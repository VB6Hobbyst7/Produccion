VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
  Persistable = 0  'NotPersistable
  DataBindingBehavior = 0  'vbNone
  DataSourceBehavior  = 0  'vbNone
  MTSTransactionMode  = 0  'NotAnMTSObject
END
Attribute VB_Name = "nCredRepoFinMes"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = True
Option Explicit
Dim Conecta As DConecta
Public Event ShowProgress()
Public Event CloseProgress()
Public Event Progress(pnValor As Long, pnTotal As Long)

Dim FechaSistema As Date
Dim sNomCmac As String
Dim sNomAge As String
Dim sCodUser As String

Private Function ImpCredRefinanCab(ByVal psFecData As String, ByVal psDesCondiciones As String, _
        ByVal pnPag As Integer, ByVal psAgencia As String) As String
Dim lsCad As String
      
lsCad = lsCad & Chr(10)
lsCad = lsCad & CabRepoCreditos("CREDITOS REFINACIADOS VIGENTES - Agencia " & NombreAgencia(psAgencia), "AL " & Format(psFecData, "mm/dd/yyyy"), pnPag, 180, "", True)
ImpCredRefinanCab = lsCad
End Function

Public Function CalculaInteresAdelantado(SaldoCapital As Double, _
    TasaInteres As Double, Plazo As Integer) As Double
'CalculaInteresAdelantado = SaldoCapital * (1 - (1 / ((1 + TasaInteres) ^ (Plazo / 360))))
CalculaInteresAdelantado = SaldoCapital * (1 - (1 / ((1 + TasaInteres / 100) ^ (Plazo / 30))))
End Function
Private Function ImpCredPigCab(ByVal pnDiasIni As Integer, ByVal pnDiasFin As Integer, _
            ByVal psAgencia As String, ByVal pnPagina As Integer)
Dim lsTitulo As String
Dim lsSubTit As String
Dim lsCad As String

lsTitulo = "LISTADO DE CREDITO PIGNORATICIO  " & NombreAgencia(psAgencia)
lsSubTit = " De " & Str(pnDiasIni) & " A  " & pnDiasFin & " Dias Atraso"
lsCad = lsCad & CabRepoCreditos(lsTitulo, lsSubTit, pnPagina, 130, " ", True)
lsCad = lsCad & String(130, "-") & Chr(10)
lsCad = lsCad & Space(2) & " ITEM    CONTRATO  F.EMPEÑO     APELLIDOS Y NOMBRES        SALDO     TASACION  PL. INT.DEV. ATRASO INT.M.ACT. INT.M.PROX. TOT.INT.COB.  DEU.TOTAL " & Chr(10)
lsCad = lsCad & String(130, "-") & Chr(10)
ImpCredPigCab = lsCad
End Function

Private Function fgCredPersVigentesCab(ByVal psFecha As String, ByVal pnDiasIni As Integer, ByVal pnDiasFin As Integer, _
            ByVal psDesCondiciones As String, ByVal pnPag As Integer, ByVal psAgencia As String) As String

    fgCredPersVigentesCab = CabRepoCreditos("CREDITOS CONSUMO VIGENTES - AGENCIA " & NombreAgencia(psAgencia) & "  AL  " & Format(psFecha, "dd/mm/yyyy"), _
        "DE  " & CStr(pnDiasIni) & " A " & CStr(pnDiasFin) & " Dias de Atraso ", pnPag, 250, psDesCondiciones, True)
End Function

Private Function ImpCredVigGarantSubCab() As String
Dim lsImp As String
lsImp = lsImp & String(223, "-") & Chr(10)
lsImp = lsImp & Space(3) & "CREDITO" & Space(14) & "CLIENTE" & Space(26) & "DIAS ATR" & Space(3) & "TASA INT." & Space(5) & "M. DESEMB." & Space(10) & "CUOTA" & Space(5) & "SALDO CAP." & Space(8) & "MORA" & Space(3) & "INT. DEVENG." & Space(5) & "DEUDA TOTAL" & Space(5) & "ANALIS." & Space(3) & "GAR. HIPOT." & Space(5) & "OTRAS GAR." & Space(4) & "F. APROB." & Chr(10)
lsImp = lsImp & String(223, "-") & Chr(10)
ImpCredVigGarantSubCab = lsImp
End Function
Public Function GetQuery(lsSQL As String) As ADODB.Recordset
Dim rs As New ADODB.Record
Conecta.AbreConexion
Set GetQuery = Conecta.CargaRecordSet(lsSQL)
Conecta.CierraConexion
End Function

Public Function GetTipoCred() As ADODB.Recordset
Dim rs As New ADODB.Recordset
Dim sql As String
sql = " select * from constante where " & _
      " nConsValor like '_50' and nConsCod=3034 Order by nConsValor"
Conecta.AbreConexion
Set rs = Conecta.CargaRecordSet(sql)
    Conecta.CierraConexion
Set GetTipoCred = rs
Set rs = Nothing
End Function
Public Function GetSubTipoCred(ByVal sTipoC As String) As ADODB.Recordset
Dim rs As New ADODB.Recordset
Dim sql As String
sql = " Select * from constante where " & _
       " nConsValor like '" & Mid(sTipoC, 1, 1) & "__'   and nConsCod=3034 " & _
       " and nConsValor!='" & sTipoC & "' " & _
       " Order by nConsValor "
Conecta.AbreConexion
Set rs = Conecta.CargaRecordSet(sql)
Conecta.CierraConexion
Set GetSubTipoCred = rs
Set rs = Nothing
End Function

Sub Inicia(ByVal pdFecSis As Date, ByVal pNomCmac As String, ByVal pNomAge As String, ByVal pCodUser As String)
    FechaSistema = pdFecSis
    sNomCmac = pNomCmac
    sNomAge = pNomAge
    sCodUser = pCodUser
End Sub

 
Public Function NombreAgencia(ByVal lsAge As String) As String
Dim rs As New ADODB.Recordset
Dim sql As String
sql = "select cAgeDescripcion from Agencias where cAgeCod='" & lsAge & "'"
Conecta.AbreConexion
Set rs = Conecta.CargaRecordSet(sql)
Conecta.CierraConexion
NombreAgencia = IIf(IsNull(rs!cAgeDescripcion), "", rs!cAgeDescripcion)
End Function

Public Function nRepo108706_ImpRepDevengados_Vigentes(psServConsol As String, pPlanCuentas As String, pTipoCambio As Single) As String
Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPL As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset

Dim lsDescPr As String
Dim lsDescF As String
Dim lsDescAG As String

Dim liLineas As Integer
Dim liDatos  As Long

' *** Moneda
Dim lnTSaldoCapM As Double

' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double

' *** Agencia
Dim lnTSaldoCapAG As Double
Dim lnTSaldoCapAGcps As Double  '**
Dim lnTSaldoCapAGlps As Double
Dim lnTSaldoCapAGcpd As Double
Dim lnTSaldoCapAGlpd As Double
' *** Producto
Dim lnTIntDevPr As Double
' *** Plazo
Dim lnTIntDevPL As Double

Dim lnTCredProd As Single
Dim lnTIntDevProd As Double

Dim lnTIntDevProdcps As Double  ' **
Dim lnTIntDevProdlps As Double
Dim lnTIntDevProdcpd As Double
Dim lnTIntDevProdlpd As Double

Dim lbSiCambio As Boolean
Dim cadena As String

Dim prod(8) As String
Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsRtfImp As String
Dim cpag As Integer

Dim Ag As Integer

Dim lsCreditosVigentes As String
Dim lsCreditosPignoraticio As String
Dim i As Integer
Dim lsRtfImpG As String

Dim lSSQL9 As String
lsCreditosVigentes = "2020,2021,2022"
'lsCreditosPignoraticio = "2101,2104,2106,2107"
lsCreditosPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07

' Para Cada Producto
'prod(0) = " '101','102'  "       ' Comercial
'prod(1) = " '201' "  ' pyme
'prod(2) = " '301','302','303','304' "        ' Consumo
'prod(3) = " '305' "                          ' prendario
'prod(4) = " '401' "                          ' Hipotecario
'prod(5) = " '202' "                          ' agricola
'prod(6) = " '320' "                          ' Administra
'prod(7) = " '423' "                          ' Mivivienda
'prod(8) = " '401' "

'ARCV 31-05-2006
prod(0) = RecuperaCadenaTipoProducto("1")        ' Comercial
prod(1) = RecuperaCadenaTipoProducto("2")  ' pyme
prod(2) = RecuperaCadenaTipoProducto("3")        ' Consu0mo
prod(3) = " '305' "                          ' prendario
prod(4) = RecuperaCadenaTipoProducto("4")     ' Hipotecario
'prod(5) = " '202' "                          ' agricola
'prod(6) = " '302' "                          ' Administra
'prod(7) = " '423' "                          ' Mivivienda
'******************

lbSiCambio = False
lsRtfImp = ""
cpag = 1

cadena = ""
Ag = 0

'===== Verificar si existen datos para el reporte
Sql9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol where nPrdEstado in ( " & lsCreditosVigentes & " ) "
Set Reg9 = GetQuery(Sql9)
If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)
If liDatos > 0 Then  ' General
    '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)
    '======== Tipo de Plazo =========
        Set rsPL = loConst.RecuperaConstantes(gColocLineaCredPlazo)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    Set rsFF = ObtieneLineaCredito 'Fuente Financiamiento
    
   '======= Para Cada Agencia  =========
    Dim loAg As DAgencias
        Set loAg = New DAgencias
            Set rsAg = loAg.RecuperaAgencias
        Set loAg = Nothing
   
    nRepo108706_ImpRepDevengados_Vigentes = ""
    lsRtfImp = lsRtfImp & CabRepDevengados_Vig(cpag, pTipoCambio, pPlanCuentas)
    liLineas = 6
    RaiseEvent ShowProgress
    '======= Para Cada Producto =========
     For i = 0 To 4 '7  'Para Cada Producto 7
        lnTCredProd = 0: lnTIntDevProd = 0
        'lsDescPr = NombreProducto(CInt(Replace(prod(I), "'", "")))
        Select Case i
          Case 0
             lsDescPr = " Comercial     "
          Case 1
             lsDescPr = " Mes           "
          Case 2
             lsDescPr = " Consumo       "
          Case 3
             lsDescPr = " Prendario     "
          Case 4
             lsDescPr = " Hipotecario   "
          'Case 5
          '   lsDescPr = " Agricola      "
          'Case 6
          '   lsDescPr = " Administrativo"
        End Select
        lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69) & "* " & lsDescPr & Chr(27) & Chr(70)
        liLineas = liLineas + 1
        
        '======= Para Cada Agencia  =========
        Ag = 0
        rsAg.MoveFirst
        Do While Not rsAg.EOF
            Ag = Ag + 1
            ' === Si hay datos para la Agencia  ========
            Sql9 = "SELECT Count(cCtaCod) AS NumCred " & _
                " from " & psServConsol & "CreditoConsol " & _
                " WHERE nPrdEstado in (" & lsCreditosVigentes & "," & lsCreditosPignoraticio & ") " & _
                " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
            
            'SQL9B = "SELECT Count(cCtaCod) AS NumCred " & _
            '    " from " & psServConsol & "CreditoConsol " & _
            '    " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND nSaldoCap > 0" & _
            '    " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
            '    " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
            'If i = 3 Then  ' Si Prendario
            '   SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
            '        " WHERE nPrdEstado IN " & lsCreditosPignoraticio & _
            '        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
            '        " AND substring(cCtaCod,4,2 )= '" & rsAg!cAgeCod & "'"
            'Else
            '   SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
            '           "WHERE nPrdEstado = 9999 "
            'End If

            'If HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then   ' De la agencia
            If HayDatos(Sql9) > 0 Then    ' De la agencia
                lnTSaldoCapAG = 0
                lnTSaldoCapAGcps = 0:   lnTSaldoCapAGlps = 0
                lnTSaldoCapAGcpd = 0:   lnTSaldoCapAGlpd = 0
                lsDescAG = Mid(rsAg!cAgeDescripcion, 1, 20)
                lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69) & "** " & lsDescAG & Chr(27) & Chr(70)
                liLineas = liLineas + 1
                
                '======= Para Cada F Financ =========
                rsFF.MoveFirst
                Do While Not rsFF.EOF 'Fuente Financ
                    lnTSaldoCapF = 0
                    ' === Si hay datos de la Fuente Financiamiento ========
                    Sql9 = "SELECT Count(cCtaCod) AS NumCred " & _
                        " from " & psServConsol & "CreditoConsol " & _
                        " WHERE nPrdEstado in ( " & lsCreditosVigentes & "," & lsCreditosPignoraticio & ") " & _
                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                        " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'"
                    
                    'SQL9B = "SELECT Count(cCtaCod) AS NumCred " & _
                    '    "" & _
                    '    " from " & psServConsol & "CreditoConsol " & _
                    '    " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND nSaldoCap > 0" & _
                    '    " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                    '    " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                    '    " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'"
                        
                    'If i = 3 And Trim(rsFF!cLineaCred) = "0101" Then ' Si Prendario / RR PP
                    '   SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
                    '        " WHERE nPrdEstado IN " & lsCreditosPignoraticio & _
                    '        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                    '        " AND substring(cCtaCod,4,2 )= '" & rsAg!cAgeCod & "'"
                    'Else
                    '   SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
                    '           "WHERE nPrdEstado = 9999 "
                    'End If
                    
                    'If HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then   ' De la Fuente Financ
                    If HayDatos(Sql9) > 0 Then    ' De la Fuente Financ
                        ' ****  Verifica Si Cambio pagina
                        lsRtfImp = lsRtfImp & Chr(10)
                        lsRtfImp = lsRtfImp & "  " & Mid(rsFF!CDescripcion & Space(15), 1, 15)
                        liLineas = liLineas + 1
                   
                        '======= Para Cada moneda =========
                        RsM.MoveFirst
                        Do While Not RsM.EOF
                            lnTSaldoCapM = 0
                            '======= Para Cada Plazo =========
                            rsPL.MoveFirst
                            lnTIntDevPL = 0
                            Do While Not rsPL.EOF 'Fuente Financ
                                   lnTIntDevPr = 0
                                   '===============================
                                   '===== Total Devengados   ======
                                          
                                    'If I <> 3 Then
                                    
                                        Sql9 = "SELECT ISNULL( SUM(nIntDev) , 0 ) AS Devengado " & _
                                              " from " & psServConsol & "CreditoConsol " & _
                                              " WHERE nPrdEstado in ( " & lsCreditosVigentes & ") " & _
                                              " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                              " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                              " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                              " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                              " AND substring(cLineaCred,6,1) = '" & rsPL!nConsValor & "'" & _
                                              " AND cRefinan = 'N' " & _
                                              " AND nDiasAtraso <= (case when substring(cCtaCod,6,1) ='1' then 15 " & _
                                              "                          when substring(cCtaCod,6,1) ='2' then 30 " & _
                                              "                          when substring(cCtaCod,6,1) ='3' then 30 " & _
                                              "                          when substring(cCtaCod,6,1) ='4' then 30 " & _
                                              "  end ) "
                                             
                                          Set Reg9 = GetQuery(Sql9)
                                          lnTIntDevPr = Reg9!Devengado
                                          Reg9.Close
                                          Set Reg9 = Nothing
'                                    Else
'                                          ' Pignoraticio  -- ' Si es Soles / Corto Plazo / RR PP  -
'                                          If Trim(RsM!nConsValor) = "1" And rsPL!nConsValor = "1" And Trim(rsFF!cLineaCred) = "0101" Then
'                                             Sql9 = "SELECT Sum(nIntDev) AS Devengado " & _
'                                                   " from " & psServConsol & "CreditoConsol " & _
'                                                   " WHERE nPrdEstado IN (" & lsCreditosPignoraticio & ") " & _
'                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
'                                                   " AND substring(cCtaCod,6,3) in ( " & prod(I) & ")" & _
'                                                   " AND substring(cCtaCod,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
'                                                   " AND  ndiasAtraso <= 30 "
'                                             Set Reg9 = GetQuery(Sql9)
'                                             lnTIntDevPr = IIf(IsNull(Reg9!Devengado), 0, Reg9!Devengado)
'                                             Reg9.Close
'                                             Set Reg9 = Nothing
'                                           End If
'
'                                    End If
                                    ' *************************************
                                    ' ***** Asigna Valores a AGENCIA    ***
                                    'lnTSaldoCapM(i) = lnTSaldoCapM(i) + lnTIntDevPr(i)
                                    If Trim(rsPL!nConsValor) = "1" Then
                                       If Trim(RsM!nConsValor) = "1" Then
                                          lnTSaldoCapAGcps = lnTSaldoCapAGcps + lnTIntDevPr
                                       Else
                                          lnTSaldoCapAGcpd = lnTSaldoCapAGcpd + lnTIntDevPr
                                       End If
                                    Else
                                       If Trim(RsM!nConsValor) = "1" Then
                                          lnTSaldoCapAGlps = lnTSaldoCapAGlps + lnTIntDevPr
                                       Else
                                          lnTSaldoCapAGlpd = lnTSaldoCapAGlpd + lnTIntDevPr
                                       End If
                                    End If
                                    lnTIntDevPL = lnTIntDevPL + lnTIntDevPr
                                    ' *****  Imprime Producto de la Moneda
                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevPr, 13, 2, True) & " | "
                               ' ** Sgte Plazo
                                rsPL.MoveNext
                            Loop ' de Plazo
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevPL, 13, 2, True) & " | "
                            RsM.MoveNext
                        Loop  ' de Moneda
                    End If  ' Si hay datos en F.Financ
                    rsFF.MoveNext
                Loop  ' de Fuente Financiamiento
                lsRtfImp = lsRtfImp & Chr(10) & String(155, "-") & Chr(10)
                lsRtfImp = lsRtfImp & Space(17)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGcps, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGlps, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGcps + lnTSaldoCapAGlps, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGcpd, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGlpd, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGcpd + lnTSaldoCapAGlpd, 13, 2, True) & " | "
                liLineas = liLineas + 2
                ' ****************************
                ' ****  Verifica Si Cambio pagina
                If liLineas >= 52 Then 'Para el control de salto de página
                   lsRtfImp = lsRtfImp & Chr(12)
                   cpag = cpag + 1
                   lsRtfImp = lsRtfImp & CabRepDevengados_Vig(cpag, pTipoCambio, pPlanCuentas)
                   liLineas = 6
                End If
                
            End If  ' si hay datos Agencia

            ' ** Sgte agencia
            rsAg.MoveNext
                
        Loop  ' de Agencia
                           
        lsRtfImp = lsRtfImp & Chr(10)
        RaiseEvent Progress(CInt(i), 10)
    Next i   ' Para el Sgte Producto
    RaiseEvent CloseProgress
Else
    nRepo108706_ImpRepDevengados_Vigentes = ""
End If '--- liDatos - General
lsRtfImpG = lsRtfImp ' Asigna el valor
nRepo108706_ImpRepDevengados_Vigentes = lsRtfImpG
Screen.MousePointer = 1
End Function

Public Function nRepo108707_ImpRepDevengados_Vencidos(psServConsol As String, pPlanCuentas As String, pTipoCambio As Single) As String
Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPL As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset

Dim lsDescPr As String
Dim lsDescF As String
Dim lsDescAG As String

Dim liLineas As Integer
Dim liDatos  As Long

' *** Moneda
Dim lnTSaldoCapM As Double

' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double

' *** Agencia
Dim lnTSaldoCapAG As Double

Dim lnTSaldoCapAGcps As Double  '**
Dim lnTSaldoCapAGlps As Double
Dim lnTSaldoCapAGcpd As Double
Dim lnTSaldoCapAGlpd As Double

' *** Producto
Dim lnTIntDevPr As Double
' *** Plazo
Dim lnTIntDevPL As Double

Dim lnTCredProd As Single
Dim lnTIntDevProd As Double

Dim lnTIntDevProdcps As Double  ' **
Dim lnTIntDevProdlps As Double
Dim lnTIntDevProdcpd As Double
Dim lnTIntDevProdlpd As Double


Dim lbSiCambio As Boolean
Dim cadena As String
'Dim prod(10) As String
Dim prod(8) As String
Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsRtfImp As String
Dim cpag As Integer

Dim lnCredAdmin As Integer ' Bandera Para Cred Admin
Dim Ag As Integer
Dim lsCreditosVigentes As String
Dim lsCreditosPignoraticio As String
Dim lsCreditosJudicial As String
Dim i As Integer
Dim lsRtfImpG As String

Dim lSSQL9 As String
'lsCreditosVigentes = "(" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc & " ) "

lsCreditosVigentes = "2021,2022,2030,2031,2032"
'lsCreditosPignoraticio = "2101,2104,2106,2107"
lsCreditosPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
lsCreditosJudicial = "2201,2205"

'prod(0) = " '101','102' "  ' Comercial
'prod(1) = " '201' "  ' PYME
'prod(2) = " '202' "  ' Agricola
'prod(3) = " '301','302','303','304' "  ' Consumo
'prod(4) = " '320' "  ' Administrativo
'prod(5) = " '305' "  ' Prendario
'prod(6) = " '423' "  ' Hipotecario
'For I = 0 To 3
'    prod(I) = RecuperaCadenaTipoProducto(CStr(I + 1))
'Next
prod(0) = RecuperaCadenaTipoProducto("1")
prod(1) = RecuperaCadenaTipoProducto("2")
prod(2) = RecuperaCadenaTipoProducto("3")
prod(3) = " '305' "
prod(4) = RecuperaCadenaTipoProducto("4")

lbSiCambio = False
lsRtfImp = ""
cpag = 1
cadena = ""
Ag = 0


'===== Verificar si existen datos para el reporte
Sql9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol where nPrdEstado in ( " & lsCreditosVigentes & " ) "
Set Reg9 = GetQuery(Sql9)

If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing
liDatos = liDatos + Round(liDatos / 10, 0)
If liDatos > 0 Then  ' General
    '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)
    '======== Tipo de Plazo =========
        Set rsPL = loConst.RecuperaConstantes(gColocLineaCredPlazo)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    Set rsFF = ObtieneLineaCredito 'Fuente Financiamiento
    
   '======= Para Cada Agencia  =========
    Dim loAg As DAgencias
        Set loAg = New DAgencias
            Set rsAg = loAg.RecuperaAgencias
        Set loAg = Nothing
    nRepo108707_ImpRepDevengados_Vencidos = ""
    lsRtfImp = lsRtfImp & CabRepDevengados_Vencidos(cpag, pTipoCambio, pPlanCuentas)
    liLineas = 6
    '======= Para Cada Producto =========
    RaiseEvent ShowProgress
     For i = 0 To 4 '5  'Para Cada Producto
        lnTCredProd = 0: lnTIntDevProd = 0
        'lsDescPr = NombreProducto(CInt(Replace(prod(i), "'", "")))
         If i = 0 Then lsDescPr = "Comercial"
         If i = 1 Then lsDescPr = "Pyme "
         If i = 2 Then lsDescPr = "Consumo" '"Pyme Agricola"
         'If I = 3 Then lsDescPr = "Consumo  "
         'If I = 4 Then lsDescPr = "Administ."
         If i = 3 Then lsDescPr = "Prendario"
         If i = 4 Then lsDescPr = "Hipotecario" '"Miviviend"
         
        'If i <> 5 Then
            lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69) & "* " & Trim(lsDescPr) & "" & Chr(27) & Chr(70)
        'Else
        '    lsRTfImp = lsRTfImp & Chr(10) & Chr(27) & Chr(69) & "* " & lsDescPr & Chr(27) & Chr(70)
        'End If
        liLineas = liLineas + 1
        '======= Para Cada Agencia  =========
        Ag = 0
        rsAg.MoveFirst
        Do While Not rsAg.EOF
            Ag = Ag + 1
            ' === Si hay datos para la Agencia  ========
            Sql9 = "SELECT Count(cCtaCod) AS NumCred " & _
                " from " & psServConsol & "CreditoConsol " & _
                " WHERE nPrdEstado in ( " & lsCreditosVigentes & "," & lsCreditosJudicial & "," & lsCreditosPignoraticio & ") " & _
                " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
            
            'SQL9B = "SELECT Count(cCtaCod) AS NumCred " & _
            '    " from " & psServConsol & "CreditoConsol " & _
            '    " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND nSaldoCap > 0" & _
            '    " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
            '    " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
                
            'If i = 5 Then  ' Si Prendario 5
            '   SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
            '        " WHERE nPrdEstado IN " & lsCreditosPignoraticio & _
            '        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
            '        " AND substring(cCtaCod,4,2 )= '" & rsAg!cAgeCod & "'"
            'Else
            '   SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
            '           "WHERE nPrdEstado = 9999 "
            'End If
            
            'If (HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0) Then   ' De la agencia
            If (HayDatos(Sql9) > 0) Then    ' De la agencia
                lnTSaldoCapAG = 0
                lnTSaldoCapAGcps = 0:   lnTSaldoCapAGlps = 0
                lnTSaldoCapAGcpd = 0:   lnTSaldoCapAGlpd = 0
                lsDescAG = Mid(rsAg!cAgeDescripcion, 1, 20)
                lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69) & "** " & lsDescAG & Chr(27) & Chr(70)
                liLineas = liLineas + 1
                
                '======= Para Cada F Financ =========
                rsFF.MoveFirst
                Do While Not rsFF.EOF 'Fuente Financ
                    lnTSaldoCapF = 0
                    
                    ' === Si hay datos de la Fuente Financiamiento ========
                    Sql9 = "SELECT Count(cCtaCod) AS NumCred " & _
                        " from " & psServConsol & "CreditoConsol " & _
                        " WHERE nPrdEstado in (" & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & ") " & _
                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                        " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'"
                    
                    'SQL9B = " SELECT Count(cCtaCod) AS NumCred " & _
                    '    "" & _
                    '    " from " & psServConsol & "CreditoConsol " & _
                    '    " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND nSaldoCap > 0" & _
                    '    " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                    '    " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                    '    " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'"
                        
                    'If i = 5 And Trim(rsFF!cLineaCred) = "0101" Then ' Si Prendario / RR PP 7
                    '   SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
                    '        " WHERE nPrdEstado IN " & lsCreditosPignoraticio & _
                    '        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                    '        " AND substring(cCtaCod,4,2 )= '" & rsAg!cAgeCod & "'"
                    'Else
                    '   SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
                    '           "WHERE nPrdEstado = 9999 "
                    'End If

                    'If (HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0) Then  ' De la Fuente Financ
                    If HayDatos(Sql9) > 0 Then  ' De la Fuente Financ
                        ' ****************************
                        ' ****  Verifica Si Cambio pagina
                          
                        lsRtfImp = lsRtfImp & Chr(10)
                        lsRtfImp = lsRtfImp & "  " & Mid(rsFF!CDescripcion & Space(15), 1, 15)
                        liLineas = liLineas + 1
                   
                        '======= Para Cada moneda =========
                        RsM.MoveFirst
                        Do While Not RsM.EOF
                            lnTSaldoCapM = 0
                            
                            '======= Para Cada Plazo =========
                            rsPL.MoveFirst
                            lnTIntDevPL = 0
                            
                            Do While Not rsPL.EOF 'Fuente Financ
                                   lnTIntDevPr = 0
                                   '===============================
                                   '===== Total Devengados   ======

                                     Select Case i
                                       
                                       Case 0, 1, 2, 4 ' 3, 4, 6, 7
                                            Sql9 = "SELECT SUM(nIntDev) AS Devengado " & _
                                                " from " & psServConsol & "CreditoConsol " & _
                                                " WHERE nPrdEstado in ( " & lsCreditosVigentes & ") " & _
                                                " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                                " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                                " AND substring(cLineaCred,6,1) = '" & rsPL!nConsValor & "' "

                                                Set Reg9 = GetQuery(Sql9)
                                                lnTIntDevPr = IIf(IsNull(Reg9!Devengado), 0, Reg9!Devengado)
                                                Reg9.Close
                                                Set Reg9 = Nothing

                                          'Judicial -------------
                                          Sql9 = "SELECT SUM(nIntDev) AS Devengado " & _
                                              " from " & psServConsol & "CreditoConsol " & _
                                              " WHERE nPrdEstado in (" & lsCreditosJudicial & " ) " & _
                                              " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                              " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                              " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                              " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                              " AND substring(cLineaCred,6,1) = '" & rsPL!nConsValor & "'"
                                          Set Reg9 = GetQuery(Sql9)
                                          lnTIntDevPr = lnTIntDevPr + IIf(IsNull(Reg9!Devengado), 0, Reg9!Devengado)
                                          Reg9.Close
                                          Set Reg9 = Nothing
                                       
                                       Case 3 '5
                                          ' Pignoraticio  -- ' Si es Soles / Corto Plazo / RR PP  -
                                          'If Trim(RsM!nConsValor) = "1" And rsPL!nConsValor = "1" And Trim(rsFF!cLineaCred) = "0101" Then
                                             Sql9 = "SELECT Sum(nIntDev) AS Devengado " & _
                                                   " from " & psServConsol & "CreditoConsol " & _
                                                   " WHERE nPrdEstado IN (" & lsCreditosPignoraticio & " ) " & _
                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                   " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                   " AND substring(cCtaCod,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                   " AND nDiasAtraso > 30 "
                                             Set Reg9 = GetQuery(Sql9)
                                             lnTIntDevPr = IIf(IsNull(Reg9!Devengado), 0, Reg9!Devengado)
                                             Reg9.Close
                                             Set Reg9 = Nothing
                                          'End If
                                     End Select
        
                                    ' *************************************
                                    ' ***** Asigna Valores a AGENCIA    ***
                                    ' *************************************
                                    'lnTSaldoCapM(i) = lnTSaldoCapM(i) + lnTIntDevPr(i)
                                    If Trim(rsPL!nConsValor) = "1" Then
                                       If Trim(RsM!nConsValor) = "1" Then
                                          lnTSaldoCapAGcps = lnTSaldoCapAGcps + lnTIntDevPr
                                       Else
                                          lnTSaldoCapAGcpd = lnTSaldoCapAGcpd + lnTIntDevPr
                                       End If
                                    Else
                                       If Trim(RsM!nConsValor) = "1" Then
                                          lnTSaldoCapAGlps = lnTSaldoCapAGlps + lnTIntDevPr
                                       Else
                                          lnTSaldoCapAGlpd = lnTSaldoCapAGlpd + lnTIntDevPr
                                       End If
                                    End If
                                    lnTIntDevPL = lnTIntDevPL + lnTIntDevPr
                                    ' *****  Imprime Producto de la Moneda
                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevPr, 13, 2, True) & " | "
                                    'End If
                               ' ** Sgte Plazo
                                rsPL.MoveNext
                            Loop ' de Plazo
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevPL, 13, 2, True) & " | "
                            RsM.MoveNext
                    
                        Loop  ' de Moneda
                    End If  ' Si hay datos en F.Financ
                    rsFF.MoveNext
                Loop  ' de Fuente Financiamiento
             
                lsRtfImp = lsRtfImp & Chr(10) & String(155, "-") & Chr(10)
                lsRtfImp = lsRtfImp & Space(17)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGcps, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGlps, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGcps + lnTSaldoCapAGlps, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGcpd, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGlpd, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAGcpd + lnTSaldoCapAGlpd, 13, 2, True) & " | "
                liLineas = liLineas + 2
                
                ' ****************************
                ' ****  Verifica Si Cambio pagina
                If liLineas >= 52 Then 'Para el control de salto de página
                   lsRtfImp = lsRtfImp & Chr(12)
                   cpag = cpag + 1
                   lsRtfImp = lsRtfImp & CabRepDevengados_Vencidos(cpag, pTipoCambio, pPlanCuentas)
                   liLineas = 6
                End If
            End If  ' si hay datos Agencia

            ' ** Sgte agencia
            rsAg.MoveNext
                
        Loop  ' de Agencia
                           
        lsRtfImp = lsRtfImp & Chr(10)
        RaiseEvent Progress(CInt(i), 10)
    Next i   ' Para el Sgte Producto
    RaiseEvent CloseProgress
Else
    nRepo108707_ImpRepDevengados_Vencidos = ""
End If '--- liDatos - General
lsRtfImpG = lsRtfImp ' Asigna el valor
nRepo108707_ImpRepDevengados_Vencidos = lsRtfImpG
Screen.MousePointer = 1
End Function

Public Function nRepo108710_ImpRepColocxSectEcon(psServConsol As String, lpCadena As String, ByVal lpTipCambio As Single) As String
Dim sql As String
Dim rsAE As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim liDatos As Long
Dim lbDato As Boolean
Dim Cont As Long
Dim lsCodRangINI() As String * 2
Dim lsCodRangFIN() As String * 2
Dim lsDesRang() As String * 29
Dim i As Integer
Dim CIUUreg As String
Dim lnNumCre As Long
Dim lnSaldoCap As Currency
Dim lnNumCreNue As Long
Dim lnSaldoCapNue As Currency
Dim lnSaldoCapRef As Currency
Dim lnTNumCre As Long   ' *** Totales
Dim lnTSaldoCap As Currency
Dim lnTNumCreNue As Long
Dim lnTSaldoCapNue As Currency
Dim lnTSaldoCapRef As Currency

Dim rsRang As New ADODB.Recordset
Dim lnRangos As Integer
Dim lsRtfImp As String
Dim cpag As Integer
Dim liLineas As Integer

Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
'Dim i As Integer
Dim lsRtfImpG As String

Dim lSSQL9 As String
Dim lnNumCreTotal, lnNumCreNueTotal, lnSaldoCapNueTotal, lnSaldoCapRefTotal, lnSaldoCapTotal As Double

lnNumCreTotal = 0
lnNumCreNueTotal = 0
lnSaldoCapNueTotal = 0
lnSaldoCapRefTotal = 0
lnSaldoCapTotal = 0

lsCreditosVigentes = "(" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc & " ) "
'lsPignoraticio = "( '2807','2802','2803','2804')"
'lsPignoraticio = "(" & gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov & ") "
lsPignoraticio = "(" & DevuelveCadenaEstadosPignoraticio & ")"  'ARCV 27-07-2006

sql = " SELECT * FROM anxriesgosrango WHERE COPEcOD=770030 ORDER BY CCODRANGO "
Set rsRang = GetQuery(sql)

If Not (rsRang.BOF And rsRang.EOF) Then
    rsRang.MoveLast
    ReDim lsCodRangINI(rsRang.RecordCount)
    ReDim lsCodRangFIN(rsRang.RecordCount)
    ReDim lsDesRang(rsRang.RecordCount)
    lnRangos = rsRang.RecordCount
    rsRang.MoveFirst
    i = 0
    Do While Not rsRang.EOF
        lsDesRang(i) = Trim(rsRang!cDescrip)
        lsCodRangINI(i) = IIf(rsRang!nDesde < 10, "0" & rsRang!nDesde, rsRang!nDesde)
        lsCodRangFIN(i) = IIf(rsRang!nHasta < 10, "0" & rsRang!nHasta, rsRang!nHasta)
        i = i + 1
        rsRang.MoveNext
    Loop
End If

lsRtfImp = ""
cpag = 1
lnNumCre = 0:      lnSaldoCap = 0
lnNumCreNue = 0:   lnSaldoCapNue = 0: lnSaldoCapRef = 0
If lpTipCambio = 0 Then
   MsgBox "No ingreso tipo de Cambio ", vbInformation, "Aviso"
   Exit Function
End If
nRepo108710_ImpRepColocxSectEcon = ""
lsRtfImp = CabRepColocxSectEcon(cpag, lpTipCambio)
liLineas = 6
lsRtfImp = lsRtfImp & "CREDITOS COMERCIAL/PYME/CONSUMO " & Chr(10)
RaiseEvent ShowProgress
For i = 0 To lnRangos - 1
          
        '=================== SALDO ACTUAL =====================
        sql = " SELECT Count(c.cCtaCod) as Numero, " & _
              " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' THEN (nSaldoCap) " & _
              "           WHEN substring(c.cCtaCod,9,1) = '2' THEN (nSaldoCap * " & lpTipCambio & ")" & _
              "      END ) AS SaldoCap "
        sql = sql & " from " & psServConsol & "CreditoConsol C INNER JOIN " & psServConsol & "FuenteIngresoConsol FI " & _
           " ON C.cNumFuente = FI.cNumFuente WHERE C.nPrdEstado in  " & lsCreditosVigentes & _
           " AND substring(c.cCtaCod,6,3) not in ('305','121','221','321','421') " & _
           " AND Substring(FI.cActEcon,2,2) >= '" & Trim(lsCodRangINI(i)) & "'" & _
           " AND Substring(FI.cActEcon,2,2) <= '" & Trim(lsCodRangFIN(i)) & "'"
        ''101','201','202'
        Set Reg9 = GetQuery(sql)
        lnNumCre = Reg9!Numero
        lnSaldoCap = IIf(IsNull(Reg9!SaldoCap), 0, Reg9!SaldoCap)
        Reg9.Close
        
        ' =======  Judiciales  ============
        sql = " SELECT Count(CJ.cCtaCod) as Numero, " & _
           " SUM( CASE WHEN substring(CJ.cCtaCod,9,1) = '1' THEN (nSaldoCap) " & _
           "           WHEN substring(CJ.cCtaCod,9,1) = '2' THEN (nSaldoCap * " & lpTipCambio & ")" & _
           "      END ) AS SaldoCap " & _
           " from " & psServConsol & "CreditoConsol CJ LEFT JOIN " & psServConsol & "FuenteIngresoConsol FI " & _
           " ON CJ.cNumFuente = FI.cNumFuente WHERE CJ.nPrdEstado =" & gColocEstRecVigJud & " AND CJ.nSaldoCap > 0 " & _
           " AND substring(cJ.cCtaCod,6,3) not in ('305','121','221','321','421') " & _
           " AND Substring(FI.cActEcon,2,2) >= '" & Trim(lsCodRangINI(i)) & "'" & _
           " AND Substring(FI.cActEcon,2,2) <= '" & Trim(lsCodRangFIN(i)) & "'"
        Set Reg9 = GetQuery(sql)
        lnNumCre = lnNumCre + Reg9!Numero
        lnSaldoCap = lnSaldoCap + IIf(IsNull(Reg9!SaldoCap), 0, Reg9!SaldoCap)
        Reg9.Close
        
        '=================== NUEVOS DESEMBOLSOS  =====================
        
        sql = " SELECT Count(c.cCtaCod) as Numero, " & _
              " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' AND c.cRefinan = 'N' THEN (nMontoDesemb) " & _
              "           WHEN substring(c.cCtaCod,9,1) = '2' AND c.cRefinan = 'N' THEN (nMontoDesemb * " & lpTipCambio & ")" & _
              "      END ) AS NueDesemb, " & _
              " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' AND c.cRefinan = 'R' THEN (nMontoDesemb) " & _
              "           WHEN substring(c.cCtaCod,9,1) = '2' AND c.cRefinan = 'R' THEN (nMontoDesemb * " & lpTipCambio & ")" & _
              "      END ) AS Refinan "
        sql = sql & " from " & psServConsol & "CreditoConsol C INNER JOIN " & psServConsol & "FuenteIngresoConsol FI " & _
           " ON C.cNumFuente = FI.cNumFuente WHERE C.nPrdEstado in " & lsCreditosVigentes & _
           " AND substring(c.cCtaCod,6,3) not in ('305','121','221','321','421') " & _
           " AND Substring(FI.cActEcon,2,2) >= '" & Trim(lsCodRangINI(i)) & "'" & _
           " AND Substring(FI.cActEcon,2,2) <= '" & Trim(lsCodRangFIN(i)) & "'" & _
           " AND  ( dFecVig Between '" & Month(GetFechaCierreMes) & "/01/" & Year(GetFechaCierreMes) & _
           "' AND '" & Format(GetFechaCierreMes, "mm/dd/yyyy") & " 23:59')"

        'Reg9.Open sql, dbCmactCentral, adOpenStatic, adLockReadOnly, adCmdText
        Set Reg9 = GetQuery(sql)
        lnNumCreNue = Reg9!Numero
        lnSaldoCapNue = IIf(IsNull(Reg9!NueDesemb), 0, Reg9!NueDesemb)
        lnSaldoCapRef = IIf(IsNull(Reg9!Refinan), 0, Reg9!Refinan)
        Reg9.Close
        
        '=================== CADENA DE IMPRESION =====================
        If liLineas >= 56 Then
            lsRtfImp = lsRtfImp & Chr(12)
            cpag = cpag + 1
            lsRtfImp = lsRtfImp & CabRepColocxSectEcon(cpag, lpTipCambio)
            liLineas = 5
        End If
        lsRtfImp = lsRtfImp & Space(1) & lsDesRang(i) & Space(2)
        lsRtfImp = lsRtfImp & ImpreFormat(lnNumCre, 10, 0, True)
        lsRtfImp = lsRtfImp & ImpreFormat(lnNumCreNue, 10, 0, True)
        lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapNue, 13, 2, True)
        lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapRef, 13, 2, True)
        lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCap, 13, 2, True)

        lsRtfImp = lsRtfImp & Chr(10)
        liLineas = liLineas + 1
        ' Adiciono al Total
        lnTNumCre = lnTNumCre + lnNumCre
        lnTSaldoCap = lnTSaldoCap + lnSaldoCap
        lnTNumCreNue = lnTNumCreNue + lnNumCreNue
        lnTSaldoCapNue = lnTSaldoCapNue + lnSaldoCapNue
        lnTSaldoCapRef = lnTSaldoCapRef + lnSaldoCapRef
        
    
Next i

RaiseEvent Progress(3, 10)
    
' *** Actividades No Definidas  ********************
'=================== SALDO CAPITAL  ================
 sql = " SELECT Count(c.cCtaCod) as Numero, " & _
   " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' THEN (nSaldoCap) " & _
   "           WHEN substring(c.cCtaCod,9,1) = '2' THEN (nSaldoCap * " & lpTipCambio & ")" & _
   "      END ) AS SaldoCap "
 sql = sql & " from " & psServConsol & "CreditoConsol C INNER JOIN " & psServConsol & "FuenteIngresoConsol FI " & _
   " ON C.cNumFuente = FI.cNumFuente WHERE C.nPrdEstado IN " & lsCreditosVigentes & _
   " AND substring(c.cCtaCod,6,3) not in ('305','121','221','321','421') " & _
   " AND (FI.cActEcon='' OR FI.cActEcon is NULL )" 'OR FI.cActEcon not in " & CIUUreg & ")"
 
 'Reg9.Open sql, dbCmactCentral, adOpenStatic, adLockReadOnly, adCmdText
 Set Reg9 = GetQuery(sql)
 lnNumCre = Reg9!Numero
 lnSaldoCap = IIf(IsNull(Reg9!SaldoCap), 0, Reg9!SaldoCap)
 Reg9.Close
 Set Reg9 = Nothing
 
 '=================== NUEVOS DESEMBOLSOS  ===========
 
 sql = " SELECT Count(c.cCtaCod) as Numero, " & _
   " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' THEN (nSaldoCap) " & _
   "           WHEN substring(c.cCtaCod,9,1) = '2' THEN (nSaldoCap * " & lpTipCambio & ")" & _
   "      END ) AS SaldoCap "
 sql = sql & " from " & psServConsol & "CreditoConsol C INNER JOIN " & psServConsol & "FuenteIngresoConsol FI " & _
   " ON C.cNumFuente = FI.cNumFuente WHERE C.nPrdEstado IN " & lsCreditosVigentes & _
   " AND substring(c.cCtaCod,6,3) not in ('305','121','221','321','421') " & _
   " AND (FI.cActEcon='' OR FI.cActEcon is NULL )" & _
   " AND ( dFecVig Between '" & Month(GetFechaCierreMes) & "/01/" & Year(GetFechaCierreMes) & _
   "' AND '" & Format(GetFechaCierreMes, "mm/dd/yyyy") & " 23:59')"
  Set Reg9 = GetQuery(sql)
 lnNumCreNue = Reg9!Numero
 lnSaldoCapNue = IIf(IsNull(Reg9!SaldoCap), 0, Reg9!SaldoCap)
 Reg9.Close
 Set Reg9 = Nothing

 lsRtfImp = lsRtfImp & " Actividad Economica No Definida"
 lsRtfImp = lsRtfImp & ImpreFormat(lnNumCre, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnNumCreNue, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapNue, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapRef, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnSaldoCapNue / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCap, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnSaldoCap / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & Chr(10)
 lsRtfImp = lsRtfImp & String(120, "=") & Chr(10)

 ' Adiciono al Total  ******
 lnTNumCre = lnTNumCre + lnNumCre
 lnTSaldoCap = lnTSaldoCap + lnSaldoCap
 lnTNumCreNue = lnTNumCreNue + lnNumCreNue
 lnTSaldoCapNue = lnTSaldoCapNue + lnSaldoCapNue
 
 '********* Imprime Total PYME
 sql = "Select Count(*) nTotal, SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') THEN 1 ELSE 0 END ) as nNumCredNew, "
 sql = sql & " SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') THEN (CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoApr ELSE C.nMontoApr * " & lpTipCambio & "  END) ELSE 0 END )  as  nPrestamos, SUM(CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN nSaldoCap ELSE nSaldoCap * " & lpTipCambio & " END ) as nSaldoCap, "
 sql = sql & " SUM( CASE WHEN C.cRefinan='N' OR C.cRefinan is NULL THEN 0 ELSE (CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap ELSE C.nSaldoCap * " & lpTipCambio & " END ) END ) as nSaldoRef "
 sql = sql & " From " & psServConsol & "CreditoConsol C "
 sql = sql & " Where SUBSTRING(C.cCtaCod,6,1) in ('2') "
 Set Reg9 = GetQuery(sql)
 
 lnTNumCre = Reg9!nTotal
 lnTNumCreNue = Reg9!nNumCredNew
 lnTSaldoCapNue = Reg9!nPrestamos
 lnTSaldoCapRef = Reg9!nSaldoRef
 lnTSaldoCap = Reg9!nSaldoCap
 
 lnNumCreTotal = lnNumCreTotal + lnTNumCre
 lnNumCreNueTotal = lnNumCreNueTotal + lnTNumCreNue
 lnSaldoCapNueTotal = lnSaldoCapNueTotal + lnTSaldoCapNue
 lnSaldoCapRefTotal = lnSaldoCapRefTotal + lnTSaldoCapRef
 lnSaldoCapTotal = lnSaldoCapTotal + lnTSaldoCap
 
 'lsCreditosVigentes = lsCreditosVigentes + lnTNumCre
 
 Reg9.Close
 
 lsRtfImp = lsRtfImp & " TOTAL CREDITOS MES   " & Space(10)
 lsRtfImp = lsRtfImp & ImpreFormat(lnTNumCre, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnTNumCreNue, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapNue, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapRef, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnTSaldoCapNue / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCap, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnTSaldoCap / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & Chr(10)
 'lsRTfimp = lsRTfimp & String(120, "=") & Chr(10)

 '********* Imprime Total COMERCIAL
 'Sql = "Select Count(*) nTotal, SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GEtFechaCierreMes, "mm/dd/yyyy") & "') THEN 1 ELSE 0 END ) as nNumCredNew, "
 'Sql = Sql & " SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GEtFechaCierreMes, "mm/dd/yyyy") & "') THEN C.nMontoApr ELSE 0 END )  as  nPrestamos, SUM(nSaldoCap) as nSaldoCap, "
 'Sql = Sql & " SUM( CASE WHEN C.cRefinan='N' OR C.cRefinan is NULL THEN 0 ELSE C.nSaldoCap END ) as nSaldoRef "
 'Sql = Sql & " From " & psServConsol & "CreditoConsol C "
 
 sql = " Select Count(*) nTotal, SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') THEN 1 ELSE 0 END ) as nNumCredNew, "
 sql = sql & " SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') THEN (CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoApr ELSE C.nMontoApr * " & lpTipCambio & "  END) ELSE 0 END )  as  nPrestamos, SUM(CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN nSaldoCap ELSE nSaldoCap * " & lpTipCambio & " END ) as nSaldoCap, "
 sql = sql & " SUM( CASE WHEN C.cRefinan='N' OR C.cRefinan is NULL THEN 0 ELSE (CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap ELSE C.nSaldoCap * " & lpTipCambio & " END ) END ) as nSaldoRef "
 sql = sql & " From " & psServConsol & "CreditoConsol C "
 sql = sql & " Where SUBSTRING(C.cCtaCod,6,1) in ('1') "
 Set Reg9 = GetQuery(sql)
 
 lnTNumCre = Reg9!nTotal
 lnTNumCreNue = Reg9!nNumCredNew
 lnTSaldoCapNue = Reg9!nPrestamos
 lnTSaldoCapRef = Reg9!nSaldoRef
 lnTSaldoCap = Reg9!nSaldoCap
 
 lnNumCreTotal = lnNumCreTotal + lnTNumCre
 lnNumCreNueTotal = lnNumCreNueTotal + lnTNumCreNue
 lnSaldoCapNueTotal = lnSaldoCapNueTotal + lnTSaldoCapNue
 lnSaldoCapRefTotal = lnSaldoCapRefTotal + lnTSaldoCapRef
 lnSaldoCapTotal = lnSaldoCapTotal + lnTSaldoCap
 
 'lsCreditosVigentes = lsCreditosVigentes + lnTNumCre
 
 Reg9.Close
 
 lsRtfImp = lsRtfImp & " TOTAL CREDITOS COMERCIAL " & Space(6)
 lsRtfImp = lsRtfImp & ImpreFormat(lnTNumCre, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnTNumCreNue, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapNue, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapRef, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnTSaldoCapNue / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCap, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnTSaldoCap / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & Chr(10)
 'lsRTfimp = lsRTfimp & String(120, "=") & Chr(10)



' **** Creditos de consumo
'=================== SALDO ACTUAL =====================
sql = " SELECT Count(c.cCtaCod) as Numero, " & _
      " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' THEN (nSaldoCap) " & _
      "           WHEN substring(c.cCtaCod,9,1) = '2' THEN (nSaldoCap * " & lpTipCambio & ")" & _
      "      END ) AS SaldoCap "
sql = sql & " from " & psServConsol & "CreditoConsol C " & _
   "  WHERE C.nPrdEstado in " & lsCreditosVigentes & _
   " AND substring(c.cCtaCod,6,3) in ('301','302','303','304','320') " & _
   " " & _
   " "
Set Reg9 = GetQuery(sql)
lnNumCre = Reg9!Numero
lnSaldoCap = IIf(IsNull(Reg9!SaldoCap), 0, Reg9!SaldoCap)
Reg9.Close
Set Reg9 = Nothing

' =======  Judiciales  ============
sql = " SELECT Count(cJ.cCtaCod) as Numero, " & _
   " SUM( CASE WHEN substring(cJ.cCtaCod,9,1) = '1' THEN (nSaldoCap) " & _
   "           WHEN substring(cJ.cCtaCod,9,1) = '2' THEN (nSaldoCap * " & lpTipCambio & ")" & _
   "      END ) AS SaldoCap " & _
   " from " & psServConsol & "CreditoConsol CJ " & _
   " WHERE CJ.nPrdEstado =" & gColocEstRecVigJud & " AND CJ.nSaldoCap > 0 " & _
   " AND substring(cJ.cCtaCod,6,3) in ('301','302','303','304','320') "

Set Reg9 = GetQuery(sql)
lnNumCre = lnNumCre + Reg9!Numero
lnSaldoCap = lnSaldoCap + IIf(IsNull(Reg9!SaldoCap), 0, Reg9!SaldoCap)
Reg9.Close
Set Reg9 = Nothing

'=================== NUEVOS DESEMBOLSOS  =====================

sql = " SELECT Count(c.cCtaCod) as Numero, " & _
      " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' AND c.cRefinan ='N' THEN (nMontoDesemb) " & _
      "           WHEN substring(c.cCtaCod,9,1) = '2' AND c.cRefinan ='N' THEN (nMontoDesemb * " & lpTipCambio & ")" & _
      "      END ) AS NueDesemb, " & _
      " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' AND c.cRefinan ='R' THEN (nMontoDesemb) " & _
      "           WHEN substring(c.cCtaCod,9,1) = '2' AND c.cRefinan ='R' THEN (nMontoDesemb * " & lpTipCambio & ")" & _
      "      END ) AS Refinan "
sql = sql & " from " & psServConsol & "CreditoConsol C " & _
   "  WHERE C.nPrdEstado in" & lsCreditosVigentes & _
   " AND substring(c.cCtaCod,6,3) in ('301','302','303','304','320') " & _
   " AND  ( dFecVig Between '" & Month(GetFechaCierreMes) & "/01/" & Year(GetFechaCierreMes) & _
   "' AND '" & Format(GetFechaCierreMes, "mm/dd/yyyy") & " 23:59')"

Set Reg9 = GetQuery(sql)
lnNumCreNue = Reg9!Numero
lnSaldoCapNue = IIf(IsNull(Reg9!NueDesemb), 0, Reg9!NueDesemb)
lnSaldoCapRef = IIf(IsNull(Reg9!Refinan), 0, Reg9!Refinan)
Reg9.Close
Set Reg9 = Nothing


'Sql = "Select Count(*) nTotal, SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GEtFechaCierreMes, "mm/dd/yyyy") & "') THEN 1 ELSE 0 END ) as nNumCredNew, "
' Sql = Sql & " SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GEtFechaCierreMes, "mm/dd/yyyy") & "') THEN C.nMontoApr ELSE 0 END )  as nPrestamos, SUM(nSaldoCap) as nSaldoCap, "
' Sql = Sql & " SUM( CASE WHEN C.cRefinan='N' OR C.cRefinan is NULL THEN 0 ELSE C.nSaldoCap END ) as nSaldoRef "
' Sql = Sql & " From " & psServConsol & "CreditoConsol C "
sql = " Select Count(*) nTotal, SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') THEN 1 ELSE 0 END ) as nNumCredNew, "
 sql = sql & " SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') THEN (CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoApr ELSE C.nMontoApr * " & lpTipCambio & "  END) ELSE 0 END )  as  nPrestamos, SUM(CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN nSaldoCap ELSE nSaldoCap * " & lpTipCambio & " END ) as nSaldoCap, "
 sql = sql & " SUM( CASE WHEN C.cRefinan='N' OR C.cRefinan is NULL THEN 0 ELSE (CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap ELSE C.nSaldoCap * " & lpTipCambio & " END ) END ) as nSaldoRef "
 sql = sql & " From " & psServConsol & "CreditoConsol C "
 sql = sql & " Where SUBSTRING(C.cCtaCod,6,1) = '3' and SUBSTRING(C.cCtaCod,6,3) <> '305' "

  Set Reg9 = GetQuery(sql)

 lnNumCre = Reg9!nTotal
 lnNumCreNue = Reg9!nNumCredNew
 lnSaldoCapNue = Reg9!nPrestamos
 lnSaldoCapRef = Reg9!nSaldoRef
 lnSaldoCap = Reg9!nSaldoCap
 Reg9.Close

lnNumCreTotal = lnNumCreTotal + lnNumCre
 lnNumCreNueTotal = lnNumCreNueTotal + lnNumCreNue
 lnSaldoCapNueTotal = lnSaldoCapNueTotal + lnSaldoCapNue
 lnSaldoCapRefTotal = lnSaldoCapRefTotal + lnSaldoCapRef
 lnSaldoCapTotal = lnSaldoCapTotal + lnSaldoCap

RaiseEvent Progress(6, 10)
 lsRtfImp = lsRtfImp & " CREDITOS DE CONSUMO            "
 lsRtfImp = lsRtfImp & ImpreFormat(lnNumCre, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnNumCreNue, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapNue, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapRef, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnSaldoCapNue / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCap, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnSaldoCap / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & Chr(10)
' ********************************

 ' Adiciono al Total  ******
 lnTNumCre = lnTNumCre + lnNumCre
 lnTSaldoCap = lnTSaldoCap + lnSaldoCap
 lnTNumCreNue = lnTNumCreNue + lnNumCreNue
 lnTSaldoCapNue = lnTSaldoCapNue + lnSaldoCapNue
 lnTSaldoCapRef = lnTSaldoCapRef + lnSaldoCapRef
 '*********
  ' **** Creditos de PIGNORATICIO

'=================== SALDO ACTUAL =====================
sql = " SELECT Count(c.cCtaCod) as Numero, " & _
      " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' THEN (nSaldoCap) " & _
      "           WHEN substring(c.cCtaCod,9,1) = '2' THEN (nSaldoCap * " & lpTipCambio & ")" & _
      "      END ) AS SaldoCap "
sql = sql & " from " & psServConsol & "CreditoConsol C  " & _
   " WHERE C.nPrdEstado IN " & lsPignoraticio

Set Reg9 = GetQuery(sql)
lnNumCre = Reg9!Numero
lnSaldoCap = IIf(IsNull(Reg9!SaldoCap), 0, Reg9!SaldoCap)
Reg9.Close
Set Reg9 = Nothing
' =======  Judiciales  ============
'SQL = " SELECT Count(c.cCtaCod) as Numero, " & _
'   " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' THEN (nSaldoCap) " & _
'   "           WHEN substring(c.cCtaCod,9,1) = '2' THEN (nSaldoCap * " & lpTipCambio & ")" & _
'   "      END ) AS SaldoCap " & _
'   " from " & psServConsol & "CreditoConsol CJ INNER JOIN CreditoConsol C ON CJ.cCtaCod = C.cCtaCod INNER JOIN FuenteIngreso FI " & _
'   " ON C.cNumFuente = FI.cNumFuente WHERE CJ.nPrdEstado = 'V' AND CJ.nCondCre = 'J' " & _
'   " AND substring(c.cCtaCod,6,3) in ('301','302','303','304','320') " & _
'   " AND Substring(FI.cActEcon,1,2) >= '" & Trim(lsCodRangINI(i)) & "'" & _
'   " AND Substring(FI.cActEcon,1,2) <= '" & Trim(lsCodRangFIN(i)) & "'"
'Reg9.Open SQL, dbcmactcentral, adOpenStatic, adLockReadOnly, adCmdText

'lnNumCre = lnNumCre + Reg9!numero
'lnSaldoCap = lnSaldoCap + IIf(IsNull(Reg9!SaldoCap), 0, Reg9!SaldoCap)
'Reg9.Close
'Set Reg9 = Nothing

'=================== NUEVOS DESEMBOLSOS  =====================
RaiseEvent Progress(9, 10)
sql = " SELECT Count(c.cCtaCod) as Numero, " & _
      " SUM( CASE WHEN substring(c.cCtaCod,9,1) = '1' THEN (nMontoDesemb) " & _
      "           WHEN substring(c.cCtaCod,9,1) = '2' THEN (nMontoDesemb * " & lpTipCambio & ")" & _
      "      END ) AS Prestamo "
sql = sql & " from " & psServConsol & "CreditoConsol c" & _
   " WHERE C.nPrdEstado in  " & lsPignoraticio & _
   " AND  ( dFecVig Between '" & Month(GetFechaCierreMes) & "/01/" & Year(GetFechaCierreMes) & _
   "' AND '" & Format(GetFechaCierreMes, "mm/dd/yyyy") & " 23:59')"
Set Reg9 = GetQuery(sql)
lnNumCreNue = Reg9!Numero
lnSaldoCapNue = IIf(IsNull(Reg9!PRESTAMO), 0, Reg9!PRESTAMO)
lnSaldoCapRef = 0
Reg9.Close
Set Reg9 = Nothing


 'Sql = "Select Count(*) nTotal, SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GEtFechaCierreMes, "mm/dd/yyyy") & "') THEN 1 ELSE 0 END ) as nNumCredNew, "
 'Sql = Sql & " SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GEtFechaCierreMes, "mm/dd/yyyy") & "') THEN C.nMontoApr ELSE 0 END )  as nPrestamos, SUM(nSaldoCap) as nSaldoCap, "
 'Sql = Sql & " SUM( CASE WHEN C.cRefinan='N' OR C.cRefinan is NULL THEN 0 ELSE C.nSaldoCap END ) as nSaldoRef "
 'Sql = Sql & " From " & psServConsol & "CreditoConsol C "
 
 sql = " Select Count(*) nTotal, SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') THEN 1 ELSE 0 END ) as nNumCredNew, "
 sql = sql & " SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') THEN (CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoApr ELSE C.nMontoApr * " & lpTipCambio & "  END) ELSE 0 END )  as  nPrestamos, SUM(CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN nSaldoCap ELSE nSaldoCap * " & lpTipCambio & " END ) as nSaldoCap, "
 sql = sql & " SUM( CASE WHEN C.cRefinan='N' OR C.cRefinan is NULL THEN 0 ELSE (CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap ELSE C.nSaldoCap * " & lpTipCambio & " END ) END ) as nSaldoRef "
 sql = sql & " From " & psServConsol & "CreditoConsol C "
 sql = sql & " Where SUBSTRING(C.cCtaCod,6,3) in ('305') "
 Set Reg9 = GetQuery(sql)
 
 lnNumCre = Reg9!nTotal
 lnNumCreNue = Reg9!nNumCredNew
 lnSaldoCapNue = Reg9!nPrestamos
 lnSaldoCapRef = Reg9!nSaldoRef
 lnSaldoCap = Reg9!nSaldoCap
 Reg9.Close
 
lnNumCreTotal = lnNumCreTotal + lnNumCre
 lnNumCreNueTotal = lnNumCreNueTotal + lnNumCreNue
 lnSaldoCapNueTotal = lnSaldoCapNueTotal + lnSaldoCapNue
 lnSaldoCapRefTotal = lnSaldoCapRefTotal + lnSaldoCapRef
 lnSaldoCapTotal = lnSaldoCapTotal + lnSaldoCap

 lsRtfImp = lsRtfImp & " CREDITOS PIGNORATICIO          "
 lsRtfImp = lsRtfImp & ImpreFormat(lnNumCre, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnNumCreNue, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapNue, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapRef, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnSaldoCapNue / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCap, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnSaldoCap / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & Chr(10)
' ********************************

'Sql = "Select Count(*) nTotal, SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GEtFechaCierreMes, "mm/dd/yyyy") & "') THEN 1 ELSE 0 END ) as nNumCredNew, "
' Sql = Sql & " SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GEtFechaCierreMes, "mm/dd/yyyy") & "') THEN C.nMontoApr ELSE 0 END )  as nPrestamos, SUM(nSaldoCap) as nSaldoCap, "
' Sql = Sql & " SUM( CASE WHEN C.cRefinan='N' OR C.cRefinan is NULL THEN 0 ELSE C.nSaldoCap END ) as nSaldoRef "
' Sql = Sql & " From " & psServConsol & "CreditoConsol C "
 
 sql = " Select Count(*) nTotal, SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') THEN 1 ELSE 0 END ) as nNumCredNew, "
 sql = sql & " SUM( CASE WHEN MONTH(C.dFecVig) = MONTH('" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') THEN (CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoApr ELSE C.nMontoApr * " & lpTipCambio & "  END) ELSE 0 END )  as  nPrestamos, SUM(CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN nSaldoCap ELSE nSaldoCap * " & lpTipCambio & " END ) as nSaldoCap, "
 sql = sql & " SUM( CASE WHEN C.cRefinan='N' OR C.cRefinan is NULL THEN 0 ELSE (CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap ELSE C.nSaldoCap * " & lpTipCambio & " END ) END ) as nSaldoRef "
 sql = sql & " From " & psServConsol & "CreditoConsol C "
 sql = sql & " Where SUBSTRING(C.cCtaCod,6,1) in ('4') "
 Set Reg9 = GetQuery(sql)
 
 lnNumCre = Reg9!nTotal
 lnNumCreNue = Reg9!nNumCredNew
 lnSaldoCapNue = Reg9!nPrestamos
 lnSaldoCapRef = Reg9!nSaldoRef
 lnSaldoCap = Reg9!nSaldoCap
 Reg9.Close
 
lnNumCreTotal = lnNumCreTotal + lnNumCre
 lnNumCreNueTotal = lnNumCreNueTotal + lnNumCreNue
 lnSaldoCapNueTotal = lnSaldoCapNueTotal + lnSaldoCapNue
 lnSaldoCapRefTotal = lnSaldoCapRefTotal + lnSaldoCapRef
 lnSaldoCapTotal = lnSaldoCapTotal + lnSaldoCap

 lsRtfImp = lsRtfImp & " CREDITOS HIPOTECARIOS          "
 lsRtfImp = lsRtfImp & ImpreFormat(lnNumCre, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnNumCreNue, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapNue, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapRef, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnSaldoCapNue / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCap, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnSaldoCap / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & Chr(10)

  
'***********************************************
  ' Adiciono al Total  ******
 lnTNumCre = lnTNumCre + lnNumCre
 lnTSaldoCap = lnTSaldoCap + lnSaldoCap
 lnTNumCreNue = lnTNumCreNue + lnNumCreNue
 lnTSaldoCapNue = lnTSaldoCapNue + lnSaldoCapNue
 lnTSaldoCapRef = lnTSaldoCapRef + lnSaldoCapRef
 '*********
 
 lsRtfImp = lsRtfImp & " TOTAL " & Space(25)
 lsRtfImp = lsRtfImp & ImpreFormat(lnNumCreTotal, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnNumCreNueTotal, 10, 0, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapNueTotal, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapRefTotal, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnTSaldoCapNue / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & ImpreFormat(lnSaldoCapTotal, 13, 2, True)
 'lsRTfimp = lsRTfimp & ImpreFormat(lnTSaldoCap / lpTipCambio, 13, 2, True)
 lsRtfImp = lsRtfImp & Chr(10)
 lsRtfImp = lsRtfImp & String(120, "=") & Chr(10)
  RaiseEvent Progress(10, 10)
lsRtfImpG = lsRtfImp  ' Asigna la Cadena de Impresion
nRepo108710_ImpRepColocxSectEcon = lsRtfImpG
Screen.MousePointer = 1
RaiseEvent CloseProgress
End Function

Private Function CabRepColocxSectEcon(ByVal pPag As Integer, ByVal pTipCambio As Single) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
lsCad = lsCad & Chr(10)
lsCad = lsCad & gsNomCmac & Space(85) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(32) & "COLOCACIONES POR SECTORES ECONOMICOS DE DESTINO" & Space(30) & Format(gdFecSis, "dd/mm/yyyy") & Chr(10)
lsCad = lsCad & "TCF.= " & Format(pTipCambio, "#.000") & Space(40) & " ( EN NUEVOS SOLES )" & Chr(10)
lsCad = lsCad & Chr(10)
lsCad = lsCad & String(120, "=") & Chr(10)
lsCad = lsCad & " SECTOR ECONOMICO" & Space(15) & "# Deudores" & Space(10) & "Cred Desemb Nuevos" & Space(22)
lsCad = lsCad & "Saldo Actual" & Space(5) & Chr(10)
lsCad = lsCad & Space(46) & "# Cred" & Space(5) & "Cred Nuevos" & Space(3) & "Refin -  Reestr" & Space(2)
lsCad = lsCad & Chr(10)  '& Space(3) & "M. Extranjera" & Chr(10)
lsCad = lsCad & String(120, "=") & Chr(10)
CabRepColocxSectEcon = lsCad
End Function

Public Function nRepo108712_ImpReversionIntDeveng(ByVal psServConsol As String, _
ByVal pPlanCuentas As String, Optional ByVal psConcepto As String = "nSaldoCap") As String

Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPL As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String
Dim lsDescP As String
Dim lsDescF As String
Dim lsDescAG As String
Dim lsDescSubPr As String
Dim lsDescPL As String

Dim liLineas As Integer
Dim liDatos  As Long

Dim lnTCred As Single  ' *** General
Dim lnTSaldoCap As Double
Dim lnTNumVig As Single
Dim lnTCapVig As Double
Dim lnTNumVen1 As Integer
Dim lnTCapVen1  As Double
Dim lnTNumVen2 As Integer
Dim lnTCapVen2 As Double
Dim lnTNumJud As Integer
Dim lnTCapJud As Double
Dim lnTCapVenNJud As Double
Dim lnTCapVenSJud As Double

Dim lnTCredM As Single  ' *** Moneda
Dim lnTSaldoCapM As Double
Dim lnTNumVigM As Single
Dim lnTCapVigM As Double
Dim lnTNumVen1M As Integer
Dim lnTCapVen1M  As Double
Dim lnTNumVen2M As Integer
Dim lnTCapVen2M As Double
Dim lnTNumJudSDemM As Integer  ' Sin Deman
Dim lnTCapJudSDemM As Double
Dim lnTNumJudCDemM As Integer  ' Con Deman
Dim lnTCapJudCDemM As Double

Dim lnTCredF As Single  ' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double
Dim lnTNumVigF As Single
Dim lnTCapVigF As Double
Dim lnTNumVen1F As Integer
Dim lnTCapVen1F  As Double
Dim lnTNumVen2F As Integer
Dim lnTCapVen2F As Double
Dim lnTNumJudSDemF As Integer  'Sin Dema
Dim lnTCapJudSDemF As Double
Dim lnTNumJudCDemF As Integer  'Con Deman
Dim lnTCapJudCDemF As Double

Dim lnTCredAG As Single  ' *** Agencia
Dim lnTSaldoCapAG As Double
Dim lnTNumVigAG As Single
Dim lnTCapVigAG As Double
Dim lnTNumVen1AG As Integer
Dim lnTCapVen1AG  As Double
Dim lnTNumVen2AG As Integer
Dim lnTCapVen2AG As Double
Dim lnTNumJudSDemAG As Integer  'sin Dema
Dim lnTCapJudSDemAG As Double
Dim lnTNumJudCDemAG As Integer  'con dema
Dim lnTCapJudCDemAG As Double

Dim lnTCredPr As Single  ' *** Producto - detalle
Dim lnTSaldoCapPr As Double
Dim lnTNumVigPr As Single
Dim lnTCapVigPr As Double
Dim lnTNumVen1Pr As Integer
Dim lnTCapVen1Pr  As Double
Dim lnTNumVen2Pr As Integer
Dim lnTCapVen2Pr As Double
Dim lnTNumJudSDemPr As Integer
Dim lnTCapJudSDemPr As Double
Dim lnTNumJudCDemPr As Integer
Dim lnTCapJudCDemPr As Double



Dim lnTCredSubPr As Single  ' *** Sub Producto
Dim lnTSaldoCapSubPr As Double
Dim lnTNumVigSubPr As Single
Dim lnTCapVigSubPr As Double
Dim lnTNumVen1SubPr As Integer
Dim lnTCapVen1SubPr  As Double
Dim lnTNumVen2SubPr As Integer
Dim lnTCapVen2SubPr As Double
Dim lnTNumJudSDemSubPr As Integer
Dim lnTCapJudSDemSubPr As Double
Dim lnTNumJudCDemSubPr As Integer
Dim lnTCapJudCDemSubPr As Double

Dim lnTCredProd As Single  ' *** Producto
Dim lnTSaldoCapProd As Double
Dim lnTNumVigProd As Single
Dim lnTCapVigProd As Double
Dim lnTNumVen1Prod As Integer
Dim lnTCapVen1Prod  As Double
Dim lnTNumVen2Prod As Integer
Dim lnTCapVen2Prod As Double
Dim lnTNumJudSDemProd As Integer
Dim lnTCapJudSDemProd As Double
Dim lnTNumJudCDemProd As Integer
Dim lnTCapJudCDemProd As Double

Dim lnTCredPL As Single  ' *** Plazo
Dim lnTSaldoCapPL As Double
Dim lnTNumVigPL As Single
Dim lnTCapVigPL As Double
Dim lnTNumVen1PL As Integer
Dim lnTCapVen1PL  As Double
Dim lnTNumVen2PL As Integer
Dim lnTCapVen2PL As Double
Dim lnTNumJudSDemPL As Integer
Dim lnTCapJudSDemPL As Double
Dim lnTNumJudCDemPL As Integer
Dim lnTCapJudCDemPL As Double

Dim lbSiCambio As Boolean
Dim cadena As String

Dim lnCapVencido As Currency  'Para los consumo
Dim sql As String

Dim prod(8) As String
Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsRtfImp As String
Dim cpag As Integer

Dim NumSubProd As Integer ' SubProductos
Dim SubProd(10, 20) As String
Dim J As Integer
Dim NorRef As Integer

RaiseEvent ShowProgress

Dim lsConceptoJud As String
Dim lsCondJud As String
Dim lsConcepto As String
If psConcepto = "nSaldoCap" Then
   lsConceptoJud = "nSaldoCap"
   lsCondJud = " nSaldoCap > 0 "
Else
   lsConceptoJud = "nIntDev"
   lsCondJud = " nIntDev > 0 "
End If

If psConcepto = "nSaldoCap" Then
   lsConcepto = "C"
Else
   lsConcepto = "I"
End If

'********************

Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim lsCreditosJudicial As String
Dim i As Integer
Dim lsRtfImpG As String
Dim FechaCierre As Date


Dim lSSQL9 As String
FechaCierre = GetFechaCierreMes

lsCreditosVigentes = gColocEstVigNorm & ", " & gColocEstVigMor & "," & gColocEstVigVenc & ", " & gColocEstRefNorm & ", " & gColocEstRefMor & ", " & gColocEstRefVenc
'lsPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
lsPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07

lsCreditosJudicial = "2201,2205"

Dim MatLongitud(5) As Integer
Dim MatSubProdCod As Variant
Dim MatSubProdDes As Variant
Dim SubProdDesc(10, 20) As String   'Para evitar desbordamiento

For J = 0 To 4
    If J <> 3 Then
        MatSubProdCod = RecuperaMatrizTipoProducto(CStr(IIf(J = 4, J, J + 1)), "nConsValor")
        MatLongitud(J) = UBound(MatSubProdCod)
        For i = 0 To UBound(MatSubProdCod) - 1
            SubProd(J, i) = MatSubProdCod(i)
        Next
    End If
Next J

'Pignoraticio
SubProd(3, 0) = "'305'"

For J = 0 To 4
    If J <> 3 Then
        MatSubProdDes = RecuperaMatrizTipoProducto(CStr(IIf(J = 4, J, J + 1)), "cConsDescripcion")
        For i = 0 To UBound(MatSubProdDes) - 1
            SubProdDesc(J, i) = MatSubProdDes(i)
        Next
    End If
Next J

SubProdDesc(3, 0) = "Prendario"

'SubProd(0, 0) = " '101' " ' Comerciales Empres
'SubProd(0, 1) = " '102' " ' Comerciales Agricola
'SubProd(1, 0) = " '201' " ' Mes Empresar
'SubProd(1, 1) = " '202' " ' Mes Agricola
'SubProd(2, 0) = " '301' " ' Consumo DxP
'SubProd(2, 1) = " '302' " ' Consumo Aval PF
'SubProd(2, 2) = " '303' " ' Consumo Aval CTS
'SubProd(2, 3) = " '304' " ' Consumo Usos diversos
'SubProd(2, 4) = " '320' " ' Consumo Prestamo Administrativos
'SubProd(3, 0) = " '305' " ' Prendario
'SubProd(4, 0) = " '423' " ' Hipotecario

' Para Cada Producto
'prod(0) = " '101','102' "  ' Comercial
'prod(1) = " '201','202' "  ' Mes Pyme-Mes
'prod(2) = " '301','302','303','304','320'"  ' Consumo
'prod(3) = " '305' "  ' Prendario
'prod(4) = " '423'" ' Hipotecario
'For I = 0 To 3
'    prod(I) = RecuperaCadenaTipoProducto(CStr(I + 1))
'Next
prod(0) = RecuperaCadenaTipoProducto("1")
prod(1) = RecuperaCadenaTipoProducto("2")
prod(2) = RecuperaCadenaTipoProducto("3")
prod(3) = "'305'"
prod(4) = RecuperaCadenaTipoProducto("4")


lbSiCambio = False

lbSiCambio = False
lsRtfImp = ""
cpag = 1
Dim tmpRepRevIntDev As String
cadena = ""
'===== Verificar si existen datos para el reporte
Sql9 = "SELECT COUNT(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol where nPrdEstado in (" & lsCreditosVigentes & ")"
Set Reg9 = GetQuery(Sql9)
If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing
liDatos = liDatos + Round(liDatos / 10, 0)
If liDatos > 0 Then  ' General
  Sql9 = " delete " & psServConsol & "tmpRepRevIntDev  "
    Conecta.AbreConexion
    Conecta.Ejecutar (Sql9)
    'Conecta.CierraConexion
          
      Sql9 = " Insert into " & psServConsol & "tmpRepRevIntDev  " _
           & " Select " _
           & " substring(CA.cCtaCod,9,1) Moneda, substring(CA.cCtaCod,6,3) Producto," _
           & " substring(CA.cCtaCod,4,2) Agencia,  substring(CA.cCtaCod,6,3) SubProducto," _
           & " substring(CA.cLineaCred,1,4) FFinanciamiento, substring(CA.cLineaCred,6,1) Plazo, Ca.cRefinan, Ca.nPrdEstado," _
           & " COUNT(ca.cCtaCod) as Numero, Isnull(sum(Ca.nSaldoCap),0) as Capital, Isnull(sum(nProvision),0) as Provision," _
           & " IsNull(SUM ( CASE WHEN CP.cCalGen = '0'  THEN Cp.nProvision else 0 END ), 0) AS Prov01," _
           & " IsNull(SUM ( CASE WHEN CP.cCalGen <> '0' THEN Cp.nProvision else 0 END ), 0) AS Prov02," _
           & " IsNull(Sum( Case When CP.cCtaCod like '_____1%' AND Cp.cCalGen in('3','4') AND Ca.nDiasAtraso <= 15 and ca.nPrdEstado IN (" & lsCreditosVigentes & "," & lsPignoraticio & ") THEN Ca.nIntDev" _
           & "                  When CP.cCtaCod like '_____2%' AND Cp.cCalGen in('3','4') AND Ca.nDiasAtraso <= 30 and ca.nPrdEstado IN (" & lsCreditosVigentes & "," & lsPignoraticio & ") THEN Ca.nIntDev" _
           & "                  When CP.cCtaCod like '_____3%' AND Cp.cCalGen in('3','4') AND Ca.nDiasAtraso <= 30 and ca.nPrdEstado IN (" & lsCreditosVigentes & "," & lsPignoraticio & ") THEN Ca.nIntDev" _
           & "                  When CP.cCtaCod like '_____4%' AND Cp.cCalGen in('3','4') AND Ca.nDiasAtraso <= 30 and ca.nPrdEstado IN (" & lsCreditosVigentes & "," & lsPignoraticio & ") THEN Ca.nIntDev" _
           & "                  Else 0 End ) ,0) As IntDevengVig," _
           & " IsNull(Sum(Case  When CP.cCtaCod like '_____1%' AND Cp.cCalGen in('3','4') AND ca.nDiasAtraso > 15 THEN Ca.nIntDev " _
           & "                  When CP.cCtaCod like '_____2%' AND Cp.cCalGen in('3','4') AND ca.nDiasAtraso > 30 THEN Ca.nIntDev " _
           & "                  When CP.cCtaCod like '_____3%' AND Cp.cCalGen in('3','4') AND ca.nDiasAtraso > 30 THEN Ca.nIntDev " _
           & "                  When CP.cCtaCod like '_____4%' AND Cp.cCalGen in('3','4') AND ca.nDiasAtraso > 30 THEN Ca.nIntDev " _
           & "                  End ), 0)  AS IntDevengVen " _
           & " From " & psServConsol & " CreditoConsol Ca " _
           & " Left Join ColocCalifProv CP on Cp.cCtaCod = Ca.cCtaCod " _
           & " WHERE ca.nPrdEstado IN ( " & lsCreditosVigentes & "," & lsPignoraticio & "," & lsCreditosJudicial & " ) " _
           & " Group By substring(CA.cCtaCod,9,1) , substring(CA.cCtaCod,6,3) , substring(CA.cCtaCod,4,2) ," _
           & " substring(CA.cCtaCod,6,3) , substring(CA.cLineaCred,1,4) , substring(CA.cLineaCred,6,1) , Ca.cRefinan , Ca.nPrdEstado "

    'Conecta.AbreConexion
    Conecta.Ejecutar (Sql9)
    Conecta.CierraConexion
    
    '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)
    '======== Tipo de Plazo =========
        Set rsPL = loConst.RecuperaConstantes(gColocLineaCredPlazo)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    Set rsFF = ObtieneLineaCredito 'Fuente Financiamiento
    
   '======= Para Cada Agencia  =========
    Dim loAg As DAgencias
    'Dim rsAg As ADODB.Recordset
       Set loAg = New DAgencias
            Set rsAg = loAg.RecuperaAgencias
        Set loAg = Nothing

    If RsM.EOF And RsM.BOF Then
    Else
        Do While Not RsM.EOF
            '=====LIMPIAR LOS DATOS SUBTOTALES POR MONEDA ======
            lnTCredM = 0:   lnTSaldoCapM = 0
            lnTNumVigM = 0: lnTCapVigM = 0
            lnTNumVen1M = 0: lnTCapVen1M = 0
            lnTNumVen2M = 0: lnTCapVen2M = 0
            lnTNumJudSDemM = 0: lnTCapJudSDemM = 0
            lnTNumJudCDemM = 0: lnTCapJudCDemM = 0
            lsDescM = Trim(RsM!cConsDescripcion)
            '============ CREDITOS VIGENTES PARA UNA DETERMINADA MONEDA =========
            Sql9 = "SELECT Count(*) AS NumCred FROM " & psServConsol & "tmpRepRevIntDev c " & _
                " WHERE nPrdEstado in (" & lsCreditosVigentes & ") And " & _
                " Moneda = '" & Trim(RsM!nConsValor) & "'"
            Set Reg9 = GetQuery(Sql9)
            If Reg9.EOF And Reg9.BOF Then
                liDatos = 0
            Else
                liDatos = Reg9!NumCred
            End If
            Reg9.Close
            Set Reg9 = Nothing
            
            If liDatos > 0 Then  ' De la Moneda
                lsRtfImp = lsRtfImp & CabImpReversionIntDeveng(cpag, pPlanCuentas, lsConcepto)
                liLineas = 6
                If lbSiCambio Then
                    lbSiCambio = False
                End If
                lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                lsRtfImp = lsRtfImp & " * MONEDA             : " & lsDescM & Chr(27) & Chr(70) & Chr(10)
                liLineas = liLineas + 2
                
                '========= CREDITOS VIGENTES PARA PRODUCTO  =========
                 For i = 0 To 4  'Para Cada Producto
                 Select Case i
                      Case 0
                         lsDescPr = " Comercial    "
                      Case 1
                         lsDescPr = " MES          "
                      Case 2
                         lsDescPr = " Consumo"
                      Case 3
                         lsDescPr = " Prendario    "
                      Case 4
                         lsDescPr = " Hipotecario "
                   End Select
                   
                   '=========== CREDITOS DEL PRODUCTO =============
                     Sql9 = "SELECT Count(Moneda) as NumCred FROM " & psServConsol & "tmpRepRevIntDev  c " & _
                         " where nPrdEstado IN (" & lsCreditosVigentes & "," & lsPignoraticio & "," & lsCreditosJudicial & ") " & _
                         " AND Moneda  = '" & Trim(RsM!nConsValor) & "'" & _
                         " AND Producto  in ( " & prod(i) & ")"
                     
                     lnTCredProd = 0:   lnTSaldoCapProd = 0
                     lnTNumVigProd = 0: lnTCapVigProd = 0
                     lnTNumVen1Prod = 0: lnTCapVen1Prod = 0
                     lnTNumVen2Prod = 0: lnTCapVen2Prod = 0
                     lnTNumJudSDemProd = 0: lnTCapJudSDemProd = 0
                     lnTNumJudCDemProd = 0: lnTCapJudCDemProd = 0
                     
                     If HayDatos(Sql9) > 0 Then  ' Para Producto
                     
                        lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                        lsRtfImp = lsRtfImp & " ** PRODUCTO          : " & lsDescPr & Chr(27) & Chr(70) & Chr(10)
                        liLineas = liLineas + 3
                        
                        '======= Para Cada Agencia  =========
                        rsAg.MoveFirst
                        Do While Not rsAg.EOF
                                 
                           Sql9 = "SELECT Count(Moneda) as NumCred FROM " & psServConsol & "tmpRepRevIntDev c " & _
                                  " where nPrdEstado IN (" & lsCreditosVigentes & "," & lsPignoraticio & "," & lsCreditosJudicial & ") " & _
                                  " AND Moneda  = '" & Trim(RsM!nConsValor) & "'" & _
                                  " AND Producto  in ( " & prod(i) & ")" & _
                                  " AND Agencia  = '" & Trim(rsAg!cAgeCod) & "'"
                              
                              lnTCredAG = 0:   lnTSaldoCapAG = 0
                              lnTNumVigAG = 0: lnTCapVigAG = 0
                              lnTNumVen1AG = 0: lnTCapVen1AG = 0
                              lnTNumVen2AG = 0: lnTCapVen2AG = 0
                              lnTNumJudSDemAG = 0: lnTCapJudSDemAG = 0
                              lnTNumJudCDemAG = 0: lnTCapJudCDemAG = 0
                             
                             If HayDatos(Sql9) > 0 Then    ' De la Agencia

                                 lsDescAG = rsAg!cAgeDescripcion
                                 lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                 lsRtfImp = lsRtfImp & " *** AGENCIA          : " & lsDescAG & Chr(27) & Chr(70) & Chr(10)
                                 liLineas = liLineas + 2
                                 
                                'Select Case I
                                '    Case 0, 1: NumSubProd = 1
                                '    Case 2:    NumSubProd = 4
                                 '   Case 3, 4: NumSubProd = 0
                                ' End Select
                                 NumSubProd = MatLongitud(i) - 1
                                 '========= CREDITOS VIGENTES PARA SUB PRODUCTOS  =========
                                 For J = 0 To NumSubProd  'Para Cada SubProductos
                                   
                                    lnTCredSubPr = 0:    lnTSaldoCapSubPr = 0
                                    lnTNumVigSubPr = 0:  lnTCapVigSubPr = 0
                                    lnTNumVen1SubPr = 0: lnTCapVen1SubPr = 0
                                    lnTNumVen2SubPr = 0: lnTCapVen2SubPr = 0
                                    lnTNumJudSDemSubPr = 0:  lnTCapJudSDemSubPr = 0
                                    lnTNumJudCDemSubPr = 0:  lnTCapJudCDemSubPr = 0
                                    
                                    Select Case i
                                      Case 0
                                        lsDescSubPr = SubProdDesc(0, J)
                                         'Select Case J
                                         '   Case 0: lsDescSubPr = " Comercial Empresarial   "
                                         '   Case 1: lsDescSubPr = " Comercial Agricola      "
                                         'End Select
                                      Case 1
                                        lsDescSubPr = SubProdDesc(1, J)
                                         'Select Case J
                                         '   Case 0: lsDescSubPr = " Mes Empresarial   "
                                         '   Case 1: lsDescSubPr = " Mes Agricola      "
                                         'End Select
                                      Case 2
                                        lsDescSubPr = SubProdDesc(2, J)
                                         'Select Case J
                                            'Case 0:  lsDescSubPr = " Consumo Dscto Planilla "
                                            'Case 1:  lsDescSubPr = " Consumo Aval PF "
                                            'Case 2:  lsDescSubPr = " Consumo Aval CTS "
                                            'Case 3:  lsDescSubPr = " Consumo Usos Diversos"
                                            'Case 4:  lsDescSubPr = " Consumo Administrativos    "
                                         'End Select
                                      Case 3
                                            lsDescSubPr = SubProdDesc(3, 0)
                                      Case 4
                                            lsDescSubPr = SubProdDesc(4, J)
                                            'lsDescSubPr = " Hipotecario "
                                    End Select

                                   '=========== CREDITOS DEL SUB PRODUCTO =============
                                    Sql9 = "SELECT Count(Moneda) as NumCred FROM " & psServConsol & "tmpRepRevIntDev c " & _
                                        " where nPrdEstado IN (" & lsCreditosVigentes & "," & lsPignoraticio & "," & lsCreditosJudicial & ") " & _
                                        " AND Moneda  = '" & Trim(RsM!nConsValor) & "'" & _
                                        " AND Producto  in ( " & prod(i) & ")" & _
                                        " AND Agencia  = '" & Trim(rsAg!cAgeCod) & "'" & _
                                        " AND SubProducto  in ( " & SubProd(i, J) & ")"
                                     
                                    
                                    If HayDatos(Sql9) > 0 Then ' Para Sub Productos
                                    
                                        lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                        lsRtfImp = lsRtfImp & " **** SUB PRODUCTO    : " & lsDescSubPr & Chr(27) & Chr(70) & Chr(10)
                                        liLineas = liLineas + 2
                                        
                                       '========= CREDITOS VIGENTES PARA FUENTES FINANCIAMIENTO =========
                                        
                                        If rsFF.EOF And rsFF.BOF Then 'Fuente Financ
                                        Else
                                            rsFF.MoveFirst
                                            Do While Not rsFF.EOF 'Fuente Financ
                                               '=========== CREDITOS VIGENTES PARA UNA FUENTE FINANCIAMIENTO =============
                                               Sql9 = " SELECT Count(Moneda) as NumCred from " & psServConsol & "tmpRepRevIntDev c " & _
                                                      " WHERE nPrdEstado IN (" & lsCreditosVigentes & "," & lsPignoraticio & "," & lsCreditosJudicial & ")" & _
                                                      " AND Moneda  = '" & Trim(RsM!nConsValor) & "'" & _
                                                      " AND Producto  in ( " & prod(i) & ")" & _
                                                      " AND Agencia  = '" & Trim(rsAg!cAgeCod) & "'" & _
                                                      " AND SubProducto  in ( " & SubProd(i, J) & ")" & _
                                                      " AND FFinanciamiento  IN ('" & Trim(rsFF!cLineaCred) & "')"
                        
                        
                                                lnTCredF = 0: lnTSaldoCapF = 0
                                                lnTNumVigF = 0: lnTCapVigF = 0
                                                lnTNumVen1F = 0: lnTCapVen1F = 0
                                                lnTNumVen2F = 0: lnTCapVen2F = 0
                                                lnTNumJudSDemF = 0: lnTCapJudSDemF = 0
                                                lnTNumJudCDemF = 0: lnTCapJudCDemF = 0
                                               If HayDatos(Sql9) > 0 Then       ' De la Fuente Financ
                            
                                                    lsDescF = Trim(rsFF!CDescripcion)
                                                    lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                                    lsRtfImp = lsRtfImp & " ***** F. FINANCIAMIENTO   : " & lsDescF & Chr(27) & Chr(70) & Chr(10)
                                                    liLineas = liLineas + 2
                                                    
                                                    lsDescF = Mid(rsFF!CDescripcion, 1, 25)

                                                    '======= Para Cada PLAZO  =========
                                                    If rsPL.EOF And rsPL.BOF Then ' Plazo
                                                    Else
                                                        rsPL.MoveFirst
                                                        Do While Not rsPL.EOF ' Plazo
                                                           lnTCredPL = 0: lnTSaldoCapPL = 0
                                                           lnTNumVigPL = 0: lnTCapVigPL = 0
                                                           lnTNumVen1PL = 0: lnTCapVen1PL = 0
                                                           lnTNumVen2PL = 0: lnTCapVen2PL = 0
                                                           lnTNumJudSDemPL = 0: lnTCapJudSDemPL = 0
                                                           lnTNumJudCDemPL = 0: lnTCapJudCDemPL = 0
                                                           lsDescPL = Mid(rsPL!cConsDescripcion, 1, 25)
                                                           
                                                           '=========== CREDITOS PARA EL PLAZO =============

                                                           Sql9 = "SELECT Count(*) as NumCred From " & psServConsol & "tmpRepRevIntDev c " & _
                                                                  " where nPrdEstado IN (" & lsCreditosVigentes & "," & lsPignoraticio & "," & lsCreditosJudicial & ") " & _
                                                                  " AND Moneda  = '" & Trim(RsM!nConsValor) & "'" & _
                                                                  " AND Producto  in ( " & prod(i) & ")" & _
                                                                  " AND Agencia  = '" & Right(Trim(rsAg!cAgeCod), 2) & "'" & _
                                                                  " AND SubProducto  in ( " & SubProd(i, J) & ")" & _
                                                                  " AND FFinanciamiento  IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                  " AND Plazo  IN ('" & Trim(rsPL!nConsValor) & "')"
                                                              
                                                            If HayDatos(Sql9) > 0 Then     ' Del PLAZO
                                
    
                                                               For NorRef = 0 To 1
                                                                    
                                                                lnTCredPr = 0: lnTSaldoCapPr = 0
                                                                lnTNumVigPr = 0: lnTCapVigPr = 0
                                                                lnTNumVen1Pr = 0: lnTCapVen1Pr = 0
                                                                lnTNumVen2Pr = 0: lnTCapVen2Pr = 0
                                                                lnTNumJudSDemPr = 0: lnTCapJudSDemPr = 0
                                                                lnTNumJudCDemPr = 0: lnTCapJudCDemPr = 0
                                                                lnTCapVenNJud = 0: lnTCapVenSJud = 0
                                                                lsDescPr = ""
                                                                   
                                                                   '=================================================
                                                                   '===== Total Cartera / Provision //  Producto de Agencia  ======
                                                                   '  Creditos ------------
                                                                   
                                                                  Sql9 = " SELECT IsNull(SUM(ca.Numero),0) as Numero, IsNull(SUM(ca.Capital),0) as Capital, " & _
                                                                         " IsNull(SUM (ca.Provision),0) as Provision ," & _
                                                                         " IsNull(SUM (ca.Prov01), 0) AS Prov01, " & _
                                                                         " IsNull(SUM (ca.Prov02), 0) AS Prov02, " & _
                                                                         " IsNull(SUM (ca.IntDevengVig), 0) AS IntDevengVig, " & _
                                                                         " IsNull(SUM (ca.IntDevengVen), 0) AS IntDevengVen " & _
                                                                         " From " & psServConsol & "tmpRepRevIntDev ca " & _
                                                                         " WHERE ca.nPrdEstado IN (" & lsCreditosVigentes & "," & lsPignoraticio & "," & lsCreditosJudicial & ") " & _
                                                                         " AND Moneda  = '" & Trim(RsM!nConsValor) & "'" & _
                                                                         " AND Producto  in ( " & prod(i) & ")" & _
                                                                         " AND Agencia  = '" & Trim(rsAg!cAgeCod) & "'" & _
                                                                         " AND SubProducto  in ( " & SubProd(i, J) & ")" & _
                                                                         " AND FFinanciamiento  IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                         " AND Plazo  IN ('" & Trim(rsPL!nConsValor) & "')" & _
                                                                         " AND ca.cRefinan in ( '" & IIf(NorRef = 0, "N", "R") & "') "
                                                                         
                                                   
                                                                   Set Reg9 = GetQuery(Sql9)
                                                                   lnTCredPr = Reg9!Numero
                                                                   lnTSaldoCapPr = Reg9!Capital
                                                                   lnTNumVigPr = 0
                                                                   lnTCapVigPr = Reg9!Provision
                                                                   lnTNumVen1Pr = 0
                                                                   lnTCapVen1Pr = Reg9!Prov01
                                                                   lnTNumVen2Pr = 0
                                                                   lnTCapVen2Pr = Reg9!Prov02
                                                                    
                                                                   lnTNumJudSDemPr = 0
                                                                   lnTCapJudSDemPr = Reg9!IntDevengVig
                                                                   
                                                                   lnTNumJudCDemPr = 0
                                                                   lnTCapJudCDemPr = Reg9!IntDevengVen
                                                                   
                                                                   Reg9.Close
                                                                   Set Reg9 = Nothing
                                                                   
                                                                   '=================================================
                                                                   ' ***** Asigna Valores a la Agencia ******
                                                                   lnTCredPL = lnTCredPL + lnTCredPr
                                                                   lnTSaldoCapPL = lnTSaldoCapPL + lnTSaldoCapPr
                                                                   lnTNumVigPL = lnTNumVigPL + lnTNumVigPr
                                                                   lnTCapVigPL = lnTCapVigPL + lnTCapVigPr
                                                                   lnTNumVen1PL = lnTNumVen1PL + lnTNumVen1Pr
                                                                   lnTCapVen1PL = lnTCapVen1PL + lnTCapVen1Pr
                                                                   lnTNumVen2PL = lnTNumVen2PL + lnTNumVen2Pr
                                                                   lnTCapVen2PL = lnTCapVen2PL + lnTCapVen2Pr
                                                                   lnTNumJudSDemPL = lnTNumJudSDemPL + lnTNumJudSDemPr
                                                                   lnTCapJudSDemPL = lnTCapJudSDemPL + lnTCapJudSDemPr
                                                                   lnTNumJudCDemPL = lnTNumJudCDemPL + lnTNumJudCDemPr
                                                                   lnTCapJudCDemPL = lnTCapJudCDemPL + lnTCapJudCDemPr
                                                                   
                                                                   ' *****  Imprime
                                                                   lsRtfImp = lsRtfImp & IIf(Trim(rsPL!nConsValor) = "1", " CP-", " LP-")
                                                                   lsRtfImp = lsRtfImp & IIf(NorRef = 0, "NORMAL     ", "REFINANC   ")
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPr, 10, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPr, 13, 2, True) & " | "
                                                                   'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVigPr, 8, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPr, 13, 2, True) & " | "
                                                                   'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen1Pr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1Pr, 12, 2, True) & " | "
                                                                   'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen2Pr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2Pr, 12, 2, True) & " | "
                                                                   'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudSDemPr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemPr, 12, 2, True) & " | "
                                                                   'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudCDemPr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemPr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & Chr(10)
                                                                   liLineas = liLineas + 1
                                                                   
                                                                   '************* Para Grabar en Tabla  (Simon)  **************
                                                                  ' 'Vigentes
                                                                  ' If lnTCapVigPr <> 0 Then
                                                                  '   sql9 = "INSERT CredSaldosCont (cConcepto, dFecha, cMoneda, nPrdEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                  '        & " VALUES ('" & lsConcepto & "','" & Format(gdFecData, "mm/dd/yyyy") & "', '" & Trim(rsM!nConsValor) & "', '1','" & IIf(NorRef = 0, "N", "R") & "','N'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Trim(rsFF!cLineaCred) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapVigPr & ")"
                                                                  '   'dbcmactcentral.Execute sql9
                                                                  ' End If
                                                                   
                                                                  ' 'Vencidas Adm por Age
                                                                  ' If lnTCapVen1Pr + lnTCapVen2Pr <> 0 Then
                                                                  '   sql9 = "INSERT CredSaldosCont (cConcepto, dFecha, cMoneda, nPrdEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                  '        & " VALUES ('" & lsConcepto & "','" & Format(gdFecData, "mm/dd/yyyy") & "', '" & Trim(rsM!nConsValor) & "', '5','" & IIf(NorRef = 0, "N", "R") & "','N'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Trim(rsFF!cLineaCred) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapVen1Pr + lnTCapVen2Pr & ")"
                                                                  '   'dbcmactcentral.Execute sql9
                                                                  ' End If
                                                                  '
                                                                  ' 'Judicial - Administ por Agencia
                                                                  ' If lnTCapJudSDemPr <> 0 Then
                                                                  '   sql9 = "INSERT CredSaldosCont (cConcepto, dFecha, cMoneda, nPrdEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                  '        & " VALUES ('" & lsConcepto & "','" & Format(gdFecData, "mm/dd/yyyy") & "', '" & Trim(rsM!nConsValor) & "', '5','" & IIf(NorRef = 0, "N", "R") & "','S'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Trim(rsFF!cLineaCred) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapJudSDemPr & ")"
                                                                  '   'dbcmactcentral.Execute sql9
                                                                  ' End If
                                                                   
                                                                  ' 'Judicial - Administ por Recup
                                                                  ' If lnTCapJudCDemPr <> 0 Then
                                                                  '   sql9 = "INSERT CredSaldosCont (cConcepto, dFecha, cMoneda, nPrdEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                  '        & " VALUES ('" & lsConcepto & "','" & Format(gdFecData, "mm/dd/yyyy") & "', '" & Trim(rsM!nConsValor) & "', '6','" & IIf(NorRef = 0, "N", "R") & "','S'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Trim(rsFF!cLineaCred) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapJudCDemPr & ")"
                                                                  '   'dbcmactcentral.Execute sql9
                                                                  ' End If
                                                                   '***********************************************************
                                                                   
                                                                   '=================================================
                                                               Next NorRef
                            
                                                               'End If  ' Fin de Si encuentra Datos
                                                               ' ***** Asigna Valores a F.Financia******
                                                               lnTCredF = lnTCredF + lnTCredPL
                                                               lnTSaldoCapF = lnTSaldoCapF + lnTSaldoCapPL
                                                               lnTNumVigF = lnTNumVigF + lnTNumVigPL
                                                               lnTCapVigF = lnTCapVigF + lnTCapVigPL
                                                               lnTNumVen1F = lnTNumVen1F + lnTNumVen1PL
                                                               lnTCapVen1F = lnTCapVen1F + lnTCapVen1PL
                                                               lnTNumVen2F = lnTNumVen2F + lnTNumVen2PL
                                                               lnTCapVen2F = lnTCapVen2F + lnTCapVen2PL
                                                               lnTNumJudSDemF = lnTNumJudSDemF + lnTNumJudSDemPL
                                                               lnTCapJudSDemF = lnTCapJudSDemF + lnTCapJudSDemPL
                                                               lnTNumJudCDemF = lnTNumJudCDemF + lnTNumJudCDemPL
                                                               lnTCapJudCDemF = lnTCapJudCDemF + lnTCapJudCDemPL
                                                               
                                                               ' *****  Imprime
                                                               lsRtfImp = lsRtfImp & String(150, "-") & Chr(10)
                                                               lsRtfImp = lsRtfImp & " TOT. PLAZO    " ' & lsDescPr
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPL, 10, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPL, 13, 2, True) & " | "
                                                               'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVigPL, 8, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPL, 13, 2, True) & " | "
                                                               'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen1PL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1PL, 12, 2, True) & " | "
                                                               'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen2PL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2PL, 12, 2, True) & " | "
                                                               'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudSDemPL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemPL, 12, 2, True) & " | "
                                                               'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudCDemPL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemPL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & Chr(10)
                                                               liLineas = liLineas + 2
                                                               ' ****************************
                                                               ' ****  Verifica Si Cambio pagina
                                                               If liLineas >= 54 Then 'Para el control de salto de página
                                                                  lsRtfImp = lsRtfImp & Chr(12)
                                                                  cpag = cpag + 1
                                                                  lsRtfImp = lsRtfImp & CabImpReversionIntDeveng(cpag, pPlanCuentas, lsConcepto)
                                                                  liLineas = 6
                                                               End If
                                                           
                                                           End If   ' Si encuentra Datos en Plazo
                                                           rsPL.MoveNext
                                                        Loop   ' Plazo
                                                    End If   ' Plazo
                                                    ' ***************************************
                                                    ' ***** Asigna Valores a Sub Producto ******
                                                    lnTCredSubPr = lnTCredSubPr + lnTCredF
                                                    lnTSaldoCapSubPr = lnTSaldoCapSubPr + lnTSaldoCapF
                                                    lnTNumVigSubPr = lnTNumVigSubPr + lnTNumVigF
                                                    lnTCapVigSubPr = lnTCapVigSubPr + lnTCapVigF
                                                    lnTNumVen1SubPr = lnTNumVen1SubPr + lnTNumVen1F
                                                    lnTCapVen1SubPr = lnTCapVen1SubPr + lnTCapVen1F
                                                    lnTNumVen2SubPr = lnTNumVen2SubPr + lnTNumVen2F
                                                    lnTCapVen2SubPr = lnTCapVen2SubPr + lnTCapVen2F
                                                    lnTNumJudSDemSubPr = lnTNumJudSDemSubPr + lnTNumJudSDemF
                                                    lnTCapJudSDemSubPr = lnTCapJudSDemSubPr + lnTCapJudSDemF
                                                    lnTNumJudCDemSubPr = lnTNumJudCDemSubPr + lnTNumJudCDemF
                                                    lnTCapJudCDemSubPr = lnTCapJudCDemSubPr + lnTCapJudCDemF
                                                    ' *****  Imprime
                                                    lsRtfImp = lsRtfImp & String(150, "-") & Chr(10)
                                                    lsRtfImp = lsRtfImp & " TOT. F.FINANC." ' & lsDescPr
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCredF, 10, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapF, 13, 2, True) & " | "
                                                    'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVigF, 8, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigF, 13, 2, True) & " | "
                                                    'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen1F, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1F, 12, 2, True) & " | "
                                                    'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen2F, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2F, 12, 2, True) & " | "
                                                    'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudSDemF, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemF, 12, 2, True) & " | "
                                                    'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudCDemF, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemF, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & Chr(10)
                                                    liLineas = liLineas + 2
                                                    
                                                    ' ****************************
                                                    ' ****  Verifica Si Cambio pagina
                                                    If liLineas >= 54 Then 'Para el control de salto de página
                                                       lsRtfImp = lsRtfImp & Chr(12)
                                                       cpag = cpag + 1
                                                       lsRtfImp = lsRtfImp & CabImpReversionIntDeveng(cpag, pPlanCuentas, lsConcepto)
                                                       liLineas = 6
                                                    End If
                                        
                                               End If  ' Fuentes Financiamiento
                                               rsFF.MoveNext
                                            Loop  ' fuente Financiamiento
                                               
                                        End If   ' Fuente financiamiento
                                        
                                        ' ***************************************
                                        ' ***** Asigna Valores a Agencia  ******
                                        lnTCredAG = lnTCredAG + lnTCredSubPr
                                        lnTSaldoCapAG = lnTSaldoCapAG + lnTSaldoCapSubPr
                                        lnTNumVigAG = lnTNumVigAG + lnTNumVigSubPr
                                        lnTCapVigAG = lnTCapVigAG + lnTCapVigSubPr
                                        lnTNumVen1AG = lnTNumVen1AG + lnTNumVen1SubPr
                                        lnTCapVen1AG = lnTCapVen1AG + lnTCapVen1SubPr
                                        lnTNumVen2AG = lnTNumVen2AG + lnTNumVen2SubPr
                                        lnTCapVen2AG = lnTCapVen2AG + lnTCapVen2SubPr
                                        lnTNumJudSDemAG = lnTNumJudSDemAG + lnTNumJudSDemSubPr
                                        lnTCapJudSDemAG = lnTCapJudSDemAG + lnTCapJudSDemSubPr
                                        lnTNumJudCDemAG = lnTNumJudCDemAG + lnTNumJudCDemSubPr
                                        lnTCapJudCDemAG = lnTCapJudCDemAG + lnTCapJudCDemSubPr
                                        ' *****  Imprime
                                        lsRtfImp = lsRtfImp & String(150, "-") & Chr(10)
                                        lsRtfImp = lsRtfImp & "  TOT.SUBPROD. " ' & lsDescPr
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCredSubPr, 10, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapSubPr, 13, 2, True) & " | "
                                        'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVigSubPr, 8, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigSubPr, 13, 2, True) & " | "
                                        'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen1SubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1SubPr, 12, 2, True) & " | "
                                        'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen2SubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2SubPr, 12, 2, True) & " | "
                                        'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudSDemSubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemSubPr, 12, 2, True) & " | "
                                        'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudCDemSubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemSubPr, 12, 2, True) & " | "
                                        'If lnTSaldoCapSubPr <> 0 And lsConcepto = "C" Then
                                        '  lsRTfimp = lsRTfimp & ImpreFormat(Round(((lnTSaldoCapSubPr - lnTCapVigSubPr) / lnTSaldoCapSubPr) * 100, 2), 3, 2) & "%"
                                        'End If
                                        lsRtfImp = lsRtfImp & Chr(10)
                                        liLineas = liLineas + 2
                                        
                                        ' ****************************
                                        ' ****  Verifica Si Cambio pagina
                                        If liLineas >= 54 Then 'Para el control de salto de página
                                           lsRtfImp = lsRtfImp & Chr(12)
                                           cpag = cpag + 1
                                           lsRtfImp = lsRtfImp & CabImpReversionIntDeveng(cpag, pPlanCuentas, lsConcepto)
                                           liLineas = 6
                                        End If
                                    End If  ' Sub Productos
                                    DoEvents
                                 Next J
                                 
                                ' ***************************************
                                ' ***** Asigna Valores a Producto ******
                                lnTCredProd = lnTCredProd + lnTCredAG
                                lnTSaldoCapProd = lnTSaldoCapProd + lnTSaldoCapAG
                                lnTNumVigProd = lnTNumVigProd + lnTNumVigAG
                                lnTCapVigProd = lnTCapVigProd + lnTCapVigAG
                                lnTNumVen1Prod = lnTNumVen1Prod + lnTNumVen1AG
                                lnTCapVen1Prod = lnTCapVen1Prod + lnTCapVen1AG
                                lnTNumVen2Prod = lnTNumVen2Prod + lnTNumVen2AG
                                lnTCapVen2Prod = lnTCapVen2Prod + lnTCapVen2AG
                                lnTNumJudSDemProd = lnTNumJudSDemProd + lnTNumJudSDemAG
                                lnTCapJudSDemProd = lnTCapJudSDemProd + lnTCapJudSDemAG
                                lnTNumJudCDemProd = lnTNumJudCDemProd + lnTNumJudCDemAG
                                lnTCapJudCDemProd = lnTCapJudCDemProd + lnTCapJudCDemAG
                                ' *****  Imprime
                                lsRtfImp = lsRtfImp & String(150, "-") & Chr(10)
                                lsRtfImp = lsRtfImp & " TOT. AGENCIA  "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCredAG, 10, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAG, 13, 2, True) & " | "
                                'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVigAG, 8, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigAG, 13, 2, True) & " | "
                                'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen1AG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1AG, 12, 2, True) & " | "
                                'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen2AG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2AG, 12, 2, True) & " | "
                                'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudSDemAG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemAG, 12, 2, True) & " | "
                                'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudCDemAG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemAG, 12, 2, True) & " | "
                                'If lnTSaldoCapAG <> 0 And lsConcepto = "C" Then
                                '    lsRTfimp = lsRTfimp & ImpreFormat(Round(((lnTSaldoCapAG - lnTCapVigAG) / lnTSaldoCapAG) * 100, 2), 3, 2) & "%"
                                'End If
                                lsRtfImp = lsRtfImp & Chr(10)
                                liLineas = liLineas + 2
                                 
                                If liLineas >= 54 Then 'Para el control de salto de página
                                   lsRtfImp = lsRtfImp & Chr(12)
                                   cpag = cpag + 1
                                   lsRtfImp = lsRtfImp & CabImpReversionIntDeveng(cpag, pPlanCuentas, lsConcepto)
                                   liLineas = 6
                                End If
                             End If  ' De la Agencia
                             rsAg.MoveNext
                             
                               '**
                         Loop   ' De agencia
                         
                     End If '  Producto
                         
                    ' ***************************************
                    ' ***** Asigna Valores a MONEDA   ******
                    lnTCredM = lnTCredM + lnTCredProd
                    lnTSaldoCapM = lnTSaldoCapM + lnTSaldoCapProd
                   ' i = i - 1
                    lnTNumVigM = lnTNumVigM + lnTNumVigProd
                    lnTCapVigM = lnTCapVigM + lnTCapVigProd
                    lnTNumVen1M = lnTNumVen1M + lnTNumVen1Prod
                    lnTCapVen1M = lnTCapVen1M + lnTCapVen1Prod
                    lnTNumVen2M = lnTNumVen2M + lnTNumVen2Prod
                    lnTCapVen2M = lnTCapVen2M + lnTCapVen2Prod
                    lnTNumJudSDemM = lnTNumJudSDemM + lnTNumJudSDemProd
                    lnTCapJudSDemM = lnTCapJudSDemM + lnTCapJudSDemProd
                    lnTNumJudCDemM = lnTNumJudCDemM + lnTNumJudCDemProd
                    lnTCapJudCDemM = lnTCapJudCDemM + lnTCapJudCDemProd

                    ' *****  Imprime
                    lsRtfImp = lsRtfImp & String(150, "-") & Chr(10)
                    lsRtfImp = lsRtfImp & "  TOT PRODUCT  "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCredProd, 10, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapProd, 13, 2, True) & " | "
                    'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVigProd, 8, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigProd, 13, 2, True) & " | "
                    'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen1Prod, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1Prod, 12, 2, True) & " | "
                    'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen2Prod, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2Prod, 12, 2, True) & " | "
                    'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudSDemProd, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemProd, 12, 2, True) & " | "
                    'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudCDemProd, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemProd, 12, 2, True) & " | "
                    'If lnTSaldoCapProd <> 0 And lsConcepto = "C" Then
                    ' lsRTfimp = lsRTfimp & ImpreFormat(Round(((lnTSaldoCapProd - lnTCapVigProd) / lnTSaldoCapProd) * 100, 2), 3, 2) & "%"
                    'End If
                    lsRtfImp = lsRtfImp & Chr(10)
                    liLineas = liLineas + 2
                         
                 Next i   ' Para el Sgte Producto
                               
                ' *****  Imprime
                lsRtfImp = lsRtfImp & String(150, "-") & Chr(10)
                lsRtfImp = lsRtfImp & "  TOT MONEDA   "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCredM, 10, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapM, 13, 2, True) & " | "
                'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVigM, 8, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigM, 13, 2, True) & " | "
                'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen1M, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1M, 12, 2, True) & " | "
                'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumVen2M, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2M, 12, 2, True) & " | "
                'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudSDemM, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemM, 12, 2, True) & " | "
                'lsRTfimp = lsRTfimp & ImpreFormat(lnTNumJudCDemM, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemM, 12, 2, True) & " | "
                'If lnTSaldoCapM <> 0 And lsConcepto = "C" Then
                '  lsRTfimp = lsRTfimp & ImpreFormat(Round(((lnTSaldoCapM - lnTCapVigM) / lnTSaldoCapM) * 100, 2), 3, 2) & "%"
                'End If
                lsRtfImp = lsRtfImp & Chr(10)
                lsRtfImp = lsRtfImp & String(150, "-") & Chr(10)
                'lsRTfImp = lsRTfImp & Chr(10)
                liLineas = liLineas + 4
             
            End If '---liDatos - Moneda
            lbSiCambio = True
            RaiseEvent Progress(RsM.Bookmark, RsM.RecordCount)
            RsM.MoveNext
            If Not RsM.EOF Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                liLineas = 0
            End If
        Loop ' ---- Moneda
    End If '--- Moneda
    RsM.Close
    Set RsM = Nothing
    
Else
    'ImpReversionIntDeveng = False
End If '--- liDatos - General
lsRtfImpG = lsRtfImp ' Asigna el valor
nRepo108712_ImpReversionIntDeveng = lsRtfImpG
RaiseEvent CloseProgress
End Function

Public Function nRepo108713_ImpRepCarteraAgencia_Prod(ByVal psServConsol As String, ByVal pPlanCuentas As String, _
ByVal pTipoCambio As Single, ByVal psConcepto As String) As String
'Concepto C=Capital / D=Devengado  / S = Suspenso
Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPla As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String
Dim lsDescP As String
Dim lsDescF As String
Dim lsDescAG As String * 15

Dim liLineas As Integer
Dim liDatos  As Long

Dim lnTCred As Single  ' *** General
Dim lnTSaldoCap As Double
Dim lnTNumVig As Single
Dim lnTCapVig As Double
Dim lnTNumVen1 As Integer
Dim lnTCapVen1  As Double
Dim lnTNumVen2 As Integer
Dim lnTCapVen2 As Double
Dim lnTNumJud As Integer
Dim lnTCapJud As Double

Dim lnTCredT As Single  ' *** Total
Dim lnTSaldoCapT As Double
Dim lnTNumVigT As Single
Dim lnTCapVigT As Double
Dim lnTNumVen1T As Integer
Dim lnTCapVen1T  As Double
Dim lnTNumVen2T As Integer
Dim lnTCapVen2T As Double
Dim lnTNumJudT As Integer
Dim lnTCapJudT As Double

Dim lnTCredM(4) As Single  ' *** Moneda
Dim lnTSaldoCapM(4) As Double

Dim lnTCredF As Single  ' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double

Dim lnTCredAG As Single  ' *** Agencia
Dim lnTSaldoCapAG As Double

Dim lnTCredPr(4) As Single  ' *** Producto
Dim lnTSaldoCapPr(4) As Double

Dim lnTCredMonAG As Single  ' *** Moneda Agencia
Dim lnTSaldoCapMonAG As Double

Dim lnTSaldoCapTCons As Double

Dim lbSiCambio As Boolean
Dim cadena As String

Dim lnCapVencido As Currency  'Para los consumo

Dim prod(4) As String
Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsRtfImp As String
Dim cpag As Integer

Dim lnCredAdmin As Integer ' Bandera Para Cred Admin

Dim RCD As nRcdReportes
Dim Rss As New ADODB.Recordset
Dim TotAge
Set RCD = New nRcdReportes
Set Rss = RCD.GetQuery("select * from agencias")
TotAge = Rss.RecordCount
ReDim lnTCredPrM(TotAge, 4) As Single ' *** Producto Moneda
ReDim lnTSaldoCapPrM(TotAge, 4) As Double

Dim Ag As Integer
Dim lsConcepto As String
Dim lsCondic As String
'------------------
Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim lsCreditosJudicial As String
Dim i As Integer
Dim lsRtfImpG As String
Dim FechaCierre As Date
Dim lSSQL9 As String
Dim lsCodReport As String
FechaCierre = GetFechaCierreMes

lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
'lsPignoraticio = " 2101,2104,2106,2107 "
lsPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
lsCreditosJudicial = " 2201,2205 "
'--------------------------
If psConcepto = "C" Then
   lsConcepto = "nSaldoCap"
   lsCondic = " nSaldoCap > 0 "
ElseIf psConcepto = "D" Then
   lsConcepto = "nIntDev"
   lsCondic = " nDiasAtraso <= (case when substring(cCtaCod,6,1) = '1' then 15 else 30 end ) and cRefinan ='N' "
   'lsCondic = " NPRDESTADO IN (" & lsCreditosVigentes & ") "
   lsCodReport = "108713"
ElseIf psConcepto = "S" Then
   lsConcepto = "nIntDev"
   lsCondic = " ((nDiasAtraso > (case when substring(cCtaCod,6,1) = '1' then 15 else 30 end ) and cRefinan ='N') or (cRefinan = 'R') ) "
   'lsCondic = " NPRDESTADO IN (2030,2031,2032,2021) "
   lsCodReport = "108714"
End If
' Para Cada Producto
'prod(0) = " '101','102' "  ' Comerciales
'prod(1) = " '201','202' "  ' Mes
'prod(2) = " '301','302','303','304','320' "  ' Consumo
'prod(3) = " '305' "  ' Prendario
'prod(4) = " '423'" ' Hipotecario
prod(0) = RecuperaCadenaTipoProducto("1")   ' Comerciales
prod(1) = RecuperaCadenaTipoProducto("2")  ' Mes
prod(2) = RecuperaCadenaTipoProducto("3")  ' Consumo
prod(3) = "'305'"  ' Prendario
prod(4) = RecuperaCadenaTipoProducto("4") ' Hipotecario

lbSiCambio = False
lsRtfImp = ""
cpag = 1
cadena = ""

Ag = 0
Dim lnTCreTAgCons As Single  ' Total Agencia Consolidado
Dim lnTSaldoCapTAgCons As Currency

Dim lnTCreTProdCons(5) As Single  ' Total Producto Consolidado
Dim lnTSaldoCapTProdCons(5) As Currency

'===== Verificar si existen datos para el reporte
Sql9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol where nPrdEstado in (" & lsCreditosVigentes & ")"
Set Reg9 = GetQuery(Sql9)

If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then  ' General
    '======== Tipo de Moneda =========
    'Set rsM = ObtieneTablaCod("03") ' Moneda
   '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)

    '======= Para Cada Agencia  =========
    Dim loAg As DAgencias
    Set loAg = New DAgencias
        Set rsAg = loAg.RecuperaAgencias
    Set loAg = Nothing

    nRepo108713_ImpRepCarteraAgencia_Prod = ""
    'lsRTfImp = lsRTfImp & CabRepCarteraAgencia_Prod(cpag, pTipoCambio, pPlanCuentas)
    liLineas = 5
    RaiseEvent ShowProgress
    If RsM.EOF And RsM.BOF Then
    Else
       Do While Not RsM.EOF
          lsRtfImp = lsRtfImp & CabRepIntereses_Prod(cpag, pTipoCambio, pPlanCuentas, psConcepto, lsCodReport)
          '=====LIMPIAR LOS DATOS SUBTOTALES POR MONEDA ======
          For i = 0 To 4
              lnTCredM(i) = 0:     lnTSaldoCapM(i) = 0
          Next i
          lnTSaldoCapMonAG = 0
          lsDescM = Trim(RsM!cConsDescripcion)
          lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
          lsRtfImp = lsRtfImp & " MONEDA      : " & lsDescM & Chr(27) & Chr(70) & Chr(10)
          liLineas = liLineas + 1
          'For i = 1 To 5  ' Limpiar
          '    lnTCredPrM(i) = 0:     lnTSaldoCapPrM(i) = 0
          'Next i

          '======= Para Cada Agencia  =========
          Ag = 0
          rsAg.MoveFirst
          Do While Not rsAg.EOF
             Ag = Ag + 1
             lnTCredAG = 0: lnTSaldoCapAG = 0
             lsDescAG = Mid(rsAg!cAgeDescripcion, 1, 20)
             lsRtfImp = lsRtfImp & lsDescAG

             For i = 0 To 4 '4  'Para Cada Producto
                lnTCredPr(i) = 0:     lnTSaldoCapPr(i) = 0
                '===== Total Cartera  Producto de MONEDA  ======
                 Select Case i
                   Case 0, 1, 2, 4
                      '  Comercial / Mes / Consumo  / Hipotecario
                      'SQL9 = "SELECT COUNT(cCtaCod) AS Numero, SUM(" & lsConcepto & ") AS Capital " & _
                      '         " from " & psServConsol & "CreditoConsol " & _
                      '         " WHERE  " & _
                      '         "  substring(cCtaCod,4,2) = '" & Trim(rsAg!cAgeCod) & "'" & _
                      '         " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                      '         " AND substring(cCtaCod,6,3) in ( " & prod(I) & ") " & _
                      '         " AND " & lsCondic
                    
                        Sql9 = "SELECT COUNT(cCtaCod) AS Numero, SUM(" & lsConcepto & ") AS Capital " & _
                               " from " & psServConsol & "CreditoConsol " & _
                               " WHERE nPrdEstado in (" & lsCreditosVigentes & " )" & _
                               " AND substring(cCtaCod,4,2) = '" & Trim(rsAg!cAgeCod) & "'" & _
                               " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ") " & _
                               " AND " & lsCondic
                    

                      Set Reg9 = GetQuery(Sql9)
                      lnTCredPr(i) = Reg9!Numero
                      lnTSaldoCapPr(i) = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                      Reg9.Close
                      Set Reg9 = Nothing
                      If psConcepto = "C" Or psConcepto = "S" Then
                      '  ' Judicial -------------
                         Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                              " SUM(" & lsConcepto & ") AS Capital " & _
                             " from " & psServConsol & "CreditoConsol " & _
                             " WHERE nPrdEstado in (" & lsCreditosJudicial & ") AND nSaldoCap >= 0" & _
                             " AND substring(cCtaCod,4,2) = '" & Right(Trim(rsAg!cAgeCod), 2) & "'" & _
                             " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                             " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                         Set Reg9 = GetQuery(Sql9)
                         lnTCredPr(i) = lnTCredPr(i) + Reg9!Numero
                         lnTSaldoCapPr(i) = lnTSaldoCapPr(i) + IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                         Reg9.Close
                         Set Reg9 = Nothing
                      End If

                   Case 3
                      lsDescPr = " Pignoraticio "
                      ' Pignoraticio  ------------
                      'If Trim(RsM!nConsValor) = "1" Then  ' Si es Soles
                         Sql9 = "SELECT count(cCtaCod) as Numero, Sum(" & lsConcepto & ") AS Capital " & _
                               " from " & psServConsol & "CreditoConsol WHERE nPrdEstado IN (" & lsPignoraticio & ") " & _
                               " AND substring(cCtaCod,4,2) = '" & Trim(rsAg!cAgeCod) & "'" & _
                               " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ") " & _
                               " " & IIf(psConcepto = "S", " and ndiasatraso>30 ", "and ndiasatraso<=30 ")

                         Set Reg9 = GetQuery(Sql9)
                         lnTCredPr(i) = Reg9!Numero
                         lnTSaldoCapPr(i) = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                         Reg9.Close
                         Set Reg9 = Nothing
                      'End If
                 End Select

                ' ********************************************
                ' ***** Asigna Valores al Total agencia    ***
                ' ********************************************
                lnTCredAG = lnTCredAG + lnTCredPr(i)
                lnTSaldoCapAG = lnTSaldoCapAG + lnTSaldoCapPr(i)


                ' *************************************************
                ' ***** Asigna Valores al Producto Total Moneda ***
                ' *************************************************
                lnTCredM(i) = lnTCredM(i) + lnTCredPr(i)
                lnTSaldoCapM(i) = lnTSaldoCapM(i) + lnTSaldoCapPr(i)


                ' ***** Asigna Valores al Consolidado de Producto Moneda ***
                ' ***** y el cambio de moneda   *************
                lnTCredPrM(Ag, i) = lnTCredPrM(Ag, i) + lnTCredPr(i)
                lnTSaldoCapPrM(Ag, i) = lnTSaldoCapPrM(Ag, i) + IIf(Trim(RsM!nConsValor) = "1", lnTSaldoCapPr(i), lnTSaldoCapPr(i) * pTipoCambio)

                ' *****  Imprime Producto de la Moneda
                'lsRTfImp = lsRTfImp & Chr(10)
                'liLineas = liLineas + 1
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPr(i), 12, 2, True) & " | "
                'If I = 4 Then
                If i = 4 Then
                   lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAG, 12, 2, True) & " | " & Chr(10)
                End If
             Next i   ' Para el Sgte Producto
             'liLineas = liLineas + 4
             ' ** Sgte agencia
             
             rsAg.MoveNext
          Loop  ' de Agencia
         ' **********************
         ' *****  Imprime Totales de Moneda
         'lsRTfImp = lsRTfImp & Chr(10)
         lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
         lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
         lsRtfImp = lsRtfImp & " TOTAL MONEDA  "

         For i = 0 To 4 '4
           'lsRTfImp = lsRTfImp & ImpreFormat(lnTCredM(i), 10, 0, True)
           lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapM(i), 12, 2, True) & " | "
           lnTSaldoCapMonAG = lnTSaldoCapMonAG + lnTSaldoCapM(i)
         Next i

         lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapMonAG, 12, 2, True) & " | "
         lsRtfImp = lsRtfImp & Chr(27) & Chr(70) & Chr(10)
         lsRtfImp = lsRtfImp & String(155, "=") & Chr(10) & Chr(12)
         cpag = cpag + 1
         RaiseEvent Progress(RsM.Bookmark, RsM.RecordCount + rsAg.RecordCount)
         RsM.MoveNext

       Loop ' ---- Moneda de Producto


    End If
     
    lsRtfImp = lsRtfImp & CabRepIntereses_Prod(cpag, pTipoCambio, pPlanCuentas, psConcepto, lsCodReport)
    lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69) & " CONSOLIDADO (Nuevos Soles) " & Chr(27) & Chr(70) & Chr(10)

    '======= Para Cada Agencia  =========
    Ag = 0
    rsAg.MoveFirst
    Do While Not rsAg.EOF
       Ag = Ag + 1
       lsDescAG = Mid(rsAg!cAgeDescripcion, 1, 20)
       'lsRTfImp = lsRTfImp & Chr(10)
       lsRtfImp = lsRtfImp & lsDescAG

       lnTCreTAgCons = 0
       lnTSaldoCapTAgCons = 0

       For i = 0 To 4 '4  ' Consolidado

           'lsRTfImp = lsRTfImp & ImpreFormat(lnTCredPrM(i), 10, 0, True)
           lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPrM(Ag, i), 12, 2, True) & " | "

           'Total Agencia Consolidado
           lnTSaldoCapTAgCons = lnTSaldoCapTAgCons + lnTSaldoCapPrM(Ag, i)

           'Total Producto Consolidado
           lnTSaldoCapTProdCons(i) = lnTSaldoCapTProdCons(i) + lnTSaldoCapPrM(Ag, i)

       Next i
       lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapTAgCons, 12, 2, True) & " | " & Chr(10)
       liLineas = liLineas + 1
       RaiseEvent Progress(RsM.RecordCount + rsAg.Bookmark, RsM.RecordCount + rsAg.RecordCount)
       rsAg.MoveNext
    Loop


    lsRtfImp = lsRtfImp & Chr(10)



''   ' **********************
''   ' *****  Imprime Totales Consolidado
    lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
    lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
    lsRtfImp = lsRtfImp & "Tot. Consolidado"

    'Total Consolidado
    lnTSaldoCapTCons = 0

    For i = 0 To 4 '4  ' Consolidado
        lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapTProdCons(i), 12, 2, True) & " | "
        'Total Consolidado
        lnTSaldoCapTCons = lnTSaldoCapTCons + lnTSaldoCapTProdCons(i)
    Next i

    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapTCons, 12, 2, True) & " | " & Chr(10)
    liLineas = liLineas + 1

    lsRtfImp = lsRtfImp & Chr(27) & Chr(70)
    lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)

    RsM.Close
    Set RsM = Nothing

Else
    nRepo108713_ImpRepCarteraAgencia_Prod = ""
End If '--- liDatos - General
lsRtfImpG = lsRtfImp ' Asigna el valor
nRepo108713_ImpRepCarteraAgencia_Prod = lsRtfImpG
RaiseEvent CloseProgress
Set RCD = Nothing
Set Rss = Nothing
End Function

Public Sub nRepo108715_ImpRepSaldoCartera_Rango(ByVal psServConsol As String, ByVal pPlanCuentas As String, pTipoCambio As Single)
Dim xlAplicacion As Excel.Application
Dim xlLibro As Excel.Workbook
Dim xlHoja1 As Excel.Worksheet  'Micro
Dim fs As Scripting.FileSystemObject
Dim Sql9 As String
Dim Reg9 As New ADODB.Recordset

Dim lnTNumVigS(2, 20) As Single
Dim lnTCapVigS(2, 20) As Double
Dim lnTNumVen1S(2, 20) As Integer
Dim lnTCapVen1S(2, 20) As Double
Dim lnTNumVen2S(2, 20) As Integer
Dim lnTCapVen2S(2, 20) As Double

Dim lnTNumVigD(2, 20) As Single
Dim lnTCapVigD(2, 20) As Double
Dim lnTNumVen1D(2, 20) As Integer
Dim lnTCapVen1D(2, 20) As Double
Dim lnTNumVen2D(2, 20) As Integer
Dim lnTCapVen2D(2, 20) As Double

Dim prod(10) As String

Dim lsCadTotNumVig(20) As String   'Cadena para la formula de Totales
Dim lsCadTotCapVig(20) As String
Dim lsCadTotNumVen1(20) As String
Dim lsCadTotCapVen1(20) As String
Dim lsCadTotNumVen2(20) As String
Dim lsCadTotCapVen2(20) As String
Dim lsCadTotNumVen3(20) As String
Dim lsCadTotCapVen3(20) As String
Dim lsCadTotNumVen4(20) As String
Dim lsCadTotCapVen4(20) As String
Dim lsCadTotNumVen5(20) As String
Dim lsCadTotCapVen5(20) As String

Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsArchivo As String
Dim lbExisteHoja  As Boolean
Dim lsNomHoja As String
Dim lnFila As Integer

Dim lnProducto As Integer, lnMoneda As Integer
Dim lnNormRef As Integer
Dim lnAgencia As Integer, lnMaxAgencias As Integer
Dim lsRefinan As String


'------------------
Dim dFecData As Date
Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim lsCreditosJudicial As String
Dim i As Integer
Dim FechaCierre As Date
Dim lsRtfImpG As String
FechaCierre = GetFechaCierreMes
lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
'lsPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
'lsPignoraticio = " 2101,2104,2106,2107 "
lsPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
lsCreditosJudicial = gColocEstRecVigJud & ",2205"
'--------------------------

dFecData = GetFechaCierreMes

'ARCV 30-06-2006
' Para Cada Producto
'prod(1) = " '101','102' "  ' COMERCIAL
'prod(2) = " '201','202' "  ' MICROEMPRESA
'prod(3) = " '301','302','303','304' "  ' CONSUMO
'prod(4) = " '320'" ' Administrativos
'prod(5) = " '305'" ' PIGNORATICIO
'prod(6) = " '423'" ' MIVIVIENDA

prod(1) = RecuperaCadenaTipoProducto("1")  ' COMERCIAL
prod(2) = RecuperaCadenaTipoProducto("2")  ' MICROEMPRESA
prod(3) = RecuperaCadenaTipoProducto("3")  ' CONSUMO
'prod(4) = "''" ' Administrativos
prod(4) = " '305'" ' PIGNORATICIO
prod(5) = RecuperaCadenaTipoProducto("4") ' MIVIVIENDA


RaiseEvent ShowProgress
lsArchivo = "SaldoCartera_Rango" & Format(dFecData, "YYYYMM") & ".XLS"
Set fs = New Scripting.FileSystemObject
Set xlAplicacion = New Excel.Application
If fs.FileExists(App.path & "\SPOOLER\" & lsArchivo) Then
    Set xlLibro = xlAplicacion.Workbooks.Open(App.path & "\SPOOLER\" & lsArchivo)
Else
    Set xlLibro = xlAplicacion.Workbooks.Add
End If

lbExisteHoja = False

'------------------------
    Dim loAg As DAgencias
        Set loAg = New DAgencias
            Set Reg9 = loAg.RecuperaAgencias
            lnMaxAgencias = Reg9.RecordCount
        Set loAg = Nothing


For lnProducto = 1 To 6 '7 ' Para los productos

    For lnAgencia = 1 To lnMaxAgencias
        lsCadTotNumVig(lnAgencia) = ""
        lsCadTotCapVig(lnAgencia) = ""
        lsCadTotNumVen1(lnAgencia) = ""
        lsCadTotCapVen1(lnAgencia) = ""
        lsCadTotNumVen2(lnAgencia) = ""
        lsCadTotCapVen2(lnAgencia) = ""
    Next

    'IMPRIME EN UNA HOJA DE EXCEL
    'Crea la hoja de Excell para el producto
    Select Case lnProducto
      Case 1
         lsNomHoja = "COMERCIAL"
      Case 2
         lsNomHoja = "MICROEMPRESA"
      Case 3
         lsNomHoja = "CONSUMO"
      'Case 4
      '   lsNomHoja = "ADMINISTRATIVO"
      Case 4
         lsNomHoja = "PIGNORATICIO"
      Case 5 '6
         lsNomHoja = "MI VIVIENDA"
      Case 6 '7
         lsNomHoja = "RECUPERACIONES"
         
    End Select
    
    For Each xlHoja1 In xlLibro.Worksheets
        If xlHoja1.Name = lsNomHoja Then
            xlHoja1.Activate
            lbExisteHoja = True
            Exit For
        End If
    Next
    
    If lbExisteHoja = False Then
        Set xlHoja1 = xlLibro.Worksheets.Add
        xlHoja1.Name = lsNomHoja
    End If
    
    xlHoja1.PageSetup.CenterHorizontally = True
    xlHoja1.PageSetup.Zoom = 65
    xlHoja1.PageSetup.Orientation = xlLandscape
    xlAplicacion.Range("A1:Z100").Font.Size = 9
    
    lnFila = 1
    xlHoja1.Cells(lnFila, 1) = gsNomCmac
    xlHoja1.Cells(lnFila, 14) = "T.C.F. = "
    xlHoja1.Cells(lnFila, 15) = Format(pTipoCambio, "#0.000")
    xlHoja1.Cells(lnFila + 1, 1) = "SALDOS DE CAPITAL DE LA CARTERA DE CREDITOS POR RANGOS"
    xlHoja1.Cells(lnFila + 2, 1) = " CREDITO " & lsNomHoja & " AL " & Format(dFecData, "dd/mm/yyyy")
    xlHoja1.Range(xlHoja1.Cells(lnFila + 1, 1), xlHoja1.Cells(lnFila + 1, 15)).Merge True
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 1), xlHoja1.Cells(lnFila + 2, 15)).Merge True
    xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + 3, 15)).Font.Bold = True
    xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + 3, 15)).HorizontalAlignment = xlCenter
    
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 2), xlHoja1.Cells(lnFila + 90, 2)).NumberFormat = "#"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 3), xlHoja1.Cells(lnFila + 90, 3)).NumberFormat = "#,#0.00"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 4), xlHoja1.Cells(lnFila + 90, 4)).NumberFormat = "#"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 5), xlHoja1.Cells(lnFila + 90, 5)).NumberFormat = "#,#0.00"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 6), xlHoja1.Cells(lnFila + 90, 6)).NumberFormat = "#"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 7), xlHoja1.Cells(lnFila + 90, 7)).NumberFormat = "#,#0.00"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 8), xlHoja1.Cells(lnFila + 90, 8)).NumberFormat = "#"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 9), xlHoja1.Cells(lnFila + 90, 9)).NumberFormat = "#,#0.00"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 10), xlHoja1.Cells(lnFila + 90, 10)).NumberFormat = "#"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 11), xlHoja1.Cells(lnFila + 90, 11)).NumberFormat = "#,#0.00"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 12), xlHoja1.Cells(lnFila + 90, 12)).NumberFormat = "#"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 13), xlHoja1.Cells(lnFila + 90, 13)).NumberFormat = "#,#0.00"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 14), xlHoja1.Cells(lnFila + 90, 14)).NumberFormat = "#"
    xlHoja1.Range(xlHoja1.Cells(lnFila + 2, 15), xlHoja1.Cells(lnFila + 90, 15)).NumberFormat = "#,#0.00"
    lnFila = lnFila + 2
    
    xlHoja1.Range("A4").ColumnWidth = 13
    xlHoja1.Range("B4").ColumnWidth = 10
    xlHoja1.Range("C4").ColumnWidth = 14
    xlHoja1.Range("D4").ColumnWidth = 10
    xlHoja1.Range("E4").ColumnWidth = 14
    xlHoja1.Range("F4").ColumnWidth = 10
    xlHoja1.Range("G4").ColumnWidth = 14
    xlHoja1.Range("H4").ColumnWidth = 10
    xlHoja1.Range("I4").ColumnWidth = 15
    xlHoja1.Range("J4").ColumnWidth = 10
    xlHoja1.Range("K4").ColumnWidth = 14
    xlHoja1.Range("L4").ColumnWidth = 10
    xlHoja1.Range("M4").ColumnWidth = 14
    xlHoja1.Range("N4").ColumnWidth = 10
    xlHoja1.Range("O4").ColumnWidth = 15
        
    '***

    For lnMoneda = 1 To 2
        lnFila = lnFila + 1
        'Cabecera de Cada Moneda
        xlHoja1.Cells(lnFila + 1, 2) = IIf(lnMoneda = 1, "Moneda Nacional", "Moneda Extranjera")
        
        xlHoja1.Cells(lnFila + 3, 1) = "Agencia"
        If lnProducto < 6 Then '7 Then
            xlHoja1.Cells(lnFila + 3, 2) = "Normales"
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 2), xlHoja1.Cells(lnFila + 3, 7)).Merge True
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 2), xlHoja1.Cells(lnFila + 4, 7)).Interior.Color = &HC0C0FF
            If lnProducto = 1 Then
                xlHoja1.Cells(lnFila + 4, 2) = "Nro":     xlHoja1.Cells(lnFila + 4, 3) = "-999 a 15"
            Else
                xlHoja1.Cells(lnFila + 4, 2) = "Nro":     xlHoja1.Cells(lnFila + 4, 3) = "-999 a 30"
            End If
            If lnProducto = 1 Then
                xlHoja1.Cells(lnFila + 4, 4) = "Nro":     xlHoja1.Cells(lnFila + 4, 5) = "16 a 999"
            ElseIf lnProducto = 2 Then 'Or lnProducto = 4 Then
                xlHoja1.Cells(lnFila + 4, 4) = "Nro":     xlHoja1.Cells(lnFila + 4, 5) = "31 a 999"
            Else
                xlHoja1.Cells(lnFila + 4, 4) = "Nro":     xlHoja1.Cells(lnFila + 4, 5) = "31 a 90"
            End If
            If lnProducto = 1 Or lnProducto = 2 Then 'Or lnProducto = 4 Then
                xlHoja1.Cells(lnFila + 4, 6) = "Nro":     xlHoja1.Cells(lnFila + 4, 7) = "999 a mas"
            Else
                xlHoja1.Cells(lnFila + 4, 6) = "Nro":     xlHoja1.Cells(lnFila + 4, 7) = "91 a 9999"
            End If
            xlHoja1.Cells(lnFila + 3, 8) = "Refinanciados"
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 8), xlHoja1.Cells(lnFila + 3, 13)).Merge True
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 8), xlHoja1.Cells(lnFila + 4, 13)).Interior.Color = &HCFCF0F
            If lnProducto = 1 Then
                xlHoja1.Cells(lnFila + 4, 8) = "Nro":     xlHoja1.Cells(lnFila + 4, 9) = "-999 a 15"
            Else
                xlHoja1.Cells(lnFila + 4, 8) = "Nro":     xlHoja1.Cells(lnFila + 4, 9) = "-999 a 30"
            End If
            If lnProducto = 1 Then
                xlHoja1.Cells(lnFila + 4, 10) = "Nro":    xlHoja1.Cells(lnFila + 4, 11) = "16 a 999"
            ElseIf lnProducto = 2 Then 'Or lnProducto = 4 Then
                xlHoja1.Cells(lnFila + 4, 10) = "Nro":     xlHoja1.Cells(lnFila + 4, 11) = "31 a 999"
            Else
                xlHoja1.Cells(lnFila + 4, 10) = "Nro":     xlHoja1.Cells(lnFila + 4, 11) = "31 a 90"
            End If
            If lnProducto = 1 Or lnProducto = 2 Then 'Or lnProducto = 4 Then
                xlHoja1.Cells(lnFila + 4, 12) = "Nro":    xlHoja1.Cells(lnFila + 4, 13) = "999 a mas"
            Else
                xlHoja1.Cells(lnFila + 4, 12) = "Nro":    xlHoja1.Cells(lnFila + 4, 13) = "91 a 999"
            End If
            xlHoja1.Cells(lnFila + 3, 14) = "TOTAL"
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 14), xlHoja1.Cells(lnFila + 3, 15)).Merge True
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 14), xlHoja1.Cells(lnFila + 4, 15)).Interior.Color = &HEEFCC0
            xlHoja1.Cells(lnFila + 4, 14) = "Nro":     xlHoja1.Cells(lnFila + 4, 15) = "Monto"
        Else ' Recuperaciones
            xlHoja1.Cells(lnFila + 3, 2) = "Comerciales"
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 2), xlHoja1.Cells(lnFila + 3, 3)).Merge True
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 2), xlHoja1.Cells(lnFila + 4, 3)).Interior.Color = &HC0C0FF
            xlHoja1.Cells(lnFila + 4, 2) = "Nro":     xlHoja1.Cells(lnFila + 4, 3) = "Monto"
            xlHoja1.Cells(lnFila + 3, 4) = "MicroEmpresarial"
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 4), xlHoja1.Cells(lnFila + 3, 5)).Merge True
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 4), xlHoja1.Cells(lnFila + 4, 5)).Interior.Color = &HC0FC0F
            xlHoja1.Cells(lnFila + 4, 4) = "Nro":     xlHoja1.Cells(lnFila + 4, 5) = "Monto"
            'xlHoja1.Cells(lnFila + 3, 6) = "Agricola"
            'xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 6), xlHoja1.Cells(lnFila + 3, 7)).Merge True
            'xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 6), xlHoja1.Cells(lnFila + 4, 7)).Interior.Color = &HCFC0F
            'xlHoja1.Cells(lnFila + 4, 6) = "Nro":     xlHoja1.Cells(lnFila + 4, 7) = "Monto"
            xlHoja1.Cells(lnFila + 3, 6) = "Consumo"
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 6), xlHoja1.Cells(lnFila + 3, 7)).Merge True
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 6), xlHoja1.Cells(lnFila + 4, 7)).Interior.Color = &HF0FC0F
            xlHoja1.Cells(lnFila + 4, 6) = "Nro":     xlHoja1.Cells(lnFila + 4, 7) = "Monto"
            'xlHoja1.Cells(lnFila + 3, 10) = "Hipotecaja"
            'xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 10), xlHoja1.Cells(lnFila + 3, 11)).Merge True
            'xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 10), xlHoja1.Cells(lnFila + 4, 11)).Interior.Color = &HFCCC0F
            'xlHoja1.Cells(lnFila + 4, 10) = "Nro":     xlHoja1.Cells(lnFila + 4, 11) = "Monto"
            xlHoja1.Cells(lnFila + 3, 8) = "Mivivienda"
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 8), xlHoja1.Cells(lnFila + 3, 9)).Merge True
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 8), xlHoja1.Cells(lnFila + 4, 9)).Interior.Color = &HCFCF0F
            xlHoja1.Cells(lnFila + 4, 8) = "Nro":     xlHoja1.Cells(lnFila + 4, 9) = "Monto"
            xlHoja1.Cells(lnFila + 3, 10) = "TOTAL"
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 10), xlHoja1.Cells(lnFila + 3, 11)).Merge True
            xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 10), xlHoja1.Cells(lnFila + 4, 11)).Interior.Color = &HEEFCC0
            xlHoja1.Cells(lnFila + 4, 10) = "Nro":     xlHoja1.Cells(lnFila + 4, 11) = "Monto"
        End If
        xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + 4, 11)).HorizontalAlignment = xlCenter
        
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 1), xlHoja1.Cells(lnFila + 5, 11)).Cells.Borders.LineStyle = xlOutside
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 1), xlHoja1.Cells(lnFila + 5, 11)).Cells.Borders.LineStyle = xlInside
        
        lnFila = lnFila + 4
    
        For lnAgencia = 1 To lnMaxAgencias
        
            If lnProducto < 6 Then '7 Then
                For lnNormRef = 1 To 2  ' Normal / Refinanciado
                    lsRefinan = IIf(lnNormRef = 1, "N", "R")
                    'ARCV 30-06-2006
                    'Sql9 = " SELECT ISNULL(COUNT( Case When Substring(cCtaCod,6,1) = '1' and nDiasAtraso <=15 then cCtaCod " _
                     & "                    When Substring(cCtaCod,6,1) <> '1' and nDiasAtraso <=30 then cCtaCod End ) , 0) NroCredR1, " _
                     & " ISNULL(SUM( Case When Substring(cCtaCod,6,1) = '1' and nDiasAtraso <= 15 then nSaldoCap " _
                     & "                  When Substring(cCtaCod,6,1) <> '1' and nDiasAtraso <= 30  then nSaldoCap " _
                     & "                  When Substring(cCtaCod,6,1) in('3','4') and nDiasAtraso > 30 and nDiasAtraso <= 90 then nSaldoCap - nCapVencido  End ) ,0) SaldCredR1, " _
                     & " ISNULL(COUNT( Case When Substring(cCtaCod,6,1) = '1' and nDiasAtraso > 15 then cCtaCod " _
                     & "                    When Substring(cCtaCod,6,1) = '2' and nDiasAtraso > 30 then cCtaCod " _
                     & "                    When Substring(cCtaCod,6,1) in('3','4') and nDiasAtraso > 30 and nDiasAtraso <= 90 then cCtaCod End ) , 0)  NroCredR2, " _
                     & " ISNULL(SUM( Case When Substring(cCtaCod,6,1) = '1' and nDiasAtraso > 15 then nSaldoCap " _
                     & "                  When Substring(cCtaCod,6,1) = '2' and nDiasAtraso > 30 then nSaldoCap " _
                     & "                  When Substring(cCtaCod,6,1) in('3','4') and nDiasAtraso > 30 and nDiasAtraso <= 90 then nCapVencido End ) ,0)  SaldCredR2, " _
                     & " ISNULL(COUNT( Case When Substring(cCtaCod,6,1) in('3','4') and nDiasAtraso > 90 then cCtaCod End ), 0)  NroCredR3, " _
                     & " ISNULL(SUM(   Case When Substring(cCtaCod,6,1) in('3','4') and nDiasAtraso > 90 then nSaldoCap End ) ,0)  SaldCredR3 " _
                     & " FROM " & psServConsol & "CreditoConsol Where ( nPrdEstado IN( " & lsCreditosVigentes & "," & lsPignoraticio & " ) )  " _
                     & " AND Substring(cCtaCod,6,3) in ( " & prod(lnProducto) & " ) " _
                     & " AND Substring(cCtaCod,9,1) = '" & lnMoneda & "' " _
                     & " AND Substring(cCtaCod,4,2) = '" & FillNum(Val(lnAgencia), 2, "0") & "' " _
                     & " AND cRefinan ='" & lsRefinan & "' "
                    Sql9 = " SELECT ISNULL(COUNT( Case When Substring(cCtaCod,6,1) = '1' and nDiasAtraso <=15 then cCtaCod " _
                     & "                    When Substring(cCtaCod,6,1) <> '1' and nDiasAtraso <=30 then cCtaCod End ) , 0) NroCredR1, " _
                     & " ISNULL(SUM( Case When Substring(cCtaCod,6,1) = '1' and nDiasAtraso <= 15 then nCapVencido " _
                     & "                  When Substring(cCtaCod,6,1) <> '1' and nDiasAtraso <= 30  then nCapVencido " _
                     & "                  When Substring(cCtaCod,6,1) in('3','4') and nDiasAtraso > 30 and nDiasAtraso <= 90 then nCapVencido  End ) ,0) SaldCredR1, " _
                     & " ISNULL(COUNT( Case When Substring(cCtaCod,6,1) = '1' and nDiasAtraso > 15 then cCtaCod " _
                     & "                    When Substring(cCtaCod,6,1) = '2' and nDiasAtraso > 30 then cCtaCod " _
                     & "                    When Substring(cCtaCod,6,1) in('3','4') and nDiasAtraso > 30 and nDiasAtraso <= 90 then cCtaCod End ) , 0)  NroCredR2, " _
                     & " ISNULL(SUM( Case When Substring(cCtaCod,6,1) = '1' and nDiasAtraso > 15 then nSaldoCap " _
                     & "                  When Substring(cCtaCod,6,1) = '2' and nDiasAtraso > 30 then nSaldoCap " _
                     & "                  When Substring(cCtaCod,6,1) in('3','4') and nDiasAtraso > 30 and nDiasAtraso <= 90 then nCapVencido End ) ,0)  SaldCredR2, " _
                     & " ISNULL(COUNT( Case When Substring(cCtaCod,6,1) in('3','4') and nDiasAtraso > 90 then cCtaCod End ), 0)  NroCredR3, " _
                     & " ISNULL(SUM(   Case When Substring(cCtaCod,6,1) in('3','4') and nDiasAtraso > 90 then nSaldoCap End ) ,0)  SaldCredR3 " _
                     & " FROM " & psServConsol & "CreditoConsol Where ( nPrdEstado IN( " & lsCreditosVigentes & "," & lsPignoraticio & " ) )  " _
                     & " AND Substring(cCtaCod,6,3) in ( " & prod(lnProducto) & " ) " _
                     & " AND Substring(cCtaCod,9,1) = '" & lnMoneda & "' " _
                     & " AND Substring(cCtaCod,4,2) = '" & FillNum(Val(lnAgencia), 2, "0") & "' " _
                     & " AND cRefinan ='" & lsRefinan & "' "
                    
                    Set Reg9 = GetQuery(Sql9)
                    lnTNumVigS(lnNormRef, lnAgencia) = Reg9!NroCredR1
                    lnTCapVigS(lnNormRef, lnAgencia) = Reg9!SaldCredR1
                    lnTNumVen1S(lnNormRef, lnAgencia) = Reg9!NroCredR2
                    lnTCapVen1S(lnNormRef, lnAgencia) = Reg9!SaldCredR2
                    lnTNumVen2S(lnNormRef, lnAgencia) = Reg9!NroCredR3
                    lnTCapVen2S(lnNormRef, lnAgencia) = Reg9!SaldCredR3
                   
                    Reg9.Close
                   
                Next lnNormRef
            Else  ' Recuperaciones
              
                'ARCV 30-06-2006
                'Sql9 = " SELECT ISNULL(COUNT( Case When Substring(cCtaCod,6,1) = '1' then cCtaCod End ) , 0) NroCredR1,  " _
                 & " ISNULL(SUM( Case When Substring(cCtaCod,6,1) = '1' then nSaldoCap End ) ,0) SaldCredR1, " _
                 & " ISNULL(COUNT( Case When Substring(cCtaCod,6,1) = '2' then cCtaCod End ) , 0) NroCredR2, " _
                 & " ISNULL(SUM( Case When Substring(cCtaCod,6,1) = '2' then nSaldoCap End ) ,0) SaldCredR2, " _
                 & " ISNULL(COUNT( Case When Substring(cCtaCod,6,3) in('301','302','303','304') then cCtaCod End ) , 0) NroCredR3,  " _
                 & " ISNULL(SUM( Case When Substring(cCtaCod,6,3) in('301','302','303','304') then nSaldoCap End ) ,0) SaldCredR3,  " _
                 & " ISNULL(COUNT( Case When Substring(cCtaCod,6,3) = '320' then cCtaCod End ) , 0) NroCredR4, " _
                 & " ISNULL(SUM( Case When Substring(cCtaCod,6,3) = '320' then nSaldoCap End ) ,0) SaldCredR4,  " _
                 & " ISNULL(COUNT( Case When Substring(cCtaCod,6,3) = '401' then cCtaCod End ) , 0) NroCredR5, " _
                 & " ISNULL(SUM( Case When Substring(cCtaCod,6,3) = '401' then nSaldoCap End ) ,0) SaldCredR5,  " _
                 & " ISNULL(COUNT( Case When Substring(cCtaCod,6,3) = '423' then cCtaCod End ) , 0) NroCredR6, " _
                 & " ISNULL(SUM( Case When Substring(cCtaCod,6,3) = '423' then nSaldoCap End ) ,0) SaldCredR6  " _
                 & " FROM " & psServConsol & "CreditoConsol Where ( nPrdEstado IN (" & lsCreditosJudicial & ")  )  " _
                 & " AND Substring(cCtaCod,9,1) = '" & lnMoneda & "' " _
                 & " AND Substring(cCtaCod,4,2) = '" & FillNum(Val(lnAgencia), 2, "0") & "' " _
                 & " AND nSaldoCap > 0 "
                Sql9 = " SELECT ISNULL(COUNT( Case When Substring(cCtaCod,6,1) = '1' then cCtaCod End ) , 0) NroCredR1,  " _
                 & " ISNULL(SUM( Case When Substring(cCtaCod,6,1) = '1' then nSaldoCap End ) ,0) SaldCredR1, " _
                 & " ISNULL(COUNT( Case When Substring(cCtaCod,6,1) = '2' then cCtaCod End ) , 0) NroCredR2, " _
                 & " ISNULL(SUM( Case When Substring(cCtaCod,6,1) = '2' then nSaldoCap End ) ,0) SaldCredR2, " _
                 & " ISNULL(COUNT( Case When Substring(cCtaCod,6,3) in (" & RecuperaCadenaTipoProducto("3") & ") then cCtaCod End ) , 0) NroCredR3,  " _
                 & " ISNULL(SUM( Case When Substring(cCtaCod,6,3) in (" & RecuperaCadenaTipoProducto("3") & ") then nSaldoCap End ) ,0) SaldCredR3,  " _
                 & " ISNULL(COUNT( Case When Substring(cCtaCod,6,3) in(" & RecuperaCadenaTipoProducto("4") & ") then cCtaCod End ) , 0) NroCredR4, " _
                 & " ISNULL(SUM( Case When Substring(cCtaCod,6,3) in(" & RecuperaCadenaTipoProducto("4") & ") then nSaldoCap End ) ,0) SaldCredR4  " _
                 & " FROM " & psServConsol & "CreditoConsol Where ( nPrdEstado IN (" & lsCreditosJudicial & ")  )  " _
                 & " AND Substring(cCtaCod,9,1) = '" & lnMoneda & "' " _
                 & " AND Substring(cCtaCod,4,2) = '" & FillNum(Val(lnAgencia), 2, "0") & "' " _
                 & " AND nSaldoCap > 0 "
                 
                 
                Set Reg9 = GetQuery(Sql9)
                lnTNumVigS(1, lnAgencia) = Reg9!NroCredR1
                lnTCapVigS(1, lnAgencia) = Reg9!SaldCredR1
                lnTNumVen1S(1, lnAgencia) = Reg9!NroCredR2
                lnTCapVen1S(1, lnAgencia) = Reg9!SaldCredR2
                lnTNumVen2S(1, lnAgencia) = Reg9!NroCredR3
                lnTCapVen2S(1, lnAgencia) = Reg9!SaldCredR3
                lnTNumVigS(2, lnAgencia) = Reg9!NroCredR4
                lnTCapVigS(2, lnAgencia) = Reg9!SaldCredR4
                'lnTNumVen1S(2, lnAgencia) = Reg9!NroCredR5
                'lnTCapVen1S(2, lnAgencia) = Reg9!SaldCredR5
                'lnTNumVen2S(2, lnAgencia) = Reg9!NroCredR6
                'lnTCapVen2S(2, lnAgencia) = Reg9!SaldCredR6
                
                Reg9.Close
              
            End If
            
            ' Imprim la Matriz generada
            xlHoja1.Cells(lnFila + lnAgencia, 1) = "Agencia " & Str(lnAgencia)
            xlHoja1.Cells(lnFila + lnAgencia, 2) = lnTNumVigS(1, lnAgencia)
            xlHoja1.Cells(lnFila + lnAgencia, 3) = lnTCapVigS(1, lnAgencia)
            xlHoja1.Cells(lnFila + lnAgencia, 4) = lnTNumVen1S(1, lnAgencia)
            xlHoja1.Cells(lnFila + lnAgencia, 5) = lnTCapVen1S(1, lnAgencia)
            xlHoja1.Cells(lnFila + lnAgencia, 6) = lnTNumVen2S(1, lnAgencia)
            xlHoja1.Cells(lnFila + lnAgencia, 7) = lnTCapVen2S(1, lnAgencia)
            xlHoja1.Cells(lnFila + lnAgencia, 8) = lnTNumVigS(2, lnAgencia)
            xlHoja1.Cells(lnFila + lnAgencia, 9) = lnTCapVigS(2, lnAgencia)
            xlHoja1.Cells(lnFila + lnAgencia, 10) = lnTNumVen1S(2, lnAgencia)
            xlHoja1.Cells(lnFila + lnAgencia, 11) = lnTCapVen1S(2, lnAgencia)
            
            If lnProducto < 6 Then  'ARCV
                xlHoja1.Cells(lnFila + lnAgencia, 12) = lnTNumVen2S(2, lnAgencia)
                xlHoja1.Cells(lnFila + lnAgencia, 13) = lnTCapVen2S(2, lnAgencia)
            End If
            'Total de fila (Agencia)

            If lnProducto < 6 Then  'ARCV
                xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 14), xlHoja1.Cells(lnFila + lnAgencia, 14)).Formula = "=SUM(B" & lnFila + lnAgencia & "+D" & lnFila + lnAgencia & "+F" & lnFila + lnAgencia & "+H" & lnFila + lnAgencia & "+J" & lnFila + lnAgencia & "+L" & lnFila + lnAgencia & " )"
                xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 15), xlHoja1.Cells(lnFila + lnAgencia, 15)).Formula = "=SUM(C" & lnFila + lnAgencia & "+E" & lnFila + lnAgencia & "+G" & lnFila + lnAgencia & "+I" & lnFila + lnAgencia & "+K" & lnFila + lnAgencia & "+M" & lnFila + lnAgencia & " )"
                xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 14), xlHoja1.Cells(lnFila + lnAgencia, 15)).Font.Bold = True
            Else
                xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 10), xlHoja1.Cells(lnFila + lnAgencia, 10)).Formula = "=SUM(B" & lnFila + lnAgencia & "+D" & lnFila + lnAgencia & "+F" & lnFila + lnAgencia & "+H" & lnFila + lnAgencia & " )"
                xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 11), xlHoja1.Cells(lnFila + lnAgencia, 11)).Formula = "=SUM(C" & lnFila + lnAgencia & "+E" & lnFila + lnAgencia & "+G" & lnFila + lnAgencia & "+I" & lnFila + lnAgencia & " )"
                xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 10), xlHoja1.Cells(lnFila + lnAgencia, 11)).Font.Bold = True
            End If
            'Concatena las celdas para el Consolidado
            If lnProducto < 6 Then  '7 Then
                lsCadTotNumVig(lnAgencia) = lsCadTotNumVig(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 2), xlHoja1.Cells(lnFila + lnAgencia, 2)).Address(False, False) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 8), xlHoja1.Cells(lnFila + lnAgencia, 8)).Address(False, False)
                lsCadTotCapVig(lnAgencia) = lsCadTotCapVig(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 3), xlHoja1.Cells(lnFila + lnAgencia, 3)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "") & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 9), xlHoja1.Cells(lnFila + lnAgencia, 9)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "")
                lsCadTotNumVen1(lnAgencia) = lsCadTotNumVen1(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 4), xlHoja1.Cells(lnFila + lnAgencia, 4)).Address(False, False) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 10), xlHoja1.Cells(lnFila + lnAgencia, 10)).Address(False, False)
                lsCadTotCapVen1(lnAgencia) = lsCadTotCapVen1(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 5), xlHoja1.Cells(lnFila + lnAgencia, 5)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "") & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 11), xlHoja1.Cells(lnFila + lnAgencia, 11)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "")
                lsCadTotNumVen2(lnAgencia) = lsCadTotNumVen2(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 6), xlHoja1.Cells(lnFila + lnAgencia, 6)).Address(False, False) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 12), xlHoja1.Cells(lnFila + lnAgencia, 12)).Address(False, False)
                lsCadTotCapVen2(lnAgencia) = lsCadTotCapVen2(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 7), xlHoja1.Cells(lnFila + lnAgencia, 7)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "") & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 13), xlHoja1.Cells(lnFila + lnAgencia, 13)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "")
            Else
                lsCadTotNumVig(lnAgencia) = lsCadTotNumVig(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 2), xlHoja1.Cells(lnFila + lnAgencia, 2)).Address(False, False)
                lsCadTotCapVig(lnAgencia) = lsCadTotCapVig(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 3), xlHoja1.Cells(lnFila + lnAgencia, 3)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "")
                lsCadTotNumVen1(lnAgencia) = lsCadTotNumVen1(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 4), xlHoja1.Cells(lnFila + lnAgencia, 4)).Address(False, False)
                lsCadTotCapVen1(lnAgencia) = lsCadTotCapVen1(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 5), xlHoja1.Cells(lnFila + lnAgencia, 5)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "")
                lsCadTotNumVen2(lnAgencia) = lsCadTotNumVen2(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 6), xlHoja1.Cells(lnFila + lnAgencia, 6)).Address(False, False)
                lsCadTotCapVen2(lnAgencia) = lsCadTotCapVen2(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 7), xlHoja1.Cells(lnFila + lnAgencia, 7)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "")
                lsCadTotNumVen3(lnAgencia) = lsCadTotNumVen3(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 8), xlHoja1.Cells(lnFila + lnAgencia, 8)).Address(False, False)
                lsCadTotCapVen3(lnAgencia) = lsCadTotCapVen3(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 9), xlHoja1.Cells(lnFila + lnAgencia, 9)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "")
                lsCadTotNumVen4(lnAgencia) = lsCadTotNumVen4(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 10), xlHoja1.Cells(lnFila + lnAgencia, 10)).Address(False, False)
                lsCadTotCapVen4(lnAgencia) = lsCadTotCapVen4(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 11), xlHoja1.Cells(lnFila + lnAgencia, 11)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "")
                '''lsCadTotNumVen5(lnAgencia) = lsCadTotNumVen5(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 12), xlHoja1.Cells(lnFila + lnAgencia, 12)).Address(False, False)
                '''lsCadTotCapVen5(lnAgencia) = lsCadTotCapVen5(lnAgencia) & "+" & xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 13), xlHoja1.Cells(lnFila + lnAgencia, 13)).Address(False, False) & IIf(lnMoneda = 2, "*O1", "")
            
            End If
        Next lnAgencia
        
        'Bordes
        xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + lnMaxAgencias + 1, 15)).Cells.Borders.LineStyle = xlOutside
        xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + lnMaxAgencias + 1, 15)).Cells.Borders.LineStyle = xlInside
        
        'Sumo el Total x Moneda
        xlHoja1.Cells(lnFila + lnAgencia, 1) = "TOTAL"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 2), xlHoja1.Cells(lnFila + lnAgencia, 2)).Formula = "=SUM(B" & lnFila + 1 & ":B" & lnFila + lnAgencia - 1 & " )"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 3), xlHoja1.Cells(lnFila + lnAgencia, 3)).Formula = "=SUM(C" & lnFila + 1 & ":C" & lnFila + lnAgencia - 1 & " )"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 4), xlHoja1.Cells(lnFila + lnAgencia, 4)).Formula = "=SUM(D" & lnFila + 1 & ":D" & lnFila + lnAgencia - 1 & " )"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 5), xlHoja1.Cells(lnFila + lnAgencia, 5)).Formula = "=SUM(E" & lnFila + 1 & ":E" & lnFila + lnAgencia - 1 & " )"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 6), xlHoja1.Cells(lnFila + lnAgencia, 6)).Formula = "=SUM(F" & lnFila + 1 & ":F" & lnFila + lnAgencia - 1 & " )"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 7), xlHoja1.Cells(lnFila + lnAgencia, 7)).Formula = "=SUM(G" & lnFila + 1 & ":G" & lnFila + lnAgencia - 1 & " )"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 8), xlHoja1.Cells(lnFila + lnAgencia, 8)).Formula = "=SUM(H" & lnFila + 1 & ":H" & lnFila + lnAgencia - 1 & " )"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 9), xlHoja1.Cells(lnFila + lnAgencia, 9)).Formula = "=SUM(I" & lnFila + 1 & ":I" & lnFila + lnAgencia - 1 & " )"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 10), xlHoja1.Cells(lnFila + lnAgencia, 10)).Formula = "=SUM(J" & lnFila + 1 & ":J" & lnFila + lnAgencia - 1 & " )"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 11), xlHoja1.Cells(lnFila + lnAgencia, 11)).Formula = "=SUM(K" & lnFila + 1 & ":K" & lnFila + lnAgencia - 1 & " )"
        If lnProducto < 6 Then 'ARCV
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 12), xlHoja1.Cells(lnFila + lnAgencia, 12)).Formula = "=SUM(L" & lnFila + 1 & ":L" & lnFila + lnAgencia - 1 & " )"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 13), xlHoja1.Cells(lnFila + lnAgencia, 13)).Formula = "=SUM(M" & lnFila + 1 & ":M" & lnFila + lnAgencia - 1 & " )"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 14), xlHoja1.Cells(lnFila + lnAgencia, 14)).Formula = "=SUM(N" & lnFila + 1 & ":N" & lnFila + lnAgencia - 1 & " )"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 15), xlHoja1.Cells(lnFila + lnAgencia, 15)).Formula = "=SUM(O" & lnFila + 1 & ":O" & lnFila + lnAgencia - 1 & " )"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 1), xlHoja1.Cells(lnFila + lnAgencia, 15)).Font.Bold = True
        End If
        lnFila = lnFila + lnMaxAgencias + 2
        
    Next lnMoneda
    
    lnFila = lnFila + 2
    ' Imprimo el Consolidado
    If lnProducto < 6 Then '9 Then
        xlHoja1.Cells(lnFila + 1, 2) = "RESUMEN CONSOLIDADO"
        xlHoja1.Cells(lnFila + 3, 1) = "Agencia"
        xlHoja1.Cells(lnFila + 3, 2) = "Vigentes"
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 2), xlHoja1.Cells(lnFila + 3, 3)).Merge True
        xlHoja1.Cells(lnFila + 4, 2) = "Nro":     xlHoja1.Cells(lnFila + 4, 3) = "Rango"
        xlHoja1.Cells(lnFila + 3, 4) = "Vencidos 1"
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 4), xlHoja1.Cells(lnFila + 3, 5)).Merge True
        xlHoja1.Cells(lnFila + 4, 4) = "Nro":     xlHoja1.Cells(lnFila + 4, 5) = "Rango"
        xlHoja1.Cells(lnFila + 3, 6) = "Vencidos 2"
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 6), xlHoja1.Cells(lnFila + 3, 7)).Merge True
        xlHoja1.Cells(lnFila + 4, 6) = "Nro":     xlHoja1.Cells(lnFila + 4, 7) = "Rango"
        xlHoja1.Cells(lnFila + 3, 8) = "Total "
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 8), xlHoja1.Cells(lnFila + 3, 9)).Merge True
        xlHoja1.Cells(lnFila + 4, 8) = "Nro":     xlHoja1.Cells(lnFila + 4, 9) = "Rango"
        
        xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + 4, 9)).HorizontalAlignment = xlCenter
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 1), xlHoja1.Cells(lnFila + 4, 9)).Font.Bold = True
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 1), xlHoja1.Cells(lnFila + 4, 9)).Interior.Color = &HCFF0FF
            
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 1), xlHoja1.Cells(lnFila + 5, 9)).Cells.Borders.LineStyle = xlOutside
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 1), xlHoja1.Cells(lnFila + 5, 9)).Cells.Borders.LineStyle = xlInside
    Else 'Recuperaciones
        xlHoja1.Cells(lnFila + 1, 2) = "RESUMEN CONSOLIDADO"
        xlHoja1.Cells(lnFila + 3, 1) = "Agencia"
        xlHoja1.Cells(lnFila + 3, 2) = "Comerciales"
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 2), xlHoja1.Cells(lnFila + 3, 3)).Merge True
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 2), xlHoja1.Cells(lnFila + 4, 3)).Interior.Color = &HC0C0FF
        xlHoja1.Cells(lnFila + 4, 2) = "Nro":     xlHoja1.Cells(lnFila + 4, 3) = "Monto"
        xlHoja1.Cells(lnFila + 3, 4) = "MicroEmpresarial"
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 4), xlHoja1.Cells(lnFila + 3, 5)).Merge True
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 4), xlHoja1.Cells(lnFila + 4, 5)).Interior.Color = &HC0FC0F
        xlHoja1.Cells(lnFila + 4, 4) = "Nro":     xlHoja1.Cells(lnFila + 4, 5) = "Monto"
        'xlHoja1.Cells(lnFila + 3, 6) = "Agricola"
        'xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 6), xlHoja1.Cells(lnFila + 3, 7)).Merge True
        'xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 6), xlHoja1.Cells(lnFila + 4, 7)).Interior.Color = &HCFC0F
        'xlHoja1.Cells(lnFila + 4, 6) = "Nro":     xlHoja1.Cells(lnFila + 4, 7) = "Monto"
        xlHoja1.Cells(lnFila + 3, 6) = "Consumo"
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 6), xlHoja1.Cells(lnFila + 3, 7)).Merge True
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 6), xlHoja1.Cells(lnFila + 4, 7)).Interior.Color = &HF0FC0F
        xlHoja1.Cells(lnFila + 4, 6) = "Nro":     xlHoja1.Cells(lnFila + 4, 7) = "Monto"
        'xlHoja1.Cells(lnFila + 3, 10) = "Hipotecaja"
        'xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 10), xlHoja1.Cells(lnFila + 3, 11)).Merge True
        'xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 10), xlHoja1.Cells(lnFila + 4, 11)).Interior.Color = &HFCCC0F
        'xlHoja1.Cells(lnFila + 4, 10) = "Nro":     xlHoja1.Cells(lnFila + 4, 11) = "Monto"
        xlHoja1.Cells(lnFila + 3, 8) = "Mivivienda"
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 8), xlHoja1.Cells(lnFila + 3, 9)).Merge True
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 8), xlHoja1.Cells(lnFila + 4, 9)).Interior.Color = &HCFCF0F
        xlHoja1.Cells(lnFila + 4, 8) = "Nro":     xlHoja1.Cells(lnFila + 4, 9) = "Monto"
        xlHoja1.Cells(lnFila + 3, 10) = "TOTAL"
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 10), xlHoja1.Cells(lnFila + 3, 11)).Merge True
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 10), xlHoja1.Cells(lnFila + 4, 11)).Interior.Color = &HEEFCC0
        xlHoja1.Cells(lnFila + 4, 10) = "Nro":     xlHoja1.Cells(lnFila + 4, 11) = "Monto"
        
        xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + 4, 11)).HorizontalAlignment = xlCenter
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 1), xlHoja1.Cells(lnFila + 4, 11)).Font.Bold = True
            
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 1), xlHoja1.Cells(lnFila + 5, 11)).Cells.Borders.LineStyle = xlOutside
        xlHoja1.Range(xlHoja1.Cells(lnFila + 3, 1), xlHoja1.Cells(lnFila + 5, 11)).Cells.Borders.LineStyle = xlInside
    End If
    lnFila = lnFila + 4
    
    For lnAgencia = 1 To lnMaxAgencias
        If lnProducto < 6 Then '7 Then
            xlHoja1.Cells(lnFila + lnAgencia, 1) = "Agencia " & Str(lnAgencia)
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 2), xlHoja1.Cells(lnFila + lnAgencia, 2)).Formula = "=SUM(" & lsCadTotNumVig(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 3), xlHoja1.Cells(lnFila + lnAgencia, 3)).Formula = "=SUM(" & lsCadTotCapVig(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 4), xlHoja1.Cells(lnFila + lnAgencia, 4)).Formula = "=SUM(" & lsCadTotNumVen1(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 5), xlHoja1.Cells(lnFila + lnAgencia, 5)).Formula = "=SUM(" & lsCadTotCapVen1(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 6), xlHoja1.Cells(lnFila + lnAgencia, 6)).Formula = "=SUM(" & lsCadTotNumVen2(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 7), xlHoja1.Cells(lnFila + lnAgencia, 7)).Formula = "=SUM(" & lsCadTotCapVen2(lnAgencia) & ")"
            'Total Fila (Agencia)
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 8), xlHoja1.Cells(lnFila + lnAgencia, 8)).Formula = "=SUM(B" & lnFila + lnAgencia & "+D" & lnFila + lnAgencia & "+F" & lnFila + lnAgencia & " )"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 9), xlHoja1.Cells(lnFila + lnAgencia, 9)).Formula = "=SUM(C" & lnFila + lnAgencia & "+E" & lnFila + lnAgencia & "+G" & lnFila + lnAgencia & " )"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 8), xlHoja1.Cells(lnFila + lnAgencia, 9)).Font.Bold = True
            'Bordes
            xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + lnAgencia, 9)).Cells.Borders.LineStyle = xlOutside
            xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + lnAgencia, 9)).Cells.Borders.LineStyle = xlInside

        Else  'Recuperaciones
            xlHoja1.Cells(lnFila + lnAgencia, 1) = "Agencia " & Str(lnAgencia)
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 2), xlHoja1.Cells(lnFila + lnAgencia, 2)).Formula = "=SUM(" & lsCadTotNumVig(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 3), xlHoja1.Cells(lnFila + lnAgencia, 3)).Formula = "=SUM(" & lsCadTotCapVig(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 4), xlHoja1.Cells(lnFila + lnAgencia, 4)).Formula = "=SUM(" & lsCadTotNumVen1(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 5), xlHoja1.Cells(lnFila + lnAgencia, 5)).Formula = "=SUM(" & lsCadTotCapVen1(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 6), xlHoja1.Cells(lnFila + lnAgencia, 6)).Formula = "=SUM(" & lsCadTotNumVen2(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 7), xlHoja1.Cells(lnFila + lnAgencia, 7)).Formula = "=SUM(" & lsCadTotCapVen2(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 8), xlHoja1.Cells(lnFila + lnAgencia, 8)).Formula = "=SUM(" & lsCadTotNumVen3(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 9), xlHoja1.Cells(lnFila + lnAgencia, 9)).Formula = "=SUM(" & lsCadTotCapVen3(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 10), xlHoja1.Cells(lnFila + lnAgencia, 10)).Formula = "=SUM(" & lsCadTotNumVen4(lnAgencia) & ")"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 11), xlHoja1.Cells(lnFila + lnAgencia, 11)).Formula = "=SUM(" & lsCadTotCapVen4(lnAgencia) & ")"
            '''xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 12), xlHoja1.Cells(lnFila + lnAgencia, 12)).Formula = "=SUM(" & lsCadTotNumVen5(lnAgencia) & ")"
            '''xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 13), xlHoja1.Cells(lnFila + lnAgencia, 13)).Formula = "=SUM(" & lsCadTotCapVen5(lnAgencia) & ")"
            
            'Total Fila (Agencia)
            '''xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 14), xlHoja1.Cells(lnFila + lnAgencia, 14)).Formula = "=SUM(B" & lnFila + lnAgencia & "+D" & lnFila + lnAgencia & "+F" & lnFila + lnAgencia & "+H" & lnFila + lnAgencia & "+J" & lnFila + lnAgencia & "+L" & lnFila + lnAgencia & " )"
            '''xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 15), xlHoja1.Cells(lnFila + lnAgencia, 15)).Formula = "=SUM(C" & lnFila + lnAgencia & "+E" & lnFila + lnAgencia & "+G" & lnFila + lnAgencia & "+I" & lnFila + lnAgencia & "+K" & lnFila + lnAgencia & "+M" & lnFila + lnAgencia & " )"
            '''xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 14), xlHoja1.Cells(lnFila + lnAgencia, 15)).Font.Bold = True
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 10), xlHoja1.Cells(lnFila + lnAgencia, 10)).Formula = "=SUM(B" & lnFila + lnAgencia & "+D" & lnFila + lnAgencia & "+F" & lnFila + lnAgencia & "+H" & lnFila + lnAgencia & " )"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 11), xlHoja1.Cells(lnFila + lnAgencia, 11)).Formula = "=SUM(C" & lnFila + lnAgencia & "+E" & lnFila + lnAgencia & "+G" & lnFila + lnAgencia & "+I" & lnFila + lnAgencia & " )"
            xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 10), xlHoja1.Cells(lnFila + lnAgencia, 11)).Font.Bold = True
            'Bordes
            xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + lnMaxAgencias + 1, 15)).Cells.Borders.LineStyle = xlOutside
            xlHoja1.Range(xlHoja1.Cells(lnFila, 1), xlHoja1.Cells(lnFila + lnMaxAgencias + 1, 15)).Cells.Borders.LineStyle = xlInside
        
        End If

    Next lnAgencia
    'Total
   
    'Sumo el Total x Consolidado
    xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 2), xlHoja1.Cells(lnFila + lnAgencia, 2)).Formula = "=SUM(B" & lnFila + 1 & ":B" & lnFila + lnAgencia - 1 & " )"
    xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 3), xlHoja1.Cells(lnFila + lnAgencia, 3)).Formula = "=SUM(C" & lnFila + 1 & ":C" & lnFila + lnAgencia - 1 & " )"
    xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 4), xlHoja1.Cells(lnFila + lnAgencia, 4)).Formula = "=SUM(D" & lnFila + 1 & ":D" & lnFila + lnAgencia - 1 & " )"
    xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 5), xlHoja1.Cells(lnFila + lnAgencia, 5)).Formula = "=SUM(E" & lnFila + 1 & ":E" & lnFila + lnAgencia - 1 & " )"
    xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 6), xlHoja1.Cells(lnFila + lnAgencia, 6)).Formula = "=SUM(F" & lnFila + 1 & ":F" & lnFila + lnAgencia - 1 & " )"
    xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 7), xlHoja1.Cells(lnFila + lnAgencia, 7)).Formula = "=SUM(G" & lnFila + 1 & ":G" & lnFila + lnAgencia - 1 & " )"
    xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 8), xlHoja1.Cells(lnFila + lnAgencia, 8)).Formula = "=SUM(H" & lnFila + 1 & ":H" & lnFila + lnAgencia - 1 & " )"
    xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 9), xlHoja1.Cells(lnFila + lnAgencia, 9)).Formula = "=SUM(I" & lnFila + 1 & ":I" & lnFila + lnAgencia - 1 & " )"
    If lnProducto < 6 Then '9 Then
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 1), xlHoja1.Cells(lnFila + lnAgencia, 9)).Font.Bold = True
    Else  'Recuperaciones
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 10), xlHoja1.Cells(lnFila + lnAgencia, 10)).Formula = "=SUM(J" & lnFila + 1 & ":J" & lnFila + lnAgencia - 1 & " )"
        xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 11), xlHoja1.Cells(lnFila + lnAgencia, 11)).Formula = "=SUM(K" & lnFila + 1 & ":K" & lnFila + lnAgencia - 1 & " )"
        '''xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 12), xlHoja1.Cells(lnFila + lnAgencia, 12)).Formula = "=SUM(L" & lnFila + 1 & ":L" & lnFila + lnAgencia - 1 & " )"
        '''xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 13), xlHoja1.Cells(lnFila + lnAgencia, 13)).Formula = "=SUM(M" & lnFila + 1 & ":M" & lnFila + lnAgencia - 1 & " )"
        '''xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 14), xlHoja1.Cells(lnFila + lnAgencia, 14)).Formula = "=SUM(N" & lnFila + 1 & ":N" & lnFila + lnAgencia - 1 & " )"
        '''xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 15), xlHoja1.Cells(lnFila + lnAgencia, 15)).Formula = "=SUM(O" & lnFila + 1 & ":O" & lnFila + lnAgencia - 1 & " )"
        '''xlHoja1.Range(xlHoja1.Cells(lnFila + lnAgencia, 1), xlHoja1.Cells(lnFila + lnAgencia, 15)).Font.Bold = True
    End If
    RaiseEvent Progress(CInt(lnProducto), 9)
Next lnProducto

'*******
xlHoja1.SaveAs App.path & "\SPOOLER\" & lsArchivo
'Cierra el libro de trabajo
xlLibro.Close
' Cierra Microsoft Excel con el método Quit.
xlAplicacion.Quit
RaiseEvent CloseProgress
'Libera los objetos.
Set xlAplicacion = Nothing
Set xlLibro = Nothing
Set xlHoja1 = Nothing
MsgBox "Se ha Generado el Archivo SaldoCartera_Rango.XLS Satisfactoriamente", vbInformation, "Aviso"
End Sub



Public Function nRepo108721_fgImpCredVigGarant(ByVal psServConsol As String, ByVal pnTipCambio As Double, ByVal psCadena As String, ByVal psDesCadena As String, _
        ByVal pnDiasAtrasoIni As Integer, ByVal pnDiasAtrasoFin As Integer, ByVal psAgencia As String, ByVal dFecSis As Date) As String
Dim Sql9 As String
Dim reg1 As New ADODB.Recordset
Dim Reg2 As New ADODB.Recordset
Dim Reg3 As New ADODB.Recordset
Dim Reg4 As New ADODB.Recordset
Dim Reg5 As New ADODB.Recordset
Dim Reg6 As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim Reg7 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String * 35
Dim lsDescP As String * 35
Dim lsDescF As String * 35
Dim liLineas As Integer
Dim liDatos  As Integer
Dim ContD As Integer
Dim Cliente As String * 40
Dim lsFecha As String * 12
Dim lnMora As Double
Dim lnDeuda As Double
Dim lnIntDeveng As Double
Dim liTCredM As Integer
Dim lnTMontoGar1M As Double
Dim lnTMontoGar2M As Double
Dim lnTDesembCapM As Double
Dim lnTSaldoCapM As Double
Dim lnTMoraM As Double
Dim lnTIntDevengM As Double
Dim lnTDeudaM As Double
Dim liTCredP As Integer
Dim lnTMontoGar1P As Double
Dim lnTMontoGar2P As Double
Dim lnTDesembCapP As Double
Dim lnTSaldoCapP As Double
Dim lnTMoraP As Double
Dim lnTIntDevengP As Double
Dim lnTDeudaP As Double
Dim liTCredPr As Integer
Dim lnTMontoGar1Pr As Double
Dim lnTMontoGar2Pr As Double
Dim lnTDesembCapPr As Double
Dim lnTSaldoCapPr As Double
Dim lnTMoraPr As Double
Dim lnTIntDevengPr As Double
Dim lnTDeudaPr As Double
Dim liTCredF As Integer
Dim lnTMontoGar1F As Double
Dim lnTMontoGar2F As Double
Dim lnTDesembCapF As Double
Dim lnTSaldoCapF As Double
Dim lnTMoraF As Double
Dim lnTIntDevengF As Double
Dim lnTDeudaF As Double
Dim lbSiCambio As Boolean
Dim lnMontoGar1 As Currency
Dim lnMontoGar2 As Currency
Dim lnIntComp As Double
Dim lnCapital As Double
Dim liCuotas  As Integer
Dim liDias As Integer

Dim Cadena1 As String
Dim vTipCambioFijo As Double
Dim liContS As Integer
Dim liContD As Integer
Dim lsCadenaS() As String
Dim lsCadenaD() As String
Dim lnTMontoAprMD As Double
Dim lnTSaldoCapMD As Double
Dim lnTIntDevMD As Double
Dim lnTDeudaMD As Double
Dim lnTGar1MD As Double
Dim lnTGar2MD As Double
Dim lnTMontoAprMS As Double
Dim lnTSaldoCapMS As Double
Dim lnTIntDevMS As Double
Dim lnTDeudaMS As Double
Dim lnTGar1MS As Double
Dim lnTGar2MS As Double
Dim liNumCredMS As Integer
Dim liNumCredMD As Integer

Dim lsSelLinea As String

Dim lbFinMes As Boolean
Dim lsFecFinMes As String

Dim lsRtfImp As String
Dim lsRtfImpAux As String
Dim cpag As Integer


'------------------
Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim i As Integer
Dim FechaCierre As Date
Dim lsRtfImpG As String
FechaCierre = GetFechaCierreMes
lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
PoneFecha (dFecSis)
'lsPignoraticio = " 2802,2803,2804,2807 "
lsPignoraticio = DevuelveCadenaEstadosPignoraticio

'--------------------------

liContS = 0
liContD = 0
ReDim lsCadenaS(liContS)
ReDim lsCadenaD(liContD)

lbSiCambio = False
lsRtfImp = ""
lsRtfImpAux = ""
ContD = 0
cpag = 1

lbFinMes = True

Sql9 = "Select dfecConsol from " & psServConsol & "VarConsolida "
Set Reg9 = GetQuery(Sql9)


lsFecFinMes = Format(Reg9!dfecConsol, "dd/mm/yyyy")
FechaCierre = Reg9!dfecConsol
Reg9.Close

vTipCambioFijo = CDbl(pnTipCambio)


       
'===== Verificar si existen datos para el reporte
'**** BRGO - BASILEA II
Sql9 = "Select Count(CS.cCtaCod) as NumCred from " & psServConsol & "CreditoSaldoConsol CS " _
    & " inner join " & psServConsol & "CreditoConsolTotal CCT ON CS.cCtaCod = CCT.cCtaCod " _
    & " WHERE datediff(d,CS.dFecha,'" & Format(FechaCierre, "yyyy/mm/dd") & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ") AND CCT.cAgeCodAct ='" & psAgencia & "' "
'***************************
Set Reg9 = GetQuery(Sql9)
If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
    nRepo108721_fgImpCredVigGarant = ""
    Exit Function
Else
    If Reg9!NumCred = 0 Then
        'liDatos = 0
        nRepo108721_fgImpCredVigGarant = ""
        Exit Function
    End If
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then
    RaiseEvent ShowProgress
   '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set reg1 = loConst.RecuperaConstantes(gMoneda)

    '======== Tipo de Plazo =========
        Set Reg2 = loConst.RecuperaConstantes(gColocLineaCredPlazo)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    Set Reg5 = ObtieneLineaCredito 'Fuente Financiamiento

   '========= Tipo de Créditos  =========
    Set Reg3 = GetTipoCred

    nRepo108721_fgImpCredVigGarant = ""
    If reg1.EOF And reg1.BOF Then
    Else
        Do While Not reg1.EOF
            '=====LIMPIAR LOS DATOS SUBTOTALES POR MONEDA ======
            liTCredM = 0
            lnTMontoGar1M = 0
            lnTMontoGar2M = 0
            lnTDesembCapM = 0
            lnTSaldoCapM = 0
            lnTMoraM = 0
            lnTIntDevengM = 0
            lnTDeudaM = 0
            lsDescM = Trim(reg1!cConsDescripcion)
            '================= CREDITOS VIGENTES - MONEDA =======================
            '******** BRGO - BASILEA II
            Sql9 = "Select count(CS.cCtaCod) as NumCred from " & psServConsol & "CreditoSaldoConsol CS " _
                & " INNER JOIN " & psServConsol & "CreditoConsol Credito ON CS.cCtaCod = Credito.cCtaCod " _
                & " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = Credito.cCtaCod " _
                & " Where datediff(d,CS.dFecha,'" & Format(lsFecFinMes, "mm/dd/yyyy") & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ") and " _
                & " CCT.cAgeCodAct ='" & psAgencia & "' AND " _
                & " Substring(CS.cCtaCod,9,1 )= '" & Trim(reg1!nConsValor) & "'" & psCadena
            '****************************
            
            Set Reg9 = GetQuery(Sql9)
            If Reg9.EOF And Reg9.BOF Then
                liDatos = 0
            Else
               
                liDatos = Reg9!NumCred
            End If
            Reg9.Close
            Set Reg9 = Nothing

            If liDatos > 0 Then
                lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                liLineas = 5
                If lbSiCambio Then
                    lbSiCambio = False
                End If
                lsRtfImp = lsRtfImp & "MONEDA         : " & lsDescM & Chr(10)
                liLineas = liLineas + 1
                If Reg3.EOF And Reg3.BOF Then 'Tipo de Crédito
                Else
                    Reg3.MoveFirst
                    Do While Not Reg3.EOF 'Tipo de Crédito
                        '=========== CREDITOS VIGENTES PARA UN TIPO DE CREDITO ==================
                        Sql9 = "Select count(CS.cCtaCod) as NumCred from " & psServConsol & "CreditoSaldoConsol CS " _
                            & " INNER JOIN " & psServConsol & "CreditoConsol Credito ON CS.cCtaCod = Credito.cCtaCod " _
                            & " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = Credito.cCtaCod " _
                            & " Where datediff(d,CS.dFecha,'" & Format(lsFecFinMes, "mm/dd/yyyy") & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ") and " _
                            & " CCT.cAgeCodAct ='" & psAgencia & "' AND " _
                            & " substring(Credito.cCtaCod,9,1 )= '" & Trim(reg1!nConsValor) & "' and substring(Cs.cLineaCred, 7,1) = '" _
                            & Mid(Trim(Reg3!nConsValor), 1, 1) & "'" & psCadena
                        Set Reg9 = GetQuery(Sql9)
                        If Reg9.EOF And Reg9.BOF Then
                            liDatos = 0
                        Else
                            liDatos = Reg9!NumCred
                        End If
                        Reg9.Close
                        Set Reg9 = Nothing

                        If liDatos > 0 Then
                            
                            '======= Sub Tipo de Crédito =========
                            Set Reg4 = GetSubTipoCred(Reg3!nConsValor)
                            'Set Reg4 = GetTablaCod(Reg3!cCodTab)
                            If Reg4.EOF And Reg4.BOF Then
                            Else
                                Do While Not Reg4.EOF
                                    lsDescPr = Trim(Reg3!cConsDescripcion) & " - " & Trim(Reg4!cConsDescripcion)
                                    '======= LIMPIAR DATOS PARA EL PRODUCTO =============
                                    liTCredPr = 0
                                    lnTMontoGar1Pr = 0
                                    lnTMontoGar2Pr = 0
                                    lnTDesembCapPr = 0
                                    lnTSaldoCapPr = 0
                                    lnTMoraPr = 0
                                    lnTIntDevengPr = 0
                                    lnTDeudaPr = 0

                                    '=========== CREDITOS VIGENTES - SUB TIPO CREDITO ==============
                                    Sql9 = "Select count(CS.cCtaCod) as NumCred from " & psServConsol & "CreditoSaldoConsol CS " _
                                        & " INNER JOIN " & psServConsol & "CreditoConsol Credito ON CS.cCtaCod = Credito.cCtaCod " _
                                        & " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = Credito.cCtaCod " _
                                        & " Where datediff(d,CS.dFecha,'" & Format(lsFecFinMes, "mm/dd/yyyy") & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ") And " _
                                        & " CCT.cAgeCodAct ='" & psAgencia & "' AND " _
                                        & " substring(Credito.cCtaCod,9,1 )= '" & Trim(reg1!nConsValor) & "' and substring(cs.cLineaCred, 7,1) = '" _
                                        & Mid(Trim(Reg3!nConsValor), 1, 1) & "' and substring( cs.cLineaCred,8,2) = '" & Mid(Trim(Reg4!nConsValor), 2, 2) & "'" & psCadena
                                    Set Reg9 = GetQuery(Sql9)
                                    If Reg9.EOF And Reg9.BOF Then
                                        liDatos = 0
                                    Else
                                        liDatos = Reg9!NumCred
                                    End If
                                    Reg9.Close
                                    Set Reg9 = Nothing

                                    If liDatos > 0 Then
                                        If liLineas >= 56 Then 'Para el control de salto de página
                                           lsRtfImp = lsRtfImp & Chr(12)
                                           cpag = cpag + 1
                                           lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                                           liLineas = 5
                                        End If
                                        If lbSiCambio Then
                                            lsRtfImp = lsRtfImp & Chr(12)
                                            liLineas = liLineas + 1
                                            lbSiCambio = False
                                        End If
                                        lsRtfImp = lsRtfImp & "PRODUCTO       : " & lsDescPr & Chr(10)
                                        liLineas = liLineas + 4
                                        If Trim(reg1!nConsValor) = "1" Then
                                           liContS = liContS + 1
                                           ReDim Preserve lsCadenaS(liContS)
                                           lsCadenaS(liContS) = Chr(10) & "*****" & lsDescPr & Chr(10) & Chr(10)
                                           liContS = liContS + 1
                                           ReDim Preserve lsCadenaS(liContS)
                                           lsCadenaS(liContS) = String(160, "-") & Chr(10)
                                           liContS = liContS + 1
                                           ReDim Preserve lsCadenaS(liContS)
                                           lsCadenaS(liContS) = Space(45) & "CASOS" & Space(7) & "M. APROBADO" & Space(7) & "S. CAPITAL" & Space(8) & "INT. DEVENG." & Space(7) & "DEUDA TOT." & Space(9) & "GAR. HIP." & Space(7) & "OTRAS GAR." & Chr(10)
                                           liContS = liContS + 1
                                           ReDim Preserve lsCadenaS(liContS)
                                           lsCadenaS(liContS) = String(160, "-") & Chr(10) & Chr(10)
                                        Else
                                           liContD = liContD + 1
                                           ReDim Preserve lsCadenaD(liContD)
                                           lsCadenaD(liContD) = Chr(10) & "*****" & lsDescPr & Chr(10) & Chr(10)
                                           liContD = liContD + 1
                                           ReDim Preserve lsCadenaD(liContD)
                                           lsCadenaD(liContD) = String(160, "-") & Chr(10)
                                           liContD = liContD + 1
                                           ReDim Preserve lsCadenaD(liContD)
                                           lsCadenaD(liContD) = Space(45) & "CASOS" & Space(7) & "M. APROBADO" & Space(7) & "S. CAPITAL" & Space(8) & "INT. DEVENG." & Space(7) & "DEUDA TOT." & Space(9) & "GAR. HIP." & Space(7) & "OTRAS GAR." & Chr(10)
                                           liContD = liContD + 1
                                           ReDim Preserve lsCadenaD(liContD)
                                           lsCadenaD(liContD) = String(160, "-") & Chr(10) & Chr(10)
                                        End If
                                        liLineas = liLineas + 1

                                        If Reg2.EOF And Reg2.BOF Then
                                        Else
                                            Reg2.MoveFirst
                                            Do While Not Reg2.EOF
                                                lsDescP = Trim(Reg2!cConsDescripcion)
                                                '============ LIMPIAR DATOS PARA EL PLAZO =============
                                                liTCredP = 0
                                                lnTMontoGar1P = 0
                                                lnTMontoGar2P = 0
                                                lnTDesembCapP = 0
                                                lnTSaldoCapP = 0
                                                lnTMoraP = 0
                                                lnTIntDevengP = 0
                                                lnTDeudaP = 0

                                                '================= CREDITOS VIGENTES  - PLAZO ==================

                                                Sql9 = "Select count(CS.cCtaCod) as NumCred from " & psServConsol & "CreditoSaldoConsol CS " _
                                                    & " INNER JOIN " & psServConsol & "CreditoConsol Credito ON CS.cCtaCod = Credito.cCtaCod " _
                                                    & " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = Credito.cCtaCod " _
                                                    & " Where datediff(d,CS.dFecha,'" & Format(lsFecFinMes, "mm/dd/yyyy") & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ") and " _
                                                    & " CCT.cAgeCodAct ='" & psAgencia & "' AND " _
                                                    & " substring(Credito.cCtaCod,9,1 )= '" & Trim(reg1!nConsValor) & "' and substring(cs.cLineaCred, 7,1) = '" _
                                                    & Mid(Trim(Reg3!nConsValor), 1, 1) & "' and substring(cs.cLineaCred,8,2) = '" & Mid(Trim(Reg4!nConsValor), 2, 2) _
                                                    & "' and substring( cs.cLineaCred,6,1) = '" & Trim(Reg2!nConsValor) & "'" & psCadena
                                                Set Reg9 = GetQuery(Sql9)
                                                If Reg9.EOF And Reg9.BOF Then
                                                    liDatos = 0
                                                Else
                                                    liDatos = Reg9!NumCred
                                                End If
                                                Reg9.Close
                                                Set Reg9 = Nothing

                                                If liDatos > 0 Then
                                                    If liLineas >= 58 Then 'Para el control de salto de página
                                                       lsRtfImp = lsRtfImp & Chr(12)
                                                       cpag = cpag + 1
                                                       lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                                                       liLineas = 5
                                                    End If
                                                    If lbSiCambio Then
                                                        lsRtfImp = lsRtfImp & Chr(10)
                                                        liLineas = liLineas + 1
                                                        lbSiCambio = False
                                                    End If
                                                    lsRtfImp = lsRtfImp & "PLAZO          : " & lsDescP & Chr(10)
                                                    liLineas = liLineas + 1

                                                    If Reg5.EOF And Reg5.BOF Then
                                                    Else
                                                        Reg5.MoveFirst
                                                        Do While Not Reg5.EOF
                                                            lsDescF = Trim(Reg5!CDescripcion)
                                                            '============ LIMPIAR DATOS PARA EL FUENTE DE FINANCIAMIENTO =============
                                                            liTCredF = 0
                                                            lnTMontoGar1F = 0
                                                            lnTMontoGar2F = 0
                                                            lnTDesembCapF = 0
                                                            lnTSaldoCapF = 0
                                                            lnTMoraF = 0
                                                            lnTIntDevengF = 0
                                                            lnTDeudaF = 0

                                                            ' ** Arma la psCadena de Linea de Credito (Cambio)
                                                            ' ** [3][44][1][2][5]
                                                            lsSelLinea = Trim(Reg5!cLineaCred) & Trim(reg1!nConsValor) & Trim(Reg2!nConsValor) & Mid(Trim(Reg3!nConsValor), 1, 1) & Mid(Trim(Reg4!nConsValor), 2, 2)

                                                            Sql9 = "SELECT Credito.cCtaCod, Credito.nTasaInt, Credito.cCodAnalista, Isnull(CS.nMoraCalc,0) as nIntMorCal,CS.nDiasAtraso as nDiasAtraso, Credito.dFecVig  dFecUltDesemb," _
                                                                & "CS.nSaldoCap, Credito.nIntApr, Credito.nCuotaApr, Credito.nCuotasApr, Credito.nPlazoApr, Credito.nMontoDesemb, Persona.cPersNombre, " _
                                                                & "Credito.dFecVig, Credito.nTipCuota, Credito.nTipoDesemb, IsNull(CS.nIntDev,0) as nIntDev, IsNull(CS.nGastoPend,0) as nGastoPend, " _
                                                                & "Credito.nHipoSoles, Credito.nHipoDol, Credito.nGarantSoles, Credito.nGarantDol " _
                                                                & "FROM " & psServConsol & "CreditoSaldoConsol CS " _
                                                                & "INNER JOIN " & psServConsol & "CreditoConsol Credito  ON CS.cCtaCod = Credito.cCtaCod And CS.nPrdEstado = Credito.nPrdEstado " _
                                                                & "INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = Credito.cCtaCod " _
                                                                & "INNER JOIN " & psServConsol & "ProductoPersonaConsol PersCredito ON Credito.cCtaCod = PersCredito.cCtaCod " _
                                                                & "INNER JOIN PERSONA PERSONA ON PERSCREDITO.cPersCod = PERSONA.cPersCod " _
                                                                & "WHERE datediff(d,CS.dFecha,'" & Format(lsFecFinMes, "mm/dd/yyyy") & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ") " _
                                                                & "And CCT.cAgeCodAct ='" & psAgencia & "' " _
                                                                & "AND PERSCREDITO.nPrdPersRelac = 20  AND Credito.cLineaCred like '" & lsSelLinea & "%'" _
                                                                & psCadena & " Order by CS.cCtaCod "
                                                        
                                                            Set Reg6 = GetQuery(Sql9)

                                                            If Reg6.EOF And Reg6.BOF Then
                                                            Else
                                                                If liLineas >= 58 Then 'Para el control de salto de página
                                                                   lsRtfImp = lsRtfImp & Chr(12)
                                                                   cpag = cpag + 1
                                                                   lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                                                                   liLineas = 5
                                                                End If
                                                                If lbSiCambio Then
                                                                    lsRtfImp = lsRtfImp & Chr(10)
                                                                    liLineas = liLineas + 1
                                                                    lbSiCambio = False
                                                                End If
                                                                lsRtfImp = lsRtfImp & "FINANCIAMIENTO : " & lsDescF & Chr(10)
                                                                liLineas = liLineas + 2
                                                                lsRtfImp = lsRtfImp & ImpCredVigGarantSubCab
                                                                liLineas = liLineas + 3
                                                                Do While Not Reg6.EOF
                                                                    Cliente = Trim(PstaNombre(Reg6!cPersNombre, False))
                                                                    
                                                                    lsFecha = Format(Reg6!dFecVig, "dd/mm/yyyy")
                                                                    If IsNull(Reg6!nIntMorCal) Then
                                                                        lnMora = 0
                                                                    Else
                                                                        lnMora = Reg6!nIntMorCal
                                                                    End If
                                                                    '=================== [ GARANTIA HIPOTECARIA SOLES ] ========================
                                                                    
                                                                    lnMontoGar1 = 0
                                                                    'lnMontoGar1 = GetGarantias(Reg6!cCtaCod, " IN ('01') ", "1")
                                                                    lnMontoGar1 = Reg6!nHipoSoles
                                                                    If Mid(Reg6!cCtaCod, 9, 1) = "2" Then
                                                                        lnMontoGar1 = lnMontoGar1 / vTipCambioFijo
                                                                    End If

                                                                    '================= GARANTIA HIPOTECARIA DOLARES ==========================
                                                                    'lnMontoGar1 = lnMontoGar1 + GetGarantias(Reg6!cCtaCod, " IN ('01') ", "2")
                                                                    If Mid(Reg6!cCtaCod, 9, 1) = "2" Then
                                                                        lnMontoGar1 = lnMontoGar1 + Reg6!nhipodol
                                                                    Else
                                                                        lnMontoGar1 = lnMontoGar1 + (Reg6!nhipodol * vTipCambioFijo)
                                                                    End If

                                                                    '===================== [OTRAS GARANTIAS SOLES] =========================
                                                                    lnMontoGar2 = 0
                                                                    'lnMontoGar2 = GetGarantias(Reg6!cCtaCod, " NOT IN ('01') ", "1")
                                                                    lnMontoGar2 = Reg6!nGarantSoles
                                                                    If Mid(Reg6!cCtaCod, 9, 1) = "2" Then
                                                                        lnMontoGar2 = lnMontoGar2 / vTipCambioFijo
                                                                    End If

                                                                    '===================== OTRAS GARANTIAS DOLARES ========================
                                                                    'lnMontoGar2 = lnMontoGar2 + GetGarantias(Reg6!cCtaCod, " NOT IN ('01') ", "2")
                                                                    If Mid(Reg6!cCtaCod, 9, 1) = "2" Then
                                                                        lnMontoGar2 = lnMontoGar2 + Reg6!nGarantDol
                                                                    Else
                                                                        lnMontoGar2 = lnMontoGar2 + (Reg6!nGarantDol * vTipCambioFijo)
                                                                    End If

'                                                                    If lbFinMes Then
                                                                        lnDeuda = Reg6!nSaldoCap + Reg6!nIntDev + lnMora + Reg6!nGastoPend
                                                                        lnIntDeveng = Reg6!nIntDev
'                                                                    Else ' Datos a la Fecha
'                                                                        If Not IsNull(Reg6!dfecUltDesemb) Then FecUltPago = Reg6!dfecUltDesemb
'                                                                        Periodo = IIf(Reg6!nplazoapr = 0, 30, Reg6!nplazoapr)
'                                                                        TasaInt = Format(InteresReal(Format(Reg6!nTasaInt / 100, "#0.000"), IIf(Reg6!nplazoapr = 0, 30, Reg6!nplazoapr)) * 100, "#0.00")
'                                                                        'Calculo de la Deuda
'                                                                        If Reg6!cTipCuota = "4" Then
'                                                                           lnDeuda = fgCalculaDeudaTotalaFechaCuotaLibre(Reg6!cCtaCod, dbCmact)
'                                                                           lnIntDeveng = fgCalculaInteresaFechaCuotaLibre(Reg6!cCtaCod, dbCmact)
'                                                                        Else
'                                                                           If Reg6!nTipoDesemb = "P" Then
'                                                                              Call CargaCuotas(Reg6!cCtaCod)
'                                                                              lnDeuda = TotalDeudaParcial(dbCmact, Reg6!cCtaCod)
'                                                                              lnIntDeveng = MatPagos(0).Interes  ' TotalInteresaFecha
'                                                                           Else
'                                                                              lnDeuda = fgCalculaDeudaTotalaFecha(Reg6!cCtaCod, dbCmact)
'                                                                              lnIntDeveng = fgCalculaInteresaFecha(Reg6!cCtaCod, dbCmact) + fgCalculaInteresReprogramados(Reg6!cCtaCod, dbCmact)
'
'                                                                           End If
'                                                                        End If
'                                                                    End If

                                                                    ContD = ContD + 1
                                                                    'If ContD > PrgBarra.Max Then
                                                                    '    PrgBarra.Max = ContD
                                                                    '    PrgBarra.Value = ContD
                                                                    'Else
                                                                    '    PrgBarra.Value = ContD
                                                                    'End If
                                                                    If liLineas >= 62 Then
                                                                        lsRtfImp = lsRtfImp & Chr(12)
                                                                        cpag = cpag + 1
                                                                        lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                                                                        lsRtfImp = lsRtfImp & ImpCredVigGarantSubCab
                                                                        liLineas = 8
                                                                    End If
                                                                    '============================== psCadena DE IMPRESION ==========================
                                                                    lsRtfImp = lsRtfImp & Reg6!cCtaCod & Space(3) & ImpreFormat(Trim(Cliente), 30, 0) & Space(3)
                                                                    lsRtfImp = lsRtfImp & ImpreFormat(Reg6!nDiasAtraso, 5, 0, True) & Space(8) & ImpreFormat(Reg6!nTasaInt, 3, 2, True)
                                                                    lsRtfImp = lsRtfImp & ImpreFormat(Reg6!nMontoDesemb, 12, 2, True) & Space(1) & ImpreFormat(Reg6!nCuotaApr, 12, , True)
                                                                    lsRtfImp = lsRtfImp & ImpreFormat(Reg6!nSaldoCap, 12, 2, True) & Space(1) & ImpreFormat(lnMora, 12, , True)
                                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnIntDeveng, 10, 2, True) & ImpreFormat(lnDeuda, 15, 2, True) & Space(5)
                                                                    lsRtfImp = lsRtfImp & ImpreFormat(Reg6!cCodAnalista, 4, 0, False) & ImpreFormat(lnMontoGar1, 12, 2, True) & Space(1)
                                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnMontoGar2, 12, 2, True) & Space(3) & lsFecha & Chr(10)
                                                                    liLineas = liLineas + 1
                                                                    If ContD >= 100 Then
                                                                        lsRtfImpAux = lsRtfImpAux & lsRtfImp
                                                                        lsRtfImp = ""
                                                                    End If
                                                                    '======= SUMAR TOTALES FUENTE DE FINANCIAMIENTO ========
                                                                    liTCredF = liTCredF + 1
                                                                    lnTMontoGar1F = lnTMontoGar1F + IIf(IsNull(lnMontoGar1), 0, lnMontoGar1)
                                                                    lnTMontoGar2F = lnTMontoGar2F + IIf(IsNull(lnMontoGar2), 0, lnMontoGar2)
                                                                    lnTDesembCapF = lnTDesembCapF + IIf(IsNull(Reg6!nMontoDesemb), 0, Reg6!nMontoDesemb)
                                                                    lnTSaldoCapF = lnTSaldoCapF + IIf(IsNull(Reg6!nSaldoCap), 0, Reg6!nSaldoCap)
                                                                    lnTMoraF = lnTMoraF + lnMora
                                                                    lnTIntDevengF = lnTIntDevengF + lnIntDeveng
                                                                    lnTDeudaF = lnTDeudaF + lnDeuda
                                                                    Reg6.MoveNext '--- Datos - Crédito
                                                                    DoEvents
                                                                Loop '--- Datos - Crédito

                                                                ' ===== SUMAR TOTALES TIPO DE PLAZO
                                                                liTCredP = liTCredP + liTCredF
                                                                lnTMontoGar1P = lnTMontoGar1P + lnTMontoGar1F
                                                                lnTMontoGar2P = lnTMontoGar2P + lnTMontoGar2F
                                                                lnTDesembCapP = lnTDesembCapP + lnTDesembCapF
                                                                lnTSaldoCapP = lnTSaldoCapP + lnTSaldoCapF
                                                                lnTMoraP = lnTMoraP + lnTMoraF
                                                                lnTIntDevengP = lnTIntDevengP + lnTIntDevengF
                                                                lnTDeudaP = lnTDeudaP + lnTDeudaF
                                                                If liLineas >= 58 Then 'Para el control de salto de página
                                                                   lsRtfImp = lsRtfImp & Chr(12)
                                                                   cpag = cpag + 1
                                                                   lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                                                                   liLineas = 5
                                                                End If
                                                                ' ===== IMPRIMIR SUB TOTAL FUENTE DE FINANCIAMIENTO ========
                                                                lsRtfImp = lsRtfImp & String(223, "-") & Chr(10)
                                                                lsRtfImp = lsRtfImp & Space(3) & "TOTAL FUENTE FINANCIAMIENTO  CASOS  :  " & ImpreFormat(liTCredF, 4, 0, True) & Space(55)
                                                                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapF, 18, , True)
                                                                lsRtfImp = lsRtfImp & Space(1) & ImpreFormat(lnTMoraF, 12, , True) & ImpreFormat(lnTIntDevengF, 10, , True)
                                                                lsRtfImp = lsRtfImp & ImpreFormat(lnTDeudaF, 15, , True) & Space(6)
                                                                lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoGar1F, 12, 2, True) & Space(1) & ImpreFormat(lnTMontoGar2F, 12, 2, True) & Chr(10)
                                                                lsRtfImp = lsRtfImp & String(223, "-") & Chr(10)
                                                                liLineas = liLineas + 3

                                                                '*********** psCadena IMPRESION RESUMEN POR F. FINANCIAMIENTO *************
                                                                If Trim(reg1!nConsValor) = "1" Then
                                                                    liContS = liContS + 1
                                                                    '*********** [ SUB TOTAL POR FUENTE DE FINANCIAMIENTO ] *************
                                                                    ReDim Preserve lsCadenaS(liContS)
                                                                    lsCadenaS(liContS) = lsDescF & Space(4) & ImpreFormat(liTCredF, 10, 0, True) & _
                                                                    ImpreFormat(lnTDesembCapF, 15, , True) & ImpreFormat(lnTSaldoCapF, 15, , True) & _
                                                                    ImpreFormat(lnTIntDevengF, 15, , True) & ImpreFormat(lnTDeudaF, 15, , True) & _
                                                                    ImpreFormat(lnTMontoGar1F, 15, , True) & ImpreFormat(lnTMontoGar2F, 15, , True) & Chr(10)
                                                                Else
                                                                    liContD = liContD + 1
                                                                    '*********** [ SUB TOTAL POR FUENTE DE FINANCIAMIENTO ] *************
                                                                    ReDim Preserve lsCadenaD(liContD)
                                                                    lsCadenaD(liContD) = lsDescF & Space(4) & ImpreFormat(liTCredF, 10, 0, True) & _
                                                                    ImpreFormat(lnTDesembCapF, 15, , True) & ImpreFormat(lnTSaldoCapF, 15, , True) & _
                                                                    ImpreFormat(lnTIntDevengF, 15, , True) & ImpreFormat(lnTDeudaF, 15, , True) & _
                                                                    ImpreFormat(lnTMontoGar1F, 15, , True) & ImpreFormat(lnTMontoGar2F, 15, , True) & Chr(10)
                                                                End If

                                                            End If '---liDatos - Créditos
                                                            Reg6.Close
                                                            Set Reg6 = Nothing
                                                            lbSiCambio = True
                                                            Reg5.MoveNext '--- Fuente de Financiamiento
                                                        Loop '--- Fuente de Financiamiento
                                                    End If '--- Fuente de Financiamiento

                                                    If liLineas >= 58 Then 'Para el control de salto de página
                                                       lsRtfImp = lsRtfImp & Chr(12)
                                                       cpag = cpag + 1
                                                       lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                                                       liLineas = 5
                                                    End If
                                                    '============ IMPRIMIR SUB TOTAL PLAZO =====================
                                                    lsRtfImp = lsRtfImp & String(223, "-") & Chr(10)
                                                    lsRtfImp = lsRtfImp & Space(3) & "TOTAL PLAZO                  CASOS  :  " & ImpreFormat(liTCredP, 4, 0, True) & Space(55)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapP, 18, , True)
                                                    lsRtfImp = lsRtfImp & Space(1) & ImpreFormat(lnTMoraP, 12, , True) & ImpreFormat(lnTIntDevengP, 10, , True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTDeudaP, 15, , True) & Space(6)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoGar1P, 12, 2, True) & Space(1) & ImpreFormat(lnTMontoGar2P, 12, 2, True) & Chr(10)
                                                    lsRtfImp = lsRtfImp & String(223, "-") & Chr(10)
                                                    liLineas = liLineas + 3

                                                    '*********** psCadena IMPRESION RESUMEN POR PLAZO *************
                                                    If Trim(reg1!nConsValor) = "1" Then
                                                        liContS = liContS + 1
                                                        '*********** [ SUB TOTAL POR PLAZO ] *************
                                                        ReDim Preserve lsCadenaS(liContS)
                                                        lsDescP = "TOTAL  " & lsDescP
                                                        lsCadenaS(liContS) = String(160, "-") & Chr(10) & lsDescP & Space(4) & ImpreFormat(liTCredP, 10, 0, True) & _
                                                        ImpreFormat(lnTDesembCapP, 15, , True) & ImpreFormat(lnTSaldoCapP, 15, , True) & _
                                                        ImpreFormat(lnTIntDevengP, 15, , True) & ImpreFormat(lnTDeudaP, 15, , True) & _
                                                        ImpreFormat(lnTMontoGar1P, 15, , True) & ImpreFormat(lnTMontoGar2P, 15, , True) & Chr(10) & String(160, "-") & Chr(10) & Chr(10)
                                                    Else
                                                        liContD = liContD + 1
                                                        '*********** [ SUB TOTAL POR PLAZO ] *************
                                                        ReDim Preserve lsCadenaD(liContD)
                                                        lsDescP = "TOTAL  " & lsDescP
                                                        lsCadenaD(liContD) = String(160, "-") & Chr(10) & lsDescP & Space(4) & ImpreFormat(liTCredP, 10, 0, True) & _
                                                        ImpreFormat(lnTDesembCapP, 15, , True) & ImpreFormat(lnTSaldoCapP, 15, , True) & _
                                                        ImpreFormat(lnTIntDevengP, 15, , True) & ImpreFormat(lnTDeudaP, 15, , True) & _
                                                        ImpreFormat(lnTMontoGar1P, 15, , True) & ImpreFormat(lnTMontoGar2P, 15, , True) & Chr(10) & String(160, "-") & Chr(10) & Chr(10)
                                                    End If

                                                    '============= SUMAR TOTALES PRODUCTO ======================
                                                    liTCredPr = liTCredPr + liTCredP
                                                    lnTMontoGar1Pr = lnTMontoGar1Pr + lnTMontoGar1P
                                                    lnTMontoGar2Pr = lnTMontoGar2Pr + lnTMontoGar2P
                                                    lnTDesembCapPr = lnTDesembCapPr + lnTDesembCapP
                                                    lnTSaldoCapPr = lnTSaldoCapPr + lnTSaldoCapP
                                                    lnTMoraPr = lnTMoraPr + lnTMoraP
                                                    lnTIntDevengPr = lnTIntDevengPr + lnTIntDevengP
                                                    lnTDeudaPr = lnTDeudaPr + lnTDeudaP
                                                    '*************************************************************
                                                End If '----liDatos - Tipo de Plazo
                                                lbSiCambio = True
                                                Reg2.MoveNext '--- Tipo de Plazo
                                            Loop '--- Tipo de Plazo
                                        End If '--- Tipo de Plazo
                                        '============= SUMAR TOTALES MONEDA ======================
                                        liTCredM = liTCredM + liTCredPr
                                        lnTMontoGar1M = lnTMontoGar1M + lnTMontoGar1Pr
                                        lnTMontoGar2M = lnTMontoGar2M + lnTMontoGar2Pr
                                        lnTDesembCapM = lnTDesembCapM + lnTDesembCapPr
                                        lnTSaldoCapM = lnTSaldoCapM + lnTSaldoCapPr
                                        lnTMoraM = lnTMoraM + lnTMoraPr
                                        lnTIntDevengM = lnTIntDevengM + lnTIntDevengPr
                                        lnTDeudaM = lnTDeudaM + lnTDeudaPr
                                        If liLineas >= 58 Then 'Para el control de salto de página
                                           lsRtfImp = lsRtfImp & Chr(12)
                                           cpag = cpag + 1
                                           lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                                           liLineas = 5
                                        End If
                                            If Trim(reg1!nConsValor) = "1" Then
                                                liNumCredMS = liTCredM
                                                lnTMontoAprMS = lnTDesembCapM
                                                lnTSaldoCapMS = lnTSaldoCapM
                                                lnTIntDevMS = lnTIntDevengM
                                                lnTDeudaMS = lnTDeudaM
                                                lnTGar1MS = lnTMontoGar1M
                                                lnTGar2MS = lnTMontoGar2M
                                            Else
                                                liNumCredMD = liTCredM
                                                lnTMontoAprMD = lnTDesembCapM
                                                lnTSaldoCapMD = lnTSaldoCapM
                                                lnTIntDevMD = lnTIntDevengM
                                                lnTDeudaMD = lnTDeudaM
                                                lnTGar1MD = lnTMontoGar1M
                                                lnTGar2MD = lnTMontoGar2M
                                            End If

                                        '============ IMPRIMIR SUB TOTAL PRODUCTO =====================
                                        lsRtfImp = lsRtfImp & String(223, "-") & Chr(10)
                                        lsRtfImp = lsRtfImp & Space(3) & "TOTAL PRODUCTO               CASOS  :  " & ImpreFormat(liTCredPr, 4, 0, True) & Space(55)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPr, 18, , True)
                                        lsRtfImp = lsRtfImp & Space(1) & ImpreFormat(lnTMoraPr, 12, , True) & ImpreFormat(lnTIntDevengPr, 10, , True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTDeudaPr, 15, , True) & Space(6)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoGar1Pr, 12, 2, True) & Space(1) & ImpreFormat(lnTMontoGar2Pr, 12, 2, True) & Chr(10)
                                        lsRtfImp = lsRtfImp & String(223, "-") & Chr(10)
                                        liLineas = liLineas + 3

                                        '*************psCadena IMPRESION RESUMEN POR PRODUCTO**************
                                        If Trim(reg1!nConsValor) = "1" Then
                                            liContS = liContS + 1
                                            '****************** [ SUB TOTAL POR PRODUCTO ] ********************
                                            ReDim Preserve lsCadenaS(liContS)
                                            lsCadenaS(liContS) = String(160, "-") & Chr(10) & lsDescPr & Space(4) & ImpreFormat(liTCredPr, 10, 0, True) & _
                                            ImpreFormat(lnTDesembCapPr, 15, , True) & ImpreFormat(lnTSaldoCapPr, 15, , True) & _
                                            ImpreFormat(lnTIntDevengPr, 15, , True) & ImpreFormat(lnTDeudaPr, 15, , True) & _
                                            ImpreFormat(lnTMontoGar1Pr, 15, , True) & ImpreFormat(lnTMontoGar2Pr, 15, , True) & Chr(10) & String(160, "-") & Chr(10)
                                        Else
                                            liContD = liContD + 1
                                            '****************** [ SUB TOTAL POR PRODUCTO ] ********************
                                            ReDim Preserve lsCadenaD(liContD)
                                            lsCadenaD(liContD) = String(160, "-") & Chr(10) & lsDescPr & Space(4) & ImpreFormat(liTCredPr, 10, 0, True) & _
                                            ImpreFormat(lnTDesembCapPr, 15, , True) & ImpreFormat(lnTSaldoCapPr, 15, , True) & _
                                            ImpreFormat(lnTIntDevengPr, 15, , True) & ImpreFormat(lnTDeudaPr, 15, , True) & _
                                            ImpreFormat(lnTMontoGar1Pr, 15, , True) & ImpreFormat(lnTMontoGar2Pr, 15, , True) & Chr(10) & String(160, "-") & Chr(10)
                                        End If

                                    End If '---liDatos - Sub Tipo de Crédito
                                    lbSiCambio = True
                                    Reg4.MoveNext
                                Loop 'Sub Tipo de Crédito
                            End If 'Sub Tipo de Crédito
                            Reg4.Close
                            Set Reg4 = Nothing
                        End If '---liDatos - Tipo de crédito
                        Reg3.MoveNext
                    Loop '--- Tipo de Crédito
                End If '--- Tipo de Crédito
                If liLineas >= 58 Then 'Para el control de salto de página
                   lsRtfImp = lsRtfImp & Chr(12)
                   cpag = cpag + 1
                   lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                   liLineas = 5
                End If
                '============ IMPRIMIR SUB TOTAL MONEDA =====================
                lsRtfImp = lsRtfImp & String(223, "-") & Chr(10)
                lsRtfImp = lsRtfImp & Space(3) & "TOTAL MONEDA                 CASOS  :  " & ImpreFormat(liTCredM, 4, 0, True) & Space(55)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapM, 18, , True)
                lsRtfImp = lsRtfImp & Space(1) & ImpreFormat(lnTMoraM, 12, , True) & ImpreFormat(lnTIntDevengM, 10, , True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTDeudaM, 15, , True) & Space(6)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoGar1M, 12, 2, True) & Space(1) & ImpreFormat(lnTMontoGar2M, 12, 2, True) & Chr(10)
                lsRtfImp = lsRtfImp & String(223, "-") & Chr(12)
                liLineas = liLineas + 3
            End If '---liDatos - Moneda
            lbSiCambio = True
            RaiseEvent Progress(reg1.Bookmark, reg1.RecordCount)
            reg1.MoveNext
            If Not reg1.EOF Then
                lsRtfImp = lsRtfImp & Chr(10)
                cpag = cpag + 1
                liLineas = 0
            End If
        Loop ' ---- Moneda
        lsRtfImp = lsRtfImp & Chr(10)

        If liContS > 0 Then
            lsRtfImp = lsRtfImp & Chr(10)
            lsRtfImp = lsRtfImp & "DETALLE POR LINEA DE CREDITO - NUEVOS SOLES - " & NombreAgencia(psAgencia) & Chr(10)
            lsRtfImp = lsRtfImp & String(40, "-") & Chr(10)
            liLineas = 3
        End If
        For i = 1 To liContS
            If liLineas >= 58 Then
                lsRtfImp = lsRtfImp & Chr(12)
                liLineas = 0
            End If
            lsRtfImp = lsRtfImp & lsCadenaS(i)
            liLineas = liLineas + 1
            If liLineas >= 62 Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                liLineas = 4
            End If
        Next i
        '========================= Impresión de SubTotal ================================
        If liContS > 0 Then
            lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
            lsRtfImp = lsRtfImp & "***** TOTALES MONEDA          CASOS  : " & ImpreFormat(liNumCredMS, 10, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoAprMS, 15, , True) & ImpreFormat(lnTSaldoCapMS, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevMS, 15, , True) & ImpreFormat(lnTDeudaMS, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTGar1MS, 15, , True) & ImpreFormat(lnTGar2MS, 15, , True) & Chr(10)
            lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
            liLineas = liLineas + 3
        End If
        lsRtfImp = lsRtfImp '& Chr(12)
        If liContD > 0 Then
            lsRtfImp = lsRtfImp & lsCadenaD(1)
            lsRtfImp = lsRtfImp & Chr(10) & Chr(10)
            lsRtfImp = lsRtfImp & "DETALLE POR LINEA DE CREDITO - DOLARES USD- " & NombreAgencia(psAgencia) & Chr(10)
            lsRtfImp = lsRtfImp & String(40, "-") & Chr(10)
            liLineas = 4
        End If
        For i = 1 To liContD
            If liLineas >= 58 Then
                lsRtfImp = lsRtfImp & Chr(12)
                liLineas = 0
            End If
            lsRtfImp = lsRtfImp & lsCadenaD(i)
            liLineas = liLineas + 1
            If liLineas >= 62 Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                lsRtfImp = lsRtfImp & ImpCredVigGarantCab(lsFecFinMes, psDesCadena, pnDiasAtrasoIni, pnDiasAtrasoFin, cpag, psAgencia)
                liLineas = 4
            End If
        Next i
        If liContD > 0 Then
            lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
            lsRtfImp = lsRtfImp & "***** TOTALES MONEDA          CASOS  : " & ImpreFormat(liNumCredMD, 10, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoAprMD, 15, , True) & ImpreFormat(lnTSaldoCapMD, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevMD, 15, , True) & ImpreFormat(lnTDeudaMD, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTGar1MD, 15, , True) & ImpreFormat(lnTGar2MD, 15, , True) & Chr(10)
            lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
            liLineas = liLineas + 3
        End If
        lsRtfImpAux = lsRtfImpAux & lsRtfImp
    End If '--- Moneda
    reg1.Close
    Set reg1 = Nothing
    Reg2.Close
    Set Reg2 = Nothing
    Reg3.Close
    Set Reg4 = Nothing
    Reg5.Close
    Set Reg5 = Nothing
    RaiseEvent CloseProgress
Else
    nRepo108721_fgImpCredVigGarant = ""
End If '--- liDatos - General
lsRtfImpG = lsRtfImpAux
nRepo108721_fgImpCredVigGarant = lsRtfImpG
End Function

Private Function ImpCredVigGarantCab(ByVal psFecData As String, ByVal psDesCondiciones As String, _
            ByVal pnDiasIni As Integer, ByVal pnDiasFin As Integer, ByVal pnPag As Integer, ByVal psAgencia As String) As String
Dim lsTitulo As String
Dim lsSubTit As String
Dim lsCad As String
    lsTitulo = "CREDITOS VIGENTES - GARANTIAS   " & NombreAgencia(psAgencia) & " AL : " & Format(psFecData, "dd/mm/yyyy")
    lsSubTit = " DE  " & CStr(pnDiasIni) & " A " & CStr(pnDiasFin)

lsCad = lsCad & CabRepoCreditos(lsTitulo, lsSubTit, pnPag, 208, psDesCondiciones, True)
ImpCredVigGarantCab = lsCad
End Function


Public Function CabRepoCreditos(pTitulo As String, pSubTitulo As String, _
                     pPagina As Integer, pAnchoLin As Integer, _
                     pComenta As String, Optional pCiereDia As Boolean = True) As String

  Dim lsCabe01 As String, lsCabe02 As String
  Dim lsCabe03 As String, lsCabe04 As String
   
  CabRepoCreditos = ""
  ' Cabecera 1
  lsCabe01 = FillText(Trim(sNomCmac), 35, " ")
  lsCabe01 = lsCabe01 & Space(pAnchoLin - 35 - 25)
  lsCabe01 = lsCabe01 & "Pag.  : " & Str(pPagina) & "   "
  'lsCabe01 = lsCabe01 & IIf(pCiereDia = True, IIf(VerifSiCierreDia(), "DC", "AC"), "")
  lsCabe01 = lsCabe01 & " - " & sCodUser & Chr(10)
  ' Cabecera 2
  lsCabe01 = lsCabe01 & FillText(Trim(sNomAge), 35, " ")
  lsCabe01 = lsCabe01 & Space(pAnchoLin - 35 - 25)
  lsCabe01 = lsCabe01 & "Fecha : " & Format(FechaSistema & " " & Time, "dd/mm/yyyy") & Chr(10)
  ' Titulo
  lsCabe02 = String(Int((pAnchoLin - Len(pTitulo)) / 2), " ") & pTitulo & Chr(10)
  ' SubTitulo
  lsCabe03 = String(Int((pAnchoLin - Len(pSubTitulo)) / 2), " ") & pSubTitulo & Chr(10)
  ' Comenta
  lsCabe04 = IIf(Len(pComenta) > 0, pComenta & Chr(10), "")
  ' ***
  CabRepoCreditos = CabRepoCreditos & lsCabe01 & lsCabe02
  CabRepoCreditos = CabRepoCreditos & lsCabe03 & lsCabe04
       
End Function

Public Function GetCodCaja() As String
Dim rs As New ADODB.Recordset
Dim sql As String

sql = "select nConsSisValor Codigo from ConstSistema Where nConsSisCod = 3"
Conecta.AbreConexion
Set rs = Conecta.CargaRecordSet(sql)
Conecta.CierraConexion
GetCodCaja = rs!Codigo
Set rs = Nothing
End Function

Public Function nRepo108722_fgImpCredPersVigentesGarant(ByVal psServConsol As String, ByVal pnTipCambio As Double, ByVal psCadena As String, ByVal psDesCadena As String, _
        ByVal pnDiasAtrasoIni As Integer, ByVal pnDiasAtrasoFin As Integer, ByVal psAgencia As String, ByVal dFecSis As Date) As String

Dim Sql9 As String
Dim reg As New ADODB.Recordset
Dim reg1 As New ADODB.Recordset
Dim Reg2 As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim Reg3 As New ADODB.Recordset
Dim Reg4 As New ADODB.Recordset
Dim Reg5 As New ADODB.Recordset
Dim Reg6 As New ADODB.Recordset
Dim RegGar As New ADODB.Recordset
Dim RegFF As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String * 50
Dim lsDescP As String * 50
Dim lsDescF As String
Dim lsDescFF As String
Dim lsDatos As Integer
Dim liNumCredM As Integer
Dim lnTMontoAprM As Double
Dim lnTSaldoCapM As Double
Dim lnTIntDevM As Double
Dim lnTDeudaM As Double
Dim lnTCapVencidoM As Double
Dim lnTCapxVencerM As Double
Dim lnTGar1M As Double
Dim lnTGar2M As Double
Dim liNumCredPr As Integer
Dim lnTMontoAprPr As Double
Dim lnTSaldoCapPr As Double
Dim lnTIntDevPr As Double
Dim lnTDeudaPr As Double
Dim lnTCapVencidoPr As Double
Dim lnTCapxVencerPr As Double
Dim lnTGar1Pr As Double
Dim lnTGar2Pr As Double
Dim liNumCredP As Integer
Dim lnTMontoAprP As Double
Dim lnTSaldoCapP As Double
Dim lnTIntDevP As Double
Dim lnTDeudaP As Double
Dim lnTCapVencidoP As Double
Dim lnTCapxVencerP As Double
Dim lnTGar1P As Double
Dim lnTGar2P As Double
Dim liNumCredFF As Double
Dim lnTMontoAprFF As Double
Dim lnTSaldoCapFF As Double
Dim lnTIntDevFF As Double
Dim lnTDeudaFF As Double
Dim lnTCapVencidoFF As Double
Dim lnTCapxVencerFF As Double
Dim lnTGar1FF As Double
Dim lnTGar2FF As Double
Dim lbSiCambio As Boolean
Dim ContD As Integer
Dim liLineas As Integer
Dim liDatos As Integer
Dim Cliente As String * 40
Dim Fecha As String * 12
Dim fecha1 As String * 12
Dim lnIntDeveng As Double
Dim lnDeudaT As Double
Dim lnCapxVencer As Double
Dim lnMora As Double
Dim lnCapVencido As Double
Dim cadena As String
Dim Cadena1 As String
Dim liCuotas As Integer
Dim liDias As Integer
Dim lnIntComp As Double
Dim lnCapital As Double
Dim lsAbrev As String * 5
Dim lnMontoGar1 As Double
Dim lnMontoGar2 As Double
Dim vTipCambioFijo As Double
Dim liContS As Integer
Dim liContD As Integer
Dim lsCadenaS() As String
Dim lsCadenaD() As String
Dim lsDescLC As String * 35
Dim liNumCredMS As Integer
Dim lnTMontoAprMS As Double
Dim lnTSaldoCapMS As Double
Dim lnTIntDevMS As Double
Dim lnTDeudaMS As Double
Dim lnTCapVencidoMS As Double
Dim lnTCapxVencerMS As Double
Dim lnTGar1MS As Double
Dim lnTGar2MS As Double
Dim liNumCredMD As Integer
Dim lnTMontoAprMD As Double
Dim lnTSaldoCapMD As Double
Dim lnTIntDevMD As Double
Dim lnTDeudaMD As Double
Dim lnTCapVencidoMD As Double
Dim lnTCapxVencerMD As Double
Dim lnTGar1MD As Double
Dim lnTGar2MD As Double

Dim lsSelLinea As String

Dim lbFinMes As Boolean
Dim lsFecFinMes As String

Dim lsRtfImp As String
Dim lsRtfImpAux As String
Dim cpag As Integer

'------------------
Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim i As Integer
Dim FechaCierre As Date
Dim lsRtfImpG As String

FechaCierre = GetFechaCierreMes
lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
'lsPignoraticio = " 2802,2803,2804,2807 "
lsPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
'--------------------------
liContS = 0
liContD = 0
ReDim lsCadenaS(liContS)
ReDim lsCadenaD(liContD)

lsRtfImp = ""
lsRtfImpAux = ""
ContD = 0
cpag = 1

lbFinMes = True
lsFecFinMes = Format(DateAdd("d", -1 * Day(dFecSis), dFecSis), "mm/dd/yyyy")

vTipCambioFijo = CDbl(pnTipCambio)

'===== Verificar si existen datos para el reporte

Sql9 = "Select count(CS.cCtaCod) as NumCred From " & psServConsol & "CreditoSaldoConsol CS " _
    & " INNER JOIN " & psServConsol & "CreditoConsol Credito ON CS.cCtaCod = Credito.cCtaCod " _
    & " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = Credito.cCtaCod " _
    & " WHERE datediff(d,CS.dFecha,'" & lsFecFinMes & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ")" _
    & " and  CCT.cAgeCodAct='" & psAgencia & "' " _
    & psCadena
Set Reg9 = GetQuery(Sql9)
If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    If Reg9!NumCred = 0 Then
        nRepo108722_fgImpCredPersVigentesGarant = ""
        Exit Function
    End If
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then
    RaiseEvent ShowProgress
    lbSiCambio = False
        
       '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set reg1 = loConst.RecuperaConstantes(gMoneda)

    '======== Tipo de Plazo =========
        Set Reg2 = loConst.RecuperaConstantes(gColocLineaCredPlazo)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    Set RegFF = ObtieneLineaCredito 'Fuente Financiamiento

   '========= Tipo de Créditos  =========
    Set Reg4 = GetTipoCred
    nRepo108722_fgImpCredPersVigentesGarant = ""
    If reg1.EOF And reg1.BOF Then
    Else
        Do While Not reg1.EOF
            '============= LIMPIAR LOS DATOS PARA SUBTOTALES POR MONEDA =====================
            lsDescM = reg1!cConsDescripcion
            lnTMontoAprM = 0
            lnTSaldoCapM = 0
            lnTIntDevM = 0
            lnTDeudaM = 0
            lnTCapVencidoM = 0
            lnTCapxVencerM = 0
            liNumCredM = 0
            lnTDeudaM = 0
            lnTGar1M = 0
            lnTGar2M = 0
            '=============== VERIFICAR SI EXISTEN DATOS PARA UN TIPO DE MONEDA ==============

            Sql9 = "Select count(CS.cCtaCod) as NumCred From " & psServConsol & "CreditoSaldoConsol CS " _
                & " INNER JOIN " & psServConsol & "CreditoConsol Credito ON CS.cCtaCod = Credito.cCtaCod " _
                & " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = Credito.cCtaCod " _
                & " WHERE datediff(d,CS.dFecha,'" & lsFecFinMes & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ")" _
                & " And CCT.cAgeCodAct ='" & psAgencia & "'  " _
                & " And substring(CCT.cTpoCredCod,1,1) = '7' " _
                & " And Substring(CS.cCtaCod,9,1) = '" & Trim(reg1!nConsValor) & "' " _
                & psCadena
            Set Reg9 = GetQuery(Sql9)
                If Reg9.EOF And Reg9.BOF Then
                    liDatos = 0
                Else
                    liDatos = Reg9!NumCred
                End If
                Reg9.Close
                Set Reg9 = Nothing

                If liDatos > 0 Then
                    lsRtfImp = lsRtfImp & fgCredPersVigentesCab(lsFecFinMes, pnDiasAtrasoIni, pnDiasAtrasoFin, psDesCadena, cpag, psAgencia)
                    liLineas = liLineas + 4

                    If lbSiCambio Then
                        lbSiCambio = False
                    End If
                    lsRtfImp = lsRtfImp & "MONEDA         : " & lsDescM & Chr(10)
                    liLineas = liLineas + 1

                    If Reg4.EOF And Reg4.BOF Then
                    Else
                        Reg4.MoveFirst
                        Do While Not Reg4.EOF
                            Sql9 = "Select count(CS.cCtaCod) as NumCred From " & psServConsol & "CreditoSaldoConsol CS " _
                                & " INNER JOIN " & psServConsol & "CreditoConsol Credito ON CS.cCtaCod = Credito.cCtaCod " _
                                & " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = Credito.cCtaCod " _
                                & " WHERE datediff(d,CS.dFecha,'" & lsFecFinMes & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ")" _
                                & " And CCT.cAgeCodAct ='" & psAgencia & "'  " _
                                & " And Substring(CS.cCtaCod,9,1) = '" & Trim(reg1!nConsValor) & "' " _
                                & " And Substring(Credito.cLineaCred,7,1) = '" & Mid(Trim(Reg4!nConsValor), 1, 1) & "' " _
                                & psCadena
 
                            Set Reg9 = GetQuery(Sql9)
                            If Reg9.EOF And Reg9.BOF Then
                                liDatos = 0
                            Else
                                liDatos = Reg9!NumCred
                            End If
                            Reg9.Close
                            Set Reg9 = Nothing

                            If liDatos > 0 Then
                                '======= Sub Tipo de Crédito =========
                                Set Reg5 = GetSubTipoCred(Reg4!nConsValor)
                                If Reg5.EOF And Reg5.BOF Then
                                Else
                                    Do While Not Reg5.EOF
                                        '============= LIMPIAR LOS DATOS PARA SUBTOTALES POR PRODUCTO =====================
                                        lsDescPr = Trim(Reg4!cConsDescripcion) & " - " & Trim(Reg5!cConsDescripcion)
                                        lnTMontoAprPr = 0:   lnTSaldoCapPr = 0
                                        lnTIntDevPr = 0:     lnTDeudaPr = 0
                                        lnTCapVencidoPr = 0: lnTCapxVencerPr = 0
                                        liNumCredPr = 0:     lnTDeudaPr = 0
                                        lnTGar1Pr = 0:       lnTGar2Pr = 0
                                        '=============== VERIFICAR SI EXISTEN DATOS PARA UN TIPO DE PRODUCTO ==============
                                        Sql9 = "Select count(CS.cCtaCod) as NumCred From " & psServConsol & "CreditoSaldoConsol CS " _
                                            & " INNER JOIN " & psServConsol & "CreditoConsol Credito ON CS.cCtaCod = Credito.cCtaCod " _
                                            & " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = Credito.cCtaCod " _
                                            & " WHERE datediff(d,CS.dFecha,'" & lsFecFinMes & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ")" _
                                            & " And CCT.cAgeCodAct ='" & psAgencia & "'  " _
                                            & " And Substring(CS.cCtaCod,9,1) = '" & Trim(reg1!nConsValor) & "' " _
                                            & " And Substring(CS.cLineaCred,7,1) = '" & Mid(Trim(Reg4!nConsValor), 1, 1) & "' " _
                                            & " And substring(CS.cLineaCred,8,2) = '" & Mid(Trim(Reg5!nConsValor), 2, 2) & "' " _
                                            & psCadena
                                        Set Reg9 = GetQuery(Sql9)
                                        If Reg9.EOF And Reg9.BOF Then
                                            liDatos = 0
                                        Else
                                            liDatos = Reg9!NumCred
                                        End If
                                        Reg9.Close
                                        Set Reg9 = Nothing

                                        If liDatos > 0 Then  ' Si hay Datos por Un Tipo de Producto
                                            If lbSiCambio Then
                                                lsRtfImp = lsRtfImp & Chr(10)
                                                liLineas = liLineas + 1
                                                lbSiCambio = False
                                            End If
                                            lsRtfImp = lsRtfImp & "PRODUCTO       : " & lsDescPr & Chr(10)
                                            lsDescLC = lsDescPr
                                            liLineas = liLineas + 1

                                            If Reg2.EOF And Reg2.BOF Then
                                            Else
                                                Reg2.MoveFirst
                                                Do While Not Reg2.EOF
                                                    lsDescP = Reg2!cConsDescripcion
                                                    '======== LIMPIAR DATOS PARA TIPO DE PLAZO =================
                                                    lnTMontoAprP = 0:   lnTSaldoCapP = 0
                                                    lnTIntDevP = 0:     lnTDeudaP = 0
                                                    lnTCapVencidoP = 0: lnTCapxVencerP = 0
                                                    liNumCredP = 0:     lnTDeudaP = 0
                                                    lnTGar1P = 0:       lnTGar2P = 0
                                                    '=============== VERIFICAR SI EXISTEN DATOS PARA plazo ==============
                                                    Sql9 = "Select count(CS.cCtaCod) as NumCred From " & psServConsol & "CreditoSaldoConsol CS " _
                                                        & " INNER JOIN " & psServConsol & "CreditoConsol Credito ON CS.cCtaCod = Credito.cCtaCod " _
                                                        & " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = Credito.cCtaCod " _
                                                        & " WHERE datediff(d,CS.dFecha,'" & lsFecFinMes & "')= 0 And CS.nPrdEstado in (" & lsCreditosVigentes & ")" _
                                                        & " And CCT.cAgeCodAct ='" & psAgencia & "'  " _
                                                        & " And Substring(CS.cCtaCod,9,1) = '" & Trim(reg1!nConsValor) & "' " _
                                                        & " And Substring(CS.cLineaCred,7,1) = '" & Mid(Trim(Reg4!nConsValor), 1, 1) & "' " _
                                                        & " And substring(CS.cLineaCred,8,2) = '" & Mid(Trim(Reg5!nConsValor), 2, 2) & "' " _
                                                        & " And SUBSTRING(CS.cLineaCred,6,1) = '" & Trim(Reg2!nConsValor) & "' " _
                                                        & psCadena
                                                    Set Reg9 = GetQuery(Sql9)
                                                    If Reg9.EOF And Reg9.BOF Then
                                                       liDatos = 0
                                                    Else
                                                       liDatos = Reg9!NumCred
                                                    End If
                                                    Reg9.Close
                                                    Set Reg9 = Nothing

                                                    If liDatos > 0 Then   ' Datos Fuentes Plazo
                                                       If lbSiCambio Then
                                                            lsRtfImp = lsRtfImp & Chr(10)
                                                            liLineas = liLineas + 1
                                                            lbSiCambio = False
                                                        End If
                                                        lsRtfImp = lsRtfImp & "PLAZO          : " & lsDescP & Chr(10)
                                                        liLineas = liLineas + 1

                                                        If RegFF.EOF And RegFF.BOF Then
                                                        Else
                                                           RegFF.MoveFirst
                                                           Do While Not RegFF.EOF
                                                                   lsDescFF = RegFF!cLineaCred
                                                                    '======== LIMPIAR DATOS PARA Fuente Financiamiento=================
                                                                    lnTMontoAprFF = 0
                                                                    lnTSaldoCapFF = 0
                                                                    lnTIntDevFF = 0
                                                                    lnTDeudaFF = 0
                                                                    lnTCapVencidoFF = 0
                                                                    lnTCapxVencerFF = 0
                                                                    liNumCredFF = 0
                                                                    lnTDeudaFF = 0
                                                                    lnTGar1FF = 0
                                                                    lnTGar2FF = 0
                                                                    '============= SELECCION DE DATOS A REPORTAR ===============
                                                                    ' ** Cambio a like LineaCredito
                                                                    ' ** [4][55][1][2][F]
                                                                    lsSelLinea = Trim(RegFF!cLineaCred) & Trim(reg1!nConsValor) & Trim(Reg2!nConsValor) & Mid(Trim(Reg4!nConsValor), 1, 1) & Mid(Trim(Reg5!nConsValor), 2, 2)
                                                                    'Credito.dFecUltDesemb,
                                                                    Sql9 = "Select Credito.cCtaCod, Persona.cPersNombre,  Credito.cCodInst, " _
                                                                        & " Credito.nCuotasApr, Credito.nPlazoApr, CS.nDiasAtraso, Credito.dFecVig, " _
                                                                        & " Credito.nMontoApr, CS.nNroProxCuota , Credito.nCuotaApr, CS.nSaldoCap, Credito.dFecUltPago, " _
                                                                        & " Credito.nTasaInt, IsNull(CS.nMoraCalc,0) as nIntMorCal, Credito.nTipCuota, " _
                                                                        & " Credito.nTipoDesemb, Credito.cRefinan, IsNull(CS.nCapVencido,0) nCapVencido, IsNull(CS.nGastoPend,0) nGastoPend, IsNUll(CS.nIntDev,0) nIntDev,  " _
                                                                        & " (Select cPersNombre From Persona where cPerscod = Credito.cCodInst) AbrevInst , " _
                                                                        & " Credito.nHipoSoles, Credito.nHipoDol, Credito.nGarantSoles, Credito.nGarantDol " _
                                                                        & " FROM " & psServConsol & "CreditoSaldoConsol CS  INNER JOIN " & psServConsol & "CreditoConsol Credito ON CS.cCtaCod = Credito.cCtaCod And CS.nPrdEstado = Credito.nPrdEstado " _
                                                                        & " INNER JOIN CreditoConsolTotal CCT ON CCT.cCtaCod = CS.cCtaCod " _
                                                                        & " Inner Join " & psServConsol & "ProductopersonaConsol PersCredito on Credito.cCtaCod = PersCredito.cCtaCod " _
                                                                        & " Inner Join PERSONA PERSONA on PersCredito.cPersCod = Persona.cPersCod " _
                                                                        & "  " _
                                                                        & " WHERE datediff(d,CS.dFecha,'" & lsFecFinMes & "')= 0 And Credito.nPrdEstado in(" & lsCreditosVigentes & ")" _
                                                                        & " And CCT.cAgeCodAct ='" & psAgencia & "'  AND Credito.cLineaCred like '" & lsSelLinea & "%'" _
                                                                        & " AND nPrdPersRelac = 20 " _
                                                                        & psCadena & " Order by CS.cCtaCod "

                                                                    Set Reg9 = GetQuery(Sql9)
                                                                     If Reg9.EOF And Reg9.BOF Then  ' Datos a Reportar
                                                                     Else
                                                                         If liLineas >= 58 Then 'Para el control de salto de página
                                                                            lsRtfImp = lsRtfImp & Chr(12)
                                                                            cpag = cpag + 1
                                                                            lsRtfImp = lsRtfImp & fgCredPersVigentesCab(lsFecFinMes, pnDiasAtrasoIni, pnDiasAtrasoFin, psDesCadena, cpag, psAgencia)
                                                                            liLineas = 4
                                                                         End If
                                                                         If lbSiCambio Then
                                                                            lsRtfImp = lsRtfImp & Chr(10)
                                                                            liLineas = liLineas + 1
                                                                            lbSiCambio = False
                                                                         End If
                                                                         lsRtfImp = lsRtfImp & "FINANCIAMIENTO : " & lsDescFF & Chr(10)
                                                                         liLineas = liLineas + 2
                                                                         lsRtfImp = lsRtfImp & CredPersVigentesSubCab
                                                                         liLineas = liLineas + 3
                                                                         Do While Not Reg9.EOF

                                                                            Cliente = PstaNombre(Reg9!cPersNombre, False)
                                                                            lsAbrev = IIf(IsNull(Reg9!AbrevInst), "", Reg9!AbrevInst)
                                                                            Fecha = Format(Reg9!dFecVig, "dd/mm/yyyy")
                                                                            fecha1 = Format(Reg9!dFecUltPago, "dd/mm/yyyy")

                                                                             '=================== [ GARANTIA HIPOTECARIA SOLES ] ========================
                                                                            lnMontoGar1 = 0
                                                                            'lnMontoGar1 = GetGarantias(Reg9!cCtaCod, " IN ('01') ", "1")
                                                                            lnMontoGar1 = Reg9!nHipoSoles

                                                                            'lnMontoGar1 = lnMontoGar1 / vTipCambioFijo
                                                                            lnMontoGar1 = lnMontoGar1

                                                                            '================= GARANTIA HIPOTECARIA DOLARES ==========================
                                                                            'lnMontoGar1 = lnMontoGar1 + GetGarantias(Reg9!cCtaCod, " IN ('01') ", "2")
                                                                            'lnMontoGar1 = lnMontoGar1 + Reg9!nhipodol
                                                                            lnMontoGar1 = lnMontoGar1 + (Reg9!nhipodol * vTipCambioFijo)

                                                                            '===================== [OTRAS GARANTIAS SOLES] =========================
                                                                            lnMontoGar2 = 0
                                                                            'lnMontoGar2 = GetGarantias(Reg9!cCtaCod, " NOT IN ('01') ", "1")
                                                                            lnMontoGar2 = Reg9!nGarantSoles

                                                                            'lnMontoGar2 = lnMontoGar2 / vTipCambioFijo
                                                                            lnMontoGar2 = lnMontoGar2

                                                                            
                                                                            '===================== OTRAS GARANTIAS DOLARES ========================
                                                                            'lnMontoGar2 = lnMontoGar2 + GetGarantias(Reg9!cCtaCod, " NOT IN ('01') ", "2")
                                                                            'lnMontoGar2 = lnMontoGar2 + Reg9!nGarantDol
                                                                            lnMontoGar2 = lnMontoGar2 + (Reg9!nGarantDol * vTipCambioFijo)

'                                                                            If lbFinMes Then
                                                                                If Reg9!nDiasAtraso > 0 Then
                                                                                    lnCapVencido = Reg9!nCapVencido
                                                                                Else
                                                                                    lnCapVencido = 0
                                                                                End If
                                                                                lnDeudaT = Format(Reg9!nSaldoCap + Reg9!nIntDev + Reg9!nIntMorCal + Reg9!nGastoPend, "#0.00")
                                                                                lnIntDeveng = Reg9!nIntDev
'                                                                            Else
'
'                                                                                If Reg9!nDiasAtraso > 0 Then
'                                                                                   SQL9 = "set dateformat mdy; Select cCtaCod, Sum(PlanDesPag.nCapital - PlanDesPag.nCapPag) as CapVenc from PLANDESPAG " & _
'                                                                                             "where cCtaCod = '" & Trim(Reg9!cCtaCod) & "' and cTipo = 'C' and nPrdEstado = 'P' " & _
'                                                                                             "and dFecVenc <= '" & Format(gdFecSis, "mm/dd/yyyy") & " 23:59' group by cCtaCod"
'                                                                                   Reg3.Open SQL9, dbCmact, adOpenStatic, adLockReadOnly, adCmdText
'
'                                                                                   If Reg3.EOF And Reg3.BOF Then
'                                                                                      lnCapVencido = 0
'                                                                                   Else
'                                                                                      lnCapVencido = Reg3!CapVenc
'                                                                                   End If
'                                                                                   Reg3.Close
'                                                                                   Set Reg3 = Nothing
'                                                                                Else
'                                                                                   lnCapVencido = 0
'                                                                                End If
'
'                                                                                If Not IsNull(Reg9!dfecUltDesemb) Then FecUltPago = Reg9!dfecUltDesemb
'                                                                                Periodo = IIf(Reg9!nplazoapr = 0, 30, Reg9!nplazoapr)
'                                                                                TasaInt = Format(InteresReal(Format(Reg9!nTasaInt / 100, "#0.000"), IIf(Reg9!nplazoapr = 0, 30, Reg9!nplazoapr)) * 100, "#0.00")
'
'
'                                                                                'Calculo de la Deuda
'                                                                                If Reg9!cTipCuota = "4" Then
'                                                                                   lnDeudaT = fgCalculaDeudaTotalaFechaCuotaLibre(Reg9!cCtaCod, dbCmact)
'                                                                                   lnIntDeveng = fgCalculaInteresaFechaCuotaLibre(Reg9!cCtaCod, dbCmact)
'                                                                                Else
'                                                                                   If Reg9!cTipoDesemb = "P" Then
'                                                                                      Call CargaCuotas(Reg9!cCtaCod)
'                                                                                      lnDeudaT = TotalDeudaParcial(dbCmact, Reg9!cCtaCod)
'                                                                                      lnIntDeveng = TotalInteresaFecha
'                                                                                   Else
'                                                                                      lnDeudaT = fgCalculaDeudaTotalaFecha(Reg9!cCtaCod, dbCmact)
'                                                                                      lnIntDeveng = fgCalculaInteresaFecha(Reg9!cCtaCod, dbCmact) + fgCalculaInteresReprogramados(Reg9!cCtaCod, dbCmact)
'
'                                                                                   End If
'                                                                                End If
'                                                                            End If

                                                                            lnCapxVencer = Reg9!nSaldoCap - lnCapVencido
                                                                            
                                                                            '=========REALIZAR EL PROCESO DE IMPRESION =============
                                                                            lsRtfImp = lsRtfImp & Reg9!cCtaCod & Space(1) & ImpreFormat(Trim(Cliente), 35, 0) & Space(2) & lsAbrev
                                                                            lsRtfImp = lsRtfImp & Space(3) & Fecha & ImpreFormat(Reg9!nCuotasApr, 4, 0, True) & " /" & ImpreFormat(Reg9!nPlazoApr, 3, 0, True) & Space(1)
                                                                            lsRtfImp = lsRtfImp & ImpreFormat(Reg9!nMontoApr, 12, , True) & ImpreFormat(Reg9!nSaldoCap, 12, , True) & ImpreFormat(Reg9!nNroProxCuota, 6, 0, True)
                                                                            lsRtfImp = lsRtfImp & ImpreFormat(Reg9!nDiasAtraso, 9, 0, True) & ImpreFormat(Reg9!nCuotaApr, 10, , True) & Space(5) & fecha1 & ImpreFormat(lnIntDeveng, 10, , True)
                                                                            lsRtfImp = lsRtfImp & ImpreFormat(lnDeudaT, 12, , True) & ImpreFormat(lnCapVencido, 10, , True) & ImpreFormat(lnCapxVencer, 10, , True)
                                                                            lsRtfImp = lsRtfImp & ImpreFormat(lnMontoGar1, 10, , True) & ImpreFormat(lnMontoGar2, 10, , True) & Space(2) & Reg9!cRefinan & Chr(10)

                                                                            '***************** SUMAR TOTALES POR Fuente Financiamiento ***************
                                                                            liNumCredFF = liNumCredFF + 1
                                                                            lnTMontoAprFF = lnTMontoAprFF + IIf(IsNull(Reg9!nMontoApr), 0, Reg9!nMontoApr)
                                                                            lnTSaldoCapFF = lnTSaldoCapFF + IIf(IsNull(Reg9!nSaldoCap), 0, Reg9!nSaldoCap)
                                                                            lnTIntDevFF = lnTIntDevFF + lnIntDeveng
                                                                            lnTDeudaFF = lnTDeudaFF + lnDeudaT
                                                                            lnTCapVencidoFF = lnTCapVencidoFF + lnCapVencido
                                                                            lnTCapxVencerFF = lnTCapxVencerFF + lnCapxVencer
                                                                            lnTGar1FF = lnTGar1FF + lnMontoGar1
                                                                            lnTGar2FF = lnTGar2FF + lnMontoGar2
                                                                            '***********************************************************
                                                                            liLineas = liLineas + 1
                                                                            ContD = ContD + 1
                                                                            If ContD > 100 Then
                                                                               lsRtfImpAux = lsRtfImpAux & lsRtfImp
                                                                               lsRtfImp = ""
                                                                            End If

                                                                            If liLineas >= 58 Then 'Para el control de salto de página
                                                                               lsRtfImp = lsRtfImp & Chr(12)
                                                                               cpag = cpag + 1
                                                                               lsRtfImp = lsRtfImp & fgCredPersVigentesCab(lsFecFinMes, pnDiasAtrasoIni, pnDiasAtrasoFin, psDesCadena, cpag, psAgencia)
                                                                               lsRtfImp = lsRtfImp & CredPersVigentesSubCab
                                                                               liLineas = 7
                                                                               
                                                                            End If

                                                                            Reg9.MoveNext ' DATOS A REPORTAR
                                                                         Loop

                                                                         If liLineas >= 58 Then 'Para el control de salto de página
                                                                            lsRtfImp = lsRtfImp & Chr(12)
                                                                            cpag = cpag + 1
                                                                            lsRtfImp = lsRtfImp & fgCredPersVigentesCab(lsFecFinMes, pnDiasAtrasoIni, pnDiasAtrasoFin, psDesCadena, cpag, psAgencia)
                                                                            liLineas = 4
                                                                         End If
                                                                         '***************** SUMAR TOTALES POR PLAZO ****************
                                                                         liNumCredP = liNumCredP + liNumCredFF
                                                                         lnTMontoAprP = lnTMontoAprP + lnTMontoAprFF
                                                                         lnTSaldoCapP = lnTSaldoCapP + lnTSaldoCapFF
                                                                         lnTIntDevP = lnTIntDevP + lnTIntDevFF
                                                                         lnTDeudaP = lnTDeudaP + lnTDeudaFF
                                                                         lnTCapVencidoP = lnTCapVencidoP + lnTCapVencidoFF
                                                                         lnTCapxVencerP = lnTCapxVencerP + lnTCapxVencerFF
                                                                         lnTGar1P = lnTGar1P + lnTGar1FF
                                                                         lnTGar2P = lnTGar2P + lnTGar2FF


                                                                         ' ===== IMPRIMIR SUB TOTAL FUENTE DE FINANCIAMIENTO ========
                                                                        lsRtfImp = lsRtfImp & String(250, "-") & Chr(10)
                                                                        lsRtfImp = lsRtfImp & "***** TOTAL FUENTE FINANCIAMIENTO     CASOS:  " & ImpreFormat(liNumCredFF, 6, 0, True) & Space(35)
                                                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoAprFF, 12, , True) & ImpreFormat(lnTSaldoCapFF, 12, , True) & Space(43)
                                                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevFF, 12, , True) & ImpreFormat(lnTDeudaFF, 12, , True)
                                                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVencidoFF, 10, , True) & ImpreFormat(lnTCapxVencerFF, 10, , True)
                                                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTGar1FF, 10, , True) & ImpreFormat(lnTGar2FF, 10, , True) & Chr(10)
                                                                        lsRtfImp = lsRtfImp & String(250, "-") & Chr(10)
                                                                        liLineas = liLineas + 3

                                                                         '*************CADENA IMPRESION RESUMEN POR PLAZO**************
                                                                          If Trim(reg1!nConsValor) = "1" Then
                                                                             liContS = liContS + 1
                                                                             ReDim Preserve lsCadenaS(liContS)

                                                                             lsCadenaS(liContS) = Mid(lsDescFF, 1, 40) & ImpreFormat(liNumCredFF, 10, 0, True) & _
                                                                             ImpreFormat(lnTMontoAprFF, 15, , True) & ImpreFormat(lnTSaldoCapFF, 15, , True) & _
                                                                             ImpreFormat(lnTIntDevFF, 15, , True) & ImpreFormat(lnTDeudaFF, 15, , True) & _
                                                                             ImpreFormat(lnTCapVencidoFF, 15, , True) & ImpreFormat(lnTCapxVencerFF, 15, , True) & _
                                                                             ImpreFormat(lnTGar1FF, 15, , True) & ImpreFormat(lnTGar2FF, 15, , True)
                                                                          Else
                                                                             liContD = liContD + 1
                                                                             ReDim Preserve lsCadenaD(liContD)

                                                                             lsCadenaD(liContD) = Mid(lsDescFF, 1, 40) & ImpreFormat(liNumCredFF, 10, 0, True) & _
                                                                             ImpreFormat(lnTMontoAprFF, 15, , True) & ImpreFormat(lnTSaldoCapFF, 15, , True) & _
                                                                             ImpreFormat(lnTIntDevFF, 15, , True) & ImpreFormat(lnTDeudaFF, 15, , True) & _
                                                                             ImpreFormat(lnTCapVencidoFF, 15, , True) & ImpreFormat(lnTCapxVencerFF, 15, , True) & _
                                                                             ImpreFormat(lnTGar1FF, 15, , True) & ImpreFormat(lnTGar2FF, 15, , True)
                                                                          End If
                                                                        '************* FIN CADENA IMPRESION RESUMEN POR PLAZO**************

                                                                     End If '---liDatos - Créditos
                                                                     Reg9.Close
                                                                     Set Reg9 = Nothing
                                                                     lbSiCambio = True
                                                                     RegFF.MoveNext '--- Fuente de Financiamiento
                                                           Loop '--- Fuente de Financiamiento
                                                        End If '--- Fuente de Financiamiento

                                                        '***************** SUMAR TOTALES POR PRODUCTO ****************
                                                        liNumCredPr = liNumCredPr + liNumCredP
                                                        lnTMontoAprPr = lnTMontoAprPr + lnTMontoAprP
                                                        lnTSaldoCapPr = lnTSaldoCapPr + lnTSaldoCapP
                                                        lnTIntDevPr = lnTIntDevPr + lnTIntDevP
                                                        lnTDeudaPr = lnTDeudaPr + lnTDeudaP
                                                        lnTCapVencidoPr = lnTCapVencidoPr + lnTCapVencidoP
                                                        lnTCapxVencerPr = lnTCapxVencerPr + lnTCapxVencerP
                                                        lnTGar1Pr = lnTGar1Pr + lnTGar1P
                                                        lnTGar2Pr = lnTGar2Pr + lnTGar2P
                                                        '**********************************************************
                                                        '**************** IMPRIMIR SUB TOTAL PLAZO ****************
                                                        lsRtfImp = lsRtfImp & String(250, "-") & Chr(10)
                                                        lsRtfImp = lsRtfImp & "****** TOTALES PLAZO          CASOS  : " & ImpreFormat(liNumCredP, 8, 0, True) & Space(40)
                                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoAprP, 12, , True) & ImpreFormat(lnTSaldoCapP, 12, , True) & Space(43)
                                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevP, 12, , True) & ImpreFormat(lnTDeudaP, 12, , True)
                                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVencidoP, 10, , True) & ImpreFormat(lnTCapxVencerP, 10, , True)
                                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTGar1P, 10, , True) & ImpreFormat(lnTGar2P, 10, , True) & Chr(10)
                                                        lsRtfImp = lsRtfImp & String(250, "-") & Chr(10)
                                                        liLineas = liLineas + 3
                                                        '***********************************************************
                                                        '*************CADENA IMPRESION RESUMEN POR PLAZO**************
                                                       If Trim(reg1!nConsValor) = "1" Then
                                                            liContS = liContS + 1
                                                            ReDim Preserve lsCadenaS(liContS)

                                                            lsCadenaS(liContS) = String(195, "-") & Chr(10) & Mid(lsDescP, 1, 40) & ImpreFormat(liNumCredP, 10, 0, True) & _
                                                            ImpreFormat(lnTMontoAprP, 15, , True) & ImpreFormat(lnTSaldoCapP, 15, , True) & _
                                                            ImpreFormat(lnTIntDevP, 15, , True) & ImpreFormat(lnTDeudaP, 15, , True) & _
                                                            ImpreFormat(lnTCapVencidoP, 15, , True) & ImpreFormat(lnTCapxVencerP, 15, , True) & _
                                                            ImpreFormat(lnTGar1P, 15, , True) & ImpreFormat(lnTGar2P, 15, , True) & Chr(10)
                                                        Else
                                                            liContD = liContD + 1
                                                            ReDim Preserve lsCadenaD(liContD)

                                                            lsCadenaD(liContD) = String(195, "-") & Chr(10) & Mid(lsDescP, 1, 40) & ImpreFormat(liNumCredP, 10, 0, True) & _
                                                            ImpreFormat(lnTMontoAprP, 15, , True) & ImpreFormat(lnTSaldoCapP, 15, , True) & _
                                                            ImpreFormat(lnTIntDevP, 15, , True) & ImpreFormat(lnTDeudaP, 15, , True) & _
                                                            ImpreFormat(lnTCapVencidoP, 15, , True) & ImpreFormat(lnTCapxVencerP, 15, , True) & _
                                                            ImpreFormat(lnTGar1P, 15, , True) & ImpreFormat(lnTGar2P, 15, , True) & Chr(10)
                                                        End If

                                                    End If ' DATOS A REPORTAR
                                                    lbSiCambio = True
                                                    Reg2.MoveNext
                                                Loop
                                            End If ' TIPO DE PLAZO
                                            If liLineas >= 58 Then 'Para el control de salto de página
                                               lsRtfImp = lsRtfImp & Chr(12)
                                               cpag = cpag + 1
                                               lsRtfImp = lsRtfImp & fgCredPersVigentesCab(lsFecFinMes, pnDiasAtrasoIni, pnDiasAtrasoFin, psDesCadena, cpag, psAgencia)
                                               liLineas = 4
                                            End If
                                            '***************** SUMAR TOTALES POR MONEDA ****************
                                            liNumCredM = liNumCredM + liNumCredPr
                                            lnTMontoAprM = lnTMontoAprM + lnTMontoAprPr
                                            lnTSaldoCapM = lnTSaldoCapM + lnTSaldoCapPr
                                            lnTIntDevM = lnTIntDevM + lnTIntDevPr
                                            lnTDeudaM = lnTDeudaM + lnTDeudaPr
                                            lnTCapVencidoM = lnTCapVencidoM + lnTCapVencidoPr
                                            lnTCapxVencerM = lnTCapxVencerM + lnTCapxVencerPr
                                            lnTGar1M = lnTGar1M + lnTGar1Pr
                                            lnTGar2M = lnTGar2M + lnTGar2Pr
                                            If Trim(reg1!nConsValor) = "1" Then
                                                liNumCredMS = liNumCredM
                                                lnTMontoAprMS = lnTMontoAprM
                                                lnTSaldoCapMS = lnTSaldoCapM
                                                lnTIntDevMS = lnTIntDevM
                                                lnTDeudaMS = lnTDeudaM
                                                lnTCapVencidoMS = lnTCapVencidoM
                                                lnTCapxVencerMS = lnTCapxVencerM
                                                lnTGar1MS = lnTGar1M
                                                lnTGar2MS = lnTGar2M
                                            Else
                                                liNumCredMD = liNumCredM
                                                lnTMontoAprMD = lnTMontoAprM
                                                lnTSaldoCapMD = lnTSaldoCapM
                                                lnTIntDevMD = lnTIntDevM
                                                lnTDeudaMD = lnTDeudaM
                                                lnTCapVencidoMD = lnTCapVencidoM
                                                lnTCapxVencerMD = lnTCapxVencerM
                                                lnTGar1MD = lnTGar1M
                                                lnTGar2MD = lnTGar2M
                                            End If

                                            '**********************************************************
                                            '**************** IMPRIMIR SUB TOTAL PRODUCTO ****************
                                            lsRtfImp = lsRtfImp & String(250, "-") & Chr(10)
                                            lsRtfImp = lsRtfImp & "****** TOTALES PRODUCTO       CASOS  : " & ImpreFormat(liNumCredPr, 8, 0, True) & Space(40)
                                            lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoAprPr, 12, , True) & ImpreFormat(lnTSaldoCapPr, 12, , True) & Space(43)
                                            lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevPr, 12, , True) & ImpreFormat(lnTDeudaPr, 12, , True)
                                            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVencidoPr, 10, , True) & ImpreFormat(lnTCapxVencerPr, 10, , True)
                                            lsRtfImp = lsRtfImp & ImpreFormat(lnTGar1Pr, 10, , True) & ImpreFormat(lnTGar2Pr, 10, , True) & Chr(10)
                                            lsRtfImp = lsRtfImp & String(250, "-") & Chr(10)
                                            liLineas = liLineas + 3
                                            '***********************************************************
                                            '*************CADENA IMPRESION RESUMEN POR PRODUCTO**************
                                            If Trim(reg1!nConsValor) = "1" Then
                                                liContS = liContS + 1
                                                ReDim Preserve lsCadenaS(liContS)

                                                lsCadenaS(liContS) = String(195, "-") & Chr(10) & lsDescLC & Space(4) & ImpreFormat(liNumCredPr, 10, 0, True) & _
                                                ImpreFormat(lnTMontoAprPr, 15, , True) & ImpreFormat(lnTSaldoCapPr, 15, , True) & _
                                                ImpreFormat(lnTIntDevPr, 15, , True) & ImpreFormat(lnTDeudaPr, 15, , True) & _
                                                ImpreFormat(lnTCapVencidoPr, 15, , True) & ImpreFormat(lnTCapxVencerPr, 15, , True) & _
                                                ImpreFormat(lnTGar1Pr, 15, , True) & ImpreFormat(lnTGar2Pr, 15, , True) & Chr(10) & _
                                                String(195, "-") & Chr(10)
                                            Else
                                                liContD = liContD + 1
                                                ReDim Preserve lsCadenaD(liContD)

                                                lsCadenaD(liContD) = String(195, "-") & Chr(10) & lsDescLC & Space(4) & ImpreFormat(liNumCredPr, 10, 0, True) & _
                                                ImpreFormat(lnTMontoAprPr, 15, , True) & ImpreFormat(lnTSaldoCapPr, 15, , True) & _
                                                ImpreFormat(lnTIntDevPr, 15, , True) & ImpreFormat(lnTDeudaPr, 15, , True) & _
                                                ImpreFormat(lnTCapVencidoPr, 15, , True) & ImpreFormat(lnTCapxVencerPr, 15, , True) & _
                                                ImpreFormat(lnTGar1Pr, 15, , True) & ImpreFormat(lnTGar2Pr, 15, , True) & Chr(10) & _
                                                String(180, "-") & Chr(10)
                                            End If
                                            End If ' LIDATOS PRODUCTO
                                            lbSiCambio = True
                                        Reg5.MoveNext
                                     Loop
                                 End If ' SUB TIPO DE CREDITO
                            End If ' LIDATOS SUB TIPO DE CREDITO
                            Reg4.MoveNext ' TIPO DE CREDITO
                        Loop
                    End If ' TIPO DE CREDITO
                    '******************* IMPRIMIR SUB TOTAL MONEDA **********************
                    lsRtfImp = lsRtfImp & String(250, "-") & Chr(10)
                    lsRtfImp = lsRtfImp & "***** TOTALES MONEDA          CASOS  : " & ImpreFormat(liNumCredM, 8, 0, True) & Space(40)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoAprM, 12, , True) & ImpreFormat(lnTSaldoCapM, 12, , True) & Space(43)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevM, 12, , True) & ImpreFormat(lnTDeudaM, 12, , True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVencidoM, 10, , True) & ImpreFormat(lnTCapxVencerM, 10, , True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTGar1M, 10, , True) & ImpreFormat(lnTGar2M, 10, , True) & Chr(10)
                    lsRtfImp = lsRtfImp & String(250, "-") & Chr(10)
                    liLineas = liLineas + 3
                    '********************************************************************
                End If ' LIDATOS MONEDA
                lbSiCambio = True
                If Not reg1.EOF Then
                    lsRtfImp = lsRtfImp & Chr(12)
                    cpag = cpag + 1
                    liLineas = 0
                End If
            RaiseEvent Progress(reg1.Bookmark, reg1.RecordCount)
            reg1.MoveNext
        Loop

        If liContS > 0 Then
            lsRtfImp = lsRtfImp & "DETALLE POR LINEA DE CREDITO - NUEVOS SOLES - " & NombreAgencia(psAgencia) & Chr(10)
            lsRtfImp = lsRtfImp & String(40, "-") & Chr(10)
            liLineas = 3
            lsRtfImp = lsRtfImp & String(195, "-") & Chr(10)
            lsRtfImp = lsRtfImp & Space(45) & "CASOS" & Space(7) & "M. APROBADO" & Space(7) & "S. CAPITAL" & Space(8) & "INT. DEVENG." & Space(7) & "DEUDA TOT." & Space(7) & "CAP. VENC." & Space(7) & "CAP. X VENC." & Space(9) & "GAR. HIP." & Space(7) & "OTRAS GAR." & Chr(10)
            lsRtfImp = lsRtfImp & String(195, "-") & Chr(10)
            liLineas = liLineas + 3
        End If
        For i = 1 To liContS
            lsRtfImp = lsRtfImp & lsCadenaS(i) & Chr(10)
            liLineas = liLineas + 1
            If liLineas >= 62 Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                lsRtfImp = lsRtfImp & fgCredPersVigentesCab(lsFecFinMes, pnDiasAtrasoIni, pnDiasAtrasoFin, psDesCadena, cpag, psAgencia)
                liLineas = 4
            End If
        Next i

        '========================= Impresión de SubTotal ================================
        If liContS > 0 Then
            lsRtfImp = lsRtfImp & String(195, "-") & Chr(10)
            lsRtfImp = lsRtfImp & "***** TOTALES MONEDA          CASOS  : " & ImpreFormat(liNumCredMS, 10, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoAprMS, 15, , True) & ImpreFormat(lnTSaldoCapMS, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevMS, 15, , True) & ImpreFormat(lnTDeudaMS, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVencidoMS, 15, , True) & ImpreFormat(lnTCapxVencerMS, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTGar1MS, 15, , True) & ImpreFormat(lnTGar2MS, 15, , True) & Chr(10)
            lsRtfImp = lsRtfImp & String(195, "-") & Chr(10)
            liLineas = liLineas + 3
        End If

        If liContD > 0 Then
            lsRtfImp = lsRtfImp & Chr(10) & Chr(10)
            lsRtfImp = lsRtfImp & "DETALLE POR LINEA DE CREDITO - DOLARES USD " & NombreAgencia(psAgencia) & Chr(10)
            lsRtfImp = lsRtfImp & String(40, "-") & Chr(10)
            liLineas = 4
            lsRtfImp = lsRtfImp & String(195, "-") & Chr(10)
            lsRtfImp = lsRtfImp & Space(45) & "CASOS" & Space(7) & "M. APROBADO" & Space(7) & "S. CAPITAL" & Space(8) & "INT. DEVENG." & Space(7) & "DEUDA TOT." & Space(7) & "CAP. VENC." & Space(7) & "CAP. X VENC." & Space(9) & "GAR. HIP." & Space(7) & "OTRAS GAR." & Chr(10)
            lsRtfImp = lsRtfImp & String(195, "-") & Chr(10)
            liLineas = liLineas + 3
        End If
        For i = 1 To liContD
            lsRtfImp = lsRtfImp & lsCadenaD(i) & Chr(10)
            liLineas = liLineas + 1
            If liLineas >= 62 Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                lsRtfImp = lsRtfImp & fgCredPersVigentesCab(lsFecFinMes, pnDiasAtrasoIni, pnDiasAtrasoFin, psDesCadena, cpag, psAgencia)
                liLineas = 4
            End If
        Next i
        If liContD > 0 Then
            lsRtfImp = lsRtfImp & String(195, "-") & Chr(10)
            lsRtfImp = lsRtfImp & "***** TOTALES MONEDA          CASOS  : " & ImpreFormat(liNumCredMD, 10, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoAprMD, 15, , True) & ImpreFormat(lnTSaldoCapMD, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevMD, 15, , True) & ImpreFormat(lnTDeudaMD, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVencidoMD, 15, , True) & ImpreFormat(lnTCapxVencerMD, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTGar1MD, 15, , True) & ImpreFormat(lnTGar2MD, 15, , True) & Chr(10)
            lsRtfImp = lsRtfImp & String(195, "-") & Chr(10)
            liLineas = liLineas + 3
        End If
        lsRtfImpAux = lsRtfImpAux & lsRtfImp
        reg1.Close
        Set reg1 = Nothing
        Reg2.Close
        Set Reg2 = Nothing
        Reg4.Close
        Set Reg4 = Nothing

    End If ' --- MONEDA
    RaiseEvent CloseProgress
Else
    nRepo108722_fgImpCredPersVigentesGarant = ""
End If

lsRtfImpG = lsRtfImpAux
nRepo108722_fgImpCredPersVigentesGarant = lsRtfImpG
End Function

Public Function nRepo108723_fgImprimeCredPigIntDev(ByVal psServConsol As String, ByVal pnDiasIni As Integer, ByVal pnDiasFin As Integer, _
        ByVal psAgencia As String) As String
        
Dim vAtraso As Double, vDiaAct As Double, vDiaPro As Double
Dim vIntDev As Currency, vIntAct As Currency, vIntPro As Currency
Dim vIntAde As Currency
Dim vFecVen As String
Dim vNombre As String * 35
Dim vIndice As Double  'contador de Item
Dim lnLineas As Double
Dim lnPage As Long
Dim vTotSald As Currency, vTotVaTa As Currency
Dim vTotIntDev As Currency
Dim vTotDAtra As Currency, vTotDAct As Currency, vTotDPro As Currency
Dim vTotIAct As Currency, vTotIPro As Currency
Dim vTotOrNe As Currency
Dim vCabecera As String
Dim vCont As Double
Dim lrReg As New ADODB.Recordset
Dim lsSQL As String
Dim lbArchivo As Boolean
Dim lsImpLinea As String
Dim lsRtfImp As String
Dim lsRtfImpAux As String
Dim lsRtfImpG As String
Dim dFecData As Date

dFecData = GetFechaCierreMes

Dim lsPignoraticio As String
'lsPignoraticio = " 2802,2803,2804,2807 "
lsPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07

Dim nTasaIntVenc As Double

' nTasaIntVenc = ReadParametros("10105")
nRepo108723_fgImprimeCredPigIntDev = ""
  '****** BRGO - BASILEA II
    lsSQL = "SELECT cp.cCtaCod, cp.dFecApr  dFecPres, cp.nPlazoApr nplazo, cp.nMontoApr nPrestamo, " & _
        " cp.nSaldoCap nSaldoCap, nDiasAtraso, nIntDev, " & _
        " cp.nValTasac nValTasac, 0 nOroNeto, CP.dFecvenc, cp.nTasaInt, " & _
        " cNomCli = (Select Max(P.cPersNombre) from Persona P " & _
        "           Inner Join " & psServConsol & "ProductoPersonaConsol PC on p.cPersCod = PC.cPersCod " & _
        "           And PC.cCtaCod = CP.cCtaCod  and PC.nPrdPersRelac = 20 ), " & _
        " nTasaIntVenc = (SELECT ISNULL(nTasaIni, 0) From ColocLineaCreditoTasa LCT " & _
        "                 WHERE LCT.cLineaCred = CP.cLineaCred and LCT.nColocLinCredTasaTpo = " & gColocLineaCredTasasIntMoratNormal & " )  " & _
        " FROM " & psServConsol & "CreditoConsol CP " & _
        " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT " & _
        "  " & _
        " WHERE cp.nPrdEstado IN (" & lsPignoraticio & ") AND CCT.cAgeCodAct = '" & psAgencia & "' And  " & _
        " cp.nDiasAtraso >= " & pnDiasIni & " And  cp.nDiasAtraso <=  " & pnDiasFin & _
        " Order by cp.cCtaCod "
  '*************************
  
    Set lrReg = GetQuery(lsSQL)
    If lrReg.BOF And lrReg.EOF Then
        lrReg.Close
        Set lrReg = Nothing
        MsgBox " No existen Contratos en la Agencia" & NombreAgencia(psAgencia), vbInformation, " ! Aviso ! "
        nRepo108723_fgImprimeCredPigIntDev = ""
        Exit Function
    End If
    RaiseEvent ShowProgress
    lnPage = 1: vCont = 0
    lsRtfImp = lsRtfImp & ImpCredPigCab(pnDiasIni, pnDiasFin, psAgencia, lnPage)
        
    vTotVaTa = 0: vTotOrNe = 0
    vIndice = 1
    lnLineas = 7
    With lrReg
        Do While Not .EOF
            vIntDev = 0:    vIntAct = 0:    vIntPro = 0:    vIntAde = 0
            vAtraso = 0:    vDiaAct = 0:    vDiaPro = 0
            vFecVen = Format(!dFecVenc, "dd/mm/yyyy")
            vNombre = PstaNombre(!cNomCli, False)
            
            'If DateDiff("d", vFecVen, dFecData) > 0 Then
            If !nDiasAtraso > 0 Then
                'vIntDev = ((1 + nTasaIntVenc) ^ (DateDiff("d", vFecVen, dFecData) / 30) - 1) * !nSaldoCap
                vIntDev = ((1 + nTasaIntVenc) ^ (!nDiasAtraso / 30) - 1) * !nSaldoCap
                vIntDev = Round(vIntDev, 2)
            End If
            'vAtraso = IIf(DateDiff("d", vFecVen, dFecData) > 0, DateDiff("d", vFecVen, dFecData), 0)
            vAtraso = IIf(!nDiasAtraso > 0, !nDiasAtraso, 0)
            If vAtraso = 0 Then
                vDiaPro = IIf(DateDiff("d", dFecData, vFecVen) > 0, DateDiff("d", dFecData, vFecVen), 0)
                vDiaAct = !nPlazo - vDiaPro
                vIntAde = CalculaInteresAdelantado(!nSaldoCap, !nTasaInt, !nPlazo)
                vIntAde = Round(vIntAde, 2)
                vIntAct = !nSaldoCap * ((((vIntAde / !nSaldoCap + 1) ^ (1 / !nPlazo)) ^ vDiaAct) - 1)
                vIntAct = Round(vIntAct, 2)
                vIntPro = (!nSaldoCap + vIntAct) * ((((vIntAde / !nSaldoCap + 1) ^ (1 / !nPlazo)) ^ vDiaPro) - 1)
                vIntPro = Round(vIntPro, 2)
            End If
            
            lsRtfImp = lsRtfImp & ImpreFormat(vIndice, 8, 0) & Space(1) & !cCtaCod & Space(1) & _
                Format(!dFecPres, "dd/mm/yyyy") & ImpreFormat(vNombre, 21, 1) & _
                ImpreFormat(!nSaldoCap, 10) & ImpreFormat(!nValTasac, 10) & _
                ImpreFormat(!nPlazo, 3, 0) & _
                ImpreFormat(vIntDev, 6) & ImpreFormat(vAtraso, 5, 0) & _
                ImpreFormat(vIntAct, 9) & ImpreFormat(vIntPro, 9) & _
                ImpreFormat(vIntAct + vIntPro, 9) & ImpreFormat(!nSaldoCap + vIntDev, 10) & _
                Chr(10)
            If vIndice Mod 300 = 0 Then
                lsRtfImpAux = lsRtfImpAux & lsRtfImp
                lsRtfImp = ""
            End If
                
            vIndice = vIndice + 1
            lnLineas = lnLineas + 1
            vTotSald = vTotSald + !nSaldoCap
            vTotVaTa = vTotVaTa + !nValTasac
            vTotIntDev = vTotIntDev + vIntDev
            vTotDAtra = vTotDAtra + vAtraso
            vTotDAct = vTotDAct + vDiaAct
            vTotDPro = vTotDPro + vDiaPro
            vTotIAct = vTotIAct + vIntAct
            vTotIPro = vTotIPro + vIntPro
            vTotOrNe = vTotOrNe + !noroneto
            If lnLineas > 60 Then
                lnPage = lnPage + 1
                lsRtfImp = lsRtfImp & Chr(12)
                lsRtfImp = lsRtfImp & ImpCredPigCab(pnDiasIni, pnDiasFin, psAgencia, lnPage)
                lnLineas = 7
            End If
            vCont = vCont + 1
            RaiseEvent Progress(.Bookmark, .RecordCount)
            .MoveNext
        Loop
            
        lsRtfImp = lsRtfImp & Chr(10)
        lsRtfImp = lsRtfImp & String(130, "-") & Chr(10)
        lsRtfImp = lsRtfImp & ImpreFormat("TOTAL", 6, 14) & ImpreFormat((vIndice - 1), 8, 0) & _
                ImpreFormat(vTotSald, 31) & ImpreFormat(vTotVaTa, 10) & _
                ImpreFormat(vTotIntDev, 9) & _
                ImpreFormat(vTotIAct, 14) & ImpreFormat(vTotIPro, 9) & _
                ImpreFormat(vTotIAct + vTotIPro, 9) & ImpreFormat(vTotSald + vTotIntDev, 10) & _
                Chr(12)
        lsRtfImpAux = lsRtfImpAux & lsRtfImp
    End With
    lrReg.Close
    Set lrReg = Nothing
    lsRtfImpG = lsRtfImpAux
    nRepo108723_fgImprimeCredPigIntDev = lsRtfImpG
    RaiseEvent CloseProgress
End Function

Public Function nRepo108724_fgImpCredRefinan(ByVal psServConsol As String, ByVal pnTipCambio As Double, ByVal psCadena As String, ByVal psDesCadena As String, _
                      ByVal psAgencia As String, ByVal FecSis As Date) As String
Dim sql As String
Dim reg1 As New ADODB.Recordset
Dim Reg2 As New ADODB.Recordset
Dim Reg3 As New ADODB.Recordset
Dim Reg4 As New ADODB.Recordset
Dim Reg5 As New ADODB.Recordset
Dim Reg6 As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String * 35
Dim lsDescP As String * 35
Dim lsDescF As String * 35
Dim liLineas As Integer
Dim liDatos  As Integer
Dim ContD As Integer
Dim Cliente As String * 34
Dim lsFecha As String * 10
Dim lnDeuda As Double
Dim lnIntDeveng As Double
Dim lnIntCapit As Double
Dim lnIntPendRevers As Double
Dim liTCredM As Integer
Dim lnTMontoGar1M As Double
Dim lnTMontoGar2M As Double
Dim lnTSaldoCapM As Double
Dim lnTDesembCapM As Double
Dim lnTIntDevengM As Double
Dim lnTIntCapitM As Double
Dim lnTDeudaM As Double
Dim lnTIntPendReversM  As Double
Dim lnMontoAntM As Double
Dim liTCredP As Integer
Dim lnTMontoGar1P As Double
Dim lnTMontoGar2P As Double
Dim lnTDesembCapP As Double
Dim lnTSaldoCapP As Double
Dim lnTMoraP As Double
Dim lnTIntDevengP As Double
Dim lnTIntCapitP As Double
Dim lnTDeudaP As Double
Dim lnTIntPendReversP As Double
Dim lnMontoAntP As Double
Dim liTCredPr As Integer
Dim lnTMontoGar1Pr As Double
Dim lnTMontoGar2Pr As Double
Dim lnTDesembCapPr As Double
Dim lnTSaldoCapPr As Double
Dim lnTIntDevengPr As Double
Dim lnTIntCapitPr As Double
Dim lnTDeudaPr As Double
Dim lnTIntPendReversPr As Double
Dim lnMontoAntPr As Double
Dim liTCredF As Integer
Dim lnTMontoGar1F As Double
Dim lnTMontoGar2F As Double
Dim lnTDesembCapF As Double
Dim lnTSaldoCapF As Double
Dim lnTIntDevengF As Double
Dim lnTIntCapitF As Double
Dim lnTDeudaF As Double
Dim lnTIntPendReversF As Double
Dim lnMontoAntF As Double
Dim lbSiCambio As Boolean
Dim sqlGar1 As String
Dim RegGar As New ADODB.Recordset
Dim MatTotGar() As Currency
Dim lnMontoGar1 As Currency
Dim lnMontoGar2 As Currency
Dim lnIntComp As Double
Dim lnCapital As Double
Dim liCuotas  As Integer
Dim liDias As Integer
Dim cadena As String
Dim Cadena1 As String
Dim liContS As Integer
Dim liContD As Integer
Dim lsCadenaS() As String
Dim lsCadenaD() As String
Dim lnTMontoAntMD As Double
Dim lnTMontoAprMD As Double
Dim lnTSaldoCapMD As Double
Dim lnTIntDevMD As Double
Dim lnTIntCapitMD As Double
Dim lnTDeudaMD As Double
Dim lnTIntPendReversMD As Double
Dim lnTGar1MD As Double
Dim lnTGar2MD As Double
Dim lnTMontoAntMS As Double
Dim lnTMontoAprMS As Double
Dim lnTSaldoCapMS As Double
Dim lnTIntDevMS As Double
Dim lntIntCapitMS As Double
Dim lnTDeudaMS As Double
Dim lnTIntPendReversMS As Double
Dim lnTGar1MS As Double
Dim lnTGar2MS As Double
Dim liNumCredMS As Integer
Dim liNumCredMD As Integer
Dim lnMontoAnt As Double
Dim FechaAnt As String * 12


Dim lbFinMes As Boolean
Dim lsFecFinMes As String

Dim lsRtfImp As String
Dim lsRtfImpAux As String
Dim cpag As Integer

'------------------
Dim dFecSis As Date
Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim i As Integer
Dim FechaCierre As Date
Dim lsRtfImpG As String
Dim lsRtfImpAuxG As String
FechaCierre = GetFechaCierreMes
dFecSis = FecSis
lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
'lsPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
'lsPignoraticio = " 2802,2803,2804,2807 "
lsPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
'--------------
liContS = 0
liContD = 0
ReDim lsCadenaS(liContS)
ReDim lsCadenaD(liContD)

lbSiCambio = False
lsRtfImp = ""
lsRtfImpAuxG = ""
ContD = 0
cpag = 1


lbFinMes = True
lsFecFinMes = Format(DateAdd("d", -1 * Day(dFecSis), dFecSis), "mm/dd/yyyy")

RaiseEvent ShowProgress
'===== Verificar si existen datos para el reporte
sql = "SELECT COUNT(CS.cCtaCod) AS NumCred FROM " & psServConsol & "CreditoConsol CS "
sql = sql & " INNER JOIN  " & psServConsol & "CreditoConsolTotal CCT ON CCT.cCtaCod = CS.cCtaCod "
sql = sql & " WHERE CS.nPrdEstado in (" & lsCreditosVigentes & ") and CS.cRefinan = 'R' "
sql = sql & " and CCT.cAgeCodAct = '" & psAgencia & "' " & psCadena
      
      
 Set Reg9 = GetQuery(sql)
If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then
   '======== Tipo de Moneda ========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set reg1 = loConst.RecuperaConstantes(gMoneda)

    '======== Tipo de Plazo =========
        Set Reg2 = loConst.RecuperaConstantes(gColocLineaCredPlazo)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    Set Reg5 = ObtieneLineaCredito 'Fuente Financiamiento

   '========= Tipo de Créditos  =========
    Set Reg3 = GetTipoCred
    
    nRepo108724_fgImpCredRefinan = ""
    If reg1.EOF And reg1.BOF Then
    Else
        Do While Not reg1.EOF
            '=====LIMPIAR LOS DATOS SUBTOTALES POR MONEDA ======
            liTCredM = 0:                lnTMontoGar1M = 0
            lnTMontoGar2M = 0:           lnTDesembCapM = 0
            lnTSaldoCapM = 0:            lnTIntDevengM = 0
            lnTDeudaM = 0:               lnMontoAntM = 0
            lnTIntCapitM = 0:            lnTIntPendReversM = 0
            lsDescM = Trim(reg1!cConsDescripcion)
            '================= CREDITOS VIGENTES - MONEDA =======================
            sql = "SELECT COUNT(cCtaCod) AS NumCred FROM " & psServConsol & "CreditoConsol CS " & _
                  "WHERE nPrdEstado in (" & lsCreditosVigentes & ") And CS.cRefinan = 'R' AND SUBSTRING(CS.cCtaCod,9,1 )= '" & Trim(reg1!nConsValor) & "' " _
                  & psCadena
            Set Reg9 = GetQuery(sql)
            If Reg9.EOF And Reg9.BOF Then
                liDatos = 0
            Else
                liDatos = Reg9!NumCred
            End If
            Reg9.Close
            Set Reg9 = Nothing
            
            If liDatos > 0 Then
                lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                liLineas = 5
                If lbSiCambio Then
                    lbSiCambio = False
                End If
                lsRtfImp = lsRtfImp & "MONEDA         : " & lsDescM & Chr(10)
                liLineas = liLineas + 1
                If Reg3.EOF And Reg3.BOF Then 'Tipo de Crédito
                Else
                    Reg3.MoveFirst
                    Do While Not Reg3.EOF 'Tipo de Crédito
                        '=========== CREDITOS VIGENTES PARA UN TIPO DE CREDITO ==================
                        sql = "SELECT COUNT(cCtaCod) AS NumCred FROM " & psServConsol & "CreditoConsol CS WHERE nPrdEstado in (" & lsCreditosVigentes & ") And cRefinan = 'R' " & _
                            " AND SUBSTRING(cCtaCod,9,1 )= '" & Trim(reg1!nConsValor) & "' " & _
                            " AND SUBSTRING(cLineacred,7,1) = '" & Mid(Trim(Reg3!nConsValor), 1, 1) & "' " & _
                            psCadena
                        Set Reg9 = GetQuery(sql)
                        If Reg9.EOF And Reg9.BOF Then
                            liDatos = 0
                        Else
                            liDatos = Reg9!NumCred
                        End If
                        Reg9.Close
                        Set Reg9 = Nothing
                        
                        If liDatos > 0 Then
                            '======= Sub Tipo de Crédito =========
                            Set Reg4 = GetSubTipoCred(Reg3!nConsValor)
                            If Reg4.EOF And Reg4.BOF Then
                            Else
                                Do While Not Reg4.EOF
                                    lsDescPr = Trim(Reg3!cConsDescripcion) & " - " & Trim(Reg4!cConsDescripcion)
                                    '======= LIMPIAR DATOS PARA EL PRODUCTO =============
                                    liTCredPr = 0:              lnTMontoGar1Pr = 0
                                    lnTMontoGar2Pr = 0:         lnTDesembCapPr = 0
                                    lnTSaldoCapPr = 0:          lnTIntDevengPr = 0
                                    lnTDeudaPr = 0:             lnMontoAntPr = 0
                                    lnTIntCapitPr = 0:          lnTIntPendReversPr = 0
                                    '=========== CREDITOS VIGENTES - SUB TIPO CREDITO ==============
                                    sql = "SELECT COUNT(cCtaCod) AS NumCred FROM " & psServConsol & "CreditoConsol CS WHERE CS.nPrdEstado in (" & lsCreditosVigentes & ") And cRefinan = 'R' " & _
                                        " AND SUBSTRING(cCtaCod,9,1 )= '" & Trim(reg1!nConsValor) & "' " & _
                                        " AND SUBSTRING(cLineaCred,7,1) = '" & Mid(Trim(Reg3!nConsValor), 1, 1) & "' " & _
                                        " AND SUBSTRING(cLineaCred,8,2) = '" & Mid(Trim(Reg4!nConsValor), 2, 2) & "' " & _
                                        psCadena
                                    Set Reg9 = GetQuery(sql)
                                    If Reg9.EOF And Reg9.BOF Then
                                        liDatos = 0
                                    Else
                                        liDatos = Reg9!NumCred
                                    End If
                                    Reg9.Close
                                    Set Reg9 = Nothing
                                    
                                    If liDatos > 0 Then
                                        If liLineas >= 56 Then 'Para el control de salto de página
                                           lsRtfImp = lsRtfImp & Chr(10)
                                           cpag = cpag + 1
                                           lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                                           liLineas = 5
                                        End If
                                        If lbSiCambio Then
                                            lsRtfImp = lsRtfImp & Chr(10)
                                            liLineas = liLineas + 1
                                            lbSiCambio = False
                                        End If
                                        lsRtfImp = lsRtfImp & "PRODUCTO       : " & lsDescPr & Chr(10)
                                        liLineas = liLineas + 4
                                        If Trim(reg1!nConsValor) = "1" Then
                                           liContS = liContS + 1
                                           ReDim Preserve lsCadenaS(liContS)
                                           lsCadenaS(liContS) = Chr(10) & "*****" & lsDescPr & Chr(10) & Chr(10)
                                           liContS = liContS + 1
                                           ReDim Preserve lsCadenaS(liContS)
                                           lsCadenaS(liContS) = String(185, "-") & Chr(10)
                                           liContS = liContS + 1
                                           ReDim Preserve lsCadenaS(liContS)
                                           lsCadenaS(liContS) = Space(45) & "CASOS" & Space(7) & "M. INICIAL" & Space(7) & Space(7) & "S. CAPITAL" & Space(8) & "INT. DEVENG." & Space(7) & "DEUDA TOT." & Space(9) & "GAR. HIP." & Space(7) & "OTRAS GAR." & Space(2) & "INT.CAP:" & Chr(10)
                                           liContS = liContS + 1
                                           ReDim Preserve lsCadenaS(liContS)
                                           lsCadenaS(liContS) = String(185, "-") & Chr(10) & Chr(10)
                                        Else
                                           liContD = liContD + 1
                                           ReDim Preserve lsCadenaD(liContD)
                                           lsCadenaD(liContD) = Chr(10) & "*****" & lsDescPr & Chr(10) & Chr(10)
                                           liContD = liContD + 1
                                           ReDim Preserve lsCadenaD(liContD)
                                           lsCadenaD(liContD) = String(185, "-") & Chr(10)
                                           liContD = liContD + 1
                                           ReDim Preserve lsCadenaD(liContD)
                                           lsCadenaD(liContD) = Space(45) & "CASOS" & Space(7) & "M. INICIAL" & Space(7) & "M. APROBADO" & Space(7) & "S. CAPITAL" & Space(8) & "INT. DEVENG." & Space(7) & "DEUDA TOT." & Space(9) & "GAR. HIP." & Space(7) & "OTRAS GAR." & Chr(10)
                                           liContD = liContD + 1
                                           ReDim Preserve lsCadenaD(liContD)
                                           lsCadenaD(liContD) = String(185, "-") & Chr(10) & Chr(10)
                                        End If
                                        liLineas = liLineas + 1
                                        
                                        If Reg2.EOF And Reg2.BOF Then
                                        Else
                                            Reg2.MoveFirst
                                            Do While Not Reg2.EOF
                                                lsDescP = Trim(Reg2!cConsDescripcion)
                                                '============ LIMPIAR DATOS PARA EL PLAZO =============
                                                liTCredP = 0:                    lnTMontoGar1P = 0
                                                lnTMontoGar2P = 0:               lnTDesembCapP = 0
                                                lnTSaldoCapP = 0:                lnTIntDevengP = 0
                                                lnTDeudaP = 0:                   lnMontoAntP = 0
                                                lnTIntCapitP = 0:                lnTIntPendReversP = 0
                                                '================= CREDITOS VIGENTES  - PLAZO ==================
                                                sql = "SELECT COUNT(cCtaCod) AS NumCred FROM   " & psServConsol & "CreditoConsol CS WHERE CS.nPrdEstado in (" & lsCreditosVigentes & ") And cRefinan = 'R' " & _
                                                    " AND SUBSTRING(cCtaCod,9,1 )= '" & Trim(reg1!nConsValor) & "' " & _
                                                    " AND SUBSTRING(cLineaCred,7,1) = '" & Trim(Mid(Reg3!nConsValor, 1, 1)) & "' " & _
                                                    " AND SUBSTRING(cLineaCred,8,2) = '" & Trim(Mid(Reg4!nConsValor, 2, 2)) & "' " & _
                                                    " AND SUBSTRING(cLineaCred,6,1) = '" & Trim(Reg2!nConsValor) & "' " & _
                                                    psCadena
                                                Set Reg9 = GetQuery(sql)
                                                If Reg9.EOF And Reg9.BOF Then
                                                    liDatos = 0
                                                Else
                                                    
                                                    liDatos = Reg9!NumCred
                                                End If
                                                Reg9.Close
                                                Set Reg9 = Nothing
                                                
                                                If liDatos > 0 Then
                                                    If liLineas >= 58 Then 'Para el control de salto de página
                                                       lsRtfImp = lsRtfImp & Chr(10)
                                                       cpag = cpag + 1
                                                       lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                                                       liLineas = 5
                                                    End If
                                                    If lbSiCambio Then
                                                        lsRtfImp = lsRtfImp & Chr(10)
                                                        liLineas = liLineas + 1
                                                        lbSiCambio = False
                                                    End If
                                                    lsRtfImp = lsRtfImp & "PLAZO          : " & lsDescP & Chr(10)
                                                    liLineas = liLineas + 1
                                                    
                                                    If Reg5.EOF And Reg5.BOF Then
                                                    Else
                                                        Reg5.MoveFirst
                                                        Do While Not Reg5.EOF
                                                            lsDescF = Trim(Reg5!CDescripcion)
                                                            '============ LIMPIAR DATOS PARA EL FUENTE DE FINANCIAMIENTO =============
                                                            liTCredF = 0:        lnTMontoGar1F = 0
                                                            lnTMontoGar2F = 0:   lnTDesembCapF = 0
                                                            lnTSaldoCapF = 0:    lnTIntDevengF = 0
                                                            lnTDeudaF = 0:       lnMontoAntF = 0
                                                            lnTIntCapitF = 0:    lnTIntPendReversF = 0
                                                            '=============== DATOS PARA EL REPORTE  ===============
                                                            sql = "SELECT Credito.cCtaCod, Credito.nTasaInt, Credito.cCodAnalista, CS.nDiasAtraso, " & _
                                                                 " Credito.dFEcVIg dFecUltDesemb, CS.nSaldoCap, Credito.nIntApr, Credito.nPlazoApr, " & _
                                                                 " Credito.nMontoApr, Persona.cPersNombre, Credito.dFecVig,  Credito.nTipCuota, Credito.nTipoDesemb, Isnull(nMontoIntCap,0) nMontoIntCap ," & _
                                                                 " IsNull(CS.nIntDev,0) as nIntDev, IsNull(CS.nGastoPend,0) as nGastoPend, IsNull(CS.nMoraCalc,0) as nMoraCalc, " & _
                                                                 " Credito.nHipoSoles, Credito.nHipoDol, Credito.nGarantSoles, Credito.nGarantDol " & _
                                                                 " FROM " & psServConsol & "CreditoSaldoConsol CS INNER JOIN " & psServConsol & "CREDITOConsol Credito ON CS.cCtaCod = Credito.cCtaCod " & _
                                                                 " INNER JOIN " & psServConsol & "CreditoConsolTotal CCT ON Credito.cCtaCod = CCT.cCtaCod  " & _
                                                                 " INNER JOIN " & psServConsol & "ProductoPersonaConsol PersCredito ON CREDITO.cCtaCod = PERSCREDITO.cCtaCod " & _
                                                                 " INNER JOIN PERSONA PERSONA ON PERSCREDITO.cPersCod = PERSONA.cPersCod " & _
                                                                 " LEFT JOIN " & psServConsol & "REFINANCConsol Refinanc ON REFINANC.cCtaCod = CREDITO.cCtaCod " & _
                                                                 " WHERE datediff(d,CS.dFecha,'" & lsFecFinMes & "')= 0 And CS.nPrdEstado in ( " & lsCreditosVigentes & ")" & _
                                                                 " AND Credito.cRefinan = 'R' And PERSCREDITO.nPrdPersRelac = 20 And CCT.cAgeCodAct ='" & psAgencia & "' " & _
                                                                 " AND SUBSTRING(CS.cLineaCred,5,1 )= '" & Trim(reg1!nConsValor) & "' " & _
                                                                 " AND SUBSTRING(CS.cLineaCred,7,1) = '" & Mid(Trim(Reg3!nConsValor), 1, 1) & "' " & _
                                                                 " AND SUBSTRING(CS.cLineaCred,8,2) = '" & Mid(Trim(Reg4!nConsValor), 2, 2) & "' " & _
                                                                 " AND SUBSTRING(CS.cLineaCred,6,1) = '" & Trim(Reg2!nConsValor) & "' " & _
                                                                 " AND SUBSTRING(CS.cLineaCred, 1,4) = '" & Trim(Reg5!cLineaCred) & "' " & _
                                                                 psCadena
                                                            

                                                            Set Reg6 = GetQuery(sql)
                                                            If Reg6.EOF And Reg6.BOF Then
                                                            Else
                                                                If liLineas >= 58 Then 'Para el control de salto de página
                                                                   lsRtfImp = lsRtfImp & Chr(10)
                                                                   cpag = cpag + 1
                                                                   lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                                                                   liLineas = 5
                                                                End If
                                                                If lbSiCambio Then
                                                                    lsRtfImp = lsRtfImp & Chr(10)
                                                                    liLineas = liLineas + 1
                                                                    lbSiCambio = False
                                                                End If
                                                                lsRtfImp = lsRtfImp & "FINANCIAMIENTO : " & lsDescF & Chr(10)
                                                                liLineas = liLineas + 2
                                                                lsRtfImp = lsRtfImp & SubCabCredRefinan
                                                                liLineas = liLineas + 3
                                                                
                                                                Do While Not Reg6.EOF
                                                                    '========= SELECCIONAR LOS DATOS DEL CREDITO ANTIGUO ============
                                                                    'sql = "SELECT nMontoApr, dFecVig FROM CREDITOConsol WHERE cCtaCod = '" & Trim(Reg6!cCodCtaAnt) & "'"
                                                                    'Reg9.Open sql, dbCmactCentral, adOpenStatic, adLockReadOnly, adCmdText
                                                                    
                                                                    'If Reg9.EOF And Reg9.BOF Then
                                                                    '    lnMontoAnt = 0
                                                                    '    FechaAnt = "00/00/0000"
                                                                    'Else
                                                                    '    lnMontoAnt = IIf(IsNull(Reg9!nMontoApr), 0, Reg9!nMontoApr)
                                                                    '    FechaAnt = Format(Reg9!dFecVig, "dd/mm/yyyy")
                                                                    'End If
                                                                    'Reg9.Close
                                                                    'Set Reg9 = Nothing
                                                                    '****
                                                                    

                                                                    'ContD = ContD + 1
                                                                    
                                                                    If liLineas >= 62 Then
                                                                        lsRtfImp = lsRtfImp & Chr(12)
                                                                        cpag = cpag + 1
                                                                        lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                                                                        lsRtfImp = lsRtfImp & SubCabCredRefinan
                                                                        liLineas = 8
                                                                    End If
                                                                    Cliente = PstaNombre(Reg6!cPersNombre, False)
                                                                    lsFecha = Format(Reg6!dFecVig, "dd/mm/yyyy")
                                                                    
                                                                    lnMontoGar1 = 0
                                                                    '=================== [ GARANTIA HIPOTECARIA SOLES ] ========================
                                                                    'lnMontoGar1 = GetGarantias(Reg6!cCtaCod, " IN ('01')", "1")
                                                                    lnMontoGar1 = Reg6!nHipoSoles
                                                                    
                                                                    lnMontoGar1 = lnMontoGar1 / pnTipCambio
                                                                    
                                                                    '================= GARANTIA HIPOTECARIA DOLARES ==========================
                                                                    'lnMontoGar1 = lnMontoGar1 + GetGarantias(Reg6!cCtaCod, " IN ('01')", "2")
                                                                    lnMontoGar1 = lnMontoGar1 + Reg6!nhipodol
                                                                    
                                                                    '======================== OTRAS GARANTIAS SOLES ==============================
                                                                    lnMontoGar2 = 0
                                                                    'lnMontoGar2 = GetGarantias(Reg6!cCtaCod, " NOT IN ('01')", "1")
                                                                    lnMontoGar2 = Reg6!nGarantSoles
                                                                    
                                                                    lnMontoGar2 = lnMontoGar2 / pnTipCambio
                                                                    
                                                                    '======================== OTRAS GARANTIAS DOLARES ===============================
                                                                    'lnMontoGar2 = lnMontoGar2 + GetGarantias(Reg6!cCtaCod, " NOT IN ('01')", "2")
                                                                    lnMontoGar2 = lnMontoGar2 + Reg6!nGarantDol
                                                                    
                                                                    'If lbFinMes Then
                                                                        lnDeuda = Reg6!nSaldoCap + Reg6!nIntDev + Reg6!nMoraCalc + Reg6!nGastoPend
                                                                        lnIntDeveng = Reg6!nIntDev
                                                                    'Else
                                                                    '    If Not IsNull(Reg6!dfecUltDesemb) Then FecUltPago = Reg6!dfecUltDesemb
                                                                    '
                                                                    '    Periodo = IIf(Reg6!nplazoapr = 0, 30, Reg6!nplazoapr)
                                                                    '    TasaInt = Format(InteresReal(Format(Reg6!nTasaInt / 100, "#0.000"), IIf(Reg6!nplazoapr = 0, 30, Reg6!nplazoapr)) * 100, "#0.00")
                                                                    '
                                                                    '    'Calculo de la Deuda
                                                                    '    If Reg6!cTipCuota = "4" Then
                                                                    '       lnDeuda = fgCalculaDeudaTotalaFechaCuotaLibre(Reg6!cCtaCod, dbCmact)
                                                                    '       lnIntDeveng = fgCalculaInteresaFechaCuotaLibre(Reg6!cCtaCod, dbCmact)
                                                                    '    Else
                                                                    '       If Reg6!cTipoDesemb = "P" Then
                                                                    '          Call CargaCuotas(Reg6!cCtaCod)
                                                                    '          lnDeuda = TotalDeudaParcial(dbCmact, Reg6!cCtaCod)
                                                                    '          lnIntDeveng = TotalInteresaFecha
                                                                    '       Else
                                                                    '          lnDeuda = fgCalculaDeudaTotalaFecha(Reg6!cCtaCod, dbCmact)
                                                                    '          lnIntDeveng = fgCalculaInteresaFecha(Reg6!cCtaCod, dbCmact) + fgCalculaInteresReprogramados(Reg6!cCtaCod, dbCmact)
                                                                    '       End If
                                                                    '    End If
                                                                    'End If
                                                                    
                                                                    '============================== CADENA DE IMPRESION ==========================
                                                                    lsRtfImp = lsRtfImp & Reg6!cCtaCod & Space(2) & Cliente
                                                                    lsRtfImp = lsRtfImp & ImpreFormat(Reg6!nMontoApr, 12, , True) & Space(2) & lsFecha & ImpreFormat(Reg6!nSaldoCap, 12, , True)
                                                                    lsRtfImp = lsRtfImp & ImpreFormat(Reg6!nDiasAtraso, 8, 0, True) & ImpreFormat(lnIntDeveng, 10, , True) & ImpreFormat(lnDeuda, 12, 2, True)
                                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnMontoGar1, 12, 2, True) & ImpreFormat(lnMontoGar2, 12, 2, True)
                                                                    lsRtfImp = lsRtfImp & Space(2) & ImpreFormat(Reg6!cCodAnalista, 4, 0, False)
                                                                    lsRtfImp = lsRtfImp & ImpreFormat(Reg6!nMontoIntCap, 10, 2, False)
                                                                    lsRtfImp = lsRtfImp & ImpreFormat((Reg6!nMontoIntCap / Reg6!nMontoApr) * Reg6!nSaldoCap, 10, 2, False) & Chr(10)
                                                                    lnIntCapit = Reg6!nMontoIntCap  ' Asigna Int Capita
                                                                    lnIntPendRevers = Format((Reg6!nMontoIntCap / Reg6!nMontoApr) * Reg6!nSaldoCap, "#0.00")
                                                                    liLineas = liLineas + 1
                                                                    If ContD >= 100 Then
                                                                        lsRtfImpAuxG = lsRtfImpAuxG & lsRtfImp
                                                                        lsRtfImp = ""
                                                                    End If
                                                                    '======= SUMAR TOTALES FUENTE DE FINANCIAMIENTO ========
                                                                    liTCredF = liTCredF + 1
                                                                    lnTMontoGar1F = lnTMontoGar1F + IIf(IsNull(lnMontoGar1), 0, lnMontoGar1)
                                                                    lnTMontoGar2F = lnTMontoGar2F + IIf(IsNull(lnMontoGar2), 0, lnMontoGar2)
                                                                    lnTDesembCapF = lnTDesembCapF + IIf(IsNull(Reg6!nMontoApr), 0, Reg6!nMontoApr)
                                                                    lnTSaldoCapF = lnTSaldoCapF + IIf(IsNull(Reg6!nSaldoCap), 0, Reg6!nSaldoCap)
                                                                    lnMontoAntF = lnMontoAntF + lnMontoAnt
                                                                    lnTIntDevengF = lnTIntDevengF + lnIntDeveng
                                                                    lnTIntCapitF = lnTIntCapitF + lnIntCapit
                                                                    lnTDeudaF = lnTDeudaF + lnDeuda
                                                                    lnTIntPendReversF = lnTIntPendReversF + lnIntPendRevers
                                                                    Reg6.MoveNext '--- Datos - Crédito
                                                                    DoEvents
                                                                Loop '--- Datos - Crédito
                                                                
                                                                ' ===== SUMAR TOTALES TIPO DE PLAZO
                                                                liTCredP = liTCredP + liTCredF
                                                                lnTMontoGar1P = lnTMontoGar1P + lnTMontoGar1F
                                                                lnTMontoGar2P = lnTMontoGar2P + lnTMontoGar2F
                                                                lnTDesembCapP = lnTDesembCapP + lnTDesembCapF
                                                                lnTSaldoCapP = lnTSaldoCapP + lnTSaldoCapF
                                                                lnMontoAntP = lnMontoAntP + lnMontoAntF
                                                                lnTIntDevengP = lnTIntDevengP + lnTIntDevengF
                                                                lnTIntCapitP = lnTIntCapitP + lnTIntCapitF
                                                                lnTDeudaP = lnTDeudaP + lnTDeudaF
                                                                lnTIntPendReversP = lnTIntPendReversP + lnTIntPendReversF
                                                                If liLineas >= 58 Then 'Para el control de salto de página
                                                                   lsRtfImp = lsRtfImp & Chr(12)
                                                                   cpag = cpag + 1
                                                                   lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                                                                   liLineas = 5
                                                                End If
                                                                ' ===== IMPRIMIR SUB TOTAL FUENTE DE FINANCIAMIENTO ========
                                                                lsRtfImp = lsRtfImp & String(185, "-") & Chr(10)
                                                                lsRtfImp = lsRtfImp & Space(3) & "TOTAL FUENTE FINANCIAMIENTO  CASOS  :  " & ImpreFormat(liTCredF, 4, 0, True) & Space(2)
                                                                lsRtfImp = lsRtfImp & ImpreFormat(lnTDesembCapF, 12, , True) & Space(12) & ImpreFormat(lnTSaldoCapF, 12, , True)
                                                                lsRtfImp = lsRtfImp & Space(8) & ImpreFormat(lnTIntDevengF, 10, , True) & ImpreFormat(lnTDeudaF, 12, 2, True)
                                                                lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoGar1F, 12, 2, True) & ImpreFormat(lnTMontoGar2F, 12, 2, True) & Space(6) & ImpreFormat(lnTIntCapitF, 10, 2, True)
                                                                lsRtfImp = lsRtfImp & ImpreFormat(lnTIntPendReversF, 10, 2, False) & Chr(10)
                                                                lsRtfImp = lsRtfImp & String(185, "-") & Chr(10)
                                                                liLineas = liLineas + 3
                                                                
                                                                '*********** CADENA IMPRESION RESUMEN POR F. FINANCIAMIENTO *************
                                                                If Trim(reg1!nConsValor) = "1" Then
                                                                    liContS = liContS + 1
                                                                    '*********** [ SUB TOTAL POR FUENTE DE FINANCIAMIENTO ] *************
                                                                    ReDim Preserve lsCadenaS(liContS)
                                                                    lsCadenaS(liContS) = lsDescF & Space(4) & ImpreFormat(liTCredF, 10, 0, True) & _
                                                                    ImpreFormat(lnTDesembCapF, 15, , True) & ImpreFormat(lnTSaldoCapF, 15, , True) & ImpreFormat(lnTIntDevengF, 15, , True) & _
                                                                    ImpreFormat(lnTDeudaF, 15, , True) & ImpreFormat(lnTMontoGar1F, 15, , True) & ImpreFormat(lnTMontoGar2F, 15, , True) & ImpreFormat(lnTIntCapitF, 12, , True) & _
                                                                    ImpreFormat(lnTIntPendReversF, 10, 2, False) & Chr(10)
                                                                Else
                                                                    liContD = liContD + 1
                                                                    '*********** [ SUB TOTAL POR FUENTE DE FINANCIAMIENTO ] *************
                                                                    ReDim Preserve lsCadenaD(liContD)
                                                                    lsCadenaD(liContD) = lsDescF & Space(4) & ImpreFormat(liTCredF, 10, 0, True) & _
                                                                    ImpreFormat(lnTDesembCapF, 15, , True) & ImpreFormat(lnTSaldoCapF, 15, , True) & ImpreFormat(lnTIntDevengF, 15, , True) & _
                                                                    ImpreFormat(lnTDeudaF, 15, , True) & ImpreFormat(lnTMontoGar1F, 15, , True) & ImpreFormat(lnTMontoGar2F, 15, , True) & ImpreFormat(lnTIntCapitF, 12, , True) & _
                                                                    ImpreFormat(lnTIntPendReversF, 10, 2, False) & Chr(10)
                                                                End If
                                                                
                                                            End If '---liDatos - Créditos
                                                            Reg6.Close
                                                            Set Reg6 = Nothing
                                                            lbSiCambio = True
                                                            Reg5.MoveNext '--- Fuente de Financiamiento
                                                        Loop '--- Fuente de Financiamiento
                                                    End If '--- Fuente de Financiamiento
                                                    
                                                    If liLineas >= 58 Then 'Para el control de salto de página
                                                       lsRtfImp = lsRtfImp & Chr(12)
                                                       cpag = cpag + 1
                                                       lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                                                       liLineas = 5
                                                    End If
                                                    '============ IMPRIMIR SUB TOTAL PLAZO =====================
                                                    lsRtfImp = lsRtfImp & String(185, "-") & Chr(10)
                                                    lsRtfImp = lsRtfImp & Space(3) & "TOTAL PLAZO                  CASOS  :  " & ImpreFormat(liTCredP, 4, 0, True) & Space(2)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTDesembCapP, 12, , True) & Space(12) & ImpreFormat(lnTSaldoCapP, 12, , True) & Space(8)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevengP, 10, , True) & ImpreFormat(lnTDeudaP, 12, 2, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoGar1P, 12, 2, True) & ImpreFormat(lnTMontoGar2P, 12, 2, True) & Space(6) & ImpreFormat(lnTIntCapitP, 10, 2, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTIntPendReversP, 10, 2, False)
                                                    lsRtfImp = lsRtfImp & Chr(10)
                                                    lsRtfImp = lsRtfImp & String(185, "-") & Chr(10)
                                                    liLineas = liLineas + 3
                                                    
                                                    '*********** CADENA IMPRESION RESUMEN POR PLAZO *************
                                                    If Trim(reg1!nConsValor) = "1" Then
                                                        liContS = liContS + 1
                                                        '*********** [ SUB TOTAL POR PLAZO ] *************
                                                        ReDim Preserve lsCadenaS(liContS)
                                                        lsDescP = "TOTAL  " & lsDescP
                                                        lsCadenaS(liContS) = String(185, "-") & Chr(10) & lsDescP & Space(4) & ImpreFormat(liTCredP, 10, 0, True) & _
                                                        ImpreFormat(lnTDesembCapP, 15, , True) & ImpreFormat(lnTSaldoCapP, 15, , True) & _
                                                        ImpreFormat(lnTIntDevengP, 15, , True) & ImpreFormat(lnTDeudaP, 15, , True) & ImpreFormat(lnTMontoGar1P, 15, , True) & _
                                                        ImpreFormat(lnTMontoGar2P, 15, , True) & ImpreFormat(lnTIntCapitP, 12, , True) & _
                                                        ImpreFormat(lnTIntPendReversP, 10, 2, False) & Chr(10) & String(185, "-") & Chr(10) & Chr(10)
                                                    Else
                                                        liContD = liContD + 1
                                                        '*********** [ SUB TOTAL POR PLAZO ] *************
                                                        ReDim Preserve lsCadenaD(liContD)
                                                        lsDescP = "TOTAL  " & lsDescP
                                                        lsCadenaD(liContD) = String(185, "-") & Chr(10) & lsDescP & Space(4) & ImpreFormat(liTCredP, 10, 0, True) & _
                                                        ImpreFormat(lnTDesembCapP, 15, , True) & ImpreFormat(lnTSaldoCapP, 15, , True) & _
                                                        ImpreFormat(lnTIntDevengP, 15, , True) & ImpreFormat(lnTDeudaP, 15, , True) & ImpreFormat(lnTMontoGar1P, 15, , True) & _
                                                        ImpreFormat(lnTMontoGar2P, 15, , True) & ImpreFormat(lnTIntCapitP, 12, , True) & _
                                                        ImpreFormat(lnTIntPendReversP, 10, 2, False) & Chr(10) & String(185, "-") & Chr(10) & Chr(10)
                                                    End If
                                                    
                                                    '============= SUMAR TOTALES PRODUCTO ======================
                                                    liTCredPr = liTCredPr + liTCredP
                                                    lnTMontoGar1Pr = lnTMontoGar1Pr + lnTMontoGar1P
                                                    lnTMontoGar2Pr = lnTMontoGar2Pr + lnTMontoGar2P
                                                    lnTDesembCapPr = lnTDesembCapPr + lnTDesembCapP
                                                    lnTSaldoCapPr = lnTSaldoCapPr + lnTSaldoCapP
                                                    lnMontoAntPr = lnMontoAntPr + lnMontoAntP
                                                    lnTIntDevengPr = lnTIntDevengPr + lnTIntDevengP
                                                    lnTIntCapitPr = lnTIntCapitPr + lnTIntCapitP
                                                    lnTDeudaPr = lnTDeudaPr + lnTDeudaP
                                                    lnTIntPendReversPr = lnTIntPendReversPr + lnTIntPendReversP
                                                    '*************************************************************
                                                End If '----liDatos - Tipo de Plazo
                                                lbSiCambio = True
                                                Reg2.MoveNext '--- Tipo de Plazo
                                            Loop '--- Tipo de Plazo
                                        End If '--- Tipo de Plazo
                                        '============= SUMAR TOTALES MONEDA ======================
                                        liTCredM = liTCredM + liTCredPr
                                        lnTMontoGar1M = lnTMontoGar1M + lnTMontoGar1Pr
                                        lnTMontoGar2M = lnTMontoGar2M + lnTMontoGar2Pr
                                        lnTDesembCapM = lnTDesembCapM + lnTDesembCapPr
                                        lnTSaldoCapM = lnTSaldoCapM + lnTSaldoCapPr
                                        lnMontoAntM = lnMontoAntM + lnMontoAntPr
                                        lnTIntDevengM = lnTIntDevengM + lnTIntDevengPr
                                        lnTIntCapitM = lnTIntCapitM + lnTIntCapitPr
                                        lnTDeudaM = lnTDeudaM + lnTDeudaPr
                                        lnTIntPendReversM = lnTIntPendReversM + lnTIntPendReversPr
                                        If liLineas >= 58 Then 'Para el control de salto de página
                                           lsRtfImp = lsRtfImp & Chr(12)
                                           cpag = cpag + 1
                                           lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                                           liLineas = 5
                                        End If
                                            If Trim(reg1!nConsValor) = "1" Then
                                                liNumCredMS = liTCredM
                                                lnTMontoAntMS = lnTMontoAntMS
                                                lnTMontoAprMS = lnTDesembCapM
                                                lnTSaldoCapMS = lnTSaldoCapM
                                                lnTIntDevMS = lnTIntDevengM
                                                lnTDeudaMS = lnTDeudaM
                                                lnTGar1MS = lnTMontoGar1M
                                                lnTGar2MS = lnTMontoGar2M
                                                lntIntCapitMS = lnTIntCapitM
                                                lnTIntPendReversMS = lnTIntPendReversM
                                            Else
                                                liNumCredMD = liTCredM
                                                lnTMontoAntMD = lnTMontoAntMD
                                                lnTMontoAprMD = lnTDesembCapM
                                                lnTSaldoCapMD = lnTSaldoCapM
                                                lnTIntDevMD = lnTIntDevengM
                                                lnTDeudaMD = lnTDeudaM
                                                lnTGar1MD = lnTMontoGar1M
                                                lnTGar2MD = lnTMontoGar2M
                                                lnTIntCapitMD = lnTIntCapitM
                                                lnTIntPendReversMD = lnTIntPendReversM
                                            End If
                                        
                                        '============ IMPRIMIR SUB TOTAL PRODUCTO =====================
                                        lsRtfImp = lsRtfImp & String(185, "-") & Chr(10)
                                        lsRtfImp = lsRtfImp & Space(3) & "TOTAL PRODUCTO               CASOS  :  " & ImpreFormat(liTCredPr, 4, 0, True) & Space(2)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTDesembCapPr, 12, , True) & Space(12) & ImpreFormat(lnTSaldoCapPr, 12, , True)
                                        lsRtfImp = lsRtfImp & Space(8) & ImpreFormat(lnTIntDevengPr, 10, , True) & ImpreFormat(lnTDeudaPr, 12, 2, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoGar1Pr, 12, 2, True) & ImpreFormat(lnTMontoGar2Pr, 12, 2, True) & Space(6) & ImpreFormat(lnTIntCapitPr, 10, 2, True)
                                        If lnTDesembCapPr > 0 Then
                                            lsRtfImp = lsRtfImp & ImpreFormat(lnTIntPendReversPr, 10, 2, False)
                                        End If
                                        lsRtfImp = lsRtfImp & Chr(10) & String(185, "-") & Chr(10)
                                        liLineas = liLineas + 3
                                        
                                        '*************CADENA IMPRESION RESUMEN POR PRODUCTO**************
                                        If Trim(reg1!nConsValor) = "1" Then
                                            liContS = liContS + 1
                                            '****************** [ SUB TOTAL POR PRODUCTO ] ********************
                                            ReDim Preserve lsCadenaS(liContS)
                                            lsCadenaS(liContS) = String(185, "-") & Chr(10) & lsDescPr & Space(4) & ImpreFormat(liTCredPr, 10, 0, True) & _
                                            ImpreFormat(lnTDesembCapPr, 15, , True) & ImpreFormat(lnTSaldoCapPr, 15, , True) & _
                                            ImpreFormat(lnTIntDevengPr, 15, , True) & ImpreFormat(lnTDeudaPr, 15, , True) & ImpreFormat(lnTMontoGar1Pr, 15, , True) & _
                                            ImpreFormat(lnTMontoGar2Pr, 15, , True) & ImpreFormat(lnTIntCapitPr, 12, , True)
                                            If lnTDesembCapPr > 0 Then
                                                lsCadenaS(liContS) = lsCadenaS(liContS) & ImpreFormat(lnTIntPendReversPr, 10, 2, False)
                                            End If
                                            lsCadenaS(liContS) = lsCadenaS(liContS) & Chr(10) & String(185, "-") & Chr(10)
                                        Else
                                            liContD = liContD + 1
                                            '****************** [ SUB TOTAL POR PRODUCTO ] ********************
                                            ReDim Preserve lsCadenaD(liContD)
                                            lsCadenaD(liContD) = String(185, "-") & Chr(10) & lsDescPr & Space(4) & ImpreFormat(liTCredPr, 10, 0, True) & _
                                            ImpreFormat(lnTDesembCapPr, 15, , True) & ImpreFormat(lnTSaldoCapPr, 15, , True) & _
                                            ImpreFormat(lnTIntDevengPr, 15, , True) & ImpreFormat(lnTDeudaPr, 15, , True) & ImpreFormat(lnTMontoGar1Pr, 15, , True) & _
                                            ImpreFormat(lnTMontoGar2Pr, 15, , True) & ImpreFormat(lnTIntCapitPr, 12, , True)
                                            If lnTDesembCapPr > 0 Then
                                                lsCadenaD(liContD) = lsCadenaD(liContD) & ImpreFormat(lnTIntPendReversPr, 10, 2, False)
                                            End If
                                            lsCadenaD(liContD) = lsCadenaD(liContD) & Chr(10) & String(185, "-") & Chr(10)
                                        End If
                                        
                                    End If '---liDatos - Sub Tipo de Crédito
                                    lbSiCambio = True
                                    Reg4.MoveNext
                                Loop 'Sub Tipo de Crédito
                            End If 'Sub Tipo de Crédito
                            Reg4.Close
                            Set Reg4 = Nothing
                        End If '---liDatos - Tipo de crédito
                        Reg3.MoveNext
                    Loop '--- Tipo de Crédito
                End If '--- Tipo de Crédito
                If liLineas >= 58 Then 'Para el control de salto de página
                   lsRtfImp = lsRtfImp & Chr(12)
                   cpag = cpag + 1
                   lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                   liLineas = 5
                End If
                '============ IMPRIMIR SUB TOTAL MONEDA =====================
                lsRtfImp = lsRtfImp & String(185, "-") & Chr(10)
                lsRtfImp = lsRtfImp & Space(3) & "TOTAL MONEDA                 CASOS  :  " & ImpreFormat(liTCredM, 4, 0, True) & Space(2)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTDesembCapM, 12, , True) & Space(12) & ImpreFormat(lnTSaldoCapM, 12, , True)
                lsRtfImp = lsRtfImp & Space(8) & ImpreFormat(lnTIntDevengM, 10, , True) & ImpreFormat(lnTDeudaM, 12, 2, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoGar1M, 12, 2, True) & ImpreFormat(lnTMontoGar2M, 12, 2, True) & Space(6) & ImpreFormat(lnTIntCapitM, 10, 2, True)
                If lnTDesembCapM > 0 Then
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTIntPendReversM, 10, 2, False)
                End If
                lsRtfImp = lsRtfImp & Chr(10) & String(185, "-") & Chr(10)
                liLineas = liLineas + 3
                lbSiCambio = True
            End If '---liDatos - Moneda
            RaiseEvent Progress(reg1.Bookmark, reg1.RecordCount)
            reg1.MoveNext
            If Not reg1.EOF And lbSiCambio = True Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                liLineas = 0
            End If
        Loop ' ---- Moneda
        lsRtfImp = lsRtfImp & Chr(12)
        
        If liContS > 0 Then
            lsRtfImp = lsRtfImp & Chr(10)
            lsRtfImp = lsRtfImp & "DETALLE POR LINEA DE CREDITO - NUEVOS SOLES - " & NombreAgencia(psAgencia) & Chr(10)
            lsRtfImp = lsRtfImp & String(40, "-") & Chr(10)
            liLineas = 3
        End If
        For i = 1 To liContS
            If liLineas >= 58 Then
                lsRtfImp = lsRtfImp & Chr(12)
                liLineas = 0
            End If
            lsRtfImp = lsRtfImp & lsCadenaS(i)
            liLineas = liLineas + 1
            If liLineas >= 62 Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                liLineas = 4
            End If
        Next i
        '========================= Impresión de SubTotal ================================
        If liContS > 0 Then
            lsRtfImp = lsRtfImp & String(185, "-") & Chr(10)
            lsRtfImp = lsRtfImp & "***** TOTALES MONEDA          CASOS  : " & ImpreFormat(liNumCredMS, 10, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoAprMS, 15, , True) & ImpreFormat(lnTSaldoCapMS, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevMS, 15, , True) & ImpreFormat(lnTDeudaMS, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTGar1MS, 15, , True) & ImpreFormat(lnTGar2MS, 15, , True) & Chr(10)
            lsRtfImp = lsRtfImp & String(185, "-") & Chr(10)
            liLineas = liLineas + 3
        End If
        lsRtfImp = lsRtfImp & Chr(12)
        If liContD > 0 Then
            lsRtfImp = lsRtfImp & lsCadenaD(1)
            lsRtfImp = lsRtfImp & Chr(10) & Chr(10)
            lsRtfImp = lsRtfImp & "DETALLE POR LINEA DE CREDITO - DOLARES USD - " & NombreAgencia(psAgencia) & Chr(10)
            lsRtfImp = lsRtfImp & String(40, "-") & Chr(10)
            liLineas = 4
        End If
        For i = 1 To liContD
            If liLineas >= 58 Then
                lsRtfImp = lsRtfImp & Chr(12)
                liLineas = 0
            End If
            lsRtfImp = lsRtfImp & lsCadenaD(i)
            liLineas = liLineas + 1
            If liLineas >= 62 Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                lsRtfImp = lsRtfImp & ImpCredRefinanCab(lsFecFinMes, psDesCadena, cpag, psAgencia)
                liLineas = 4
            End If
        Next i
        If liContD > 0 Then
            lsRtfImp = lsRtfImp & String(185, "-") & Chr(10)
            lsRtfImp = lsRtfImp & "***** TOTALES MONEDA          CASOS  : " & ImpreFormat(liNumCredMD, 10, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTMontoAprMD, 15, , True) & ImpreFormat(lnTSaldoCapMD, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTIntDevMD, 15, , True) & ImpreFormat(lnTDeudaMD, 15, , True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTGar1MD, 15, , True) & ImpreFormat(lnTGar2MD, 15, , True) & Chr(10)
            lsRtfImp = lsRtfImp & String(185, "-") & Chr(10)
            liLineas = liLineas + 3
        End If
        lsRtfImpAux = lsRtfImpAux & lsRtfImp
    End If '--- Moneda
    reg1.Close
    Set reg1 = Nothing
    Reg2.Close
    Set Reg2 = Nothing
    Reg3.Close
    Set Reg4 = Nothing
    Reg5.Close
    Set Reg5 = Nothing
Else
    nRepo108724_fgImpCredRefinan = ""
End If '--- liDatos - General
RaiseEvent CloseProgress
lsRtfImpG = lsRtfImpAux
nRepo108724_fgImpCredRefinan = lsRtfImpG
End Function

Sub PoneFecha(pdFecSis As Date)
  FechaSistema = pdFecSis
End Sub

Private Function SubCabCredRefinan()
Dim lsImp As String
lsImp = lsImp & String(185, "-") & Chr(10)
lsImp = lsImp & Space(2) & "CREDITO" & Space(12) & "CLIENTE " & Space(25) & "MONTO REF." & Space(3) & "VIGENCIA" & Space(7) & "SALDO CAP." & Space(3) & "ATRASO" & Space(2) & "INT.DEVENG." & Space(4) & "DEUDA TOT" & Space(4) & "GAR. HIPOT." & Space(5) & "OTRAS GAR." & Space(2) & "ANALITA" & Space(2) & "INT. CAP." & Chr(10)
lsImp = lsImp & String(185, "-") & Chr(10)
SubCabCredRefinan = lsImp
End Function

Public Function nRepo108804_(ByVal psServConsol As String, ByVal pnTipoCambio As Double, ByVal psCmac As String) As String
Dim sql As String
Dim rs As New ADODB.Recordset
Dim Lineas() As String
Dim Linea As Long

Dim lnNroClientes(2) As Long
Dim lnNroCredVig(2) As Long
Dim lnSaldoVigente(2) As Currency

Dim lnNroCliNue(2) As Long, lnNroClieCon(2) As Long
Dim lnSaldoVigNue(2) As Currency, lnSaldoVigCon(2) As Currency

Dim lnNroCredCom(2) As Long, lnNroCredPar(2) As Long
Dim lnSaldoVigCom(2) As Currency, lnSaldoVigPar(2) As Currency

Dim J As Long
Dim Total As Long
Dim i As Integer
Dim lsCadena As String

Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim lsCadenaPrint As String
Dim Tabula As Integer

'Agregado por LMMD la parte de Creditos automaticos y nuevos creditos

Dim rsN As ADODB.Recordset
Dim sSQLN As String
Dim nSKPyme As Double
Dim nCantPyme As Integer
Dim nSkAgricola As Double
Dim nCantAgricola As Integer

Dim nNumPyme1 As Integer
Dim nSKPyme1 As Double
Dim nNumAgri1 As Integer
Dim nSKAgri1 As Double

Dim nNumPyme2 As Integer
Dim nSKPyme2 As Double
Dim nNumAgri2 As Integer
Dim nSKAgri12 As Double

Dim nNumPyme3 As Integer
Dim nSKPyme3 As Double
Dim nNumAgri3 As Integer
Dim nSKAgri3 As Double

Dim ssql As String

lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc

If "102" = psCmac Then
    lsPignoraticio = " 2802,2803,2804, 2807 "
Else
    'lsPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
    lsPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
End If



Screen.MousePointer = 11
J = 4
Total = 4 * 25
lsCadenaPrint = ""
Tabula = 10
ReDim Lineas(20)
lsCadenaPrint = ReporteInfo4Cab(pnTipoCambio)
RaiseEvent ShowProgress
For i = 0 To 1
    If "102" = psCmac Then
        If i = 0 Then
            lsCadena = " AND SUBSTRING (C.cCtaCod,6,3) in ('101','201') "
        ElseIf i = 1 Then
            lsCadena = " AND SUBSTRING (C.cCtaCod,6,3) in ('XXX') "
        End If
    Else
        If i = 0 Then
            lsCadena = " AND SUBSTRING (C.cCtaCod,6,3) in ('101','201') "
        ElseIf i = 1 Then
            lsCadena = " AND SUBSTRING (C.cCtaCod,6,3) in ('102','202') "
    End If
    
    End If
    
    J = 0

    '--************************** CLIENTES NUEVOS Y CONOCIDOS *****************************
    sql = "SELECT COUNT(Distinct(PERSCREDITO.cPersCod)) AS TotalPersonas,  " _
        & " COUNT(Distinct( Case When Persona.dPersIng < DateAdd (day,-30,'" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') Then PersCredito.cPersCod End )) TotalConocido, " _
        & " IsNull(SUM( CASE WHEN Persona.dPersIng < DateAdd (day,-30,'" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') And  Substring(c.cCtaCod,9,1) ='1' THEN c.nSaldoCap /" & pnTipoCambio _
        & "                  WHEN Persona.dPersIng < DateAdd (day,-30,'" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "') And  Substring(c.cCtaCod,9,1) ='2' THEN c.nSaldoCap END ), 0 )  As SKConocido  " _
        & " FROM " & psServConsol & "CreditoConsol c " _
        & " INNER JOIN " & psServConsol & "ProductoPersonaConsol PersCredito ON PERSCREDITO.cCtaCod=C.cCtaCod " _
        & " INNER JOIN PERSONA ON PERSONA.cPersCod = PERSCREDITO.cPersCod  " _
        & " WHERE (C.nprdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") OR (C.nprdEstado =" & gColocEstRecVigJud & " ))  " _
        & " AND PersCredito.nPrdPersRelac =20 And C.nSaldoCap > 0 " _
        & lsCadena

    Set rs = GetQuery(sql)
    If Not RSVacio(rs) Then
        lnNroClientes(i) = rs!TotalPersonas
        lnNroClieCon(i) = rs!TotalConocido
        lnSaldoVigCon(i) = rs!SKConocido
    End If
    rs.Close
    'Set rs = Nothing

    '--************************** Saldos Vigentes  *****************************
    sql = "SELECT COUNT(c.cCtaCod)  As NumVig, " _
        & " Isnull(Sum ( CASE  WHEN  SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap/" & pnTipoCambio _
        & "                    WHEN  SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nSaldoCap  End ),  0 ) SKVig , " _
        & " COUNT( CASE  WHEN C.nCondCre IN (1,2) THEN c.cCtaCod END )  As NumCom,  " _
        & " IsNull(SUM( CASE WHEN C.nCondCre IN (1,2) And Substring(c.cCtaCod,9,1) ='1' THEN c.nSaldoCap /" & pnTipoCambio _
        & "                  WHEN C.nCondCre IN (1,2) And Substring(c.cCtaCod,9,1) ='2' THEN c.nSaldoCap END ), 0 )  As SKCom  " _
        & " From " & psServConsol & "CreditoConsol C " _
        & " WHERE ( C.nprdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") OR (C.nprdEstado in('2201','2205') ) )" _
        & "  AND C.nSaldoCap > 0  " _
        & lsCadena

    Set rs = GetQuery(sql)
    If Not RSVacio(rs) Then
        lnNroCredVig(i) = rs!NumVig
        lnSaldoVigente(i) = rs!SKVig
        lnNroCredCom(i) = rs!NumCom
        lnSaldoVigCom(i) = rs!SKCom
    End If
    rs.Close
    Set rs = Nothing
    
    '--****************encontrando lo creditos nuevos****************
    sSQLN = "Select NumCreVigPymes= Count(Cs.cCtaCod) ,"
    sSQLN = sSQLN & " SaldoVigPymes=Sum(Case When SubString(CS.cCtaCod,9,1)='1' Then Cs.nSaldoCap Else Cs.nSaldoCap*3.5 End )"
    sSQLN = sSQLN & " From ColocacCred C"
    sSQLN = sSQLN & " Inner Join DbConsolidada..CreditoConsol CS on CS.cCtaCod=C.cCtaCod"
    sSQLN = sSQLN & " Where SubString(C.cCtaCod,6,3) in ('201') and (C.cRFA ='NOR' or C.cRFA is NULL) and C.nColocCondicion in (1,2)"
    sSQLN = sSQLN & " Union"
    sSQLN = sSQLN & " Select NumCreVigAgri= Count(Cs.cCtaCod) ,"
    sSQLN = sSQLN & " SaldoVigAgri=Sum(Case When SubString(CS.cCtaCod,9,1)='1' Then Cs.nSaldoCap Else Cs.nSaldoCap*" & pnTipoCambio & " End )"
    sSQLN = sSQLN & " From ColocacCred C"
    sSQLN = sSQLN & " Inner Join DbConsolidada..CreditoConsol CS on CS.cCtaCod=C.cCtaCod"
    sSQLN = sSQLN & " Where SubString(C.cCtaCod,6,3) in ('202') and (C.cRFA ='NOR' or C.cRFA is NULL) and C.nColocCondicion in (1,2)"

    Set rsN = GetQuery(sSQLN)
    If Not rsN.EOF And Not rsN.BOF Then
        nSKPyme = rsN!NumCreVigPymes
        nCantPyme = rsN!NumCreVigPymes
        rsN.MoveNext
        nSkAgricola = rsN!SaldoVigPymes
        nCantAgricola = rsN!NumCreVigPymes
    End If
    Set rsN = Nothing
         
    '--**
    lnNroCliNue(i) = lnNroClientes(i) - lnNroClieCon(i)
    lnSaldoVigNue(i) = lnSaldoVigente(i) - lnSaldoVigCon(i)
    lnNroCredPar(i) = lnNroCredVig(i) - lnNroCredCom(i)
    lnSaldoVigPar(i) = lnSaldoVigente(i) - lnSaldoVigCom(i)
    RaiseEvent Progress(CInt(i), 2)
Next i
    RaiseEvent Progress(2, 2)
    RaiseEvent CloseProgress
Lineas(1) = Lineas(1) & CadDerecha("TOTAL", 25) & ImpreFormat(lnNroClientes(0), 15, 0, True) & ImpreFormat(lnSaldoVigente(0), 15, 2, True) & ImpreFormat(lnNroClientes(1), 15, 0, True) & ImpreFormat(lnSaldoVigente(1), 15, 2, True)
Lineas(2) = Lineas(2) & CadDerecha("NUEVOS", 25) & ImpreFormat(lnNroCliNue(0), 15, 0, True) & ImpreFormat(lnSaldoVigNue(0), 15, 2, True) & ImpreFormat(lnNroCliNue(1), 15, 0, True) & ImpreFormat(lnSaldoVigNue(1), 15, 2, True)
Lineas(3) = Lineas(3) & CadDerecha("CONOCIDOS", 25) & ImpreFormat(lnNroClieCon(0), 15, 0, True) & ImpreFormat(lnSaldoVigCon(0), 15, 2, True) & ImpreFormat(lnNroClieCon(1), 15, 0, True) & ImpreFormat(lnSaldoVigCon(1), 15, 2, True)

Lineas(4) = Lineas(4) & CadDerecha("TOTAL", 25) & ImpreFormat(lnNroCredVig(0), 15, 0, True) & ImpreFormat(lnSaldoVigente(0), 15, 2, True) & ImpreFormat(lnNroCredVig(1), 15, 0, True) & ImpreFormat(lnSaldoVigente(1), 15, 2, True)
Lineas(5) = Lineas(5) & CadDerecha("COMUN", 25) & ImpreFormat(lnNroCredCom(0), 15, 0, True) & ImpreFormat(lnSaldoVigCom(0), 15, 2, True) & ImpreFormat(lnNroCredCom(1), 15, 0, True) & ImpreFormat(lnSaldoVigCom(1), 15, 2, True)
Lineas(6) = Lineas(6) & CadDerecha("Credito ESTACIONAL", 25) & ImpreFormat(lnNroCredPar(0), 15, 0, True) & ImpreFormat(lnSaldoVigPar(0), 15, 2, True) & ImpreFormat(lnNroCredPar(1), 15, 0, True) & ImpreFormat(lnSaldoVigPar(1), 15, 2, True)
Lineas(7) = Lineas(7) & CadDerecha("Credito AUTOMATICO", 25) & ImpreFormat(0, 15, 0, True) & ImpreFormat(0, 15, 2, True) & ImpreFormat(0, 15, 0, True) & ImpreFormat(0, 15, 2, True)
Lineas(8) = Lineas(8) & CadDerecha("Credito NUEVO Y REPRE.", 25) & ImpreFormat(nCantPyme, 15, 2, True) & ImpreFormat(nSKPyme, 15, 2, True) & ImpreFormat(nCantAgricola, 15, 2, True) & ImpreFormat(nSkAgricola, 15, 2, True)

'Obteniendo la informacion de automaticos
'1 cliente pyme
ssql = "Select Count(PP.cPersCod) as nCantidad,"
ssql = ssql & " isnull(Sum(case When SubString(CS.cCtaCod,9,1)='1' Then CS.nSaldoCap Else CS.nSaldoCap*" & pnTipoCambio & " End),0) as nMonto"
ssql = ssql & " From ColocacCred C"
ssql = ssql & " Inner Join dbConsolidada..CreditoConsol CS on CS.cCtaCod=C.cCtaCod"
ssql = ssql & " Inner Join ProductoPersona PP on  PP.cCtacod=CS.cCtaCod and PP.nPrdPersRelac=20"
ssql = ssql & " Where CS.nDiasAtraso<=0 and (Select Count(*)"
ssql = ssql & " From ProductoPersona PP1"
ssql = ssql & " Inner Join ColocacCred CC1 on CC1.cCtaCod=PP1.cCtacod"
ssql = ssql & " Where PP1.nPrdPersRelac=20 and PP.cPersCod=PP1.cPersCod)=1 and"
ssql = ssql & " SubString(PP.cCtaCod,6,3)='201' and (C.cRFA='NOR' or C.cRFA is NULL)"

Set rs = GetQuery(ssql)

If Not rs.EOF And Not rs.BOF Then
    nNumPyme1 = rs!nCantidad
    nSKPyme1 = rs!nMonto
End If
Set rs = Nothing

ssql = "Select Count(PP.cPersCod) as nCantidad,"
ssql = ssql & " isnull(Sum(case When SubString(CS.cCtaCod,9,1)='1' Then CS.nSaldoCap Else CS.nSaldoCap*" & pnTipoCambio & " End),0) as nMonto"
ssql = ssql & " From ColocacCred C"
ssql = ssql & " Inner Join dbConsolidada..CreditoConsol CS on CS.cCtaCod=C.cCtaCod"
ssql = ssql & " Inner Join ProductoPersona PP on  PP.cCtacod=CS.cCtaCod and PP.nPrdPersRelac=20"
ssql = ssql & " Where C.nDiasAtraso<=0 and (Select Count(*)"
ssql = ssql & " From ProductoPersona PP1"
ssql = ssql & " Inner Join ColocacCred CC1 on CC1.cCtaCod=PP1.cCtacod"
ssql = ssql & " Where PP1.nPrdPersRelac=20 and PP.cPersCod=PP1.cPersCod)=1 and"
ssql = ssql & " SubString(PP.cCtaCod,6,3)='202' and (C.cRFA='NOR' or C.cRFA is NULL)"

Set rs = GetQuery(ssql)
If Not rs.EOF And Not rs.BOF Then
    nNumAgri1 = rs!nCantidad
    nSKAgri1 = rs!nMonto
End If
Set rs = Nothing

ssql = " Select Count(PP.cPersCod) as nCantidad,"
ssql = ssql & " isnull(Sum(case When SubString(CS.cCtaCod,9,1)='1' Then CS.nSaldoCap Else CS.nSaldoCap*" & pnTipoCambio & " End),0) as nMonto"
ssql = ssql & " From ColocacCred C"
ssql = ssql & " Inner Join dbConsolidada..CreditoConsol CS on CS.cCtaCod=C.cCtaCod"
ssql = ssql & " Inner Join ProductoPersona PP on  PP.cCtacod=CS.cCtaCod and PP.nPrdPersRelac=20"
ssql = ssql & " Where CS.nDiasAtraso<=0 and (Select Count(*)"
ssql = ssql & " From ProductoPersona PP1"
ssql = ssql & " Inner Join ColocacCred CC1 on CC1.cCtaCod=PP1.cCtacod"
ssql = ssql & " Where PP1.nPrdPersRelac=20 and PP.cPersCod=PP1.cPersCod)=2 and"
ssql = ssql & " SubString(PP.cCtaCod,6,3)='201' and (C.cRFA='NOR' or C.cRFA is NULL)"


Set rs = GetQuery(ssql)
If Not rs.EOF And Not rs.BOF Then
    nNumPyme2 = rs!nCantidad
    nSKPyme2 = rs!nMonto
End If
Set rs = Nothing

ssql = "Select Count(PP.cPersCod) as nCantidad,"
ssql = ssql & " isnull(Sum(case When SubString(CS.cCtaCod,9,1)='1' Then CS.nSaldoCap Else CS.nSaldoCap*" & pnTipoCambio & " End),0) as nMonto"
ssql = ssql & " From ColocacCred C"
ssql = ssql & " Inner Join dbConsolidada..CreditoConsol CS on CS.cCtaCod=C.cCtaCod"
ssql = ssql & " Inner Join ProductoPersona PP on  PP.cCtacod=CS.cCtaCod and PP.nPrdPersRelac=20"
ssql = ssql & " Where C.nDiasAtraso<=0 and (Select Count(*)"
ssql = ssql & " From ProductoPersona PP1"
ssql = ssql & " Inner Join ColocacCred CC1 on CC1.cCtaCod=PP1.cCtacod"
ssql = ssql & " Where PP1.nPrdPersRelac=20 and PP.cPersCod=PP1.cPersCod)=2 and"
ssql = ssql & " SubString(PP.cCtaCod,6,3)='202' and (C.cRFA='NOR' or C.cRFA is NULL)"

Set rs = GetQuery(ssql)
If Not rs.EOF And Not rs.BOF Then
    nNumAgri2 = rs!nCantidad
    nSKAgri12 = rs!nMonto
End If
Set rs = Nothing


ssql = "Select Count(PP.cPersCod) as nCantidad,"
ssql = ssql & " isnull(Sum(case When SubString(CS.cCtaCod,9,1)='1' Then CS.nSaldoCap Else CS.nSaldoCap*" & pnTipoCambio & " End),0) as nMonto"
ssql = ssql & " From ColocacCred C"
ssql = ssql & " Inner Join dbConsolidada..CreditoConsol CS on CS.cCtaCod=C.cCtaCod"
ssql = ssql & " Inner Join ProductoPersona PP on  PP.cCtacod=CS.cCtaCod and PP.nPrdPersRelac=20"
ssql = ssql & " Where CS.nDiasAtraso<=0 and (Select Count(*)"
ssql = ssql & " From ProductoPersona PP1"
ssql = ssql & " Inner Join ColocacCred CC1 on CC1.cCtaCod=PP1.cCtacod"
ssql = ssql & " Where PP1.nPrdPersRelac=20 and PP.cPersCod=PP1.cPersCod)=3 and"
ssql = ssql & " SubString(PP.cCtaCod,6,3)='201' and (C.cRFA='NOR' or C.cRFA is NULL)"

Set rs = GetQuery(ssql)
If Not rs.EOF And Not rs.BOF Then
    nNumPyme3 = rs!nCantidad
    nSKPyme3 = rs!nMonto
End If
Set rs = Nothing

ssql = "Select Count(PP.cPersCod) as nCantidad,"
ssql = ssql & " isnull(Sum(case When SubString(CS.cCtaCod,9,1)='1' Then CS.nSaldoCap Else CS.nSaldoCap*" & pnTipoCambio & " End),0) as nMonto"
ssql = ssql & " From ColocacCred C"
ssql = ssql & " Inner Join dbConsolidada..CreditoConsol CS on CS.cCtaCod=C.cCtaCod"
ssql = ssql & " Inner Join ProductoPersona PP on  PP.cCtacod=CS.cCtaCod and PP.nPrdPersRelac=20"
ssql = ssql & " Where CS.nDiasAtraso<=0 and (Select Count(*)"
ssql = ssql & " From ProductoPersona PP1"
ssql = ssql & " Inner Join ColocacCred CC1 on CC1.cCtaCod=PP1.cCtacod"
ssql = ssql & " Where PP1.nPrdPersRelac=20 and PP.cPersCod=PP1.cPersCod)=3 and"
ssql = ssql & " SubString(PP.cCtaCod,6,3)='202' and (C.cRFA='NOR' or C.cRFA is NULL)"

Set rs = GetQuery(ssql)
If Not rs.EOF And Not rs.BOF Then
    nNumAgri3 = rs!nCantidad
    nSKAgri3 = rs!nMonto
End If
Set rs = Nothing

Lineas(9) = Lineas(9) & CadDerecha("CLIEN UN CREDITO", 25) & ImpreFormat(nNumPyme1, 15, 0, True) & ImpreFormat(nSKPyme1, 20, 2, True) & Space(6) & ImpreFormat(nNumAgri1, 0, 2, True) & ImpreFormat(nSKAgri1, 15, 2, True)
Lineas(10) = Lineas(10) & CadDerecha("CLIEN CON DOS CREDITO", 25) & ImpreFormat(nNumPyme2, 15, 0, True) & ImpreFormat(nSKPyme2, 20, 2, True) & Space(6) & ImpreFormat(nNumAgri2, 0, 2, True) & ImpreFormat(nSKAgri12, 15, 2, True)
Lineas(11) = Lineas(11) & CadDerecha("CLIEN CON TRES CREDITO", 25) & ImpreFormat(nNumPyme3, 15, 0, True) & ImpreFormat(nSKPyme3, 20, 2, True) & Space(6) & ImpreFormat(nNumAgri3, 0, 2, True) & ImpreFormat(nSKAgri3, 15, 2, True)
Lineas(12) = Lineas(12) & CadDerecha("CLIENTES TOTAL", 25) & ImpreFormat(nNumPyme3 + nNumPyme2 + nNumPyme1, 15, 0, True) & ImpreFormat(nSKPyme3 + nSKPyme2 + nSKPyme1, 20, 2, True) & Space(6) & ImpreFormat(nNumAgri3 + nNumAgri2 + nNumAgri1, 0, 2, True) & ImpreFormat(nSKAgri3 + nSKAgri12 + nSKAgri1, 15, 2, True)

lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(10)  ' & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "TIPO DE CLIENTES" & Space(15) & " CLIENTES    SALDO VIGENTE  |     CLIENTES     SALDO VIGENTE |" & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(1) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(2) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(3) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "TIPO DE PRODUCTO" & Space(15) & " CREDITOS    SALDO VIGENTE  |     CREDITOS     SALDO VIGENTE |" & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(4) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(5) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(6) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(7) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(8) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "CREDITOS AUTOMATICOS" & Space(15) & " CLIENTES    SALDO VIGENTE  |     CLIENTES     SALDO VIGENTE |" & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(9) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(10) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(11) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(12) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)

Screen.MousePointer = 0
nRepo108804_ = lsCadenaPrint
End Function

Public Function nRepo108806_(ByVal psServConsol As String, ByVal pnTipoCambio As Double) As String
Dim sql As String
Dim rs As New ADODB.Recordset
Dim Lineas() As String
Dim Linea As Long

Dim lnNroCredVig As Long
Dim lnSKOtorg As Currency

Dim lnNroCredVigHom As Long, lnNroCredVigMuj As Long
Dim lnSKOtorgHom As Currency, lnSKOtorgMuj As Currency

Dim lnNroCredVigUrb As Long, lnNroCredVigRur As Long
Dim lnSKOtorgUrb As Currency, lnSKOtorgRur As Currency

Dim Total As Long
Dim i As Integer
Dim lsCadena As String
Dim J As Integer

Dim lsCreditosVigentes As String

Dim lsCadenaPrint As String
Dim Tabula As Integer


lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc


RaiseEvent ShowProgress
Screen.MousePointer = 11
J = 4
Total = 4 * 25

lsCadenaPrint = ""
Tabula = 10
ReDim Lineas(20)
lsCadenaPrint = ReporteInfo6Cab(pnTipoCambio)

    '--************************** Total CREDITOS *****************************
    sql = "SELECT COUNT(C.cCtaCod) AS NroCred,  " _
        & " IsNull(SUM( CASE WHEN Substring(c.cCtaCod,9,1) ='1' THEN c.nMontoDesemb /" & pnTipoCambio _
        & "                  WHEN Substring(c.cCtaCod,9,1) ='2' THEN c.nMontoDesemb END ), 0 )  As SKOtorg  " _
        & " FROM " & psServConsol & "CreditoConsol c " _
        & " WHERE (C.nPrdEstado in (" & lsCreditosVigentes & ") OR (C.nPrdEstado =" & gColocEstRecVigJud & "))  " _
        & " And C.nSaldoCap > 0 " _
        & " AND Substring(C.cCtaCod,6,3) in ('101','201')  "
   RaiseEvent Progress(2, 10)
    Set rs = GetQuery(sql)
    If Not RSVacio(rs) Then
        lnNroCredVig = rs!NroCred
        lnSKOtorg = rs!SKOtorg
    End If
    rs.Close
    'Set rs = Nothing
    '--************************** Total x Sexo *****************************
    sql = "Select cOUNT(c1.cCtaCod) NumCredFem, " _
        & " Isnull(Sum ( CASE  WHEN  SUBSTRING(C1.cCtaCod,9,1)='1' THEN C1.nMontoDesemb /" & pnTipoCambio _
        & "                    WHEN  SUBSTRING(C1.cCtaCod,9,1)='2' THEN C1.nMontoDesemb  End ),  0 )  SKOtorgFem  " _
        & " From " & psServConsol & "Creditoconsol C1 " _
        & " INNER JOIN " & psServConsol & "ProductoPersonaConsol PersCredito ON PERSCREDITO.cCtaCod=C1.cCtaCod " _
        & " INNER JOIN PERSONA PERSONA ON PERSONA.cPersCod = PERSCREDITO.cPersCod " _
        & " INNER JOIN PersonaNat PN on PERSONA.cPersCod = PN.cPersCod " _
        & " WHERE (C1.nPrdEstado in (" & lsCreditosVigentes & ") OR (C1.nPrdEstado =" & gColocEstRecVigJud & "))  " _
        & " And C1.nSaldoCap > 0 " _
        & " AND Substring(C1.cCtaCod,6,3) in ('101','201') AND PERSCREDITO.nPrdPersRelac =20  " _
        & " AND PN.cPersNatSexo = 'F' "

    Set rs = GetQuery(sql)
    If Not RSVacio(rs) Then
        lnNroCredVigMuj = rs!NumCredFem
        lnSKOtorgMuj = rs!SKOtorgFem
    End If
    rs.Close
RaiseEvent Progress(4, 10)
    
    '--************************** Total x Zona Geografica *****************************
    sql = "Select cOUNT(c1.cCtaCod) NumCredRur, " _
        & " Isnull(Sum ( CASE  WHEN  SUBSTRING(C1.cCtaCod,9,1)='1' THEN C1.nMontoDesemb /" & pnTipoCambio _
        & "                    WHEN  SUBSTRING(C1.cCtaCod,9,1)='2' THEN C1.nMontoDesemb  End ),  0 )  SKOtorgRur  " _
        & " From " & psServConsol & "Creditoconsol C1 " _
        & " INNER JOIN " & psServConsol & "ProductoPersonaConsol PersCredito ON PERSCREDITO.cCtaCod=C1.cCtaCod " _
        & " INNER JOIN PERSONA PERSONA ON PERSONA.cPersCod = PERSCREDITO.cPersCod " _
        & " WHERE (C1.nPrdEstado in (" & lsCreditosVigentes & ") OR (C1.nPrdEstado =" & gColocEstRecVigJud & " ))  " _
        & " And C1.nSaldoCap > 0 " _
        & " AND Substring(C1.cCtaCod,6,3) in ('101','201')  AND PERSCREDITO.nPrdPersRelac =20  " _
        & " AND Substring(Persona.cPersDireccUbiGeo,8,2) in ( '04','05','10','06','12','13','07','15' ) "

        Set rs = GetQuery(sql)
    If Not RSVacio(rs) Then
        lnNroCredVigRur = rs!NumCredRur
        lnSKOtorgRur = rs!SKOtorgRur
    End If
    rs.Close
    Set rs = Nothing
    
    '--**
    lnNroCredVigHom = lnNroCredVig - lnNroCredVigMuj
    lnSKOtorgHom = lnSKOtorg - lnSKOtorgMuj
    lnNroCredVigUrb = lnNroCredVig - lnNroCredVigUrb
    lnSKOtorgUrb = lnSKOtorg - lnSKOtorgUrb

    'Lineas(1) = Lineas(1) & CadDerecha("Tipo Cliente", 25) & "  Creditos Vigentes    |  Monto Inicial Otorgado  "
    Lineas(2) = Lineas(2) & CadDerecha("Hombres", 25) & ImpreFormat(lnNroCredVigHom, 25, 0, True) & ImpreFormat(lnSKOtorgHom, 25, 2, True)
    Lineas(3) = Lineas(3) & CadDerecha("Mujeres", 25) & ImpreFormat(lnNroCredVigMuj, 25, 0, True) & ImpreFormat(lnSKOtorgMuj, 25, 2, True)
    Lineas(4) = Lineas(4) & CadDerecha("TOTAL ", 25) & ImpreFormat(lnNroCredVig, 25, 0, True) & ImpreFormat(lnSKOtorg, 25, 2, True)

    
    Lineas(5) = Lineas(5) & CadDerecha("Urbano", 25) & ImpreFormat(lnNroCredVigUrb, 25, 0, True) & ImpreFormat(lnSKOtorgUrb, 25, 2, True)
    Lineas(6) = Lineas(6) & CadDerecha("Rural ", 25) & ImpreFormat(lnNroCredVigRur, 25, 0, True) & ImpreFormat(lnSKOtorgRur, 25, 2, True)
    Lineas(7) = Lineas(7) & CadDerecha("TOTAL ", 25) & ImpreFormat(lnNroCredVig, 25, 0, True) & ImpreFormat(lnSKOtorg, 25, 2, True)
RaiseEvent Progress(7, 10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & "POR SEXO" & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "TIPO DE CLIENTES" & Space(20) & "CREDITOS VIGENTES    |   MONTO INICIAL OTORGADO " & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(2) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(3) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(4) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & "POR ZONA GEOGRAFICA" & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "TIPO DE CLIENTES" & Space(20) & "CREDITOS VIGENTES    |   MONTO INICIAL OTORGADO " & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(5) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(6) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(7) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
nRepo108806_ = lsCadenaPrint
Screen.MousePointer = 0
RaiseEvent Progress(10, 10)
RaiseEvent CloseProgress
End Function


Public Sub nRepo108810_(ByVal psServConsol As String, _
            ByVal pnTipoCambio As Double, ByVal psNomCmac As String, ByVal pdFecSis As Date, ByVal pdFecIni As Date, _
            ByVal pdFecFin As Date)

Dim xlAplicacion As Excel.Application
Dim xlLibro As Excel.Workbook
Dim xlHoja1 As Excel.Worksheet
Dim fs As Scripting.FileSystemObject

Dim sql As String
Dim SqlM As String

Dim RsM As New ADODB.Recordset
Dim rs As New ADODB.Recordset
Dim nTipoCambio As Currency

Dim lsArchivo As String
Dim nFil As Integer
Dim nCol As Integer
Dim lsCodigo As String
Dim Titulo As String
Dim i As Integer
Dim J As Integer
Dim K As Integer
Dim L As Integer

'On Error Resume Next
sql = "select * from ConstSistema where nConsSisCod=80"
Set rs = GetQuery(sql)
lsCodigo = IIf(IsNull(rs!nConssisValor), "", rs!nConssisValor)
lsArchivo = "ReporteMicroRed" & Format(pdFecSis, "YYYYMMDD") & ".xls"
Set fs = New Scripting.FileSystemObject

Set xlAplicacion = New Excel.Application

If fs.FileExists(App.path & "\SPOOLER\" & lsArchivo) Then
    Set xlLibro = xlAplicacion.Workbooks.Open(App.path & "\SPOOLER\" & lsArchivo)
Else
    Set xlLibro = xlAplicacion.Workbooks.Add
End If

Set xlHoja1 = xlLibro.Worksheets.Add


xlHoja1.Range("A1").Cells.Font.Bold = True
xlHoja1.Range("A1").Cells.Font.Size = 14
xlHoja1.Cells(1, 1) = psNomCmac
xlHoja1.Range("A2").Cells.Font.Size = 10
xlHoja1.Cells(2, 1) = "Portafolio Analista"
J = DateDiff("m", pdFecIni, pdFecFin)
K = 4
For i = 0 To J
    xlHoja1.Cells(4, K + i) = "'" & Format(DateAdd("m", i, pdFecIni), "mmm yyyy")
    ' Obtener tipo de Cambio de esa Fecha
     SqlM = " Select nValFijo from TipoCambio"
     SqlM = SqlM & "  WHERE dFecCamb ="
     SqlM = SqlM & " (select max(dFecCamb)  from TipoCambio Where datediff(m,dFecCamb,'" & Format(DateAdd("m", i, pdFecIni), "mm/dd/yyyy") & "')=0)"
     Set RsM = GetQuery(SqlM)
        
     If RsM.EOF And RsM.BOF Then
        nTipoCambio = 0
     Else
        nTipoCambio = RsM!nValFijo
     End If
     xlHoja1.Cells(85, K + i) = Format(nTipoCambio, "0.000")
    
    '              ---------------------   Pymes -----------------------------
    'Nuevos
    sql = " select rango,  sum(SALDO) Saldo from ("
    sql = sql & " Select substring(C.cCtaCod,9,1) Tipo, Ct.cRefinan,"
    sql = sql & "  Saldo = case When  substring(C.cCtaCod,9,1) = '1' Then C.nSaldoCap"
    sql = sql & "          When  substring(C.cCtaCod,9,1) = '2' Then C.nSaldoCap * " & pnTipoCambio & " End,"
    sql = sql & " rango = case"
    sql = sql & "    WHEN c.ndiasatraso <= 0 THEN '01. Menor a 0'"
    sql = sql & "    WHEN c.ndiasatraso > 0 And c.ndiasatraso <= 30 THEN '02. 1 a 30'"
    sql = sql & "    WHEN c.ndiasatraso > 30 And c.ndiasatraso <= 60 THEN '03. 31 a 60'"
    sql = sql & "    WHEN c.ndiasatraso > 60 And c.ndiasatraso <= 90 THEN '04. 61 a 90'"
    sql = sql & "    WHEN c.ndiasatraso > 90 And c.ndiasatraso <= 180 THEN '05. 91 a 180'"
    sql = sql & "    WHEN c.ndiasatraso > 180 THEN '06. > 180' END"
    sql = sql & " from " & psServConsol & "CreditoSaldoConsol C"
    sql = sql & " Inner Join " & psServConsol & "CreditoConsolTotal CT on C.cCtaCod = CT.cCtaCod"
    sql = sql & " where C.nPrdEstado in (2020,2021,2022,2030,2031,2032) and"
    sql = sql & " datediff(month,C.dFecha,'" & Format(DateAdd("m", i, pdFecIni), "YYYY/MM/DD") & "')=0 and"
    sql = sql & " substring(C.cCtaCod,6,3) in ('201','101') and Ct.cRefinan='N' "
    sql = sql & " ) T"
    sql = sql & " group by  rango"
    sql = sql & " order by  rango"
    Set rs = GetQuery(sql)
    While Not rs.EOF
        Select Case rs!Rango
            Case "01. Menor a 0"
                xlHoja1.Cells(6, K + i) = rs!Saldo
            Case "02. 1 a 30"
                xlHoja1.Cells(7, K + i) = rs!Saldo
            Case "03. 31 a 60"
                xlHoja1.Cells(8, K + i) = rs!Saldo
            Case "04. 61 a 90"
                xlHoja1.Cells(9, K + i) = rs!Saldo
            Case "05. 91 a 180"
                xlHoja1.Cells(10, K + i) = rs!Saldo
            Case "06. > 180"
                xlHoja1.Cells(11, K + i) = rs!Saldo
        End Select
        rs.MoveNext
    Wend
    
    ' Refinanciados
    sql = " select rango,  sum(SALDO) Saldo from ("
    sql = sql & " Select substring(C.cCtaCod,9,1) Tipo, Ct.cRefinan,"
    sql = sql & "  Saldo = case When  substring(C.cCtaCod,9,1) = '1' Then C.nSaldoCap"
    sql = sql & "          When  substring(C.cCtaCod,9,1) = '2' Then C.nSaldoCap * " & nTipoCambio & " End,"
    sql = sql & " rango = case"
    sql = sql & "    WHEN c.ndiasatraso <= 0 THEN '01. Menor a 0'"
    sql = sql & "    WHEN c.ndiasatraso > 0 And c.ndiasatraso <= 30 THEN '02. 1 a 30'"
    sql = sql & "    WHEN c.ndiasatraso > 30 And c.ndiasatraso <= 60 THEN '03. 31 a 60'"
    sql = sql & "    WHEN c.ndiasatraso > 60 And c.ndiasatraso <= 90 THEN '04. 61 a 90'"
    sql = sql & "    WHEN c.ndiasatraso > 90 And c.ndiasatraso <= 180 THEN '05. 91 a 180'"
    sql = sql & "    WHEN c.ndiasatraso > 180 THEN '06. > 180' END"
    sql = sql & " from " & psServConsol & "CreditoSaldoConsol C"
    sql = sql & " Inner Join " & psServConsol & "CreditoConsolTotal CT on C.cCtaCod = CT.cCtaCod"
    sql = sql & " where C.nPrdEstado in (2020,2021,2022,2030,2031,2032) and"
    sql = sql & " datediff(month,C.dFecha,'" & Format(DateAdd("m", i, pdFecIni), "YYYY/MM/DD") & "')=0 and"
    sql = sql & " substring(C.cCtaCod,6,3) in ('201','101') and Ct.cRefinan='R' "
    sql = sql & " ) T"
    sql = sql & " group by  rango"
    sql = sql & " order by  rango"
    Set rs = GetQuery(sql)
    While Not rs.EOF
        Select Case rs!Rango
            Case "01. Menor a 0"
                xlHoja1.Cells(13, K + i) = rs!Saldo
            Case "02. 1 a 30"
                xlHoja1.Cells(14, K + i) = rs!Saldo
            Case "03. 31 a 60"
                xlHoja1.Cells(15, K + i) = rs!Saldo
            Case "04. 61 a 90"
                xlHoja1.Cells(16, K + i) = rs!Saldo
            Case "05. 91 a 180"
                xlHoja1.Cells(17, K + i) = rs!Saldo
            Case "06. > 180"
                xlHoja1.Cells(18, K + i) = rs!Saldo
        End Select
        rs.MoveNext
    Wend
    
    '------------------------ Consumo ----------------------
     'Nuevos
    sql = " select rango,  sum(SALDO) Saldo from ("
    sql = sql & " Select substring(C.cCtaCod,9,1) Tipo, Ct.cRefinan,"
    sql = sql & "  Saldo = case When  substring(C.cCtaCod,9,1) = '1' Then C.nSaldoCap"
    sql = sql & "          When  substring(C.cCtaCod,9,1) = '2' Then C.nSaldoCap * " & nTipoCambio & " End,"
    sql = sql & " rango = case"
    sql = sql & "    WHEN c.ndiasatraso <= 0 THEN '01. Menor a 0'"
    sql = sql & "    WHEN c.ndiasatraso > 0 And c.ndiasatraso <= 30 THEN '02. 1 a 30'"
    sql = sql & "    WHEN c.ndiasatraso > 30 And c.ndiasatraso <= 60 THEN '03. 31 a 60'"
    sql = sql & "    WHEN c.ndiasatraso > 60 And c.ndiasatraso <= 90 THEN '04. 61 a 90'"
    sql = sql & "    WHEN c.ndiasatraso > 90 And c.ndiasatraso <= 180 THEN '05. 91 a 180'"
    sql = sql & "    WHEN c.ndiasatraso > 180 THEN '06. > 180' END"
    sql = sql & " from " & psServConsol & "CreditoSaldoConsol C"
    sql = sql & " Inner Join " & psServConsol & "CreditoConsolTotal CT on C.cCtaCod = CT.cCtaCod"
    sql = sql & " where C.nPrdEstado in (2020,2021,2022,2030,2031,2032) and"
    sql = sql & " datediff(month,C.dFecha,'" & Format(DateAdd("m", i, pdFecIni), "YYYY/MM/DD") & "')=0 and"
    sql = sql & " substring(C.cCtaCod,6,3) in ('301','304','320') and Ct.cRefinan='N' "
    sql = sql & " ) T"
    sql = sql & " group by  rango"
    sql = sql & " order by  rango"
    Set rs = GetQuery(sql)
    While Not rs.EOF
        Select Case rs!Rango
            Case "01. Menor a 0"
                xlHoja1.Cells(22, K + i) = rs!Saldo
            Case "02. 1 a 30"
                xlHoja1.Cells(23, K + i) = rs!Saldo
            Case "03. 31 a 60"
                xlHoja1.Cells(24, K + i) = rs!Saldo
            Case "04. 61 a 90"
                xlHoja1.Cells(25, K + i) = rs!Saldo
            Case "05. 91 a 180"
                xlHoja1.Cells(26, K + i) = rs!Saldo
            Case "06. > 180"
                xlHoja1.Cells(27, K + i) = rs!Saldo
        End Select
        rs.MoveNext
    Wend
    
    ' Refinanciados
    sql = " select rango,  sum(SALDO) Saldo from ("
    sql = sql & " Select substring(C.cCtaCod,9,1) Tipo, Ct.cRefinan,"
    sql = sql & "  Saldo = case When  substring(C.cCtaCod,9,1) = '1' Then C.nSaldoCap"
    sql = sql & "          When  substring(C.cCtaCod,9,1) = '2' Then C.nSaldoCap * " & nTipoCambio & " End,"
    sql = sql & " rango = case"
    sql = sql & "    WHEN c.ndiasatraso <= 0 THEN '01. Menor a 0'"
    sql = sql & "    WHEN c.ndiasatraso > 0 And c.ndiasatraso <= 30 THEN '02. 1 a 30'"
    sql = sql & "    WHEN c.ndiasatraso > 30 And c.ndiasatraso <= 60 THEN '03. 31 a 60'"
    sql = sql & "    WHEN c.ndiasatraso > 60 And c.ndiasatraso <= 90 THEN '04. 61 a 90'"
    sql = sql & "    WHEN c.ndiasatraso > 90 And c.ndiasatraso <= 180 THEN '05. 91 a 180'"
    sql = sql & "    WHEN c.ndiasatraso > 180 THEN '06. > 180' END"
    sql = sql & " from " & psServConsol & "CreditoSaldoConsol C"
    sql = sql & " Inner Join " & psServConsol & "CreditoConsolTotal CT on C.cCtaCod = CT.cCtaCod"
    sql = sql & " where C.nPrdEstado in (2020,2021,2022,2030,2031,2032) and"
    sql = sql & " datediff(month,C.dFecha,'" & Format(DateAdd("m", i, pdFecIni), "YYYY/MM/DD") & "')=0 and"
    sql = sql & " substring(C.cCtaCod,6,3) in ('301','304','320') and Ct.cRefinan='R' "
    sql = sql & " ) T"
    sql = sql & " group by  rango"
    sql = sql & " order by  rango"
    Set rs = GetQuery(sql)
    While Not rs.EOF
        Select Case rs!Rango
            Case "01. Menor a 0"
                xlHoja1.Cells(30, K + i) = rs!Saldo
            Case "02. 1 a 30"
                xlHoja1.Cells(31, K + i) = rs!Saldo
            Case "03. 31 a 60"
                xlHoja1.Cells(32, K + i) = rs!Saldo
            Case "04. 61 a 90"
                xlHoja1.Cells(33, K + i) = rs!Saldo
            Case "05. 91 a 180"
                xlHoja1.Cells(34, K + i) = rs!Saldo
            Case "06. > 180"
                xlHoja1.Cells(35, K + i) = rs!Saldo
        End Select
        rs.MoveNext
    Wend
    ' Fin Consumo
    
    '------------------------ Hipotecario ----------------------
     'Nuevos
    sql = " select rango,  sum(SALDO) Saldo from ("
    sql = sql & " Select substring(C.cCtaCod,9,1) Tipo, Ct.cRefinan,"
    sql = sql & "  Saldo = case When  substring(C.cCtaCod,9,1) = '1' Then C.nSaldoCap"
    sql = sql & "          When  substring(C.cCtaCod,9,1) = '2' Then C.nSaldoCap * " & nTipoCambio & " End,"
    sql = sql & " rango = case"
    sql = sql & "    WHEN c.ndiasatraso <= 0 THEN '01. Menor a 0'"
    sql = sql & "    WHEN c.ndiasatraso > 0 And c.ndiasatraso <= 30 THEN '02. 1 a 30'"
    sql = sql & "    WHEN c.ndiasatraso > 30 And c.ndiasatraso <= 60 THEN '03. 31 a 60'"
    sql = sql & "    WHEN c.ndiasatraso > 60 And c.ndiasatraso <= 90 THEN '04. 61 a 90'"
    sql = sql & "    WHEN c.ndiasatraso > 90 And c.ndiasatraso <= 180 THEN '05. 91 a 180'"
    sql = sql & "    WHEN c.ndiasatraso > 180 THEN '06. > 180' END"
    sql = sql & " from " & psServConsol & "CreditoSaldoConsol C"
    sql = sql & " Inner Join " & psServConsol & "CreditoConsolTotal CT on C.cCtaCod = CT.cCtaCod"
    sql = sql & " where C.nPrdEstado in (2020,2021,2022,2030,2031,2032) and"
    sql = sql & " datediff(month,C.dFecha,'" & Format(DateAdd("m", i, pdFecIni), "YYYY/MM/DD") & "')=0 and"
    sql = sql & " substring(C.cCtaCod,6,3) in ('402') and Ct.cRefinan='N' "
    sql = sql & " ) T"
    sql = sql & " group by  rango"
    sql = sql & " order by  rango"
    Set rs = GetQuery(sql)
    While Not rs.EOF
        Select Case rs!Rango
            Case "01. Menor a 0"
                xlHoja1.Cells(39, K + i) = rs!Saldo
            Case "02. 1 a 30"
                xlHoja1.Cells(40, K + i) = rs!Saldo
            Case "03. 31 a 60"
                xlHoja1.Cells(41, K + i) = rs!Saldo
            Case "04. 61 a 90"
                xlHoja1.Cells(42, K + i) = rs!Saldo
            Case "05. 91 a 180"
                xlHoja1.Cells(43, K + i) = rs!Saldo
            Case "06. > 180"
                xlHoja1.Cells(44, K + i) = rs!Saldo
        End Select
        rs.MoveNext
    Wend
    
    ' Refinanciados
    sql = " select rango,  sum(SALDO) Saldo from ("
    sql = sql & " Select substring(C.cCtaCod,9,1) Tipo, Ct.cRefinan,"
    sql = sql & "  Saldo = case When  substring(C.cCtaCod,9,1) = '1' Then C.nSaldoCap"
    sql = sql & "          When  substring(C.cCtaCod,9,1) = '2' Then C.nSaldoCap * " & nTipoCambio & " End,"
    sql = sql & " rango = case"
    sql = sql & "    WHEN c.ndiasatraso <= 0 THEN '01. Menor a 0'"
    sql = sql & "    WHEN c.ndiasatraso > 0 And c.ndiasatraso <= 30 THEN '02. 1 a 30'"
    sql = sql & "    WHEN c.ndiasatraso > 30 And c.ndiasatraso <= 60 THEN '03. 31 a 60'"
    sql = sql & "    WHEN c.ndiasatraso > 60 And c.ndiasatraso <= 90 THEN '04. 61 a 90'"
    sql = sql & "    WHEN c.ndiasatraso > 90 And c.ndiasatraso <= 180 THEN '05. 91 a 180'"
    sql = sql & "    WHEN c.ndiasatraso > 180 THEN '06. > 180' END"
    sql = sql & " from " & psServConsol & "CreditoSaldoConsol C"
    sql = sql & " Inner Join " & psServConsol & "CreditoConsolTotal CT on C.cCtaCod = CT.cCtaCod"
    sql = sql & " where C.nPrdEstado in (2020,2021,2022,2030,2031,2032) and"
    sql = sql & " datediff(month,C.dFecha,'" & Format(DateAdd("m", i, pdFecIni), "YYYY/MM/DD") & "')=0 and"
    sql = sql & " substring(C.cCtaCod,6,3) in ('402') and Ct.cRefinan='R' "
    sql = sql & " ) T"
    sql = sql & " group by  rango"
    sql = sql & " order by  rango"
    Set rs = GetQuery(sql)
    While Not rs.EOF
        Select Case rs!Rango
            Case "01. Menor a 0"
                xlHoja1.Cells(47, K + i) = rs!Saldo
            Case "02. 1 a 30"
                xlHoja1.Cells(48, K + i) = rs!Saldo
            Case "03. 31 a 60"
                xlHoja1.Cells(49, K + i) = rs!Saldo
            Case "04. 61 a 90"
                xlHoja1.Cells(50, K + i) = rs!Saldo
            Case "05. 91 a 180"
                xlHoja1.Cells(51, K + i) = rs!Saldo
            Case "06. > 180"
                xlHoja1.Cells(52, K + i) = rs!Saldo
        End Select
        rs.MoveNext
    Wend
    ' --------------------------   Fin Hipotecario --------------------
    
    '------------------------ Prendario ----------------------
     'Nuevos
    sql = " select rango,  sum(SALDO) Saldo from ("
    sql = sql & " Select substring(C.cCtaCod,9,1) Tipo, Ct.cRefinan,"
    sql = sql & "  Saldo = case When  substring(C.cCtaCod,9,1) = '1' Then C.nSaldoCap"
    sql = sql & "          When  substring(C.cCtaCod,9,1) = '2' Then C.nSaldoCap * " & nTipoCambio & " End,"
    sql = sql & " rango = case"
    sql = sql & "    WHEN c.ndiasatraso <= 0 THEN '01. Menor a 0'"
    sql = sql & "    WHEN c.ndiasatraso > 0 And c.ndiasatraso <= 30 THEN '02. 1 a 30'"
    sql = sql & "    WHEN c.ndiasatraso > 30 And c.ndiasatraso <= 60 THEN '03. 31 a 60'"
    sql = sql & "    WHEN c.ndiasatraso > 60 And c.ndiasatraso <= 90 THEN '04. 61 a 90'"
    sql = sql & "    WHEN c.ndiasatraso > 90 And c.ndiasatraso <= 180 THEN '05. 91 a 180'"
    sql = sql & "    WHEN c.ndiasatraso > 180 THEN '06. > 180' END"
    sql = sql & " from " & psServConsol & "CreditoSaldoConsol C"
    sql = sql & " Inner Join " & psServConsol & "CreditoConsolTotal CT on C.cCtaCod = CT.cCtaCod"
    sql = sql & " where C.nPrdEstado in (2802,2803,2804, 2807) and"
    sql = sql & " datediff(month,C.dFecha,'" & Format(DateAdd("m", i, pdFecIni), "mm/dd/yyyy") & "')=0 and"
    sql = sql & " substring(C.cCtaCod,6,3) in ('305') and Ct.cRefinan='N' "
    sql = sql & " ) T"
    sql = sql & " group by  rango"
    sql = sql & " order by  rango"
    Set rs = GetQuery(sql)
    While Not rs.EOF
        Select Case rs!Rango
            Case "01. Menor a 0"
                xlHoja1.Cells(56, K + i) = rs!Saldo
            Case "02. 1 a 30"
                xlHoja1.Cells(57, K + i) = rs!Saldo
            Case "03. 31 a 60"
                xlHoja1.Cells(58, K + i) = rs!Saldo
            Case "04. 61 a 90"
                xlHoja1.Cells(59, K + i) = rs!Saldo
            Case "05. 91 a 180"
                xlHoja1.Cells(60, K + i) = rs!Saldo
            Case "06. > 180"
                xlHoja1.Cells(61, K + i) = rs!Saldo
        End Select
        rs.MoveNext
    Wend
    
    ' ----------------------  Fin Prendario ----------------------------------
    
    '------------------------ Comercial ----------------------
     'Nuevos
    sql = " select rango,  sum(SALDO) Saldo from ("
    sql = sql & " Select substring(C.cCtaCod,9,1) Tipo, Ct.cRefinan,"
    sql = sql & "  Saldo = case When  substring(C.cCtaCod,9,1) = '1' Then C.nSaldoCap"
    sql = sql & "          When  substring(C.cCtaCod,9,1) = '2' Then C.nSaldoCap * " & nTipoCambio & " End,"
    sql = sql & " rango = case"
    sql = sql & "    WHEN c.ndiasatraso <= 0 THEN '01. Menor a 0'"
    sql = sql & "    WHEN c.ndiasatraso > 0 And c.ndiasatraso <= 30 THEN '02. 1 a 30'"
    sql = sql & "    WHEN c.ndiasatraso > 30 And c.ndiasatraso <= 60 THEN '03. 31 a 60'"
    sql = sql & "    WHEN c.ndiasatraso > 60 And c.ndiasatraso <= 90 THEN '04. 61 a 90'"
    sql = sql & "    WHEN c.ndiasatraso > 90 And c.ndiasatraso <= 180 THEN '05. 91 a 180'"
    sql = sql & "    WHEN c.ndiasatraso > 180 THEN '06. > 180' END"
    sql = sql & " from " & psServConsol & "CreditoSaldoConsol C"
    sql = sql & " Inner Join " & psServConsol & "CreditoConsolTotal CT on C.cCtaCod = CT.cCtaCod"
    sql = sql & " where C.nPrdEstado in (2020,2021,2022,2030,2031,2032) and"
    sql = sql & " datediff(month,C.dFecha,'" & Format(DateAdd("m", i, pdFecIni), "mm/dd/yyyy") & "')=0 and"
    sql = sql & " substring(C.cCtaCod,6,3) in ('102','103') and Ct.cRefinan='N' "
    sql = sql & " ) T"
    sql = sql & " group by  rango"
    sql = sql & " order by  rango"
    Set rs = GetQuery(sql)
    While Not rs.EOF
        Select Case rs!Rango
            Case "01. Menor a 0"
                xlHoja1.Cells(65, K + i) = rs!Saldo
            Case "02. 1 a 30"
                xlHoja1.Cells(66, K + i) = rs!Saldo
            Case "03. 31 a 60"
                xlHoja1.Cells(67, K + i) = rs!Saldo
            Case "04. 61 a 90"
                xlHoja1.Cells(68, K + i) = rs!Saldo
            Case "05. 91 a 180"
                xlHoja1.Cells(69, K + i) = rs!Saldo
            Case "06. > 180"
                xlHoja1.Cells(70, K + i) = rs!Saldo
        End Select
        rs.MoveNext
    Wend
    
    ' Refinanciados
    sql = " select rango,  sum(SALDO) Saldo from ("
    sql = sql & " Select substring(C.cCtaCod,9,1) Tipo, Ct.cRefinan,"
    sql = sql & "  Saldo = case When  substring(C.cCtaCod,9,1) = '1' Then C.nSaldoCap"
    sql = sql & "          When  substring(C.cCtaCod,9,1) = '2' Then C.nSaldoCap * " & nTipoCambio & " End,"
    sql = sql & " rango = case"
    sql = sql & "    WHEN c.ndiasatraso <= 0 THEN '01. Menor a 0'"
    sql = sql & "    WHEN c.ndiasatraso > 0 And c.ndiasatraso <= 30 THEN '02. 1 a 30'"
    sql = sql & "    WHEN c.ndiasatraso > 30 And c.ndiasatraso <= 60 THEN '03. 31 a 60'"
    sql = sql & "    WHEN c.ndiasatraso > 60 And c.ndiasatraso <= 90 THEN '04. 61 a 90'"
    sql = sql & "    WHEN c.ndiasatraso > 90 And c.ndiasatraso <= 180 THEN '05. 91 a 180'"
    sql = sql & "    WHEN c.ndiasatraso > 180 THEN '06. > 180' END"
    sql = sql & " from " & psServConsol & "CreditoSaldoConsol C"
    sql = sql & " Inner Join " & psServConsol & "CreditoConsolTotal CT on C.cCtaCod = CT.cCtaCod"
    sql = sql & " where C.nPrdEstado in (2020,2021,2022,2030,2031,2032) and"
    sql = sql & " datediff(month,C.dFecha,'" & Format(DateAdd("m", i, pdFecIni), "mm/dd/yyyy") & "')=0 and"
    sql = sql & " substring(C.cCtaCod,6,3) in ('102','103') and Ct.cRefinan='R' "
    sql = sql & " ) T"
    sql = sql & " group by  rango"
    sql = sql & " order by  rango"
    Set rs = GetQuery(sql)
    While Not rs.EOF
        Select Case rs!Rango
            Case "01. Menor a 0"
                xlHoja1.Cells(74, K + i) = rs!Saldo
            Case "02. 1 a 30"
                xlHoja1.Cells(75, K + i) = rs!Saldo
            Case "03. 31 a 60"
                xlHoja1.Cells(76, K + i) = rs!Saldo
            Case "04. 61 a 90"
                xlHoja1.Cells(77, K + i) = rs!Saldo
            Case "05. 91 a 180"
                xlHoja1.Cells(78, K + i) = rs!Saldo
            Case "06. > 180"
                xlHoja1.Cells(79, K + i) = rs!Saldo
        End Select
        rs.MoveNext
    Wend
    
Next i

xlHoja1.Cells(4, 1) = "PYMES"
    xlHoja1.Cells(5, 2) = "NORMALES"
    xlHoja1.Cells(5, 3) = "0 DIAS"
    xlHoja1.Cells(6, 3) = "'1 - 30"
    xlHoja1.Cells(7, 3) = "31 - 60"
    xlHoja1.Cells(8, 3) = "61 - 90"
    xlHoja1.Cells(9, 3) = "91 - 180"
    xlHoja1.Cells(10, 3) = "> 180"
    xlHoja1.Cells(11, 3) = "TOTAL"
    
    xlHoja1.Cells(13, 2) = "REFINACIADOS"
    xlHoja1.Cells(13, 3) = "0 DIAS"
    xlHoja1.Cells(14, 3) = "'1 - 30"
    xlHoja1.Cells(15, 3) = "31 - 60"
    xlHoja1.Cells(16, 3) = "61 - 90"
    xlHoja1.Cells(17, 3) = "91 - 180"
    xlHoja1.Cells(18, 3) = "> 180"
    xlHoja1.Cells(19, 3) = "TOTAL"

xlHoja1.Cells(21, 1) = "CONSUMO"
    xlHoja1.Cells(22, 2) = "NORMALES"
    xlHoja1.Cells(22, 3) = "0 DIAS"
    xlHoja1.Cells(23, 3) = "'1 - 30"
    xlHoja1.Cells(24, 3) = "31 - 60"
    xlHoja1.Cells(25, 3) = "61 - 90"
    xlHoja1.Cells(26, 3) = "91 - 180"
    xlHoja1.Cells(27, 3) = "> 180"
    xlHoja1.Cells(28, 3) = "TOTAL"
    
    xlHoja1.Cells(30, 2) = "REFINACIADOS"
    xlHoja1.Cells(30, 3) = "0 DIAS"
    xlHoja1.Cells(31, 3) = "'1 - 30"
    xlHoja1.Cells(32, 3) = "31 - 60"
    xlHoja1.Cells(33, 3) = "61 - 90"
    xlHoja1.Cells(34, 3) = "91 - 180"
    xlHoja1.Cells(35, 3) = "> 180"
    xlHoja1.Cells(36, 3) = "TOTAL"


xlHoja1.Cells(38, 1) = "HIPOTECARIO"
    xlHoja1.Cells(39, 2) = "NORMALES"
    xlHoja1.Cells(39, 3) = "0 DIAS"
    xlHoja1.Cells(40, 3) = "'1 - 30"
    xlHoja1.Cells(41, 3) = "31 - 60"
    xlHoja1.Cells(42, 3) = "61 - 90"
    xlHoja1.Cells(43, 3) = "91 - 180"
    xlHoja1.Cells(44, 3) = "> 180"
    xlHoja1.Cells(45, 3) = "TOTAL"
    
    xlHoja1.Cells(47, 2) = "REFINACIADOS"
    xlHoja1.Cells(47, 3) = "0 DIAS"
    xlHoja1.Cells(48, 3) = "'1 - 30"
    xlHoja1.Cells(49, 3) = "31 - 60"
    xlHoja1.Cells(50, 3) = "61 - 90"
    xlHoja1.Cells(51, 3) = "91 - 180"
    xlHoja1.Cells(52, 3) = "> 180"
    xlHoja1.Cells(53, 3) = "TOTAL"

xlHoja1.Cells(55, 1) = "PRENDARIO"
    xlHoja1.Cells(56, 2) = "NORMALES"
    xlHoja1.Cells(56, 3) = "0 DIAS"
    xlHoja1.Cells(57, 3) = "'1 - 30"
    xlHoja1.Cells(58, 3) = "31 - 60"
    xlHoja1.Cells(59, 3) = "61 - 90"
    xlHoja1.Cells(60, 3) = "91 - 180"
    xlHoja1.Cells(61, 3) = "> 180"
    xlHoja1.Cells(62, 3) = "TOTAL"
    

xlHoja1.Cells(64, 1) = "COMERCIAL"
    xlHoja1.Cells(65, 2) = "NORMALES"
    xlHoja1.Cells(65, 3) = "0 DIAS"
    xlHoja1.Cells(66, 3) = "'1 - 30"
    xlHoja1.Cells(67, 3) = "31 - 60"
    xlHoja1.Cells(68, 3) = "61 - 90"
    xlHoja1.Cells(69, 3) = "91 - 180"
    xlHoja1.Cells(70, 3) = "> 180"
    xlHoja1.Cells(71, 3) = "TOTAL"
    
    xlHoja1.Cells(73, 2) = "REFINACIADOS"
    xlHoja1.Cells(74, 3) = "0 DIAS"
    xlHoja1.Cells(75, 3) = "'1 - 30"
    xlHoja1.Cells(76, 3) = "31 - 60"
    xlHoja1.Cells(77, 3) = "61 - 90"
    xlHoja1.Cells(78, 3) = "91 - 180"
    xlHoja1.Cells(79, 3) = "> 180"
    xlHoja1.Cells(80, 3) = "TOTAL"
    
xlHoja1.Cells(82, 1) = "TOTAL PORTAFOLIO"

xlHoja1.Cells(84, 1) = "TOTAL PORTAFOLIO EN US$"

xlHoja1.Cells(86, 1) = "TOTAL"
    xlHoja1.Cells(87, 2) = "NORMALES"
    xlHoja1.Cells(87, 3) = "0 DIAS"
    xlHoja1.Cells(88, 3) = "'1 - 30"
    xlHoja1.Cells(89, 3) = "31 - 60"
    xlHoja1.Cells(90, 3) = "61 - 90"
    xlHoja1.Cells(91, 3) = "91 - 180"
    xlHoja1.Cells(92, 3) = "> 180"
    xlHoja1.Cells(93, 3) = "TOTAL"
    
    xlHoja1.Cells(95, 2) = "REFINACIADOS"
    xlHoja1.Cells(96, 3) = "0 DIAS"
    xlHoja1.Cells(97, 3) = "'1 - 30"
    xlHoja1.Cells(98, 3) = "31 - 60"
    xlHoja1.Cells(99, 3) = "61 - 90"
    xlHoja1.Cells(100, 3) = "91 - 180"
    xlHoja1.Cells(101, 3) = "> 180"
    xlHoja1.Cells(102, 3) = "TOTAL"
    
    xlHoja1.Cells(104, 2) = "TOTAL"
    xlHoja1.Cells(105, 3) = "0 DIAS"
    xlHoja1.Cells(106, 3) = "'1 - 30"
    xlHoja1.Cells(107, 3) = "31 - 60"
    xlHoja1.Cells(108, 3) = "61 - 90"
    xlHoja1.Cells(109, 3) = "91 - 180"
    xlHoja1.Cells(110, 3) = "> 180"
    xlHoja1.Cells(111, 3) = "TOTAL"



xlHoja1.Range(xlHoja1.Cells(11, 3), xlHoja1.Cells(11, 3 + J + 1)).HorizontalAlignment = xlCenter

xlHoja1.Range(xlHoja1.Cells(11, 3), xlHoja1.Cells(11, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(11, 3), xlHoja1.Cells(11, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(19, 3), xlHoja1.Cells(19, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(19, 3), xlHoja1.Cells(19, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(28, 3), xlHoja1.Cells(28, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(28, 3), xlHoja1.Cells(28, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(36, 3), xlHoja1.Cells(36, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(36, 3), xlHoja1.Cells(36, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(45, 3), xlHoja1.Cells(45, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(45, 3), xlHoja1.Cells(45, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(53, 3), xlHoja1.Cells(53, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(53, 3), xlHoja1.Cells(53, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(62, 3), xlHoja1.Cells(62, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(62, 3), xlHoja1.Cells(62, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(71, 3), xlHoja1.Cells(71, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(71, 3), xlHoja1.Cells(71, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(80, 3), xlHoja1.Cells(80, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(80, 3), xlHoja1.Cells(80, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(84, 3), xlHoja1.Cells(84, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(84, 3), xlHoja1.Cells(84, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(93, 3), xlHoja1.Cells(93, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(93, 3), xlHoja1.Cells(93, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(102, 3), xlHoja1.Cells(102, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(102, 3), xlHoja1.Cells(102, 3 + J + 1)).Interior.Pattern = xlSolid
 
xlHoja1.Range(xlHoja1.Cells(111, 3), xlHoja1.Cells(111, 3 + J + 1)).Interior.ColorIndex = 15
xlHoja1.Range(xlHoja1.Cells(111, 3), xlHoja1.Cells(111, 3 + J + 1)).Interior.Pattern = xlSolid


xlHoja1.Range("D87").Formula = "=sum(D5+D22+D39+D56+D65)"
xlHoja1.Range("D88").Formula = "=sum(D6+D23+D40+D57+D66)"
xlHoja1.Range("D89").Formula = "=sum(D7+D24+D41+D58+D67)"
xlHoja1.Range("D90").Formula = "=sum(D8+D25+D42+D59+D68)"
xlHoja1.Range("D91").Formula = "=sum(D9+D26+D43+D60+D69)"
xlHoja1.Range("D92").Formula = "=sum(D10+D27+D44+D61+D70)"

xlHoja1.Range("D96").Formula = "=sum(D13+D30+D47+D74)"
xlHoja1.Range("D97").Formula = "=sum(D14+D31+D48+D75)"
xlHoja1.Range("D98").Formula = "=sum(D15+D32+D49+D76)"
xlHoja1.Range("D99").Formula = "=sum(D16+D33+D50+D77)"
xlHoja1.Range("D100").Formula = "=sum(D17+D34+D51+D78)"
xlHoja1.Range("D101").Formula = "=sum(D18+D35+D52+D79)"

xlHoja1.Range("D105").Formula = "=sum(D87+D96)"
xlHoja1.Range("D106").Formula = "=sum(D88+D97)"
xlHoja1.Range("D107").Formula = "=sum(D89+D98)"
xlHoja1.Range("D108").Formula = "=sum(D90+D99)"
xlHoja1.Range("D109").Formula = "=sum(D91+D100)"
xlHoja1.Range("D110").Formula = "=sum(D92+D101)"

'Suma de Totales
L = Asc("D")
For i = 0 To J
    xlHoja1.Range(Chr(L) & 11).Formula = "=sum(" & Chr(L) & "5.." & Chr(L) & "10)"
    xlHoja1.Range(Chr(L) & 19).Formula = "=sum(" & Chr(L) & "13.." & Chr(L) & "18)"
    xlHoja1.Range(Chr(L) & 28).Formula = "=sum(" & Chr(L) & "22.." & Chr(L) & "27)"
    xlHoja1.Range(Chr(L) & 36).Formula = "=sum(" & Chr(L) & "30.." & Chr(L) & "35)"
    xlHoja1.Range(Chr(L) & 45).Formula = "=sum(" & Chr(L) & "39.." & Chr(L) & "44)"
    xlHoja1.Range(Chr(L) & 53).Formula = "=sum(" & Chr(L) & "47.." & Chr(L) & "52)"
    xlHoja1.Range(Chr(L) & 62).Formula = "=sum(" & Chr(L) & "56.." & Chr(L) & "61)"
    xlHoja1.Range(Chr(L) & 71).Formula = "=sum(" & Chr(L) & "65.." & Chr(L) & "70)"
    xlHoja1.Range(Chr(L) & 80).Formula = "=sum(" & Chr(L) & "74.." & Chr(L) & "79)"
    xlHoja1.Range(Chr(L) & 93).Formula = "=sum(" & Chr(L) & "87.." & Chr(L) & "92)"
    xlHoja1.Range(Chr(L) & 102).Formula = "=sum(" & Chr(L) & "96.." & Chr(L) & "101)"
    xlHoja1.Range(Chr(L) & 111).Formula = "=sum(" & Chr(L) & "105.." & Chr(L) & "110)"
    xlHoja1.Range(Chr(L) & 82).Formula = "=sum(" & Chr(L) & "11+" & Chr(L) & "19+" & Chr(L) & "28+" & Chr(L) & "36+" & Chr(L) & "45+" & Chr(L) & "53+" & Chr(L) & "62+" & Chr(L) & "71+" & Chr(L) & "80)"
    xlHoja1.Range(Chr(L) & 84).Formula = "=" & Chr(L) & "82 /" & Chr(L) & "85"
    L = L + 1
Next i


xlHoja1.Range("A4:C111").Cells.Font.Bold = True
xlHoja1.Range("A4:A86").Cells.Font.Size = 12
xlHoja1.Range("B5:C111").Cells.Font.Size = 10
xlHoja1.Range("D4:FF4").Cells.Font.Bold = True

xlHoja1.PageSetup.CenterHorizontally = True
xlHoja1.PageSetup.Zoom = 70
xlHoja1.PageSetup.Orientation = xlLandscape



xlHoja1.SaveAs App.path & "\SPOOLER\" & lsArchivo
'Cierra el libro de trabajo
xlLibro.Close
' Cierra Microsoft Excel con el método Quit.
xlAplicacion.Quit
'RaiseEvent Progress(20, 20)
'---------------->
'Libera los objetos.
Set xlAplicacion = Nothing
Set xlLibro = Nothing
Set xlHoja1 = Nothing
'Set oTipCambio = Nothing
'-------------->

'RaiseEvent CloseProgress

MsgBox "Se ha Generado el Archivo " & lsArchivo & ".XLS Satisfactoriamente", vbInformation, "Aviso"
Exit Sub
ErrorExcel:
    MsgBox "Error Nº [" & Str(Err.Number) & "] " & Err.Description, vbInformation, "Aviso"
    xlLibro.Close
    ' Cierra Microsoft Excel con el método Quit.
    xlAplicacion.Quit
    'Libera los objetos.
    Set xlAplicacion = Nothing
    Set xlLibro = Nothing
    Set xlHoja1 = Nothing
End Sub


Public Sub nRepo108808_(ByVal psServConsol As String, ByVal pdFechaCierre As Date, _
            ByVal pnTipoCambio As Double, ByVal psNomCmac As String, ByVal pdFecSis As Date, ByVal pdFecIni As Date, _
            ByVal pdFecFin As Date)

Dim xlAplicacion As Excel.Application
Dim xlLibro As Excel.Workbook
Dim xlHoja1 As Excel.Worksheet
Dim xlHojaP As Excel.Worksheet

Dim sql As String
Dim rs As New ADODB.Recordset
Dim fs As Scripting.FileSystemObject

'****************************************
Dim lsArchivo As String

Dim lsCond1(11) As String, lsCond2(11) As String
Dim Det As Integer
Dim lnFil As Integer, lnCol As Integer

Dim lnNroCreFMS(8) As Long, lnNroCreFMD As Long
Dim lnMonCreFMS(8) As Long, lnMonCreFMD As Long
Dim lnNroCreOtorgS(8) As Long, lnNroCreOtorgD As Long
Dim lnMonCreOtorgS(8) As Currency, lnMonCreOtorgD As Currency
Dim lnNroCreCancelS(8) As Currency, lnNroCreCancelD As Currency
Dim lnMonCreCancelS(8) As Currency, lnMonCreCancelD As Currency

Dim lnNroCredS(8) As Long, lnNroCredD As Currency
Dim lnMonCredS(8) As Currency, lnMonCredD As Currency
Dim i As Integer
Dim lnTipCambioFM As Double
Dim lnTipCambioFMAnt As Double

Dim Titulo As String
Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim lsVig As String
Dim Total As Double
Dim Tabula As Integer
Dim oTipCambio As nTipoCambio

Dim P As Integer
Dim Z As Integer
Dim sSuma As String
Dim x As Integer
Dim ProdPersonal(1 To 4) As String
Dim sVar1 As String
Dim sVar2 As String
Dim sVar3 As String
Dim sVar4 As String

ProdPersonal(1) = "301"
ProdPersonal(2) = "304"
ProdPersonal(3) = "320"
'-- Para Financiamiento Cofide
ProdPersonal(4) = "402"

    
Set oTipCambio = New nTipoCambio
Dim rs1 As New ADODB.Recordset

lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
'lsPignoraticio = "2802,2803,2804,2807"
lsPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07

lsVig = gColocEstRecVigJud & "," & gColocEstRecVigCast & "," & gColocEstRecCanJud & ""


'On Error Resume Next
RaiseEvent ShowProgress

Total = 4 * 25
Tabula = 20
ReDim Lineas(20)
lsArchivo = "INFO_COLOC_BCR" & Format(pdFechaCierre, "YYYYMMDD") & ".xls"
Set fs = New Scripting.FileSystemObject

Set xlAplicacion = New Excel.Application
If fs.FileExists(App.path & "\SPOOLER\" & lsArchivo) Then
    Set xlLibro = xlAplicacion.Workbooks.Open(App.path & "\SPOOLER\" & lsArchivo)
Else
    Set xlLibro = xlAplicacion.Workbooks.Add
End If
Set xlHoja1 = xlLibro.Worksheets.Add

'ReporteColocacionesBCRCab
xlAplicacion.Range("A1:Z100").Font.Size = 9
xlHoja1.Cells(1, 1) = psNomCmac
xlHoja1.Cells(1, 8) = "T.C.F. SBS "
xlHoja1.Cells(1, 9) = Format(pnTipoCambio, "#,#0.000")
xlHoja1.Cells(2, 1) = "R E P O R T E   D E  C O L O C A C I O N E S   P A R A    B C R  -  AL " & Format(pdFechaCierre, "dd/mm/yyyy")
xlHoja1.Cells(3, 1) = "(En Nuevos Soles) "
xlHoja1.Range(xlHoja1.Cells(2, 1), xlHoja1.Cells(2, 11)).Merge True
xlHoja1.Range(xlHoja1.Cells(3, 1), xlHoja1.Cells(3, 11)).Merge True
xlHoja1.Range(xlHoja1.Cells(1, 1), xlHoja1.Cells(4, 11)).Font.Bold = True
xlHoja1.Range("A1..A36").ColumnWidth = 35
xlHoja1.Range("B1..L36").ColumnWidth = 15
RaiseEvent Progress(1, 15)

If pdFechaCierre = pdFecFin Then
    lnTipCambioFM = CDbl(pnTipoCambio)
Else
    lnTipCambioFM = oTipCambio.EmiteTipoCambio(Format(pdFecSis, "dd/mm/yyyy"), TCFijoMes)
End If

lnTipCambioFMAnt = oTipCambio.EmiteTipoCambio(Format(pdFecIni, "dd/mm/yyyy"), TCFijoMes)

'---*********************************
' -- CREDITOS PYME - RRPP
'---*********************************
    lnFil = 6
    lnCol = 1

    xlHoja1.Cells(lnFil, 1) = "CREDITOS PEQUEÑA EMPRESA"
    xlHoja1.Cells(lnFil, 2) = "RECURSOS PROPIOS"
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil, 3)).Merge True
    xlHoja1.Cells(lnFil, 4) = "SUB"
        
    xlHoja1.Cells(lnFil + 1, 2) = "M.N."
    xlHoja1.Cells(lnFil + 1, 3) = "M.E."
    xlHoja1.Cells(lnFil + 1, 4) = "TOTAL"

    xlHoja1.Range(xlHoja1.Cells(lnFil, 1), xlHoja1.Cells(lnFil + 1, 4)).HorizontalAlignment = xlCenter
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil + 1, 4)).Cells.Borders.LineStyle = xlOutside
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil + 1, 4)).Cells.Borders.LineStyle = xlInside
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil, 4)).Font.Bold = True
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 1), xlHoja1.Cells(lnFil + 9, 4)).Cells.Borders.LineStyle = xlOutside
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 1), xlHoja1.Cells(lnFil + 9, 4)).Cells.Borders.LineStyle = xlInside
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 2), xlHoja1.Cells(lnFil + 5, 4)).NumberFormat = "#,#0"
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 2), xlHoja1.Cells(lnFil + 5, 4)).Interior.Color = &HC0C0FF
    xlHoja1.Range(xlHoja1.Cells(lnFil + 6, 2), xlHoja1.Cells(lnFil + 9, 4)).NumberFormat = "#,#0.00"
    xlHoja1.Range(xlHoja1.Cells(lnFil + 6, 2), xlHoja1.Cells(lnFil + 9, 4)).Interior.Color = &HFFC0C0
    
    RaiseEvent Progress(3, 15)
    'Desembolsado
    sql = " SELECT"
    sql = sql & " COUNT( CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='1' THEN PRO.CCTACOD END )  NumOtorgS,"
    sql = sql & " COUNT( CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='2' THEN PRO.CCTACOD END )  NumOtorgd,"
    sql = sql & " ISNULL(SUM(CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='1' THEN COL.NMONTOCOL END),0) SKOtorgS,"
    sql = sql & " ROUND(ISNULL(SUM(CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='2' THEN COL.NMONTOCOL * " & lnTipCambioFM & " END),0),2) SKOtorgD"
    sql = sql & " FROM   COLOCACIONES COL"
    sql = sql & " INNER JOIN PRODUCTO PRO ON PRO.CCTACOD = COL.CCTACOD"
    sql = sql & " WHERE NPRDESTADO IN (2020,2021,2022,2030,2031,2032,2201)"
    sql = sql & " AND  COL.DVIGENCIA BETWEEN '" & Format(pdFecIni, "mm/dd/yyyy") & "' AND '" & Format(pdFecFin, "mm/dd/yyyy") & " 23:59' "
    sql = sql & " AND Substring(PRO.cCtaCod,6,3) in('101','201')"
    sql = sql & " AND Substring(COL.cLineaCred,1,2) in('01')"
    
    
    Set rs = GetQuery(sql)
    lnNroCreOtorgS(1) = rs!NumOtorgS: lnMonCreOtorgS(1) = rs!SKOtorgS 'Soles
    lnNroCreOtorgS(2) = rs!NumOtorgD: lnMonCreOtorgS(2) = rs!SKOtorgD 'Dolares
    RaiseEvent Progress(4, 15)
    rs.Close
    'Fin Mes Anterior
    sql = "SELECT Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.cCtaCod End ) NumFinMesS , " _
        & " Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='2' THEN C.cCtaCod End ) NumFinMesD , " _
        & " Isnull(SUM( CASE WHEN substring(C.cCtaCod,9,1) = '1' THEN (C.nSaldoCap) End ), 0 ) SKFinMesS , " _
        & " Isnull(SUM( CASE WHEN substring(C.cCtaCod,9,1) = '2' THEN C.nSaldoCap * " & lnTipCambioFMAnt & " End ), 0 ) SKFinMesD " _
        & " From " & psServConsol & "CreditoSaldoConsol C " _
        & " JOIN " & psServConsol & "CreditoConsol CC on C.cCtaCod = CC.cCtaCod " _
        & " WHERE ( C.nPrdEstado in (" & lsCreditosVigentes & ") or (C.nPrdEstado =" & gColocEstRecVigJud & " ) ) And Datediff(d,dFecha,'" & Format(pdFecIni, "mm/dd/yyyy") & "') = 0 " _
        & " AND C.nSaldoCap > 0 " _
        & " AND Substring(C.cCtaCod,6,3) in('101','201') AND Substring(CC.cLineaCred,1,2) in('01')  "

    Set rs = GetQuery(sql)
    
    lnNroCreFMS(1) = rs!NumFinMesS: lnMonCreFMS(1) = rs!SKFinMesS 'Soles
    lnNroCreFMS(2) = rs!NumFinMesD: lnMonCreFMS(2) = rs!SKFinMesD 'Dolares
    
    rs.Close
    'Fin Mes
    sql = "SELECT Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.cCtaCod End ) NumCredS ,  " _
        & " Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='2' THEN C.cCtaCod End ) NumCredD , " _
        & " Isnull(SUM( CASE WHEN substring(C.cCtaCod,9,1) = '1' THEN (C.nSaldoCap) End ), 0 ) SKCredS, " _
        & " Isnull(Round(SUM( CASE WHEN substring(C.cCtaCod,9,1) = '2' THEN (C.nSaldoCap * " & lnTipCambioFM & ") End ),2) , 0 ) SKCredD " _
        & " From " & psServConsol & "CreditoSaldoConsol C " _
        & " JOIN  " & psServConsol & "CreditoConsol CC on C.cCtaCod = CC.cCtaCod " _
        & " WHERE ( C.nPrdEstado in (" & lsCreditosVigentes & ") or (C.nPrdEstado =" & gColocEstRecVigJud & " ) ) And Datediff(d,dFecha,'" & Format(pdFecFin, "mm/dd/yyyy") & "') = 0  " _
        & " AND C.nSaldoCap > 0" _
        & " AND Substring(C.cCtaCod,6,3) in('101','201') AND Substring(CC.cLineaCred,1,2) in('01')  "

    Set rs = GetQuery(sql)
    lnNroCredS(1) = rs!NumCredS: lnMonCredS(1) = rs!SKCredS 'Soles
    lnNroCredS(2) = rs!NumCredD: lnMonCredS(2) = rs!SKCredD 'Dolares
    RaiseEvent Progress(5, 15)
      rs.Close

    lnNroCreCancelS(1) = lnNroCreFMS(1) + lnNroCreOtorgS(1) - lnNroCredS(1)
    lnNroCreCancelS(2) = lnNroCreFMS(2) + lnNroCreOtorgS(2) - lnNroCredS(2)
    lnMonCreCancelS(1) = lnMonCreFMS(1) + lnMonCreOtorgS(1) - lnMonCredS(1)
    lnMonCreCancelS(2) = lnMonCreFMS(2) + lnMonCreOtorgS(2) - lnMonCredS(2)
    
    lnFil = 8
    lnCol = 1
    xlHoja1.Cells(lnFil, lnCol) = "Nro Cred. Vigentes    " & Format(pdFecIni, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 1, lnCol) = "Nro Cred. Otorgados   " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 2, lnCol) = "Nro Cred. Cancelados  " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 3, lnCol) = "Nro Cred. Vigentes    " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 4, lnCol) = "Saldo Cred. Vigentes  " & Format(pdFecIni, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 5, lnCol) = "Monto Cred. Otorgados " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 6, lnCol) = "Monto Cred. Cancelados" & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 7, lnCol) = "Saldo Cred. Vigentes  " & Format(pdFecFin, "dd/mm/yyyy")

    xlHoja1.Cells(lnFil, lnCol + 1) = lnNroCreFMS(1)
    xlHoja1.Cells(lnFil + 1, lnCol + 1) = lnNroCreOtorgS(1)
    xlHoja1.Cells(lnFil + 2, lnCol + 1) = lnNroCreCancelS(1)
    xlHoja1.Cells(lnFil + 3, lnCol + 1) = lnNroCredS(1)
    xlHoja1.Cells(lnFil + 4, lnCol + 1) = lnMonCreFMS(1)
    xlHoja1.Cells(lnFil + 5, lnCol + 1) = lnMonCreOtorgS(1)
    xlHoja1.Cells(lnFil + 6, lnCol + 1) = lnMonCreCancelS(1)
    xlHoja1.Cells(lnFil + 7, lnCol + 1) = lnMonCredS(1)
    xlHoja1.Cells(lnFil, lnCol + 2) = lnNroCreFMS(2)
    xlHoja1.Cells(lnFil + 1, lnCol + 2) = lnNroCreOtorgS(2)
    xlHoja1.Cells(lnFil + 2, lnCol + 2) = lnNroCreCancelS(2)
    xlHoja1.Cells(lnFil + 3, lnCol + 2) = lnNroCredS(2)
    xlHoja1.Cells(lnFil + 4, lnCol + 2) = lnMonCreFMS(2)
    xlHoja1.Cells(lnFil + 5, lnCol + 2) = lnMonCreOtorgS(2)
    xlHoja1.Cells(lnFil + 6, lnCol + 2) = lnMonCreCancelS(2)
    xlHoja1.Cells(lnFil + 7, lnCol + 2) = lnMonCredS(2)
    
    RaiseEvent Progress(6, 15)
    'Suma el total por Moneda
    
    For i = 1 To 8
        xlHoja1.Range(xlHoja1.Cells(lnFil - 1 + i, lnCol + 3), xlHoja1.Cells(lnFil - 1 + i, lnCol + 3)).Formula = "=SUM(B" & i + 7 & "+C" & i + 7 & ")"
    Next i
'---*********************************
' -- CREDITOS PYME - RECURSOS DE TERCEROS
'---*********************************
     Set rs1 = GetQuery("select cLineaCred , cDescripcion from ColocLineacredito where cLineaCred <> '01' and cLineaCred like '__' order by cLineaCred")
    If rs1.EOF And rs1.BOF Then
    Else
        i = 5
        P = 4
        While Not rs1.EOF
            xlHoja1.Cells(7, i) = UCase(rs1!CDescripcion)
            
            For Z = 1 To 2
                lnNroCreFMS(Z) = 0:            lnNroCreOtorgS(Z) = 0
                lnNroCreCancelS(Z) = 0:            lnNroCredS(Z) = 0
                lnMonCreFMS(Z) = 0:            lnMonCreOtorgS(Z) = 0
                lnMonCreCancelS(Z) = 0:            lnMonCredS(Z) = 0
            Next Z
            

            sql = " SELECT"
            sql = sql & " Count( CASE WHEN SUBSTRING(cLineaCred,1,2)='02' THEN Col.cCtaCod End ) NumOtorg,"
            sql = sql & " Isnull(Sum ( CASE WHEN SUBSTRING(Col.cCtaCod,9,1)='1' THEN Col.NMONTOCOL"
            sql = sql & "                   WHEN SUBSTRING(Col.cCtaCod,9,1)='2' THEN Col.NMONTOCOL * " & lnTipCambioFM & " End ),  0 ) SKOtorg"
            sql = sql & " FROM   COLOCACIONES COL"
            sql = sql & " INNER JOIN PRODUCTO PRO ON PRO.CCTACOD = COL.CCTACOD"
            sql = sql & " WHERE NPRDESTADO IN (2020,2021,2022,2030,2031,2032,2201)"
            sql = sql & " AND  COL.DVIGENCIA BETWEEN '" & Format(pdFecIni, "mm/dd/yyyy") & "' AND '" & Format(pdFecFin, "mm/dd/yyyy") & " 23:59' "
            sql = sql & " AND Substring(PRO.cCtaCod,6,3) in('101','201')"
            sql = sql & " AND Substring(COL.cLineaCred,1,2) in('" & rs1!cLineaCred & "')"
            Set rs = GetQuery(sql)
            lnNroCreOtorgS(1) = rs!NumOtorg: lnMonCreOtorgS(1) = rs!SKOtorg
            rs.Close
            
            '-------------  Fin Mes Anterior
            sql = "SELECT " _
                    & " Count(*) NumFinMes , " _
                    & " Isnull(Sum ( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap " _
                    & "                   WHEN SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nSaldoCap *" & lnTipCambioFMAnt & " End ),  0 ) SKFinMes " _
                    & " From " & psServConsol & "CreditoSaldoConsol C " _
                    & " JOIN  " & psServConsol & "CreditoConsol CC on C.cCtaCod = CC.cCtaCod " _
                    & " WHERE ( C.nPrdEstado IN (" & lsCreditosVigentes & ") or (C.nPrdEstado =" & gColocEstRecVigJud & ") )  And Datediff(d,dFecha,'" & Format(pdFecIni, "mm/dd/yyyy") & "') = 0 " _
                    & " And C.nSaldoCap > 0 " _
                    & " AND Substring(C.cCtaCod,6,3) in('101','201')  and SUBSTRING(CC.cLineaCred,1,2) in ('" & rs1!cLineaCred & "')"
                    
            Set rs = GetQuery(sql)
            lnNroCreFMS(1) = rs!NumFinMes: lnMonCreFMS(1) = rs!SKFinMes

            rs.Close
            '------------   Fin Mes
            sql = "SELECT " _
                    & " Count(*) NumCred , " _
                    & " Isnull(Sum ( CASE  When SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap " _
                    & "                    When SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nSaldoCap *" & lnTipCambioFM & " End ),  0 ) SKCred  " _
                    & " From " & psServConsol & "CreditoSaldoConsol C " _
                    & " JOIN  " & psServConsol & "CreditoConsol CC on C.cCtaCod = CC.cCtaCod " _
                    & " WHERE ( C.nPrdEstado in (" & lsCreditosVigentes & ") or (C.nPrdEstado =" & gColocEstRecVigJud & ") )  And Datediff(d,dFecha,'" & Format(pdFecFin, "mm/dd/yyyy") & "') = 0  " _
                    & " And C.nSaldoCap > 0 " _
                    & " AND Substring(C.cCtaCod,6,3) in('101','201') and SUBSTRING(CC.cLineaCred,1,2) in ('" & rs1!cLineaCred & "')"

            Set rs = GetQuery(sql)
            lnNroCredS(1) = rs!NumCred: lnMonCredS(1) = rs!SKCred
            
            rs.Close
            lnNroCreCancelS(1) = lnNroCreFMS(1) + lnNroCreOtorgS(1) - lnNroCredS(1)
            lnMonCreCancelS(1) = lnMonCreFMS(1) + lnMonCreOtorgS(1) - lnMonCredS(1)
            
            xlHoja1.Cells(lnFil, lnCol + P) = lnNroCreFMS(1)
            xlHoja1.Cells(lnFil + 1, lnCol + P) = lnNroCreOtorgS(1)
            xlHoja1.Cells(lnFil + 2, lnCol + P) = lnNroCreCancelS(1)
            xlHoja1.Cells(lnFil + 3, lnCol + P) = lnNroCredS(1)
            xlHoja1.Cells(lnFil + 4, lnCol + P) = lnMonCreFMS(1)
            xlHoja1.Cells(lnFil + 5, lnCol + P) = lnMonCreOtorgS(1)
            xlHoja1.Cells(lnFil + 6, lnCol + P) = lnMonCreCancelS(1)
            xlHoja1.Cells(lnFil + 7, lnCol + P) = lnMonCredS(1)
            
            lnNroCreFMS(1) = 0:            lnNroCreOtorgS(1) = 0
            lnNroCreCancelS(1) = 0:            lnNroCredS(1) = 0
            lnMonCreFMS(1) = 0:            lnMonCreOtorgS(1) = 0
            lnMonCreCancelS(1) = 0:            lnMonCredS(1) = 0
            
            rs1.MoveNext
            i = i + 1
            P = P + 1
        Wend
        If rs1.RecordCount > 1 Then
            xlHoja1.Range(xlHoja1.Cells(6, 5), xlHoja1.Cells(6, i - 1)).Merge True
            xlHoja1.Cells(6, 5) = "RECURSOS DE TERCEROS "
        Else
            xlHoja1.Cells(6, 5) = "RECURSOS DE TERCEROS "
        End If
        xlHoja1.Cells(6, i) = "TOTAL"
        xlHoja1.Range(xlHoja1.Cells(6, 1), xlHoja1.Cells(7, i)).HorizontalAlignment = xlCenter
        xlHoja1.Range(xlHoja1.Cells(6, 2), xlHoja1.Cells(7, i)).Cells.Borders.LineStyle = xlOutside
        xlHoja1.Range(xlHoja1.Cells(6, 2), xlHoja1.Cells(7, i)).Cells.Borders.LineStyle = xlInside
        xlHoja1.Range(xlHoja1.Cells(6, 2), xlHoja1.Cells(6, i)).Font.Bold = True
        xlHoja1.Range(xlHoja1.Cells(8, 1), xlHoja1.Cells(15, i)).Cells.Borders.LineStyle = xlOutside
        xlHoja1.Range(xlHoja1.Cells(8, 1), xlHoja1.Cells(15, i)).Cells.Borders.LineStyle = xlInside
        xlHoja1.Range(xlHoja1.Cells(8, 2), xlHoja1.Cells(11, i)).NumberFormat = "#,#0"
        xlHoja1.Range(xlHoja1.Cells(8, 2), xlHoja1.Cells(11, i)).Interior.Color = &HC0C0FF
        xlHoja1.Range(xlHoja1.Cells(12, 2), xlHoja1.Cells(15, i)).NumberFormat = "#,#0.00"
        xlHoja1.Range(xlHoja1.Cells(12, 2), xlHoja1.Cells(15, i)).Interior.Color = &HFFC0C0
        
       x = 0
        For P = 4 To i - 1
            sSuma = sSuma & Chr(Asc("D") + x) & "8+"
            x = 1 + x
        Next P
        sSuma = Mid(sSuma, 1, Len(sSuma) - 1)
        For P = 8 To 15
            xlHoja1.Range(xlHoja1.Cells(P, i), xlHoja1.Cells(P, i)).Formula = "= " & Replace(sSuma, "8", CStr(P))
        Next P
        sVar1 = Replace(sSuma, "8", CStr(P) - 1)
    End If

'---*********************************
' -- CREDITOS PERSONALES - RECURSOS PROPIOS
'---*********************************
       
    lnFil = 18
    lnCol = 1
    xlHoja1.Cells(lnFil + 2, lnCol) = "Nro Cred. Vigentes    " & Format(pdFecIni, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 3, lnCol) = "Nro Cred. Otorgados   " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 4, lnCol) = "Nro Cred. Cancelados  " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 5, lnCol) = "Nro Cred. Vigentes    " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 6, lnCol) = "Saldo Cred. Vigentes  " & Format(pdFecIni, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 7, lnCol) = "Monto Cred. Otorgados " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 8, lnCol) = "Monto Cred. Cancelados" & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 9, lnCol) = "Saldo Cred. Vigentes  " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil, 1) = "CREDITOS PERSONALES CON RECURSOS PROPIOS"
    
    x = 2
    lnCol = 2
    For i = 1 To 3
        For Z = 1 To 2
            lnNroCreFMS(Z) = 0:            lnNroCreOtorgS(Z) = 0
            lnNroCreCancelS(Z) = 0:            lnNroCredS(Z) = 0
            lnMonCreFMS(Z) = 0:            lnMonCreOtorgS(Z) = 0
            lnMonCreCancelS(Z) = 0:            lnMonCredS(Z) = 0
        Next Z
        'xlHoja1.Cells(7, I) = UCase(Rs1!cDescripcion)
        xlHoja1.Cells(lnFil, x) = NombreProducto(CInt(ProdPersonal(i)))
        xlHoja1.Range(xlHoja1.Cells(lnFil, x), xlHoja1.Cells(lnFil, x + 1)).Merge True
        xlHoja1.Cells(lnFil + 1, x) = "M.N."
        xlHoja1.Cells(lnFil + 1, x + 1) = "M.E."
        
        '- Desembolso
        sql = " SELECT"
        sql = sql & " COUNT( CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='1' THEN PRO.CCTACOD END )  NumOtorgS,"
        sql = sql & " COUNT( CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='2' THEN PRO.CCTACOD END )  NumOtorgd,"
        sql = sql & " ISNULL(SUM(CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='1' THEN COL.NMONTOCOL END),0) SKOtorgS,"
        sql = sql & " ROUND(ISNULL(SUM(CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='2' THEN COL.NMONTOCOL * " & lnTipCambioFM & " END),0),2) SKOtorgD"
        sql = sql & " FROM   COLOCACIONES COL"
        sql = sql & " INNER JOIN PRODUCTO PRO ON PRO.CCTACOD = COL.CCTACOD"
        sql = sql & " WHERE NPRDESTADO IN (2020,2021,2022,2030,2031,2032,2201)"
        sql = sql & " AND  COL.DVIGENCIA BETWEEN '" & Format(pdFecIni, "mm/dd/yyyy") & "' AND '" & Format(pdFecFin, "mm/dd/yyyy") & " 23:59' "
        sql = sql & " AND Substring(PRO.cCtaCod,6,3) in('" & ProdPersonal(i) & "')"
        sql = sql & " AND Substring(COL.cLineaCred,1,2) in('01')"
         '   RaiseEvent Progress(11, 15)
        Set rs = GetQuery(sql)
        While Not rs.EOF
            lnNroCreOtorgS(1) = rs!NumOtorgS: lnNroCreOtorgS(2) = rs!NumOtorgD
            lnMonCreOtorgS(1) = rs!SKOtorgS: lnMonCreOtorgS(2) = rs!SKOtorgD
            rs.MoveNext
            lnCol = lnCol + 1
        Wend
        rs.Close
        
        'Fin Mes Anterior
        sql = "SELECT " _
             & " Count( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='1' THEN C.cCtaCod End ) NumFinMesS , " _
             & " Count( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='2' THEN C.cCtaCod End ) NumFinMesD , " _
             & " Isnull(Sum ( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap End ), 0) SKFinMesS , " _
             & " Isnull(Sum ( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nSaldoCap *" & lnTipCambioFMAnt & " End ),  0 ) SKFinMesD   " _
             & " From " & psServConsol & "CreditoSaldoConsol C " _
             & " JOIN  " & psServConsol & "CreditoConsol CC on C.cCtaCod = CC.cCtaCod " _
             & " WHERE  ( C.nPrdEstado in (" & lsCreditosVigentes & " ) or (C.nPrdEstado = " & gColocEstRecVigJud & ") ) And Datediff(d,dFecha,'" & Format(pdFecIni, "mm/dd/yyyy") & "') = 0 " _
             & " And C.nSaldoCap > 0 " _
             & " AND Substring(C.cCtaCod,6,3) in ('" & ProdPersonal(i) & "') AND Substring(CC.cLineaCred,1,2) in('01')  "
        Set rs = GetQuery(sql)
        While Not rs.EOF
            lnNroCreFMS(1) = rs!NumFinMesS: lnNroCreFMS(2) = rs!NumFinMesD
            lnMonCreFMS(1) = rs!SKFinMesS: lnMonCreFMS(2) = rs!SKFinMesD
            rs.MoveNext
        Wend
        rs.Close
        
        '------ Fin Mes
        sql = "SELECT " _
        & " Count( CASE When SUBSTRING(C.cCtaCod,9,1)='1' THEN C.cCtaCod End ) NumCredS , " _
        & " Count( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='2' THEN C.cCtaCod End ) NumCredD , " _
        & " Isnull(Sum ( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap End ), 0) SKCredS , " _
        & " Round(Isnull(Sum ( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nSaldoCap *" & lnTipCambioFM & " End ),  0 ),2) SKCredD  " _
        & " From " & psServConsol & "CreditoSaldoConsol C " _
        & " JOIN  " & psServConsol & "CreditoConsol CC on C.cCtaCod = CC.cCtaCod " _
        & " WHERE ( C.nPrdEstado in (" & lsCreditosVigentes & ") or (C.nPrdEstado =" & gColocEstRecVigJud & " ) ) And Datediff(d,dFecha,'" & Format(pdFecFin, "mm/dd/yyyy") & "') = 0  " _
        & " And C.nSaldoCap > 0 " _
        & " AND Substring(C.cCtaCod,6,3) in ('" & ProdPersonal(i) & "') AND Substring(CC.cLineaCred,1,2) in('01')  "
        Set rs = GetQuery(sql)
        While Not rs.EOF
            lnNroCredS(1) = rs!NumCredS: lnNroCredS(2) = rs!NumCredD
            lnMonCredS(1) = rs!SKCredS: lnMonCredS(2) = rs!SKCredD
            rs.MoveNext
        Wend
        rs.Close
        ' Calcula Cancelados
         For P = 1 To 8
             lnNroCreCancelS(P) = lnNroCreFMS(P) + lnNroCreOtorgS(P) - lnNroCredS(P)
             lnMonCreCancelS(P) = lnMonCreFMS(P) + lnMonCreOtorgS(P) - lnMonCredS(P)
        Next P
        xlHoja1.Cells(lnFil + 2, x) = lnNroCreFMS(1)
        xlHoja1.Cells(lnFil + 3, x) = lnNroCreOtorgS(1)
        xlHoja1.Cells(lnFil + 4, x) = lnNroCreCancelS(1)
        xlHoja1.Cells(lnFil + 5, x) = lnNroCredS(1)
        xlHoja1.Cells(lnFil + 6, x) = lnMonCreFMS(1)
        xlHoja1.Cells(lnFil + 7, x) = lnMonCreOtorgS(1)
        xlHoja1.Cells(lnFil + 8, x) = lnMonCreCancelS(1)
        xlHoja1.Cells(lnFil + 9, x) = lnMonCredS(1)
        
        xlHoja1.Cells(lnFil + 2, x + 1) = lnNroCreFMS(2)
        xlHoja1.Cells(lnFil + 3, x + 1) = lnNroCreOtorgS(2)
        xlHoja1.Cells(lnFil + 4, x + 1) = lnNroCreCancelS(2)
        xlHoja1.Cells(lnFil + 5, x + 1) = lnNroCredS(2)
        xlHoja1.Cells(lnFil + 6, x + 1) = lnMonCreFMS(2)
        xlHoja1.Cells(lnFil + 7, x + 1) = lnMonCreOtorgS(2)
        xlHoja1.Cells(lnFil + 8, x + 1) = lnMonCreCancelS(2)
        xlHoja1.Cells(lnFil + 9, x + 1) = lnMonCredS(2)
            
        x = x + 2
    Next i
    RaiseEvent Progress(10, 15)
    Z = 0
    sSuma = ""
    For P = 2 To x - 1
        sSuma = sSuma & Chr(Asc("B") + Z) & "20+"
        Z = 1 + Z
    Next P
    sSuma = Mid(sSuma, 1, Len(sSuma) - 1)
    For P = 20 To 27
        xlHoja1.Range(xlHoja1.Cells(P, x), xlHoja1.Cells(P, x)).Formula = "= " & Replace(sSuma, "20", CStr(P))
    Next P
    sVar2 = Replace(sSuma, "20", CStr(P) - 1)
    xlHoja1.Cells(lnFil, x) = "TOTAL"
    xlHoja1.Range(xlHoja1.Cells(lnFil, 1), xlHoja1.Cells(lnFil + 1, x)).HorizontalAlignment = xlCenter
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil + 1, x)).Cells.Borders.LineStyle = xlOutside
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil + 1, x)).Cells.Borders.LineStyle = xlInside
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil, 10)).Font.Bold = True
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 1), xlHoja1.Cells(lnFil + 9, x)).Cells.Borders.LineStyle = xlOutside
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 1), xlHoja1.Cells(lnFil + 9, x)).Cells.Borders.LineStyle = xlInside
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 2), xlHoja1.Cells(lnFil + 5, x)).NumberFormat = "#,#0"
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 2), xlHoja1.Cells(lnFil + 5, x)).Interior.Color = &HC0C0FF
    xlHoja1.Range(xlHoja1.Cells(lnFil + 6, 2), xlHoja1.Cells(lnFil + 9, x)).NumberFormat = "#,#0.00"
    xlHoja1.Range(xlHoja1.Cells(lnFil + 6, 2), xlHoja1.Cells(lnFil + 9, x)).Interior.Color = &HFFC0C0

    '---*********************************
    ' -- CREDITOS FINANCIAMIENTO - COFIDE
    '---*********************************
    lnFil = 30
    lnCol = 1
  '  RaiseEvent Progress(13, 15)
  xlHoja1.Cells(lnFil, 1) = "CREDITOS FINANCIAMIENTO COFIDE"
  xlHoja1.Cells(lnFil + 2, lnCol) = "Nro Cred. Vigentes    " & Format(pdFecIni, "dd/mm/yyyy")
  xlHoja1.Cells(lnFil + 3, lnCol) = "Nro Cred. Otorgados   " & Format(pdFecFin, "dd/mm/yyyy")
  xlHoja1.Cells(lnFil + 4, lnCol) = "Nro Cred. Cancelados  " & Format(pdFecFin, "dd/mm/yyyy")
  xlHoja1.Cells(lnFil + 5, lnCol) = "Nro Cred. Vigentes    " & Format(pdFecFin, "dd/mm/yyyy")
  xlHoja1.Cells(lnFil + 6, lnCol) = "Saldo Cred. Vigentes  " & Format(pdFecIni, "dd/mm/yyyy")
  xlHoja1.Cells(lnFil + 7, lnCol) = "Monto Cred. Otorgados " & Format(pdFecFin, "dd/mm/yyyy")
  xlHoja1.Cells(lnFil + 8, lnCol) = "Monto Cred. Cancelados" & Format(pdFecFin, "dd/mm/yyyy")
  xlHoja1.Cells(lnFil + 9, lnCol) = "Saldo Cred. Vigentes  " & Format(pdFecFin, "dd/mm/yyyy")
  x = 2
  For i = 1 To 4
    For Z = 1 To 2
        lnNroCreFMS(Z) = 0:            lnNroCreOtorgS(Z) = 0
        lnNroCreCancelS(Z) = 0:            lnNroCredS(Z) = 0
        lnMonCreFMS(Z) = 0:            lnMonCreOtorgS(Z) = 0
        lnMonCreCancelS(Z) = 0:            lnMonCredS(Z) = 0
    Next Z
    xlHoja1.Cells(lnFil, x) = NombreProducto(CInt(ProdPersonal(i)))
    xlHoja1.Range(xlHoja1.Cells(lnFil, x), xlHoja1.Cells(lnFil, x + 1)).Merge True
    xlHoja1.Cells(lnFil + 1, x) = "M.N."
    xlHoja1.Cells(lnFil + 1, x + 1) = "M.E."
    
  'Desembolsado
    sql = " SELECT"
    sql = sql & " COUNT( CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='1' THEN PRO.CCTACOD END )  NumOtorgS,"
    sql = sql & " COUNT( CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='2' THEN PRO.CCTACOD END )  NumOtorgd,"
    sql = sql & " ISNULL(SUM(CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='1' THEN COL.NMONTOCOL END),0) SKOtorgS,"
    sql = sql & " ROUND(ISNULL(SUM(CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='2' THEN COL.NMONTOCOL * " & lnTipCambioFM & " END),0),2) SKOtorgD"
    sql = sql & " FROM   COLOCACIONES COL"
    sql = sql & " INNER JOIN PRODUCTO PRO ON PRO.CCTACOD = COL.CCTACOD"
    sql = sql & " WHERE NPRDESTADO IN (2020,2021,2022,2030,2031,2032,2201)"
    sql = sql & " AND  COL.DVIGENCIA BETWEEN '" & Format(pdFecIni, "mm/dd/yyyy") & "' AND '" & Format(pdFecFin, "mm/dd/yyyy") & " 23:59' "
    sql = sql & " AND Substring(PRO.cCtaCod,6,3) in('" & ProdPersonal(i) & "')"
    sql = sql & " AND Substring(COL.cLineaCred,1,2) in('02')"
   Set rs = GetQuery(sql)
    While Not rs.EOF
       lnNroCreOtorgS(1) = rs!NumOtorgS: lnNroCreOtorgS(2) = rs!NumOtorgD
       lnMonCreOtorgS(1) = rs!SKOtorgS: lnMonCreOtorgS(2) = rs!SKOtorgD
        rs.MoveNext
    Wend
    rs.Close
    
    'Fin Mes Anterior
   sql = "SELECT " _
        & " Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.cCtaCod End ) NumFinMesS , " _
        & " Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='2' THEN C.cCtaCod End ) NumFinMesD , " _
        & " Isnull(Sum ( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap End ), 0) SKFinMesS , " _
        & " Isnull(Sum ( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nSaldoCap *" & lnTipCambioFMAnt & " End ),  0 ) SKFinMesD   " _
        & " From " & psServConsol & "CreditoSaldoConsol C " _
        & " JOIN  " & psServConsol & "CreditoConsol CC on C.cCtaCod = CC.cCtaCod " _
        & " WHERE ( C.nPrdEstado in (" & lsCreditosVigentes & ") or (C.nPrdEstado =" & gColocEstRecVigJud & " ) ) And Datediff(d,dFecha,'" & Format(pdFecIni, "mm/dd/yyyy") & "') = 0 " _
        & "  " _
        & " AND Substring(C.cCtaCod,6,3) in ('" & ProdPersonal(i) & "') AND Substring(CC.cLineaCred,1,2) in ('02')   "
     Set rs = GetQuery(sql)
    While Not rs.EOF
       lnNroCreFMS(1) = rs!NumFinMesS: lnNroCreFMS(2) = rs!NumFinMesD
       lnMonCreFMS(1) = rs!SKFinMesS:   lnMonCreFMS(2) = rs!SKFinMesD
       rs.MoveNext
    Wend
    rs.Close
    
    'Fin Mes
     sql = "SELECT " _
        & " Count( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='1' THEN C.cCtaCod End ) NumCredS , " _
        & " Count( CASE WHEN  SUBSTRING(C.cCtaCod,9,1)='2' THEN C.cCtaCod End ) NumCredD , " _
        & " Isnull(Sum ( CASE when SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap End ), 0) SKCredS , " _
        & " Round(Isnull(Sum ( case when  SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nSaldoCap *" & lnTipCambioFM & " End ),  0 ),2) SKCredD  " _
        & " From " & psServConsol & "CreditoSaldoConsol C " _
        & " JOIN  " & psServConsol & "CreditoConsol CC on C.cCtaCod = CC.cCtaCod " _
        & " WHERE ( C.nPrdEstado in (" & lsCreditosVigentes & ") or (C.nPrdEstado =" & gColocEstRecVigJud & " ) ) And Datediff(d,dFecha,'" & Format(pdFecFin, "mm/dd/yyyy") & "') = 0  " _
        & "  " _
        & " AND Substring(C.cCtaCod,6,3) in ('" & ProdPersonal(i) & "') AND Substring(CC.cLineaCred,1,2) in ('02')  "
        Set rs = GetQuery(sql)
    While Not rs.EOF
        lnNroCredS(1) = rs!NumCredS: lnNroCredS(2) = rs!NumCredD
        lnMonCredS(1) = rs!SKCredS: lnMonCredS(2) = rs!SKCredD
        rs.MoveNext
    Wend
    rs.Close
    ' --- Calcula Cancelados
    For P = 1 To 8
        lnNroCreCancelS(P) = lnNroCreFMS(P) + lnNroCreOtorgS(P) - lnNroCredS(P)
        lnMonCreCancelS(P) = lnMonCreFMS(P) + lnMonCreOtorgS(P) - lnMonCredS(P)
    Next P
    xlHoja1.Cells(lnFil + 2, x) = lnNroCreFMS(1)
    xlHoja1.Cells(lnFil + 3, x) = lnNroCreOtorgS(1)
    xlHoja1.Cells(lnFil + 4, x) = lnNroCreCancelS(1)
    xlHoja1.Cells(lnFil + 5, x) = lnNroCredS(1)
    xlHoja1.Cells(lnFil + 6, x) = lnMonCreFMS(1)
    xlHoja1.Cells(lnFil + 7, x) = lnMonCreOtorgS(1)
    xlHoja1.Cells(lnFil + 8, x) = lnMonCreCancelS(1)
    xlHoja1.Cells(lnFil + 9, x) = lnMonCredS(1)
        
    xlHoja1.Cells(lnFil + 2, x + 1) = lnNroCreFMS(2)
    xlHoja1.Cells(lnFil + 3, x + 1) = lnNroCreOtorgS(2)
    xlHoja1.Cells(lnFil + 4, x + 1) = lnNroCreCancelS(2)
    xlHoja1.Cells(lnFil + 5, x + 1) = lnNroCredS(2)
    xlHoja1.Cells(lnFil + 6, x + 1) = lnMonCreFMS(2)
    xlHoja1.Cells(lnFil + 7, x + 1) = lnMonCreOtorgS(2)
    xlHoja1.Cells(lnFil + 8, x + 1) = lnMonCreCancelS(2)
    xlHoja1.Cells(lnFil + 9, x + 1) = lnMonCredS(2)
    
    x = x + 2
  Next i
  
    Z = 0
    sSuma = ""
    For P = 2 To x - 1
        sSuma = sSuma & Chr(Asc("B") + Z) & "32+"
        Z = 1 + Z
    Next P
    sSuma = Mid(sSuma, 1, Len(sSuma) - 1)
    For P = 32 To 39
        xlHoja1.Range(xlHoja1.Cells(P, x), xlHoja1.Cells(P, x)).Formula = "= " & Replace(sSuma, "32", CStr(P))
    Next P
    sVar3 = Replace(sSuma, "32", CStr(P) - 1)
  xlHoja1.Cells(lnFil, x) = "TOTAL"
  xlHoja1.Range(xlHoja1.Cells(lnFil, 1), xlHoja1.Cells(lnFil + 1, x)).HorizontalAlignment = xlCenter
  xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil + 1, x)).Cells.Borders.LineStyle = xlOutside
  xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil + 1, x)).Cells.Borders.LineStyle = xlInside
  xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil, 10)).Font.Bold = True
  xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 1), xlHoja1.Cells(lnFil + 9, x)).Cells.Borders.LineStyle = xlOutside
  xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 1), xlHoja1.Cells(lnFil + 9, x)).Cells.Borders.LineStyle = xlInside
  xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 2), xlHoja1.Cells(lnFil + 5, x)).NumberFormat = "#,#0"
  xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 2), xlHoja1.Cells(lnFil + 5, x)).Interior.Color = &HC0C0FF
  xlHoja1.Range(xlHoja1.Cells(lnFil + 6, 2), xlHoja1.Cells(lnFil + 9, x)).NumberFormat = "#,#0.00"
  xlHoja1.Range(xlHoja1.Cells(lnFil + 6, 2), xlHoja1.Cells(lnFil + 9, x)).Interior.Color = &HFFC0C0
  
'---*********************************
' -- CREDITOS PRENDARIOS
'---*********************************
    lnFil = 42
    lnCol = 1

    xlHoja1.Cells(lnFil, 1) = "CREDITOS PIGNORATICIOS"
    xlHoja1.Cells(lnFil, 2) = "RECURSOS PROPIOS"
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil, 3)).Merge True
    xlHoja1.Cells(lnFil, 4) = "TOTAL"
    xlHoja1.Cells(lnFil + 1, 2) = "M.N.":      xlHoja1.Cells(lnFil + 1, 3) = "M.E."
    xlHoja1.Range(xlHoja1.Cells(lnFil, 1), xlHoja1.Cells(lnFil + 1, 4)).HorizontalAlignment = xlCenter
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil + 1, 4)).Cells.Borders.LineStyle = xlOutside
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil + 1, 4)).Cells.Borders.LineStyle = xlInside
    xlHoja1.Range(xlHoja1.Cells(lnFil, 2), xlHoja1.Cells(lnFil, 4)).Font.Bold = True
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 1), xlHoja1.Cells(lnFil + 9, 4)).Cells.Borders.LineStyle = xlOutside
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 1), xlHoja1.Cells(lnFil + 9, 4)).Cells.Borders.LineStyle = xlInside
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 2), xlHoja1.Cells(lnFil + 5, 4)).NumberFormat = "#,#0"
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, 2), xlHoja1.Cells(lnFil + 5, 4)).Interior.Color = &HC0C0FF
    xlHoja1.Range(xlHoja1.Cells(lnFil + 6, 2), xlHoja1.Cells(lnFil + 9, 4)).NumberFormat = "#,#0.00"
    xlHoja1.Range(xlHoja1.Cells(lnFil + 6, 2), xlHoja1.Cells(lnFil + 9, 4)).Interior.Color = &HFFC0C0

    'Desembolsado
    'Sql = "SELECT Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.cCtaCod End ) NumOtorgS , " _
        & " Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='2' THEN C.cCtaCod End ) NumOtorgD , " _
        & " Isnull(Sum ( CASE  WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.NMONTODESEMB End ),  0 ) SKOtorgS,  " _
        & " Isnull(Sum ( CASE  WHEN SUBSTRING(C.cCtaCod,9,1)='2' THEN C.NMONTODESEMB* " & lnTipCambioFM & "  End ),  0 ) SKOtorgD  " _
        & " From " & psServConsol & "CreditoConsol  C " _
        & " WHERE C.nPrdEstado in (" & lsPignoraticio & ") " _
        & " AND  C.DFECVIG BETWEEN '" & Format(pdFecIni, "mm/dd/yyyy") & "' AND '" & Format(pdFecFin, "mm/dd/yyyy") & " 23:59' " _
        & " AND Substring(C.cCtaCod,6,3) in('305')   "
    
    
        sql = " SELECT"
        sql = sql & " COUNT( CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='1' THEN PRO.CCTACOD END )  NumOtorgS,"
        sql = sql & " COUNT( CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='2' THEN PRO.CCTACOD END )  NumOtorgd,"
        sql = sql & " ISNULL(SUM(CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='1' THEN COL.NMONTOCOL END),0) SKOtorgS,"
        sql = sql & " ROUND(ISNULL(SUM(CASE WHEN SUBSTRING(PRO.CCTACOD,9,1)='2' THEN COL.NMONTOCOL * " & lnTipCambioFM & " END),0),2) SKOtorgD"
        sql = sql & " FROM   COLOCACIONES COL"
        sql = sql & " INNER JOIN PRODUCTO PRO ON PRO.CCTACOD = COL.CCTACOD"
        sql = sql & " WHERE "
        sql = sql & " COL.DVIGENCIA BETWEEN '" & Format(pdFecIni, "mm/dd/yyyy") & "' AND '" & Format(pdFecFin, "mm/dd/yyyy") & " 23:59' "
        sql = sql & " AND Substring(PRO.cCtaCod,6,3) in('305')"
        sql = sql & " AND Substring(COL.cLineaCred,1,2) in('01')"
        
    Set rs = GetQuery(sql)
    lnNroCreOtorgS(1) = rs!NumOtorgS: lnMonCreOtorgS(1) = rs!SKOtorgS 'Soles
    lnNroCreOtorgS(2) = rs!NumOtorgD: lnMonCreOtorgS(2) = rs!SKOtorgD 'Dolares
    rs.Close
    'Fin Mes Anterior
    sql = "SELECT Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.cCtaCod End ) NumFinMesS , " _
        & " Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='2' THEN C.cCtaCod End ) NumFinMesD , " _
        & " Isnull(SUM( CASE WHEN substring(C.cCtaCod,9,1) = '1' THEN (C.nSaldoCap) End ), 0 ) SKFinMesS , " _
        & " Isnull(SUM( CASE WHEN substring(C.cCtaCod,9,1) = '2' THEN C.nSaldoCap * " & lnTipCambioFMAnt & " End ), 0 ) SKFinMesD " _
        & " From " & psServConsol & "CreditoSaldoConsol C " _
        & " JOIN  " & psServConsol & "CreditoConsol CC on C.cCtaCod = CC.cCtaCod " _
        & " WHERE C.nPrdEstado in (" & lsPignoraticio & ") And Datediff(d,dFecha,'" & Format(pdFecIni, "mm/dd/yyyy") & "') = 0 " _
        & "  " _
        & " AND Substring(C.cCtaCod,6,3) in('305') AND Substring(CC.cLineaCred,1,2) in('01')  "

    Set rs = GetQuery(sql)
    lnNroCreFMS(1) = rs!NumFinMesS: lnMonCreFMS(1) = rs!SKFinMesS 'Soles
    lnNroCreFMS(2) = rs!NumFinMesD: lnMonCreFMS(2) = rs!SKFinMesD 'Dolares
    
    rs.Close
    'Fin Mes
    sql = "SELECT Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.cCtaCod End ) NumCredS ,  " _
        & " Count( CASE WHEN SUBSTRING(C.cCtaCod,9,1)='2' THEN C.cCtaCod End ) NumCredD , " _
        & " Isnull(SUM( CASE WHEN substring(C.cCtaCod,9,1) = '1' THEN (C.nSaldoCap) End ), 0 ) SKCredS, " _
        & " Isnull(SUM( CASE WHEN substring(C.cCtaCod,9,1) = '2' THEN (C.nSaldoCap * " & lnTipCambioFM & ") End ), 0 ) SKCredD " _
        & " From " & psServConsol & "CreditoSaldoConsol C " _
        & " JOIN  " & psServConsol & "CreditoConsol CC on C.cCtaCod = CC.cCtaCod " _
        & " WHERE C.nPrdEstado in (" & lsPignoraticio & ") And Datediff(d,dFecha,'" & Format(pdFecFin, "mm/dd/yyyy") & "') = 0  " _
        & "  " _
        & " AND Substring(C.cCtaCod,6,3) in('305') AND Substring(CC.cLineaCred,1,2) in('01')  "

    Set rs = GetQuery(sql)
    lnNroCredS(1) = rs!NumCredS: lnMonCredS(1) = rs!SKCredS 'Soles
    lnNroCredS(2) = rs!NumCredD: lnMonCredS(2) = rs!SKCredD 'Dolares
    rs.Close

    lnNroCreCancelS(1) = lnNroCreFMS(1) + lnNroCreOtorgS(1) - lnNroCredS(1)
    lnNroCreCancelS(2) = lnNroCreFMS(2) + lnNroCreOtorgS(2) - lnNroCredS(2)
    lnMonCreCancelS(1) = lnMonCreFMS(1) + lnMonCreOtorgS(1) - lnMonCredS(1)
    lnMonCreCancelS(2) = lnMonCreFMS(2) + lnMonCreOtorgS(2) - lnMonCredS(2)
    
    ' Imprime
    lnFil = lnFil + 2
    xlHoja1.Cells(lnFil, lnCol) = "Nro Cred. Vigentes    " & Format(pdFecIni, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 1, lnCol) = "Nro Cred. Otorgados   " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 2, lnCol) = "Nro Cred. Cancelados  " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 3, lnCol) = "Nro Cred. Vigentes    " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 4, lnCol) = "Saldo Cred. Vigentes  " & Format(pdFecIni, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 5, lnCol) = "Monto Cred. Otorgados " & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 6, lnCol) = "Monto Cred. Cancelados" & Format(pdFecFin, "dd/mm/yyyy")
    xlHoja1.Cells(lnFil + 7, lnCol) = "Saldo Cred. Vigentes  " & Format(pdFecFin, "dd/mm/yyyy")

    xlHoja1.Cells(lnFil, lnCol + 1) = lnNroCreFMS(1)
    xlHoja1.Cells(lnFil + 1, lnCol + 1) = lnNroCreOtorgS(1)
    xlHoja1.Cells(lnFil + 2, lnCol + 1) = lnNroCreCancelS(1)
    xlHoja1.Cells(lnFil + 3, lnCol + 1) = lnNroCredS(1)
    xlHoja1.Cells(lnFil + 4, lnCol + 1) = lnMonCreFMS(1)
    xlHoja1.Cells(lnFil + 5, lnCol + 1) = lnMonCreOtorgS(1)
    xlHoja1.Cells(lnFil + 6, lnCol + 1) = lnMonCreCancelS(1)
    xlHoja1.Cells(lnFil + 7, lnCol + 1) = lnMonCredS(1)
    xlHoja1.Cells(lnFil, lnCol + 2) = lnNroCreFMS(2)
    xlHoja1.Cells(lnFil + 1, lnCol + 2) = lnNroCreOtorgS(2)
    xlHoja1.Cells(lnFil + 2, lnCol + 2) = lnNroCreCancelS(2)
    xlHoja1.Cells(lnFil + 3, lnCol + 2) = lnNroCredS(2)
    xlHoja1.Cells(lnFil + 4, lnCol + 2) = lnMonCreFMS(2)
    xlHoja1.Cells(lnFil + 5, lnCol + 2) = lnMonCreOtorgS(2)
    xlHoja1.Cells(lnFil + 6, lnCol + 2) = lnMonCreCancelS(2)
    xlHoja1.Cells(lnFil + 7, lnCol + 2) = lnMonCredS(2)
    
    'Suma el total por Moneda
    For i = 1 To 8
        xlHoja1.Range(xlHoja1.Cells(lnFil - 1 + i, lnCol + 3), xlHoja1.Cells(lnFil - 1 + i, lnCol + 3)).Formula = "=SUM(B" & lnFil - 1 + i & "+C" & lnFil - 1 + i & ")"
    Next i
    
    'Cuadro Resumido
    lnFil = 55
    xlHoja1.Cells(lnFil, lnCol) = "CREDITOS PYME RRPP Y R DE TECEROS"
    xlHoja1.Range(xlHoja1.Cells(lnFil, lnCol + 1), xlHoja1.Cells(lnFil, lnCol + 1)).Formula = "=" & sVar1
    xlHoja1.Cells(lnFil + 1, lnCol) = "CREDITOS PERSONALES RRPP "
    xlHoja1.Range(xlHoja1.Cells(lnFil + 1, lnCol + 1), xlHoja1.Cells(lnFil + 1, lnCol + 1)).Formula = "=" & sVar2
    xlHoja1.Cells(lnFil + 2, lnCol) = "CREDITOS FINANCIAMIENTO COFIDE"
    xlHoja1.Range(xlHoja1.Cells(lnFil + 2, lnCol + 1), xlHoja1.Cells(lnFil + 2, lnCol + 1)).Formula = "=" & sVar3
    xlHoja1.Cells(lnFil + 3, lnCol) = "CREDITOS PRENDARIOS"
    xlHoja1.Range(xlHoja1.Cells(lnFil + 3, lnCol + 1), xlHoja1.Cells(lnFil + 3, lnCol + 1)) = "=D51"
    xlHoja1.Cells(lnFil + 4, lnCol) = "TOTAL"
    xlHoja1.Range(xlHoja1.Cells(lnFil + 4, lnCol + 1), xlHoja1.Cells(lnFil + 4, lnCol + 1)).Formula = "=SUM(B" & lnFil & ":B" & lnFil + 3 & ")"
    RaiseEvent Progress(15, 15)
    xlHoja1.Range(xlHoja1.Cells(lnFil, 1), xlHoja1.Cells(lnFil + 4, 2)).Cells.Borders.LineStyle = xlOutside
    xlHoja1.Range(xlHoja1.Cells(lnFil, 1), xlHoja1.Cells(lnFil + 4, 2)).Cells.Borders.LineStyle = xlInside
    xlHoja1.Range(xlHoja1.Cells(lnFil, 1), xlHoja1.Cells(lnFil + 4, 2)).Font.Bold = True
    
    xlHoja1.PageSetup.CenterHorizontally = True
    xlHoja1.PageSetup.Zoom = 70
    xlHoja1.PageSetup.Orientation = xlLandscape
    xlAplicacion.Range("A1:Z100").Font.Size = 9
    
xlHoja1.SaveAs App.path & "\SPOOLER\" & lsArchivo
'Cierra el libro de trabajo
xlLibro.Close
' Cierra Microsoft Excel con el método Quit.
xlAplicacion.Quit
RaiseEvent CloseProgress
'Libera los objetos.
Set xlAplicacion = Nothing
Set xlLibro = Nothing
Set xlHoja1 = Nothing
Set oTipCambio = Nothing
'Screen.MousePointer = 0
MsgBox "Se ha Generado el Archivo " & lsArchivo & ".XLS Satisfactoriamente", vbInformation, "Aviso"
Exit Sub

ErrorExcel:
    MsgBox "Error Nº [" & Str(Err.Number) & "] " & Err.Description, vbInformation, "Aviso"
    xlLibro.Close
    ' Cierra Microsoft Excel con el método Quit.
    xlAplicacion.Quit
    'Libera los objetos.
    Set xlAplicacion = Nothing
    Set xlLibro = Nothing
    Set xlHoja1 = Nothing
    Set oTipCambio = Nothing






'****************************************





End Sub



Private Function ReporteInfo6Cab(ByVal nTipoCambio As Double) As String
Dim Titulo As String
Dim Tabula As Integer
Tabula = 10
Dim lsCadenaPrint As String
Titulo = "ESTRATIFICACION DE CARTERA MICROEMPRESARIAL"
lsCadenaPrint = lsCadenaPrint & "."
lsCadenaPrint = lsCadenaPrint & Space(Tabula - 1) & gsNomCmac & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("R E P O R T E   I N F O 6", 100) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena("(En Moneda Extranjera)", 100) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "INFORMACION AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "T.C.F. :" & Format(nTipoCambio, "#,#0.000") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena(Titulo, 100) & Chr(27) & Chr(70) & Chr(10) & Chr(10)
ReporteInfo6Cab = lsCadenaPrint
End Function

Public Function TipoDiaCambio() As Currency
Dim rs As New ADODB.Recordset
Dim Conecta As DConecta
Dim lsSQL As String
Set Conecta = New DConecta
lsSQL = "select nValFijo from tipoCambio Where dFecCamb=(Select MAX(dFecCamb) from tipoCambio)"
Conecta.AbreConexion
Set rs = Conecta.CargaRecordSet(lsSQL)
Conecta.CierraConexion
TipoDiaCambio = rs!nValFijo
End Function
Function FunDescProductoDetallada(pItem As Integer) As String
Dim lsDescProd As String
lsDescProd = "              "
    Select Case pItem
        Case 0
           lsDescProd = " Comercial Caja Pyme " ' " Comercial    "
        Case 1
           lsDescProd = " Comercial Institucional " '" Pyme         "
        Case 2
           lsDescProd = " Comercial Inmobiliario  " '" Dscto Plan.  "
        Case 3
           lsDescProd = " Mes Caja Pyme     " '" Aval PP.FF   "
        Case 4
           lsDescProd = " Planilla Cash " '" Aval CTS     "
        Case 5
           lsDescProd = " Consumo Prestamos Administrativos"
        Case 6
           lsDescProd = " Hipotecario    " '" Agricola     "
        Case 7
           lsDescProd = " Prendario    "
        Case 8
           lsDescProd = " Consumo Personales"
        Case 9
           lsDescProd = " Hipotecaja   "
        Case 10
           lsDescProd = " Hipotecario  " '" MiVivienda   "
    End Select
FunDescProductoDetallada = lsDescProd
End Function


Function NombreProducto(ByVal nProducto As Integer) As String
Dim rs As New ADODB.Recordset
Dim sql As String

sql = " Select cConsDescripcion from Constante where nConsCod =1001 and nConsValor=" & nProducto
Set rs = GetQuery(sql)
If rs.EOF And rs.BOF Then
    NombreProducto = "Prod Desconocido"
Else
    NombreProducto = rs!cConsDescripcion
End If

Set rs = Nothing
End Function

Private Function GetDatosReclasifica(ByVal psServerR As String, ByVal psConcepto As String, ByVal psMoneda As String, ByVal psProd As String, ByVal psSubProd As String, ByVal psAge As String, ByVal psFF As String, ByVal psPL As String, ByVal pnNorRef As Integer, ByVal pnRangoIni As Integer, ByVal pnRangoFin As Integer, Optional ByVal pbDemanda As Boolean = False) As Recordset
Dim sCampo1 As String
Dim sCampo2 As String
Dim sql As String
Dim prs As ADODB.Recordset
 
    sql = " SELECT COUNT(cCtaCod) AS Numero, " & _
          " ISNULL(SUM(" & IIf(psConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital, " & _
          IIf(psConcepto = "C", "ISNULL(SUM(nCapVencido),0)", "0") & " AS CapVencido " & _
          " FROM " & psServerR & "CreditoConsol C " & _
          " WHERE nPrDEstado in (" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc & " ) " & _
          " AND substring(cLineaCred,5,1 )= '" & Trim(psMoneda) & "'" & _
          " AND substring(cCtaCod,6,3) in ( " & psProd & ")" & _
          " AND substring(cCtaCod,4,2) = '" & Trim(psAge) & "'" & _
          " AND substring(cCtaCod,6,3) in ( " & psSubProd & ")" & _
          " AND substring(cLineaCred,1,4) IN ('" & Trim(psFF) & "')" & _
          " AND substring(cLineaCred, 6,1) IN ('" & Trim(psPL) & "')" & _
          " AND cRefinan = '" & IIf(pnNorRef = 0, "N", "R") & "'" & _
          " And ndiasAtraso >= " & Val(pnRangoIni) & _
          " And ndiasatraso <= " & Val(pnRangoFin) & _
          " And " & IIf(pbDemanda, "", " NOT ") & "EXISTS(SELECT cCtaCod FROM " & psServerR & "CreditoConsol C1 WHERE C1.cCtaCod = C.cCtaCod and C1.nPrdEstado in (" & gColocEstRecVigJud & "," & gColocEstRecVigCast & ")) "
   
    
   Set prs = New ADODB.Recordset
   
   Set GetDatosReclasifica = GetQuery(sql)
   Set prs = Nothing
End Function

Public Function ObtieneTablaCod(Cod As Integer) As Object
Dim rs As New ADODB.Recordset
Dim sql As String
sql = "select nConsValor cValor, cConsDescripcion from constante where nConsCod=" & Cod
sql = sql & "and nConsValor!=" & Cod

Conecta.AbreConexion
Set rs = Conecta.CargaRecordSet(sql)
Conecta.CierraConexion

If (rs.BOF And rs.EOF) Then
    Set rs = Nothing
    Set ObtieneTablaCod = rs
Else
    Set ObtieneTablaCod = rs
End If
End Function



Public Function ObtieneLineaCredito() As Object
Dim rs As New ADODB.Recordset
Dim Server As String
Dim sql As String

'Set rs = GetQuery("select nConsSisValor from Constsistema where nConsSisCod=43")
'Server = rs!nConsSisValor

sql = "select distinct(substring(cLineaCred,1,4)) cLineaCred, cDescripcion " & _
        " From ColocLineaCredito " & _
        " Where LEN(clineaCred) =4  " & _
        " Order by cLineaCred "
Set rs = GetQuery(sql)

If (rs.BOF And rs.EOF) Then
    Set rs = Nothing
    Set ObtieneLineaCredito = rs
Else
    Set ObtieneLineaCredito = rs
End If
End Function
Private Function ReporteINFO1Cab(ByVal pdDesde As Date, ByVal pdHasta As Date, ByVal pntCambio As Double, ByVal psNomCmac As String, Optional lbFinMes As Boolean = False) As String
Dim Tabula As Integer
Dim lsCadenaPrint As String
Dim TotalLineas As Integer
TotalLineas = 0
Tabula = 10
If lbFinMes = False Then
    lsCadenaPrint = "."
    lsCadenaPrint = lsCadenaPrint & Space(Tabula - 1) & psNomCmac & Chr(10)
    TotalLineas = TotalLineas + 1
    lsCadenaPrint = lsCadenaPrint & Chr(10)
    TotalLineas = TotalLineas + 1
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena("R E P O R T E    I N F O 1", 100) & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena(" (En Moneda Extranjera) ", 100) & Chr(10)
    TotalLineas = TotalLineas + 1
    lsCadenaPrint = lsCadenaPrint & Chr(10)
    TotalLineas = TotalLineas + 1
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & "INFORMACION  DESDE : " & Trim(pdDesde) & "  AL :" & Trim(pdHasta) & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "TIPO DE CAMBIO : " & pntCambio & Chr(27) & Chr(70) & Chr(10)
    TotalLineas = TotalLineas + 1
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(130, "-") & Chr(10)
    TotalLineas = TotalLineas + 1
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & "CREDITOS OTORGADOS" & Space(14) & "PYME" & Space(9) & _
                    "AGRICOLAS" & Space(10) & "PERSONAL" & Space(9) & "HIPOTECARIO" & Space(8) & _
                    "PRENDARIO" & Space(8) & "TOTAL" & Chr(27) & Chr(70) & Chr(10)
    TotalLineas = TotalLineas + 1
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(130, "-") & Chr(10)
    TotalLineas = TotalLineas + 1
Else
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(130, "-") & Chr(10)
    TotalLineas = TotalLineas + 1
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CadDerecha("CREDITOS VIGENTES ", 30) & CadDerecha("PYME", 18) & _
                    CadDerecha("AGRICOLAS", 18) & CadDerecha("PERSONAL", 18) & _
                    CadDerecha("HIPOTECARIO", 18) & CadDerecha("PRENDARIO", 18) & CadDerecha("TOTAL", 18) & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("AL FIN DE MES", 30) & Chr(27) & Chr(70) & Chr(10)
    TotalLineas = TotalLineas + 1
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(130, "-") & Chr(10)
    TotalLineas = TotalLineas + 1
End If
ReporteINFO1Cab = lsCadenaPrint
End Function


Public Function ConvierteLineaCred(ByVal psLinea As String, Optional ByVal psServer As String = "") As String
Dim sql As String
Dim lrRs As New ADODB.Recordset
sql = "select cCtaCont from " & psServer & "ColocLineaCreditoEquiv Where cLineaCred ='" & psLinea & "'"
Set lrRs = GetQuery(sql)

ConvierteLineaCred = IIf(IsNull(lrRs!cCtaCont), lrRs!cCtaCont, "")
End Function



Public Function CabCarteraCredxMoneda(pPag As Integer, pPlanCuentas As String) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
lsCad = lsCad & Chr(10)
lsCad = lsCad & gsNomCmac & Space(110) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(60) & "108701 - CARTERA DE CREDITOS x MONEDA AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
lsCad = lsCad & Space(68) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
lsCad = lsCad & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
lsCad = lsCad & " LINEA Credito " & Space(7) & "TOTAL COLOCACIONES  | " & Space(7) & "CARTERA VIGENTE  | " & Space(6)
lsCad = lsCad & "CARTERA VENCIDA 1| " & Space(6) & "CARTERA VENCIDA 2 | " & Space(6) & "COBRANZA JUDICIAL |  Mora " & Chr(10)
lsCad = lsCad & "               " & Space(7) & " Nro      Importe   | " & Space(7) & " Nro    Importe  | " & Space(6)
lsCad = lsCad & "Nro      Importe | " & Space(6) & "Nro    Importe    | " & Space(6) & "  Nro     Importe |   %   " & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
CabCarteraCredxMoneda = lsCad
End Function


Private Function CabRepCarteraProd_Venc(pPag As Integer, pTipoCambio As Single, pPlanCuentas As String, _
                                        Optional ByVal psCodRepo As String) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
lsCad = lsCad & Chr(10)
lsCad = lsCad & sNomCmac & Space(110) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(50) & psCodRepo & "108703 - RESUMEN POR PRODUCTO Y VENCIMIENTO AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
lsCad = lsCad & "TCF = " & ImpreFormat(pTipoCambio, 3, 3) & Space(58) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
'lsCad = lsCad & Space(70) & "( EN NUEVOS SOLES )" & Chr(10)
lsCad = lsCad & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
lsCad = lsCad & " LINEA Credito " & Space(7) & "TOTAL COLOCACIONES  | " & Space(7) & " CARTERA NORMAL   | " & Space(6)
lsCad = lsCad & "CARTERA VENCIDA 1| " & Space(5) & "CARTERA VENCIDA 2 | " & Space(6) & "COBRANZA JUDICIAL | Mora  " & Chr(10)
lsCad = lsCad & "               " & Space(7) & " Nro      Importe   | " & Space(7) & " Nro    Importe   | " & Space(6)
lsCad = lsCad & "Nro      Importe | " & Space(5) & "Nro    Importe    | " & Space(6) & "  Nro     Importe |  %    " & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
CabRepCarteraProd_Venc = lsCad
End Function


Private Function CabRepDevengados_Vig(pPag As Integer, pTipoCambio As Single, pPlanCuentas As String) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
'lsCad = lsCad & Chr(10)
lsCad = lsCad & gsNomCmac & Space(110) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(55) & "108706-INTERESES DEVENGADOS VIGENTES POR COBRAR AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
lsCad = lsCad & "TCF = " & ImpreFormat(pTipoCambio, 3, 3) & Space(58) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
'lsCad = lsCad & Space(70) & "( EN NUEVOS SOLES )" & Chr(10)
lsCad = lsCad & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
lsCad = lsCad & Space(30) & "NUEVOS SOLES" & Space(30) & "|" & Space(15) & "  DOLARES  " & Chr(10)
lsCad = lsCad & Space(20) & " Corto Plazo  |" & Space(5) & "Largo Plazo  |" & Space(10) & "Total   |"
lsCad = lsCad & Space(5) & "Corto Plazo  |" & Space(5) & "Largo Plazo  |" & Space(10) & " Total  |" & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
CabRepDevengados_Vig = lsCad
End Function



Private Function CabRepDevengados_Vencidos(pPag As Integer, pTipoCambio As Single, pPlanCuentas As String) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
'lsCad = lsCad & Chr(10)
lsCad = lsCad & sNomCmac & Space(110) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(47) & "108707 - INTERESES DEVENGADOS (VENCIDOS + COB. JUDICIAL) AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
lsCad = lsCad & "TCF = " & ImpreFormat(pTipoCambio, 3, 3) & Space(58) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
'lsCad = lsCad & Space(70) & "( EN NUEVOS SOLES )" & Chr(10)
lsCad = lsCad & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
lsCad = lsCad & Space(30) & "NUEVOS SOLES" & Space(30) & "|" & Space(15) & "  DOLARES  " & Chr(10)
lsCad = lsCad & Space(20) & " Corto Plazo  |" & Space(5) & "Largo Plazo  |" & Space(10) & "Total   |"
lsCad = lsCad & Space(5) & "Corto Plazo  |" & Space(5) & "Largo Plazo  |" & Space(10) & " Total  |" & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
CabRepDevengados_Vencidos = lsCad
End Function


Public Function CabImpReversionIntDeveng(pPag As Integer, pPlanCuentas As String, Optional pConcepto As String = "C") As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
'lsCad = lsCad & Chr(10)
lsCad = lsCad & gsNomCmac & Space(100) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(50) & "PROVISION DE CARTERA DE CREDITOS AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
lsCad = lsCad & Space(68) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
'lsCad = lsCad & Chr(10)
lsCad = lsCad & String(150, "=") & Chr(10)
lsCad = lsCad & " LINEA CREDITO " & Space(7) & "  TOTAL  CARTERA    |    PROVISION     |  PROV GENERICA  |  PROV ESPECIFICA | INT.DEVENG. VIG | INT.DEVENG. VEN |  " & Chr(10)
lsCad = lsCad & "               " & Space(7) & " Nro      Importe   |      Importe     |      Importe    |     Importe      |     Importe     |     Importe     |  " & Chr(10)
lsCad = lsCad & String(150, "=") & Chr(10)
CabImpReversionIntDeveng = lsCad
End Function
    
Private Function CabRepCarteraAgencia_Prod(pPag As Integer, pTipoCambio As Single, pPlanCuentas As String, _
            Optional pConcepto As String = "C", Optional pCodReporte As String) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
'lsCad = lsCad & Chr(10)
lsCad = lsCad & sNomCmac & Space(110) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(55) & pCodReporte & "-RESUMEN POR PRODUCTO Y AGENCIA AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & IIf(pConcepto = "D", "  ", "  ") & Chr(10)
lsCad = lsCad & "TCF = " & ImpreFormat(pTipoCambio, 3, 3) & Space(58) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
'lsCad = lsCad & Space(70) & "( EN NUEVOS SOLES )" & Chr(10)
'lsCad = lsCad & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
lsCad = lsCad & " AGENCIA" & Space(12) & " COMERCIAL  |" & Space(5) & "   MES     | " & Space(5) & " CONSUMO  | " & Space(5)
lsCad = lsCad & " PRENDARIO | " & Space(5) & " HIPOTEC   | " & Space(5) & " AGRICOL   | " & Space(5) & " ADMINIS   | " & "        TOTAL   |" & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
CabRepCarteraAgencia_Prod = lsCad
End Function


Private Function CabCarteraCredConsolidada(pPag As Integer, pTipoCambio As Single, pPlanCuentas As String) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
'lsCad = lsCad & Chr(10)
lsCad = lsCad & gsNomCmac & Space(110) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(58) & "CARTERA DE CREDITOS CONSOLIDADA AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
lsCad = lsCad & Space(68) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
lsCad = lsCad & "TCF. = " & ImpreFormat(pTipoCambio, 4, 3) & Space(55) & "( EN NUEVOS SOLES )" & Chr(10)
'lsCad = lsCad & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
lsCad = lsCad & " LINEA Credito " & Space(7) & "TOTAL COLOCACIONES  | " & Space(7) & "CARTERA VIGENTE  | " & Space(6)
lsCad = lsCad & "CARTERA VENCIDA 1| " & Space(6) & "CARTERA VENCIDA 2 | " & Space(6) & "COBRANZA JUDICIAL | Mora  " & Chr(10)
lsCad = lsCad & "               " & Space(7) & " Nro      Importe   | " & Space(7) & " Nro    Importe  | " & Space(6)
lsCad = lsCad & "Nro      Importe | " & Space(6) & "Nro    Importe    | " & Space(6) & "  Nro     Importe |  %    " & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
CabCarteraCredConsolidada = lsCad
End Function
Private Function CabRepCarteraAltoRiesgo(ByVal pPag As Integer, ByVal pTipCambio As Single) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
lsCad = lsCad & Chr(10)
lsCad = lsCad & gsNomCmac & Space(85) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(50) & "CARTERA DE ALTO RIESGO" & Space(30) & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
lsCad = lsCad & "TCF.= " & Format(pTipCambio, "#.00") & Space(40) & " ( EN NUEVOS SOLES )" & Chr(10)
lsCad = lsCad & Chr(10)
lsCad = lsCad & String(120, "=") & Chr(10)
lsCad = lsCad & " M E S " & Space(30) & "C A R T E R A" & Space(18) & "TOTAL" & Space(6) & "COLOCACIONES" & Space(6) & "INDICE" & Chr(10)
lsCad = lsCad & Space(16) & "Refinanciada" & Space(8) & "Vencida " & Space(8) & "Judicial" & Space(8) & "C.A.R "
lsCad = lsCad & Space(10) & "BRUTA" & Space(8) & "C.A.R" & Chr(10)
lsCad = lsCad & String(120, "=") & Chr(10)
CabRepCarteraAltoRiesgo = lsCad
End Function

Private Function CabRepResumenGarantias(pPag As Integer, pTipoCambio As Single, pPlanCuentas As String) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
'lsCad = lsCad & Chr(10)
lsCad = lsCad & gsNomCmac & Space(110) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(62) & "RESUMEN DE GARANTIAS AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
lsCad = lsCad & "TCF = " & ImpreFormat(pTipoCambio, 3, 3) & Space(58) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
'lsCad = lsCad & Space(70) & "( EN DOLARES - US $ )" & Chr(10)
lsCad = lsCad & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
lsCad = lsCad & Space(30) & "HIPOTECARIA " & Space(30) & "|" & Space(15) & "OTRAS GARANTIAS  " & Chr(10)
lsCad = lsCad & Space(20) & " Nuevos Soles |" & Space(5) & " Dolares     |" & Space(5) & " Total (US$) |"
lsCad = lsCad & Space(5) & "Nuevos Soles |" & Space(5) & "  Dolares   |" & Space(5) & " Total (US$) |" & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
CabRepResumenGarantias = lsCad
End Function

Private Function CabCarteraReclasificacion(pPag As Integer, pPlanCuentas As String, Optional pConcepto As String = "C") As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
'lsCad = lsCad & Chr(10)
lsCad = lsCad & sNomCmac & Space(120) & "Pagina: " & pPag & Chr(10)
If pConcepto = "C" Then
   lsCad = lsCad & Space(56) & "CARTERA DE CREDITOS PARA RECLASIFICACION AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
Else
   lsCad = lsCad & Space(56) & "INTERESES DEVENGADOS DE CREDITOS AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
End If
lsCad = lsCad & Space(68) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
'lsCad = lsCad & Chr(10)
lsCad = lsCad & String(160, "=") & Chr(10)
lsCad = lsCad & " LINEA      " & Space(3) & "    T O T A L       | " & Space(4) & "CARTERA VIGENTE   | " & Space(4)
lsCad = lsCad & "CARTERA VENCIDA 1| " & Space(4) & "CARTERA VENCIDA 2| " & Space(4) & "COB.JUD. ADM.AGENC| " & Space(4) & "COB.JUD. ADM.RECUP| " & IIf(pConcepto = "C", " Mora ", "") & Chr(10)

lsCad = lsCad & "            " & Space(3) & " Nro      Importe   | " & Space(4) & " Nro    Importe  | " & Space(4)
lsCad = lsCad & "Nro      Importe | " & Space(4) & "Nro    Importe     | " & Space(4) & "  Nro     Importe | " & Space(4) & "  Nro    Importe | " & IIf(pConcepto = "C", "  %   ", "") & Chr(10)
lsCad = lsCad & String(160, "=") & Chr(10)
CabCarteraReclasificacion = lsCad
End Function

Private Function CabRepIntereses_Prod(pPag As Integer, pTipoCambio As Single, pPlanCuentas As String, _
            Optional pConcepto As String = "C", Optional pCodReporte As String) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
'lsCad = lsCad & Chr(10)
lsCad = lsCad & sNomCmac & Space(110) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(55) & pCodReporte & "-RESUMEN POR PRODUCTO Y AGENCIA AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & IIf(pConcepto = "D", " INT. DEVENGADO ", " INT. SUSPENSO ") & Chr(10)
lsCad = lsCad & "TCF = " & ImpreFormat(pTipoCambio, 3, 3) & Space(58) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
'lsCad = lsCad & Space(70) & "( EN NUEVOS SOLES )" & Chr(10)
'lsCad = lsCad & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
lsCad = lsCad & " AGENCIA" & Space(12) & " COMERCIAL  |" & Space(5) & "   MES     | " & Space(5) & " CONSUMO  | " & Space(5)
lsCad = lsCad & " PRENDARIO | " & Space(5) & " HIPOTEC   | " & "        TOTAL   |" & Chr(10)
lsCad = lsCad & String(155, "=") & Chr(10)
CabRepIntereses_Prod = lsCad
End Function


Public Function HayDatos(ByVal pSQL As String) As Long
Dim rsData As New ADODB.Recordset
'rsData.Open pSQL, pConexion, adOpenStatic, adLockReadOnly, adCmdText
Conecta.AbreConexion
Set rsData = Conecta.CargaRecordSet(pSQL)
Conecta.CierraConexion

If rsData.EOF And rsData.BOF Then
   HayDatos = 0
Else
   HayDatos = rsData!NumCred
End If
rsData.Close
Set rsData = Nothing
End Function

Public Function HayDatosConec(ByVal pSQL As String, oCon As DConecta) As Long
Dim rsData As New ADODB.Recordset
'rsData.Open pSQL, pConexion, adOpenStatic, adLockReadOnly, adCmdText
'Conecta.AbreConexion
Set rsData = oCon.CargaRecordSet(pSQL)
'Conecta.CierraConexion

If rsData.EOF And rsData.BOF Then
   HayDatosConec = 0
Else
   HayDatosConec = rsData!NumCred
End If
rsData.Close
Set rsData = Nothing
End Function

Public Function GetFechaCierreMes() As Date
Dim sql As String
Dim rs As New ADODB.Recordset
sql = "select nConsSisValor from dbo.ConstSistema where nConsSisCod=14"
Conecta.AbreConexion
Set rs = Conecta.CargaRecordSet(sql)
Conecta.CierraConexion
GetFechaCierreMes = rs!nConssisValor
End Function


Private Function GetDatosReclasificaJudi(psServer As String, psConcepto As String, psMoneda As String, psProd As String, psSubProd As String, psAge As String, psFF As String, psPL As String, psCondJud As String, pbDemandaJud As Boolean) As Recordset
Dim sCampo1 As String
Dim sCampo2 As String
Dim sql As String
Dim prs As ADODB.Recordset
 
 
    sql = "SELECT COUNT(cCtaCod) AS Numero, " & _
          " ISNULL(SUM(" & IIf(psConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital " & _
          " FROM " & psServer & "CreditoConsol " & _
          " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND nSaldoCap > 0 AND  " & psCondJud & _
          " AND substring(cLineaCred,5,1 )= '" & Trim(psMoneda) & "'" & _
          " AND substring(cCtaCod,6,3) in ( " & psProd & ")" & _
          " AND substring(cCtaCod,4,2) = '" & Trim(psAge) & "'" & _
          " AND substring(cCtaCod,6,3) in ( " & psSubProd & ")" & _
          " AND substring(cLineaCred,1,4) IN ('" & Trim(psFF) & "')" & _
          " AND substring(cLineaCred, 6,1) IN ('" & Trim(psPL) & "')" & _
          " AND nDemanda = '" & IIf(pbDemandaJud = True, 1, 2) & "' "
   
   Set prs = New ADODB.Recordset
   Set prs = GetQuery(sql)
   Set GetDatosReclasificaJudi = prs
   Set prs = Nothing
End Function
Function nRepo108702_ImpCarteraCredConsolidada(ByVal pPlanCuentas As String, ByVal pTipoCambio As Single, ByVal psServConsol As String) As String

Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPla As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String
Dim lsDescP As String
Dim lsDescF As String
Dim lsDescAG As String

Dim liLineas As Long
Dim liDatos  As Long

Dim lnTCred As Single  ' *** General
Dim lnTSaldoCap As Double
Dim lnTNumVig As Single
Dim lnTCapVig As Double
Dim lnTNumVen1 As Integer
Dim lnTCapVen1  As Double
Dim lnTNumVen2 As Integer
Dim lnTCapVen2 As Double
Dim lnTNumJud As Integer
Dim lnTCapJud As Double

Dim lnTCredT As Single  ' *** Total
Dim lnTSaldoCapT As Double
Dim lnTNumVigT As Single
Dim lnTCapVigT As Double
Dim lnTNumVen1T As Long
Dim lnTCapVen1T  As Double
Dim lnTNumVen2T As Integer
Dim lnTCapVen2T As Double
Dim lnTNumJudT As Integer
Dim lnTCapJudT As Double

Dim lnTCredM As Single  ' *** Moneda
Dim lnTSaldoCapM As Double
Dim lnTNumVigM As Single
Dim lnTCapVigM As Double
Dim lnTNumVen1M As Integer
Dim lnTCapVen1M  As Double
Dim lnTNumVen2M As Integer
Dim lnTCapVen2M As Double
Dim lnTNumJudM As Integer
Dim lnTCapJudM As Double

Dim lnTCredF As Single  ' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double
Dim lnTNumVigF As Single
Dim lnTCapVigF As Double
Dim lnTNumVen1F As Long
Dim lnTCapVen1F  As Double
Dim lnTNumVen2F As Integer
Dim lnTCapVen2F As Double
Dim lnTNumJudF As Integer
Dim lnTCapJudF As Double

Dim lnTCredAG As Single  ' *** Agencia
Dim lnTSaldoCapAG As Double
Dim lnTNumVigAG As Single
Dim lnTCapVigAG As Double
Dim lnTNumVen1AG As Integer
Dim lnTCapVen1AG  As Double
Dim lnTNumVen2AG As Integer
Dim lnTCapVen2AG As Double
Dim lnTNumJudAG As Integer
Dim lnTCapJudAG As Double

Dim lnTCredPr As Single  ' *** Producto
Dim lnTSaldoCapPr As Double
Dim lnTNumVigPr As Single
Dim lnTCapVigPr As Double
Dim lnTNumVen1Pr As Integer
Dim lnTCapVen1Pr  As Double
Dim lnTNumVen2Pr As Integer
Dim lnTCapVen2Pr As Double
Dim lnTNumJudPr As Integer
Dim lnTCapJudPr As Double

Dim lnTCredPrM As Single  ' *** Producto Moneda
Dim lnTSaldoCapPrM As Double
Dim lnTNumVigPrM As Single
Dim lnTCapVigPrM As Double
Dim lnTNumVen1PrM As Integer
Dim lnTCapVen1PrM  As Double
Dim lnTNumVen2PrM As Integer
Dim lnTCapVen2PrM As Double
Dim lnTNumJudPrM As Integer
Dim lnTCapJudPrM As Double

Dim lsCreditosVigentes As String
Dim lsCreditosPignoraticio As String
Dim lsCreditosJudicial As String

Dim i As Integer
Dim lsRtfImpG As String

Dim lbSiCambio As Boolean
Dim cadena As String

Dim lnCapVencido As Currency  'Para los consumo

Dim prod(7) As String
Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsRtfImp As String
Dim cpag As Integer
Dim lSSQL9 As String
Dim lnCredAdmin As Integer ' Bandera Para Cred Admin

'Screen.MousePointer = 13

lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
'lsCreditosPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
lsCreditosPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
lsCreditosJudicial = gColocEstRecVigJud & ",2205"

' Para Cada Producto

'prod(0) = " '101' "  ' Comercial
'prod(1) = " '201' "  ' Pyme-Mes
'prod(2) = " '301','302','303','304' "  ' Personales
'prod(3) = " '102','202' "  ' Agricola
'prod(4) = " '305'" ' Pignoraticio
'prod(5) = " '320'" ' Administrativos
'prod(6) = " '401'" ' Hipotecaja
'prod(7) = " '423'" ' MiVivienda

'04/12/06--------------------------
prod(0) = "101, 102"  ' Comerciales
prod(1) = "201, 202" ' Pyme
prod(2) = "301, 302, 303, 304, 320"  ' Consumo
prod(3) = " 305" ' Pignoraticio
prod(4) = " 401,403,423" ' Hipotecaja

'prod(0) = RecuperaCadenaTipoProducto("1")         ' Comercial
'prod(1) = RecuperaCadenaTipoProducto("2")        ' Pyme-Mes
'prod(2) = RecuperaCadenaTipoProducto("3")        ' Consumo
'prod(3) = " '305' "       ' Prendario
''prod(4) = " '423'"        ' Hipotecario
''prod(5) = " '202' "       ' Agricola
''prod(6) = " '320' "       ' Administrativo
'prod(4) = RecuperaCadenaTipoProducto("4") ' Hipotecario
'--------------------------------------------------

lbSiCambio = False
lsRtfImp = ""
cpag = 1

cadena = ""
'Cadena = ValorMoneda & ValorNorRefPar & ValorProducto

'===== Verificar si existen datos para el reporte

lSSQL9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol  " & _
       "Where nPrdEstado in (" & lsCreditosVigentes & "," & lsCreditosJudicial & "," & lsCreditosPignoraticio & " ) "

Conecta.AbreConexion
Set Reg9 = Conecta.CargaRecordSet(lSSQL9)
Conecta.CierraConexion

If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then  ' General
    '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    Set rsFF = ObtieneLineaCredito 'Fuente Financiamiento
   
    'ImpCarteraCredConsolidada = True
    
    lsRtfImp = lsRtfImp & CabCarteraCredConsolidada(cpag, pTipoCambio, pPlanCuentas)
    liLineas = 5
                
        If rsFF.EOF And rsFF.BOF Then 'Fuente Financ
        Else
            rsFF.MoveFirst
            RaiseEvent ShowProgress
            Do While Not rsFF.EOF 'Fuente Financ
               lnTCredF = 0: lnTSaldoCapF = 0
               lnTNumVigF = 0: lnTCapVigF = 0
               lnTNumVen1F = 0: lnTCapVen1F = 0
               lnTNumVen2F = 0: lnTCapVen2F = 0
               lnTNumJudF = 0: lnTCapJudF = 0
               lsDescF = Mid(rsFF!CDescripcion, 1, 25)
               '=========== CREDITOS VIGENTES PARA UNA FUENTE FINANCIAMIENTO =============
               Sql9 = " SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
                      " WHERE nPrdEstado in ( " & lsCreditosVigentes & "," & lsCreditosJudicial & ", " & lsCreditosPignoraticio & ") " & _
                      " AND substring(cLineaCred,1, 4) IN ('" & Trim(rsFF!cLineaCred) & "')"
               'SQL9B = "SELECT Count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
               '        "WHERE nPrdEstado =" & gColocEstRecVigJud & "  AND nSaldoCap > 0 " & _
               '        "AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')"
               If HayDatos(Sql9) > 0 Then  ' De la Fuente Financ
                    
                  ' ****************************
                  ' ****  Verifica Si Cambio pagina
                  If liLineas >= 55 Then 'Para el control de salto de página
                     lsRtfImp = lsRtfImp & Chr(12)
                     cpag = cpag + 1
                     lsRtfImp = lsRtfImp & CabCarteraCredConsolidada(cpag, pTipoCambio, pPlanCuentas)
                     liLineas = 5
                  End If
                    
                  lsRtfImp = lsRtfImp & Chr(27) & Chr(69) & "**" & lsDescF & Chr(27) & Chr(70) & Chr(10)
                  liLineas = liLineas + 1
                       
                  For i = 0 To 4 '7  'Para Cada Producto
                         
                     lnTCredPr = 0:     lnTSaldoCapPr = 0
                     lnTNumVigPr = 0:   lnTCapVigPr = 0
                     lnTNumVen1Pr = 0:  lnTCapVen1Pr = 0
                     lnTNumVen2Pr = 0:  lnTCapVen2Pr = 0
                     lnTNumJudPr = 0:   lnTCapJudPr = 0
                          
                     Select Case i
                       Case 0
                          lsDescPr = " Comercial    "
                       Case 1
                          lsDescPr = " Pyme         "
                       Case 2
                          lsDescPr = " Consumo     "
                       Case 3
                          lsDescPr = " Pignoraticio "
                       Case 4
                          lsDescPr = " MiVivienda   "
                       'Case 5
                       '   lsDescPr = " Administrat  "
                       'Case 6
                       '   lsDescPr = " Hipotecario  "
                       'Case 7
                       '   lsDescPr = " MiVivienda   "
                          
                     End Select
                     ' **** Para Cada Moneda
                     RsM.MoveFirst
                     lnTCredPrM = 0:     lnTSaldoCapPrM = 0
                     lnTNumVigPrM = 0:   lnTCapVigPrM = 0
                     lnTNumVen1PrM = 0:  lnTCapVen1PrM = 0
                     lnTNumVen2PrM = 0:  lnTCapVen2PrM = 0
                     lnTNumJudPrM = 0:   lnTCapJudPrM = 0
                     If RsM.EOF And RsM.BOF Then
                     Else
                        Do While Not RsM.EOF
                          
                           '=========== CREDITOS DE LA MONEDA =============
                            Sql9 = "SELECT Count(cCtaCod) AS NumCred from " & psServConsol & "CreditoConsol " & _
                                " WHERE nPrdEstado in ( " & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & ")" & _
                                " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                             
                            If HayDatos(Sql9) > 0 Then ' Para Producto
                               '=================================================
                               '===== Total Cartera  Producto de MONEDA  ======
                               '  Creditos ------------
                               Sql9 = "SELECT COUNT(cCtaCod) AS Numero, SUM(nSaldoCap) AS Capital " & _
                                      " from " & psServConsol & "CreditoConsol " & _
                                      " WHERE nPrdEstado in (  " & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & ") " & _
                                      " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                      " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                      " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                      
                               Conecta.AbreConexion
                               Set Reg9 = Conecta.CargaRecordSet(Sql9)
                               Conecta.CierraConexion
                               
                               lnTCredPr = Reg9!Numero
                               lnTSaldoCapPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                               Reg9.Close
                               Set Reg9 = Nothing
                                        
                               '=================================================
                               '====== Cartera Vigente  Producto de Agencia  ===
                               Select Case i
                                   
                                   Case 0  ' Comercial   ******************
                                     'If pPlanCuentas = "1" Then
                                     '   lnRangoIni = -9999   ' Comerciales
                                     '   lnRangoFin = 15
                                     'Else
                                        lnRangoIni = -9999   ' Comerciales
                                        lnRangoFin = 15
                                     'End If
                                   
                                     Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                           " SUM(nSaldoCap) AS Capital " & _
                                           " from " & psServConsol & "CreditoConsol " & _
                                           " WHERE nPrdEstado in ( " & lsCreditosVigentes & " ) " & _
                                           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                           " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                           " AND substring(cCtaCod,6,3) in (" & prod(i) & ")" & _
                                           " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                           " And ndiasatraso <= " & Val(lnRangoFin)
                                           
                                    Conecta.AbreConexion
                                    Set Reg9 = Conecta.CargaRecordSet(Sql9)
                                    Conecta.CierraConexion
                                     
                                     lnTNumVigPr = Reg9!Numero
                                     lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                     Reg9.Close
                                     Set Reg9 = Nothing
                                   
                                   Case 1 ', 2 ', 3   ' Pyme / Agricola   ******************
                                     'If pPlanCuentas = "1" Then
                                     '    lnRangoIni = -9999   ' MicroEmpresa
                                     '    lnRangoFin = 30
                                     'Else
                                         lnRangoIni = -9999   ' MicroEmpresa
                                         lnRangoFin = 30
                                     'End If
                                     
                                     Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                           " SUM(nSaldoCap) AS Capital " & _
                                           " from " & psServConsol & "CreditoConsol " & _
                                           " WHERE nPrdEstado in ( " & lsCreditosVigentes & " ) " & _
                                           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                           " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                           " AND substring(cCtaCod,6,3) in (" & prod(i) & ")" & _
                                           " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                           " And ndiasatraso <= " & Val(lnRangoFin)
                                     Conecta.AbreConexion
                                     Set Reg9 = Conecta.CargaRecordSet(Sql9)
                                     Conecta.CierraConexion
                                    
                                     lnTNumVigPr = Reg9!Numero
                                     lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                     Reg9.Close
                                     Set Reg9 = Nothing
                                           
                                  Case 2, 4 ', 5, 6, 7  ' Consumo / Administ / Hipotecaja / MiVivienda   **********
                                     If pPlanCuentas = "1" Then
                                         lnRangoIni = -9999
                                         lnRangoFin = 30
                                     Else
                                         lnRangoIni = -9999
                                         lnRangoFin = 30
                                     End If
                                     
                                     Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                           " SUM(nSaldoCap) AS Capital " & _
                                           " from " & psServConsol & "CreditoConsol " & _
                                           " WHERE nPrdEstado in ( " & lsCreditosVigentes & " ) " & _
                                           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                           " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                           " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                           " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                           " And ndiasatraso <= " & Val(lnRangoFin)
                                           
                                     Conecta.AbreConexion
                                      Set Reg9 = Conecta.CargaRecordSet(Sql9)
                                     Conecta.CierraConexion
                                     
                                     lnTNumVigPr = Reg9!Numero
                                     lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                     Reg9.Close
                                     Set Reg9 = Nothing
                                           
                                  Case 3 '4  ' Prendario  *************************
                                     'If Trim(rsFF!cLineaCred) = "0101" Then  ' Si es RR PP
                                        lnRangoIni = -999
                                        lnRangoFin = 30
                                        Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                            " SUM(nSaldoCap) AS Capital " & _
                                           " from " & psServConsol & "CreditoConsol " & _
                                           " WHERE nPrdEstado in ( " & lsCreditosPignoraticio & " ) " & _
                                           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                           " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                           " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                           " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                           " And ndiasAtraso <= " & Val(lnRangoFin)
                                           
                                         Conecta.AbreConexion
                                         Set Reg9 = Conecta.CargaRecordSet(Sql9)
                                         Conecta.CierraConexion
                                         
                                         lnTNumVigPr = Reg9!Numero
                                         lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                         Reg9.Close
                                         Set Reg9 = Nothing
                                     'End If
                                  
                                 '*********
                                   Case Else
                                       lnTNumVigPr = 0
                                       lnTCapVigPr = 0
                                   
                               End Select
                               '=================================================
                               '====== Cartera Vencida 1 Producto de Agencia  ===
                               Select Case i
                                   Case 0  ' Comercial  ******************
                                   '  If pPlanCuentas = "1" Then
                                   '      lnRangoIni = 16   ' Comerciales
                                   '      lnRangoFin = 120
                                   '  Else
                                         lnRangoIni = 16   ' Comerciales
                                         lnRangoFin = 9999
                                   '  End If
                                   
                                     Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                           " SUM(nSaldoCap) AS Capital " & _
                                           " from " & psServConsol & "CreditoConsol " & _
                                           " WHERE nPrdEstado in ( " & lsCreditosVigentes & " ) " & _
                                           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                           " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                           " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                           " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                           " And ndiasatraso <= " & Val(lnRangoFin)
                                           
                                      Conecta.AbreConexion
                                      Set Reg9 = Conecta.CargaRecordSet(Sql9)
                                      Conecta.CierraConexion
                                        
                                     lnTNumVen1Pr = Reg9!Numero
                                     lnTCapVen1Pr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                     Reg9.Close
                                     Set Reg9 = Nothing
                                   
                                   Case 1 ', 3   ' Pyme / Agricola   ******************
                                     'If pPlanCuentas = "1" Then
                                     '    lnRangoIni = 31   ' MicroEmpresa
                                     '    lnRangoFin = 120
                                     'Else
                                         lnRangoIni = 31   ' MicroEmpresa
                                         lnRangoFin = 9999
                                     'End If
                                     
                                     Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                           " SUM(nSaldoCap) AS Capital " & _
                                           " from " & psServConsol & "CreditoConsol " & _
                                           " WHERE nPrdEstado in ( " & lsCreditosVigentes & " ) " & _
                                           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                           " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                           " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                           " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                           " And ndiasatraso <= " & Val(lnRangoFin)
                                           
                                     Conecta.AbreConexion
                                     Set Reg9 = Conecta.CargaRecordSet(Sql9)
                                     Conecta.CierraConexion
                                     
                                     lnTNumVen1Pr = Reg9!Numero
                                     lnTCapVen1Pr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                     Reg9.Close
                                     Set Reg9 = Nothing
                                           
                                  Case 2, 4 '5, 6, 7     ' Consumo / Administrativos /Hipotecaja / MiVivienda  *****************  OJO
                                  
                                     'If pPlanCuentas = "1" Then
                                     '    lnRangoIni = 31   ' Capital Vencido OJO
                                     '    lnRangoFin = 90
                                     'Else
                                         lnRangoIni = 31   ' Capital Vencido OJO
                                         lnRangoFin = 90
                                     'End If
                                  
                                     Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                           " SUM(nSaldoCap) AS Capital, " & _
                                           " SUM(nCapVencido) AS CapVencido " & _
                                           " from " & psServConsol & "CreditoConsol " & _
                                           " WHERE nPrdEstado in ( " & lsCreditosVigentes & " ) " & _
                                           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                           " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                           " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                           " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                           " And ndiasatraso <= " & Val(lnRangoFin)
                                           
                                      Conecta.AbreConexion
                                      Set Reg9 = Conecta.CargaRecordSet(Sql9)
                                      Conecta.CierraConexion
                                     
                                     lnTNumVen1Pr = Reg9!Numero
                                     lnTCapVen1Pr = IIf(IsNull(Reg9!CapVencido), 0, Reg9!CapVencido)
                                     ' Paso (Sald Cap - Cap Venc) a Vigentes
                                     lnTCapVigPr = lnTCapVigPr + IIf(IsNull(Reg9!Capital), 0, Reg9!Capital) - IIf(IsNull(Reg9!CapVencido), 0, Reg9!CapVencido)
                                     Reg9.Close
                                     Set Reg9 = Nothing
                                     
                                  Case 3 '4  ' Prendario  *************************
                                     
                                        lnRangoIni = 31
                                        lnRangoFin = 999
                                        Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                            " SUM(nSaldoCap) AS Capital " & _
                                           " from " & psServConsol & "CreditoConsol " & _
                                           " WHERE nPrdEstado in ( " & lsCreditosPignoraticio & " ) " & _
                                           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                           " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                           " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                           " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                           " And ndiasAtraso <= " & Val(lnRangoFin)
                                         
                                         Conecta.AbreConexion
                                         Set Reg9 = Conecta.CargaRecordSet(Sql9)
                                         Conecta.CierraConexion
                                         
                                         lnTNumVen1Pr = Reg9!Numero
                                         lnTCapVen1Pr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                         Reg9.Close
                                         Set Reg9 = Nothing
                                  
                                  Case Else
                                       lnTNumVen1Pr = 0
                                       lnTCapVen1Pr = 0
                                  
                               End Select
                               
                               '=================================================
                               '====== Cartera Vencida 2 Producto de Agencia  ===
                               Select Case i
                                           
                                  Case 2, 4 '5, 6, 7    ' Consumo / Hipotecaja  / MiVivienda ***********  OJO
                                  
                                     'If pPlanCuentas = "1" Then
                                     '    lnRangoIni = 121  '
                                     '    lnRangoFin = 999
                                     'Else
                                         lnRangoIni = 91   ' Saldo Capital
                                         lnRangoFin = 9999
                                     'End If
                                  
                                     Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                           " SUM(nSaldoCap) AS Capital " & _
                                           " from " & psServConsol & "CreditoConsol " & _
                                           " WHERE nPrdEstado in ( " & lsCreditosVigentes & ") " & _
                                           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                           " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                           " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                           " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                           " And ndiasatraso <= " & Val(lnRangoFin)
                                           
                                     Conecta.AbreConexion
                                     Set Reg9 = Conecta.CargaRecordSet(Sql9)
                                     Conecta.CierraConexion
                                     
                                     lnTNumVen2Pr = Reg9!Numero
                                     lnTCapVen2Pr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                     Reg9.Close
                                     Set Reg9 = Nothing
                                 
                                  Case Else
                                      lnTNumVen2Pr = 0
                                      lnTCapVen2Pr = 0
                                       
                               End Select
                               
                               '=================================================
                               '====== En Asesoria Legal Producto de Agencia  ===
                                Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                      " SUM(nSaldoCap) AS Capital " & _
                                      " from " & psServConsol & "CreditoConsol " & _
                                      " WHERE nPrdEstado in (" & lsCreditosJudicial & " ) " & _
                                      " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                      " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                      " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                
                                Conecta.AbreConexion
                                Set Reg9 = Conecta.CargaRecordSet(Sql9)
                                Conecta.CierraConexion
                                
                                lnTNumJudPr = Reg9!Numero
                                lnTCapJudPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                Reg9.Close
                                Set Reg9 = Nothing
                               
                               ' *******************************************
                               ' ***** Asigna Valores al Producto Moneda ***
                               ' ***** y el cambio de moneda   *************
                               lnTCredPrM = lnTCredPrM + lnTCredPr
                               lnTSaldoCapPrM = lnTSaldoCapPrM + IIf(Trim(RsM!nConsValor) = "1", lnTSaldoCapPr, lnTSaldoCapPr * pTipoCambio)
                               lnTNumVigPrM = lnTNumVigPrM + lnTNumVigPr
                               lnTCapVigPrM = lnTCapVigPrM + IIf(Trim(RsM!nConsValor) = "1", lnTCapVigPr, lnTCapVigPr * pTipoCambio)
                               lnTNumVen1PrM = lnTNumVen1PrM + lnTNumVen1Pr
                               lnTCapVen1PrM = lnTCapVen1PrM + IIf(Trim(RsM!nConsValor) = "1", lnTCapVen1Pr, lnTCapVen1Pr * pTipoCambio)
                               lnTNumVen2PrM = lnTNumVen2PrM + lnTNumVen2Pr
                               lnTCapVen2PrM = lnTCapVen2PrM + IIf(Trim(RsM!nConsValor) = "1", lnTCapVen2Pr, lnTCapVen2Pr * pTipoCambio)
                               lnTNumJudPrM = lnTNumJudPrM + lnTNumJudPr
                               lnTCapJudPrM = lnTCapJudPrM + IIf(Trim(RsM!nConsValor) = "1", lnTCapJudPr, lnTCapJudPr * pTipoCambio)
                               ' *****  Imprime


                            End If  ' Fin de Si encuentra Datos Producto Moned
                            
                            RsM.MoveNext
                        Loop ' ---- Moneda de Producto
                        
                     End If '--- Moneda de Producto
                    
                    ' **********************
                    ' *****  Imprime
                    If lnTCredPrM > 0 Then
                        lsRtfImp = lsRtfImp & " " & lsDescPr
                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPrM, 10, 0, True)
                        lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPrM, 13, 2, True) & " | "
                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigPrM, 8, 0, True)
                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPrM, 13, 2, True) & " | "
                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1PrM, 7, 0, True)
                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1PrM, 12, 2, True) & " | "
                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2PrM, 7, 0, True)
                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2PrM, 12, 2, True) & " | "
                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudPrM, 7, 0, True)
                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudPrM, 12, 2, True) & " | "
                        If lnTSaldoCapPrM <> 0 Then
                            lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapPrM - lnTCapVigPrM) / lnTSaldoCapPrM) * 100, 2), 3, 2) & "%"
                        Else
                            lsRtfImp = lsRtfImp & " 0 %"
                        End If
                        lsRtfImp = lsRtfImp & Chr(10)
                        liLineas = liLineas + 1
                    End If
                    ' ************ Asigna Valores a Fuente Financ
                    lnTCredF = lnTCredF + lnTCredPrM
                    lnTSaldoCapF = lnTSaldoCapF + lnTSaldoCapPrM
                    lnTNumVigF = lnTNumVigF + lnTNumVigPrM
                    lnTCapVigF = lnTCapVigF + lnTCapVigPrM
                    lnTNumVen1F = lnTNumVen1F + lnTNumVen1PrM
                    lnTCapVen1F = lnTCapVen1F + lnTCapVen1PrM
                    lnTNumVen2F = lnTNumVen2F + lnTNumVen2PrM
                    lnTCapVen2F = lnTCapVen2F + lnTCapVen2PrM
                    lnTNumJudF = lnTNumJudF + lnTNumJudPrM
                    lnTCapJudF = lnTCapJudF + lnTCapJudPrM
                             
                                
                 Next i   ' Para el Sgte Producto

                    
                    ' **********************
                    ' ************ Asigna Valores al Total
                    lnTCredT = lnTCredT + lnTCredF
                    lnTSaldoCapT = lnTSaldoCapT + lnTSaldoCapF
                    lnTNumVigT = lnTNumVigT + lnTNumVigF
                    lnTCapVigT = lnTCapVigT + lnTCapVigF
                    lnTNumVen1T = lnTNumVen1T + lnTNumVen1F
                    lnTCapVen1T = lnTCapVen1T + lnTCapVen1F
                    lnTNumVen2T = lnTNumVen2T + lnTNumVen2F
                    lnTCapVen2T = lnTCapVen2T + lnTCapVen2F
                    lnTNumJudT = lnTNumJudT + lnTNumJudF
                    lnTCapJudT = lnTCapJudT + lnTCapJudF
                    ' *****  Imprime
                    'lsRTfImp = lsRTfImp & Chr(10)
                    lsRtfImp = lsRtfImp & String(155, "-") & Chr(10)
                    lsRtfImp = lsRtfImp & Mid(lsDescF, 1, 15)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCredF, 10, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapF, 13, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigF, 8, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigF, 13, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1F, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1F, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2F, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2F, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudF, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudF, 12, 2, True) & " | "
                    If lnTSaldoCapF = 0 Then
                        lsRtfImp = lsRtfImp & ImpreFormat(0, 3, 2) & "%"
                    Else
                        lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapF - lnTCapVigF) / lnTSaldoCapF) * 100, 2), 3, 2) & "%"
                    End If
                    lsRtfImp = lsRtfImp & Chr(10)
                    lsRtfImp = lsRtfImp & String(155, "_") & Chr(10)
                    lsRtfImp = lsRtfImp & Chr(10)
                    liLineas = liLineas + 5
                       
                       
                End If  ' Fin de Fuente financiamiento
                RaiseEvent Progress(rsFF.Bookmark, rsFF.RecordCount)
                rsFF.MoveNext
                  ' Arturo
            Loop  ' De la Fuente Financiamiento
            
                    
            ' **********************
            ' *****  Imprime Totales
            'lsRTfImp = lsRTfImp & Chr(10)
            lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
            lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
            lsRtfImp = lsRtfImp & " TOTAL         "
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCredT, 10, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapT, 13, 2, True) & " | "
            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigT, 8, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigT, 13, 2, True) & " | "
            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1T, 7, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1T, 12, 2, True) & " | "
            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2T, 7, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2T, 12, 2, True) & " | "
            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudT, 7, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudT, 12, 2, True) & " | "
            lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapT - lnTCapVigT) / IIf(lnTSaldoCapT = 0, 1, lnTSaldoCapT)) * 100, 2), 3, 2) & "%"
            lsRtfImp = lsRtfImp & Chr(27) & Chr(70)
            lsRtfImp = lsRtfImp & Chr(10)
            lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
            lsRtfImp = lsRtfImp & Chr(10)
            liLineas = liLineas + 4
            
            '****** Imprime Resumen
            lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
            lsRtfImp = lsRtfImp & Space(45) & "*******************  RESUMEN  *******************" & Chr(10)
            lsRtfImp = lsRtfImp & Space(45) & "CREDITOS NORMALES              " & ImpreFormat(lnTCapVigT, 13, 2, True) & Space(5) & "(A)" & Chr(10)
            lsRtfImp = lsRtfImp & Space(45) & "CREDITOS VENCIDOS              " & ImpreFormat(lnTCapVen1T + lnTCapVen2T, 13, 2, True) & Space(5) & "(B)" & Chr(10)
            lsRtfImp = lsRtfImp & Space(45) & "CREDITOS COBR JUDIC.           " & ImpreFormat(lnTCapJudT, 13, 2, True) & Space(5) & "(C)" & Chr(10)
            lsRtfImp = lsRtfImp & Space(45) & "-------------------------------------------------" & Chr(10)
            lsRtfImp = lsRtfImp & Space(45) & "TOTAL COLOCACIONES BRUTAS S/.  " & ImpreFormat(lnTSaldoCapT, 13, 2, True) & Space(5) & "(D)" & Chr(10) & Chr(10)
            lsRtfImp = lsRtfImp & Space(45) & "MORA TOTAL : (B + C) / D  =    " & Space(10) & ImpreFormat(Round(((lnTCapVen1T + lnTCapVen2T + lnTCapJudT) / IIf(lnTSaldoCapT = 0, 1, lnTSaldoCapT)) * 100, 2), 3, 2) & " %" & Chr(10)
            lsRtfImp = lsRtfImp & Chr(27) & Chr(70)

        End If
    RsM.Close
    Set RsM = Nothing
    RaiseEvent CloseProgress
Else
    
    nRepo108702_ImpCarteraCredConsolidada = ""
End If '--- liDatos - General
lsRtfImpG = lsRtfImp ' Asigna el valor
nRepo108702_ImpCarteraCredConsolidada = lsRtfImpG
Screen.MousePointer = 1

End Function

Public Function nRepo108703_ImpRepCarteraProd_Venc(ByVal pPlanCuentas As String, ByVal pTipoCambio As Single, ByVal psServConsol As String) As String
Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPla As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String
Dim lsDescP As String
Dim lsDescF As String
Dim lsDescAG As String

Dim liLineas As Long
Dim liDatos  As Long

Dim lnTCred As Single  ' *** General
Dim lnTSaldoCap As Double
Dim lnTNumVig As Single
Dim lnTCapVig As Double
Dim lnTNumVen1 As Integer
Dim lnTCapVen1  As Double
Dim lnTNumVen2 As Integer
Dim lnTCapVen2 As Double
Dim lnTNumJud As Integer
Dim lnTCapJud As Double

Dim lnTCredT As Single  ' *** Total
Dim lnTSaldoCapT As Double
Dim lnTNumVigT As Single
Dim lnTCapVigT As Double
Dim lnTNumVen1T As Integer
Dim lnTCapVen1T  As Double
Dim lnTNumVen2T As Integer
Dim lnTCapVen2T As Double
Dim lnTNumJudT As Integer
Dim lnTCapJudT As Double

Dim lnTCredM As Single  ' *** Moneda
Dim lnTSaldoCapM As Double
Dim lnTNumVigM As Single
Dim lnTCapVigM As Double
Dim lnTNumVen1M As Integer
Dim lnTCapVen1M  As Double
Dim lnTNumVen2M As Integer
Dim lnTCapVen2M As Double
Dim lnTNumJudM As Integer
Dim lnTCapJudM As Double

Dim lnTCredF As Single  ' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double
Dim lnTNumVigF As Single
Dim lnTCapVigF As Double
Dim lnTNumVen1F As Integer
Dim lnTCapVen1F  As Double
Dim lnTNumVen2F As Integer
Dim lnTCapVen2F As Double
Dim lnTNumJudF As Integer
Dim lnTCapJudF As Double

Dim lnTCredAG As Single  ' *** Agencia
Dim lnTSaldoCapAG As Double
Dim lnTNumVigAG As Single
Dim lnTCapVigAG As Double
Dim lnTNumVen1AG As Integer
Dim lnTCapVen1AG  As Double
Dim lnTNumVen2AG As Integer
Dim lnTCapVen2AG As Double
Dim lnTNumJudAG As Integer
Dim lnTCapJudAG As Double

Dim lnTCredPr As Single  ' *** Producto
Dim lnTSaldoCapPr As Double
Dim lnTNumVigPr As Single
Dim lnTCapVigPr As Double
Dim lnTNumVen1Pr As Single
Dim lnTCapVen1Pr  As Double
Dim lnTNumVen2Pr As Single
Dim lnTCapVen2Pr As Double
Dim lnTNumJudPr As Single
Dim lnTCapJudPr As Double

Dim lnTCapVen1DifPr As Double ' Diferencia entre SaldoCap - CapVencido Consumo

Dim lnTCredPrM(6) As Single  ' *** Producto Moneda
Dim lnTSaldoCapPrM(6) As Double
Dim lnTNumVigPrM(6) As Single
Dim lnTCapVigPrM(6) As Double
Dim lnTNumVen1PrM(6) As Integer
Dim lnTCapVen1PrM(6)  As Double
Dim lnTNumVen2PrM(6) As Integer
Dim lnTCapVen2PrM(6) As Double
Dim lnTNumJudPrM(6) As Integer
Dim lnTCapJudPrM(6) As Double

Dim lsCreditosVigentes As String
Dim lsCreditosPignoraticio As String
Dim lsCreditosJudicial As String
Dim i As Integer
Dim lsRtfImpG As String

Dim lbSiCambio As Boolean
Dim cadena As String

Dim lnCapVencido As Currency  'Para los consumo

Dim prod(6) As String
Dim lnRangoIni As Long
Dim lnRangoFin As Long
Dim lsRtfImp As String
Dim cpag As Integer

Dim lnCredAdmin As Integer ' Bandera Para Cred Admin

Dim lsCadDolares As String
Dim lsCadConsol As String
Dim lSSQL9 As String
lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
'lsCreditosPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
lsCreditosPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
lsCreditosJudicial = gColocEstRecVigJud & ",2205"

' Para Cada Producto
'prod(0) = " '101','102' "        ' Comercial
'prod(1) = " '201' "        ' Pyme-Mes
'prod(2) = " '301','302','303','304' "        ' Consumo
'prod(3) = " '305' "       ' Prendario
'prod(4) = " '423'"        ' Hipotecario
'prod(5) = " '202' "       ' Agricola
'prod(6) = " '320' "       ' Administrativo

'prod(0) = RecuperaCadenaTipoProducto("1")         ' Comercial
'prod(1) = RecuperaCadenaTipoProducto("2")        ' Pyme-Mes
'prod(2) = RecuperaCadenaTipoProducto("3")        ' Consumo
'prod(3) = " '305' "       ' Prendario
'prod(4) = " '423'"        ' Hipotecario
'prod(5) = " '202' "       ' Agricola
'prod(6) = " '320' "       ' Administrativo
'prod(4) = RecuperaCadenaTipoProducto("4") ' Hipotecario

'04/12/06--------------------------
prod(0) = "101, 102"  ' Comerciales
prod(1) = "201, 202" ' Pyme
prod(2) = "301, 302, 303, 304, 320"  ' Consumo
prod(3) = " 305" ' Pignoraticio
prod(4) = " 401,403,423 " ' Hipotecaja

lbSiCambio = False
lsRtfImp = ""
cpag = 1

cadena = ""

'===== Verificar si existen datos para el reporte
lSSQL9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol  " & _
       "Where nPrdEstado in (" & lsCreditosVigentes & "," & lsCreditosPignoraticio & " ) "

Set Reg9 = GetQuery(lSSQL9)

If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then  ' General
    '======== Tipo de Moneda =========
    'Set rsM = ObtieneTablaCod("03") ' Moneda
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    'Set rsFF = ObtieneLineaCredito 'Fuente Financiamiento
    
    nRepo108703_ImpRepCarteraProd_Venc = ""
    lsRtfImp = lsRtfImp & CabRepCarteraProd_Venc(cpag, pTipoCambio, pPlanCuentas)
    liLineas = 5
                    
    RsM.MoveFirst
    For i = 1 To 4
        lnTCredPrM(i) = 0:     lnTSaldoCapPrM(i) = 0
        lnTNumVigPrM(i) = 0:   lnTCapVigPrM(i) = 0
        lnTNumVen1PrM(i) = 0:  lnTCapVen1PrM(i) = 0
        lnTNumVen2PrM(i) = 0:  lnTCapVen2PrM(i) = 0
        lnTNumJudPrM(i) = 0:   lnTCapJudPrM(i) = 0
    Next i
               
    If RsM.EOF And RsM.BOF Then
    Else
        RaiseEvent ShowProgress
        Do While Not RsM.EOF
           lnTCredM = 0:     lnTSaldoCapM = 0
           lnTNumVigM = 0:   lnTCapVigM = 0
           lnTNumVen1M = 0:  lnTCapVen1M = 0
           lnTNumVen2M = 0:  lnTCapVen2M = 0
           lnTNumJudM = 0:   lnTCapJudM = 0
           lsDescM = Trim(RsM!cConsDescripcion)
           lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
           lsRtfImp = lsRtfImp & " MONEDA      : " & lsDescM & Chr(27) & Chr(70) & Chr(10)
           liLineas = liLineas + 1

              For i = 0 To 4 '6  'Para Cada Producto
                     
                 lnTCredPr = 0:     lnTSaldoCapPr = 0
                 lnTNumVigPr = 0:   lnTCapVigPr = 0
                 lnTNumVen1Pr = 0:  lnTCapVen1Pr = 0
                 lnTNumVen2Pr = 0:  lnTCapVen2Pr = 0
                 lnTNumJudPr = 0:   lnTCapJudPr = 0
                 lnTCapVen1DifPr = 0
                      
                 Select Case i
                   Case 0
                      lsDescPr = " Comercial     "
                   Case 1
                      lsDescPr = " Mes           "
                   Case 2
                      lsDescPr = " Consumo       "
                   Case 3
                      lsDescPr = " Prendario     "
                   Case 4
                      lsDescPr = " Hipotecario   "
                   'Case 5
                   '   lsDescPr = " Agricola      "
                   'Case 6
                   '   lsDescPr = " Administrativo"
                 End Select
                    '=========== CREDITOS DE LA MONEDA =============
                     Sql9 = "SELECT Count(cCtaCod) AS NumCred From " & psServConsol & "CreditoConsol " & _
                         " WHERE nPrdEstado in (" & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & ") " & _
                         "  " & _
                         " AND substring(cLineaCred,9,1)= '" & Trim(RsM!nConsValor) & "' "

                        If HayDatos(Sql9) > 0 Then  ' Para Producto
                           '=================================================
                           '===== Total Cartera  Producto de MONEDA  ======
                           '  Creditos ------------
                           Sql9 = "SELECT COUNT(cCtaCod) AS Numero, SUM(nSaldoCap) AS Capital " & _
                                  " From " & psServConsol & " CreditoConsol " & _
                                  " WHERE nPrdEstado in (" & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & ") " & _
                                  " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                  " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                           Set Reg9 = GetQuery(Sql9)
                           
                           lnTCredPr = Reg9!Numero
                           lnTSaldoCapPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                           Reg9.Close
                           Set Reg9 = Nothing
                                    
                           '=================================================
                           '====== Cartera Vigente  Producto de Agencia  ===
                           Select Case i
                               
                               Case 0  ' Comercial   ******************
                                 'If pPlanCuentas = "1" Then
                                 '   lnRangoIni = -9999   ' Comerciales
                                 '   lnRangoFin = 15
                                 'Else
                                    lnRangoIni = -9999   ' Comerciales
                                    lnRangoFin = 15
                                 'End If
                                 Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                       " SUM(nSaldoCap) AS Capital " & _
                                       " From " & psServConsol & " CreditoConsol " & _
                                       " WHERE nPrdEstado in (" & lsCreditosVigentes & " ) " & _
                                       " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                       " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                       " And ndiasatraso <= " & Val(lnRangoFin)
                                 Set Reg9 = GetQuery(Sql9)
                                 lnTNumVigPr = Reg9!Numero
                                 lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                 Reg9.Close
                                 Set Reg9 = Nothing
                                 '********
                               
                               Case 1 ', 5  ' Mes Pyme / Agricola  ******************
                                 'If pPlanCuentas = "1" Then
                                 '    lnRangoIni = -9999   ' MicroEmpresa / Agricola
                                 '    lnRangoFin = 30
                                 'Else
                                     lnRangoIni = -9999   ' MicroEmpresa / Agricola
                                     lnRangoFin = 30
                                 'End If
                                 Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                       " SUM(nSaldoCap) AS Capital " & _
                                       " From " & psServConsol & " CreditoConsol " & _
                                       " WHERE nPrdEstado in ( " & lsCreditosVigentes & " ) " & _
                                       " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                       " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                       " And ndiasatraso <= " & Val(lnRangoFin)
                                  Set Reg9 = GetQuery(Sql9)
                                 lnTNumVigPr = Reg9!Numero
                                 lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                 Reg9.Close
                                 Set Reg9 = Nothing
                                       
                              Case 2, 4 ', 6  ' Consumo / Hipotecario
                                 'If pPlanCuentas = "1" Then
                                 '    lnRangoIni = -9999
                                 '    lnRangoFin = 90
                                 'Else
                                    lnRangoIni = -9999
                                    lnRangoFin = 30
                                 'End If
                                 Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                       " SUM(nSaldoCap) AS Capital " & _
                                       " From " & psServConsol & " CreditoConsol " & _
                                       " WHERE nPrdEstado in (" & lsCreditosVigentes & " ) " & _
                                       " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                       " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                       " And ndiasatraso <= " & Val(lnRangoFin)
                                 Set Reg9 = GetQuery(Sql9)
                                 lnTNumVigPr = Reg9!Numero
                                 lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                 Reg9.Close
                                 Set Reg9 = Nothing
                                                                              
                              Case 3  ' Prendario  *************************
                                    lnRangoIni = -999
                                    lnRangoFin = 30
                                    'SACR: MONEDA
                                    Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                        " SUM(nSaldoCap) AS Capital " & _
                                       " From " & psServConsol & " CreditoConsol " & _
                                       " WHERE nPrdEstado in ( " & lsCreditosPignoraticio & " ) " & _
                                       " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                       " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                       " And ndiasAtraso <= " & Val(lnRangoFin)

                                    Set Reg9 = GetQuery(Sql9)
                                     lnTNumVigPr = Reg9!Numero
                                     lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                     Reg9.Close
                                     Set Reg9 = Nothing
                               Case Else
                                   lnTNumVigPr = 0
                                   lnTCapVigPr = 0
                               
                           End Select
                           '=================================================
                           '====== Cartera Vencida 1 Producto de Agencia  ===
                           Select Case i
                               
                               Case 0  ' Comerciales  ******************
                                 'If pPlanCuentas = "1" Then
                                 '    lnRangoIni = 16   ' Comerciales
                                 '    lnRangoFin = 120
                                 'Else
                                     lnRangoIni = 16   ' Comerciales
                                     lnRangoFin = 99999
                                 'End If
                                 Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                       " SUM(nSaldoCap) AS Capital " & _
                                       " From " & psServConsol & " CreditoConsol " & _
                                       " WHERE nPrdEstado in ( " & lsCreditosVigentes & " ) " & _
                                       " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                       " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                       " And ndiasatraso <= " & Val(lnRangoFin)
                                  Set Reg9 = GetQuery(Sql9)
                                 lnTNumVen1Pr = Reg9!Numero
                                 lnTCapVen1Pr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                 Reg9.Close
                                 Set Reg9 = Nothing
                                 '********
                               
                               Case 1 ', 5   ' Mes Pyme  / Agricola  ******************
                                 'If pPlanCuentas = "1" Then
                                 '    lnRangoIni = 31   ' MicroEmpresa  /Agricola
                                 '    lnRangoFin = 120
                                 'Else
                                     lnRangoIni = 31   ' MicroEmpresa
                                     lnRangoFin = 99999
                                 'End If
                                 Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                       " SUM(nSaldoCap) AS Capital " & _
                                       " From " & psServConsol & " CreditoConsol " & _
                                       " WHERE nPrdEstado in (" & lsCreditosVigentes & ") " & _
                                       " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                       " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                       " And ndiasatraso <= " & Val(lnRangoFin)
                                 Set Reg9 = GetQuery(Sql9)
                                 lnTNumVen1Pr = Reg9!Numero
                                 lnTCapVen1Pr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                 Reg9.Close
                                 Set Reg9 = Nothing
                                       
                              Case 2, 4 ', 6    ' Consumo / Hipotecario / Administra
                                 'If pPlanCuentas = "1" Then
                                 '    lnRangoIni = 91   ' Capital Vencido OJO
                                 '    lnRangoFin = 120
                                 'Else
                                     lnRangoIni = 31   ' Capital Vencido OJO
                                     lnRangoFin = 90
                                 'End If
                                 Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                       " SUM(nSaldoCap) AS Capital, " & _
                                       " SUM(nCapVencido) AS CapVencido " & _
                                       " From " & psServConsol & " CreditoConsol " & _
                                       " WHERE nPrdEstado in (" & lsCreditosVigentes & ") " & _
                                       " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                       " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                       " And ndiasatraso <= " & Val(lnRangoFin)
                                  Set Reg9 = GetQuery(Sql9)
                                 lnTNumVen1Pr = Reg9!Numero
                                 lnTCapVen1Pr = IIf(IsNull(Reg9!CapVencido), 0, Reg9!CapVencido)
                                 lnTCapVen1DifPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital) - IIf(IsNull(Reg9!CapVencido), 0, Reg9!CapVencido)
                                 If lnTCapVen1DifPr < 0 Then
                                    MsgBox "ERROR GRAVE : ", vbInformation, "Aviso"
                                 End If
                                 lnTCapVigPr = lnTCapVigPr + lnTCapVen1DifPr
                                 Reg9.Close
                                 Set Reg9 = Nothing
                                       
                                       
                              Case 3  ' Prendario  *************************
                                  'If Trim(rsFF!cLineaCred) = "0101" Then  ' Si es RR PP
                                    lnRangoIni = 31
                                    lnRangoFin = 9999
                                    Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                        " SUM(nSaldoCap) AS Capital " & _
                                       " From " & psServConsol & " CreditoConsol " & _
                                       " WHERE nPrdEstado in (" & lsCreditosPignoraticio & ") " & _
                                       " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                       " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                       " And ndiasAtraso <= " & Val(lnRangoFin)

                                     Set Reg9 = GetQuery(Sql9)
                                     lnTNumVen1Pr = Reg9!Numero
                                     lnTCapVen1Pr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                     Reg9.Close
                                     Set Reg9 = Nothing
                                 'End If
                               
                              Case Else
                                   lnTNumVen1Pr = 0
                                   lnTCapVen1Pr = 0
                              
                           End Select
                           
                           '=================================================
                           '====== Cartera Vencida 2 Producto de Agencia  ===
                           Select Case i
                                       
                               Case 2, 4 ', 6 '  Consumo / Hipotecario / Administrativ ******************
                                 'If pPlanCuentas = "1" Then
                                 '    lnRangoIni = 91   ' Capital Vencido OJO
                                 '    lnRangoFin = 120
                                 'Else
                                     lnRangoIni = 91   ' Capital Vencido OJO
                                     lnRangoFin = 9999
                                 'End If
                               
                               
                                    Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                          " SUM(nSaldoCap) AS Capital " & _
                                          " From " & psServConsol & " CreditoConsol " & _
                                          " WHERE nPrdEstado in ( " & lsCreditosVigentes & ") " & _
                                          " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                          " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                          " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                          " And ndiasatraso <= " & Val(lnRangoFin)
                                          
                                    Set Reg9 = GetQuery(Sql9)
                                    lnTNumVen2Pr = Reg9!Numero
                                    lnTCapVen2Pr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                    Reg9.Close
                                    Set Reg9 = Nothing
                              
                              Case Else
                                  lnTNumVen2Pr = 0
                                  lnTCapVen2Pr = 0
                                   
                           End Select
                           
                           '=================================================
                           '====== En Asesoria Legal Producto de Agencia  ===
                                Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                       " SUM(nSaldoCap) AS Capital " & _
                                       " From " & psServConsol & " CreditoConsol " & _
                                       " WHERE nPrdEstado in (" & lsCreditosJudicial & ") " & _
                                       " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                
                                Set Reg9 = GetQuery(Sql9)
                                lnTNumJudPr = Reg9!Numero
                                lnTCapJudPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                Reg9.Close
                                Set Reg9 = Nothing
                           
                           
                           ' *************************************************
                           ' ***** Asigna Valores al Producto Total Moneda ***
                           ' *************************************************
                           lnTCredM = lnTCredM + lnTCredPr
                           lnTSaldoCapM = lnTSaldoCapM + lnTSaldoCapPr
                           lnTNumVigM = lnTNumVigM + lnTNumVigPr
                           lnTCapVigM = lnTCapVigM + lnTCapVigPr
                           lnTNumVen1M = lnTNumVen1M + lnTNumVen1Pr
                           lnTCapVen1M = lnTCapVen1M + lnTCapVen1Pr
                           lnTNumVen2M = lnTNumVen2M + lnTNumVen2Pr
                           lnTCapVen2M = lnTCapVen2M + lnTCapVen2Pr
                           lnTNumJudM = lnTNumJudM + lnTNumJudPr
                           lnTCapJudM = lnTCapJudM + lnTCapJudPr

                           
                           ' ***** Asigna Valores al Producto Moneda ***
                           ' ***** y el cambio de moneda   *************
                           lnTCredPrM(i) = lnTCredPrM(i) + lnTCredPr
                           lnTSaldoCapPrM(i) = lnTSaldoCapPrM(i) + IIf(Trim(RsM!nConsValor) = "1", lnTSaldoCapPr, lnTSaldoCapPr * pTipoCambio)
                           lnTNumVigPrM(i) = lnTNumVigPrM(i) + lnTNumVigPr
                           lnTCapVigPrM(i) = lnTCapVigPrM(i) + IIf(Trim(RsM!nConsValor) = "1", lnTCapVigPr, lnTCapVigPr * pTipoCambio)
                           lnTNumVen1PrM(i) = lnTNumVen1PrM(i) + lnTNumVen1Pr
                           lnTCapVen1PrM(i) = lnTCapVen1PrM(i) + IIf(Trim(RsM!nConsValor) = "1", lnTCapVen1Pr, lnTCapVen1Pr * pTipoCambio)
                           lnTNumVen2PrM(i) = lnTNumVen2PrM(i) + lnTNumVen2Pr
                           lnTCapVen2PrM(i) = lnTCapVen2PrM(i) + IIf(Trim(RsM!nConsValor) = "1", lnTCapVen2Pr, lnTCapVen2Pr * pTipoCambio)
                           lnTNumJudPrM(i) = lnTNumJudPrM(i) + lnTNumJudPr
                           lnTCapJudPrM(i) = lnTCapJudPrM(i) + IIf(Trim(RsM!nConsValor) = "1", lnTCapJudPr, lnTCapJudPr * pTipoCambio)
                           ' *****  Imprime Producto de la Moneda
                           lsRtfImp = lsRtfImp & Chr(10)
                           lsRtfImp = lsRtfImp & " " & lsDescPr
                           lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPr, 10, 0, True)
                           lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPr, 13, 2, True) & " | "
                           lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigPr, 8, 0, True)
                           lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPr, 13, 2, True) & " | "
                           lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1Pr, 7, 0, True)
                           lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1Pr, 12, 2, True) & " | "
                           lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2Pr, 7, 0, True)
                           lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2Pr, 12, 2, True) & " | "
                           lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudPr, 7, 0, True)
                           lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudPr, 12, 2, True) & " | "
                           lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapPr - lnTCapVigPr) / IIf(lnTSaldoCapPr = 0, 1, lnTSaldoCapPr)) * 100, 2), 3, 2) & "%"
                           liLineas = liLineas + 1

                        End If  ' Fin de Si encuentra Datos Producto Moned
              Next i   ' Para el Sgte Producto
             
               ' **********************
               ' *****  Imprime Totales de Moneda
            lsRtfImp = lsRtfImp & Chr(10)
            lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
            lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
            lsRtfImp = lsRtfImp & " TOTAL         "
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCredM, 10, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapM, 13, 2, True) & " | "
            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigM, 8, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigM, 13, 2, True) & " | "
            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1M, 7, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1M, 12, 2, True) & " | "
            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2M, 7, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2M, 12, 2, True) & " | "
            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudM, 7, 0, True)
            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudM, 12, 2, True) & " | "
            lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapM - lnTCapVigM) / lnTSaldoCapM) * 100, 2), 3, 2) & "%"
            lsRtfImp = lsRtfImp & Chr(27) & Chr(70)
            lsRtfImp = lsRtfImp & Chr(10)
            lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
            lsRtfImp = lsRtfImp & Chr(10)
            liLineas = liLineas + 4
            RaiseEvent Progress(RsM.Bookmark, RsM.RecordCount)
        RsM.MoveNext
        Loop ' ---- Moneda de Producto
                            
        lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
        lsRtfImp = lsRtfImp & " CONSOLIDADO (Nuevos Soles) " & Chr(27) & Chr(70) & Chr(10)
        For i = 0 To 4 '6  ' Consolidado
           lnTCredT = lnTCredT + lnTCredPrM(i)
           lnTSaldoCapT = lnTSaldoCapT + lnTSaldoCapPrM(i)
           lnTNumVigT = lnTNumVigT + lnTNumVigPrM(i)
           lnTCapVigT = lnTCapVigT + lnTCapVigPrM(i)
           lnTNumVen1T = lnTNumVen1T + lnTNumVen1PrM(i)
           lnTCapVen1T = lnTCapVen1T + lnTCapVen1PrM(i)
           lnTNumVen2T = lnTNumVen2T + lnTNumVen2PrM(i)
           lnTCapVen2T = lnTCapVen2T + lnTCapVen2PrM(i)
           lnTNumJudT = lnTNumJudT + lnTNumJudPrM(i)
           lnTCapJudT = lnTCapJudT + lnTCapJudPrM(i)
          Select Case i
              Case 0
                  lsDescPr = " Comercial    "
               Case 1
                  lsDescPr = " Mes          "
               Case 2
                  lsDescPr = " Consumo      "
               Case 3
                  lsDescPr = " Prendario    "
               Case 4
                  lsDescPr = " Hipotecario "
               'Case 5
               '   lsDescPr = " Agricola     "
               'Case 6
               '   lsDescPr = " Administrativo"
           End Select
           lsRtfImp = lsRtfImp & Chr(10)
           lsRtfImp = lsRtfImp & " " & lsDescPr
           lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPrM(i), 10, 0, True)
           lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPrM(i), 13, 2, True) & " | "
           lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigPrM(i), 8, 0, True)
           lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPrM(i), 13, 2, True) & " | "
           lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1PrM(i), 7, 0, True)
           lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1PrM(i), 12, 2, True) & " | "
           lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2PrM(i), 7, 0, True)
           lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2PrM(i), 12, 2, True) & " | "
           lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudPrM(i), 7, 0, True)
           lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudPrM(i), 12, 2, True) & " | "
           lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapPrM(i) - lnTCapVigPrM(i)) / IIf(lnTSaldoCapPrM(i) = 0, 1, lnTSaldoCapPrM(i))) * 100, 2), 3, 2) & "%"
           liLineas = liLineas + 1
           
        Next i

        lsRtfImp = lsRtfImp & Chr(10)
            
        ' **********************
        ' *****  Imprime Totales
        'lsRTfImp = lsRTfImp & Chr(10)
        lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
        lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
        lsRtfImp = lsRtfImp & " TOTAL         "
        lsRtfImp = lsRtfImp & ImpreFormat(lnTCredT, 10, 0, True)
        lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapT, 13, 2, True) & " | "
        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigT, 8, 0, True)
        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigT, 13, 2, True) & " | "
        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1T, 7, 0, True)
        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1T, 12, 2, True) & " | "
        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2T, 7, 0, True)
        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2T, 12, 2, True) & " | "
        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudT, 7, 0, True)
        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudT, 12, 2, True) & " | "
        lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapT - lnTCapVigT) / lnTSaldoCapT) * 100, 2), 3, 2) & "%"
        lsRtfImp = lsRtfImp & Chr(27) & Chr(70)
        lsRtfImp = lsRtfImp & Chr(10)
        lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
        lsRtfImp = lsRtfImp & Chr(10)
        liLineas = liLineas + 4
            
    End If
    RaiseEvent CloseProgress
    RsM.Close
    Set RsM = Nothing
Else
    nRepo108703_ImpRepCarteraProd_Venc = ""
End If '--- liDatos - General
lsRtfImpG = lsRtfImp ' Asigna el valor
nRepo108703_ImpRepCarteraProd_Venc = lsRtfImpG
Screen.MousePointer = 1
End Function



Private Sub Class_Initialize()
Set Conecta = New DConecta
End Sub

Private Sub Class_Terminate()
Set Conecta = Nothing
End Sub

Public Function nRepo108701_CarteraColocacionesxMoneda(ByVal pPlanCuentas As String, ByVal psServConsol As String) As String
Dim lSSQL9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPla As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim lrReg9 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String
Dim lsDescP As String
Dim lsDescF As String
Dim lsDescAG As String
Dim i As Integer
Dim liLineas As Integer
Dim liDatos  As Long

Dim lnTCred As Single  ' *** General
Dim lnTSaldoCap As Double
Dim lnTNumVig As Single
Dim lnTCapVig As Double
Dim lnTNumVen1 As Integer
Dim lnTCapVen1  As Double
Dim lnTNumVen2 As Integer
Dim lnTCapVen2 As Double
Dim lnTNumJud As Integer
Dim lnTCapJud As Double

Dim lnTCredM As Single  ' *** Moneda
Dim lnTSaldoCapM As Double
Dim lnTNumVigM As Single
Dim lnTCapVigM As Double
Dim lnTNumVen1M As Integer
Dim lnTCapVen1M  As Double
Dim lnTNumVen2M As Integer
Dim lnTCapVen2M As Double
Dim lnTNumJudM As Integer
Dim lnTCapJudM As Double
 
Dim lnTCredF As Single  ' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double
Dim lnTNumVigF As Single
Dim lnTCapVigF As Double
Dim lnTNumVen1F As Integer
Dim lnTCapVen1F  As Double
Dim lnTNumVen2F As Integer
Dim lnTCapVen2F As Double
Dim lnTNumJudF As Integer
Dim lnTCapJudF As Double

Dim lnTCredAG As Single  ' *** Agencia
Dim lnTSaldoCapAG As Double
Dim lnTNumVigAG As Single
Dim lnTCapVigAG As Double
Dim lnTNumVen1AG As Integer
Dim lnTCapVen1AG  As Double
Dim lnTNumVen2AG As Integer
Dim lnTCapVen2AG As Double
Dim lnTNumJudAG As Integer
Dim lnTCapJudAG As Double

Dim lnTCredPr As Single  ' *** Producto
Dim lnTSaldoCapPr As Double
Dim lnTNumVigPr As Single
Dim lnTCapVigPr As Double
Dim lnTNumVen1Pr As Integer
Dim lnTCapVen1Pr  As Double
Dim lnTNumVen2Pr As Integer
Dim lnTCapVen2Pr As Double
Dim lnTNumJudPr As Integer
Dim lnTCapJudPr As Double

Dim lbSiCambio As Boolean
Dim cadena As String

Dim lnCapVencido As Currency  'Para los consumo


Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsRtfImp As String
Dim cpag As Integer

Dim lnCredAdmin As Integer ' Bandera Para Cred Admin
Dim lsEstadoPignoraticio As String
Dim lsEstadoCreditos As String
Dim lsEstadoJudicial As String

'importante - LAYG
lsEstadoPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
lsEstadoCreditos = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & _
                   gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
lsEstadoJudicial = gColocEstRecVigJud & ",2205"

Dim prod(7) As String

Dim RCD As nRcdReportes
Set RCD = New nRcdReportes
Dim sql As String
Dim rs As New ADODB.Recordset
Dim Rss As New ADODB.Recordset
Dim sProd As String
Dim np As Integer

' Para Cada Producto

'ARCV 04-07-2006
'prod(0) = " '101','102' "  ' Comerciales
'prod(1) = " '201' "  ' Pyme
'prod(2) = " '301','302','303','304' "  ' Personales
'prod(3) = " '202'"  ' Agricola
'prod(4) = " '305'" ' Pignoraticio
'prod(5) = " '320'" ' Administrativos
'prod(6) = " '401'" ' Hipotecaja
'prod(7) = " '423'" ' Mivivienda

prod(0) = RecuperaCadenaTipoProducto("1")   ' Comerciales
prod(1) = RecuperaCadenaTipoProducto("2")   ' Pyme
prod(2) = RecuperaCadenaTipoProducto("3")   ' Personales
'prod(3) = " '202'"  ' Agricola
prod(3) = " '305'" ' Pignoraticio
'prod(5) = " '320'" ' Administrativos
'prod(6) = " '401'" ' Hipotecaja
prod(4) = RecuperaCadenaTipoProducto("4")  ' Mivivienda

lbSiCambio = False
lsRtfImp = ""
cpag = 1

cadena = ""
 
'===== Verificar si existen datos para el reporte                                                'CreditoConsol.nEstado='F'
lSSQL9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol  " & _
       "Where nPrdEstado in (" & lsEstadoCreditos & " ) "

Conecta.AbreConexion
Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
Conecta.CierraConexion

If lrReg9.EOF And lrReg9.BOF Then
    liDatos = 0
Else
    liDatos = lrReg9!NumCred
End If
lrReg9.Close
Set lrReg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then  ' General
    '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    Set rsFF = ObtieneLineaCredito 'Fuente Financiamiento
        
    Dim loAg As DAgencias
        Set loAg = New DAgencias
            Set rsAg = loAg.RecuperaAgencias
        Set loAg = Nothing
   
    'PrgBarra.Min = 0
    'PrgBarra.Max = liDatos
    'StBarra.Panels(1).Text = "Procesando Reporte, Por Favor Espere..."
    
    If RsM.EOF And RsM.BOF Then
    Else
        RaiseEvent ShowProgress
        Do While Not RsM.EOF
            '=====LIMPIAR LOS DATOS SUBTOTALES POR MONEDA ======
            lnTCredM = 0:   lnTSaldoCapM = 0
            lnTNumVigM = 0: lnTCapVigM = 0
            lnTNumVen1M = 0: lnTCapVen1M = 0
            lnTNumVen2M = 0: lnTCapVen2M = 0
            lnTNumJudM = 0: lnTCapJudM = 0
            lsDescM = Trim(RsM!cConsDescripcion)
            '============ CREDITOS VIGENTES PARA UNA DETERMINADA MONEDA =========
            lSSQL9 = "SELECT Count(cCtaCod) AS NumCred FROM " & psServConsol & "CreditoConsol " & _
                "WHERE nPrdEstado in (" & lsEstadoCreditos & " ) " & _
                "And Substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'"
            Conecta.AbreConexion
            Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
            Conecta.CierraConexion
            If lrReg9.EOF And lrReg9.BOF Then
                liDatos = 0
            Else
                liDatos = lrReg9!NumCred
            End If
            lrReg9.Close
            Set lrReg9 = Nothing
            
            If liDatos > 0 Then  ' De la Moneda
                lsRtfImp = lsRtfImp & CabCarteraCredxMoneda(cpag, pPlanCuentas)
                liLineas = 5
                If lbSiCambio Then
                    lbSiCambio = False
                End If
                lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
                lsRtfImp = lsRtfImp & " MONEDA      : " & lsDescM & Chr(27) & Chr(70) & Chr(10)
                liLineas = liLineas + 1
                If rsFF.EOF And rsFF.BOF Then 'Fuente Financ
                Else
                    rsFF.MoveFirst
                    Do While Not rsFF.EOF 'Fuente Financ
                       lnTCredF = 0: lnTSaldoCapF = 0
                       lnTNumVigF = 0: lnTCapVigF = 0
                       lnTNumVen1F = 0: lnTCapVen1F = 0
                       lnTNumVen2F = 0: lnTCapVen2F = 0
                       lnTNumJudF = 0: lnTCapJudF = 0
                       lsDescF = Mid(rsFF!CDescripcion, 1, 25)
                       '=========== CREDITOS VIGENTES PARA UNA FUENTE FINANCIAMIENTO =============
                       lSSQL9 = " SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
                              " WHERE nPrdEstado in (" & lsEstadoCreditos & "," & lsEstadoJudicial & " ) " & _
                              " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                              " AND substring(cLineaCred, 1,4) IN ('" & Trim(rsFF!cLineaCred) & "')"
                              
                       'SQL9B = "SELECT Count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol "
                       'SQL9B = SQL9B & "WHERE nPrdEstado =" & gColocEstRecVigJud & "  AND nSaldoCap > 0 "
                       'SQL9B = SQL9B & "AND  substring(cCtaCod,6,1)= '" & Trim(RsM!NCONSVALOR) & "'"
                       'SQL9B = SQL9B & "AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')"

                        'If HayDatos(lSSQL9) + HayDatos(SQL9B) > 0 Then  ' De la Fuente Financ
                        If HayDatos(lSSQL9) > 0 Then  ' De la Fuente Financ
                          ' ****************************
                          ' ****  Verifica Si Cambio pagina
                          If liLineas >= 55 Then 'Para el control de salto de página
                             lsRtfImp = lsRtfImp & Chr(12)
                             cpag = cpag + 1
                             lsRtfImp = lsRtfImp & CabCarteraCredxMoneda(cpag, pPlanCuentas)
                             liLineas = 5
                          End If
                            
                          lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
                          lsRtfImp = lsRtfImp & " * FUENTE FINANCIAMIENTO   : " & lsDescF & Chr(27) & Chr(70) & Chr(10)
                          liLineas = liLineas + 1
                            '======= Para Cada Agencia  =========
                          rsAg.MoveFirst
                          Do While Not rsAg.EOF
                               
                            lSSQL9 = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                    " where nPrdEstado in (" & lsEstadoCreditos & "," & lsEstadoPignoraticio & "," & lsEstadoJudicial & " ) " & _
                                    " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                    " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                    " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
                            'If Trim(rsFF!cLineaCred) = "0101" Then
                            '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                       "WHERE nPrdEstado IN (" & lsEstadoPignoraticio & ") " & _
                                       "AND substring(cCtaCod,9,1 )= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                       "AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
                                       ' "WHERE nPrdEstado IN (" & gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov & ") " & _
                            Else
                            '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol "
                            '   SQL9B = SQL9B & "WHERE nPrdESTADO = 9999 "
                            '             -----------------> ver
                            'End If
                            'SQL9C = "SELECT Count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol "
                            'SQL9C = SQL9C & "WHERE nPrdEstado =" & gColocEstRecVigJud & "  AND nSaldoCap > 0 "
                            'SQL9C = SQL9C & "AND  substring(cCtaCod,6,1)= '" & Trim(RsM!NCONSVALOR) & "'"
                            'SQL9C = SQL9C & "AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'"
                            'SQL9C = SQL9C & "AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
                            '******* Administrativos
                            'If Trim(rsFF!cLineaCred) = "0101" And rsAg!cAgeCod = "07" And i = "5" Then
                            '   lnCredAdmin = 1
                            'Else
                            '   lnCredAdmin = 0
                            'End If
                            
                            'If HayDatos(lSSQL9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then    ' De la Agencia
                            If HayDatos(lSSQL9) > 0 Then     ' De la Agencia

                               lnTCredAG = 0: lnTSaldoCapAG = 0
                               lnTNumVigAG = 0: lnTCapVigAG = 0
                               lnTNumVen1AG = 0: lnTCapVen1AG = 0
                               lnTNumVen2AG = 0: lnTCapVen2AG = 0
                               lnTNumJudAG = 0: lnTCapJudAG = 0
                               lsDescAG = Mid(rsAg!cAgeDescripcion, 1, 20)
                               ' ****************************
                               ' ****  Verifica Si Cambio pagina
                               If liLineas >= 55 Then 'Para el control de salto de página
                                  lsRtfImp = lsRtfImp & Chr(12)
                                  cpag = cpag + 1
                                  lsRtfImp = lsRtfImp & CabCarteraCredxMoneda(cpag, pPlanCuentas)
                                  liLineas = 5
                               End If
                               lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
                               lsRtfImp = lsRtfImp & " ** " & Mid(lsDescAG, 1, 25) & Chr(27) & Chr(70) & Chr(10)
                               liLineas = liLineas + 1
                               
                               For i = 0 To 4 '7 'Para Cada Producto
                                  lnTCredPr = 0:   lnTSaldoCapPr = 0
                                  lnTNumVigPr = 0: lnTCapVigPr = 0
                                  lnTNumVen1Pr = 0: lnTCapVen1Pr = 0
                                  lnTNumVen2Pr = 0: lnTCapVen2Pr = 0
                                  lnTNumJudPr = 0: lnTCapJudPr = 0
                                  
                                  Select Case i
                                     Case 0
                                        lsDescPr = " Comercial    "
                                     Case 1
                                        lsDescPr = " Pyme         "
                                     Case 2
                                        lsDescPr = " Consumo      "
                                     'Case 3
                                     '   lsDescPr = " Agricola     "
                                     Case 3
                                        lsDescPr = " Pignoraticio "
                                     'Case 5
                                     '   lsDescPr = " Administrativ"
                                     'Case 6
                                     '   lsDescPr = " Hipotecario  "
                                     Case 4 '7
                                        lsDescPr = " MiVivienda   "
                                  End Select
                                  
                                  '=========== CREDITOS DEL PRODUCTO =============
                                    lSSQL9 = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                        " where nPrdEstado in (" & lsEstadoCreditos & "," & lsEstadoPignoraticio & "," & lsEstadoJudicial & " )" & _
                                        " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                        " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                     
                                    'If Trim(rsFF!cLineaCred) = "0101" And Trim(RsM!NCONSVALOR) = "1" Then  ' Si es RR PP
                                    '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                    '        " WHERE nPrdEstado IN (" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc & ",2101,2104,2106,2107,2201" & " ) " & _
                                    '        " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                    '        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                    '        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                    'Else
                                    '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                    '           "WHERE nPrdEstado = 9999 "
                                    'End If
                                    ' Judicial
                                    'SQL9C = "SELECT COUNT(cCtaCod) AS NumCred " & _
                                    '       " FROM " & psServConsol & "CreditoConsol " & _
                                    '       " WHERE nPrdEstado =" & gColocEstRecVigJud & "   AND nSaldoCap > 0" & _
                                    '       " AND substring(cLineaCred,5,1)= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                    '      " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                    '       " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                    '       " AND substring(cCtaCod,6,3) in (" & prod(i) & ")"
                                    

                                    'If HayDatos(lSSQL9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then  ' Para Producto
                                    If HayDatos(lSSQL9) > 0 Then   ' Para Producto
                                       '=================================================
                                       '===== Total Cartera  Producto de Agencia  ======
                                       '  Creditos ------------
                                       lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, SUM(nSaldoCap) AS Capital " & _
                                              " FROM " & psServConsol & "CreditoConsol " & _
                                              " WHERE nPrdEstado in (" & lsEstadoCreditos & "," & lsEstadoPignoraticio & "," & lsEstadoJudicial & " )  " & _
                                              " AND substring(cLineaCred,5,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                              " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                              " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                              " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                              
                                       'lrReg9.Open lsSQL9, dbCmactCentral, adOpenStatic, adLockReadOnly, adCmdText
                                       Conecta.AbreConexion
                                       Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                       Conecta.CierraConexion
                                       
                                       lnTCredPr = lrReg9!Numero
                                       lnTSaldoCapPr = IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                       lrReg9.Close
                                       Set lrReg9 = Nothing
                                                
                                       ' Pignoraticio  ------------
                                       'If Trim(rsFF!cLineaCred) = "0101" And Trim(RsM!NCONSVALOR) = "1" Then  ' Si es RR PP
                                       '   lSSQL9 = "SELECT count(cCtaCod) as Numero, Sum(nSaldoCap) AS Capital " & _
                                       '       " FROM " & psServConsol & "CreditoConsol WHERE nPrdEstado IN (" & lsEstadoPignoraticio & ") " & _
                                       '       " AND substring(cCtaCod,9,1)= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                       '       " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                       '       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                       '   'gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
                                          
                                       '   Conecta.AbreConexion
                                       '   Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                       '   Conecta.CierraConexion
                                       '
                                       '   lnTCredPr = lnTCredPr + lrReg9!Numero
                                       '   lnTSaldoCapPr = lnTSaldoCapPr + IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                       '   lrReg9.Close
                                       '   Set lrReg9 = Nothing
                                       'End If
                                       ' Judicial -------------
                                       'lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                       '       " SUM(nSaldoCap) AS Capital " & _
                                       '       " FROM " & psServConsol & "CreditoConsol " & _
                                       '       " WHERE nPrdEstado =" & gColocEstRecVigJud & "  AND nSaldoCap > 0" & _
                                       '       " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                       '       " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                       '       " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                       '       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                      '
                                       '  Conecta.AbreConexion
                                       '  Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                       '  Conecta.CierraConexion
                                       
                                       'lnTCredPr = lnTCredPr + lrReg9!Numero
                                       'lnTSaldoCapPr = lnTSaldoCapPr + IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                       'lrReg9.Close
                                       'Set lrReg9 = Nothing
                                       '=================================================
                                       '====== Cartera Vigente  Producto de Agencia  ===
                                       Select Case i
                                       
                                           Case 0  ' Comercial  ******************
                                             lnRangoIni = -9999   ' Comerciales
                                             lnRangoFin = 15

                                             lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                   " SUM(nSaldoCap) AS Capital " & _
                                                   " FROM " & psServConsol & "CreditoConsol " & _
                                                   " WHERE nPrdEstado in (" & lsEstadoCreditos & " )" & _
                                                   " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                                   " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                   " AND substring(cCtaCod,6,3) in (" & prod(i) & ") " & _
                                                   " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                   " And ndiasatraso <= " & Val(lnRangoFin)
                                             
                                             Conecta.AbreConexion
                                             Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                             Conecta.CierraConexion
                                             lnTNumVigPr = lrReg9!Numero
                                             lnTCapVigPr = IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                             lrReg9.Close
                                             Set lrReg9 = Nothing
                                             
                                             '********
                                       
                                           Case 1 ', 3    ' Pyme / Agricola  ******************
                                            lnRangoIni = -9999   ' MicroEmpresa
                                            lnRangoFin = 30
                                             
                                             lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                   " SUM(nSaldoCap) AS Capital " & _
                                                   " FROM " & psServConsol & "CreditoConsol " & _
                                                   " WHERE nPrdEstado in (" & lsEstadoCreditos & " ) " & _
                                                   " AND substring(cLineaCred,5,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                                   " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                   " AND substring(cCtaCod,6,3) in (" & prod(i) & ")" & _
                                                   " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                   " And ndiasatraso <= " & Val(lnRangoFin)
                                             
                                             Conecta.AbreConexion
                                             Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                             Conecta.CierraConexion
                                             
                                             lnTNumVigPr = lrReg9!Numero
                                             lnTCapVigPr = IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                             lrReg9.Close
                                             Set lrReg9 = Nothing
                                                   
                                          Case 2, 4 ' 5, 6, 7 ' Consumo / Administrat / Hipotecaja / MiVivienda ***************
                                          
                                             lnRangoIni = -9999
                                             lnRangoFin = 30
                                          
                                             lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                   " SUM(nSaldoCap) AS Capital " & _
                                                   " FROM " & psServConsol & "CreditoConsol " & _
                                                   " WHERE nPrdEstado in (" & lsEstadoCreditos & " ) " & _
                                                   " AND substring(cLineaCred,5,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                                   " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                   " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                   " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                   " And ndiasatraso <= " & Val(lnRangoFin)
                                             
                                             Conecta.AbreConexion
                                             Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                             Conecta.CierraConexion
                                             
                                             lnTNumVigPr = lrReg9!Numero
                                             lnTCapVigPr = IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                             lrReg9.Close
                                             Set lrReg9 = Nothing
                                                   
                                          Case 3  ' Prendario  *************************
                                             If Trim(rsFF!cLineaCred) = "0101" Then  ' Si es RR PP
                                                lnRangoIni = -999
                                                lnRangoFin = 30
                                                lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                    " SUM(nSaldoCap) AS Capital " & _
                                                   " FROM " & psServConsol & "CreditoConsol " & _
                                                   " WHERE nPrdEstado in (" & lsEstadoPignoraticio & ") " & _
                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                   " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                   " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                   " And ndiasatraso <= " & Val(lnRangoFin)

                                                 Conecta.AbreConexion
                                                 Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                                 Conecta.CierraConexion

                                                 lnTNumVigPr = lrReg9!Numero
                                                 lnTCapVigPr = IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                                 lrReg9.Close
                                                 Set lrReg9 = Nothing
                                             End If
                                           
                                           Case Else
                                               lnTNumVigPr = 0
                                               lnTCapVigPr = 0
                                           
                                       End Select
                                       '=================================================
                                       '====== Cartera Vencida 1 Producto de Agencia  ===
                                       Select Case i
                                           
                                           Case 0  ' Comerciales  ******************
                                           
                                             lnRangoIni = 16   ' Comerciales
                                             lnRangoFin = 9999
                                           
                                             lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                   " SUM(nSaldoCap) AS Capital " & _
                                                   " FROM " & psServConsol & "CreditoConsol " & _
                                                   " WHERE nPrdEstado in (" & lsEstadoCreditos & " )" & _
                                                   " AND substring(cLineaCred,5,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                                   " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                   " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                   " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                   " And ndiasatraso <= " & Val(lnRangoFin)
                                                   
                                             Conecta.AbreConexion
                                             Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                             Conecta.CierraConexion
                                             
                                             lnTNumVen1Pr = lrReg9!Numero
                                             lnTCapVen1Pr = IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                             lrReg9.Close
                                             Set lrReg9 = Nothing
                                           
                                           Case 1 ', 3  ' Pyme / Agricola  ******************
                                           
                                             lnRangoIni = 31   ' MicroEmpresa
                                             lnRangoFin = 9999
                                             
                                             
                                             lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                   " SUM(nSaldoCap) AS Capital " & _
                                                   " FROM " & psServConsol & "CreditoConsol " & _
                                                   " WHERE nPrdEstado in (" & lsEstadoCreditos & " ) " & _
                                                   " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                                   " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                   " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                   " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                   " And ndiasatraso <= " & Val(lnRangoFin)
                                                   
                                             Conecta.AbreConexion
                                             Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                             Conecta.CierraConexion
                                             lnTNumVen1Pr = lrReg9!Numero
                                             lnTCapVen1Pr = IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                             lrReg9.Close
                                             Set lrReg9 = Nothing
                                                   
                                          Case 2, 4 ' 5, 6, 7   ' Consumo / Administrat / Hipotecario / MiVivienda *******************  OJO
                                             
                                             lnRangoIni = 31   ' Capital Vencido OJO
                                             lnRangoFin = 90
                                             
                                             lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                   " SUM(nSaldoCap) AS Capital, " & _
                                                   " SUM(nCapVencido) AS CapVencido " & _
                                                   " FROM " & psServConsol & "CreditoConsol " & _
                                                   " WHERE nPrdEstado in (" & lsEstadoCreditos & " )" & _
                                                   " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                                   " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                   " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                   " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                   " And ndiasatraso <= " & Val(lnRangoFin)
                                             
                                             Conecta.AbreConexion
                                             Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                             Conecta.CierraConexion
                                             
                                             lnTNumVen1Pr = lrReg9!Numero
                                             lnTCapVen1Pr = IIf(IsNull(lrReg9!CapVencido), 0, lrReg9!CapVencido)
                                             ' Sumo la Dif (Sald Cap - Cap Venc) *****
                                             lnTCapVigPr = lnTCapVigPr + IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital) - IIf(IsNull(lrReg9!CapVencido), 0, lrReg9!CapVencido)
                                             'IIf(IsNull(lrReg9!Capital - lrReg9!CapVencido), 0, lrReg9!Capital - lrReg9!CapVencido)
                                             lrReg9.Close
                                             Set lrReg9 = Nothing
                                                   
                                          Case 3  ' Prendario  *************************
                                              If Trim(rsFF!cLineaCred) = "0101" Then  ' Si es RR PP
                                                lnRangoIni = 31
                                                lnRangoFin = 999
                                                lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                    " SUM(nSaldoCap) AS Capital " & _
                                                   " FROM " & psServConsol & "CreditoConsol " & _
                                                   " WHERE nPrdEstado in (" & lsEstadoPignoraticio & ") " & _
                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                   " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                   " And ndiasatraso >= " & Val(lnRangoIni) & _
                                                   " And ndiasatraso <= " & Val(lnRangoFin)

                                                 Conecta.AbreConexion
                                                 Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                                 Conecta.CierraConexion

                                                 lnTNumVen1Pr = lrReg9!Numero
                                                 lnTCapVen1Pr = IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                                 lrReg9.Close
                                                 Set lrReg9 = Nothing
                                              End If
                                           
                                          Case Else
                                               lnTNumVen1Pr = 0
                                               lnTCapVen1Pr = 0
                                          
                                       End Select
                                       
                                       '=================================================
                                       '====== Cartera Vencida 2 Producto de Agencia  ===
                                       Select Case i
                                           
                                          Case 2, 4 ' 5, 6, 7   ' Consumo / Administ / Hipotecaja / MiVivienda **************  OJO
                                          
                                             lnRangoIni = 91   ' Capital
                                             lnRangoFin = 9999
                                             lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                   " SUM(nSaldoCap) AS Capital " & _
                                                   " FROM " & psServConsol & "CreditoConsol " & _
                                                   " WHERE nPrdEstado in (" & lsEstadoCreditos & " ) " & _
                                                   " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                                   " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                                   " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                   " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                   " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                   " And ndiasatraso <= " & Val(lnRangoFin)
                                                   
                                             Conecta.AbreConexion
                                             Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                             Conecta.CierraConexion
                                             
                                             lnTNumVen2Pr = lrReg9!Numero
                                             lnTCapVen2Pr = IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                             lrReg9.Close
                                             Set lrReg9 = Nothing
                                          
                                          Case Else
                                              lnTNumVen2Pr = 0
                                              lnTCapVen2Pr = 0
                                               
                                       End Select
                                       
                                       '=================================================
                                       '====== En Asesoria Legal Producto de Agencia  ===
                                        lSSQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                 " SUM(nSaldoCap) AS Capital " & _
                                                 " FROM " & psServConsol & "CreditoConsol " & _
                                                 " WHERE nPrdEstado in (" & lsEstadoJudicial & " ) " & _
                                                 " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                                 " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'" & _
                                                 " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                 " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                                   
                                        Conecta.AbreConexion
                                        Set lrReg9 = Conecta.CargaRecordSet(lSSQL9)
                                        Conecta.CierraConexion
                                         
                                         lnTNumJudPr = lrReg9!Numero
                                         lnTCapJudPr = IIf(IsNull(lrReg9!Capital), 0, lrReg9!Capital)
                                         lrReg9.Close
                                         Set lrReg9 = Nothing
                                         '********
                                       
                                       ' ***************************************
                                       ' ***** Asigna Valores a la Agencia ******
                                       lnTCredAG = lnTCredAG + lnTCredPr
                                       lnTSaldoCapAG = lnTSaldoCapAG + lnTSaldoCapPr
                                       lnTNumVigAG = lnTNumVigAG + lnTNumVigPr
                                       lnTCapVigAG = lnTCapVigAG + lnTCapVigPr
                                       lnTNumVen1AG = lnTNumVen1AG + lnTNumVen1Pr
                                       lnTCapVen1AG = lnTCapVen1AG + lnTCapVen1Pr
                                       lnTNumVen2AG = lnTNumVen2AG + lnTNumVen2Pr
                                       lnTCapVen2AG = lnTCapVen2AG + lnTCapVen2Pr
                                       lnTNumJudAG = lnTNumJudAG + lnTNumJudPr
                                       lnTCapJudAG = lnTCapJudAG + lnTCapJudPr
                                       ' *****  Imprime
                                       lsRtfImp = lsRtfImp & " " & lsDescPr
                                       lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPr, 10, 0, True)
                                       lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPr, 13, 2, True) & " | "
                                       lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigPr, 8, 0, True)
                                       lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPr, 13, 2, True) & " | "
                                       lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1Pr, 7, 0, True)
                                       lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1Pr, 12, 2, True) & " | "
                                       lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2Pr, 7, 0, True)
                                       lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2Pr, 12, 2, True) & " | "
                                       lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudPr, 7, 0, True)
                                       lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudPr, 12, 2, True) & " | "
                                       lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapPr - lnTCapVigPr) / IIf(lnTSaldoCapPr = 0, 1, lnTSaldoCapPr)) * 100, 2), 3, 2) & "%"
                                       lsRtfImp = lsRtfImp & Chr(10)
                                       liLineas = liLineas + 1

                                    End If  ' Fin de Si encuentra Datos
                                        
                                        
                               Next i   ' Para el Sgte Producto
                               
                               
                               ' **********************
                               ' ************ Asigna Valores a Fuente Financ
                               lnTCredF = lnTCredF + lnTCredAG
                               lnTSaldoCapF = lnTSaldoCapF + lnTSaldoCapAG
                               lnTNumVigF = lnTNumVigF + lnTNumVigAG
                               lnTCapVigF = lnTCapVigF + lnTCapVigAG
                               lnTNumVen1F = lnTNumVen1F + lnTNumVen1AG
                               lnTCapVen1F = lnTCapVen1F + lnTCapVen1AG
                               lnTNumVen2F = lnTNumVen2F + lnTNumVen2AG
                               lnTCapVen2F = lnTCapVen2F + lnTCapVen2AG
                               lnTNumJudF = lnTNumJudF + lnTNumJudAG
                               lnTCapJudF = lnTCapJudF + lnTCapJudAG
                               ' *****  Imprime
                               lsRtfImp = lsRtfImp & String(155, "-") & Chr(10)
                               lsRtfImp = lsRtfImp & Space(15)
                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCredAG, 10, 0, True)
                               lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAG, 13, 2, True) & " | "
                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigAG, 8, 0, True)
                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigAG, 13, 2, True) & " | "
                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1AG, 7, 0, True)
                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1AG, 12, 2, True) & " | "
                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2AG, 7, 0, True)
                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2AG, 12, 2, True) & " | "
                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudAG, 7, 0, True)
                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudAG, 12, 2, True) & " | "
                               lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapAG - lnTCapVigAG) / IIf(lnTSaldoCapAG = 0, 1, lnTSaldoCapAG)) * 100, 2), 3, 2) & "%"
                               lsRtfImp = lsRtfImp & Chr(10)
                               lsRtfImp = lsRtfImp & String(155, "-") & Chr(10)
                               'lsRTfImp = lsRTfImp & Chr(10)
                               liLineas = liLineas + 4
                               ' *** Sgte agencia
                             End If  ' Si hay datos
                            
                            rsAg.MoveNext
                            

                            Loop  ' de Agencia
                            
                            ' **********************
                            ' ************ Asigna Valores a Moneda
                            lnTCredM = lnTCredM + lnTCredF
                            lnTSaldoCapM = lnTSaldoCapM + lnTSaldoCapF
                            lnTNumVigM = lnTNumVigM + lnTNumVigF
                            lnTCapVigM = lnTCapVigM + lnTCapVigF
                            lnTNumVen1M = lnTNumVen1M + lnTNumVen1F
                            lnTCapVen1M = lnTCapVen1M + lnTCapVen1F
                            lnTNumVen2M = lnTNumVen2M + lnTNumVen2F
                            lnTCapVen2M = lnTCapVen2M + lnTCapVen2F
                            lnTNumJudM = lnTNumJudM + lnTNumJudF
                            lnTCapJudM = lnTCapJudM + lnTCapJudF
                            ' *****  Imprime
                            'lsRTfImp = lsRTfImp & Chr(10)
                            lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
                            lsRtfImp = lsRtfImp & Mid(lsDescF, 1, 15)
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTCredF, 10, 0, True)
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapF, 13, 2, True) & " | "
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigF, 8, 0, True)
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigF, 13, 2, True) & " | "
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1F, 7, 0, True)
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1F, 12, 2, True) & " | "
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2F, 7, 0, True)
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2F, 12, 2, True) & " | "
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudF, 7, 0, True)
                            lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudF, 12, 2, True) & " | "
                            lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapF - lnTCapVigF) / IIf(lnTSaldoCapF = 0, 1, lnTSaldoCapF)) * 100, 2), 3, 2) & "%"
                            lsRtfImp = lsRtfImp & Chr(10)
                            lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
                            lsRtfImp = lsRtfImp & Chr(10)
                            liLineas = liLineas + 5
                               
                               
                        End If  ' Fin de Fuente financiamiento
                        
                        rsFF.MoveNext
                          ' Arturo
                    Loop  ' De la Fuente Financiamiento
                    
                            
                    ' **********************
                    ' ************ Asigna Valores a Moneda
                    lnTCred = lnTCred + lnTCredM
                    lnTSaldoCap = lnTSaldoCap + lnTSaldoCapM
                    lnTNumVig = lnTNumVig + lnTNumVigM
                    lnTCapVig = lnTCapVig + lnTCapVigM
                    lnTNumVen1 = lnTNumVen1 + lnTNumVen1M
                    lnTCapVen1 = lnTCapVen1 + lnTCapVen1M
                    lnTNumVen2 = lnTNumVen2 + lnTNumVen2M
                    lnTCapVen2 = lnTCapVen2 + lnTCapVen2M
                    lnTNumJud = lnTNumJud + lnTNumJudM
                    lnTCapJud = lnTCapJud + lnTCapJudM
                    ' *****  Imprime
                    lsRtfImp = lsRtfImp & Chr(10)
                    lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
                    lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
                    lsRtfImp = lsRtfImp & " TOTAL Moneda  "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCredM, 10, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapM, 13, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigM, 8, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigM, 13, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1M, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1M, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2M, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2M, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudM, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudM, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapM - lnTCapVigM) / IIf(lnTSaldoCapM = 0, 1, lnTSaldoCapM)) * 100, 2), 3, 2) & "%"
                    lsRtfImp = lsRtfImp & Chr(27) & Chr(70)
                    lsRtfImp = lsRtfImp & Chr(10)
                    lsRtfImp = lsRtfImp & String(155, "=") & Chr(10)
                    lsRtfImp = lsRtfImp & Chr(10)
                    liLineas = liLineas + 5
                End If
             
            End If '---liDatos - Moneda
            lbSiCambio = True
            
            If Not RsM.EOF Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                liLineas = 0
            End If
            RaiseEvent Progress(RsM.Bookmark, RsM.RecordCount)
            RsM.MoveNext
        Loop ' ---- Moneda
    End If '--- Moneda
    RaiseEvent CloseProgress
    RsM.Close
    Set RsM = Nothing
    Conecta.CierraConexion
Else
    nRepo108701_CarteraColocacionesxMoneda = " " 'False
End If '--- liDatos - General
nRepo108701_CarteraColocacionesxMoneda = lsRtfImp ' Asigna el valor
Screen.MousePointer = 1
End Function

Public Function nRepo108704_ImpRepCarteraAgencia_Prod(pPlanCuentas As String, _
        pTipoCambio As Single, psConcepto As String, psServConsol As String) As String

'* Concepto C=Capital / D=Devengado  / S = Suspenso
Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPla As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String
Dim lsDescP As String
Dim lsDescF As String
Dim lsDescAG As String * 15

Dim liLineas As Integer
Dim liDatos  As Long

Dim lnTCred As Single  ' *** General
Dim lnTSaldoCap As Double
Dim lnTNumVig As Single
Dim lnTCapVig As Double
Dim lnTNumVen1 As Integer
Dim lnTCapVen1  As Double
Dim lnTNumVen2 As Integer
Dim lnTCapVen2 As Double
Dim lnTNumJud As Integer
Dim lnTCapJud As Double

Dim lnTCredT As Single  ' *** Total
Dim lnTSaldoCapT As Double
Dim lnTNumVigT As Single
Dim lnTCapVigT As Double
Dim lnTNumVen1T As Integer
Dim lnTCapVen1T  As Double
Dim lnTNumVen2T As Integer
Dim lnTCapVen2T As Double
Dim lnTNumJudT As Integer
Dim lnTCapJudT As Double

Dim lnTCredM(7) As Single  ' *** Moneda
Dim lnTSaldoCapM(7) As Double

Dim lnTCredF As Single  ' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double

Dim lnTCredAG As Single  ' *** Agencia
Dim lnTSaldoCapAG As Double

Dim lnTCredPr(6) As Single  ' *** Producto
Dim lnTSaldoCapPr(6) As Double

Dim lnTCredMonAG As Single  ' *** Moneda Agencia
Dim lnTSaldoCapMonAG As Double


Dim lnTSaldoCapTCons As Double

Dim lbSiCambio As Boolean
Dim cadena As String

Dim lnCapVencido As Currency  'Para los consumo

Dim prod(6) As String
Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsRtfImp As String
Dim cpag As Integer

Dim lnCredAdmin As Integer ' Bandera Para Cred Admin


Dim RCD As nRcdReportes
Dim Rss As New ADODB.Recordset
Set RCD = New nRcdReportes
Set Rss = RCD.GetQuery("select * from agencias")
ReDim lnTCredPrM(Rss.RecordCount, 7) As Single ' *** Producto Moneda
ReDim lnTSaldoCapPrM(Rss.RecordCount, 7) As Double

Dim Ag As Integer
Dim lsConcepto As String
Dim lsCondic As String

Dim lsCreditosVigentes As String
Dim lsCreditosPignoraticio As String
Dim lsCreditosJudicial As String

Dim i As Integer
Dim lsRtfImpG As String

Dim lSSQL9 As String

lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
'lsCreditosPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
lsCreditosPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
lsCreditosJudicial = gColocEstRecVigJud & ",2205"


If psConcepto = "C" Then
   lsConcepto = "nSaldoCap"
   lsCondic = " nSaldoCap > 0 "
ElseIf psConcepto = "D" Then
   lsConcepto = "nIntDev"
   lsCondic = " nDiasAtraso <= (case when substring(cCtaCod,9,1) = '1' then 15 else 30 end ) and cRefinan ='N' "
ElseIf psConcepto = "S" Then
   lsConcepto = "nIntDev"
   lsCondic = " ((nDiasAtraso > (case when substring(cCtaCod,9,1) = '1' then 15 else 30 end ) and cRefinan ='N') or (cRefinan = 'R') ) "
End If


' Para Cada Producto
'prod(0) = " '101','102' "  ' Comercial
'prod(1) = " '201' "  ' Pyme-Mes
'prod(2) = " '301','302','303','304' "  ' Consumo
'prod(3) = " '305' "  ' Prendario
'prod(4) = " '401','423'" ' Hipotecario
'prod(5) = " '202' "  ' Agricola
'prod(6) = " '320'" ' Administrativo

'04/12/06--------------------------
prod(0) = "101, 102"  ' Comerciales
prod(1) = "201" ' Pyme
prod(2) = "301, 302, 303, 304, 320"  ' Consumo
prod(3) = " 305" ' Pignoraticio
prod(4) = " 401,403,423 " ' Hipotecaja
prod(5) = " 202" ' Agrícola

'prod(0) = RecuperaCadenaTipoProducto("1")   ' Comerciales
'prod(1) = RecuperaCadenaTipoProducto("2")   ' Pyme
'----------------------------------
'prod(2) = RecuperaCadenaTipoProducto("3")   ' Consumo
'prod(3) = " '202'"  ' Agricola
'prod(3) = " '305'" ' Pignoraticio
'prod(5) = " '320'" ' Administrativos
'prod(6) = " '401'" ' Hipotecaja
'prod(4) = RecuperaCadenaTipoProducto("4")  ' Mivivienda

lbSiCambio = False
lsRtfImp = ""
cpag = 1

cadena = ""

Ag = 0
Dim lnTCreTAgCons As Single  ' Total Agencia Consolidado
Dim lnTSaldoCapTAgCons As Currency

Dim lnTCreTProdCons(6) As Single  ' Total Producto Consolidado
Dim lnTSaldoCapTProdCons(6) As Currency


'===== Verificar si existen datos para el reporte
lSSQL9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol  " & _
       "Where nPrdEstado in (" & lsCreditosVigentes & "," & lsCreditosJudicial & "," & lsCreditosPignoraticio & " ) "

Set Reg9 = GetQuery(lSSQL9)
If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then  ' General
   '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)
        Set loConst = Nothing

   '========= Fuente Financiamiento =========
    'Set rsFF = ObtieneLineaCredito 'Fuente Financiamiento

    Dim loAg As DAgencias
        Set loAg = New DAgencias
            Set rsAg = loAg.RecuperaAgencias
        Set loAg = Nothing

    nRepo108704_ImpRepCarteraAgencia_Prod = ""
    'lsRTfImp = lsRTfImp & CabRepCarteraAgencia_Prod(cpag, pTipoCambio, pPlanCuentas)
    liLineas = 5

    If RsM.EOF And RsM.BOF Then
    Else
       RaiseEvent ShowProgress
       Do While Not RsM.EOF
          lsRtfImp = lsRtfImp & CabRepCarteraAgencia_Prod_NEW(cpag, pTipoCambio, pPlanCuentas, , "108704")
          '=====LIMPIAR LOS DATOS SUBTOTALES POR MONEDA ======
          'For i = 0 To 6
          For i = 0 To 7
              lnTCredM(i) = 0:     lnTSaldoCapM(i) = 0
          Next i
          lnTSaldoCapMonAG = 0
          lsDescM = Trim(RsM!cConsDescripcion)
          lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
          lsRtfImp = lsRtfImp & " MONEDA      : " & lsDescM & Chr(27) & Chr(70) & Chr(10)
          liLineas = liLineas + 1
          'For i = 1 To 5  ' Limpiar
          '    lnTCredPrM(i) = 0:     lnTSaldoCapPrM(i) = 0
          'Next i

          '======= Para Cada Agencia  =========
          Ag = 0
          rsAg.MoveFirst
          Do While Not rsAg.EOF
             Ag = Ag + 1
             lnTCredAG = 0: lnTSaldoCapAG = 0
             lsDescAG = Mid(rsAg!cAgeDescripcion, 1, 20)
             lsRtfImp = lsRtfImp & Chr(10) & lsDescAG  'lsDescAG

             'For i = 0 To 4 '6 'Para Cada Producto
             For i = 0 To 5 '6 'Para Cada Producto

                lnTCredPr(i) = 0:     lnTSaldoCapPr(i) = 0
                'lnTNumVigPr = 0:   lnTCapVigPr = 0

                '=================================================
                '===== Total Cartera  Producto de MONEDA  ======
                 Select Case i
                   Case 0, 1, 2, 4, 5 ', 6
                      
                      Sql9 = "SELECT COUNT(cCtaCod) AS Numero, SUM(" & lsConcepto & ") AS Capital " & _
                               " FROM " & psServConsol & "CreditoConsol " & _
                               " WHERE nPrdEstado in (  " & lsCreditosVigentes & ") " & _
                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                               " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ") " & _
                               " AND " & lsCondic

                      Set Reg9 = GetQuery(Sql9)

                      lnTCredPr(i) = Reg9!Numero
                      lnTSaldoCapPr(i) = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                      Reg9.Close
                      Set Reg9 = Nothing
                      If psConcepto = "C" Or psConcepto = "S" Then
                        ' Judicial -------------
                         Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                              " SUM(" & lsConcepto & ") AS Capital " & _
                             " FROM " & psServConsol & "CreditoConsol " & _
                             " WHERE nPrdEstado in (" & lsCreditosJudicial & " ) " & _
                             " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                             " AND  substring(cCtaCod,9,1)= '" & Trim(RsM!nConsValor) & "'" & _
                             " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                         Set Reg9 = GetQuery(Sql9)
                         lnTCredPr(i) = lnTCredPr(i) + Reg9!Numero
                         lnTSaldoCapPr(i) = lnTSaldoCapPr(i) + IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                         Reg9.Close
                         Set Reg9 = Nothing
                      End If

                   Case 3
                      lsDescPr = " Prendario  "
                      ' Pignoraticio  ------------
                      If Trim(RsM!nConsValor) = "1" Then  ' Si es Soles
                         Sql9 = "SELECT count(cCtaCod) as Numero, Sum(" & lsConcepto & ") AS Capital " & _
                               " FROM " & psServConsol & "CreditoConsol WHERE nPrdEstado IN ( " & lsCreditosPignoraticio & " ) " & _
                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                               " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ") " & _
                               " AND " & lsCondic
                         Set Reg9 = GetQuery(Sql9)
                         lnTCredPr(i) = Reg9!Numero
                         lnTSaldoCapPr(i) = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                         Reg9.Close
                         Set Reg9 = Nothing
                      End If

                 End Select

                ' ********************************************
                ' ***** Asigna Valores al Total agencia    ***
                ' ********************************************
                lnTCredAG = lnTCredAG + lnTCredPr(i)
                lnTSaldoCapAG = lnTSaldoCapAG + lnTSaldoCapPr(i)

                ' *************************************************
                ' ***** Asigna Valores al Producto Total Moneda ***
                ' *************************************************
                lnTCredM(i) = lnTCredM(i) + lnTCredPr(i)
                lnTSaldoCapM(i) = lnTSaldoCapM(i) + lnTSaldoCapPr(i)

                ' ***** Asigna Valores al Consolidado de Producto Moneda ***
                ' ***** y el cambio de moneda   *************
                lnTCredPrM(Ag, i) = lnTCredPrM(Ag, i) + lnTCredPr(i)
                lnTSaldoCapPrM(Ag, i) = lnTSaldoCapPrM(Ag, i) + IIf(Trim(RsM!nConsValor) = "1", lnTSaldoCapPr(i), lnTSaldoCapPr(i) * pTipoCambio)

                ' *****  Imprime Producto de la Moneda
                'lsRTfImp = lsRTfImp & Chr(10)
                'liLineas = liLineas + 1
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPr(i), 12, 2, True) & " | "
                'If i = 4 Then '6
                If i = 5 Then '6
                   lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAG, 12, 2, True) & " | " & Chr(10)
                End If
                'DoEvents

             Next i   ' Para el Sgte Producto
             'liLineas = liLineas + 4

             ' ** Sgte agencia
             rsAg.MoveNext
            
          Loop  ' de Agencia

         ' **********************
         ' *****  Imprime Totales de Moneda
         'lsRTfImp = lsRTfImp & Chr(10)
         lsRtfImp = lsRtfImp & String(140, "=") & Chr(10)
         lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
         lsRtfImp = lsRtfImp & " TOTAL MONEDA   "
        
         'For i = 0 To 4 '6
         For i = 0 To 5 '6
           'lsRTfImp = lsRTfImp & ImpreFormat(lnTCredM(i), 10, 0, True)
           lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapM(i), 12, 2, True) & " | "
           lnTSaldoCapMonAG = lnTSaldoCapMonAG + lnTSaldoCapM(i)
         Next i

         lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapMonAG, 12, 2, True) & " | "
         lsRtfImp = lsRtfImp & Chr(27) & Chr(70) & Chr(10)
         lsRtfImp = lsRtfImp & String(140, "=") & Chr(10)
         cpag = 1 + cpag
         RaiseEvent Progress(RsM.Bookmark, RsM.RecordCount)
         RsM.MoveNext
         lsRtfImp = lsRtfImp & Chr(12)

       Loop ' ---- Moneda de Producto

    End If
    lsRtfImp = lsRtfImp & CabRepCarteraAgencia_Prod_NEW(cpag, pTipoCambio, pPlanCuentas, , "108704")
    lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
    lsRtfImp = lsRtfImp & " CONSOLIDADO (Nuevos Soles) " & Chr(27) & Chr(70) & Chr(10)

    '======= Para Cada Agencia  =========
    Ag = 0
    rsAg.MoveFirst
    Do While Not rsAg.EOF
       Ag = Ag + 1
       lsDescAG = Mid(rsAg!cAgeDescripcion, 1, 20)
       'lsRTfImp = lsRTfImp & Chr(10)
       lsRtfImp = lsRtfImp & lsDescAG

       lnTCreTAgCons = 0
       lnTSaldoCapTAgCons = 0

       'For i = 0 To 4 '6  ' Consolidado
        For i = 0 To 5 '6  ' Consolidado
    
           'lsRTfImp = lsRTfImp & ImpreFormat(lnTCredPrM(i), 10, 0, True)
           lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPrM(Ag, i), 12, 2, True) & " | "

           'Total Agencia Consolidado
           lnTSaldoCapTAgCons = lnTSaldoCapTAgCons + lnTSaldoCapPrM(Ag, i)

           'Total Producto Consolidado
           lnTSaldoCapTProdCons(i) = lnTSaldoCapTProdCons(i) + lnTSaldoCapPrM(Ag, i)

       Next i
       lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapTAgCons, 12, 2, True) & " | " & Chr(10)
       liLineas = liLineas + 1
       rsAg.MoveNext
    Loop

    lsRtfImp = lsRtfImp & Chr(10)

''   ' **********************
''   ' *****  Imprime Totales Consolidado
    lsRtfImp = lsRtfImp & String(140, "=") & Chr(10)
    lsRtfImp = lsRtfImp & Chr(27) & Chr(69)
    lsRtfImp = lsRtfImp & "Tot. Consolidado"

    'Total Consolidado
    lnTSaldoCapTCons = 0

    'For i = 0 To 4 '6  ' Consolidado
    For i = 0 To 5 '6  ' Consolidado
        lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapTProdCons(i), 12, 2, True) & " | "
        'Total Consolidado
        lnTSaldoCapTCons = lnTSaldoCapTCons + lnTSaldoCapTProdCons(i)
    Next i

    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapTCons, 12, 2, True) & " | " & Chr(10)
    liLineas = liLineas + 1

    lsRtfImp = lsRtfImp & Chr(27) & Chr(70)
    lsRtfImp = lsRtfImp & String(140, "=") & Chr(10)

    RsM.Close
    Set RsM = Nothing
    RaiseEvent CloseProgress
Else
    nRepo108704_ImpRepCarteraAgencia_Prod = ""
End If '--- liDatos - General
lsRtfImpG = lsRtfImp ' Asigna el valor
Set RCD = Nothing
Set Rss = Nothing
Set rsAg = Nothing
nRepo108704_ImpRepCarteraAgencia_Prod = lsRtfImpG
Screen.MousePointer = 1
End Function


'******************* Imprime Reclasificacion Cartera / Intereses  **************
'*******************************************************************************
Function nRepo108705_ImpCarteraReclasificacion(pPlanCuentas As String, psServConsol As String, Optional psConcepto As String = "nSaldoCap") As String
Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPL As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String
Dim lsDescP As String
Dim lsDescF As String
Dim lsDescAG As String
Dim lsDescSubPr As String
Dim lsDescPL As String

Dim liLineas As Integer
Dim liDatos  As Long

Dim lnTCred As Single  ' *** General
Dim lnTSaldoCap As Double
Dim lnTNumVig As Single
Dim lnTCapVig As Double
Dim lnTNumVen1 As Integer
Dim lnTCapVen1  As Double
Dim lnTNumVen2 As Integer
Dim lnTCapVen2 As Double
Dim lnTNumJud As Integer
Dim lnTCapJud As Double
Dim lnTCapVenNJud As Double
Dim lnTCapVenSJud As Double

Dim lnTCredM As Single  ' *** Moneda
Dim lnTSaldoCapM As Double
Dim lnTNumVigM As Single
Dim lnTCapVigM As Double
Dim lnTNumVen1M As Integer
Dim lnTCapVen1M  As Double
Dim lnTNumVen2M As Integer
Dim lnTCapVen2M As Double
Dim lnTNumJudSDemM As Integer  ' Sin Deman
Dim lnTCapJudSDemM As Double
Dim lnTNumJudCDemM As Integer  ' Con Deman
Dim lnTCapJudCDemM As Double

Dim lnTCredF As Single  ' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double
Dim lnTNumVigF As Single
Dim lnTCapVigF As Double
Dim lnTNumVen1F As Integer
Dim lnTCapVen1F  As Double
Dim lnTNumVen2F As Integer
Dim lnTCapVen2F As Double
Dim lnTNumJudSDemF As Integer  'Sin Dema
Dim lnTCapJudSDemF As Double
Dim lnTNumJudCDemF As Integer  'Con Deman
Dim lnTCapJudCDemF As Double

Dim lnTCredAG As Single  ' *** Agencia
Dim lnTSaldoCapAG As Double
Dim lnTNumVigAG As Single
Dim lnTCapVigAG As Double
Dim lnTNumVen1AG As Integer
Dim lnTCapVen1AG  As Double
Dim lnTNumVen2AG As Integer
Dim lnTCapVen2AG As Double
Dim lnTNumJudSDemAG As Integer  'sin Dema
Dim lnTCapJudSDemAG As Double
Dim lnTNumJudCDemAG As Integer  'con dema
Dim lnTCapJudCDemAG As Double

Dim lnTCredPr As Single  ' *** Producto - detalle
Dim lnTSaldoCapPr As Double
Dim lnTNumVigPr As Single
Dim lnTCapVigPr As Double
Dim lnTNumVen1Pr As Integer
Dim lnTCapVen1Pr  As Double
Dim lnTNumVen2Pr As Integer
Dim lnTCapVen2Pr As Double
Dim lnTNumJudSDemPr As Integer
Dim lnTCapJudSDemPr As Double
Dim lnTNumJudCDemPr As Integer
Dim lnTCapJudCDemPr As Double

Dim lnTCredSubPr As Single  ' *** Sub Producto
Dim lnTSaldoCapSubPr As Double
Dim lnTNumVigSubPr As Single
Dim lnTCapVigSubPr As Double
Dim lnTNumVen1SubPr As Integer
Dim lnTCapVen1SubPr  As Double
Dim lnTNumVen2SubPr As Integer
Dim lnTCapVen2SubPr As Double
Dim lnTNumJudSDemSubPr As Integer
Dim lnTCapJudSDemSubPr As Double
Dim lnTNumJudCDemSubPr As Integer
Dim lnTCapJudCDemSubPr As Double

Dim lnTCredProd As Single  ' *** Producto
Dim lnTSaldoCapProd As Double
Dim lnTNumVigProd As Single
Dim lnTCapVigProd As Double
Dim lnTNumVen1Prod As Integer
Dim lnTCapVen1Prod  As Double
Dim lnTNumVen2Prod As Integer
Dim lnTCapVen2Prod As Double
Dim lnTNumJudSDemProd As Integer
Dim lnTCapJudSDemProd As Double
Dim lnTNumJudCDemProd As Integer
Dim lnTCapJudCDemProd As Double

Dim lnTCredPL As Single  ' *** Plazo
Dim lnTSaldoCapPL As Double
Dim lnTNumVigPL As Single
Dim lnTCapVigPL As Double
Dim lnTNumVen1PL As Integer
Dim lnTCapVen1PL  As Double
Dim lnTNumVen2PL As Integer
Dim lnTCapVen2PL As Double
Dim lnTNumJudSDemPL As Integer
Dim lnTCapJudSDemPL As Double
Dim lnTNumJudCDemPL As Integer
Dim lnTCapJudCDemPL As Double

Dim lbSiCambio As Boolean
Dim cadena As String

Dim lnCapVencido As Currency  'Para los consumo

Dim prod(7) As String
Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsRtfImp As String
Dim cpag As Integer

Dim lnCredAdmin As Integer ' Bandera Para Cred Admin

Dim NumSubProd As Integer ' SubProductos
Dim SubProd(7, 7) As String
Dim J As Integer
Dim NorRef As Integer

'** CAMBIOS SIMON
Dim lsConceptoJud As String
Dim lsCondJud As String
Dim lsConcepto As String
Dim lsArcTmp As String

Dim i As Integer

If psConcepto = "nSaldoCap" Then
   lsConceptoJud = "nSaldoCap"
   lsCondJud = " nSaldoCap > 0 "
Else
   lsConceptoJud = "nIntDev"
   lsCondJud = " nIntDev > 0 "
End If

If psConcepto = "nSaldoCap" Then
   lsConcepto = "C"
Else
   lsConcepto = "I"
End If

'********************

' Para Cada SubProducto
SubProd(0, 0) = " '101' " ' Comerciales
'SubProd(0, 1) = " '' " ' Comerciales Automatico
SubProd(1, 0) = " '201' " ' Pyme
'SubProd(1, 1) = " '' " ' Pyme DxP
'SubProd(1, 2) = " '' " ' Pyme DxP
'SubProd(1, 3) = " '' " ' ????
'SubProd(1, 4) = " '' " ' Credidiario
SubProd(2, 0) = " '301' " ' Personales
SubProd(2, 1) = " '302' "
SubProd(2, 2) = " '303' "
SubProd(2, 3) = " '304' "
'SubProd(2, 4) = " '' "
'SubProd(2, 5) = " '' "
SubProd(3, 0) = " '102' " ' Agricola
SubProd(3, 1) = " '202' "
SubProd(4, 0) = " '305' " ' Pignoraticio
SubProd(5, 0) = " '320' " ' Administrativos
SubProd(6, 0) = " '401' " ' Hipotecario
SubProd(6, 1) = " '403' " ' Hipotecario
SubProd(7, 0) = " '423' " ' Mivivienda

' Para Cada Producto
prod(0) = " '101' "  ' Comerciales
prod(1) = " '201' "  ' Pyme
prod(2) = " '301','302','303','304'"  ' Personales
prod(3) = " '102','202' "  ' Agricola
prod(4) = " '305'" ' Pignoraticio
prod(5) = " '320'" ' Administrativos
prod(6) = " '401','403'" ' Hipotecario
prod(7) = " '423'" ' Mivivienda

lbSiCambio = False
lsRtfImp = ""
cpag = 1

cadena = ""

'ABRE CONEXION
Dim oCon As DConecta
Set oCon = New DConecta
oCon.AbreConexion

Dim rsFecha As ADODB.Recordset
Set rsFecha = New ADODB.Recordset
Dim sql As String
sql = "Select nConsSisValor from constsistema Where nConsSisCod = 14"
Set rsFecha = oCon.CargaRecordSet(sql)

gdFecData = rsFecha.Fields(0)

'===== Verificar si existen datos para el reporte
Sql9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol where nPrdEstado in (2020,2021,2022,2030,2031,2032,2101,2104,2106,2107,2201) "
Set Reg9 = oCon.CargaRecordSet(Sql9)
'Reg9.Open Sql9, dbCmactCentral, adOpenStatic, adLockReadOnly, adCmdText

If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then  ' General
   Sql9 = "DELETE " & psServConsol & "CredSaldosCont WHERE dFecha = '" & Format(gdFecData, "mm/dd/yyyy") & "' and cConcepto = '" & lsConcepto & "'"
   oCon.Ejecutar Sql9

    '****************************************************************
    '****** Creo la tabla Temporal **********************************
    lsArcTmp = "##CredReclasifica" & lsConcepto
    ' Crea la tabla temporal
    Sql9 = " create table " & lsArcTmp & " " _
      & "( cMoneda Integer, " _
      & " cProducto char(3), " _
      & " cAgencia char(2), " _
      & " cFFinanc char (4), " _
      & " cPlazo char (1), " _
      & " cRefinan char(1), " _
      & " nDemanda int, " _
      & " TotNro real, " _
      & " TotSaldo money, " _
      & " VigNro real, " _
      & " VigSaldo money,  " _
      & " Ven1Nro real, " _
      & " Ven1Saldo money, " _
      & " Ven2Nro real, " _
      & " Ven2Saldo money, " _
      & " JudSDNro real, " _
      & " JudSDSaldo money, " _
      & " JudCDNro real, " _
      & " JudCDSaldo money " _
      & "    ) "

    oCon.Ejecutar Sql9
    ' LLena la tabla temporal
    Sql9 = " Insert into " & lsArcTmp & " " _
         & " SELECT substring(cLineaCred,5,1) Moneda, substring(cCtaCod,6,3) Producto , substring(cCtaCod,4,2) Agencia, " _
         & " Substring(cLineaCred,1,4) FFinanc, substring(cLineaCred, 6,1) Plazo, cRefinan, Isnull(nDemanda,2) nDemanda, " _
         & " COUNT(cCtaCod) AS TotNro, SUM(" & psConcepto & ") AS TotSaldoCap , " _
         & " COUNT(case when substring(cCtaCod,6,1) ='1' and nPrdEstado not in (2201) and nDiasAtraso <= 15 then cCtaCod " _
         & "            when substring(cCtaCod,6,1) ='2' and nPrdEstado not in (2201) and nDiasAtraso <= 30 then cCtaCod " _
         & "            when substring(cCtaCod,6,1) In ('3','4') and nPrdEstado not in (2201) and nDiasAtraso <= 30 then cCtaCod " _
         & " end) VigNro, " _
         & " Isnull(SUM(case when substring(cCtaCod,6,1) ='1' and nPrdEstado not in (2201,2205) and nDiasAtraso <= 15 then " & psConcepto & " " _
         & "                 when substring(cCtaCod,6,1) ='2' and nPrdEstado not in (2201,2205) and nDiasAtraso <= 30 then " & psConcepto & " " _
         & "                 when substring(cCtaCod,6,1) in('3','4') and nPrdEstado not in (2201,2205) and nDiasAtraso <= 30 then " & psConcepto & " " _
         & "                 when substring(cCtaCod,6,1) in('3','4') and nPrdEstado not in (2201,2205) and nDiasAtraso > 30 and nDiasAtraso <= 90 " _
         & "                      then " & IIf(lsConcepto = "C", "nSaldoCap - IsNull(nCapVencido,0)", "0") _
         & "  end),0) VigSaldo , " _
         & " COUNT(case when substring(cCtaCod,6,1) ='1' and nPrdEstado not in (2201,2205) and nDiasAtraso > 15 then cCtaCod " _
         & "            when substring(cCtaCod,6,1) ='2' and nPrdEstado not in (2201,2205) and nDiasAtraso > 30 then cCtaCod " _
         & "            when substring(cCtaCod,6,1) in('3','4') and nPrdEstado not in (2201,2205) and nDiasAtraso > 30 and nDiasAtraso <= 90 then cCtaCod " _
         & "  end) Ven1Nro, " _
         & " Isnull(SUM(case when substring(cCtaCod,6,1) ='1' and nPrdEstado not in (2201,2205) and nDiasAtraso > 15 then " & psConcepto & " " _
         & "                 when substring(cCtaCod,6,1) ='2' and nPrdEstado not in (2201,2205) and nDiasAtraso > 30 then " & psConcepto & " " _
         & "                 when substring(cCtaCod,6,1) in('3','4') and nPrdEstado not in (2201,2205) and nDiasAtraso > 30 and nDiasAtraso <= 90 " _
         & "                      then " & IIf(lsConcepto = "C", "IsNull(nCapVencido,0)", "nIntDev") & "  " _
         & " end),0) Ven1Saldo , "
    Sql9 = Sql9 _
         & " COUNT(case when substring(cCtaCod,6,1) in('3','4') and nPrdEstado not in (2201,2205) and nDiasAtraso > 90 then cCtaCod " _
         & "       end) Ven2Nro, " _
         & " Isnull(SUM(case when substring(cCtaCod,6,1) in('3','4') and nPrdEstado not in (2201,2205) and nDiasAtraso > 90 then " & psConcepto & " " _
         & "            end),0) Ven2Saldo, " _
         & " COUNT(case when nPrdEstado in (2201,2205) and IsNull(nDemanda,2) = 2 then cCtaCod " _
         & "       end) JudSDNro, " _
         & " Isnull(SUM(case when nPrdEstado in (2201,2205) and IsNull(nDemanda,2) = 2 then " & psConcepto & "  " _
         & "            end),0) JudSDSaldo, " _
         & " COUNT(case when nPrdEstado in (2201,2205) and IsNull(nDemanda,2) = 1 then cCtaCod " _
         & "       end) JudCDNro, " _
         & " Isnull(SUM(case when nPrdEstado in (2201,2205) and IsNull(nDemanda,2) = 1 then " & psConcepto & "  " _
         & "       end),0) JudCDSaldo " _
         & " From " & psServConsol & "CreditoConsol " _
         & " WHERE ( nPrdEstado in (2020,2021,2022,2030,2031,2032,2101,2104,2106,2107,2201,2205 ) ) " _
         & "  " _
         & " Group By substring(cLineaCred,5,1), substring(cCtaCod,6,3) , substring(cCtaCod,4,2), " _
         & " Substring(cLineaCred,1,4), substring(cLineaCred, 6,1), cRefinan , IsNull(nDemanda,2) " _
         & " Order By substring(cLineaCred,5,1), substring(cCtaCod,6,3) , substring(cCtaCod,4,2),  " _
         & " substring(cLineaCred,1,4), substring(cLineaCred, 6,1), cRefinan , IsNull(nDemanda,2) "
    oCon.Ejecutar Sql9
    'SANDRA LA DEL MILLON /*And nSaldoCap > 0*/
    ' Indexa la temporal
    Sql9 = " CREATE INDEX [Reclasif_1] ON [" & lsArcTmp & "]([cMoneda], [cProducto], [cAgencia], [cFFinanc], [cPlazo]) WITH  FILLFACTOR = 90  ON [PRIMARY] "
    oCon.Ejecutar Sql9
    
        Dim loConst As DConstante
    Set loConst = New DConstante

    '======== Tipo de Moneda =========
    Set RsM = loConst.RecuperaConstantes(gMoneda) ' Moneda
   '========= Fuente Financiamiento =========
    Set rsFF = ObtieneLineaCredito  ' Fuente Financiamiento
    '======== Tipo de Plazo =========
    Set rsPL = loConst.RecuperaConstantes(gColocLineaCredPlazo)
    Set loConst = Nothing
    
   '======= Para Cada Agencia  =========
    'Sql9 = " SELECT cNomTab,cValor FROM TABLACOD " & _
           " WHERE cCodTab like '47%' AND cValor like '112%'  ORDER BY cValor "
    Dim loAg As DAgencias
    Set loAg = New DAgencias
    Set rsAg = loAg.RecuperaAgencias
    Set loAg = Nothing
    'rsAg.Open Sql9, dbCmactCentral, adOpenStatic, adLockReadOnly, adCmdText
    
    nRepo108705_ImpCarteraReclasificacion = ""
    
    If RsM.EOF And RsM.BOF Then
    Else
        Do While Not RsM.EOF
            '=====LIMPIAR LOS DATOS SUBTOTALES POR MONEDA ======
            lnTCredM = 0:   lnTSaldoCapM = 0
            lnTNumVigM = 0: lnTCapVigM = 0
            lnTNumVen1M = 0: lnTCapVen1M = 0
            lnTNumVen2M = 0: lnTCapVen2M = 0
            lnTNumJudSDemM = 0: lnTCapJudSDemM = 0
            lnTNumJudCDemM = 0: lnTCapJudCDemM = 0
            lsDescM = Trim(RsM!cConsDescripcion)
            '============ CREDITOS VIGENTES PARA UNA DETERMINADA MONEDA =========
            Sql9 = "SELECT Count(*) AS NumCred FROM " & lsArcTmp & " C " & _
                "WHERE  " & _
                "cMoneda = '" & Trim(RsM!nConsValor) & "'"
            Set Reg9 = oCon.CargaRecordSet(Sql9)
            'Reg9.Open Sql9, dbCmactCentral, adOpenStatic, adLockReadOnly, adCmdText
            
            If Reg9.EOF And Reg9.BOF Then
                liDatos = 0
            Else
                liDatos = Reg9!NumCred
            End If
            Reg9.Close
            Set Reg9 = Nothing
            
            If liDatos > 0 Then  ' De la Moneda
                lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                liLineas = 6
                If lbSiCambio Then
                    lbSiCambio = False
                End If
                lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                lsRtfImp = lsRtfImp & " * MONEDA             : " & lsDescM & Chr(27) & Chr(70) & Chr(10)
                liLineas = liLineas + 2
                
                '========= CREDITOS VIGENTES PARA PRODUCTO  =========
                 For i = 0 To 7  'Para Cada Producto
                   
                   Select Case i
                      Case 0
                         lsDescPr = " Comercial    "
                      Case 1
                         lsDescPr = " Pyme         "
                      Case 2
                         lsDescPr = " Personal     "
                      Case 3
                         lsDescPr = " Agricola     "
                      Case 4
                         lsDescPr = " Pignoraticio "
                      Case 5
                         lsDescPr = " Administrat  "
                      Case 6
                         lsDescPr = " Hipotecario  "
                      Case 7
                         lsDescPr = " Mivivienda   "
                   End Select
                   
                   '=========== CREDITOS DEL PRODUCTO =============
                     Sql9 = "SELECT count(*) as NumCred FROM " & lsArcTmp & " C  " & _
                         " where cMoneda ='" & Trim(RsM!nConsValor) & "' " & _
                         " AND cProducto in ( " & prod(i) & ")"
                         
                     lnTCredProd = 0:   lnTSaldoCapProd = 0
                     lnTNumVigProd = 0: lnTCapVigProd = 0
                     lnTNumVen1Prod = 0: lnTCapVen1Prod = 0
                     lnTNumVen2Prod = 0: lnTCapVen2Prod = 0
                     lnTNumJudSDemProd = 0: lnTCapJudSDemProd = 0
                     lnTNumJudCDemProd = 0: lnTCapJudCDemProd = 0
                     
                     If HayDatosConec(Sql9, oCon) > 0 Then   ' Para Producto
                     
                        lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                        lsRtfImp = lsRtfImp & " ** PRODUCTO          : " & lsDescPr & Chr(27) & Chr(70) & Chr(10)
                        liLineas = liLineas + 3
                        
                        
                        '======= Para Cada Agencia  =========
                        rsAg.MoveFirst
                        Do While Not rsAg.EOF
                                 
                            Sql9 = "SELECT count(*) as NumCred FROM " & lsArcTmp & " C " & _
                                " Where cMoneda ='" & Trim(RsM!nConsValor) & "' " & _
                                " AND cProducto in ( " & prod(i) & ")" & _
                                " AND cAgencia = '" & rsAg!cAgeCod & "'"
                              
                              lnTCredAG = 0:   lnTSaldoCapAG = 0
                              lnTNumVigAG = 0: lnTCapVigAG = 0
                              lnTNumVen1AG = 0: lnTCapVen1AG = 0
                              lnTNumVen2AG = 0: lnTCapVen2AG = 0
                              lnTNumJudSDemAG = 0: lnTCapJudSDemAG = 0
                              lnTNumJudCDemAG = 0: lnTCapJudCDemAG = 0
                             
                             If HayDatosConec(Sql9, oCon) > 0 Then    ' De la Agencia

                                 lsDescAG = rsAg!cAgeDescripcion
                                 lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                 lsRtfImp = lsRtfImp & " *** AGENCIA          : " & lsDescAG & Chr(27) & Chr(70) & Chr(10)
                                 liLineas = liLineas + 2
                                 
                                
                                 '========= CREDITOS VIGENTES PARA SUB PRODUCTOS  =========
                                 If i = 0 Then  ' Comerciales
                                    NumSubProd = 0
                                 ElseIf i = 1 Then  ' / Pyme
                                    NumSubProd = 0
                                 ElseIf i = 2 Then  ' Consumo
                                    NumSubProd = 3
                                 ElseIf i = 3 Then  ' Comerciales
                                    NumSubProd = 1
                                 ElseIf i = 4 Then  ' Prendario
                                    NumSubProd = 0
                                 ElseIf i = 5 Then  ' RRHH
                                    NumSubProd = 0
                                 ElseIf i = 6 Then  ' Hipotecario
                                    NumSubProd = 1
                                 ElseIf i = 7 Then  ' Mi Vivienda
                                    NumSubProd = 0
                                 Else  ' Resto
                                    NumSubProd = 0
                                 End If
                                 For J = 0 To NumSubProd  'Para Cada SubProductos
                                   
                                    lnTCredSubPr = 0:    lnTSaldoCapSubPr = 0
                                    lnTNumVigSubPr = 0:  lnTCapVigSubPr = 0
                                    lnTNumVen1SubPr = 0: lnTCapVen1SubPr = 0
                                    lnTNumVen2SubPr = 0: lnTCapVen2SubPr = 0
                                    lnTNumJudSDemSubPr = 0:  lnTCapJudSDemSubPr = 0
                                    lnTNumJudCDemSubPr = 0:  lnTCapJudCDemSubPr = 0
                                    Select Case i
                                      Case 0
                                         Select Case J
                                            Case 0
                                             lsDescSubPr = " Comercial    "
                                            Case 1
                                             lsDescSubPr = " Comercial Aut"
                                         End Select
                                      Case 1
                                         Select Case J
                                            Case 0
                                               lsDescSubPr = " Pyme "
                                            Case 1
                                               lsDescSubPr = " Pyme DxP "
                                            Case 2
                                               lsDescSubPr = " Pyme Automat "
                                            Case 3
                                               lsDescSubPr = " Pyme Automat DxP "
                                         End Select
                                      Case 2
                                         Select Case J
                                            Case 0
                                               lsDescSubPr = " Dscto Planilla "
                                            Case 1
                                               lsDescSubPr = " Plazo Fijo     "
                                            Case 2
                                               lsDescSubPr = " C.T.S.         "
                                            Case 3
                                               lsDescSubPr = " Usos Diversos  "
                                            Case 4
                                               lsDescSubPr = " Consumo Automat   "
                                            Case 5
                                               lsDescSubPr = " Consumo Automat DxP "
                                         End Select
                                      Case 3
                                         Select Case J
                                            Case 0
                                               lsDescSubPr = " Agricola Com.  "
                                            Case 1
                                               lsDescSubPr = " Agricola Pyme  "
                                            End Select
                                      Case 4
                                         lsDescSubPr = " Pignoraticio "
                                      Case 5
                                         lsDescSubPr = " Administrat  "
                                      Case 6
                                         lsDescSubPr = " HipoteCaja     "
                                      Case 7
                                         lsDescSubPr = " Mi Vivienda    "
                                    End Select

                                   '=========== CREDITOS DEL SUB PRODUCTO =============
                                    'SQL9 = "SELECT count(*) as NumCred FROM " & lsArcTmp & " C " & _
                                        " where cMoneda = '" & Trim(rsm!nConsValor) & "'" & _
                                        " AND cProducto in ( " & prod(I) & ") " & _
                                        " AND cAgencia = '" & rsag!cAgeCod & "'" & _
                                        " AND cProducto in ( " & SubProd(I, j) & ") "
                                    Sql9 = "SELECT count(*) as NumCred FROM " & lsArcTmp & " C " & _
                                        " where cMoneda = '" & Trim(RsM!nConsValor) & "'" & _
                                        " AND cProducto in ( " & IIf(SubProd(i, J) = "", "''", SubProd(i, J)) & ") " & _
                                        " AND cAgencia = '" & rsAg!cAgeCod & "'"

                                    If HayDatosConec(Sql9, oCon) Then ' Para Sub Productos
                                        lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                        lsRtfImp = lsRtfImp & " **** SUB PRODUCTO    : " & lsDescSubPr & Chr(27) & Chr(70) & Chr(10)
                                        liLineas = liLineas + 2
                                        
                                       '========= CREDITOS VIGENTES PARA FUENTES FINANCIAMIENTO =========
                                        
                                        If rsFF.EOF And rsFF.BOF Then 'Fuente Financ
                                        Else
                                            rsFF.MoveFirst
                                            Do While Not rsFF.EOF 'Fuente Financ
                                               '=========== CREDITOS VIGENTES PARA UNA FUENTE FINANCIAMIENTO =============
                                                Sql9 = "SELECT count(*) as NumCred FROM " & lsArcTmp & " C " & _
                                                    " where cMoneda= '" & Trim(RsM!nConsValor) & "'" & _
                                                    " AND cProducto in ( " & SubProd(i, J) & ") " & _
                                                    " AND cAgencia  = '" & rsAg!cAgeCod & "'" & _
                                                    " AND cFFinanc IN ('" & Trim(rsFF!cLineaCred) & "')"
                        
                                                lnTCredF = 0: lnTSaldoCapF = 0
                                                lnTNumVigF = 0: lnTCapVigF = 0
                                                lnTNumVen1F = 0: lnTCapVen1F = 0
                                                lnTNumVen2F = 0: lnTCapVen2F = 0
                                                lnTNumJudSDemF = 0: lnTCapJudSDemF = 0
                                                lnTNumJudCDemF = 0: lnTCapJudCDemF = 0
                                                If HayDatosConec(Sql9, oCon) Then       ' De la Fuente Financ
                            
                                                    lsDescF = Trim(rsFF!CDescripcion)
                                                    lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                                    lsRtfImp = lsRtfImp & " ***** F. FINANCIAMIENTO   : " & lsDescF & Chr(27) & Chr(70) & Chr(10)
                                                    liLineas = liLineas + 2
                                                    
                                                    lsDescF = Mid(rsFF!CDescripcion, 1, 25)

                                                    '======= Para Cada PLAZO  =========
                                                    If rsPL.EOF And rsPL.BOF Then ' Plazo
                                                    Else
                                                        rsPL.MoveFirst
                                                        Do While Not rsPL.EOF ' Plazo
                                                           lnTCredPL = 0: lnTSaldoCapPL = 0
                                                           lnTNumVigPL = 0: lnTCapVigPL = 0
                                                           lnTNumVen1PL = 0: lnTCapVen1PL = 0
                                                           lnTNumVen2PL = 0: lnTCapVen2PL = 0
                                                           lnTNumJudSDemPL = 0: lnTCapJudSDemPL = 0
                                                           lnTNumJudCDemPL = 0: lnTCapJudCDemPL = 0
                                                           lsDescPL = Mid(rsPL!cConsDescripcion, 1, 25)
                                                           
                                                           '=========== CREDITOS PARA EL PLAZO =============
                                                            Sql9 = "SELECT count(*) as NumCred FROM " & lsArcTmp & " C " & _
                                                                " where cMoneda ='" & Trim(RsM!nConsValor) & "' " & _
                                                                " AND cProducto in ( " & SubProd(i, J) & ") " & _
                                                                " AND cAgencia = '" & rsAg!cAgeCod & "'" & _
                                                                " AND cFFinanc IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                " AND cPlazo ='" & Trim(rsPL!nConsValor) & "' "
                                                                
                                                             If HayDatosConec(Sql9, oCon) > 0 Then    ' Del PLAZO
    
                                                               For NorRef = 0 To 1
                                                                    
                                                                lnTCredPr = 0: lnTSaldoCapPr = 0
                                                                lnTNumVigPr = 0: lnTCapVigPr = 0
                                                                lnTNumVen1Pr = 0: lnTCapVen1Pr = 0
                                                                lnTNumVen2Pr = 0: lnTCapVen2Pr = 0
                                                                lnTNumJudSDemPr = 0: lnTCapJudSDemPr = 0
                                                                lnTNumJudCDemPr = 0: lnTCapJudCDemPr = 0
                                                                lnTCapVenNJud = 0: lnTCapVenSJud = 0
                                                                lsDescPr = ""
                                                               
                                                                'frmRepoConsolidado.Caption = lsDescM & "-" & lsDescPr & "-" & Trim(lsDescAG) & " -" & lsDescSubPr & " -" & rsff!cLineaCred
                                                                   
                                                                   '=================================================
                                                                   '===== Total Cartera  Producto de Agencia  ======
                                                                   '  Creditos ------------
                                                                   Sql9 = "SELECT Isnull(SUM(TotNro),0) AS TotNro, Isnull(SUM(TotSaldo),0) AS TotSaldo,  " & _
                                                                          " Isnull(SUM(VigNro),0) AS VigNro, Isnull(SUM(VigSaldo),0) as VigSaldo, " & _
                                                                          " Isnull(SUM(Ven1Nro),0) AS Ven1Nro, Isnull(SUM(Ven1Saldo),0) as Ven1Saldo, " & _
                                                                          " Isnull(SUM(Ven2Nro),0) as Ven2Nro, Isnull(SUM(Ven2Saldo),0) as Ven2Saldo, " & _
                                                                          " Isnull(SUM(JudSDNro),0) as JudSDNro, Isnull(SUM(JudSDSaldo),0) as JudSDSaldo, " & _
                                                                          " Isnull(SUM(JudCDNro),0) as JudCDNro, Isnull(SUM(JudCDSaldo),0) as JudCDSaldo " & _
                                                                          " FROM " & lsArcTmp & " " & _
                                                                          " where cMoneda ='" & Trim(RsM!nConsValor) & "' " & _
                                                                          " AND cProducto in ( " & SubProd(i, J) & ") " & _
                                                                          " AND cAgencia = '" & rsAg!cAgeCod & "'" & _
                                                                          " AND cFFinanc IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                          " AND cPlazo ='" & Trim(rsPL!nConsValor) & "' " & _
                                                                          " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'"
                                                                
                                                                   Reg9.CursorLocation = adUseClient
                                                                   Set Reg9 = oCon.CargaRecordSet(Sql9)
                                                                   'Reg9.Open Sql9, dbCmactCentral, adOpenStatic, adLockReadOnly, adCmdText
                                                                   
                                                                   Set Reg9.ActiveConnection = Nothing
                                                                   '====== Total Cartera
                                                                   lnTCredPr = Reg9!TotNro
                                                                   lnTSaldoCapPr = Reg9!totsaldo
                                                                   '====== Cartera Vigente
                                                                   lnTNumVigPr = Reg9!VigNro
                                                                   lnTCapVigPr = Reg9!VigSaldo
                                                                   '====== Cartera Vencida 1
                                                                   lnTNumVen1Pr = Reg9!Ven1Nro
                                                                   lnTCapVen1Pr = Reg9!Ven1Saldo
                                                                   '====== Cartera Vencida 2
                                                                   lnTNumVen2Pr = Reg9!Ven2Nro
                                                                   lnTCapVen2Pr = Reg9!Ven2Saldo
                                                                   '====== Judicial Sin Demanda
                                                                   lnTNumJudSDemPr = Reg9!JudSDNro
                                                                   lnTCapJudSDemPr = Reg9!JudSDSaldo
                                                                   '====== Judicial Con Demanda
                                                                   lnTNumJudCDemPr = Reg9!JudCDNro
                                                                   lnTCapJudCDemPr = Reg9!JudCDSaldo
                                                                   
                                                                   Reg9.Close
                                                                   Set Reg9 = Nothing
                                                                   
                                                                   '=================================================
                                           
                                                                   ' ***************************************
                                                                   ' ***** Asigna Valores a la Agencia ******
                                                                   lnTCredPL = lnTCredPL + lnTCredPr
                                                                   lnTSaldoCapPL = lnTSaldoCapPL + lnTSaldoCapPr
                                                                   lnTNumVigPL = lnTNumVigPL + lnTNumVigPr
                                                                   lnTCapVigPL = lnTCapVigPL + lnTCapVigPr
                                                                   lnTNumVen1PL = lnTNumVen1PL + lnTNumVen1Pr
                                                                   lnTCapVen1PL = lnTCapVen1PL + lnTCapVen1Pr
                                                                   lnTNumVen2PL = lnTNumVen2PL + lnTNumVen2Pr
                                                                   lnTCapVen2PL = lnTCapVen2PL + lnTCapVen2Pr
                                                                   lnTNumJudSDemPL = lnTNumJudSDemPL + lnTNumJudSDemPr
                                                                   lnTCapJudSDemPL = lnTCapJudSDemPL + lnTCapJudSDemPr
                                                                   lnTNumJudCDemPL = lnTNumJudCDemPL + lnTNumJudCDemPr
                                                                   lnTCapJudCDemPL = lnTCapJudCDemPL + lnTCapJudCDemPr
                                                                   
                                                                   ' *****  Imprime
                                                                   lsRtfImp = lsRtfImp & IIf(Trim(rsPL!nConsValor) = "1", " CP-", " LP-")
                                                                   lsRtfImp = lsRtfImp & IIf(NorRef = 0, "NORMAL     ", "REFINANC   ")
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPr, 10, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPr, 13, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigPr, 8, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPr, 13, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1Pr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1Pr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2Pr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2Pr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemPr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemPr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemPr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemPr, 12, 2, True) & " | "
                                                                   'If lnTSaldoCapPr <> 0 And lsConcepto = "C" Then
                                                                   '  lsRTfimp = lsRTfimp & ImpreFormat(Round(((lnTSaldoCapPr - lnTCapVigPr) / lnTSaldoCapPr) * 100, 2), 3, 2) & "%"
                                                                   'End If
                                                                   lsRtfImp = lsRtfImp & Chr(10)
                                                                   liLineas = liLineas + 1
                                                                   
                                                                   '************* Para Grabar en Tabla  (Simon)  **************
                                                                   
                                                                   'Vigentes
                                                                   If lnTCapVigPr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(gdFecData, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '1','" & IIf(NorRef = 0, "N", "R") & "','N'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Trim(rsFF!cLineaCred) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapVigPr & ")"
                                                                     oCon.Ejecutar Sql9
                                                                   End If
                                                                   
                                                                   'Vencidas Adm por Age
                                                                   If lnTCapVen1Pr + lnTCapVen2Pr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(gdFecData, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '5','" & IIf(NorRef = 0, "N", "R") & "','N'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Trim(rsFF!cLineaCred) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapVen1Pr + lnTCapVen2Pr & ")"
                                                                     oCon.Ejecutar Sql9
                                                                   End If
                                                                   
                                                                   'Judicial - Administ por Agencia
                                                                   If lnTCapJudSDemPr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(gdFecData, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '5','" & IIf(NorRef = 0, "N", "R") & "','S'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Trim(rsFF!cLineaCred) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapJudSDemPr & ")"
                                                                     oCon.Ejecutar Sql9
                                                                   End If
                                                                   
                                                                   'Judicial - Administ por Recup
                                                                   If lnTCapJudCDemPr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(gdFecData, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '6','" & IIf(NorRef = 0, "N", "R") & "','S'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Trim(rsFF!cLineaCred) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapJudCDemPr & ")"
                                                                     oCon.Ejecutar Sql9
                                                                   End If
                                                                   '***********************************************************
                                                                   '=================================================
                                                                   DoEvents
                                                               Next NorRef
                            
                                                               ' ***************************************
                                                               ' ***** Asigna Valores a F.Financia******
                                                               lnTCredF = lnTCredF + lnTCredPL
                                                               lnTSaldoCapF = lnTSaldoCapF + lnTSaldoCapPL
                                                               lnTNumVigF = lnTNumVigF + lnTNumVigPL
                                                               lnTCapVigF = lnTCapVigF + lnTCapVigPL
                                                               lnTNumVen1F = lnTNumVen1F + lnTNumVen1PL
                                                               lnTCapVen1F = lnTCapVen1F + lnTCapVen1PL
                                                               lnTNumVen2F = lnTNumVen2F + lnTNumVen2PL
                                                               lnTCapVen2F = lnTCapVen2F + lnTCapVen2PL
                                                               lnTNumJudSDemF = lnTNumJudSDemF + lnTNumJudSDemPL
                                                               lnTCapJudSDemF = lnTCapJudSDemF + lnTCapJudSDemPL
                                                               lnTNumJudCDemF = lnTNumJudCDemF + lnTNumJudCDemPL
                                                               lnTCapJudCDemF = lnTCapJudCDemF + lnTCapJudCDemPL
                                                               
                                                               ' *****  Imprime
                                                               lsRtfImp = lsRtfImp & String(170, "-") & Chr(10)
                                                               lsRtfImp = lsRtfImp & " TOT. PLAZO    " ' & lsDescPr
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPL, 10, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPL, 13, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigPL, 8, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPL, 13, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1PL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1PL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2PL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2PL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemPL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemPL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemPL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemPL, 12, 2, True) & " | "
                                                               'If lnTSaldoCapPL <> 0 And lsConcepto = "C" Then
                                                               '   lsRTfimp = lsRTfimp & ImpreFormat(Round(((lnTSaldoCapPL - lnTCapVigPL) / lnTSaldoCapPL) * 100, 2), 3, 2) & "%"
                                                               'End If
                                                               lsRtfImp = lsRtfImp & Chr(10)
                                                               liLineas = liLineas + 2
                                                               
                                                               ' ****************************
                                                               ' ****  Verifica Si Cambio pagina
                                                               If liLineas >= 54 Then 'Para el control de salto de página
                                                                  lsRtfImp = lsRtfImp & Chr(12)
                                                                  cpag = cpag + 1
                                                                  lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                                                  liLineas = 6
                                                               End If
                                                           
                                                           End If   ' Si encuentra Datos en Plazo
                                                           rsPL.MoveNext
                                                           
                                                        Loop   ' Plazo
                                                        
                                                    
                                                    End If   ' Plazo
                                                    
                                                    ' ***************************************
                                                    ' ***** Asigna Valores a Sub Producto ******
                                                    lnTCredSubPr = lnTCredSubPr + lnTCredF
                                                    lnTSaldoCapSubPr = lnTSaldoCapSubPr + lnTSaldoCapF
                                                    lnTNumVigSubPr = lnTNumVigSubPr + lnTNumVigF
                                                    lnTCapVigSubPr = lnTCapVigSubPr + lnTCapVigF
                                                    lnTNumVen1SubPr = lnTNumVen1SubPr + lnTNumVen1F
                                                    lnTCapVen1SubPr = lnTCapVen1SubPr + lnTCapVen1F
                                                    lnTNumVen2SubPr = lnTNumVen2SubPr + lnTNumVen2F
                                                    lnTCapVen2SubPr = lnTCapVen2SubPr + lnTCapVen2F
                                                    lnTNumJudSDemSubPr = lnTNumJudSDemSubPr + lnTNumJudSDemF
                                                    lnTCapJudSDemSubPr = lnTCapJudSDemSubPr + lnTCapJudSDemF
                                                    lnTNumJudCDemSubPr = lnTNumJudCDemSubPr + lnTNumJudCDemF
                                                    lnTCapJudCDemSubPr = lnTCapJudCDemSubPr + lnTCapJudCDemF
                                                    ' *****  Imprime
                                                    lsRtfImp = lsRtfImp & String(170, "-") & Chr(10)
                                                    lsRtfImp = lsRtfImp & " TOT. F.FINANC." ' & lsDescPr
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCredF, 10, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapF, 13, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigF, 8, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigF, 13, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1F, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1F, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2F, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2F, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemF, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemF, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemF, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemF, 12, 2, True) & " | "
                                                    If lnTSaldoCapF <> 0 And lsConcepto = "C" Then
                                                      lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapF - lnTCapVigF) / lnTSaldoCapF) * 100, 2), 3, 2) & "%"
                                                    End If
                                                    lsRtfImp = lsRtfImp & Chr(10)
                                                    liLineas = liLineas + 2
                                                    
                                                    ' ****************************
                                                    ' ****  Verifica Si Cambio pagina
                                                    If liLineas >= 54 Then 'Para el control de salto de página
                                                       lsRtfImp = lsRtfImp & Chr(12)
                                                       cpag = cpag + 1
                                                       lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                                       liLineas = 6
                                                    End If
                                                    
                                        
                                               End If  ' Fuentes Financiamiento
                                               
                                               rsFF.MoveNext
                                           
                                            Loop  ' fuente Financiamiento
                                               
                                        End If   ' Fuente financiamiento
                                        
                                        ' ***************************************
                                        ' ***** Asigna Valores a Agencia  ******
                                        lnTCredAG = lnTCredAG + lnTCredSubPr
                                        lnTSaldoCapAG = lnTSaldoCapAG + lnTSaldoCapSubPr
                                        lnTNumVigAG = lnTNumVigAG + lnTNumVigSubPr
                                        lnTCapVigAG = lnTCapVigAG + lnTCapVigSubPr
                                        lnTNumVen1AG = lnTNumVen1AG + lnTNumVen1SubPr
                                        lnTCapVen1AG = lnTCapVen1AG + lnTCapVen1SubPr
                                        lnTNumVen2AG = lnTNumVen2AG + lnTNumVen2SubPr
                                        lnTCapVen2AG = lnTCapVen2AG + lnTCapVen2SubPr
                                        lnTNumJudSDemAG = lnTNumJudSDemAG + lnTNumJudSDemSubPr
                                        lnTCapJudSDemAG = lnTCapJudSDemAG + lnTCapJudSDemSubPr
                                        lnTNumJudCDemAG = lnTNumJudCDemAG + lnTNumJudCDemSubPr
                                        lnTCapJudCDemAG = lnTCapJudCDemAG + lnTCapJudCDemSubPr
                                        ' *****  Imprime
                                        lsRtfImp = lsRtfImp & String(170, "-") & Chr(10)
                                        lsRtfImp = lsRtfImp & "  TOT.SUBPROD. " ' & lsDescPr
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCredSubPr, 10, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapSubPr, 13, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigSubPr, 8, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigSubPr, 13, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1SubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1SubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2SubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2SubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemSubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemSubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemSubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemSubPr, 12, 2, True) & " | "
                                        If lnTSaldoCapSubPr <> 0 And lsConcepto = "C" Then
                                          lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapSubPr - lnTCapVigSubPr) / lnTSaldoCapSubPr) * 100, 2), 3, 2) & "%"
                                        End If
                                        lsRtfImp = lsRtfImp & Chr(10)
                                        liLineas = liLineas + 2
                                        
                                        ' ****************************
                                        ' ****  Verifica Si Cambio pagina
                                        If liLineas >= 54 Then 'Para el control de salto de página
                                           lsRtfImp = lsRtfImp & Chr(12)
                                           cpag = cpag + 1
                                           lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                           liLineas = 6
                                        End If
                                        
                                        
                                    End If  ' Sub Productos
                                        
                                 Next J
                                 
                                ' ***************************************
                                ' ***** Asigna Valores a Producto ******
                                lnTCredProd = lnTCredProd + lnTCredAG
                                lnTSaldoCapProd = lnTSaldoCapProd + lnTSaldoCapAG
                                lnTNumVigProd = lnTNumVigProd + lnTNumVigAG
                                lnTCapVigProd = lnTCapVigProd + lnTCapVigAG
                                lnTNumVen1Prod = lnTNumVen1Prod + lnTNumVen1AG
                                lnTCapVen1Prod = lnTCapVen1Prod + lnTCapVen1AG
                                lnTNumVen2Prod = lnTNumVen2Prod + lnTNumVen2AG
                                lnTCapVen2Prod = lnTCapVen2Prod + lnTCapVen2AG
                                lnTNumJudSDemProd = lnTNumJudSDemProd + lnTNumJudSDemAG
                                lnTCapJudSDemProd = lnTCapJudSDemProd + lnTCapJudSDemAG
                                lnTNumJudCDemProd = lnTNumJudCDemProd + lnTNumJudCDemAG
                                lnTCapJudCDemProd = lnTCapJudCDemProd + lnTCapJudCDemAG
                                ' *****  Imprime
                                lsRtfImp = lsRtfImp & String(170, "-") & Chr(10)
                                lsRtfImp = lsRtfImp & " TOT. AGENCIA  "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCredAG, 10, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAG, 13, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigAG, 8, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigAG, 13, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1AG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1AG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2AG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2AG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemAG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemAG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemAG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemAG, 12, 2, True) & " | "
                                If lnTSaldoCapAG <> 0 And lsConcepto = "C" Then
                                lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapAG - lnTCapVigAG) / lnTSaldoCapAG) * 100, 2), 3, 2) & "%"
                                End If
                                lsRtfImp = lsRtfImp & Chr(10)
                                liLineas = liLineas + 2
                                 
                                If liLineas >= 54 Then 'Para el control de salto de página
                                   lsRtfImp = lsRtfImp & Chr(12)
                                   cpag = cpag + 1
                                   lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                   liLineas = 6
                                End If
                                 
                               
                             End If  ' De la Agencia
                             
                              
                             rsAg.MoveNext
                                                                                       
                         Loop   ' De agencia
                         
                         
                     End If '  Producto
                         
                         
                    ' ***************************************
                    ' ***** Asigna Valores a MONEDA   ******
                    lnTCredM = lnTCredM + lnTCredProd
                    lnTSaldoCapM = lnTSaldoCapM + lnTSaldoCapProd
                   ' i = i - 1
                    lnTNumVigM = lnTNumVigM + lnTNumVigProd
                    lnTCapVigM = lnTCapVigM + lnTCapVigProd
                    lnTNumVen1M = lnTNumVen1M + lnTNumVen1Prod
                    lnTCapVen1M = lnTCapVen1M + lnTCapVen1Prod
                    lnTNumVen2M = lnTNumVen2M + lnTNumVen2Prod
                    lnTCapVen2M = lnTCapVen2M + lnTCapVen2Prod
                    lnTNumJudSDemM = lnTNumJudSDemM + lnTNumJudSDemProd
                    lnTCapJudSDemM = lnTCapJudSDemM + lnTCapJudSDemProd
                    lnTNumJudCDemM = lnTNumJudCDemM + lnTNumJudCDemProd
                    lnTCapJudCDemM = lnTCapJudCDemM + lnTCapJudCDemProd

                    ' *****  Imprime
                    lsRtfImp = lsRtfImp & String(170, "-") & Chr(10)
                    lsRtfImp = lsRtfImp & "  TOT PRODUCT  "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCredProd, 10, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapProd, 13, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigProd, 8, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigProd, 13, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1Prod, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1Prod, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2Prod, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2Prod, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemProd, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemProd, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemProd, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemProd, 12, 2, True) & " | "
                    If lnTSaldoCapProd <> 0 And lsConcepto = "C" Then
                     lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapProd - lnTCapVigProd) / lnTSaldoCapProd) * 100, 2), 3, 2) & "%"
                    End If
                    lsRtfImp = lsRtfImp & Chr(10)
                    liLineas = liLineas + 2
                         
                 Next i   ' Para el Sgte Producto
                               
                               
                ' *****  Imprime
                lsRtfImp = lsRtfImp & String(170, "-") & Chr(10)
                lsRtfImp = lsRtfImp & "  TOT MONEDA   "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCredM, 10, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapM, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigM, 8, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigM, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1M, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1M, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2M, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2M, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemM, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemM, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemM, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemM, 12, 2, True) & " | "
                If lnTSaldoCapM <> 0 And lsConcepto = "C" Then
                  lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapM - lnTCapVigM) / lnTSaldoCapM) * 100, 2), 3, 2) & "%"
                End If
                lsRtfImp = lsRtfImp & Chr(10)
                lsRtfImp = lsRtfImp & String(170, "-") & Chr(10)
                'lsRTfImp = lsRTfImp & Chr(10)
                liLineas = liLineas + 4
             
            End If '---liDatos - Moneda
            lbSiCambio = True
            RsM.MoveNext
            If Not RsM.EOF Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                liLineas = 0
            End If
        Loop ' ---- Moneda
    End If '--- Moneda
    RsM.Close
    Set RsM = Nothing
    Sql9 = "Drop Table " & lsArcTmp & " "
    oCon.Ejecutar Sql9
    
Else
    nRepo108705_ImpCarteraReclasificacion = ""
End If '--- liDatos - General
'lsRtfImpG = lsRtfImp ' Asigna el valor
nRepo108705_ImpCarteraReclasificacion = lsRtfImp
Screen.MousePointer = 1
End Function



Public Function nRepo108705_ImpCarteraReclasificacion_Ant(pPlanCuentas As String, psServConsol As String, Optional psConcepto As String = "nSaldoCap") As String
Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPL As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String
Dim lsDescP As String
Dim lsDescF As String
Dim lsDescAG As String
Dim lsDescSubPr As String
Dim lsDescPL As String

Dim liLineas As Integer
Dim liDatos  As Long

Dim lnTCred As Single  ' *** General
Dim lnTSaldoCap As Double
Dim lnTNumVig As Single
Dim lnTCapVig As Double
Dim lnTNumVen1 As Integer
Dim lnTCapVen1  As Double
Dim lnTNumVen2 As Integer
Dim lnTCapVen2 As Double
Dim lnTNumJud As Integer
Dim lnTCapJud As Double
Dim lnTCapVenNJud As Double
Dim lnTCapVenSJud As Double

Dim lnTCredM As Single  ' *** Moneda
Dim lnTSaldoCapM As Double
Dim lnTNumVigM As Single
Dim lnTCapVigM As Double
Dim lnTNumVen1M As Integer
Dim lnTCapVen1M  As Double
Dim lnTNumVen2M As Integer
Dim lnTCapVen2M As Double
Dim lnTNumJudSDemM As Integer  ' Sin Deman
Dim lnTCapJudSDemM As Double
Dim lnTNumJudCDemM As Integer  ' Con Deman
Dim lnTCapJudCDemM As Double

Dim lnTCredF As Single  ' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double
Dim lnTNumVigF As Single
Dim lnTCapVigF As Double
Dim lnTNumVen1F As Integer
Dim lnTCapVen1F  As Double
Dim lnTNumVen2F As Integer
Dim lnTCapVen2F As Double
Dim lnTNumJudSDemF As Integer  'Sin Dema
Dim lnTCapJudSDemF As Double
Dim lnTNumJudCDemF As Integer  'Con Deman
Dim lnTCapJudCDemF As Double

Dim lnTCredAG As Single  ' *** Agencia
Dim lnTSaldoCapAG As Double
Dim lnTNumVigAG As Single
Dim lnTCapVigAG As Double
Dim lnTNumVen1AG As Integer
Dim lnTCapVen1AG  As Double
Dim lnTNumVen2AG As Integer
Dim lnTCapVen2AG As Double
Dim lnTNumJudSDemAG As Integer  'sin Dema
Dim lnTCapJudSDemAG As Double
Dim lnTNumJudCDemAG As Integer  'con dema
Dim lnTCapJudCDemAG As Double

Dim lnTCredPr As Single  ' *** Producto - detalle
Dim lnTSaldoCapPr As Double
Dim lnTNumVigPr As Single
Dim lnTCapVigPr As Double
Dim lnTNumVen1Pr As Integer
Dim lnTCapVen1Pr  As Double
Dim lnTNumVen2Pr As Integer
Dim lnTCapVen2Pr As Double
Dim lnTNumJudSDemPr As Integer
Dim lnTCapJudSDemPr As Double
Dim lnTNumJudCDemPr As Integer
Dim lnTCapJudCDemPr As Double



Dim lnTCredSubPr As Single  ' *** Sub Producto
Dim lnTSaldoCapSubPr As Double
Dim lnTNumVigSubPr As Single
Dim lnTCapVigSubPr As Double
Dim lnTNumVen1SubPr As Integer
Dim lnTCapVen1SubPr  As Double
Dim lnTNumVen2SubPr As Integer
Dim lnTCapVen2SubPr As Double
Dim lnTNumJudSDemSubPr As Integer
Dim lnTCapJudSDemSubPr As Double
Dim lnTNumJudCDemSubPr As Integer
Dim lnTCapJudCDemSubPr As Double

Dim lnTCredProd As Single  ' *** Producto
Dim lnTSaldoCapProd As Double
Dim lnTNumVigProd As Single
Dim lnTCapVigProd As Double
Dim lnTNumVen1Prod As Integer
Dim lnTCapVen1Prod  As Double
Dim lnTNumVen2Prod As Integer
Dim lnTCapVen2Prod As Double
Dim lnTNumJudSDemProd As Integer
Dim lnTCapJudSDemProd As Double
Dim lnTNumJudCDemProd As Integer
Dim lnTCapJudCDemProd As Double

Dim lnTCredPL As Single  ' *** Plazo
Dim lnTSaldoCapPL As Double
Dim lnTNumVigPL As Single
Dim lnTCapVigPL As Double
Dim lnTNumVen1PL As Integer
Dim lnTCapVen1PL  As Double
Dim lnTNumVen2PL As Integer
Dim lnTCapVen2PL As Double
Dim lnTNumJudSDemPL As Integer
Dim lnTCapJudSDemPL As Double
Dim lnTNumJudCDemPL As Integer
Dim lnTCapJudCDemPL As Double

Dim lbSiCambio As Boolean
Dim cadena As String

Dim lnCapVencido As Currency  'Para los consumo

Dim prod(7) As String
Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsRtfImp As String
Dim cpag As Integer

Dim lnCredAdmin As Integer ' Bandera Para Cred Admin

Dim NumSubProd As Integer ' SubProductos
Dim SubProd(10, 20) As String
Dim J As Integer
Dim NorRef As Integer

'** CAMBIOS
Dim lsConceptoJud As String
Dim lsCondJud As String
Dim lsConcepto As String
Screen.MousePointer = 13
If psConcepto = "nSaldoCap" Then
   lsConceptoJud = "nSaldoCap"
   lsCondJud = " nSaldoCap > 0 "
Else
   lsConceptoJud = "nIntDev"
   lsCondJud = " nIntDev > 0 "
End If

If psConcepto = "nSaldoCap" Then
   lsConcepto = "C"
Else
   lsConcepto = "I"
End If

'********************
Dim lsCreditosVigentes As String
Dim lsCreditosPignoraticio As String
Dim lsCreditosJudicial As String
Dim i As Integer
Dim lsRtfImpG As String

'Ica - LAYG -2005/02/15
Dim lsRFACondicion As String
Dim lsRFACredito As String
Dim lsFFinanc As String
Dim lSSQL9 As String
lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & _
                     "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc

'lsCreditosPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
lsCreditosPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
lsCreditosJudicial = gColocEstRecVigJud & ",2205"

'ARCV 28-06-2006
Dim MatLongitud(4) As Integer
Dim MatSubProdCod As Variant
Dim MatSubProdDes As Variant
Dim SubProdDesc(10, 20) As String   'Para evitar desbordamiento
'Se agrego para almacenar el vigente Moroso (Cuenta 1411)
Dim lnTCapVigenMoroso As Double

For J = 0 To 4
    If J <> 3 Then
        MatSubProdCod = RecuperaMatrizTipoProducto(CStr(IIf(J = 4, J, J + 1)), "nConsValor")
        MatLongitud(J) = UBound(MatSubProdCod)
        For i = 0 To UBound(MatSubProdCod) - 1
            SubProd(J, i) = MatSubProdCod(i)
        Next
    End If
Next J

'Pignoraticio
SubProd(3, 0) = "'305'"

For J = 0 To 4
    If J <> 3 Then
        MatSubProdDes = RecuperaMatrizTipoProducto(CStr(IIf(J = 4, J, J + 1)), "cConsDescripcion")
        For i = 0 To UBound(MatSubProdDes) - 1
            SubProdDesc(J, i) = MatSubProdDes(i)
        Next
    End If
Next J

SubProdDesc(3, 0) = "Prendario"

'SubProd(0, 0) = " '101' " ' Comerciales Empres
'SubProd(0, 1) = " '102' " ' Comerciales Agricola
'SubProd(1, 0) = " '201' " ' Mes Empresar
'SubProd(1, 1) = " '202' " ' Mes Agricola
'SubProd(2, 0) = " '301' " ' Consumo DxP
'SubProd(2, 1) = " '302' " ' Consumo Aval PF
'SubProd(2, 2) = " '303' " ' Consumo Aval CTS
'SubProd(2, 3) = " '304' " ' Consumo Usos diversos
'SubProd(2, 4) = " '320' " ' Consumo Prestamo Administrativos
'SubProd(3, 0) = " '305' " ' Prendario
'SubProd(4, 0) = " '423' " ' Hipotecario

' Para Cada Producto
'prod(0) = " '101','102' "  ' Comercial
'prod(1) = " '201','202' "  ' Mes Pyme-Mes
'prod(2) = " '301','302','303','304','320'"  ' Consumo
'prod(3) = " '305' "  ' Prendario
'prod(4) = " '423'" ' Hipotecario
'For I = 0 To 3
'    prod(I) = RecuperaCadenaTipoProducto(CStr(I + 1))
'Next
prod(0) = RecuperaCadenaTipoProducto("1")
prod(1) = RecuperaCadenaTipoProducto("2")
prod(2) = RecuperaCadenaTipoProducto("3")
prod(3) = "'305'"
prod(4) = RecuperaCadenaTipoProducto("4")


' Para Cada Producto
'prod(0) = " '101','102','104'"  ' Comercial
'prod(1) = " '201','202','203','204','205','231' "  ' Pyme-Mes
'prod(2) = " '301','302','303'"  ' Consumo
'prod(3) = " '305'"  ' prendario
'prod(3) = " '401,402,423'"  ' Hipotecario


lbSiCambio = False
lsRtfImp = ""
cpag = 1

cadena = ""

'===== Verificar si existen datos para el reporte
lSSQL9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol  " & _
       "Where nPrdEstado in (" & lsCreditosVigentes & "," & lsCreditosJudicial & " ) "

Set Reg9 = GetQuery(lSSQL9)

If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then  ' General
   Sql9 = "DELETE " & psServConsol & "CredSaldosCont WHERE dFecha = '" & Format(GetFechaCierreMes, "mm/dd/yyyy") & "' and cConcepto = '" & lsConcepto & "'"
   
   Conecta.AbreConexion
   Conecta.Ejecutar (Sql9)
    Conecta.CadenaConexion

    '======== Tipo de Moneda =========
    Dim loConst As DConstante
    Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)
    '======== Tipo de Plazo =========
            Set rsPL = loConst.RecuperaConstantes(gColocLineaCredPlazo)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    Set rsFF = ObtieneLineaCredito 'Fuente Financiamiento
    
   '======= Para Cada Agencia  =========
    Dim loAg As DAgencias
        Set loAg = New DAgencias
            Set rsAg = loAg.RecuperaAgencias
        Set loAg = Nothing
    
    nRepo108705_ImpCarteraReclasificacion_Ant = ""
    If RsM.EOF And RsM.BOF Then
    Else
        RaiseEvent ShowProgress
        Do While Not RsM.EOF
            '=====LIMPIAR LOS DATOS SUBTOTALES POR MONEDA ======
            lnTCredM = 0:   lnTSaldoCapM = 0
            lnTNumVigM = 0: lnTCapVigM = 0
            lnTNumVen1M = 0: lnTCapVen1M = 0
            lnTNumVen2M = 0: lnTCapVen2M = 0
            lnTNumJudSDemM = 0: lnTCapJudSDemM = 0
            lnTNumJudCDemM = 0: lnTCapJudCDemM = 0
            lsDescM = Trim(RsM!cConsDescripcion)
            '============ CREDITOS VIGENTES PARA UNA DETERMINADA MONEDA =========
            Sql9 = "SELECT Count(cCtaCod) AS NumCred FROM " & psServConsol & "CreditoConsol " & _
                "WHERE nPrdEstado in ( " & lsCreditosVigentes & " ) and " & _
                "substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'"
            Set Reg9 = GetQuery(Sql9)
            If Reg9.EOF And Reg9.BOF Then
                liDatos = 0
            Else
                liDatos = Reg9!NumCred
            End If
            Reg9.Close
            Set Reg9 = Nothing
            
            If liDatos > 0 Then  ' De la Moneda
                lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                liLineas = 6
                If lbSiCambio Then
                    lbSiCambio = False
                End If
                lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                lsRtfImp = lsRtfImp & " * MONEDA             : " & lsDescM & Chr(27) & Chr(70) & Chr(10)
                liLineas = liLineas + 2
                
                '========= CREDITOS VIGENTES PARA PRODUCTO  =========
                 For i = 0 To 4  'Para Cada Producto
                   
                   Select Case i
                      Case 0: lsDescPr = " Comercial   "
                      Case 1: lsDescPr = " Mes - Pyme  "
                      Case 2: lsDescPr = " Consumo     "
                      Case 3: lsDescPr = " Prendario   "
                      Case 4: lsDescPr = " Hipotecario "
                   End Select
                   
                   '=========== CREDITOS DEL PRODUCTO =============
                     Sql9 = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                         " where nPrdEstado in ( " & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & ") " & _
                         " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                         " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                      
                     'If Trim(RsM!NCONSVALOR) = "1" And i = 3 Then ' Si es RR PP
                     '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                     '        " WHERE nPrdEstado IN " & lsCreditosPignoraticio & _
                     '        " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!NCONSVALOR) & "'" & _
                     '        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                     'Else
                     '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                     '           "WHERE nPrdEstado = 9999 "
                     'End If
                     ' Judicial
                     'SQL9C = "SELECT COUNT(cCtaCod) AS NumCred " & _
                     '       " FROM " & psServConsol & "CreditoConsol " & _
                     '       " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud & _
                     '       " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!NCONSVALOR) & "'" & _
                     '       " AND substring(cCtaCod,6,3) in (" & prod(i) & ")"
                     lnTCredProd = 0:   lnTSaldoCapProd = 0
                     lnTNumVigProd = 0: lnTCapVigProd = 0
                     lnTNumVen1Prod = 0: lnTCapVen1Prod = 0
                     lnTNumVen2Prod = 0: lnTCapVen2Prod = 0
                     lnTNumJudSDemProd = 0: lnTCapJudSDemProd = 0
                     lnTNumJudCDemProd = 0: lnTCapJudCDemProd = 0
                     
                     'If HayDatos(SQL9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then  ' Para Producto
                     If HayDatos(Sql9) > 0 Then  ' Para Producto
                        lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                        lsRtfImp = lsRtfImp & " ** PRODUCTO          : " & lsDescPr & Chr(27) & Chr(70) ' & Chr(10)
                        liLineas = liLineas + 3
                        
                        '======= Para Cada Agencia  =========
                        rsAg.MoveFirst
                        Do While Not rsAg.EOF
                                 
                           Sql9 = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                  " where nPrdEstado in ( " & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & " ) " & _
                                  " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                  " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                  " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
                            'If Trim(RsM!NCONSVALOR) = "1" And i = 3 Then
                            '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                            '           "WHERE nPrdEstado IN " & lsCreditosPignoraticio & _
                            '           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!NCONSVALOR) & "'" & _
                            '           " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                            '           " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
                            'Else
                            '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol "
                            '   SQL9B = SQL9B & "WHERE nPrdEstado = 9999 "
                            'End If
                            'SQL9C = "SELECT Count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol "
                            'SQL9C = SQL9C & "WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud
                            'SQL9C = SQL9C & " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!NCONSVALOR) & "'"
                            'SQL9C = SQL9C & " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                            'SQL9C = SQL9C & " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"

                              lnTCredAG = 0:   lnTSaldoCapAG = 0
                              lnTNumVigAG = 0: lnTCapVigAG = 0
                              lnTNumVen1AG = 0: lnTCapVen1AG = 0
                              lnTNumVen2AG = 0: lnTCapVen2AG = 0
                              lnTNumJudSDemAG = 0: lnTCapJudSDemAG = 0
                              lnTNumJudCDemAG = 0: lnTCapJudCDemAG = 0
                             'If HayDatos(SQL9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then     ' De la Agencia
                             If HayDatos(Sql9) > 0 Then      ' De la Agencia

                                 lsDescAG = rsAg!cAgeDescripcion
                                 lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                 lsRtfImp = lsRtfImp & " *** AGENCIA          : " & lsDescAG & Chr(27) & Chr(70) '& Chr(10)
                                 liLineas = liLineas + 2
                                 
                                 '========= CREDITOS VIGENTES PARA SUB PRODUCTOS  =========
                                 'Select Case I
                                 '   Case 0, 1
                                 '       NumSubProd = 1
                                 '   Case 2
                                 '       NumSubProd = 4
                                 '   Case 3, 4
                                 '       NumSubProd = 0
                                 'End Select
                                                                  
                                 NumSubProd = MatLongitud(i) - 1
                                 '-------------------
                                 For J = 0 To NumSubProd  'Para Cada SubProductos
                                   
                                    lnTCredSubPr = 0:    lnTSaldoCapSubPr = 0
                                    lnTNumVigSubPr = 0:  lnTCapVigSubPr = 0
                                    lnTNumVen1SubPr = 0: lnTCapVen1SubPr = 0
                                    lnTNumVen2SubPr = 0: lnTCapVen2SubPr = 0
                                    lnTNumJudSDemSubPr = 0:  lnTCapJudSDemSubPr = 0
                                    lnTNumJudCDemSubPr = 0:  lnTCapJudCDemSubPr = 0
                                    
                                    Select Case i
                                      Case 0
                                         lsDescSubPr = " Comercial "
                                         lsDescSubPr = SubProdDesc(0, J)
                                         'Select Case J
                                         '   Case 0: lsDescSubPr = " Comercial Empresar "
                                         '   Case 1: lsDescSubPr = " Comercial Agricola "
                                         '   Case 2: lsDescSubPr = " Comercial Industri "
                                         'End Select
                                         
                                      Case 1
                                        lsDescSubPr = SubProdDesc(1, J)
                                         'Select Case J
                                         '   Case 0: lsDescSubPr = " Pymes "
                                         '   Case 1: lsDescSubPr = " Pyme Agricola "
                                         '   Case 2: lsDescSubPr = " Pyme Pecuario "
                                         '   Case 3: lsDescSubPr = " Pyme Industri "
                                         '   Case 4: lsDescSubPr = " Soporte Micro "
                                         '   Case 5: lsDescSubPr = " Pyme VAC "
                                        'End Select
                                      Case 2
                                        lsDescSubPr = SubProdDesc(2, J)
                                         'Select Case J
                                         '   Case 0: lsDescSubPr = " Consumo Convenio "
                                         '   Case 1: lsDescSubPr = " Consumo Administrativo"
                                         '   Case 2: lsDescSubPr = " Consumo Confianza Personal "
                                         'End Select
                                      Case 3
                                            lsDescSubPr = " Prendario   "
                                      Case 4
                                            lsDescSubPr = " MiVivienda "
                                            lsDescSubPr = SubProdDesc(3, J)
                                            'Select Case J
                                            '    Case 0: lsDescSubPr = " Hipotecario Micasita "
                                            '    Case 1: lsDescSubPr = " Hipotecario Conficasa "
                                            '    Case 2: lsDescSubPr = " Hipotecario "
                                            'End Select
                                    End Select

                                   '=========== CREDITOS DEL SUB PRODUCTO =============
                                    Sql9 = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                        " where nPrdEstado in ( " & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & " ) " & _
                                        " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                        " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")"
                                     
                                    'If Trim(RsM!NCONSVALOR) = "1" And i = 3 Then  ' Si es RR PP prendario
                                    '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                    '        " WHERE nPrdEstado IN " & lsCreditosPignoraticio & _
                                    '        " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                    '        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                    '        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                    '        " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")"
                                    'Else
                                    '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                    '           "WHERE nPrdEstado = 9999 "
                                    'End If
                                    ' Judicial
                                    'SQL9C = "SELECT COUNT(cCtaCod) AS NumCred " & _
                                    '       " FROM " & psServConsol & "CreditoConsol " & _
                                    '       " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud & _
                                    '       " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                    '       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                    '       " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                    '       " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")"
                                    
                                    
                                    'If HayDatos(SQL9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then  ' Para Sub Productos
                                    If HayDatos(Sql9) > 0 Then   ' Para Sub Productos
                                        lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                        lsRtfImp = lsRtfImp & " **** SUB PRODUCTO    : " & lsDescSubPr & Chr(27) & Chr(70) '& Chr(10)
                                        liLineas = liLineas + 2
                                        
                                       '========= CREDITOS VIGENTES PARA FUENTES FINANCIAMIENTO =========
                                        
                                        If rsFF.EOF And rsFF.BOF Then 'Fuente Financ
                                        Else
                                            rsFF.MoveFirst
                                            Do While Not rsFF.EOF 'Fuente Financ
                                               '=========== CREDITOS VIGENTES PARA UNA FUENTE FINANCIAMIENTO =============
                                               Sql9 = " SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                                      " WHERE nPrdEstado in ( " & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & ") " & _
                                                      " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                      " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                      " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                      " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                      " AND substring(cLineaCred, 1,4) IN ('" & Trim(rsFF!cLineaCred) & "')"
                                               'SQL9B = "SELECT Count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                               '         "WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud & _
                                               '         " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                               '         " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                               '         " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                               '         " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                               '         " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')"
                        
                                               'If i = 3 And Trim(RsM!NCONSVALOR) = "1" And Trim(rsFF!cLineaCred) = "0101" Then   ' Si es RR PP Prendario
                                               '    SQL9C = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                               '         " WHERE nPrdEstado IN " & lsCreditosPignoraticio & _
                                               '         " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                               '         " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                               '         " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                               '         " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")"
                                               'Else
                                               '    SQL9C = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                               '            "WHERE nPrdEstado = 9999 "
                                               'End If
                        
                                                lnTCredF = 0: lnTSaldoCapF = 0
                                                lnTNumVigF = 0: lnTCapVigF = 0
                                                lnTNumVen1F = 0: lnTCapVen1F = 0
                                                lnTNumVen2F = 0: lnTCapVen2F = 0
                                                lnTNumJudSDemF = 0: lnTCapJudSDemF = 0
                                                lnTNumJudCDemF = 0: lnTCapJudCDemF = 0
                                               'If HayDatos(SQL9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then       ' De la Fuente Financ
                                                If HayDatos(Sql9) > 0 Then       ' De la Fuente Financ
                                                    lsDescF = Trim(rsFF!CDescripcion)
                                                    lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                                    lsRtfImp = lsRtfImp & " ***** F. FINANCIAMIENTO   : " & lsDescF & Chr(27) & Chr(70) & Chr(10)
                                                    liLineas = liLineas + 2
                                                    
                                                    lsDescF = Mid(rsFF!CDescripcion, 1, 25)
                                                    '======= Para Cada PLAZO  =========
                                                    If rsPL.EOF And rsPL.BOF Then ' Plazo
                                                    Else
                                                        rsPL.MoveFirst
                                                        Do While Not rsPL.EOF ' Plazo
                                                           lnTCredPL = 0: lnTSaldoCapPL = 0
                                                           lnTNumVigPL = 0: lnTCapVigPL = 0
                                                           lnTNumVen1PL = 0: lnTCapVen1PL = 0
                                                           lnTNumVen2PL = 0: lnTCapVen2PL = 0
                                                           lnTNumJudSDemPL = 0: lnTCapJudSDemPL = 0
                                                           lnTNumJudCDemPL = 0: lnTCapJudCDemPL = 0
                                                           lsDescPL = Mid(rsPL!cConsDescripcion, 1, 25)
                                                           
                                                           '=========== CREDITOS PARA EL PLAZO =============

                                                           Sql9 = "SELECT Count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                                                  " where nPrdEstado in ( " & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & ") " & _
                                                                  " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                  " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                  " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                  " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                  " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                  " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!nConsValor) & "')"
                                                            'If i = 3 And Trim(rsFF!cLineaCred) = "0101" And Trim(rsPL!NCONSVALOR) = "1" Then ' Prendario
                                                            'SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                                            '           "WHERE nPrdEstado IN " & lsCreditosPignoraticio & _
                                                            '           " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                                            '           " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                            '           " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
                                                            'Else
                                                            '   SQL9B = "SELECT count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol "
                                                            '   SQL9B = SQL9B & "WHERE nPrdEstado = 9999 "
                                                            'End If
                                                            
                                                            'SQL9C = "SELECT Count(cCtaCod) as NumCred FROM " & psServConsol & "CreditoConsol " & _
                                                            '        "WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud & _
                                                            '        " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                                            '        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                            '        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                            '        " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                            '        " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                            '        " AND substring(cLineaCred,6,1) IN ('" & Trim(rsPL!NCONSVALOR) & "')"

                                                            
                                                            'If HayDatos(SQL9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then     ' Del PLAZO
                                                            If HayDatos(Sql9) > 0 Then      ' Del PLAZO
    
                                                               'For NorRef = 0 To 1
                                                               For NorRef = 0 To 3
                                                               If NorRef = 0 Or NorRef = 1 Then
                                                               'If NorRef = 0 Then
                                                                 lsRFACondicion = " And nNroRepro IN (0,50) "
                                                                 lsRFACredito = ""
                                                               'ElseIf NorRef = 1 Then
                                                               ' lsRFACondicion = " And nNroRepro = 50 "
                                                               ' lsRFACredito = ""
                                                               ElseIf NorRef = 2 Then   'RFC
                                                                 lsRFACondicion = " And nNroRepro = 51 "
                                                                 lsRFACredito = "RFC"
                                                               ElseIf NorRef = 3 Then   'DIF
                                                                 lsRFACondicion = " And nNroRepro = 52 "
                                                                 lsRFACredito = "DIF"
                                                               End If
                                                                lnTCredPr = 0: lnTSaldoCapPr = 0
                                                                lnTNumVigPr = 0: lnTCapVigPr = 0
                                                                lnTNumVen1Pr = 0: lnTCapVen1Pr = 0
                                                                lnTNumVen2Pr = 0: lnTCapVen2Pr = 0
                                                                lnTNumJudSDemPr = 0: lnTCapJudSDemPr = 0
                                                                lnTNumJudCDemPr = 0: lnTCapJudCDemPr = 0
                                                                lnTCapVenNJud = 0: lnTCapVenSJud = 0
                                                                lsDescPr = ""
                                                               
                                                                   '=================================================
                                                                   '===== Total Cartera  Producto de Agencia  ======
                                                                   '  Creditos ------------
                                                                   Sql9 = "SELECT COUNT(cCtaCod) AS Numero, SUM(" & psConcepto & ") AS Capital " & _
                                                                          " FROM " & psServConsol & "CreditoConsol " & _
                                                                          " WHERE nPrdEstado in ( " & lsCreditosVigentes & "," & lsCreditosPignoraticio & "," & lsCreditosJudicial & ") " & _
                                                                          " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                          " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                          " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                          " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                          " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                          " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!nConsValor) & "')" & _
                                                                          " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "' " & lsRFACondicion
                         
                                                                   Set Reg9 = GetQuery(Sql9)
                                                                   lnTCredPr = Reg9!Numero
                                                                   lnTSaldoCapPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                   Reg9.Close
                                                                   Set Reg9 = Nothing
                                                                   
                                                                   ' Pignoraticio  ------------
                                                                   'If Trim(rsFF!cLineaCred) = "0101" And Trim(RsM!NCONSVALOR) = "1" And i = 3 And NorRef = 0 Then  ' Si es RR PP
                                                                   '   SQL9 = "SELECT count(cCtaCod) as Numero, Sum(" & psConcepto & ") AS Capital " & _
                                                                   '       " FROM " & psServConsol & "CreditoConsol WHERE nPrdEstado IN " & lsCreditosPignoraticio & _
                                                                   '       " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                                                   '       " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                   '       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                                                   '
                                                                   '   Set Reg9 = GetQuery(SQL9)
                                                                   '   lnTCredPr = lnTCredPr + Reg9!Numero
                                                                   '   lnTSaldoCapPr = lnTSaldoCapPr + IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                   '   Reg9.Close
                                                                   '   Set Reg9 = Nothing
                                                                   'End If
                                                                   ' Judicial -------------
                                                                   'If NorRef = 0 Then  ' Si es Normal
                                                                   '     SQL9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                   '       " SUM(" & lsConceptoJud & ") AS Capital " & _
                                                                   '       " FROM " & psServConsol & "CreditoConsol " & _
                                                                   '       " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud & _
                                                                   '       " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!NCONSVALOR) & "'" & _
                                                                   '       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                   '       " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                   '       " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                   '       " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                   '       " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!NCONSVALOR) & "')" & _
                                                                   '       " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'"
                                                                   '
                                                                   '     Set Reg9 = GetQuery(SQL9)
                                                                   '     lnTCredPr = lnTCredPr + Reg9!Numero
                                                                   '     lnTSaldoCapPr = lnTSaldoCapPr + IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                   '     Reg9.Close
                                                                   '     Set Reg9 = Nothing
                                                                   'End If
                                                                   '=================================================
                                                                   '====== Cartera Vigente  Producto de Agencia  ===
                                                                   Select Case i
                                                                       Case 0  ' Comercial  ******************
                                                                         lnRangoIni = -9999   ' Comerciales
                                                                         lnRangoFin = 15
                                                                         
                                                                         Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                               " SUM(" & psConcepto & ") AS Capital " & _
                                                                               " FROM " & psServConsol & "CreditoConsol " & _
                                                                               " WHERE nPrdEstado in ( " & lsCreditosVigentes & ") " & _
                                                                               " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                               " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                               " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!nConsValor) & "')" & _
                                                                               " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'"
                                                                          Sql9 = Sql9 & " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                               " And ndiasAtraso <= " & Val(lnRangoFin) & _
                                                                               lsRFACondicion
                                                                               
                                                                         Set Reg9 = GetQuery(Sql9)
                                                                         lnTNumVigPr = Reg9!Numero
                                                                         lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                         Reg9.Close
                                                                         Set Reg9 = Nothing
                                                                         '********
                                                                       Case 1 ' Mes  ******************
                                                                         lnRangoIni = -9999   '
                                                                         lnRangoFin = 30
                                                                         Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                               " SUM(" & psConcepto & ") AS Capital " & _
                                                                               " FROM " & psServConsol & "CreditoConsol " & _
                                                                               " WHERE nPrdEstado in ( " & lsCreditosVigentes & ") " & _
                                                                               " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                               " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                               " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!nConsValor) & "')" & _
                                                                               " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                               " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                               " And ndiasAtraso <= " & Val(lnRangoFin) & _
                                                                               lsRFACondicion
                                                                               
                                                                         Set Reg9 = GetQuery(Sql9)
                                                                         lnTNumVigPr = Reg9!Numero
                                                                         lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                         Reg9.Close
                                                                         Set Reg9 = Nothing
                                                                               
                                                                      Case 2, 4    ' Consumo / Hipotecario /
                                                                         lnRangoIni = -9999
                                                                         lnRangoFin = 30
                                                                         Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                               " SUM(" & psConcepto & ") AS Capital " & _
                                                                               " FROM " & psServConsol & "CreditoConsol " & _
                                                                               " WHERE nPrdEstado in ( " & lsCreditosVigentes & ") " & _
                                                                               " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                               " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                               " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!nConsValor) & "')" & _
                                                                               " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                               " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                               " And ndiasAtraso <= " & Val(lnRangoFin) & _
                                                                               lsRFACondicion
                                                                               
                                                                         Set Reg9 = GetQuery(Sql9)
                                                                         lnTNumVigPr = Reg9!Numero
                                                                         lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                         Reg9.Close
                                                                         Set Reg9 = Nothing
                                                                               
                                                                      Case 3  ' Prendario  *************************
                                                                      'ARCV 27-06-2006
                                                                      '   If Trim(rsFF!cLineaCred) = "0101" And Trim(RsM!nConsValor) = "1" And Trim(rsPL!nConsValor) = "1" And NorRef = 0 Then   ' Si es RR PP / Corto Plazo / Normal
                                                                            lnRangoIni = -999
                                                                            lnRangoFin = 30
                                                                            Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                                " SUM(" & psConcepto & ") AS Capital " & _
                                                                               " FROM " & psServConsol & "CreditoConsol " & _
                                                                               " WHERE nPrdEstado in ( " & lsCreditosPignoraticio & ") " & _
                                                                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                               " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                               " And ndiasAtraso <= " & Val(lnRangoFin) & _
                                                                               lsRFACondicion

                                                                             Set Reg9 = GetQuery(Sql9)
                                                                             lnTNumVigPr = Reg9!Numero
                                                                             lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                             Reg9.Close
                                                                             Set Reg9 = Nothing
                                                                       '  End If
                                                                      
                                                                       Case Else
                                                                           lnTNumVigPr = 0
                                                                           lnTCapVigPr = 0
                                                                       
                                                                   End Select
                                                                   
                                                                   'ARCV 30-06-2006
                                                                   If psConcepto = "C" Then
                                                                        Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                            " ISNULL(SUM(" & IIf(lsConcepto = "C", "ISNULL(nSaldoCap,0)-ISNULL(nCapVencido,0)", "nIntDev") & "),0) AS Capital " & _
                                                                            " FROM " & psServConsol & "CreditoConsol " & _
                                                                            " WHERE nPrdEstado in(" & lsCreditosJudicial & ") AND nSaldoCap > 0 AND  " & lsCondJud & _
                                                                            " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                            " AND substring(cCtaCod,4,2) = '" & Trim(rsAg!cAgeCod) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                            " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                            " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                            " AND nDemanda = 2 " & _
                                                                            " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & lsRFACondicion
                                                                            
                                                                            
                                                                            Set Reg9 = GetQuery(Sql9)
                                                                            lnTCapVigPr = lnTCapVigPr + IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                    End If
                                                                   '--------------------------------------
                                                                   
                                                                   '====== Cartera Vencida 1 Producto de Agencia  ===
                                                                   Select Case i
                                                                       
                                                                       Case 0  ' Comerciales  ******************
                                                                        lnRangoIni = 16   ' Comerciales
                                                                        lnRangoFin = 9999
                                                                         
                                                                        Sql9 = " SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                            " ISNULL(SUM(" & IIf(lsConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital, " & _
                                                                            IIf(lsConcepto = "C", "ISNULL(SUM(nCapVencido),0)", "0") & " AS CapVencido " & _
                                                                            " FROM " & psServConsol & "CreditoConsol C " & _
                                                                            " WHERE nPrDEstado in (" & lsCreditosVigentes & " ) " & _
                                                                            " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                            " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                            " AND substring(cLineaCred,1,4) IN ('" & rsFF!cLineaCred & "')" & _
                                                                            " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                            " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                            " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                            " And ndiasatraso <= " & Val(lnRangoFin) & _
                                                                            lsRFACondicion
                                                                            
                                                                        Set Reg9 = GetQuery(Sql9)
                                                                         lnTNumVen1Pr = Reg9!Numero
                                                                         lnTCapVen1Pr = Reg9!Capital
                                                                         lnTCapVenNJud = Reg9!Capital
                                                                         Reg9.Close
                                                                         Set Reg9 = Nothing

                                                                       
                                                                       Case 1  ' Mes Caja Pyme  ******************
                                                                        lnRangoIni = 31   ' MicroEmpresa
                                                                        lnRangoFin = 9999
                                                                         
                                                                        Sql9 = " SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                            " ISNULL(SUM(" & IIf(lsConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital, " & _
                                                                            IIf(lsConcepto = "C", "ISNULL(SUM(nCapVencido),0)", "0") & " AS CapVencido " & _
                                                                            " FROM " & psServConsol & "CreditoConsol C " & _
                                                                            " WHERE nPrDEstado in (" & lsCreditosVigentes & " ) " & _
                                                                            " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                            " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                            " AND substring(cLineaCred,1,4) IN ('" & rsFF!cLineaCred & "')" & _
                                                                            " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                            " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                            " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                            " And ndiasatraso <= " & Val(lnRangoFin) & _
                                                                            lsRFACondicion
                                                                            
                                                                        Set Reg9 = GetQuery(Sql9)
                                                                         lnTNumVen1Pr = Reg9!Numero
                                                                         lnTCapVen1Pr = Reg9!Capital
                                                                         lnTCapVenNJud = Reg9!Capital
                                                                         Reg9.Close
                                                                         Set Reg9 = Nothing
                                                  
                                                                               
                                                                      Case 2, 4 ' Consumo / / Hipotecario **********
                                                                        lnRangoIni = 31   ' Capital Vencido OJO
                                                                        lnRangoFin = 90
                                                                         
                                                                         If lsConcepto = "I" Then
                                                                         
                                                                            'Set Reg9 = GetDatosReclasifica(psServConsol, lsConcepto, RsM!nConsValor, prod(I), SubProd(I, J), rsAg!cAgeCod, rsFF!cLineaCred, rsPL!nConsValor, NorRef, lnRangoIni, lnRangoFin)
                                                                            
                                                                            Sql9 = " SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                                " ISNULL(SUM(nIntDev),0) AS Capital " & _
                                                                                " FROM " & psServConsol & "CreditoConsol C " & _
                                                                                " WHERE nPrDEstado in (" & lsCreditosVigentes & " ) " & _
                                                                                " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                                " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                                " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                                " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                                " AND substring(cLineaCred,1,4) IN ('" & rsFF!cLineaCred & "')" & _
                                                                                " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                                " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                                " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                                " And ndiasatraso <= " & Val(lnRangoFin) & _
                                                                                lsRFACondicion
                                                                                
                                                                            Set Reg9 = GetQuery(Sql9)
                                                                            lnTNumVen1Pr = Reg9!Numero
                                                                            lnTCapVen1Pr = Reg9!Capital
                                                                            lnTCapVenNJud = Reg9!Capital
                                                                            Reg9.Close
                                                                            Set Reg9 = Nothing
                                                                            
                                                                         Else
                                                                         
                                                                            Sql9 = " SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                                " ISNULL(SUM(" & IIf(lsConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital, " & _
                                                                                IIf(lsConcepto = "C", "ISNULL(SUM(nCapVencido),0)", "0") & " AS CapVencido " & _
                                                                                " FROM " & psServConsol & "CreditoConsol C " & _
                                                                                " WHERE nPrDEstado in (" & lsCreditosVigentes & " ) " & _
                                                                                " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                                " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                                " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                                " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                                " AND substring(cLineaCred,1,4) IN ('" & rsFF!cLineaCred & "')" & _
                                                                                " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                                " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                                " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                                " And ndiasatraso <= " & Val(lnRangoFin) & _
                                                                                lsRFACondicion
                                                                                
                                                                            Set Reg9 = GetQuery(Sql9)
                                                                            lnTNumVen1Pr = Reg9!Numero
                                                                            lnTCapVen1Pr = Reg9!CapVencido
                                                                            lnTCapVenNJud = Reg9!CapVencido
                                                                            ' Agrega SaldoCap - CapVencido a Vignetes
                                                                            lnTCapVigPr = lnTCapVigPr + IIf(IsNull(Reg9!Capital), 0, Reg9!Capital) - IIf(IsNull(Reg9!CapVencido), 0, Reg9!CapVencido)
                                                                            'ARCV 30-06-2006
                                                                            'lnTCapVigPr = lnTCapVigPr + IIf(IsNull(Reg9!CapVencido), 0, Reg9!CapVencido)
                                                                            Reg9.Close
                                                                            Set Reg9 = Nothing
      
                                                                        End If
                                                                                         
                                                                      Case 3  ' Prendario  *************************
                                                                        'ARCV 27-06-2006
                                                                          'If Trim(rsFF!cLineaCred) = "0101" And Trim(RsM!nConsValor) = "1" And Trim(rsPL!nConsValor) = "1" And I = 3 And NorRef = 0 Then   ' Si es RR PP
                                                                            lnRangoIni = 31
                                                                            lnRangoFin = 9999
                                                                            Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                                " ISNULL(SUM(" & psConcepto & "),0) AS Capital " & _
                                                                               " FROM " & psServConsol & "CreditoConsol " & _
                                                                               " WHERE nPrdEstado in ( " & lsCreditosPignoraticio & ") " & _
                                                                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ('305')" & _
                                                                               " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                               " And ndiasAtraso <= " & Val(lnRangoFin) & _
                                                                               lsRFACondicion

                                                                             Set Reg9 = GetQuery(Sql9)
                                                                             lnTNumVen1Pr = Reg9!Numero
                                                                             lnTCapVen1Pr = Reg9!Capital
                                                                             lnTCapVenNJud = Reg9!Capital
                                                                             lnTCapVenSJud = 0
                                                                             Reg9.Close
                                                                             Set Reg9 = Nothing
                                                                         'End If
                                                                       
                                                                      Case Else
                                                                         lnTNumVen1Pr = 0
                                                                         lnTCapVen1Pr = 0
                                                                         lnTCapVenSJud = 0
                                                                         lnTCapVenNJud = 0
                                                                   End Select
                                                                   
                                                                   '=================================================
                                                                   '====== Cartera Vencida 2 Producto de Agencia  ===
                                                                   
                                                                   Select Case i
                                                                               
                                                                       Case 2, 4  ' Consumo / Hipotecario
                                                      
                                                                        lnRangoIni = 91   '
                                                                        lnRangoFin = 9999

                                                                        Sql9 = " SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                            " ISNULL(SUM(" & IIf(lsConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital, " & _
                                                                            IIf(lsConcepto = "C", "ISNULL(SUM(nCapVencido),0)", "0") & " AS CapVencido " & _
                                                                            " FROM " & psServConsol & "CreditoConsol C " & _
                                                                            " WHERE nPrDEstado in (" & lsCreditosVigentes & " ) " & _
                                                                            " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                            " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                            " AND substring(cLineaCred,1,4) IN ('" & rsFF!cLineaCred & "')" & _
                                                                            " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                            " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                            " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                            " And ndiasatraso <= " & Val(lnRangoFin) & _
                                                                            lsRFACondicion
                                                                            
                                                                        Set Reg9 = GetQuery(Sql9)
                                                                        lnTNumVen2Pr = Reg9!Numero
                                                                        lnTCapVen2Pr = Reg9!Capital
                                                                        lnTCapVenNJud = lnTCapVenNJud + Reg9!Capital
                                                                        Reg9.Close
                                                                        Set Reg9 = Nothing

                                                                      Case Else
                                                                          lnTNumVen2Pr = 0
                                                                          lnTCapVen2Pr = 0
                                                                           
                                                                   End Select
                                                                   
                                                                   '=========================================================
                                                                   '====== En Asesoria Legal Producto de Agencia          ===
                                                                   '====== Sin Demanda Judicial//Administrado por Agencia ===
                                                                  
                                                                   Select Case i
                                                                       Case 0, 1, 2, 4 '
                                                                            Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                            " ISNULL(SUM(" & IIf(lsConcepto = "C", "nCapVencido", "nIntDev") & "),0) AS Capital " & _
                                                                            " FROM " & psServConsol & "CreditoConsol " & _
                                                                            " WHERE nPrdEstado in(" & lsCreditosJudicial & ") AND nSaldoCap > 0 AND  " & lsCondJud & _
                                                                            " AND  substring(cCtaCod,6,1)= '" & Trim(RsM!nConsValor) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                            " AND substring(cCtaCod,4,2) = '" & Trim(rsAg!cAgeCod) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                            " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                            " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                            " AND nDemanda = 2 " & _
                                                                            " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & lsRFACondicion
                                                                            
                                                                            '" ISNULL(SUM(" & IIf(lsConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital " & _ (Se Cambio nCapVencido enlu gar de nSaldoCap )

                                                                            Set Reg9 = GetQuery(Sql9)
                                                                            lnTNumJudSDemPr = Reg9!Numero
                                                                            lnTCapJudSDemPr = Reg9!Capital
                                                                            Reg9.Close
                                                                            Set Reg9 = Nothing

                                                                         '********
                                                                      Case Else
                                                                          lnTNumJudSDemPr = 0
                                                                          lnTCapJudSDemPr = 0
                                                                           
                                                                   End Select
                                                                   
                                                                   '=========================================================
                                                                   '====== En Asesoria Legal Producto de Agencia          ===
                                                                   '====== Con Demanda Judicial//Administrado por Recuper ===
                                                                   Select Case i
                                                                       Case 0, 1, 2, 4  ' Comer / Pyme / Consumo / Agric / Admin / Hipotec / Miviviend ******
                                                                        ' If NorRef = 0 Then  ' Si es Normal
                                                                                ' Incluyo los Judiciales con saldo de capital = 0
                                                                                 Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                                " ISNULL(SUM(" & IIf(lsConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital " & _
                                                                                " FROM " & psServConsol & "CreditoConsol " & _
                                                                                " WHERE nPrdEstado in (" & lsCreditosJudicial & ") " & _
                                                                                " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                                " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                                " AND substring(cCtaCod,4,2) = '" & Trim(rsAg!cAgeCod) & "'" & _
                                                                                " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                                " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                                " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                                " " & _
                                                                                " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                                lsRFACondicion & " AND nDemanda = 1" ' ==> SE AGREGO"
                                                                                
                                                                                ' AND nDemanda = 1 ==> SE elimino
                                                                                
                                                                                Set Reg9 = GetQuery(Sql9)
                                                                                lnTNumJudCDemPr = Reg9!Numero
                                                                                lnTCapJudCDemPr = Reg9!Capital
                                                                                Reg9.Close
                                                                                Set Reg9 = Nothing
                                                                         'End If
                                                                         '********
                                                                      Case Else
                                                                          lnTNumJudCDemPr = 0
                                                                          lnTCapJudCDemPr = 0
                                                                           
                                                                   End Select
                                                                   '=================================================
                                                                   ' ***************************************
                                                                   ' ***** Asigna Valores a la Agencia ******
                                                                   lnTCredPL = lnTCredPL + lnTCredPr
                                                                   lnTSaldoCapPL = lnTSaldoCapPL + lnTSaldoCapPr
                                                                   lnTNumVigPL = lnTNumVigPL + lnTNumVigPr
                                                                   lnTCapVigPL = lnTCapVigPL + lnTCapVigPr
                                                                   lnTNumVen1PL = lnTNumVen1PL + lnTNumVen1Pr
                                                                   lnTCapVen1PL = lnTCapVen1PL + lnTCapVen1Pr
                                                                   lnTNumVen2PL = lnTNumVen2PL + lnTNumVen2Pr
                                                                   lnTCapVen2PL = lnTCapVen2PL + lnTCapVen2Pr
                                                                   lnTNumJudSDemPL = lnTNumJudSDemPL + lnTNumJudSDemPr
                                                                   lnTCapJudSDemPL = lnTCapJudSDemPL + lnTCapJudSDemPr
                                                                   lnTNumJudCDemPL = lnTNumJudCDemPL + lnTNumJudCDemPr
                                                                   lnTCapJudCDemPL = lnTCapJudCDemPL + lnTCapJudCDemPr
                                                                   
                                                                   ' *****  Imprime
                                                                   lsRtfImp = lsRtfImp & IIf(Trim(rsPL!nConsValor) = "1", " CP-", " LP-")
                                                                   
                                                                   If NorRef = 0 Then lsRtfImp = lsRtfImp & "NORMAL     "
                                                                   If NorRef = 1 Then lsRtfImp = lsRtfImp & "REFINANCIAD"
                                                                   If NorRef = 2 Then lsRtfImp = lsRtfImp & "RFC        "
                                                                   If NorRef = 3 Then lsRtfImp = lsRtfImp & "DIFERENCIAL"
                                                                   
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPr, 5, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigPr, 5, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1Pr, 5, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1Pr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2Pr, 5, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2Pr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemPr, 5, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemPr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemPr, 5, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemPr, 12, 2, True) & " | "
                                                                   'If lnTSaldoCapPr <> 0 And lsConcepto = "C" Then
                                                                   '  lsRTfimp = lsRTfimp & ImpreFormat(Round(((lnTSaldoCapPr - lnTCapVigPr) / lnTSaldoCapPr) * 100, 2), 3, 2) & "%"
                                                                   'End If
                                                                   lsRtfImp = lsRtfImp & Chr(10)
                                                                   liLineas = liLineas + 1
                                                                   'Obtiene las fuentes financiam
                                                                   Conecta.AbreConexion
                                                                   Sql9 = " Select top 1 cctacont FFinan From " & psServConsol & "ColocLineaCreditoEquiv Where substring(cLineaCred,1,4)='" & Left(rsFF!cLineaCred, 4) & "' "
                                                                   Set Reg9 = GetQuery(Sql9)
                                                                   If IsNull(Reg9!FFinan) Then
                                                                      MsgBox "Error No encuentro la F.Financia( ColocLineaCreditoEquiv )", vbInformation, "Aviso"
                                                                      lsFFinanc = "XX"
                                                                   Else
                                                                      lsFFinanc = Reg9!FFinan
                                                                   End If
                                                                   Conecta.CierraConexion
                                                                   '************* Para Grabar en Tabla   **************
                                                                   'Vigentes
                                                                   Dim FechaCierre As Date
                                                                   FechaCierre = GetFechaCierreMes
                                                                   
                                                                   If lnTCapVigPr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo, cRFA) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(FechaCierre, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '1','" & IIf(NorRef = 0, "N", "R") & "','N'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & lsFFinanc & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapVigPr & ",'" & lsRFACredito & "' )"
                                                                     
                                                                     Conecta.AbreConexion
                                                                     Conecta.Ejecutar (Sql9)
                                                                     Conecta.CierraConexion
                                                                   End If
                                                                   
                                                                   'Vencidas Adm por Age
                                                                   If lnTCapVen1Pr + lnTCapVen2Pr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo, cRFA) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(FechaCierre, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '5','" & IIf(NorRef = 0, "N", "R") & "','N'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & lsFFinanc & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapVen1Pr + lnTCapVen2Pr & ",'" & lsRFACredito & "' )"
                                                                     Conecta.AbreConexion
                                                                     Conecta.Ejecutar (Sql9)
                                                                     Conecta.CierraConexion
                                                                   End If
                                                                   
                                                                   'Judicial - Administ por Agencia (sin demanda)
                                                                   If lnTCapJudSDemPr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo, cRFA) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(FechaCierre, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '6','" & IIf(NorRef = 0, "N", "R") & "','N'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & lsFFinanc & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapJudSDemPr & ",'" & lsRFACredito & "' )"
                                                                     Conecta.AbreConexion
                                                                    
                                                                     Conecta.Ejecutar (Sql9)
                                                                     Conecta.CierraConexion
                                                                   End If
                                                                   'Judicial - Administ por Recup
                                                                   If lnTCapJudCDemPr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo, cRFA) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(FechaCierre, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '6','" & IIf(NorRef = 0, "N", "R") & "','S'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & lsFFinanc & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapJudCDemPr & ",'" & lsRFACredito & "' )"
                                                                     Conecta.AbreConexion
                                                                     Conecta.Ejecutar (Sql9)
                                                                     Conecta.CierraConexion
                                                                     
                                                                   End If
                                                                   
                                                                   'ARCV 04-07-2006 (Nuevo Estado 7)
                                                                   If lsConcepto = "C" Then
                                                                        lnTCapVigenMoroso = lnTCapVigPr - (lnTCapVen1Pr + lnTCapVen2Pr + lnTCapJudSDemPr)
                                                                        If lnTCapVigenMoroso <> 0 Then
                                                                            Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo, cRFA) " _
                                                                                & " VALUES ('" & lsConcepto & "','" & Format(FechaCierre, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '7','" & IIf(NorRef = 0, "N", "R") & "','N'," & SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & lsFFinanc & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapVigenMoroso & ",'" & lsRFACredito & "' )"
                                                                     
                                                                            Conecta.AbreConexion
                                                                            Conecta.Ejecutar (Sql9)
                                                                            Conecta.CierraConexion
                                                                        End If
                                                                   End If
                                                                   '-----------------------
                                                                   '***********************************************************
                                                               Next NorRef
                            
                                                               ' ***** Asigna Valores a F.Financia******
                                                               lnTCredF = lnTCredF + lnTCredPL
                                                               lnTSaldoCapF = lnTSaldoCapF + lnTSaldoCapPL
                                                               lnTNumVigF = lnTNumVigF + lnTNumVigPL
                                                               lnTCapVigF = lnTCapVigF + lnTCapVigPL
                                                               lnTNumVen1F = lnTNumVen1F + lnTNumVen1PL
                                                               lnTCapVen1F = lnTCapVen1F + lnTCapVen1PL
                                                               lnTNumVen2F = lnTNumVen2F + lnTNumVen2PL
                                                               lnTCapVen2F = lnTCapVen2F + lnTCapVen2PL
                                                               lnTNumJudSDemF = lnTNumJudSDemF + lnTNumJudSDemPL
                                                               lnTCapJudSDemF = lnTCapJudSDemF + lnTCapJudSDemPL
                                                               lnTNumJudCDemF = lnTNumJudCDemF + lnTNumJudCDemPL
                                                               lnTCapJudCDemF = lnTCapJudCDemF + lnTCapJudCDemPL
                                                               
                                                               ' *****  Imprime
                                                               lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                                                               lsRtfImp = lsRtfImp & " TOT. PLAZO    " ' & lsDescPr
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPL, 5, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigPL, 5, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1PL, 5, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1PL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2PL, 5, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2PL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemPL, 5, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemPL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemPL, 5, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemPL, 12, 2, True) & " | "
                                                               'If lnTSaldoCapPL <> 0 And lsConcepto = "C" Then
                                                               '   lsRTfimp = lsRTfimp & ImpreFormat(Round(((lnTSaldoCapPL - lnTCapVigPL) / lnTSaldoCapPL) * 100, 2), 3, 2) & "%"
                                                               'End If
                                                               lsRtfImp = lsRtfImp & Chr(10)
                                                               liLineas = liLineas + 2
                                                               
                                                               ' ****************************
                                                               ' ****  Verifica Si Cambio pagina
                                                               If liLineas >= 54 Then 'Para el control de salto de página
                                                                  lsRtfImp = lsRtfImp & Chr(12)
                                                                  cpag = cpag + 1
                                                                  lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                                                  liLineas = 6
                                                               End If
                                                           
                                                           End If   ' Si encuentra Datos en Plazo
                                                           rsPL.MoveNext
                                                        Loop   ' Plazo
                                                    End If   ' Plazo
                                                    ' ***************************************
                                                    ' ***** Asigna Valores a Sub Producto ******
                                                    lnTCredSubPr = lnTCredSubPr + lnTCredF
                                                    lnTSaldoCapSubPr = lnTSaldoCapSubPr + lnTSaldoCapF
                                                    lnTNumVigSubPr = lnTNumVigSubPr + lnTNumVigF
                                                    lnTCapVigSubPr = lnTCapVigSubPr + lnTCapVigF
                                                    lnTNumVen1SubPr = lnTNumVen1SubPr + lnTNumVen1F
                                                    lnTCapVen1SubPr = lnTCapVen1SubPr + lnTCapVen1F
                                                    lnTNumVen2SubPr = lnTNumVen2SubPr + lnTNumVen2F
                                                    lnTCapVen2SubPr = lnTCapVen2SubPr + lnTCapVen2F
                                                    lnTNumJudSDemSubPr = lnTNumJudSDemSubPr + lnTNumJudSDemF
                                                    lnTCapJudSDemSubPr = lnTCapJudSDemSubPr + lnTCapJudSDemF
                                                    lnTNumJudCDemSubPr = lnTNumJudCDemSubPr + lnTNumJudCDemF
                                                    lnTCapJudCDemSubPr = lnTCapJudCDemSubPr + lnTCapJudCDemF
                                                    ' *****  Imprime
                                                    lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                                                    lsRtfImp = lsRtfImp & " TOT. F.FINANC." ' & lsDescPr
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCredF, 5, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapF, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigF, 5, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigF, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1F, 5, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1F, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2F, 5, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2F, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemF, 5, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemF, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemF, 5, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemF, 12, 2, True) & " | "
                                                    If lnTSaldoCapF <> 0 And lsConcepto = "C" Then
                                                      lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapF - lnTCapVigF) / IIf(lnTSaldoCapF = 0, 1, lnTSaldoCapF)) * 100, 2), 3, 2) & "%"
                                                    End If
                                                    lsRtfImp = lsRtfImp & Chr(10)
                                                    liLineas = liLineas + 2
                                                    
                                                    ' ****************************
                                                    ' ****  Verifica Si Cambio pagina
                                                    If liLineas >= 54 Then 'Para el control de salto de página
                                                       lsRtfImp = lsRtfImp & Chr(12)
                                                       cpag = cpag + 1
                                                       lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                                       liLineas = 6
                                                    End If
                                        
                                               End If  ' Fuentes Financiamiento
                                               rsFF.MoveNext
                                            Loop  ' fuente Financiamiento
                                               
                                        End If   ' Fuente financiamiento
                                        
                                        ' ***************************************
                                        ' ***** Asigna Valores a Agencia  ******
                                        lnTCredAG = lnTCredAG + lnTCredSubPr
                                        lnTSaldoCapAG = lnTSaldoCapAG + lnTSaldoCapSubPr
                                        lnTNumVigAG = lnTNumVigAG + lnTNumVigSubPr
                                        lnTCapVigAG = lnTCapVigAG + lnTCapVigSubPr
                                        lnTNumVen1AG = lnTNumVen1AG + lnTNumVen1SubPr
                                        lnTCapVen1AG = lnTCapVen1AG + lnTCapVen1SubPr
                                        lnTNumVen2AG = lnTNumVen2AG + lnTNumVen2SubPr
                                        lnTCapVen2AG = lnTCapVen2AG + lnTCapVen2SubPr
                                        lnTNumJudSDemAG = lnTNumJudSDemAG + lnTNumJudSDemSubPr
                                        lnTCapJudSDemAG = lnTCapJudSDemAG + lnTCapJudSDemSubPr
                                        lnTNumJudCDemAG = lnTNumJudCDemAG + lnTNumJudCDemSubPr
                                        lnTCapJudCDemAG = lnTCapJudCDemAG + lnTCapJudCDemSubPr
                                        ' *****  Imprime
                                        lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                                        lsRtfImp = lsRtfImp & "  TOT.SUBPROD. " ' & lsDescPr
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCredSubPr, 5, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapSubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigSubPr, 5, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigSubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1SubPr, 5, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1SubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2SubPr, 5, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2SubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemSubPr, 5, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemSubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemSubPr, 5, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemSubPr, 12, 2, True) & " | "
                                        If lnTSaldoCapSubPr <> 0 And lsConcepto = "C" Then
                                          lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapSubPr - lnTCapVigSubPr) / lnTSaldoCapSubPr) * 100, 2), 3, 2) & "%"
                                        End If
                                        lsRtfImp = lsRtfImp & Chr(10)
                                        liLineas = liLineas + 2
                                        
                                        ' ****************************
                                        ' ****  Verifica Si Cambio pagina
                                        If liLineas >= 54 Then 'Para el control de salto de página
                                           lsRtfImp = lsRtfImp & Chr(12)
                                           cpag = cpag + 1
                                           lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                           liLineas = 6
                                        End If
                                    End If  ' Sub Productos
                                 Next J
                                 
                                ' ***************************************
                                ' ***** Asigna Valores a Producto ******
                                lnTCredProd = lnTCredProd + lnTCredAG
                                lnTSaldoCapProd = lnTSaldoCapProd + lnTSaldoCapAG
                                lnTNumVigProd = lnTNumVigProd + lnTNumVigAG
                                lnTCapVigProd = lnTCapVigProd + lnTCapVigAG
                                lnTNumVen1Prod = lnTNumVen1Prod + lnTNumVen1AG
                                lnTCapVen1Prod = lnTCapVen1Prod + lnTCapVen1AG
                                lnTNumVen2Prod = lnTNumVen2Prod + lnTNumVen2AG
                                lnTCapVen2Prod = lnTCapVen2Prod + lnTCapVen2AG
                                lnTNumJudSDemProd = lnTNumJudSDemProd + lnTNumJudSDemAG
                                lnTCapJudSDemProd = lnTCapJudSDemProd + lnTCapJudSDemAG
                                lnTNumJudCDemProd = lnTNumJudCDemProd + lnTNumJudCDemAG
                                lnTCapJudCDemProd = lnTCapJudCDemProd + lnTCapJudCDemAG
                                ' *****  Imprime
                                lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                                lsRtfImp = lsRtfImp & " TOT. AGENCIA  "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCredAG, 5, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigAG, 5, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigAG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1AG, 5, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1AG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2AG, 5, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2AG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemAG, 5, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemAG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemAG, 5, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemAG, 12, 2, True) & " | "
                                If lnTSaldoCapAG <> 0 And lsConcepto = "C" Then
                                lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapAG - lnTCapVigAG) / IIf(lnTSaldoCapAG = 0, 1, lnTSaldoCapAG)) * 100, 2), 3, 2) & "%"
                                End If
                                lsRtfImp = lsRtfImp & Chr(10)
                                liLineas = liLineas + 2
                                 
                                If liLineas >= 54 Then 'Para el control de salto de página
                                   lsRtfImp = lsRtfImp & Chr(12)
                                   cpag = cpag + 1
                                   lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                   liLineas = 6
                                End If
                             End If  ' De la Agencia
                             rsAg.MoveNext
                         Loop   ' De agencia
                     End If '  Producto
                         
                    ' ***************************************
                    ' ***** Asigna Valores a MONEDA   ******
                    lnTCredM = lnTCredM + lnTCredProd
                    lnTSaldoCapM = lnTSaldoCapM + lnTSaldoCapProd
                   ' i = i - 1
                    lnTNumVigM = lnTNumVigM + lnTNumVigProd
                    lnTCapVigM = lnTCapVigM + lnTCapVigProd
                    lnTNumVen1M = lnTNumVen1M + lnTNumVen1Prod
                    lnTCapVen1M = lnTCapVen1M + lnTCapVen1Prod
                    lnTNumVen2M = lnTNumVen2M + lnTNumVen2Prod
                    lnTCapVen2M = lnTCapVen2M + lnTCapVen2Prod
                    lnTNumJudSDemM = lnTNumJudSDemM + lnTNumJudSDemProd
                    lnTCapJudSDemM = lnTCapJudSDemM + lnTCapJudSDemProd
                    lnTNumJudCDemM = lnTNumJudCDemM + lnTNumJudCDemProd
                    lnTCapJudCDemM = lnTCapJudCDemM + lnTCapJudCDemProd

                    ' *****  Imprime
                    lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                    lsRtfImp = lsRtfImp & "  TOT PRODUCT  "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCredProd, 5, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapProd, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigProd, 5, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigProd, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1Prod, 5, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1Prod, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2Prod, 5, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2Prod, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemProd, 5, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemProd, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemProd, 5, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemProd, 12, 2, True) & " | "
                    If lnTSaldoCapProd <> 0 And lsConcepto = "C" Then
                     lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapProd - lnTCapVigProd) / IIf(lnTSaldoCapProd = 0, 1, lnTSaldoCapProd)) * 100, 2), 3, 2) & "%"
                    End If
                    lsRtfImp = lsRtfImp & Chr(10)
                    liLineas = liLineas + 2
                 Next i   ' Para el Sgte Producto
                ' *****  Imprime
                lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                lsRtfImp = lsRtfImp & "  TOT MONEDA   "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCredM, 5, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapM, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigM, 5, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigM, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1M, 5, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1M, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2M, 5, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2M, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemM, 5, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemM, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemM, 5, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemM, 12, 2, True) & " | "
                If lnTSaldoCapM <> 0 And lsConcepto = "C" Then
                  lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapM - lnTCapVigM) / IIf(lnTSaldoCapM = 0, 1, lnTSaldoCapM)) * 100, 2), 3, 2) & "%"
                End If
                lsRtfImp = lsRtfImp & Chr(10)
                lsRtfImp = lsRtfImp & String(165, "-") & Chr(10)
                'lsRTfImp = lsRTfImp & Chr(10)
                liLineas = liLineas + 4
             
            End If '---liDatos - Moneda
            lbSiCambio = True
                RaiseEvent Progress(RsM.Bookmark, RsM.RecordCount)
            RsM.MoveNext
            If Not RsM.EOF Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                liLineas = 0
            End If
        Loop ' ---- Moneda
    End If '--- Moneda
    RaiseEvent CloseProgress
    RsM.Close
    Set RsM = Nothing
Else
    nRepo108705_ImpCarteraReclasificacion_Ant = ""
End If '--- liDatos - General
lsRtfImpG = lsRtfImp ' Asigna el valor
nRepo108705_ImpCarteraReclasificacion_Ant = lsRtfImpG
Screen.MousePointer = 1
End Function


Public Function nRepo108708_ImpRepResumenGarantias(psServConsol As String, pPlanCuentas As String, pTipoCambio As Single) As String
Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPL As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset

Dim lsDescPr As String
Dim lsDescF As String
Dim lsDescAG As String

Dim liLineas As Integer
Dim liDatos  As Long


Dim lnTHipoSoles As Double
Dim lnTHipoDol As Double
Dim lnTGarantSoles As Double
Dim lnTGarantDol As Double

' *** Agencia
Dim lnTHipoSolesAG As Double
Dim lnTHipoDolAG As Double
Dim lnTGarantSolesAG As Double
Dim lnTGarantDolAG As Double

Dim lbSiCambio As Boolean

'Dim prod(8) As String
Dim prod() As Variant

Dim lsRtfImp As String
Dim cpag As Integer

Dim lnCredAdmin As Integer ' Bandera Para Cred Admin

Dim Ag As Integer

Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim i As Integer
Dim lsRtfImpG As String


'ARCV 06-07-2006
'Totales por Producto
Dim lnTHipoSolesPr As Double
Dim lnTHipoDolPr As Double
Dim lnTGarantSolesPr As Double
Dim lnTGarantDolPr As Double
'Totales Generales
Dim lnTHipoSolesT As Double
Dim lnTHipoDolT As Double
Dim lnTGarantSolesT As Double
Dim lnTGarantDolT As Double

'---------------

Dim lSSQL9 As String
lsCreditosVigentes = "(" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc '& " ) "
'ARCV 06-07-2006
lsCreditosVigentes = lsCreditosVigentes & "," & gColocEstRecVigCast & "," & 2205 & "," & 2206 & ")"
'-----------------------

'lsPignoraticio = " (2807,2802,2803,2804) "
lsPignoraticio = "(" & DevuelveCadenaEstadosPignoraticio & ")" 'ARCV 27-07

' Para Cada Producto
'prod(0) = " '101' "  ' caja pyme
'prod(1) = " '102' "  ' institucional
'prod(2) = " '103' "  ' immobiliario
'prod(3) = " '201' "  ' pyme / mes
'prod(4) = " '301' "  ' planilla cash
'prod(5) = " '320' "  ' Prestamos administrativos
'prod(6) = " '402' " ' Hipotecario
'prod(7) = " '305' "  ' Prendario
'prod(8) = " '304' "  ' Personal
'prod = RecuperaTodoslosProductos
ReDim prod(5)
prod(0) = RecuperaCadenaTipoProducto("1")
prod(1) = RecuperaCadenaTipoProducto("2")
prod(2) = RecuperaCadenaTipoProducto("3")
prod(3) = "'305'"
prod(4) = RecuperaCadenaTipoProducto("4")

lbSiCambio = False
lsRtfImp = ""
cpag = 1
Ag = 0
'===== Verificar si existen datos para el reporte
Sql9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol where nPrdEstado in " & lsCreditosVigentes
Set Reg9 = GetQuery(Sql9)
If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing
liDatos = liDatos + Round(liDatos / 10, 0)
If liDatos > 0 Then  ' General
    '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)
    '======== Tipo de Plazo =========
        Set rsPL = loConst.RecuperaConstantes(gColocLineaCredPlazo)
        Set loConst = Nothing
   '========= Fuente Financiamiento =========
    Set rsFF = ObtieneLineaCredito 'Fuente Financiamiento
   '======= Para Cada Agencia  =========
    Dim loAg As DAgencias
        Set loAg = New DAgencias
            Set rsAg = loAg.RecuperaAgencias
        Set loAg = Nothing
       
    nRepo108708_ImpRepResumenGarantias = ""
    lsRtfImp = lsRtfImp & CabRepResumenGarantias(cpag, pTipoCambio, pPlanCuentas)
    liLineas = 6
    '======= Para Cada Producto =========
    RaiseEvent ShowProgress
    
    'ARCV 06-07-2006
    lnTHipoSolesT = 0
    lnTHipoDolT = 0
    lnTGarantSolesT = 0
    lnTGarantDolT = 0
    '--------------------
    
     For i = 0 To UBound(prod) - 1 '8  'Para Cada Producto 8
        'lsDescPr = FunDescProductoDetallada(I) ' Desc Garantias
        'lsDescPr = NombreProducto(CInt(Replace(prod(I), "'", "")))
        If i = 0 Then
            lsDescPr = "COMERCIAL"
        ElseIf i = 1 Then
            lsDescPr = "MES"
        ElseIf i = 2 Then
            lsDescPr = "CONSUMO"
        ElseIf i = 3 Then
            lsDescPr = "PRENDARIO"
        Else
            lsDescPr = "HIPOTECARIO"
        End If
        lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69) & "* " & lsDescPr & Chr(27) & Chr(70)
        liLineas = liLineas + 1
        
        'ARCV 06-07-2006
        lnTHipoSolesPr = 0
        lnTHipoDolPr = 0
        lnTGarantSolesPr = 0
        lnTGarantDolPr = 0
        '---------------
        
        '======= Para Cada Agencia  =========
        Ag = 0
        rsAg.MoveFirst
        Do While Not rsAg.EOF
            Ag = Ag + 1

            ' === Si hay datos para la Agencia  ========
            Sql9 = "SELECT Count(cCtaCod) AS NumCred " & _
                " from " & psServConsol & "CreditoConsol " & _
                " WHERE nPrdEstado in " & lsCreditosVigentes & _
                " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
            
            SQL9B = "SELECT Count(cCtaCod) AS NumCred " & _
                " from " & psServConsol & "CreditoConsol " & _
                " WHERE nPrdEstado =" & gColocEstRecVigJud & "  AND nSaldoCap > 0" & _
                " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
             
            'If I = 6 Then  ' Si Prendario
            '   SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
                    " WHERE nPrdEstado IN  " & lsPignoraticio & _
                    " AND substring(cCtaCod,6,3) in ( " & prod(I) & ")" & _
                    " AND substring(cCtaCod,4,2 )= '" & rsAg!cAgeCod & "'"
            'Else
               SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
                       "WHERE nPrdEstado = 9999 "
            'End If
                
            If HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then   ' De la agencia
                        
                lnTHipoSolesAG = 0
                lnTHipoDolAG = 0
                lnTGarantSolesAG = 0
                lnTGarantDolAG = 0
                
                lsDescAG = Mid(rsAg!cAgeDescripcion, 1, 20)
                lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69) & "** " & lsDescAG & Chr(27) & Chr(70)
                liLineas = liLineas + 1
                
                '======= Para Cada F Financ =========
                rsFF.MoveFirst
                Do While Not rsFF.EOF 'Fuente Financ
                    
                    ' === Si hay datos de la Fuente Financiamiento ========
                    Sql9 = "SELECT Count(cCtaCod) AS NumCred " & _
                        " from " & psServConsol & "CreditoConsol " & _
                        " WHERE nPrdEstado in " & lsCreditosVigentes & _
                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                        " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'"
                    
                    SQL9B = "SELECT Count(cCtaCod) AS NumCred " & _
                        " from " & psServConsol & "CreditoConsol " & _
                        " WHERE nPrdEstado =" & gColocEstRecVigJud & "  AND nSaldoCap > 0" & _
                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                        " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'"
                        
                    'If I = 7 And Trim(rsFF!cLineaCred) = "0101" Then ' Si Prendario / RR PP 7
                    '   SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
                            " WHERE nPrdEstado IN " & lsPignoraticio & _
                            " AND substring(cCtaCod,6,3) in ( " & prod(I) & ")" & _
                            " AND substring(cCtaCod,4,2 )= '" & rsAg!cAgeCod & "'"
                    'Else
                       SQL9C = "SELECT count(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol " & _
                               "WHERE nPrdEstado = 9999 "
                    'End If
                    
                    If HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then   ' De la Fuente Financ
                                
                       ' *****************************
                       ' *** Verifica Si Cambio pagina
                          
                       lsRtfImp = lsRtfImp & Chr(10)
                       lsRtfImp = lsRtfImp & "  " & Mid(rsFF!CDescripcion, 1, 15) & Space(15 - Len(Mid(rsFF!CDescripcion, 1, 15)))
                       liLineas = liLineas + 1
                   
                       '================================
                       lnTHipoSoles = 0
                       lnTHipoDol = 0
                       lnTGarantSoles = 0
                       lnTGarantDol = 0

                       '===============================
                       '===== Total Garantias    ======
                       Select Case i
                         
                           Case 0, 1, 2, 4 '3, 4, 5, 6, 8
                                                    
                              Sql9 = "SELECT SUM(nHipoSoles) AS HipoSoles, SUM(nHipoDol) as HipoDol, " & _
                                       " SUM(nGarantSoles) AS GarantSoles, SUM(nGarantDol) as GarantDol " & _
                                       " from " & psServConsol & "CreditoConsol " & _
                                       " WHERE nPrdEstado in " & lsCreditosVigentes & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                       " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                       " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'"
                                       
                              Set Reg9 = GetQuery(Sql9)
                              lnTHipoSoles = IIf(IsNull(Reg9!HipoSoles), 0, Reg9!HipoSoles)
                              lnTHipoDol = IIf(IsNull(Reg9!HipoDol), 0, Reg9!HipoDol)
                              lnTGarantSoles = IIf(IsNull(Reg9!GarantSoles), 0, Reg9!GarantSoles)
                              lnTGarantDol = IIf(IsNull(Reg9!GarantDol), 0, Reg9!GarantDol)
                              
                              Reg9.Close
                              Set Reg9 = Nothing
                              
                             ' Judicial -------------
                              Sql9 = "SELECT SUM(nHipoSoles) AS HipoSoles, SUM(nHipoDol) as HipoDol, " & _
                                  " SUM(nGarantSoles) AS GarantSoles, SUM(nGarantDol) as GarantDol " & _
                                  " from " & psServConsol & "CreditoConsol " & _
                                  " WHERE nPrdEstado =" & gColocEstRecVigJud & "  AND nSaldoCap > 0" & _
                                  " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                  " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                  " AND substring(cLineaCred,1,4) = '" & Trim(rsFF!cLineaCred) & "'"

                              Set Reg9 = GetQuery(Sql9)
                              lnTHipoSoles = lnTHipoSoles + IIf(IsNull(Reg9!HipoSoles), 0, Reg9!HipoSoles)
                              lnTHipoDol = lnTHipoDol + IIf(IsNull(Reg9!HipoDol), 0, Reg9!HipoDol)
                              lnTGarantSoles = lnTGarantSoles + IIf(IsNull(Reg9!GarantSoles), 0, Reg9!GarantSoles)
                              lnTGarantDol = lnTGarantDol + IIf(IsNull(Reg9!GarantDol), 0, Reg9!GarantDol)
                              
                              Reg9.Close
                              Set Reg9 = Nothing
                           Case 3
                              ' Pignoraticio  -- ' Si es Soles / Corto Plazo / RR PP  -
                              'If Trim(RsM!nConsValor) = "1" And Trim(rsFF!cLineaCred) = "0101" Then
                                 Sql9 = "SELECT Sum(nGarantSoles) AS GarantSoles " & _
                                       " from " & psServConsol & "CreditoConsol WHERE nPrdEstado IN " & lsPignoraticio & _
                                       " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                 Set Reg9 = GetQuery(Sql9)
                                 lnTHipoSoles = lnTHipoSoles + 0
                                 lnTHipoDol = lnTHipoDol + 0
                                 lnTGarantSoles = lnTGarantSoles + IIf(IsNull(Reg9!GarantSoles), 0, Reg9!GarantSoles)
                                 lnTGarantDol = lnTGarantDol + 0

                                 Reg9.Close
                                 Set Reg9 = Nothing
                              'End If
                       End Select
                           
                       ' *****  Imprime las Garantias
                       lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoSoles, 13, 2, True) & " | "
                       lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoDol, 13, 2, True) & " | "
                       lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoSoles + lnTHipoDol * pTipoCambio, 13, 2, True) & " | "
                       lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantSoles, 13, 2, True) & " | "
                       lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantDol, 13, 2, True) & " | "
                       lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantSoles + lnTGarantDol * pTipoCambio, 13, 2, True) & " | "

                       ' *****  Asigna a AGENCIA
                       lnTHipoSolesAG = lnTHipoSolesAG + lnTHipoSoles
                       lnTHipoDolAG = lnTHipoDolAG + lnTHipoDol
                       lnTGarantSolesAG = lnTGarantSolesAG + lnTGarantSoles
                       lnTGarantDolAG = lnTGarantDolAG + lnTGarantDol
                    End If  ' Si hay datos en F.Financ
                    rsFF.MoveNext
                Loop  ' de Fuente Financiamiento
             
                lsRtfImp = lsRtfImp & Chr(10) & String(155, "-") & Chr(10)
                lsRtfImp = lsRtfImp & Space(17)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoSolesAG, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoDolAG, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoSolesAG + lnTHipoDolAG * pTipoCambio, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantSolesAG, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantDolAG, 13, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantSolesAG + lnTGarantDolAG * pTipoCambio, 13, 2, True) & " | "
                liLineas = liLineas + 2
                
                ' ****************************
                ' ****  Verifica Si Cambio pagina
                If liLineas >= 52 Then 'Para el control de salto de página
                   lsRtfImp = lsRtfImp & Chr(12)
                   cpag = cpag + 1
                   lsRtfImp = lsRtfImp & CabRepResumenGarantias(cpag, pTipoCambio, pPlanCuentas)
                   liLineas = 6
                End If
                
                'ARCV 06-07-2006
                lnTHipoSolesPr = lnTHipoSolesPr + lnTHipoSolesAG
                lnTHipoDolPr = lnTHipoDolPr + lnTHipoDolAG
                lnTGarantSolesPr = lnTGarantSolesPr + lnTGarantSolesAG
                lnTGarantDolPr = lnTGarantDolPr + lnTGarantDolAG
                '----------------
                
            End If  ' si hay datos Agencia

            ' ** Sgte agencia
            rsAg.MoveNext
                                
        Loop  ' de Agencia
                           
        lsRtfImp = lsRtfImp & Chr(10)
        RaiseEvent Progress(CInt(i), 10)
        
        'ARCV 06-07-2006
        lsRtfImp = lsRtfImp & Chr(10) & String(155, "-") & Chr(10)
        lsRtfImp = lsRtfImp & "TOT PRODUCTO" & Space(5)  'Space(17)
        lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoSolesPr, 13, 2, True) & " | "
        lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoDolPr, 13, 2, True) & " | "
        lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoSolesPr + lnTHipoDolPr * pTipoCambio, 13, 2, True) & " | "
        lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantSolesPr, 13, 2, True) & " | "
        lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantDolPr, 13, 2, True) & " | "
        lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantSolesPr + lnTGarantDolPr * pTipoCambio, 13, 2, True) & " | "
        lsRtfImp = lsRtfImp & Chr(10)
        liLineas = liLineas + 2

        lnTHipoSolesT = lnTHipoSolesT + lnTHipoSolesPr
        lnTHipoDolT = lnTHipoDolT + lnTHipoDolPr
        lnTGarantSolesT = lnTGarantSolesT + lnTGarantSolesPr
        lnTGarantDolT = lnTGarantDolT + lnTGarantDolPr
        '-----------------------
        
    Next i   ' Para el Sgte Producto
    
    'ARCV 06-07-2006

    lsRtfImp = lsRtfImp & Chr(10) & String(155, "-") & Chr(10)
    lsRtfImp = lsRtfImp & "TOTAL REPORTE" & Space(4) 'Space(17)
    lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoSolesT, 13, 2, True) & " | "
    lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoDolT, 13, 2, True) & " | "
    lsRtfImp = lsRtfImp & ImpreFormat(lnTHipoSolesT + lnTHipoDolT * pTipoCambio, 13, 2, True) & " | "
    lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantSolesT, 13, 2, True) & " | "
    lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantDolT, 13, 2, True) & " | "
    lsRtfImp = lsRtfImp & ImpreFormat(lnTGarantSolesT + lnTGarantDolT * pTipoCambio, 13, 2, True) & " | "
    '---------------
    
    RaiseEvent CloseProgress
Else
    nRepo108708_ImpRepResumenGarantias = ""
End If '--- liDatos - General
lsRtfImpG = lsRtfImp ' Asigna el valor
nRepo108708_ImpRepResumenGarantias = lsRtfImpG
Screen.MousePointer = 1
End Function

' Ya no se usa, fue reemplazada por nRepo108705
Public Function nRepo108711_ImpCarteraReclasificacion(ByVal psServConsol As String, ByVal pPlanCuentas As String, Optional ByVal psConcepto As String = "nSaldoCap") As String
Dim Sql9 As String
Dim SQL9B As String
Dim SQL9C As String
Dim RsM As New ADODB.Recordset
Dim rsPL As New ADODB.Recordset
Dim rsFF As New ADODB.Recordset
Dim rsAg As New ADODB.Recordset
Dim Reg9 As New ADODB.Recordset
Dim lsDescM As String
Dim lsDescPr As String
Dim lsDescP As String
Dim lsDescF As String
Dim lsDescAG As String
Dim lsDescSubPr As String
Dim lsDescPL As String

Dim liLineas As Integer
Dim liDatos  As Long

Dim lnTCred As Single  ' *** General
Dim lnTSaldoCap As Double
Dim lnTNumVig As Single
Dim lnTCapVig As Double
Dim lnTNumVen1 As Integer
Dim lnTCapVen1  As Double
Dim lnTNumVen2 As Integer
Dim lnTCapVen2 As Double
Dim lnTNumJud As Integer
Dim lnTCapJud As Double
Dim lnTCapVenNJud As Double
Dim lnTCapVenSJud As Double

Dim lnTCredM As Single  ' *** Moneda
Dim lnTSaldoCapM As Double
Dim lnTNumVigM As Single
Dim lnTCapVigM As Double
Dim lnTNumVen1M As Integer
Dim lnTCapVen1M  As Double
Dim lnTNumVen2M As Integer
Dim lnTCapVen2M As Double
Dim lnTNumJudSDemM As Integer  ' Sin Deman
Dim lnTCapJudSDemM As Double
Dim lnTNumJudCDemM As Integer  ' Con Deman
Dim lnTCapJudCDemM As Double

Dim lnTCredF As Single  ' *** Fuente Financiamiento
Dim lnTSaldoCapF As Double
Dim lnTNumVigF As Single
Dim lnTCapVigF As Double
Dim lnTNumVen1F As Integer
Dim lnTCapVen1F  As Double
Dim lnTNumVen2F As Integer
Dim lnTCapVen2F As Double
Dim lnTNumJudSDemF As Integer  'Sin Dema
Dim lnTCapJudSDemF As Double
Dim lnTNumJudCDemF As Integer  'Con Deman
Dim lnTCapJudCDemF As Double

Dim lnTCredAG As Single  ' *** Agencia
Dim lnTSaldoCapAG As Double
Dim lnTNumVigAG As Single
Dim lnTCapVigAG As Double
Dim lnTNumVen1AG As Integer
Dim lnTCapVen1AG  As Double
Dim lnTNumVen2AG As Integer
Dim lnTCapVen2AG As Double
Dim lnTNumJudSDemAG As Integer  'sin Dema
Dim lnTCapJudSDemAG As Double
Dim lnTNumJudCDemAG As Integer  'con dema
Dim lnTCapJudCDemAG As Double

Dim lnTCredPr As Single  ' *** Producto - detalle
Dim lnTSaldoCapPr As Double
Dim lnTNumVigPr As Single
Dim lnTCapVigPr As Double
Dim lnTNumVen1Pr As Integer
Dim lnTCapVen1Pr  As Double
Dim lnTNumVen2Pr As Integer
Dim lnTCapVen2Pr As Double
Dim lnTNumJudSDemPr As Integer
Dim lnTCapJudSDemPr As Double
Dim lnTNumJudCDemPr As Integer
Dim lnTCapJudCDemPr As Double



Dim lnTCredSubPr As Single  ' *** Sub Producto
Dim lnTSaldoCapSubPr As Double
Dim lnTNumVigSubPr As Single
Dim lnTCapVigSubPr As Double
Dim lnTNumVen1SubPr As Integer
Dim lnTCapVen1SubPr  As Double
Dim lnTNumVen2SubPr As Integer
Dim lnTCapVen2SubPr As Double
Dim lnTNumJudSDemSubPr As Integer
Dim lnTCapJudSDemSubPr As Double
Dim lnTNumJudCDemSubPr As Integer
Dim lnTCapJudCDemSubPr As Double

Dim lnTCredProd As Single  ' *** Producto
Dim lnTSaldoCapProd As Double
Dim lnTNumVigProd As Single
Dim lnTCapVigProd As Double
Dim lnTNumVen1Prod As Integer
Dim lnTCapVen1Prod  As Double
Dim lnTNumVen2Prod As Integer
Dim lnTCapVen2Prod As Double
Dim lnTNumJudSDemProd As Integer
Dim lnTCapJudSDemProd As Double
Dim lnTNumJudCDemProd As Integer
Dim lnTCapJudCDemProd As Double

Dim lnTCredPL As Single  ' *** Plazo
Dim lnTSaldoCapPL As Double
Dim lnTNumVigPL As Single
Dim lnTCapVigPL As Double
Dim lnTNumVen1PL As Integer
Dim lnTCapVen1PL  As Double
Dim lnTNumVen2PL As Integer
Dim lnTCapVen2PL As Double
Dim lnTNumJudSDemPL As Integer
Dim lnTCapJudSDemPL As Double
Dim lnTNumJudCDemPL As Integer
Dim lnTCapJudCDemPL As Double

Dim lbSiCambio As Boolean
Dim cadena As String

Dim lnCapVencido As Currency  'Para los consumo

Dim prod(7) As String
Dim lnRangoIni As Integer
Dim lnRangoFin As Integer
Dim lsRtfImp As String
Dim cpag As Integer

Dim lnCredAdmin As Integer ' Bandera Para Cred Admin

Dim NumSubProd As Integer ' SubProductos
Dim SubProd(7, 7) As String
Dim J As Integer
Dim NorRef As Integer

'** CAMBIOS SIMON
Dim lsConceptoJud As String
Dim lsCondJud As String
Dim lsConcepto As String
If psConcepto = "nSaldoCap" Then
   lsConceptoJud = "nSaldoCap"
   lsCondJud = " nSaldoCap > 0 "
Else
   lsConceptoJud = "nIntDev"
   lsCondJud = " nIntDev > 0 "
End If

If psConcepto = "nSaldoCap" Then
   lsConcepto = "C"
Else
   lsConcepto = "I"
End If

'********************
Dim lsCreditosVigentesyJudi As String
Dim lsPignoraticio As String
Dim i As Integer
Dim lsRtfImpG As String
Dim FechaCierre As Date
Dim lsCreditosVigentes As String


Dim lSSQL9 As String
FechaCierre = GetFechaCierreMes

lsCreditosVigentesyJudi = "(" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc & ") "
lsCreditosVigentes = "(" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc & " ) "
'lsPignoraticio = "(2101,2104,2106,2107)"
lsPignoraticio = "(" & DevuelveCadenaEstadosPignoraticio & ")" 'ARCV 27-07

' Para Cada SubProducto
SubProd(0, 0) = " '101' " ' Comerciales
SubProd(0, 1) = " '102' " ' Comerciales Agropec
SubProd(1, 0) = " '201' " ' Mes  Pyme
SubProd(1, 1) = " '202' " ' Mes  Agropec
SubProd(2, 0) = " '301' " ' Planilla
SubProd(2, 1) = " '302' " ' Planilla Cash
SubProd(2, 2) = " '303' " ' Planilla Cash
SubProd(2, 3) = " '304' " ' Planilla Cash
SubProd(2, 4) = " '320' " ' Prestamos Administrativos
SubProd(3, 0) = " '305' " ' Prendario
SubProd(4, 0) = " '423' " ' Hipotecario
'SubProd(5, 0) = " 'xxx' " ' Agricola

' Para Cada Producto
prod(0) = " '101','102'"  ' Comercial
prod(1) = " '201','202'"  ' Pyme-Mes
prod(2) = " '301','302','303','320','304'"  ' Consumo
prod(3) = " '305' "  ' Prendario
prod(4) = " '423'" ' Hipotecario
'prod(5) = " '203'" ' Agricola

lbSiCambio = False
lsRtfImp = ""
cpag = 1

cadena = ""

'===== Verificar si existen datos para el reporte
Sql9 = "SELECT COUNT(cCtaCod) as NumCred from " & psServConsol & "CreditoConsol where nPrdEstado in " & lsCreditosVigentesyJudi
Set Reg9 = GetQuery(Sql9)

If Reg9.EOF And Reg9.BOF Then
    liDatos = 0
Else
    liDatos = Reg9!NumCred
End If
Reg9.Close
Set Reg9 = Nothing

liDatos = liDatos + Round(liDatos / 10, 0)

If liDatos > 0 Then  ' General
   Sql9 = "DELETE " & psServConsol & "CredSaldosCont WHERE dFecha = '" & Format(FechaCierre, "mm/dd/yyyy") & "' and cConcepto = '" & lsConcepto & "'"
   Conecta.AbreConexion
   Conecta.Ejecutar (Sql9)
   Conecta.CierraConexion
    
    '======== Tipo de Moneda =========
    Dim loConst As DConstante
        Set loConst = New DConstante
            Set RsM = loConst.RecuperaConstantes(gMoneda)
    '======== Tipo de Plazo =========
        Set rsPL = loConst.RecuperaConstantes(gColocLineaCredPlazo)
        Set loConst = Nothing
        
   '========= Fuente Financiamiento =========
    Set rsFF = ObtieneLineaCredito 'Fuente Financiamiento
    
   '======= Para Cada Agencia  =========
    Dim loAg As DAgencias
        Set loAg = New DAgencias
            Set rsAg = loAg.RecuperaAgencias
        Set loAg = Nothing
    
    nRepo108711_ImpCarteraReclasificacion = ""
    RaiseEvent ShowProgress
    If RsM.EOF And RsM.BOF Then
    Else
        Do While Not RsM.EOF
            '=====LIMPIAR LOS DATOS SUBTOTALES POR MONEDA ======
            lnTCredM = 0:   lnTSaldoCapM = 0
            lnTNumVigM = 0: lnTCapVigM = 0
            lnTNumVen1M = 0: lnTCapVen1M = 0
            lnTNumVen2M = 0: lnTCapVen2M = 0
            lnTNumJudSDemM = 0: lnTCapJudSDemM = 0
            lnTNumJudCDemM = 0: lnTCapJudCDemM = 0
            lsDescM = Trim(RsM!cConsDescripcion)
            '============ CREDITOS VIGENTES PARA UNA DETERMINADA MONEDA =========
            Sql9 = "SELECT Count(cCtaCod) AS NumCred From " & psServConsol & "CreditoConsol " & _
                "WHERE nPrdEstado in " & lsCreditosVigentesyJudi & " and " & _
                "substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'"
            Set Reg9 = GetQuery(Sql9)
            If Reg9.EOF And Reg9.BOF Then
                liDatos = 0
            Else
                liDatos = Reg9!NumCred
            End If
            Reg9.Close
            Set Reg9 = Nothing
            
            If liDatos > 0 Then  ' De la Moneda
                lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                liLineas = 6
                If lbSiCambio Then
                    lbSiCambio = False
                End If
                lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                lsRtfImp = lsRtfImp & " * MONEDA             : " & lsDescM & Chr(27) & Chr(70) & Chr(10)
                liLineas = liLineas + 2
                
                '========= CREDITOS VIGENTES PARA PRODUCTO  =========
                 For i = 0 To 4  'Para Cada Producto
                   Select Case i
                      Case 0
                         lsDescPr = " Comercial   "
                      Case 1
                         lsDescPr = " Mes         "
                      Case 2
                         lsDescPr = " Consumo     "
                      Case 3
                         lsDescPr = " Prendario   "
                      Case 4
                         lsDescPr = " Hipotecario "
                      'Case 5
                         'lsDescPr = " Agricola    "

                   End Select
                   
                   '=========== CREDITOS DEL PRODUCTO =============
                     Sql9 = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                         " where nPrdEstado in " & lsCreditosVigentesyJudi & " " & _
                         " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                         " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                      
                     If Trim(RsM!nConsValor) = "1" Then  ' Si es RR PP
                        SQL9B = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                             " WHERE nPrdEstado IN " & lsPignoraticio & _
                             " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                             " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                     Else
                        SQL9B = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                "WHERE nPrdEstado = 9999 "
                     End If
                     ' Judicial
                     SQL9C = "SELECT COUNT(cCtaCod) AS NumCred " & _
                            " From " & psServConsol & "CreditoConsol " & _
                            " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud & _
                            " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                            " AND substring(cCtaCod,6,3) in (" & prod(i) & ")"
                     
                     lnTCredProd = 0:   lnTSaldoCapProd = 0
                     lnTNumVigProd = 0: lnTCapVigProd = 0
                     lnTNumVen1Prod = 0: lnTCapVen1Prod = 0
                     lnTNumVen2Prod = 0: lnTCapVen2Prod = 0
                     lnTNumJudSDemProd = 0: lnTCapJudSDemProd = 0
                     lnTNumJudCDemProd = 0: lnTCapJudCDemProd = 0
                     
                     If HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then  ' Para Producto
                     
                        lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                        lsRtfImp = lsRtfImp & " ** PRODUCTO          : " & lsDescPr & Chr(27) & Chr(70) & Chr(10)
                        liLineas = liLineas + 3
                        '======= Para Cada Agencia  =========
                        rsAg.MoveFirst
                        Do While Not rsAg.EOF
                                 
                           Sql9 = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                  " where nPrdEstado in " & lsCreditosVigentesyJudi & " " & _
                                  " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                  " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                  " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
                    
                               SQL9B = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                       "WHERE nPrdEstado IN " & lsPignoraticio & _
                                       " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                       " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"

                            SQL9C = "SELECT Count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol "
                            SQL9C = SQL9C & "WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud
                            SQL9C = SQL9C & " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'"
                            SQL9C = SQL9C & " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                            SQL9C = SQL9C & " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
                            
                              lnTCredAG = 0:   lnTSaldoCapAG = 0
                              lnTNumVigAG = 0: lnTCapVigAG = 0
                              lnTNumVen1AG = 0: lnTCapVen1AG = 0
                              lnTNumVen2AG = 0: lnTCapVen2AG = 0
                              lnTNumJudSDemAG = 0: lnTCapJudSDemAG = 0
                              lnTNumJudCDemAG = 0: lnTCapJudCDemAG = 0
                             '
                             If HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then     ' De la Agencia

                                 lsDescAG = rsAg!cAgeDescripcion
                                 lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                 lsRtfImp = lsRtfImp & " *** AGENCIA          : " & lsDescAG & Chr(27) & Chr(70) & Chr(10)
                                  liLineas = liLineas + 2
                                 
                                
                                 '========= CREDITOS VIGENTES PARA SUB PRODUCTOS  =========
                                 ' Producto , SubPrducto
                                 Select Case i
                                    Case 0, 1: NumSubProd = 1
                                    Case 2: NumSubProd = 4
                                    Case 3, 4, 5: NumSubProd = 0
                                 End Select
                                 
                                 For J = 0 To NumSubProd  'Para Cada SubProductos
                                   
                                    lnTCredSubPr = 0:    lnTSaldoCapSubPr = 0
                                    lnTNumVigSubPr = 0:  lnTCapVigSubPr = 0
                                    lnTNumVen1SubPr = 0: lnTCapVen1SubPr = 0
                                    lnTNumVen2SubPr = 0: lnTCapVen2SubPr = 0
                                    lnTNumJudSDemSubPr = 0:  lnTCapJudSDemSubPr = 0
                                    lnTNumJudCDemSubPr = 0:  lnTCapJudCDemSubPr = 0
                                    Select Case i
                                      Case 0
                                         Select Case J
                                         Case 0: lsDescSubPr = " Comercial Empresar  "
                                         Case 1: lsDescSubPr = " Comercial Agropec   "
                                         End Select
                                      Case 1
                                         Case 0: lsDescSubPr = " PYME Empresar "
                                         Case 1: lsDescSubPr = " PYME Agropec  "
                                         
                                      Case 2
                                         Select Case J
                                            Case 0: lsDescSubPr = " Consumo Dscto Planilla  "
                                            Case 1: lsDescSubPr = " Consumo Gar. Plazo Fijo "
                                            Case 2: lsDescSubPr = " Consumo Gar. CTS        "
                                            Case 3: lsDescSubPr = " Consumo Usos Diversos   "
                                            Case 4: lsDescSubPr = " Consumo Administrativos "
                                         End Select
                                      Case 3
                                                lsDescSubPr = " Prendario    "
                                      Case 4
                                         lsDescSubPr = " Hipotecario "
                                      'Case 5
                                      '   lsDescSubPr = " Agricola    "
                                         
                                    End Select

                                   '=========== CREDITOS DEL SUB PRODUCTO =============
                                    Sql9 = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                        " where nPrdEstado in " & lsCreditosVigentesyJudi & " " & _
                                        " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                        " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")"
                                     
                                    If Trim(RsM!nConsValor) = "1" And i = 3 Then ' Si es RR PP
                                       SQL9B = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                            " WHERE nPrdEstado IN " & lsPignoraticio & _
                                            " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                            " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                            " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                            " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")"
                                    Else
                                       SQL9B = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                               "WHERE nPrdEstado = 9999 "
                                    End If
                                    ' Judicial
                                    SQL9C = "SELECT COUNT(cCtaCod) AS NumCred " & _
                                           " From " & psServConsol & "CreditoConsol " & _
                                           " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud & _
                                           " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                           " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                           " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                           " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")"
                                    
                                    '******* Administrativos
                                    If HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then  ' Para Sub Productos
                                        lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                        lsRtfImp = lsRtfImp & " **** SUB PRODUCTO    : " & lsDescSubPr & Chr(27) & Chr(70) & Chr(10)
                                        liLineas = liLineas + 2
                                        
                                       '========= CREDITOS VIGENTES PARA FUENTES FINANCIAMIENTO =========
                                        If rsFF.EOF And rsFF.BOF Then 'Fuente Financ
                                        Else
                                            rsFF.MoveFirst
                                            Do While Not rsFF.EOF 'Fuente Financ
                                               '=========== CREDITOS VIGENTES PARA UNA FUENTE FINANCIAMIENTO =============
                                               Sql9 = " SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                                      " WHERE nPrdEstado in " & lsCreditosVigentesyJudi & " " & _
                                                      " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                      " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                      " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                      " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                      " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')"
                                               SQL9B = "SELECT Count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                                        "WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud & _
                                                        " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                        " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                        " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')"
                        
                                               If i = 3 And Trim(RsM!nConsValor) = "1" And Trim(rsFF!cLineaCred) = "0101" Then   ' Si es RR PP
                                                   SQL9C = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                                        " WHERE nPrdEstado IN " & lsPignoraticio & _
                                                        " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                        " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")"
                                               Else
                                                   SQL9C = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                                           "WHERE nPrdEstado = 9999 "
                                               End If
                                               
                                                lnTCredF = 0: lnTSaldoCapF = 0
                                                lnTNumVigF = 0: lnTCapVigF = 0
                                                lnTNumVen1F = 0: lnTCapVen1F = 0
                                                lnTNumVen2F = 0: lnTCapVen2F = 0
                                                lnTNumJudSDemF = 0: lnTCapJudSDemF = 0
                                                lnTNumJudCDemF = 0: lnTCapJudCDemF = 0
                                               '
                                               If HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then       ' De la Fuente Financ
                            
                                                    lsDescF = Trim(rsFF!CDescripcion)
                                                    lsRtfImp = lsRtfImp & Chr(10) & Chr(27) & Chr(69)
                                                    lsRtfImp = lsRtfImp & " ***** F. FINANCIAMIENTO   : " & lsDescF & Chr(27) & Chr(70) & Chr(10)
                                                    liLineas = liLineas + 2
                                                    
                                                    lsDescF = Mid(rsFF!CDescripcion, 1, 25)

                                                    '======= Para Cada PLAZO  =========
                                                    If rsPL.EOF And rsPL.BOF Then ' Plazo
                                                    Else
                                                        rsPL.MoveFirst
                                                        Do While Not rsPL.EOF ' Plazo
                                                           lnTCredPL = 0: lnTSaldoCapPL = 0
                                                           lnTNumVigPL = 0: lnTCapVigPL = 0
                                                           lnTNumVen1PL = 0: lnTCapVen1PL = 0
                                                           lnTNumVen2PL = 0: lnTCapVen2PL = 0
                                                           lnTNumJudSDemPL = 0: lnTCapJudSDemPL = 0
                                                           lnTNumJudCDemPL = 0: lnTCapJudCDemPL = 0
                                                           lsDescPL = Mid(rsPL!cConsDescripcion, 1, 25)
                                                           
                                                           '=========== CREDITOS PARA EL PLAZO =============

                                                           Sql9 = "SELECT Count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                                                  " where nPrdEstado in " & lsCreditosVigentesyJudi & " " & _
                                                                  " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                  " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                  " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                  " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                  " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                  " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!nConsValor) & "')"
                                                                  
                                                            If i = 3 And Trim(rsFF!cLineaCred) = "0101" And Trim(rsPL!nConsValor) = "1" Then  ' prendario
                                                            SQL9B = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                                                       "WHERE nPrdEstado IN " & lsPignoraticio & _
                                                                       " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                       " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                       " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'"
                                                            Else
                                                               SQL9B = "SELECT count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol "
                                                               SQL9B = SQL9B & "WHERE nPrdEstado = 9999 "
                                                            End If
                                                            SQL9C = "SELECT Count(cCtaCod) as NumCred From " & psServConsol & "CreditoConsol " & _
                                                                    "WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud & _
                                                                    " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                    " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                    " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                    " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                    " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                    " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!nConsValor) & "')"

                                                            '*******
                                                            If HayDatos(Sql9) + HayDatos(SQL9B) + HayDatos(SQL9C) > 0 Then     ' Del PLAZO
                                                               For NorRef = 0 To 1
                                                                    
                                                                lnTCredPr = 0: lnTSaldoCapPr = 0
                                                                lnTNumVigPr = 0: lnTCapVigPr = 0
                                                                lnTNumVen1Pr = 0: lnTCapVen1Pr = 0
                                                                lnTNumVen2Pr = 0: lnTCapVen2Pr = 0
                                                                lnTNumJudSDemPr = 0: lnTCapJudSDemPr = 0
                                                                lnTNumJudCDemPr = 0: lnTCapJudCDemPr = 0
                                                                lnTCapVenNJud = 0: lnTCapVenSJud = 0
                                                                lsDescPr = ""
                                                               
                                                                   '=================================================
                                                                   '===== Total Cartera  Producto de Agencia  ======
                                                                   '  Creditos ------------
                                                                   Sql9 = "SELECT COUNT(cCtaCod) AS Numero, SUM(" & psConcepto & ") AS Capital " & _
                                                                          " From " & psServConsol & "CreditoConsol " & _
                                                                          " WHERE nPrdEstado in " & lsCreditosVigentesyJudi & " " & _
                                                                          " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                          " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                          " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                          " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                          " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                          " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!nConsValor) & "')" & _
                                                                          " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'"
                                                                          
                                                                   Set Reg9 = GetQuery(Sql9)
                                                                   lnTCredPr = Reg9!Numero
                                                                   lnTSaldoCapPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                   Reg9.Close
                                                                   Set Reg9 = Nothing
                                                                   
                                                                   ' Pignoraticio  ------------
                                                                   If Trim(rsFF!cLineaCred) = "0101" And Trim(RsM!nConsValor) = "1" And Trim(rsPL!nConsValor) = "1" And i = 3 And NorRef = 0 Then ' Si es RR PP
                                                                      Sql9 = "SELECT count(cCtaCod) as Numero, Sum(" & psConcepto & ") AS Capital " & _
                                                                          " From " & psServConsol & "CreditoConsol WHERE nPrdEstado IN " & lsPignoraticio & _
                                                                          " AND substring(cCtaCod,9,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                          " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                          " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")"
                                                                      
                                                                      Set Reg9 = GetQuery(Sql9)
                                                                      lnTCredPr = lnTCredPr + Reg9!Numero
                                                                      lnTSaldoCapPr = lnTSaldoCapPr + IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                      Reg9.Close
                                                                      Set Reg9 = Nothing
                                                                   End If
                                                                   
                                                                   ' Judicial -------------
                                                                        Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                          " SUM(" & lsConceptoJud & ") AS Capital " & _
                                                                          " From " & psServConsol & "CreditoConsol " & _
                                                                          " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND " & lsCondJud & _
                                                                          " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                          " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                          " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                          " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                          " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                          " AND substring(cLineaCred,6,1) IN ('" & Trim(rsPL!nConsValor) & "')" & _
                                                                          " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'"
                                                                       
                                                                        Set Reg9 = GetQuery(Sql9)
                                                                        lnTCredPr = lnTCredPr + Reg9!Numero
                                                                        lnTSaldoCapPr = lnTSaldoCapPr + IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                        Reg9.Close
                                                                        Set Reg9 = Nothing
                                                                   
                                                                   '=================================================
                                                                   '====== Cartera Vigente  Producto de Agencia  ===
                                                                   Select Case i
                                                                   
                                                                       Case 0  ' Comercial  ******************
                                                                         If pPlanCuentas = "1" Then
                                                                            lnRangoIni = -9999   ' Comerciales
                                                                            lnRangoFin = 15
                                                                         Else
                                                                            lnRangoIni = -9999   ' Comerciales
                                                                            lnRangoFin = 15
                                                                         End If
                            
                                                                         Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                               " SUM(" & psConcepto & ") AS Capital " & _
                                                                               " From " & psServConsol & "CreditoConsol " & _
                                                                               " WHERE nPrdEstado in " & lsCreditosVigentes & " " & _
                                                                               " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                               " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                               " AND substring(cLineaCred,6,1) IN ('" & Trim(rsPL!nConsValor) & "')" & _
                                                                               " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                               " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                               " And ndiasAtraso <= " & Val(lnRangoFin)
                                                                         Set Reg9 = GetQuery(Sql9)
                                                                         lnTNumVigPr = Reg9!Numero
                                                                         lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                         Reg9.Close
                                                                         Set Reg9 = Nothing
                                                                         
                                                                         '********
                                                                       Case 1, 5 ' Mes - Agricola
                                                                         If pPlanCuentas = "1" Then
                                                                             lnRangoIni = -9999
                                                                             lnRangoFin = 30
                                                                         Else
                                                                             lnRangoIni = -9999
                                                                             lnRangoFin = 30
                                                                         End If
                                                                         Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                               " SUM(" & psConcepto & ") AS Capital " & _
                                                                               " From " & psServConsol & "CreditoConsol " & _
                                                                               " WHERE nPrdEstado in " & lsCreditosVigentes & " " & _
                                                                               " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                               " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                               " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!nConsValor) & "')" & _
                                                                               " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                               " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                               " And ndiasAtraso <= " & Val(lnRangoFin)
                                                                         Set Reg9 = GetQuery(Sql9)
                                                                         lnTNumVigPr = Reg9!Numero
                                                                         lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                         Reg9.Close
                                                                         Set Reg9 = Nothing
                                                                               
                                                                      
                                                                       Case 2, 4 ' Consumo Hipotecario
                                                                         If pPlanCuentas = "1" Then
                                                                             lnRangoIni = -9999
                                                                             lnRangoFin = 90
                                                                         Else
                                                                             lnRangoIni = -9999
                                                                             lnRangoFin = 30
                                                                         End If
                                                                         Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                               " SUM(" & psConcepto & ") AS Capital " & _
                                                                               " From " & psServConsol & "CreditoConsol " & _
                                                                               " WHERE nPrdEstado in " & lsCreditosVigentes & " " & _
                                                                               " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                               " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                               " AND substring(cLineaCred, 6,1) IN ('" & Trim(rsPL!nConsValor) & "')" & _
                                                                               " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                               " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                               " And ndiasAtraso <= " & Val(lnRangoFin)
                                                                         Set Reg9 = GetQuery(Sql9)
                                                                         lnTNumVigPr = Reg9!Numero
                                                                         lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                         Reg9.Close
                                                                         Set Reg9 = Nothing
                                                                      
                                                                      Case 3  ' Prendario  *************************
                                                                         If Trim(rsFF!cLineaCred) = "0101" And Trim(RsM!nConsValor) = "1" And Trim(rsPL!nConsValor) = "1" And NorRef = 0 Then   ' Si es RR PP / Corto Plazo / Normal
                                                                            lnRangoIni = -999
                                                                            lnRangoFin = 30
                                                                            Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                                " SUM(" & psConcepto & ") AS Capital " & _
                                                                               " From " & psServConsol & "CreditoConsol " & _
                                                                               " WHERE nPrdEstado in " & lsPignoraticio & _
                                                                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                               " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                               " And ndiasAtraso <= " & Val(lnRangoFin)
                                                                             Set Reg9 = GetQuery(Sql9)
                                                                             lnTNumVigPr = Reg9!Numero
                                                                             lnTCapVigPr = IIf(IsNull(Reg9!Capital), 0, Reg9!Capital)
                                                                             Reg9.Close
                                                                             Set Reg9 = Nothing
                                                                         End If

                                                                       Case Else
                                                                           lnTNumVigPr = 0
                                                                           lnTCapVigPr = 0
                                                                       
                                                                   End Select
                                                                   '=================================================
                                                                   '====== Cartera Vencida 1 Producto de Agencia  ===
                                                                   Select Case i
                                                                       Case 0  ' Comerciales  ******************
                                                                         If pPlanCuentas = "1" Then
                                                                             lnRangoIni = 16   ' Comerciales
                                                                             lnRangoFin = 120
                                                                         Else
                                                                             lnRangoIni = 16   ' Comerciales
                                                                             lnRangoFin = 9999
                                                                         End If
                                                                         
                                                                       Sql9 = " SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                        " ISNULL(SUM(" & IIf(psConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital, " & _
                                                                        IIf(psConcepto = "C", "ISNULL(SUM(nCapVencido),0)", "0") & " AS CapVencido " & _
                                                                        " FROM " & psServConsol & "CreditoConsol C " & _
                                                                        " WHERE nPrDEstado in (" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc & " ) " & _
                                                                        " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                        " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                        " AND substring(cLineaCred,1,4) IN ('" & rsFF!cLineaCred & "')" & _
                                                                        " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                        " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                        " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                        " And ndiasatraso <= " & Val(lnRangoFin)
                                                                        Set Reg9 = GetQuery(Sql9)
                                                                         lnTNumVen1Pr = Reg9!Numero
                                                                         lnTCapVen1Pr = Reg9!Capital
                                                                         lnTCapVenNJud = Reg9!Capital
                                                                         Reg9.Close
                                                                         Set Reg9 = Nothing
                                                                         
                                                                       Case 1, 5   ' Mes Pyme - Agricola  ******************
                                                                         If pPlanCuentas = "1" Then
                                                                             lnRangoIni = 31   ' Mes Caja Pyme
                                                                             lnRangoFin = 120
                                                                         Else
                                                                             lnRangoIni = 31   ' Mes Caja Pyme
                                                                             lnRangoFin = 9999
                                                                         End If
                                                                        Sql9 = " SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                        " ISNULL(SUM(" & IIf(psConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital, " & _
                                                                        IIf(psConcepto = "C", "ISNULL(SUM(nCapVencido),0)", "0") & " AS CapVencido " & _
                                                                        " FROM " & psServConsol & "CreditoConsol C " & _
                                                                        " WHERE nPrDEstado in (" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc & " ) " & _
                                                                        " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                        " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                        " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                        " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                        " AND substring(cLineaCred,1,4) IN ('" & rsFF!cLineaCred & "')" & _
                                                                        " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                        " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                        " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                        " And ndiasatraso <= " & Val(lnRangoFin)
                                                                        Set Reg9 = GetQuery(Sql9)
                                                                         lnTNumVen1Pr = Reg9!Numero
                                                                         lnTCapVen1Pr = Reg9!Capital
                                                                         lnTCapVenNJud = Reg9!Capital
                                                                         Reg9.Close
                                                                         Set Reg9 = Nothing
                                                                      
                                                                      Case 2, 4 ' Consumo  / Hipotecario **********
                                                                         If pPlanCuentas = "1" Then
                                                                             lnRangoIni = 91   ' Capital Vencido OJO
                                                                             lnRangoFin = 120
                                                                         Else
                                                                             lnRangoIni = 31   ' Capital Vencido OJO
                                                                             lnRangoFin = 90
                                                                         End If
                                                                         If lsConcepto = "I" Then
                                                                         
                                                                            Sql9 = " SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                            " ISNULL(SUM(" & IIf(psConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital, " & _
                                                                            IIf(psConcepto = "C", "ISNULL(SUM(nCapVencido),0)", "0") & " AS CapVencido " & _
                                                                            " FROM " & psServConsol & "CreditoConsol C " & _
                                                                            " WHERE nPrDEstado in (" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc & " ) " & _
                                                                            " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                            " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                            " AND substring(cLineaCred,1,4) IN ('" & rsFF!cLineaCred & "')" & _
                                                                            " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                            " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                            " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                            " And ndiasatraso <= " & Val(lnRangoFin)
                                                                            Set Reg9 = GetQuery(Sql9)
                                                                            lnTNumVen1Pr = Reg9!Numero
                                                                            lnTCapVen1Pr = Reg9!Capital
                                                                            lnTCapVenNJud = Reg9!Capital
                                                                            Reg9.Close
                                                                            Set Reg9 = Nothing
                                                                         Else
                                                                            Set Reg9 = GetDatosReclasifica(psServConsol, lsConcepto, RsM!nConsValor, prod(i), SubProd(i, J), rsAg!cAgeCod, rsFF!cLineaCred, rsPL!nConsValor, NorRef, lnRangoIni, lnRangoFin)
                                                                            lnTNumVen1Pr = Reg9!Numero
                                                                            lnTCapVen1Pr = Reg9!CapVencido
                                                                            lnTCapVigPr = lnTCapVigPr + Reg9!Capital - Reg9!CapVencido
                                                                            lnTCapVenNJud = Reg9!CapVencido
                                                                            
                                                                            Set Reg9 = GetDatosReclasifica(psServConsol, lsConcepto, RsM!nConsValor, prod(i), SubProd(i, J), rsAg!cAgeCod, rsFF!cLineaCred, rsPL!nConsValor, NorRef, lnRangoIni, lnRangoFin, True)
                                                                            lnTNumVen1Pr = lnTNumVen1Pr + Reg9!Numero
                                                                            lnTCapVen1Pr = lnTCapVen1Pr + Reg9!CapVencido
                                                                            lnTCapVigPr = lnTCapVigPr + Reg9!Capital - Reg9!CapVencido
                                                                            lnTCapVenSJud = Reg9!CapVencido
                                                                            Reg9.Close
                                                                            Set Reg9 = Nothing
                                                                            
                                                                           If pPlanCuentas = "1" Then
                                                                              lnRangoIni = 91  ' Capital Vencido OJO
                                                                              lnRangoFin = 120
                                                                              Set Reg9 = GetDatosReclasifica(psServConsol, lsConcepto, RsM!nConsValor, prod(i), SubProd(i, J), rsAg!cAgeCod, rsFF!cLineaCred, rsPL!nConsValor, NorRef, lnRangoIni, lnRangoFin)
                                                                        
                                                                              lnTNumVen1Pr = lnTNumVen1Pr + Reg9!Numero
                                                                              lnTCapVen1Pr = lnTCapVen1Pr + Reg9!Capital
                                                                              lnTCapVenNJud = lnTCapVenNJud + Reg9!Capital
                                                                            
                                                                              Set Reg9 = GetDatosReclasifica(psServConsol, lsConcepto, RsM!nConsValor, prod(i), SubProd(i, J), rsAg!cAgeCod, rsFF!cLineaCred, rsPL!nConsValor, NorRef, lnRangoIni, lnRangoFin, True)
                                                                              lnTNumVen1Pr = lnTNumVen1Pr + Reg9!Numero
                                                                              lnTCapVen1Pr = lnTCapVen1Pr + Reg9!Capital
                                                                              lnTCapVenSJud = lnTCapVenSJud + Reg9!Capital
                                                                              Reg9.Close
                                                                              Set Reg9 = Nothing
                                                                           End If
                                                                        End If
                                                                               
                                                                      Case 3  ' Prendario  *************************
                                                                          If Trim(rsFF!cLineaCred) = "0101" And Trim(RsM!nConsValor) = "1" And Trim(rsPL!nConsValor) = "1" And i = 3 And NorRef = 0 Then   ' Si es RR PP
                                                                            lnRangoIni = 31
                                                                            lnRangoFin = 999
                                                                            Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                                " ISNULL(SUM(" & psConcepto & "),0) AS Capital " & _
                                                                               " From " & psServConsol & "CreditoConsol " & _
                                                                               " WHERE nPrdEstado in " & lsPignoraticio & _
                                                                               " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                               " AND substring(cCtaCod,6,3) in ('305')" & _
                                                                               " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                               " And ndiasAtraso <= " & Val(lnRangoFin)
                                                                               
                                                                             Set Reg9 = GetQuery(Sql9)
                                                                             lnTNumVen1Pr = Reg9!Numero
                                                                             lnTCapVen1Pr = Reg9!Capital
                                                                             lnTCapVenNJud = Reg9!Capital
                                                                             lnTCapVenSJud = 0
                                                                             Reg9.Close
                                                                             Set Reg9 = Nothing
                                                                         End If
                                                                       
                                                                      Case Else
                                                                         lnTNumVen1Pr = 0
                                                                         lnTCapVen1Pr = 0
                                                                         lnTCapVenSJud = 0
                                                                         lnTCapVenNJud = 0
                                                                   End Select
                                                                   '=================================================
                                                                   '====== Cartera Vencida 2 Producto de Agencia  ===
                                                                   Select Case i
                                                                       Case 0, 1, 2, 4, 5  ' comercial / Mes / Consumo / Hipotecario
                                                                         If pPlanCuentas = "1" Then  'Solo Plan Actual
                                                                            lnRangoIni = 121   ' Comerciales
                                                                            lnRangoFin = 999
                                                                            
                                                                            Sql9 = " SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                            " ISNULL(SUM(" & IIf(psConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital, " & _
                                                                            IIf(psConcepto = "C", "ISNULL(SUM(nCapVencido),0)", "0") & " AS CapVencido " & _
                                                                            " FROM " & psServConsol & "CreditoConsol C " & _
                                                                            " WHERE nPrDEstado in (" & gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc & " ) " & _
                                                                            " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                            " AND substring(cCtaCod,4,2) = '" & rsAg!cAgeCod & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                            " AND substring(cLineaCred,1,4) IN ('" & rsFF!cLineaCred & "')" & _
                                                                            " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                            " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'" & _
                                                                            " And ndiasAtraso >= " & Val(lnRangoIni) & _
                                                                            " And ndiasatraso <= " & Val(lnRangoFin)
                                                                            Set Reg9 = GetQuery(Sql9)
                                                                            lnTNumVen2Pr = Reg9!Numero
                                                                            lnTCapVen2Pr = Reg9!Capital
                                                                            lnTCapVenNJud = lnTCapVenNJud + Reg9!Capital
                                                                            Reg9.Close
                                                                            Set Reg9 = Nothing
                                                                         End If
                                                                       
                                                                      
                                                                      Case Else
                                                                          lnTNumVen2Pr = 0
                                                                          lnTCapVen2Pr = 0
                                                                           
                                                                   End Select
                                                                   
                                                                   '=========================================================
                                                                   '====== En Asesoria Legal Producto de Agencia          ===
                                                                   '====== Sin Demanda Judicial//Administrado por Agencia ===
                                                                   Select Case i
                                                                       Case 0, 1, 2, 4, 5   '  ********
                                                                            Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                            " ISNULL(SUM(" & IIf(psConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital " & _
                                                                            " FROM " & psServConsol & "CreditoConsol " & _
                                                                            " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND nSaldoCap > 0 AND  " & lsCondJud & _
                                                                            " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                            " AND substring(cCtaCod,4,2) = '" & Trim(rsAg!cAgeCod) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                            " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                            " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                            " AND nDemanda = 1 " & _
                                                                            " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'"
                                                                            Set Reg9 = GetQuery(Sql9)
                                                                            lnTNumJudSDemPr = Reg9!Numero
                                                                            lnTCapJudSDemPr = Reg9!Capital
                                                                            Reg9.Close
                                                                            Set Reg9 = Nothing
                                                                         
                                                                      Case Else
                                                                          lnTNumJudSDemPr = 0
                                                                          lnTCapJudSDemPr = 0
                                                                   End Select
                                                                   
                                                                   '=========================================================
                                                                   '====== En Asesoria Legal Producto de Agencia          ===
                                                                   '====== Con Demanda Judicial//Administrado por Recuper ===
                                                                   Select Case i
                                                                       Case 0, 1, 2, 4, 5    '*************
                                                                            Sql9 = "SELECT COUNT(cCtaCod) AS Numero, " & _
                                                                            " ISNULL(SUM(" & IIf(psConcepto = "C", "nSaldoCap", "nIntDev") & "),0) AS Capital " & _
                                                                            " FROM " & psServConsol & "CreditoConsol " & _
                                                                            " WHERE nPrdEstado =" & gColocEstRecVigJud & " AND nSaldoCap > 0 AND  " & lsCondJud & _
                                                                            " AND substring(cLineaCred,5,1 )= '" & Trim(RsM!nConsValor) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & prod(i) & ")" & _
                                                                            " AND substring(cCtaCod,4,2) = '" & Trim(rsAg!cAgeCod) & "'" & _
                                                                            " AND substring(cCtaCod,6,3) in ( " & SubProd(i, J) & ")" & _
                                                                            " AND substring(cLineaCred,1,4) IN ('" & Trim(rsFF!cLineaCred) & "')" & _
                                                                            " AND substring(cLineaCred, 6,1) IN ('" & rsPL!nConsValor & "')" & _
                                                                            " AND nDemanda = 2 " & _
                                                                            " AND cRefinan = '" & IIf(NorRef = 0, "N", "R") & "'"
                                                                            Set Reg9 = GetQuery(Sql9)
                                                                            lnTNumJudCDemPr = Reg9!Numero
                                                                            lnTCapJudCDemPr = Reg9!Capital
                                                                            Reg9.Close
                                                                            Set Reg9 = Nothing
                                                                      Case Else
                                                                          lnTNumJudCDemPr = 0
                                                                          lnTCapJudCDemPr = 0
                                                                   End Select
                                                                   
                                                                   ' ***************************************
                                                                   ' ***** Asigna Valores a la Agencia ******
                                                                   lnTCredPL = lnTCredPL + lnTCredPr
                                                                   lnTSaldoCapPL = lnTSaldoCapPL + lnTSaldoCapPr
                                                                   lnTNumVigPL = lnTNumVigPL + lnTNumVigPr
                                                                   lnTCapVigPL = lnTCapVigPL + lnTCapVigPr
                                                                   lnTNumVen1PL = lnTNumVen1PL + lnTNumVen1Pr
                                                                   lnTCapVen1PL = lnTCapVen1PL + lnTCapVen1Pr
                                                                   lnTNumVen2PL = lnTNumVen2PL + lnTNumVen2Pr
                                                                   lnTCapVen2PL = lnTCapVen2PL + lnTCapVen2Pr
                                                                   lnTNumJudSDemPL = lnTNumJudSDemPL + lnTNumJudSDemPr
                                                                   lnTCapJudSDemPL = lnTCapJudSDemPL + lnTCapJudSDemPr
                                                                   lnTNumJudCDemPL = lnTNumJudCDemPL + lnTNumJudCDemPr
                                                                   lnTCapJudCDemPL = lnTCapJudCDemPL + lnTCapJudCDemPr
                                                                   
                                                                   ' *****  Imprime
                                                                   lsRtfImp = lsRtfImp & IIf(Trim(rsPL!nConsValor) = "1", " CP-", " LP-")
                                                                   lsRtfImp = lsRtfImp & IIf(NorRef = 0, "NORMAL     ", "REFINANC   ")
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPr, 5, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigPr, 8, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1Pr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1Pr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2Pr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2Pr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemPr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemPr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemPr, 7, 0, True)
                                                                   lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemPr, 12, 2, True) & " | "
                                                                   lsRtfImp = lsRtfImp & Chr(10)
                                                                   liLineas = liLineas + 1
                                                                   
                                                                   '************* Para Grabar en Tabla  (Simon)  **************
                                                                   'Vigentes
                                                                   If lnTCapVigPr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(FechaCierre, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '1','" & IIf(NorRef = 0, "N", "R") & "','N'," & _
                                                                          SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Left(rsFF!cCtaCont, 2) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapVigPr & ")"
                                                                          
                                                                     Conecta.AbreConexion
                                                                     Conecta.Ejecutar (Sql9)
                                                                     Conecta.CierraConexion
                                                                   End If
                                                                   
                                                                   'Vencidas Adm por Age
                                                                   If lnTCapVen1Pr + lnTCapVen2Pr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(FechaCierre, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '5','" & IIf(NorRef = 0, "N", "R") & "','N'," & _
                                                                          SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Left(rsFF!cCtaCont, 2) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapVen1Pr + lnTCapVen2Pr & ")"
                                                                     Conecta.AbreConexion
                                                                     Conecta.Ejecutar (Sql9)
                                                                     Conecta.CierraConexion
                                                                   End If
                                                                   
                                                                   'Judicial - Administ por Agencia
                                                                   If lnTCapJudSDemPr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(FechaCierre, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '5','" & IIf(NorRef = 0, "N", "R") & "','S'," & _
                                                                          SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Left(rsFF!cCtaCont, 2) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapJudSDemPr & ")"
                                                                     Conecta.AbreConexion
                                                                     Conecta.Ejecutar (Sql9)
                                                                     Conecta.CierraConexion
                                                                   End If
                                                                   
                                                                   'Judicial - Administ por Recup
                                                                   If lnTCapJudCDemPr <> 0 Then
                                                                     Sql9 = "INSERT " & psServConsol & "CredSaldosCont (cConcepto, dFecha, cMoneda, cEstado, cRefinanc, cDemandado, cProdCod, cPlazo, cFuenteFinanc, cAgeCod, nSaldo) " _
                                                                          & " VALUES ('" & lsConcepto & "','" & Format(FechaCierre, "mm/dd/yyyy") & "', '" & Trim(RsM!nConsValor) & "', '6','" & IIf(NorRef = 0, "N", "R") & "','S'," & _
                                                                          SubProd(i, J) & ",'" & Trim(rsPL!nConsValor) & "','" & Left(rsFF!cCtaCont, 2) & "','" & Trim(Right(rsAg!cAgeCod, 2)) & "'," & lnTCapJudCDemPr & ")"
                                                                     Conecta.AbreConexion
                                                                     Conecta.Ejecutar (Sql9)
                                                                     Conecta.CierraConexion
                                                                   End If
                                                                   '=================================================
                                                               Next NorRef
                                                               'End If  ' Fin de Si encuentra Datos
                                                               ' ***************************************
                                                               ' ***** Asigna Valores a F.Financia******
                                                               lnTCredF = lnTCredF + lnTCredPL
                                                               lnTSaldoCapF = lnTSaldoCapF + lnTSaldoCapPL
                                                               lnTNumVigF = lnTNumVigF + lnTNumVigPL
                                                               lnTCapVigF = lnTCapVigF + lnTCapVigPL
                                                               lnTNumVen1F = lnTNumVen1F + lnTNumVen1PL
                                                               lnTCapVen1F = lnTCapVen1F + lnTCapVen1PL
                                                               lnTNumVen2F = lnTNumVen2F + lnTNumVen2PL
                                                               lnTCapVen2F = lnTCapVen2F + lnTCapVen2PL
                                                               lnTNumJudSDemF = lnTNumJudSDemF + lnTNumJudSDemPL
                                                               lnTCapJudSDemF = lnTCapJudSDemF + lnTCapJudSDemPL
                                                               lnTNumJudCDemF = lnTNumJudCDemF + lnTNumJudCDemPL
                                                               lnTCapJudCDemF = lnTCapJudCDemF + lnTCapJudCDemPL
                                                               ' *****  Imprime
                                                               lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                                                               lsRtfImp = lsRtfImp & " TOT. PLAZO    " ' & lsDescPr
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCredPL, 5, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapPL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigPL, 8, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigPL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1PL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1PL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2PL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2PL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemPL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemPL, 12, 2, True) & " | "
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemPL, 7, 0, True)
                                                               lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemPL, 12, 2, True) & " | "
                                                               'If lnTSaldoCapPL <> 0 And lsConcepto = "C" Then
                                                               '   lsRTfimp = lsRTfimp & ImpreFormat(Round(((lnTSaldoCapPL - lnTCapVigPL) / lnTSaldoCapPL) * 100, 2), 3, 2) & "%"
                                                               'End If
                                                               lsRtfImp = lsRtfImp & Chr(10)
                                                               liLineas = liLineas + 2
                                                               
                                                               ' ****************************
                                                               ' ****  Verifica Si Cambio pagina
                                                               If liLineas >= 54 Then 'Para el control de salto de página
                                                                  lsRtfImp = lsRtfImp & Chr(12)
                                                                  cpag = cpag + 1
                                                                  lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                                                  liLineas = 6
                                                               End If
                                                           
                                                           End If   ' Si encuentra Datos en Plazo
                                                           rsPL.MoveNext
                                                        Loop   ' Plazo
                                                    End If   ' Plazo
                                                    
                                                    ' ***************************************
                                                    ' ***** Asigna Valores a Sub Producto ******
                                                    lnTCredSubPr = lnTCredSubPr + lnTCredF
                                                    lnTSaldoCapSubPr = lnTSaldoCapSubPr + lnTSaldoCapF
                                                    lnTNumVigSubPr = lnTNumVigSubPr + lnTNumVigF
                                                    lnTCapVigSubPr = lnTCapVigSubPr + lnTCapVigF
                                                    lnTNumVen1SubPr = lnTNumVen1SubPr + lnTNumVen1F
                                                    lnTCapVen1SubPr = lnTCapVen1SubPr + lnTCapVen1F
                                                    lnTNumVen2SubPr = lnTNumVen2SubPr + lnTNumVen2F
                                                    lnTCapVen2SubPr = lnTCapVen2SubPr + lnTCapVen2F
                                                    lnTNumJudSDemSubPr = lnTNumJudSDemSubPr + lnTNumJudSDemF
                                                    lnTCapJudSDemSubPr = lnTCapJudSDemSubPr + lnTCapJudSDemF
                                                    lnTNumJudCDemSubPr = lnTNumJudCDemSubPr + lnTNumJudCDemF
                                                    lnTCapJudCDemSubPr = lnTCapJudCDemSubPr + lnTCapJudCDemF
                                                    ' *****  Imprime
                                                    lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                                                    lsRtfImp = lsRtfImp & " TOT. F.FINANC." ' & lsDescPr
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCredF, 5, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapF, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigF, 8, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigF, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1F, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1F, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2F, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2F, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemF, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemF, 12, 2, True) & " | "
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemF, 7, 0, True)
                                                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemF, 12, 2, True) & " | "
                                                    If lnTSaldoCapF <> 0 And lsConcepto = "C" Then
                                                      lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapF - lnTCapVigF) / lnTSaldoCapF) * 100, 2), 3, 2) & "%"
                                                    End If
                                                    lsRtfImp = lsRtfImp & Chr(10)
                                                    liLineas = liLineas + 2
                                                    
                                                    ' ****  Verifica Si Cambio pagina
                                                    If liLineas >= 54 Then 'Para el control de salto de página
                                                       lsRtfImp = lsRtfImp & Chr(12)
                                                       cpag = cpag + 1
                                                       lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                                       liLineas = 6
                                                    End If
                                               End If  ' Fuentes Financiamiento
                                               rsFF.MoveNext
                                            Loop  ' fuente Financiamiento
                                        End If   ' Fuente financiamiento
                                        
                                        ' ***************************************
                                        ' ***** Asigna Valores a Agencia  ******
                                        lnTCredAG = lnTCredAG + lnTCredSubPr
                                        lnTSaldoCapAG = lnTSaldoCapAG + lnTSaldoCapSubPr
                                        lnTNumVigAG = lnTNumVigAG + lnTNumVigSubPr
                                        lnTCapVigAG = lnTCapVigAG + lnTCapVigSubPr
                                        lnTNumVen1AG = lnTNumVen1AG + lnTNumVen1SubPr
                                        lnTCapVen1AG = lnTCapVen1AG + lnTCapVen1SubPr
                                        lnTNumVen2AG = lnTNumVen2AG + lnTNumVen2SubPr
                                        lnTCapVen2AG = lnTCapVen2AG + lnTCapVen2SubPr
                                        lnTNumJudSDemAG = lnTNumJudSDemAG + lnTNumJudSDemSubPr
                                        lnTCapJudSDemAG = lnTCapJudSDemAG + lnTCapJudSDemSubPr
                                        lnTNumJudCDemAG = lnTNumJudCDemAG + lnTNumJudCDemSubPr
                                        lnTCapJudCDemAG = lnTCapJudCDemAG + lnTCapJudCDemSubPr
                                        ' *****  Imprime
                                        lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                                        lsRtfImp = lsRtfImp & "  TOT.SUBPROD. " ' & lsDescPr
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCredSubPr, 5, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapSubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigSubPr, 8, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigSubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1SubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1SubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2SubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2SubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemSubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemSubPr, 12, 2, True) & " | "
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemSubPr, 7, 0, True)
                                        lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemSubPr, 12, 2, True) & " | "
                                        If lnTSaldoCapSubPr <> 0 And lsConcepto = "C" Then
                                          lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapSubPr - lnTCapVigSubPr) / lnTSaldoCapSubPr) * 100, 2), 3, 2) & "%"
                                        End If
                                        lsRtfImp = lsRtfImp & Chr(10)
                                        liLineas = liLineas + 2
                                        
                                        ' ****************************
                                        ' ****  Verifica Si Cambio pagina
                                        If liLineas >= 54 Then 'Para el control de salto de página
                                           lsRtfImp = lsRtfImp & Chr(12)
                                           cpag = cpag + 1
                                           lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                           liLineas = 6
                                        End If
                                    End If  ' Sub Productos
                                 Next J
                                 
                                ' ***************************************
                                ' ***** Asigna Valores a Producto ******
                                lnTCredProd = lnTCredProd + lnTCredAG
                                lnTSaldoCapProd = lnTSaldoCapProd + lnTSaldoCapAG
                                lnTNumVigProd = lnTNumVigProd + lnTNumVigAG
                                lnTCapVigProd = lnTCapVigProd + lnTCapVigAG
                                lnTNumVen1Prod = lnTNumVen1Prod + lnTNumVen1AG
                                lnTCapVen1Prod = lnTCapVen1Prod + lnTCapVen1AG
                                lnTNumVen2Prod = lnTNumVen2Prod + lnTNumVen2AG
                                lnTCapVen2Prod = lnTCapVen2Prod + lnTCapVen2AG
                                lnTNumJudSDemProd = lnTNumJudSDemProd + lnTNumJudSDemAG
                                lnTCapJudSDemProd = lnTCapJudSDemProd + lnTCapJudSDemAG
                                lnTNumJudCDemProd = lnTNumJudCDemProd + lnTNumJudCDemAG
                                lnTCapJudCDemProd = lnTCapJudCDemProd + lnTCapJudCDemAG
                                ' *****  Imprime
                                lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                                lsRtfImp = lsRtfImp & " TOT. AGENCIA  "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCredAG, 5, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapAG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigAG, 8, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigAG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1AG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1AG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2AG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2AG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemAG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemAG, 12, 2, True) & " | "
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemAG, 7, 0, True)
                                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemAG, 12, 2, True) & " | "
                                If lnTSaldoCapAG <> 0 And lsConcepto = "C" Then
                                lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapAG - lnTCapVigAG) / lnTSaldoCapAG) * 100, 2), 3, 2) & "%"
                                End If
                                lsRtfImp = lsRtfImp & Chr(10)
                                liLineas = liLineas + 2
                                 
                                If liLineas >= 54 Then 'Para el control de salto de página
                                   lsRtfImp = lsRtfImp & Chr(12)
                                   cpag = cpag + 1
                                   lsRtfImp = lsRtfImp & CabCarteraReclasificacion(cpag, pPlanCuentas, lsConcepto)
                                   liLineas = 6
                                End If
                             End If  ' De la Agencia
                             rsAg.MoveNext
                         Loop   ' De agencia
                     End If '  Producto
                    ' ***************************************
                    ' ***** Asigna Valores a MONEDA   ******
                    lnTCredM = lnTCredM + lnTCredProd
                    lnTSaldoCapM = lnTSaldoCapM + lnTSaldoCapProd
                   ' i = i - 1
                    lnTNumVigM = lnTNumVigM + lnTNumVigProd
                    lnTCapVigM = lnTCapVigM + lnTCapVigProd
                    lnTNumVen1M = lnTNumVen1M + lnTNumVen1Prod
                    lnTCapVen1M = lnTCapVen1M + lnTCapVen1Prod
                    lnTNumVen2M = lnTNumVen2M + lnTNumVen2Prod
                    lnTCapVen2M = lnTCapVen2M + lnTCapVen2Prod
                    lnTNumJudSDemM = lnTNumJudSDemM + lnTNumJudSDemProd
                    lnTCapJudSDemM = lnTCapJudSDemM + lnTCapJudSDemProd
                    lnTNumJudCDemM = lnTNumJudCDemM + lnTNumJudCDemProd
                    lnTCapJudCDemM = lnTCapJudCDemM + lnTCapJudCDemProd

                    ' *****  Imprime
                    lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                    lsRtfImp = lsRtfImp & "  TOT PRODUCT  "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCredProd, 5, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapProd, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigProd, 8, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigProd, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1Prod, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1Prod, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2Prod, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2Prod, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemProd, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemProd, 12, 2, True) & " | "
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemProd, 7, 0, True)
                    lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemProd, 12, 2, True) & " | "
                    If lnTSaldoCapProd <> 0 And lsConcepto = "C" Then
                     lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapProd - lnTCapVigProd) / lnTSaldoCapProd) * 100, 2), 3, 2) & "%"
                    End If
                    lsRtfImp = lsRtfImp & Chr(10)
                    liLineas = liLineas + 2
                         
                 Next i   ' Para el Sgte Producto
                ' *****  Imprime
                lsRtfImp = lsRtfImp & String(160, "-") & Chr(10)
                lsRtfImp = lsRtfImp & "  TOT MONEDA   "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCredM, 5, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTSaldoCapM, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVigM, 8, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVigM, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen1M, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen1M, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumVen2M, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapVen2M, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudSDemM, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudSDemM, 12, 2, True) & " | "
                lsRtfImp = lsRtfImp & ImpreFormat(lnTNumJudCDemM, 7, 0, True)
                lsRtfImp = lsRtfImp & ImpreFormat(lnTCapJudCDemM, 12, 2, True) & " | "
                If lnTSaldoCapM <> 0 And lsConcepto = "C" Then
                  lsRtfImp = lsRtfImp & ImpreFormat(Round(((lnTSaldoCapM - lnTCapVigM) / lnTSaldoCapM) * 100, 2), 3, 2) & "%"
                End If
                lsRtfImp = lsRtfImp & Chr(10)
                lsRtfImp = lsRtfImp & String(170, "-") & Chr(10)
                'lsRTfImp = lsRTfImp & Chr(10)
                liLineas = liLineas + 4
             
            End If '---liDatos - Moneda
            lbSiCambio = True
            RaiseEvent Progress(RsM.Bookmark, RsM.RecordCount)
            RsM.MoveNext
            If Not RsM.EOF Then
                lsRtfImp = lsRtfImp & Chr(12)
                cpag = cpag + 1
                liLineas = 0
            End If
        Loop ' ---- Moneda
    End If '--- Moneda
    RaiseEvent CloseProgress
    RsM.Close
    Set RsM = Nothing
Else
    nRepo108711_ImpCarteraReclasificacion = ""
End If '--- liDatos - General
lsRtfImpG = lsRtfImp ' Asigna el valor
nRepo108711_ImpCarteraReclasificacion = lsRtfImpG
Screen.MousePointer = 1
End Function

Public Function nRepo108716_ImpProvisiondeCreditos(ByVal psServConsol As String) As String
'Dim Sql As String
'Dim SQL1 As String
'Dim rs As New ADODB.Recordset
'Dim rs1 As New ADODB.Recordset
'Dim lnLineas, lnPage As Integer
'Dim Linea As Long
'Dim lsCadPrint As String
'Dim cpag As Integer
'Dim calif() As String
'Dim cartera() As String
'Dim i As Integer
'Dim lscadDol As String
'Dim lscartera As String
'Dim flgdol As Boolean
'
'SQL1 = "select * from constante where nConsCod = 8014 and nconsvalor<>8014 order by nconsvalor "
'Set rs1 = GetQuery(SQL1)
'
'ReDim calif(8014)
'For i = 0 To rs1.RecordCount - 1
'    calif(i) = rs1!cConsDescripcion
'    rs1.MoveNext
'Next i
'
'SQL1 = "SELECT substring(convert(char,nconsvalor),1,1) as valor, cconsdescripcion FROM CONSTANTE WHERE NCONSCOD=1001 and substring(convert(char,nconsvalor),2,3)='00'"
'Set rs1 = GetQuery(SQL1)
'
'ReDim cartera(5)
'For i = 0 To rs1.RecordCount - 1
'    cartera(i) = rs1!cConsDescripcion
'    rs1.MoveNext
'Next i
'
'
'Sql = ""
'Sql = "Select Distinct"
'Sql = Sql & " case when (GROUPING(CN2.cconsDescripcion)=1) then 'Total' else isnull(CN2.cconsDescripcion,'Desconocido') end as Moneda,"
'Sql = Sql & " case when (GROUPING(CN1.cConsDescripcion)=1) then 'Total' else isnull(CN1.cConsDescripcion, 'Moneda desconocida') end as Cartera,"
'Sql = Sql & " case when (GROUPING(CN.cConsDescripcion)=1) then 'Total' else isnull(CN.cConsDescripcion,'cartera desconocida') end as Producto,"
'Sql = Sql & " case when (GROUPING(CN3.nconsvalor)=1) then 8014 else isnull(CN3.nconsvalor,'Producto desconocida') end as Calificacion,"
'Sql = Sql & " CASE WHEN (GROUPING(P.cPersNombre) = 1) THEN 'ZZTotal' ELSE ISNULL(P.cPersNombre, 'Desconocido ')   END AS sFuenteFinan,"
'Sql = Sql & " count(*) as casos,"
'Sql = Sql & " isnull(sum(CASE WHEN CAL.estado= 2201 THEN 0 Else CASE when CN.nConsValor IN (121,221,321,421) then CCP.nsaldoCap else   "
'Sql = Sql & " CASE when CAL2.vigente <> 0 then (CCP.nsaldoCap-CCL.ncapvencido) else 0 end  end End ),0) as vigente,"
'Sql = Sql & " isnull(sum(CASE WHEN CAL.estado= 2201 then  0 else case when CAL3.Refinanciado <> 0  then (CCP.nsaldoCap-CCL.ncapvencido) else 0 end  END),0) as refinanciado,"
'Sql = Sql & " isnull(SUM(CASE WHEN CAL.estado= 2201 then 0 else CCL.ncapvencido end ),0) as vencidos ,"
'Sql = Sql & " isnull(sum( CAL.judicial),0) as judicial, isnull(sum(CCP.nsaldoCap),0) as Total,isnull(Sum( CCP.nprovision),0) as provision,"
'Sql = Sql & " isnull(Sum(AutoLiq),0) AutoLiq, isnull(Sum(Preferi),0) Preferi, isnull(Sum(NoPrefe),0) NoPrefe,"
'Sql = Sql & " InteresDev = isnull(Sum(CCL.nintDev), 0)"
'Sql = Sql & " from DBCmactAux..colocCalifProv CCP left join"
'Sql = Sql & " (select gcc.cCtaCod,"
'Sql = Sql & " AUTOLIQ = SUM(CASE WHEN GC.nMONEDA = 1 THEN CASE WHEN GC.nGarClase = 3 THEN  GCC.nMontoGrava ELSE 0 END"
'Sql = Sql & " ELSE CASE WHEN GC.nGarClase = 3 THEN  GCC.nMontoGrava ELSE 0 END   END),"
'Sql = Sql & " PREFERI = SUM(CASE WHEN GC.nMONEDA = 1 THEN CASE WHEN GC.nGarClase = 1 THEN  GCC.nMontoGrava ELSE 0 END"
'Sql = Sql & " ELSE CASE WHEN GC.nGarClase = 1 THEN  GCC.nMontoGrava ELSE 0 END  END),"
'Sql = Sql & " NOPREFE = SUM(CASE WHEN GC.nMONEDA = 1 THEN CASE WHEN GC.nGarClase = 4 THEN  GCC.nMontoGrava ELSE 0 END"
'Sql = Sql & " ELSE CASE WHEN GC.nGarClase = 4 THEN  GCC.nMontoGrava  ELSE 0 END  END)"
'Sql = Sql & " from DBCMACTCONSOLIDADA..GarantCredConsol GCC"
'Sql = Sql & " JOIN DBCMACTCONSOLIDADA..GarantiasConsol gc ON gcc.cNumGarant = gc.cNumGarant"
'Sql = Sql & " Where gc.nEstado = 3 And gcc.nEstado = 1"
'Sql = Sql & "  group by gcc.cCtaCod"
'Sql = Sql & " ) Garant ON Garant.cCtacod  = CCP.Cctacod"
'Sql = Sql & " left join DBCMACTCONSOLIDADA..CreditoConsol CCL on CCL.Cctacod=CCP.Cctacod"
'Sql = Sql & " inner Join DBCmactAux..Constante CN2 ON Convert(Int,SUBSTRING(CCP.cCtaCod,9,1)) = CN2.nConsValor And CN2.nConsCod = 1011"
'Sql = Sql & " inner join DBCmactAux..Constante CN1 ON Convert(Int,SUBSTRING(CCP.cCtaCod,6,1)+'00') = CN1.nConsValor And CN1.nConsCod = 1001"
'Sql = Sql & " Inner Join DBCmactAux..Constante CN ON Convert(Int,SUBSTRING(CCP.cCtaCod,6,3)) = CN.nConsValor And CN.nConsCod = 1001"
'Sql = Sql & " Inner Join DBCmactAux..Constante CN3 ON convert(int,CCP.cCalGen) = CN3.nConsValor And CN3.nConsCod = 8014"
'Sql = Sql & " Inner Join DBCmactAux..Persona P ON CCP.cPersCod = P.cPersCod"
'Sql = Sql & " Left Join (select GCC.Cctacod, C.nprdEstado as estado, sum(case when rtrim(C.nprdEstado)=2201 then C.nsaldoCap else 0 end)/count (distinct GCC.cnumGarant) as judicial"
'Sql = Sql & " From DBCmactAux..colocCalifProv C join DBCMACTCONSOLIDADA..GarantCredConsol GCC on C.Cctacod= GCC.Cctacod"
'Sql = Sql & " GROUP BY GCC.cCtaCod, C.nprdEstado) CAL ON CAL.cCtaCod = CCP.cCtaCod"
'Sql = Sql & " Left Join (select GCC.Cctacod,C.cRefinan as estado, (sum(case when rtrim(C.cRefinan)='N' then C.nsaldoCap else 0 end))/count (distinct GCC.cnumGarant) as vigente"
'Sql = Sql & " From DBCmactAux..colocCalifProv C join DBCMACTCONSOLIDADA..GarantCredConsol GCC on C.Cctacod= GCC.Cctacod"
'Sql = Sql & " GROUP BY GCC.cCtaCod, C.cRefinan) CAL2 ON CAL2.cCtaCod = CCP.cCtaCod"
'Sql = Sql & " Left Join (select GCC.Cctacod,C.nprdEstado as estado, sum(case when rtrim(C.nprdEstado)=2021 then C.nsaldoCap else 0 end)/count (distinct GCC.cnumGarant) as vencido"
'Sql = Sql & " From DBCmactAux..colocCalifProv C join DBCMACTCONSOLIDADA..GarantCredConsol GCC on C.Cctacod= GCC.Cctacod"
'Sql = Sql & " GROUP BY GCC.cCtaCod, C.nprdEstado) CAL4 ON CAL4.cCtaCod = CCP.cCtaCod"
'Sql = Sql & " Left Join (select GCC.Cctacod,C.cRefinan as estado, (sum(case when rtrim(C.cRefinan)='R' then C.nsaldoCap else 0 end))/count (distinct GCC.cnumGarant) as Refinanciado"
'Sql = Sql & " From DBCmactAux..colocCalifProv C join DBCMACTCONSOLIDADA..GarantCredConsol GCC on C.Cctacod= GCC.Cctacod"
'Sql = Sql & " GROUP BY GCC.cCtaCod, C.cRefinan) CAL3 ON CAL3.cCtaCod = CCP.cCtaCod"
'Sql = Sql & " where  CCP.nprdEstado in (2020,2021,2030,2031,2022,2032,2201,2802,2803,2804,2807)"
'Sql = Sql & " and substring(CCP.cCtaCod,6,3)<>'305' "
'Sql = Sql & " Group by  CN2.cconsDescripcion,CN1.cConsDescripcion,CN.cConsDescripcion,CN3.nconsvalor,"
'Sql = Sql & " P.cPersNombre"
'Sql = Sql & " With rollup"
'
'
'Set rs = GetQuery(Sql)
'flgdol = True
'lscartera = ""
'RaiseEvent ShowProgress
'
'If Not rs.BOF And Not rs.EOF Then
'    lnLineas = 0
'    cpag = 1
'    lsCadPrint = ""
'    lsCadPrint = ProvisionCredCab(0, rs!Moneda, rs!cartera, rs!Producto, IIf(rs!Calificacion = 8014, "Total", calif(rs!Calificacion)))
'    lsCadPrint = lsCadPrint & ProvisionCredCab(1, rs!Moneda, rs!cartera, rs!Producto, IIf(rs!Calificacion = 8014, "Total", calif(rs!Calificacion)))
'    lnLineas = lnLineas + 12
'
'
'    Do While Not rs.EOF
'        'If RTrim(rs!Moneda) = "Total" Then
'
'        'End If
'
'        If RTrim(rs!cartera) = "Total" And RTrim(rs!Moneda) <> "Total" Then ''Moneda <> rs!Moneda Then
'            lsCadPrint = lsCadPrint & String(172, "-") & Chr$(10)
'            lsCadPrint = lsCadPrint & String(5, " ") & ImpreFormat("TOTAL MONEDA", 25) & Space(1) & ImpreFormat(rs!VIGENTE, 10, 2, True) & Space(1) & ImpreFormat(rs!refinanciado, 10, 2, True) & Space(1) & ImpreFormat(rs!vencidos, 10, 2, True) & Space(1)
'            lsCadPrint = lsCadPrint & ImpreFormat(rs!judicial, 10, 2, True) & Space(1) & ImpreFormat(rs!Total, 10, 2, True) & Space(1) & ImpreFormat(rs!Provision, 10, 2, True) & Space(1)
'            lsCadPrint = lsCadPrint & ImpreFormat(rs!AutoLiq, 10, 2, True) & Space(1) & ImpreFormat(rs!PREFERI, 10, 2, True) & Space(1) & ImpreFormat(rs!NOPREFE, 10, 2, True) & Space(1) & ImpreFormat(rs!InteresDev, 10, 2, True) & Space(1) & Chr$(10)
'            lsCadPrint = lsCadPrint & String(172, "-") & Chr$(10)
'            lsCadPrint = lsCadPrint & String(160, " ") & "--Pag." & cpag & "--" & Chr$(12)
'            lnLineas = lnLineas + 4
'            cpag = cpag + 1
'            If flgdol = True Then
'                lscadDol = lsCadPrint
'                lsCadPrint = ""
'                flgdol = False
'            End If
'
'            rs.MoveNext
'            If Not rs.EOF Then
'                If RTrim(rs!Moneda) <> "Total" Then
'                    lsCadPrint = lsCadPrint & ProvisionCredCab(0, rs!Moneda, rs!cartera, rs!Producto, IIf(rs!Calificacion = 8014, "Total", calif(rs!Calificacion)))
'                    lsCadPrint = lsCadPrint & ProvisionCredCab(1, rs!Moneda, rs!cartera, rs!Producto, IIf(rs!Calificacion = 8014, "Total", calif(rs!Calificacion)))
'                    lnLineas = 13
'                End If
'            End If
'         Else
'            If RTrim(rs!Producto) = "Total" And RTrim(rs!Moneda) <> "Total" Then ''Cartera <> rs!Cartera Then
'                lsCadPrint = lsCadPrint & String(172, "-") & Chr$(10)
'                lsCadPrint = lsCadPrint & String(5, " ") & ImpreFormat("TOTAL CARTERA", 25) & Space(1) & ImpreFormat(rs!VIGENTE, 10, 2, True) & Space(1) & ImpreFormat(rs!refinanciado, 10, 2, True) & Space(1) & ImpreFormat(rs!vencidos, 10, 2, True) & Space(1)
'                lsCadPrint = lsCadPrint & ImpreFormat(rs!judicial, 10, 2, True) & Space(1) & ImpreFormat(rs!Total, 10, 2, True) & Space(1) & ImpreFormat(rs!Provision, 10, 2, True) & Space(1)
'                lsCadPrint = lsCadPrint & ImpreFormat(rs!AutoLiq, 10, 2, True) & Space(1) & ImpreFormat(rs!PREFERI, 10, 2, True) & Space(1) & ImpreFormat(rs!NOPREFE, 10, 2, True) & Space(1) & ImpreFormat(rs!InteresDev, 10, 2, True) & Space(1) & Chr$(10)
'                lsCadPrint = lsCadPrint & String(172, "-") & Chr$(10)
'                lnLineas = lnLineas + 3
'                rs.MoveNext
'                If Not rs.EOF Then
'                    If RTrim(rs!cartera) <> "Total" And RTrim(rs!Moneda) <> "Total" Then
'                        cpag = cpag + 1
'                        lsCadPrint = lsCadPrint & String(160, " ") & "--Pag." & cpag & "--" & Chr$(12)
'                        lnLineas = lnLineas + 1
'                        lsCadPrint = lsCadPrint & ProvisionCredCab(0, rs!Moneda, rs!cartera, rs!Producto, IIf(rs!Calificacion = 8014, "Total", calif(rs!Calificacion)))
'                        lsCadPrint = lsCadPrint & ProvisionCredCab(1, rs!Moneda, rs!cartera, rs!Producto, IIf(rs!Calificacion = 8014, "Total", calif(rs!Calificacion)))
'                        lnLineas = 13
'                    End If
'                End If
'            Else
'                If RTrim(rs!Calificacion) = 8014 And RTrim(rs!Moneda) <> "Total" Then ''Producto <> rs!Producto Then
'                    lsCadPrint = lsCadPrint & String(172, "-") & Chr$(10)
'                    lsCadPrint = lsCadPrint & String(5, " ") & ImpreFormat("TOTAL PRODUCTO", 25) & Space(1) & ImpreFormat(rs!VIGENTE, 10, 2, True) & Space(1) & ImpreFormat(rs!refinanciado, 10, 2, True) & Space(1) & ImpreFormat(rs!vencidos, 10, 2, True) & Space(1)
'                    lsCadPrint = lsCadPrint & ImpreFormat(rs!judicial, 10, 2, True) & Space(1) & ImpreFormat(rs!Total, 10, 2, True) & Space(1) & ImpreFormat(rs!Provision, 10, 2, True) & Space(1)
'                    lsCadPrint = lsCadPrint & ImpreFormat(rs!AutoLiq, 10, 2, True) & Space(1) & ImpreFormat(rs!PREFERI, 10, 2, True) & Space(1) & ImpreFormat(rs!NOPREFE, 10, 2, True) & Space(1) & ImpreFormat(rs!InteresDev, 10, 2, True) & Space(1) & Chr$(10)
'                    lsCadPrint = lsCadPrint & String(172, "-") & Chr$(10)
'                    lnLineas = lnLineas + 4
'                    rs.MoveNext
'                    If Not rs.EOF Then
'                        lsCadPrint = lsCadPrint & ProvisionCredCab(3, rs!Moneda, rs!cartera, rs!Producto, IIf(rs!Calificacion = 8014, "Total", calif(rs!Calificacion)))
'                        lnLineas = lnLineas + 4
'                    End If
'                Else
'                    If RTrim(rs!sFuentefinan) = "ZZTotal" And RTrim(rs!Moneda) <> "Total" Then ''Calificacion <> rs!Calificacion Then
'                        lsCadPrint = lsCadPrint & String(172, "-") & Chr$(10)
'                        lsCadPrint = lsCadPrint & String(5, " ") & ImpreFormat("TOTAL CALIFICACION", 25) & Space(1) & ImpreFormat(rs!VIGENTE, 10, 2, True) & Space(1) & ImpreFormat(rs!refinanciado, 10, 2, True) & Space(1) & ImpreFormat(rs!vencidos, 10, 2, True) & Space(1)
'                        lsCadPrint = lsCadPrint & ImpreFormat(rs!judicial, 10, 2, True) & Space(1) & ImpreFormat(rs!Total, 10, 2, True) & Space(1) & ImpreFormat(rs!Provision, 10, 2, True) & Space(1)
'                        lsCadPrint = lsCadPrint & ImpreFormat(rs!AutoLiq, 10, 2, True) & Space(1) & ImpreFormat(rs!PREFERI, 10, 2, True) & Space(1) & ImpreFormat(rs!NOPREFE, 10, 2, True) & Space(1) & ImpreFormat(rs!InteresDev, 10, 2, True) & Space(1) & Chr$(10)
'                        lsCadPrint = lsCadPrint & String(172, "-") & Chr$(10)
'                        lnLineas = lnLineas + 4
'                        rs.MoveNext
'                        If Not rs.EOF Then
'                            lsCadPrint = lsCadPrint & ProvisionCredCab(4, rs!Moneda, rs!cartera, rs!Producto, IIf(rs!Calificacion = 8014, "Total", calif(rs!Calificacion)))
'                            lnLineas = lnLineas + 2
'                        End If
'                    ElseIf RTrim(rs!Moneda) = "Total" Then
'                        rs.MoveNext
'                    End If
'                End If
'            End If
'        End If
'
'
'
'        If Not rs.EOF Then
'            If RTrim(rs!sFuentefinan) <> "ZZTotal" And RTrim(rs!Calificacion) <> 8014 And RTrim(rs!Producto) <> "Total" And RTrim(rs!cartera) <> "Total" And RTrim(rs!Moneda) <> "Total" And Not rs.EOF Then
'                lsCadPrint = lsCadPrint & ImpreFormat(rs!sFuentefinan, 30) & Space(1)
'                lsCadPrint = lsCadPrint & ImpreFormat(rs!VIGENTE, 10, 2, True) & Space(1) & ImpreFormat(rs!refinanciado, 10, 2, True) & Space(1) & ImpreFormat(rs!vencidos, 10, 2, True) & Space(1)
'                lsCadPrint = lsCadPrint & ImpreFormat(rs!judicial, 10, 2, True) & Space(1) & ImpreFormat(rs!Total, 10, 2, True) & Space(1) & ImpreFormat(rs!Provision, 10, 2, True) & Space(1)
'                lsCadPrint = lsCadPrint & ImpreFormat(rs!AutoLiq, 10, 2, True) & Space(1) & ImpreFormat(rs!PREFERI, 10, 2, True) & Space(1) & ImpreFormat(rs!NOPREFE, 10, 2, True) & Space(1) & ImpreFormat(rs!InteresDev, 10, 2, True) & Chr$(10)
'                lnLineas = lnLineas + 1
'                If lnLineas >= 54 Then 'Para el control de salto de página
'                   lsCadPrint = lsCadPrint & String(160, " ") & "--Pag." & cpag & "--"
'                   lnLineas = lnLineas + 1
'                   lsCadPrint = lsCadPrint & Chr(12)
'                   lsCadPrint = lsCadPrint & ProvisionCredCab(0, rs!Moneda, rs!cartera, rs!Producto, IIf(rs!Calificacion = 8014, "Total", calif(rs!Calificacion)))
'                   lsCadPrint = lsCadPrint & ProvisionCredCab(1, rs!Moneda, rs!cartera, rs!Producto, IIf(rs!Calificacion = 8014, "Total", calif(rs!Calificacion)))
'                   cpag = cpag + 1
'                   lnLineas = 13
'                End If
'                RaiseEvent Progress(rs.Bookmark, rs.RecordCount)
'                rs.MoveNext
'            End If
'        End If
'    Loop
'    rs.Close
'    Set rs = Nothing
'    RaiseEvent CloseProgress
'    nRepo108716_ImpProvisiondeCreditos = lscadDol & lsCadPrint
'Else
'    nRepo108716_ImpProvisiondeCreditos = ""
'    Exit Function
'End If
'
End Function

Public Function nRepo108801_(ByVal psServConsol As String, ByVal pdFechaDesde As Date, ByVal pdFechaHasta As Date, _
ByVal pnTipoCambio As Double, ByVal psCmac As String) As String
Dim sql As String
Dim Sql1 As String
Dim rs As New ADODB.Recordset
Dim rs1 As New ADODB.Recordset
Dim Lineas() As String
Dim Linea As Long
Dim MontoTotal As Currency
Dim TotalCreditos As Long
Dim TotalPersonas As Long
Dim TotalMontoPrendario As Currency
Dim TotalCredPrendario As Long
Dim TotalClientesPrendario As Long
Dim J As Long
Dim Total As Long

Dim lnProd As Integer
Dim lsProduc(5) As String
Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim lsVig As String

'agregado por LMMD: Total de analistas de RRHH
Dim rsRH As ADODB.Recordset
Dim sSQLRH As String
Dim nCantAnalistas As Integer

lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc
'
lsVig = gColocEstRecVigJud & "," & gColocEstRecVigCast & "," & gColocEstRecCanJud & "," & gColocEstRecCanCast


'Lima
If "102" = psCmac Then
    lsProduc(1) = " ('101','201') " ' PYME
    lsProduc(2) = " ('102','103','103') " ' Consumo
    lsProduc(3) = " ('301','304','320') " ' Personales
    lsProduc(4) = " ('402') " ' HIPOTECARIO
    lsProduc(5) = " ('305') " ' PRENDARIO
    lsPignoraticio = " 2802,2803,2804,2807"
Else
' Trujillo
    lsProduc(1) = " ('101','201') " ' PYME
    lsProduc(2) = " ('102','202') " ' AGRICOLA
    lsProduc(3) = " ('301','302','303','304','320') " ' CONSUMO
    lsProduc(4) = " ('401','423') " ' HIPOTECARIO
    lsProduc(5) = " ('305') " ' PRENDARIO
    'lsPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
    lsPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
End If
Dim NumClientes As Long
Dim lnTotOtorg As Double, lnNumOtorg As Long
Dim lnTotRepre As Double, lnNumRepre As Long
Dim lnTotNuevo As Double, lnNumNuevo As Long
Dim lnTotRefin As Double, lnNumRefin As Long
Dim lnTotOtorgPig As Double, lnNumOtorgPig As Long
Dim lnTotReprePig As Double, lnNumReprePig As Long
Dim lnTotNuevoPig As Double, lnNumNuevoPig As Long
Dim lnTotRefinPig As Double, lnNumRefinPig As Long

Dim lnFilTotVolCredD As Currency, lnFilTotNroCredD As Currency
Dim lnFilTotClienteD As Long
Dim lnFilTotVolRep As Currency, lnFilTotNroRep As Long
Dim lnFilTotVolNue As Currency, lnFilTotNroNue As Long
Dim lnFilTotVolRef As Currency, lnFilTotNroRef As Long

Dim lnTotCred As Double, lnNumcred As Long
Dim lnTotMora1 As Double, lnNumMora1 As Long
Dim lnTotMora2 As Double, lnNumMora2 As Long
Dim lnTotMora3 As Double, lnNumMora3 As Long
Dim lnTotMora4 As Double, lnNumMora4 As Long
Dim lnTotMora5 As Double, lnNumMora5 As Long
Dim lnTotMora0 As Double, lnNumMora0 As Long

Dim lsCadenaPrint As String
Dim Tabula As Integer
Screen.MousePointer = 11
J = 4
Total = 4 * 25
lsCadenaPrint = ""

Tabula = 10
ReDim Lineas(20)
lsCadenaPrint = ReporteINFO1Cab(pdFechaDesde, pdFechaHasta, pnTipoCambio, psCmac)

lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & "TOTAL" & Chr(27) & Chr(70) & Chr(10)

'*****************************************************************
'*****************************************************************
'--**************** CREDITOS OTORGADOS           *****************

RaiseEvent ShowProgress
Lineas(1) = Lineas(1) & CadDerecha("VOLUMEN(US$)", 20)
Lineas(2) = Lineas(2) & CadDerecha("Nº CREDITOS ", 20)
Lineas(3) = Lineas(3) & CadDerecha("Nº DE CLIENTES", 20)
Lineas(4) = Lineas(4) & CadDerecha("VOLUMEN(US$)", 20)
Lineas(5) = Lineas(5) & CadDerecha("Nº CREDITOS ", 20)
Lineas(6) = Lineas(6) & CadDerecha("VOLUMEN(US$)", 20)
Lineas(7) = Lineas(7) & CadDerecha("Nº CREDITOS ", 20)
Lineas(8) = Lineas(8) & CadDerecha("VOLUMEN(US$)", 20)
Lineas(9) = Lineas(9) & CadDerecha("Nº CREDITOS ", 20)

RaiseEvent Progress(1, 10)
For lnProd = 1 To 4

    sql = "SELECT Count (C.cCtaCod ) NumOtorg ," _
        & " Isnull(Sum ( CASE  WHEN SUBSTRING(C.cCtaCod,9,1)='1' THEN C.NMONTODESEMB/" & pnTipoCambio _
        & "                    WHEN SUBSTRING(C.cCtaCod,9,1)='2' THEN C.NMONTODESEMB  End ),  0 ) SKOtorg , " _
        & " COUNT( CASE  WHEN C.nCondCre IN (2,3) AND C.cRefinan ='N' THEN c.cCtaCod END )  As NumRepre, " _
        & " IsNull(SUM( CASE WHEN Substring(c.cCtaCod,9,1) ='1' and C.nCondCre IN (2,3) AND C.cRefinan ='N' THEN c.NMONTODESEMB /" & pnTipoCambio _
        & "                  WHEN Substring(c.cCtaCod,9,1) ='2' and C.nCondCre IN (2,3) AND C.cRefinan ='N' THEN c.NMONTODESEMB END ), 0 )  As SKRepre , " _
        & " COUNT( CASE  WHEN C.nCondCre IN (1) AND C.cRefinan ='N'  THEN c.cCtaCod END )  As NumNuevo, " _
        & " IsNull(SUM( CASE WHEN Substring(c.cCtaCod,9,1) ='1' and C.nCondCre IN (1) AND C.cRefinan ='N'  THEN c.NMONTODESEMB /" & pnTipoCambio _
        & "                  WHEN Substring(c.cCtaCod,9,1) ='2' and C.nCondCre IN (1) AND C.cRefinan ='N'  THEN c.NMONTODESEMB END ), 0 )  As SKNuevo , " _
        & " COUNT( CASE  WHEN C.cRefinan ='R' THEN c.cCtaCod END )  As NumRefin, " _
        & " IsNull(SUM( CASE WHEN Substring(c.cCtaCod,9,1) ='1' AND C.cRefinan ='R' THEN c.NMONTODESEMB /" & pnTipoCambio _
        & "                  WHEN Substring(c.cCtaCod,9,1) ='2' AND C.cRefinan ='R' THEN c.NMONTODESEMB END ), 0 )  As SKRefin  " _
        & " From " & psServConsol & "CreditoConsol C " _
        & " WHERE C.nPrdEstado in (" & lsCreditosVigentes & "," & gColocEstCancelado & "," & lsVig & ") And SUBSTRING(C.cCtaCod,6,3) IN " & lsProduc(lnProd) _
        & "  AND  C.DFECVIG BETWEEN '" & Format(pdFechaDesde, "mm/dd/yyyy") & "' AND '" & Format(pdFechaHasta, "mm/dd/yyyy") & " 23:59' " _
 
    lnTotOtorg = 0: lnNumOtorg = 0
    lnTotRepre = 0: lnNumRepre = 0
    lnTotNuevo = 0: lnNumNuevo = 0
    lnTotRefin = 0: lnNumRefin = 0
    Set rs = GetQuery(sql)
    If Not RSVacio(rs) Then
        lnNumOtorg = rs!NumOtorg
        lnTotOtorg = rs!SKOtorg
        lnNumRepre = rs!NumRepre
        lnTotRepre = rs!SKRepre
        lnNumNuevo = rs!NumNuevo
        lnTotNuevo = rs!SKNUevo
        lnNumRefin = rs!NumRefin
        lnTotRefin = rs!SKRefin

        lnFilTotNroCredD = lnFilTotNroCredD + rs!NumOtorg
        lnFilTotVolCredD = lnFilTotVolCredD + rs!SKOtorg
        lnFilTotNroRep = lnFilTotNroRep + rs!NumRepre
        lnFilTotVolRep = lnFilTotVolRep + rs!SKRepre
        lnFilTotNroNue = lnFilTotNroNue + rs!NumNuevo
        lnFilTotVolNue = lnFilTotVolNue + rs!SKNUevo
        lnFilTotNroRef = lnFilTotNroRef + rs!NumRefin
        lnFilTotVolRef = lnFilTotVolRef + rs!SKRefin
    End If
    Lineas(1) = Lineas(1) & ImpreFormat(lnTotOtorg, 15, 2, True)
    Lineas(2) = Lineas(2) & ImpreFormat(lnNumOtorg, 15, 2, True)

    Lineas(4) = Lineas(4) & ImpreFormat(lnTotRepre, 15, 2, True)
    Lineas(5) = Lineas(5) & ImpreFormat(lnNumRepre, 15, 2, True)

    Lineas(6) = Lineas(6) & ImpreFormat(lnTotNuevo, 15, 2, True)
    Lineas(7) = Lineas(7) & ImpreFormat(lnNumNuevo, 15, 2, True)

    Lineas(8) = Lineas(8) & ImpreFormat(lnTotRefin, 15, 2, True)
    Lineas(9) = Lineas(9) & ImpreFormat(lnNumRefin, 15, 2, True)

    rs.Close

    TotalPersonas = 0
    sql = "SELECT COUNT(DISTINCT(PERSCREDITO.cPersCod)) AS TOTALPERSONAS " _
        & " FROM " & psServConsol & "ProductoPersonaConsol PERSCREDITO INNER JOIN " & psServConsol & "CreditoConsol ON " & psServConsol & "CreditoConsol.cCtacod=PERSCREDITO.cCtaCod " _
        & " WHERE nPrdEstado in (" & lsCreditosVigentes & "," & gColocEstCancelado & "," & lsVig & ") AND SUBSTRING(PERSCREDITO.cCtaCod,6,3) IN " & lsProduc(lnProd) _
        & " AND DFECVIG BETWEEN '" & Format(pdFechaDesde, "mm/dd/yyyy") & "' AND '" & Format(pdFechaHasta, "mm/dd/yyyy") & " 23:59' " _
        & " AND nPrdPersRelac =20  "
    Set rs1 = GetQuery(sql)
    If Not RSVacio(rs1) Then
        TotalPersonas = rs1!TotalPersonas
        Lineas(3) = Lineas(3) & ImpreFormat(TotalPersonas, 15, 2, True)
        lnFilTotClienteD = lnFilTotClienteD + TotalPersonas
    End If
    rs1.Close

Next

RaiseEvent Progress(5, 10)
J = J + 4
'--*****************************************************************************
'--****************************  PRENDARIO  ************************************
If "102" = psCmac Then

sql = "SELECT Count (CASE  WHEN T.cOpeCod IN(" & 150201 & "," & 150901 & "," & 150902 & ")  Then  C.cCtaCod End ) NumOtorg, " _
    & " Isnull(Sum ( CASE  WHEN T.cOpeCod IN(" & 150201 & "," & 150901 & "," & 150902 & ") And SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoDesemb/" & pnTipoCambio _
    & "                    WHEN T.cOpeCod IN(" & 150201 & ") And SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nMontoDesemb  End ),  0 ) SKOtorg , " _
    & " COUNT( CASE  WHEN T.cOpeCod IN(" & 150901 & "," & 150902 & ")  THEN c.cCtaCod END )  As NumRepre, " _
    & " Isnull(Sum ( CASE WHEN T.cOpeCod IN(" & 150901 & "," & 150902 & ") AND SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoDesemb/" & pnTipoCambio _
    & "                   WHEN T.cOpeCod IN(" & 150901 & "," & 150902 & ")  AND SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nMontoDesemb End) , 0 ) SKRepre,  " _
    & " COUNT( CASE  WHEN T.cOpeCod IN(" & 150201 & ")  THEN c.cCtaCod END )  As NumNuevo, " _
    & " Isnull(Sum ( CASE WHEN T.cOpeCod IN(" & 150201 & ") AND SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoDesemb/" & pnTipoCambio _
    & "                   WHEN T.cOpeCod IN(" & 150201 & ") AND SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nMontoDesemb End) , 0 ) SKNuevo  " _
    & " " _
    & " From " & psServConsol & "CreditoConsol C  " _
    & " INNER JOIN MovCol T ON T.cCtaCod=C.cCtaCod    " _
    & " INNER Join Mov M on M.nMovNro=T.nMovNro  " _
    & " WHERE substring(M.cMovNro,1,8) BETWEEN '" & Format(pdFechaDesde, gsFormatoMovFecha) & "' AND '" & Format(pdFechaHasta, gsFormatoMovFecha) & " 23:59' " _
    & " AND T.cOpeCod IN(" & 150201 & "," & 150901 & "," & 150902 & ")  " _
    & " AND T.nFLAG IS NULL  "

Else

sql = "SELECT Count (CASE  WHEN T.cOpeCod IN(" & gColPOpeDesembolsoEFE & ")  Then  C.cCtaCod End ) NumOtorg, " _
    & " Isnull(Sum ( CASE  WHEN T.cOpeCod IN(" & gColPOpeDesembolsoEFE & ") And SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoDesemb/" & pnTipoCambio _
    & "                    WHEN T.cOpeCod IN(" & gColPOpeDesembolsoEFE & ") And SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nMontoDesemb  End ),  0 ) SKOtorg , " _
    & " COUNT( CASE  WHEN T.cOpeCod IN(" & gColPOpeRenovMorEFE & "," & gColPOpeRenovNorEFE & ")  THEN c.cCtaCod END )  As NumRepre, " _
    & " Isnull(Sum ( CASE WHEN T.cOpeCod IN(" & gColPOpeRenovMorEFE & "," & gColPOpeRenovNorEFE & ") AND SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoDesemb/" & pnTipoCambio _
    & "                   WHEN T.cOpeCod IN(" & gColPOpeRenovMorEFE & "," & gColPOpeRenovNorEFE & ")  AND SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nMontoDesemb End) , 0 ) SKRepre,  " _
    & " COUNT( CASE  WHEN T.cOpeCod IN(" & gColPOpeDesembolsoEFE & ")  THEN c.cCtaCod END )  As NumNuevo, " _
    & " Isnull(Sum ( CASE WHEN T.cOpeCod IN(" & gColPOpeDesembolsoEFE & ") AND SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nMontoDesemb/" & pnTipoCambio _
    & "                   WHEN T.cOpeCod IN(" & gColPOpeDesembolsoEFE & ") AND SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nMontoDesemb End) , 0 ) SKNuevo  " _
    & " From " & psServConsol & "CreditoConsol C  " _
    & " INNER JOIN MovCol T ON T.cCtaCod=C.cCtaCod    " _
    & " INNER Join Mov M on M.nMovNro=T.nMovNro  " _
    & " WHERE substring(M.cMovNro,1,8) BETWEEN '" & Format(pdFechaDesde, gsFormatoMovFecha) & "' AND '" & Format(pdFechaHasta, gsFormatoMovFecha) & " 23:59' " _
    & " AND T.cOpeCod IN(" & gColPOpeDesembolsoEFE & "," & gColPOpeRenovNorEFE & "," & gColPOpeRenovMorEFE & ")  " _
    & " AND T.nFLAG IS NULL  "
End If

Set rs = GetQuery(sql)
    If Not RSVacio(rs) Then
        lnNumOtorgPig = rs!NumOtorg
        lnTotOtorgPig = rs!SKOtorg
        lnNumReprePig = rs!NumRepre
        lnTotReprePig = rs!SKRepre
        lnNumNuevoPig = rs!NumNuevo
        lnTotNuevoPig = rs!SKNUevo
        lnNumRefinPig = 0
        lnTotRefinPig = 0

        lnFilTotNroCredD = lnFilTotNroCredD + rs!NumOtorg
        lnFilTotVolCredD = lnFilTotVolCredD + rs!SKOtorg
        lnFilTotNroRep = lnFilTotNroRep + rs!NumRepre
        lnFilTotVolRep = lnFilTotVolRep + rs!SKRepre
        lnFilTotNroNue = lnFilTotNroNue + rs!NumNuevo
        lnFilTotVolNue = lnFilTotVolNue + rs!SKNUevo
        lnFilTotNroRef = lnFilTotNroRef + 0
        lnFilTotVolRef = lnFilTotVolRef + 0
    End If
    Lineas(1) = Lineas(1) & ImpreFormat(lnTotOtorgPig, 15, 2, True)
    Lineas(2) = Lineas(2) & ImpreFormat(lnNumOtorgPig, 15, 2, True)

    Lineas(4) = Lineas(4) & ImpreFormat(lnTotReprePig, 15, 2, True)
    Lineas(5) = Lineas(5) & ImpreFormat(lnNumReprePig, 15, 2, True)

    Lineas(6) = Lineas(6) & ImpreFormat(lnTotNuevoPig, 15, 2, True)
    Lineas(7) = Lineas(7) & ImpreFormat(lnNumNuevoPig, 15, 2, True)

    Lineas(8) = Lineas(8) & ImpreFormat(lnTotRefinPig, 15, 2, True)
    Lineas(9) = Lineas(9) & ImpreFormat(lnNumRefinPig, 15, 2, True)

    rs.Close

    TotalPersonas = 0

sql = "SELECT  COUNT(PERSCUENTA.cPersCod) AS TOTALPERSONAS " _
    & " FROM " & psServConsol & "ProductoPersonaConsol PERSCUENTA INNER JOIN " & psServConsol & "CreditoConsol  ON " & psServConsol & "CreditoConsol.cCtaCod=PERSCUENTA.cCtaCod " _
    & " INNER JOIN MovCol TRANSPRENDA ON TRANSPRENDA.cCtaCod=" & psServConsol & "CreditoConsol.cCtaCod " _
    & " Inner Join Mov M on M.nMovNro= TRANSPRENDA.nMovNro " _
    & " WHERE substring(M.cMovNro,1,8) BETWEEN '" & Format(pdFechaDesde, gsFormatoMovFecha) & "' AND '" & Format(pdFechaHasta, gsFormatoMovFecha) & " 23:59' " _
    & " AND TRANSPRENDA.cOpeCod IN(" & gColPOpeDesembolsoEFE & ")  " _
    & " AND TRANSPRENDA.nFLAG IS NULL  AND PERSCUENTA.nPrdPersRelac = 20  "

Set rs1 = GetQuery(sql)
If Not RSVacio(rs1) Then
    TotalClientesPrendario = IIf(IsNull(rs1!TotalPersonas), 0, rs1!TotalPersonas)
    Lineas(3) = Lineas(3) & ImpreFormat(TotalClientesPrendario, 15, 2, True)
    lnFilTotClienteD = lnFilTotClienteD + TotalClientesPrendario
End If
rs1.Close
Set rs1 = Nothing

J = J + 4

'***** Imprimir *****
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(1) & ImpreFormat(lnFilTotVolCredD, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(2) & ImpreFormat(lnFilTotNroCredD, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(3) & ImpreFormat(lnFilTotClienteD, 15, 2, True) & Chr(10) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & "REPRESTAMOS" & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(4) & ImpreFormat(lnFilTotVolRep, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(5) & ImpreFormat(lnFilTotNroRep, 15, 2, True) & Chr(10) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & "CREDITOS NUEVOS" & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(6) & ImpreFormat(lnFilTotVolNue, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(7) & ImpreFormat(lnFilTotNroNue, 15, 2, True) & Chr(10) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & "CREDITOS REFINANCIADOS" & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(8) & ImpreFormat(lnFilTotVolRef, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(9) & ImpreFormat(lnFilTotNroRef, 15, 2, True) & Chr(10) & Chr(10)

J = J + 4

MontoTotal = 0
TotalCreditos = 0
RaiseEvent Progress(7, 10)
'*******************************************************************************
'************************* CREDITOS VIGENTES  ********************************
'*******************************************************************************

lsCadenaPrint = lsCadenaPrint & ReporteINFO1Cab(pdFechaDesde, pdFechaHasta, pnTipoCambio, True)
Dim lnFilTotNroCred As Long, lnFilTotVolCred As Currency, lnFilTotNroCli As Long
Dim lnFilTotMora1 As Currency, lnFilTotMora2 As Currency, lnFilTotMora3 As Currency
Dim lnFilTotMora4 As Currency, lnFilTotMora5 As Currency, lnFilTotMora0 As Currency

Lineas(10) = Lineas(10) & CadDerecha("Nº CREDITOS ", 20)
Lineas(11) = Lineas(11) & CadDerecha("VOLUMEN(US$)", 20)
Lineas(12) = Lineas(12) & CadDerecha("Nº DE CLIENTES", 20)

Lineas(13) = Lineas(13) & CadDerecha("1 - 7 DIAS ", 20)
Lineas(14) = Lineas(14) & CadDerecha("8 - 30 DIAS ", 20)
Lineas(15) = Lineas(15) & CadDerecha("MAYORES DE 30 DIAS ", 20)
Lineas(16) = Lineas(16) & CadDerecha("EN RECUPERACIONES ", 20)
Lineas(17) = Lineas(17) & CadDerecha("CARTERA CASTIGADA ", 20)
Lineas(18) = Lineas(18) & CadDerecha("<=0  DIAS ", 20)
Lineas(19) = Lineas(19) & CadDerecha("TOTAL DE ANALISTAS", 20)

For lnProd = 1 To 5

    sql = "SELECT Count( CASE WHEN ( C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") OR (C.nPrdEstado  in (" & gColocEstRecVigJud & ",2205) )) THEN C.cCtaCod  END ) NumCred ," _
        & " Isnull(Sum ( CASE  WHEN ( C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") OR (C.nPrdEstado IN (" & gColocEstRecVigJud & ",2205) )) AND SUBSTRING(C.cCtaCod,9,1)='1' THEN C.nSaldoCap/" & pnTipoCambio _
        & "                    WHEN ( C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") OR (C.nPrdEstado in (" & gColocEstRecVigJud & ",2205) )) AND SUBSTRING(C.cCtaCod,9,1)='2' THEN C.nSaldoCap  End ),  0 ) SKCred , " _
        & " COUNT( CASE  WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso <= 0  THEN c.cCtaCod END )  As NumMora0,  " _
        & " IsNull(SUM( CASE WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso <= 0 And  Substring(c.cCtaCod,9,1) ='1' THEN c.nSaldoCap /" & pnTipoCambio _
        & "                  WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso <= 0 And  Substring(c.cCtaCod,9,1) ='2' THEN c.nSaldoCap END ), 0 )  As SKMora0 , " _
        & " COUNT( CASE  WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso between 1 and 7  THEN c.cCtaCod END )  As NumMora1, " _
        & " IsNull(SUM( CASE WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso between 1 and 7 And  Substring(c.cCtaCod,9,1) ='1' THEN c.nSaldoCap  /" & pnTipoCambio _
        & "                  WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso between 1 and 7 And  Substring(c.cCtaCod,9,1) ='2' THEN c.nSaldoCap END ), 0 )  As SKMora1 , " _
        & " COUNT( CASE  WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso between 1 and 7  THEN c.cCtaCod END )  As NumMora2, " _
        & " IsNull(SUM( CASE WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso between 8 and 30 And  Substring(c.cCtaCod,9,1) ='1' THEN c.nSaldoCap /" & pnTipoCambio _
        & "                  WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso between 8 and 30 And  Substring(c.cCtaCod,9,1) ='2' THEN c.nSaldoCap END ), 0 )  As SKMora2 , " _
        & " COUNT( CASE  WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso between 8 and 30  THEN c.cCtaCod END )  As NumMora3, " _
        & " IsNull(SUM( CASE WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso > 30 And  Substring(c.cCtaCod,9,1) ='1' THEN c.nSaldoCap /" & pnTipoCambio _
        & "                  WHEN C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") And C.nDiasAtraso > 30 And  Substring(c.cCtaCod,9,1) ='2' THEN c.nSaldoCap END ), 0 )  As SKMora3 , " _
        & " COUNT( CASE  WHEN C.nPrdEstado in (" & gColocEstRecVigJud & ")  THEN c.cCtaCod END )  As NumMora4, " _
        & " IsNull(SUM( CASE WHEN C.nPrdEstado in (" & gColocEstRecVigJud & ",2205)  And Substring(c.cCtaCod,9,1) ='1' THEN c.nSaldoCap /" & pnTipoCambio _
        & "                  WHEN C.nPrdEstado in (" & gColocEstRecVigJud & ",2205)  And Substring(c.cCtaCod,9,1) ='2' THEN c.nSaldoCap END ), 0 )  As SKMora4 , " _
        & " COUNT( CASE  WHEN C.nPrdEstado in (" & gColocEstRecVigJud & ",2205)     THEN c.cCtaCod END )  As NumMora5, " _
        & " IsNull(SUM( CASE WHEN C.nPrdEstado in (" & 2202 & ",2206)    And Substring(c.cCtaCod,9,1) ='1' THEN c.nSaldoCap /" & pnTipoCambio _
        & "                  WHEN C.nPrdEstado in (" & 2202 & ",2206)   And Substring(c.cCtaCod,9,1) ='2' THEN c.nSaldoCap END ), 0 )  As SKMora5  " _
        & " From " & psServConsol & "CreditoConsol C " _
        & " WHERE SUBSTRING(C.cCtaCod,6,3) IN " & lsProduc(lnProd) _
        & "  AND   C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & "," & gColocEstRecVigJud & ",2205,2202,2206) " _
        & "  AND C.nSaldoCap > 0  "


    lnTotCred = 0: lnNumcred = 0
    lnTotMora1 = 0: lnNumMora1 = 0
    lnTotMora2 = 0: lnNumMora2 = 0
    lnTotMora3 = 0: lnNumMora3 = 0
    lnTotMora4 = 0: lnNumMora4 = 0
    lnTotMora0 = 0: lnNumMora0 = 0

    Set rs = GetQuery(sql)
    If Not RSVacio(rs) Then
        lnNumcred = rs!NumCred
        lnTotCred = IIf(IsNull(rs!SKCred), 0, rs!SKCred)
        lnNumMora1 = rs!NumMora1
        lnTotMora1 = IIf(IsNull(rs!SKmora1), 0, rs!SKmora1)
        lnNumMora2 = rs!NumMora2
        lnTotMora2 = IIf(IsNull(rs!SKMora2), 0, rs!SKMora2)
        lnNumMora3 = rs!NumMora3
        lnTotMora3 = IIf(IsNull(rs!SKMora3), 0, rs!SKMora3)
        lnNumMora4 = rs!NumMora4
        lnTotMora4 = IIf(IsNull(rs!SKMora4), 0, rs!SKMora4)
        lnNumMora5 = rs!NumMora5
        lnTotMora5 = IIf(IsNull(rs!SKMora5), 0, rs!SKMora5)
        lnNumMora0 = rs!NumMora0
        lnTotMora0 = IIf(IsNull(rs!SKMora0), 0, rs!SKMora0)

        lnFilTotNroCred = lnFilTotNroCred + lnNumcred
        lnFilTotVolCred = lnFilTotVolCred + lnTotCred
        lnFilTotMora1 = lnFilTotMora1 + lnTotMora1
        lnFilTotMora2 = lnFilTotMora2 + lnTotMora2
        lnFilTotMora3 = lnFilTotMora3 + lnTotMora3
        lnFilTotMora4 = lnFilTotMora4 + lnTotMora4
        lnFilTotMora5 = lnFilTotMora5 + lnTotMora5
        lnFilTotMora0 = lnFilTotMora0 + lnTotMora0

    End If
    rs.Close
        
    sSQLRH = "select count(*) as nCantidad "
    sSQLRH = sSQLRH & "FROM RHCARGOS RC1, RRHH RH, PERSONA P, RHCONTRATO RT1,AREAS A,RHCARGOSTABLA RA, AGENCIAS AG"
    sSQLRH = sSQLRH & " Where"
    sSQLRH = sSQLRH & " RC1.cPersCod = RH.cPersCod"
    sSQLRH = sSQLRH & " AND RT1.cperscod =RC1.cperscod"
    sSQLRH = sSQLRH & " AND P.cperscod =  rc1.cperscod"
    sSQLRH = sSQLRH & " AND A.cAreaCod = RC1.cRHAreaCodOficial"
    sSQLRH = sSQLRH & " AND RA.cRHCargoCod = RC1.cRHCargoCodOficial"
    sSQLRH = sSQLRH & " AND RC1.cRHAgenciaCodOficial = AG.cAgeCod"
    sSQLRH = sSQLRH & " AND dRHCargoFecha = (SELECT MAX (dRHCargoFecha) FROM  RHCARGOS RC2 WHERE RC2.CPERSCOD = RC1.CPERSCOD)"
    sSQLRH = sSQLRH & " AND cRHContratoNro = (SELECT MAX (cRHContratoNro) FROM  RHCONTRATO RT2 WHERE RT2.CPERSCOD = RT1.CPERSCOD)"
    sSQLRH = sSQLRH & " AND  SUBSTRING(cRHCod,1,1) IN ('E','P')"
    sSQLRH = sSQLRH & " AND NRHESTADO NOT LIKE  '8%' and substring(RA.cRHCargoCod,1,3) in ('004')"
 
    Set rsRH = GetQuery(sSQLRH)
    If Not rsRH.EOF And Not rsRH.BOF Then
        nCantAnalistas = rsRH!nCantidad
    End If
    Set rsRH = Nothing
    
    
    Lineas(10) = Lineas(10) & ImpreFormat(lnNumcred, 15, 2, True)
    Lineas(11) = Lineas(11) & ImpreFormat(lnTotCred, 15, 2, True)

    Lineas(13) = Lineas(13) & ImpreFormat(lnTotMora1, 15, 2, True)
    Lineas(14) = Lineas(14) & ImpreFormat(lnTotMora2, 15, 2, True)
    Lineas(15) = Lineas(15) & ImpreFormat(lnTotMora3, 15, 2, True)
    Lineas(16) = Lineas(16) & ImpreFormat(lnTotMora4, 15, 2, True)
   ' Lineas(17) = Lineas(17) & Space(15 - Len(Format(lnTotMora5, "#,#0.00"))) & Format(lnTotMora5, "#,#0.00")
    Lineas(17) = Lineas(17) & ImpreFormat(lnTotMora5, 15, 2, True)
    Lineas(18) = Lineas(18) & ImpreFormat(lnTotMora0, 15, 2, True)
    If lnProd = 1 Then
      Lineas(19) = Lineas(19) & ImpreFormat(nCantAnalistas, 15, 0, True)
    End If
    
    sql = "SELECT COUNT(Distinct(PERSCREDITO.cPersCod)) AS TOTALPERSONAS " _
        & " From " & psServConsol & "CreditoConsol c INNER JOIN " & psServConsol & "ProductoPersonaConsol PERSCREDITO ON PERSCREDITO.cCtaCod=C.cCtaCod " _
        & " WHERE (C.nPrdEstado in (" & lsCreditosVigentes & "," & lsPignoraticio & ") OR (C.nPrdEstado in (" & gColocEstRecVigJud & ",2205)))  " _
        & " AND PERSCREDITO.nPrdPersRelac =20 And C.nSaldoCap > 0 " _
        & " AND SUBSTRING(C.cCtaCod,6,3) IN " & lsProduc(lnProd)

    Set rs = GetQuery(sql)
    If Not RSVacio(rs) Then
        lnFilTotNroCli = lnFilTotNroCli + rs!TotalPersonas
        Lineas(12) = Lineas(12) & ImpreFormat(rs!TotalPersonas, 15, 2, True)
    End If
    rs.Close
    Set rs = Nothing
    
Next lnProd

J = J + 4
RaiseEvent Progress(10, 10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & "TOTAL" & Chr(27) & Chr(70) & Chr(10)

lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(10) & ImpreFormat(lnFilTotNroCred, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(11) & ImpreFormat(lnFilTotVolCred, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(12) & ImpreFormat(lnFilTotNroCli, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(10)

lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & "MORA(US$)" & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(13) & ImpreFormat(lnFilTotMora1, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(14) & ImpreFormat(lnFilTotMora2, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(15) & ImpreFormat(lnFilTotMora3, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(16) & ImpreFormat(lnFilTotMora4, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(17) & ImpreFormat(lnFilTotMora5, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(130, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(18) & ImpreFormat(lnFilTotMora0, 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(130, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Lineas(19) & Chr(10)
J = J + 4
Screen.MousePointer = 0
RaiseEvent CloseProgress
nRepo108801_ = lsCadenaPrint

End Function




Public Function nRepo108802_(ByVal psServConsol As String, ByVal pnTipoCambio As Double) As String
Dim sql As String
Dim rs As New ADODB.Recordset
Dim Total As Long
Dim i As Integer
Dim J As Long
Dim Total100(2) As Long
Dim Monto100(2) As Currency
Dim Total500(2) As Long
Dim Monto500(2) As Currency
Dim Total1000(2) As Long
Dim Monto1000(2) As Currency
Dim Total2000(2) As Long
Dim Monto2000(2) As Currency
Dim Total5000(2) As Long
Dim Monto5000(2) As Currency
Dim Total10000(2) As Long
Dim Monto10000(2) As Currency
Dim Total25000(2) As Long
Dim Monto25000(2) As Currency
Dim Total50000(2) As Long
Dim Monto50000(2) As Currency
Dim Total100000(2) As Long
Dim Monto100000(2) As Currency
Dim Total99999(2) As Long
Dim Monto99999(2) As Currency
Dim TotalCred(2) As Long
Dim TotalMontoCred(2) As Currency
Dim lsCadena As String
Dim lsCadenaPrint As String
'lsCadena = CadenaTipo
lsCadenaPrint = ""
Dim Tabula As Integer
Tabula = 10
lsCadenaPrint = ReporteInfo2Cab(pnTipoCambio)

'****************** ESTRATIFICACION POR MONTOS **************************************
For i = 0 To 1
    Total500(i) = 0: Monto500(i) = 0: Total1000(i) = 0: Monto1000(i) = 0: Total2000(i) = 0: Monto2000(i) = 0: Total5000(i) = 0
    Monto5000(i) = 0: Total10000(i) = 0: Monto10000(i) = 0: Total25000(i) = 0: Monto25000(i) = 0: Total99999(i) = 0: Monto99999(i) = 0
    TotalCred(i) = 0: TotalMontoCred(i) = 0
Next i
RaiseEvent ShowProgress
For i = 0 To 1
    If i = 0 Then
        sql = "SELECT C.cCtaCod,nSaldDispAC, nSaldCntAC," _
                & " MONTODEPOSITO = Isnull(CASE WHEN SUBSTRING(c.cCtaCod,9,1)='1' THEN C.nSaldCntAC /" & pnTipoCambio _
                & "                              WHEN SUBSTRING(c.cCtaCod,9,1)='2' THEN C.nSaldCntAC  END ,0) " _
                & " From " & psServConsol & "AhorroCConsol C " _
                & " WHERE C.nEstCtaAC not in (" & gCapEstAnulada & "," & gCapEstCancelada & ") "

    ElseIf i = 1 Then
        sql = "SELECT C.cCtaCod,nSaldCntPF," _
                & " MONTODEPOSITO = Isnull(CASE WHEN SUBSTRING(c.cCtaCod,9,1)='1' THEN C.nSaldCntPF /" & pnTipoCambio _
                & "                              WHEN SUBSTRING(c.cCtaCod,9,1)='2' THEN C.nSaldCntPF  END ,0) " _
                & " From " & psServConsol & "PlazoFijoConsol C " _
                & " WHERE C.nEstCtaPF not in (" & gCapEstAnulada & "," & gCapEstCancelada & ") "
        sql = sql & "UNION "
        sql = sql & "SELECT C.cCtaCod,nSaldCntCTS," _
                & " MONTODEPOSITO = Isnull(CASE WHEN SUBSTRING(c.cCtaCod,9,1)='1' THEN C.nSaldCntCTS /" & pnTipoCambio _
                & "                              WHEN SUBSTRING(c.cCtaCod,9,1)='2' THEN C.nSaldCntCTS  END ,0) " _
                & " From " & psServConsol & "CTSConsol C " _
                & " WHERE C.nEstCtaCTS not in (" & gCapEstAnulada & "," & gCapEstCancelada & ") "
    End If
    
    J = 0

    Set rs = GetQuery(sql)
    Total = rs.RecordCount
    If Not RSVacio(rs) Then
        Do While Not rs.EOF
            J = J + 1
            Select Case IIf(IsNull(rs!MontoDeposito), 0, rs!MontoDeposito)
                Case Is <= 100
                    Total100(i) = Total100(i) + 1
                    Monto100(i) = Monto100(i) + rs!MontoDeposito
                Case 100.01 To 500
                    Total500(i) = Total500(i) + 1
                    Monto500(i) = Monto500(i) + rs!MontoDeposito
                Case 500.01 To 1000
                    Total1000(i) = Total1000(i) + 1
                    Monto1000(i) = Monto1000(i) + rs!MontoDeposito
                Case 1000.01 To 2000
                    Total2000(i) = Total2000(i) + 1
                    Monto2000(i) = Monto2000(i) + rs!MontoDeposito
                Case 2000.01 To 5000
                    Total5000(i) = Total5000(i) + 1
                    Monto5000(i) = Monto5000(i) + rs!MontoDeposito
                Case 5000.01 To 10000
                    Total10000(i) = Total10000(i) + 1
                    Monto10000(i) = Monto10000(i) + rs!MontoDeposito
                Case 10000.01 To 25000
                    Total25000(i) = Total25000(i) + 1
                    Monto25000(i) = Monto25000(i) + rs!MontoDeposito
                Case 25000.01 To 50000
                    Total50000(i) = Total50000(i) + 1
                    Monto50000(i) = Monto50000(i) + rs!MontoDeposito
                Case 50000.01 To 100000
                    Total100000(i) = Total100000(i) + 1
                    Monto100000(i) = Monto100000(i) + rs!MontoDeposito
                Case Is > 100000
                    Total99999(i) = Total99999(i) + 1
                    Monto99999(i) = Monto99999(i) + rs!MontoDeposito
            End Select
            
            TotalCred(i) = TotalCred(i) + 1
            TotalMontoCred(i) = TotalMontoCred(i) + rs!MontoDeposito
            rs.MoveNext
        Loop
    End If
    rs.Close
    RaiseEvent Progress(CInt(i), 1)
Next i
RaiseEvent CloseProgress
Set rs = Nothing

lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("ESTRATIFICACION DE LOS DEPOSITOS", 100) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena("VOLUMEN(US$)", 30) & ImpreFormat(TotalMontoCred(0), 15, 2, True) & ImpreFormat(TotalMontoCred(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena("NRO CUENTAS", 30) & ImpreFormat(TotalCred(0), 15, 0, True) & ImpreFormat(TotalCred(1), 15, 0, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Space(35) & "          AHORRO                |          DEPOSITOS            | " & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Space(35) & "    NRO     |      VOLUMEN      |      NRO     |      VOLUMEN   | " & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha(" TOTAL       ", 30) & ImpreFormat(TotalCred(0), 15, 0, True) & ImpreFormat(TotalMontoCred(0), 15, 2, True) & ImpreFormat(TotalCred(1), 15, 2, True) & ImpreFormat(TotalMontoCred(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha(" 0     -   100 ", 30) & ImpreFormat(Total100(0), 15, 0, True) & ImpreFormat(Monto100(0), 15, 2, True) & ImpreFormat(Total100(1), 15, 2, True) & ImpreFormat(Monto100(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("101    -  500", 30) & ImpreFormat(Total500(0), 15, 0, True) & ImpreFormat(Monto500(0), 15, 2, True) & ImpreFormat(Total500(1), 15, 2, True) & ImpreFormat(Monto500(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("501    -  1,000", 30) & ImpreFormat(Total1000(0), 15, 0, True) & ImpreFormat(Monto1000(0), 15, 2, True) & ImpreFormat(Total1000(1), 15, 2, True) & ImpreFormat(Monto1000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("1,001  - 2,000", 30) & ImpreFormat(Total2000(0), 15, 0, True) & ImpreFormat(Monto2000(0), 15, 2, True) & ImpreFormat(Total2000(1), 15, 2, True) & ImpreFormat(Monto2000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("2,001  - 5,000", 30) & ImpreFormat(Total5000(0), 15, 0, True) & ImpreFormat(Monto5000(0), 15, 2, True) & ImpreFormat(Total5000(1), 15, 2, True) & ImpreFormat(Monto5000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("5,001  - 10,000", 30) & ImpreFormat(Total10000(0), 15, 0, True) & ImpreFormat(Monto10000(0), 15, 2, True) & ImpreFormat(Total10000(1), 15, 2, True) & ImpreFormat(Monto10000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("10,001 - 25,000", 30) & ImpreFormat(Total25000(0), 15, 0, True) & ImpreFormat(Monto25000(0), 15, 2, True) & ImpreFormat(Total25000(1), 15, 2, True) & ImpreFormat(Monto25000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("25,001 - 50,000", 30) & ImpreFormat(Total50000(0), 15, 0, True) & ImpreFormat(Monto50000(0), 15, 2, True) & ImpreFormat(Total50000(1), 15, 2, True) & ImpreFormat(Monto50000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("50,001 - 100,000", 30) & ImpreFormat(Total100000(0), 15, 0, True) & ImpreFormat(Monto100000(0), 15, 2, True) & ImpreFormat(Total100000(1), 15, 2, True) & ImpreFormat(Monto100000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha(" > 100,000", 30) & ImpreFormat(Total99999(0), 15, 0, True) & ImpreFormat(Monto99999(0), 15, 2, True) & ImpreFormat(Total99999(1), 15, 2, True) & ImpreFormat(Monto99999(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)

lsCadenaPrint = lsCadenaPrint & Chr(10)
nRepo108802_ = lsCadenaPrint
End Function




Public Function nRepo108803_(ByVal psServConsol As String, ByVal pnTipoCambio As Double, _
ByVal psCmac As String) As String
Dim sql As String
Dim rs As New ADODB.Recordset
Dim Total As Long
Dim i As Integer
Dim J As Long
Dim Total500(2) As Long
Dim Monto500(2) As Currency
Dim Total1000(2) As Long
Dim Monto1000(2) As Currency
Dim Total2000(2) As Long
Dim Monto2000(2) As Currency
Dim Total5000(2) As Long
Dim Monto5000(2) As Currency
Dim Total10000(2) As Long
Dim Monto10000(2) As Currency
Dim Total20000(2) As Long
Dim Monto20000(2) As Currency
Dim Total99999(2) As Long
Dim Monto99999(2) As Currency
Dim TotalCred(2) As Long
Dim TotalMontoCred(2) As Currency
Dim lsCadena As String

Dim Total3meses(2) As Long
Dim Monto3meses(2) As Currency
Dim Total6meses(2) As Long
Dim Monto6meses(2) As Currency
Dim Total12meses(2) As Long
Dim Monto12meses(2) As Currency
Dim Total24meses(2) As Long
Dim Monto24meses(2) As Currency
Dim Total99meses(2) As Long
Dim Monto99meses(2) As Currency

Dim TotalCapTrab(2) As Long
Dim MontoCaptrab(2) As Currency
Dim TotalOtrosDest(2) As Long
Dim MontoOtrosDest(2) As Currency

Dim Plazo As Long
Dim Sector As String

Dim TotalServicio(2) As Long
Dim MontoServicio(2) As Currency
Dim TotalComercio(2) As Long
Dim MontoComercio(2) As Currency
Dim TotalProduccion(2) As Long
Dim MontoProduccion(2) As Currency
Dim TotalAgro(2) As Long
Dim MontoAgro(2) As Currency

Dim lsCreditosVigentes As String
Dim lsPignoraticio As String
Dim lsCadenaPrint As String
Dim Tabula As Integer

lsCreditosVigentes = gColocEstVigNorm & "," & gColocEstVigMor & "," & gColocEstVigVenc & "," & gColocEstRefNorm & "," & gColocEstRefMor & "," & gColocEstRefVenc

If "102" = psCmac Then
    lsPignoraticio = " 2802,2803,2804, 2807 "
Else
    'lsPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
    lsPignoraticio = DevuelveCadenaEstadosPignoraticio 'ARCV 27-07
End If



lsCadenaPrint = ""
Tabula = 10
lsCadenaPrint = ReporteInfo3Cab(pnTipoCambio)

'****************** ESTRATIFICACION POR MONTOS **************************************
For i = 0 To 1
    Total500(i) = 0: Monto500(i) = 0: Total1000(i) = 0: Monto1000(i) = 0: Total2000(i) = 0: Monto2000(i) = 0: Total5000(i) = 0
    Monto5000(i) = 0: Total10000(i) = 0: Monto10000(i) = 0: Total20000(i) = 0: Monto20000(i) = 0: Total99999(i) = 0: Monto99999(i) = 0
    TotalCred(i) = 0: TotalMontoCred(i) = 0
    Total3meses(i) = 0:        Monto3meses(i) = 0
    Total6meses(i) = 0:        Monto6meses(i) = 0
    Total12meses(i) = 0:        Monto12meses(i) = 0
    Total24meses(i) = 0:        Monto24meses(i) = 0
    Total99meses(i) = 0:        Monto99meses(i) = 0   'MAYORES A 24 MESES
    TotalCapTrab(i) = 0: MontoCaptrab(i) = 0: TotalOtrosDest(i) = 0: MontoOtrosDest(i) = 0
    TotalServicio(i) = 0: MontoServicio(i) = 0: TotalComercio(i) = 0: MontoComercio(i) = 0: TotalProduccion(i) = 0
    MontoProduccion(i) = 0: TotalAgro(i) = 0: MontoAgro(i) = 0
Next i
RaiseEvent ShowProgress
For i = 0 To 1
    If psCmac = "108" Then
        If i = 0 Then
            lsCadena = " AND SUBSTRING (cCtaCod,6,3) in ('101','201') "
        ElseIf i = 1 Then
            lsCadena = " AND SUBSTRING (cCtaCod,6,3) in ('102','202') "
        End If
    Else
        If i = 0 Then
            lsCadena = " AND SUBSTRING (cCtaCod,6,3) in ('101','201') "
        ElseIf i = 1 Then
            lsCadena = " AND SUBSTRING (cCtaCod,6,3) in ('XXX') "
        End If
    End If
    
    
    
    J = 0
'    sql = "SELECT C.cCtaCod,C.NMONTODESEMB,C.NPLAZOAPR," _
'            & " C.NCUOTASAPR,C.nDESTCRE,C.nPrdESTADO,C.CNUMFUENTE," _
'            & "'MONTODESEMB' = Isnull(CASE WHEN SUBSTRING(c.cCtaCod,6,1)='1' THEN C.NMONTODESEMB/" & pnTipoCambio _
'            & "                            WHEN SUBSTRING(c.cCtaCod,6,1)='2' THEN C.NMONTODESEMB  END ,0) " _
'            & "From " & psServConsol & "CreditoConsol C " _
'            & "WHERE (C.nPrdESTADO in (" & lsCreditosVigentes & "," & lsPignoraticio & ") OR (C.nPrdESTADO =" & gColocEstRecVigJud & ") ) " _
'            & "AND C.nSaldoCap > 0  " & lsCadena


sql = "SELECT C.cCtaCod,C.nSaldoCap,C.NPLAZOAPR," _
            & " C.NCUOTASAPR,C.nDESTCRE,C.nPrdESTADO,C.CNUMFUENTE," _
            & "'MONTODESEMB' = Isnull(CASE WHEN SUBSTRING(c.cCtaCod,9,1)='1' THEN C.nSaldoCap/" & pnTipoCambio _
            & "                            WHEN SUBSTRING(c.cCtaCod,9,1)='2' THEN C.nSaldoCap  END ,0) " _
            & "From " & psServConsol & "CreditoConsol C " _
            & "WHERE (C.nPrdESTADO in (" & lsCreditosVigentes & "," & lsPignoraticio & ") OR (C.nPrdESTADO in(" & gColocEstRecVigJud & ",2205)) ) " _
            & "AND C.nSaldoCap > 0  " & lsCadena


    Set rs = GetQuery(sql)
    Total = rs.RecordCount
    
    If Not RSVacio(rs) Then
        Do While Not rs.EOF
            J = J + 1
            Select Case IIf(IsNull(rs!MontoDesemb), 0, rs!MontoDesemb)
                Case Is <= 500
                    Total500(i) = Total500(i) + 1
                    Monto500(i) = Monto500(i) + rs!MontoDesemb
                Case 501 To 1000
                    Total1000(i) = Total1000(i) + 1
                    Monto1000(i) = Monto1000(i) + rs!MontoDesemb
                Case 1001 To 2000
                    Total2000(i) = Total2000(i) + 1
                    Monto2000(i) = Monto2000(i) + rs!MontoDesemb
                Case 2001 To 5000
                    Total5000(i) = Total5000(i) + 1
                    Monto5000(i) = Monto5000(i) + rs!MontoDesemb
                Case 5001 To 10000
                    Total10000(i) = Total10000(i) + 1
                    Monto10000(i) = Monto10000(i) + rs!MontoDesemb
                Case 10001 To 20000
                    Total20000(i) = Total20000(i) + 1
                    Monto20000(i) = Monto20000(i) + rs!MontoDesemb
                Case Is > 20000
                    Total99999(i) = Total99999(i) + 1
                    Monto99999(i) = Monto99999(i) + rs!MontoDesemb
            End Select
            '****************** ESTRATIFICACION POR PLAZOS **************************************
            Plazo = IIf(rs!nPlazoApr = 0, 30, IIf(IsNull(rs!nPlazoApr), 0, rs!nPlazoApr)) * IIf(IsNull(rs!nCuotasApr), 0, rs!nCuotasApr)

            Select Case Plazo
                Case Is < 120       ' 3 meses
                    Total3meses(i) = Total3meses(i) + 1
                    Monto3meses(i) = Monto3meses(i) + rs!MontoDesemb
                Case 120 To 279     '4 a 6 meses
                    Total6meses(i) = Total6meses(i) + 1
                    Monto6meses(i) = Monto6meses(i) + rs!MontoDesemb
                Case 210 To 389     '7 a 12 meses
                    Total12meses(i) = Total12meses(i) + 1
                    Monto12meses(i) = Monto12meses(i) + rs!MontoDesemb
                Case 290 To 749     '13 a 24 meses
                    Total24meses(i) = Total24meses(i) + 1
                    Monto24meses(i) = Monto24meses(i) + rs!MontoDesemb
                Case Is > 750       'mayor a 24 meses
                    Total99meses(i) = Total99meses(i) + 1
                    Monto99meses(i) = Monto99meses(i) + rs!MontoDesemb
            End Select


            '****************** ESTRATIFICACION POR SECTORES **************************************
            Sector = Trim(SectorEconomico(psServConsol, Trim(IIf(IsNull(rs!cNumFuente), "00053664", rs!cNumFuente))))
            Select Case Sector
                'Case "S", "X", "E"
                Case "S"
                    TotalServicio(i) = TotalServicio(i) + 1
                    MontoServicio(i) = MontoServicio(i) + rs!MontoDesemb
                'Case "C", "R"
                Case "C"
                    TotalComercio(i) = TotalComercio(i) + 1
                    MontoComercio(i) = MontoComercio(i) + rs!MontoDesemb
                'Case "I", "M", "Q", "P"
                Case "N"
                    TotalProduccion(i) = TotalProduccion(i) + 1
                    MontoProduccion(i) = MontoProduccion(i) + rs!MontoDesemb
                Case "A"
                    TotalAgro(i) = TotalAgro(i) + 1
                    MontoAgro(i) = MontoAgro(i) + rs!MontoDesemb
            End Select

            '****************** DESTINO DEL CreditoConsol **************************************
            Select Case Trim(rs!nDestCre)
                Case 1       ' Capital de Trabajo
                    TotalCapTrab(i) = TotalCapTrab(i) + 1
                    MontoCaptrab(i) = MontoCaptrab(i) + rs!MontoDesemb
                Case Else
                    TotalOtrosDest(i) = TotalOtrosDest(i) + 1
                    MontoOtrosDest(i) = MontoOtrosDest(i) + rs!MontoDesemb
            End Select
            TotalCred(i) = TotalCred(i) + 1
            TotalMontoCred(i) = TotalMontoCred(i) + rs!MontoDesemb
            'Me.Barra.value = Int(J / Total * 100)
            rs.MoveNext
            'DoEvents
        Loop
    End If
    rs.Close
    RaiseEvent Progress(CInt(i), 2)
Next i
RaiseEvent Progress(2, 2)
RaiseEvent CloseProgress
Set rs = Nothing

lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("ESTRATIFICACION POR MONTOS", 100) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("TOTAL", 29) & ImpreFormat(TotalCred(0), 15, 0, True) & ImpreFormat(TotalMontoCred(0), 15, 2, True) & ImpreFormat(TotalCred(1), 15, 2, True) & ImpreFormat(TotalMontoCred(1), 15, 2, True) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("HASTA 500", 30) & ImpreFormat(Total500(0), 15, 0, True) & ImpreFormat(Monto500(0), 15, 2, True) & ImpreFormat(Total500(1), 15, 2, True) & ImpreFormat(Monto500(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("DE 501 A 1,000", 30) & ImpreFormat(Total1000(0), 15, 0, True) & ImpreFormat(Monto1000(0), 15, 2, True) & ImpreFormat(Total1000(1), 15, 2, True) & ImpreFormat(Monto1000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("DE 1,001 A 2,000", 30) & ImpreFormat(Total2000(0), 15, 0, True) & ImpreFormat(Monto2000(0), 15, 2, True) & ImpreFormat(Total2000(1), 15, 2, True) & ImpreFormat(Monto2000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("DE 2,001 A 5,000", 30) & ImpreFormat(Total5000(0), 15, 0, True) & ImpreFormat(Monto5000(0), 15, 2, True) & ImpreFormat(Total5000(1), 15, 2, True) & ImpreFormat(Monto5000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("DE 5,001 A 10,000", 30) & ImpreFormat(Total10000(0), 15, 0, True) & ImpreFormat(Monto10000(0), 15, 2, True) & ImpreFormat(Total10000(1), 15, 2, True) & ImpreFormat(Monto10000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("DE 10,001 A 20,000", 30) & ImpreFormat(Total20000(0), 15, 0, True) & ImpreFormat(Monto20000(0), 15, 2, True) & ImpreFormat(Total20000(1), 15, 2, True) & ImpreFormat(Monto20000(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("MAYOR A 20,000", 30) & ImpreFormat(Total99999(0), 15, 0, True) & ImpreFormat(Monto99999(0), 15, 2, True) & ImpreFormat(Total99999(1), 15, 2, True) & ImpreFormat(Monto99999(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)

lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("ESTRATIFICACION POR PLAZOS", 100) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("TOTAL", 29) & ImpreFormat(TotalCred(0), 15, 0, True) & ImpreFormat(TotalMontoCred(0), 15, 2, True) & ImpreFormat(TotalCred(1), 15, 2, True) & ImpreFormat(TotalMontoCred(1), 15, 2, True) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("HASTA 3 MESES", 30) & ImpreFormat(Total3meses(0), 15, 0, True) & ImpreFormat(Monto3meses(0), 15, 2, True) & ImpreFormat(Total3meses(1), 15, 2, True) & ImpreFormat(Monto3meses(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("DE 4 A 6 MESES", 30) & ImpreFormat(Total6meses(0), 15, 0, True) & ImpreFormat(Monto6meses(0), 15, 2, True) & ImpreFormat(Total6meses(1), 15, 2, True) & ImpreFormat(Monto6meses(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("DE 7 A 12 MESES", 30) & ImpreFormat(Total12meses(0), 15, 0, True) & ImpreFormat(Monto12meses(0), 15, 2, True) & ImpreFormat(Total12meses(1), 15, 2, True) & ImpreFormat(Monto12meses(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("DE 13 A 24 MESES", 30) & ImpreFormat(Total24meses(0), 15, 0, True) & ImpreFormat(Monto24meses(0), 15, 2, True) & ImpreFormat(Total24meses(1), 15, 2, True) & ImpreFormat(Monto24meses(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("MAS DE 24 MESES", 30) & ImpreFormat(Total99meses(0), 15, 0, True) & ImpreFormat(Monto99meses(0), 15, 2, True) & ImpreFormat(Total99meses(1), 15, 2, True) & ImpreFormat(Monto99meses(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)

lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("ESTRATIFICACION POR SECTORES", 100) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("TOTAL", 29) & ImpreFormat(TotalCred(0), 15, 0, True) & ImpreFormat(TotalMontoCred(0), 15, 2, True) & ImpreFormat(TotalCred(1), 15, 2, True) & ImpreFormat(TotalMontoCred(1), 15, 2, True) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("SERVICIO", 30) & ImpreFormat(TotalComercio(0), 15, 0, True) & ImpreFormat(MontoComercio(0), 15, 2, True) & ImpreFormat(TotalAgro(1), 15, 2, True) & ImpreFormat(MontoAgro(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("COMERCIO", 30) & ImpreFormat(TotalServicio(0), 15, 0, True) & ImpreFormat(MontoServicio(0), 15, 2, True) & ImpreFormat(TotalComercio(1), 15, 2, True) & ImpreFormat(MontoComercio(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("PRODUCCION(NO AGROP.)", 30) & ImpreFormat(TotalProduccion(0), 15, 0, True) & ImpreFormat(MontoProduccion(0), 15, 2, True) & ImpreFormat(TotalProduccion(1), 15, 2, True) & ImpreFormat(MontoProduccion(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("PRODUCCION AGROPECU.", 30) & ImpreFormat(TotalAgro(0), 15, 0, True) & ImpreFormat(MontoAgro(0), 15, 2, True) & ImpreFormat(TotalServicio(1), 15, 2, True) & ImpreFormat(MontoServicio(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)

lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("DESTINO DEL CREDITO", 100) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("TOTAL", 29) & ImpreFormat(TotalCred(0), 15, 0, True) & ImpreFormat(TotalMontoCred(0), 15, 2, True) & ImpreFormat(TotalCred(1), 15, 2, True) & ImpreFormat(TotalMontoCred(1), 15, 2, True) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("INVERSIONES(ACT. FIJO)", 30) & ImpreFormat(TotalOtrosDest(0), 15, 0, True) & ImpreFormat(MontoOtrosDest(0), 15, 2, True) & ImpreFormat(TotalOtrosDest(1), 15, 2, True) & ImpreFormat(MontoOtrosDest(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CadDerecha("CAPITAL DE TRABAJO", 30) & ImpreFormat(TotalCapTrab(0), 15, 0, True) & ImpreFormat(MontoCaptrab(0), 15, 2, True) & ImpreFormat(TotalCapTrab(1), 15, 2, True) & ImpreFormat(MontoCaptrab(1), 15, 2, True) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)

lsCadenaPrint = lsCadenaPrint & Chr(10)
nRepo108803_ = lsCadenaPrint
End Function

Private Function SectorEconomico(ByVal psServerConsol As String, ByVal lsNumfuente As String) As String
Dim sql As String
Dim cCiiu As String
Dim rs As New ADODB.Recordset

'Modificado JHVP 06.02.2005

'sql = "Select cSector from " & psServerConsol & "FuenteIngresoconsol where cNumfuente='" & lsNumfuente & "'"

sql = "Select P.cPersCIIU "
sql = sql & " From Persona P "
sql = sql & "     Inner Join PersFteIngreso PFI"
sql = sql & "         On P.cPersCod=PFI.cPersFIPersCod"
sql = sql & " Where PFI.cNumFuente='" & lsNumfuente & "' "

Set rs = GetQuery(sql)
If Not RSVacio(rs) Then
    If Len(Trim(rs!cPersCiiu)) > 0 Then
        cCiiu = rs!cPersCiiu
    Else
        cCiiu = ""
    End If
Else
    cCiiu = ""
End If
rs.Close
Set rs = Nothing

'SIAFT
'Case I = 1
'    lsDescInfo = 'SERVICIOS'
'    lsCondicion1 = " (LEFT(cCodAct,2)$'00,22' OR LEFT(cCodAct,1) $ '4,6,7,8,9') "
'Case I = 2
'    lsDescInfo = 'COMERCIO'
'    lsCondicion1 = " LEFT(cCodAct,1)$'5' "
'Case I = 3
'    lsDescInfo = 'PRODUCCION (NO AGRICOLA)'
'    lsCondicion1 = " (LEFT(cCodAct,1) $ '1,3' OR LEFT(cCodAct,2) $ '05,20,21,23,24,25,26,27,28,29') "
'Case I = 4
'    lsDescInfo = 'PRODUCCION AGROPECUARIA'
'    lsCondicion1 = " LEFT(cCodAct,2) $ '01' "
'Fin SIAFT

If Left(cCiiu, 2) = "00" Or Left(cCiiu, 2) = "22" Or Left(cCiiu, 1) = "4" Or Left(cCiiu, 1) = "6" _
    Or Left(cCiiu, 1) = "7" Or Left(cCiiu, 1) = "8" Or Left(cCiiu, 1) = "9" Then
        SectorEconomico = "S"
ElseIf Left(cCiiu, 1) = "5" Then
    SectorEconomico = "C"
ElseIf Left(cCiiu, 1) = "1" Or Left(cCiiu, 1) = "3" Or Left(cCiiu, 2) = "05" Or Left(cCiiu, 2) = "20" _
    Or Left(cCiiu, 2) = "21" Or Left(cCiiu, 2) = "23" Or Left(cCiiu, 2) = "24" Or Left(cCiiu, 2) = "25" _
    Or Left(cCiiu, 2) = "26" Or Left(cCiiu, 2) = "27" Or Left(cCiiu, 2) = "28" Or Left(cCiiu, 2) = "29" Then
        SectorEconomico = "N"
ElseIf Left(cCiiu, 2) = "01" Then
    SectorEconomico = "A"
Else
    SectorEconomico = "C"
End If


End Function
Private Function ReporteInfo3Cab(ByVal nTipoCambio As Double) As String
Dim Titulo As String
Dim lsCadenaPrint As String
Dim Tabula As Integer
Tabula = 10
    'If chkTipo(2).Value = 1 Then
    '    TITULO = " C R E D I T O   P E R S O N A L"
    'Else
        Titulo = " C R E D I T O   E M P R E S A R I A L"
    'End If
    lsCadenaPrint = lsCadenaPrint & "."
    lsCadenaPrint = lsCadenaPrint & Space(Tabula - 1) & gsNomCmac & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("R E P O R T E   I N F O 3", 100) & Chr(27) & Chr(70) & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena("(En Moneda Extranjera)", 100) & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "INFORMACION AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "T.C.F. :" & Format(nTipoCambio, "#,#0.000") & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena(Titulo, 100) & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Space(35) & "Nº CREDITOS | MONT. INICIALES   |  Nº CREDITOS | MONT. INICIALES  " & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Space(35) & " VIGENTES   | CRED. VIGENTES    |    VIGENTES  | CRED. VIGENTES   " & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Space(35) & "   PYME     |     (US $)        |   AGRICOLAS  |     (US $)       " & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
    'lsCadenaPrint = lsCadenaPrint & Chr(10)
ReporteInfo3Cab = lsCadenaPrint
End Function
Private Function ReporteInfo4Cab(nTipoCambio As Double) As String
Dim Titulo As String
Dim lsCadenaPrint As String
Dim Tabula As Integer
Tabula = 10
Titulo = " C R E D I T O   E M P R E S A R I A L"
lsCadenaPrint = lsCadenaPrint & "."
lsCadenaPrint = lsCadenaPrint & Space(Tabula - 1) & gsNomCmac & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("R E P O R T E   I N F O 4", 100) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena("(En Moneda Extranjera)", 100) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "INFORMACION AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "T.C.F. :" & Format(nTipoCambio, "#,#0.000") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena(Titulo, 100) & Chr(27) & Chr(70) & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Space(30) & " CREDITO   PEQUEÑA EMPRESA   |     CREDITO    AGRICOLAS       | " & Chr(10)
lsCadenaPrint = lsCadenaPrint & Space(Tabula) & String(100, "-") & Chr(10)
ReporteInfo4Cab = lsCadenaPrint
End Function
Private Function ReporteInfo2Cab(ByVal nTipoCambio As Double) As String
Dim Titulo As String
Dim lsCadenaPrint As String
Dim Tabula As Integer
Tabula = 10
    Titulo = " "

    lsCadenaPrint = lsCadenaPrint & "."
    lsCadenaPrint = lsCadenaPrint & Space(Tabula - 1) & gsNomCmac & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & Chr(27) & Chr(69) & CentrarCadena("R E P O R T E   I N F O 2", 100) & Chr(27) & Chr(70) & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena("(En Moneda Extranjera)", 100) & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "INFORMACION AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & "T.C.F. :" & Format(nTipoCambio, "#,#0.000") & Chr(10)
    lsCadenaPrint = lsCadenaPrint & Space(Tabula) & CentrarCadena(Titulo, 100) & Chr(10)
    'lsCadenaPrint = lsCadenaPrint & Chr(10)
    ReporteInfo2Cab = lsCadenaPrint
End Function


Public Function CredPersVigentesSubCab()
Dim lsImp As String
lsImp = String(250, "-") & Chr(10)
lsImp = lsImp & Space(3) & "CREDITO" & Space(12) & "CLIENTE" & Space(26) & "INSTIT." & Space(2) & "F. DESEMB." & Space(6) & "PLAZO" & Space(6) & "M. APROBADO" & Space(4) & "S. CAPITAL" & Space(2) & "PRXCUOT" & Space(2) & "D. MORA" & Space(4) & "M. CUOTA" & Space(3) & "ULT. F. PAGO" & Space(6) & "INT. DEVENG." & Space(3) & "DEUDA TOT." & Space(2) & "CAP. VENC." & Space(2) & "CAP. X VENC." & Space(3) & "GAR. HIP." & Space(2) & "OTRAS GAR. Ref" & Chr(10)
lsImp = lsImp & String(250, "-") & Chr(10)
CredPersVigentesSubCab = lsImp
End Function

'ARCV 28-07-2006
Public Function RecuperaMatrizTipoProducto(ByVal psTipoprod As String, ByVal psCampo As String) As Variant
Dim sql As String
Dim rs As ADODB.Recordset
Dim MatTemp As Variant

sql = "Select Valor=" & psCampo & " FROM Constante WHERE nConsCod=1001 AND nConsValor<>nConsCod AND " & _
      " nConsValor<>'" & psTipoprod & "00' AND LEFT(nConsValor,1)='" & psTipoprod & "' ORDER BY nConsValor"
Set rs = GetQuery(sql)

ReDim MatTemp(rs.RecordCount)

While Not rs.EOF
    MatTemp(rs.Bookmark - 1) = rs!Valor
    rs.MoveNext
Wend
RecuperaMatrizTipoProducto = MatTemp
End Function

Public Function RecuperaCadenaTipoProducto(ByVal psTipoprod As String) As String
Dim sql As String
Dim rs As ADODB.Recordset
Dim lsCadena As String

sql = "Select nConsValor FROM Constante WHERE nConsCod=1001 AND nConsValor<>nConsCod AND " & _
      "nConsValor<>'" & psTipoprod & "00' AND LEFT(nConsValor,1)='" & psTipoprod & "' AND nConsValor <> 305"    'Excluimos el Producto Pignoraticio
Set rs = GetQuery(sql)

While Not rs.EOF
    lsCadena = lsCadena & rs!nConsValor & ","
    rs.MoveNext
Wend
If lsCadena <> "" Then lsCadena = Left(lsCadena, Len(lsCadena) - 1)

RecuperaCadenaTipoProducto = lsCadena
End Function

Public Function RecuperaTodoslosProductos() As Variant
Dim sql As String
Dim rs As ADODB.Recordset
Dim MatTemp As Variant

sql = "Select Valor=nConsValor FROM Constante WHERE nConsCod=1001 AND nConsValor<>nConsCod AND " & _
      "nConsValor NOT LIKE '_00' AND nConsValor<>'999'"
Set rs = GetQuery(sql)

ReDim MatTemp(rs.RecordCount)

While Not rs.EOF
    MatTemp(rs.Bookmark - 1) = rs!Valor
    rs.MoveNext
Wend
RecuperaTodoslosProductos = MatTemp

End Function

Private Function CabRepCarteraAgencia_Prod_NEW(pPag As Integer, pTipoCambio As Single, pPlanCuentas As String, _
            Optional pConcepto As String = "C", Optional pCodReporte As String) As String
'Crea la Cabecera de Impresión de los Saldos de cartera vigente en montos totales
Dim lsCad As String
'lsCad = lsCad & Chr(10)
lsCad = lsCad & sNomCmac & Space(110) & "Pagina: " & pPag & Chr(10)
lsCad = lsCad & Space(55) & pCodReporte & "-RESUMEN POR PRODUCTO Y AGENCIA AL " & Format(GetFechaCierreMes, "dd/mm/yyyy") & IIf(pConcepto = "D", "  ", "  ") & Chr(10)
lsCad = lsCad & "TCF = " & ImpreFormat(pTipoCambio, 3, 3) & Space(58) & IIf(pPlanCuentas = "1", "PLAN DE CUENTAS ACTUAL", "MANUAL DE CUENTAS") & Chr(10)
'lsCad = lsCad & Space(70) & "( EN NUEVOS SOLES )" & Chr(10)
'lsCad = lsCad & Chr(10)
lsCad = lsCad & String(130, "=") & Chr(10)
lsCad = lsCad & " AGENCIA" & Space(12) & " COMERCIAL  |" & Space(5) & "   MES     | " & Space(5) & " CONSUMO  | " & Space(5)
lsCad = lsCad & " PRENDARIO | " & Space(5) & " HIPOTEC   | " & "        AGRICOLA |" & "        TOTAL   |" & Chr(10)
lsCad = lsCad & String(130, "=") & Chr(10)
CabRepCarteraAgencia_Prod_NEW = lsCad
End Function

'ARCV 27-07-2006
Private Function DevuelveCadenaEstadosPignoraticio() As String
    DevuelveCadenaEstadosPignoraticio = gColPEstDesem & "," & gColPEstVenci & "," & gColPEstPRema & "," & gColPEstRenov
End Function


