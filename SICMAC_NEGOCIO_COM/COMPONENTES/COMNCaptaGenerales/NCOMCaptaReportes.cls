VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
  Persistable = 0  'NotPersistable
  DataBindingBehavior = 0  'vbNone
  DataSourceBehavior  = 0  'vbNone
  MTSTransactionMode  = 0  'NotAnMTSObject
END
Attribute VB_Name = "NCOMCaptaReportes"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = True
'Genera los registros de Firmas, las cartas de contrato y las constancias de
'plazo fijo, saca las plantillas de la base de datos de acuerdo a un codigo
'que se le envía
Option Base 0
'Option Explicit
Public oImp As COMFunciones.FCOMVarImpresion

Private lsNomAge As String
Private lsEmpresa As String
Private ldFecSis As Date
Private ldFecRepo As Date
Private lnRango As Integer
Private lsAgeCod As String
Private gsInstCmac As String
Private laMovDia() As String

Private lsRTFDat As String
Private i As Long
Private lnTotA02 As Currency
Private lnTotA03 As Currency
Private lnTotA04 As Currency
Private lnTotA05 As Currency
Private lnTotA06 As Currency
Private lnTotA07 As Currency
Private lnTotA08 As Currency
Private lnTotA09 As Currency
Private lnTotA10 As Currency
Private lnTotA11 As Currency
Private lnTotA12 As Currency
Private lnTotA13 As Currency
Private lnTotA14 As Currency
Private lnTotA15 As Currency


Private lsRTFRfm As String
Private lsReporte As String
Private lsMoneda As String
Private lsRTFSdo As String
Private lsPerson As String
Dim VSQL As String
Dim SalA As String
Dim NumA As String

Dim SalC As String
Dim NumC As String

Dim NumP As String
Dim SalP As String

Dim CA As Currency
Dim CAE As Currency
Dim TB As Currency
Dim TBD As Currency

Dim ImpSoles As String
Dim K As Integer
Dim DHora(50) As String
Dim tc(100) As String
Dim TCE(100) As String
Dim TV(100) As String
Dim TVE(100) As String

Dim lnTipoPigno As Integer
Dim RegCmacStemp As Integer


Public Event ProgresoBarra(ByVal i As Long, ByVal lsTitulo As String, ByVal lsSubtitulo As String)
Public Event IniciaBarra(ByVal lnTotal As Long)
Public Event FinalizaBarra()
Dim ofunf As New COMFunciones.FCOMVarPublicas


'By Capi 07082008
Public Function ImpExtractosBatch(ByVal sCodAge As String, ByVal psdfecsis As Date, ByVal dfechai As Date, ByVal dFechaf As Date, ByVal NomPrint As String, _
                                  ByVal gsCodUser As String, ByVal gsNomCmac As String, ByVal gsNomAge As String, Optional ByVal pcProducto As String = "", Optional ByVal pcCodInst As String = "", Optional ByVal pnAccion As Integer) As String


Dim rsCtas As ADODB.Recordset, rsPer As ADODB.Recordset, rsMov As ADODB.Recordset
Dim sCta As String

Set rsCtas = ReporteExtractoCuentas(dfechai, dFechaf, sCodAge, pcProducto, pcCodInst, pnAccion)



Dim sCadAux As String
Dim nCntPag As Integer
Dim sNumPag As String
Dim smen As String
Dim nSalinicial As Double
Dim sFechaIni As String
Dim lncontador As Integer
Dim sSaldoDisponible As String * 13
Dim sSaldoContable As String * 13
   

sCadAux = ""
sNumPag = ""
nCntPag = 0
smen = ""
    
Do While Not rsCtas.EOF
    Dim sCad As String, sMoneda As String
    Dim nCarLin As Integer, nLinPag As Integer
    Dim i As Integer, J As Integer
    Dim sOperacion As String * 28
    Dim sDocumento As String * 15
    Dim sDeposito As String * 13
    Dim sRetiro As String * 13
    Dim sSaldoCnt As String * 14
    Dim sAgencia  As String * 15
    Dim sTotAbono As String * 13
    Dim sTotCargo As String * 13
    Dim sInteresMes As String * 13
    Dim sTitRp1 As String, sTitRp2 As String
    Dim ntotabono As Double, ntotCargo As Double, nDisp As String, nConta As String
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim lcCuenta As String * 18
    

    sCad = ""
   
    nCarLin = 118
    nLinPag = 65

    sMoneda = IIf(Mid(rsCtas!cCtaCod, 9, 1) = gMonedaNacional, "SOLES", "DOLARES")
    sTitRp1 = Space(60) & "EXTRACTO DE CUENTA"
    sTitRp2 = Space(55) & "( DEL " & Format$(dfechai, "dd/MM/yyyy") & " AL " & Format$(dFechaf, "dd/MM/yyyy") & " )"

    

    lcCuenta = rsCtas!cCtaCod
    lncontador = lncontador + 1
    ntotabono = 0
    ntotCargo = 0
    Do While rsCtas!cCtaCod = lcCuenta
        If nLinPag > 58 Then
            If sNumPag <> "" Then
                sCad = sCad & String(130, "-") & oImp.gPrnSaltoLinea
                sCad = sCad & gsCodUser
                'sCad = sCad & oImp.gPrnSaltoPagina
            End If
            sNumPag = ofunc.FillNum(Trim(nCntPag), 4, " ")
            sCad = sCad & oImp.gPrnCondensadaON
            sCad = sCad & oImp.gPrnSaltoLinea                                                                                                                    'ncarlin
            nCntPag = nCntPag + 1
            sCad = sCad & ofuni.CabeRepo(gsNomCmac, gsNomAge, " SECCION AHORROS ", sMoneda, Format$(psdfecsis, "dd/mm/yyyy"), sTitRp1, sTitRp2, "", "", nCntPag, 80, 0, oImp, True) & oImp.gPrnSaltoLinea
            sCad = sCad & String(130, "-") & oImp.gPrnSaltoLinea
            sCad = sCad & "Cuenta No. :   " & oImp.gPrnNegritaON & rsCtas!cCtaCod & oImp.gPrnNegritaOFF & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
            sCad = sCad & "CLIENTE" & Space(51) & "RELACION" & Space(13) & "DIRECCION" & oImp.gPrnSaltoLinea
            Set rsPer = DatosCtasPer(rsCtas!cCtaCod)
            While Not rsPer.EOF
                sCad = sCad & Left(Trim(rsPer!cpersnombre), 50) & Space(60 - Len(Left(Trim(rsPer!cpersnombre), 50))) & Trim(rsPer!Relacion) & Space(20 - Left(Len(Trim(rsPer!Relacion)), 15)) & Trim(rsPer!Direccion) & " " & Left(Trim(rsPer!cubigeodes), 20) & oImp.gPrnSaltoLinea
                rsPer.MoveNext
            Wend
            If pnAccion <> 1 Then
            If rsCtas!institucion <> "" Then
                sCad = sCad & "Institucion..: " & rsCtas!institucion
            End If
            End If
            'sCad = sCad & Space(30) & "------------------------" & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
                        
             
             sCad = sCad & oImp.gPrnSaltoLinea
             sFechaIni = Format$(dfechai, "dd/MM/yyyy")
             If lncontador = 1 Then
                nSalinicial = rsCtas!nSaldoContable + Abs(rsCtas!nCargo) - rsCtas!nAbono
                sCad = sCad & "SALDO AL " & sFechaIni & " : " & Format(nSalinicial, "###,###,###.##") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
             End If
             
             sCad = sCad & String(130, "-") & oImp.gPrnSaltoLinea
            'sCad = sCad & Space(30) & "  SALDO " & oImp.gPrnSaltoLinea
             sCad = sCad & Space(93) & "  SALDO " & oImp.gPrnSaltoLinea
             sCad = sCad & "      FECHAS        "
             sCad = sCad & "     TIPO DE OPERACION      "
             sCad = sCad & "   DOCUMENTO"
             sCad = sCad & "      DEPOSITOS   "
             sCad = sCad & "    RETIROS    "
             sCad = sCad & "CONTABLE "
             sCad = sCad & "   AGENCIA         "
             sCad = sCad & "USUARIO" & oImp.gPrnSaltoLinea
             sCad = sCad & String(130, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
             nLinPag = 21
             If (nCntPag Mod 3) = 0 Then
               sCadAux = sCadAux & sCad
               sCad = ""
             End If
        End If
        
        sCad = sCad & rsCtas!fecha & " "
        sOperacion = rsCtas!Operacion & " "
        sDocumento = rsCtas!cDocumento & " "
        RSet sDeposito = rsCtas!nAbono & " "
        RSet sRetiro = rsCtas!nCargo & " "
        RSet sSaldoCnt = rsCtas!nSaldoContable & " "
        sAgencia = rsCtas!cAgencia & " "

        sCad = sCad & sOperacion
        sCad = sCad & sDocumento
        sCad = sCad & sDeposito
        sCad = sCad & sRetiro
        sCad = sCad & sSaldoCnt
        sCad = sCad & sAgencia
        sCad = sCad & Space(5) & rsCtas!cUsu & oImp.gPrnSaltoLinea
        nLinPag = nLinPag + 1
        sSaldoDisponible = rsCtas!nSaldoDisponible
        sSaldoContable = rsCtas!nSaldoContable
        ntotabono = ntotabono + rsCtas!nAbono
        ntotCargo = ntotCargo + rsCtas!nCargo
        rsCtas.MoveNext
        If rsCtas.EOF = True Then
            Exit Do
        End If
    Loop
    'By capi 11022009 para que regrese al registro anterior
    rsCtas.MovePrevious
    'End by
    lncontador = 0
    'ntotabono, ntotCargo, nDisp, nConta, nSalinicial, sFechaIni, smen
    RSet sTotAbono = ntotabono
    RSet sTotCargo = ntotCargo
    'RSet sSaldoDisponible = nDisp
    'RSet sSaldoContable = nConta
    'RSet sInteresMes = Format$(rsCtas!nIntAcum, "#,##0.00")
    sCad = sCad & String(130, "-") & oImp.gPrnSaltoLinea               ' hasta 160 caracteres x línea
    sCad = sCad & "  TOTAL    " & Space(52)
    sCad = sCad & sTotAbono & " "
    sCad = sCad & sTotCargo & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    If pcProducto = gCapCTS Then
        sCad = sCad & "SALDO DISPONIBLE RETIRO A FECHA DE EMISION " & Space(71) & sSaldoDisponible & oImp.gPrnSaltoLinea
        sCad = sCad & "SALDO CONTABLE                             " & Space(71) & sSaldoContable & oImp.gPrnSaltoLinea
    Else
        sCad = sCad & "SALDO DISPONIBLE  " & Space(71) & sSaldoDisponible & oImp.gPrnSaltoLinea
        sCad = sCad & "SALDO CONTABLE    " & Space(71) & sSaldoContable & oImp.gPrnSaltoLinea
    End If
        
    'sCad = sCad & Space(30) & "INTERÉS DEL MES   " & Space(71) & sInteresMes & oImp.gPrnSaltoLinea
'            If Mid(sCuenta, 6, 3) = Producto.gCapPlazoFijo Then
'                sCad = sCad & Space(30) & "INTERÉS PAGADO    " & Space(80) & Format(nIntPag, "#0.00") & oImp.gPrnSaltoLinea
'            End If
    sCad = sCad & String(130, "=") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
   ' sCad = sCad & Space(30) & rsCtas!Estado & oImp.gPrnSaltoLinea    '   & oImp.gPrnSaltoPagina
    sCad = sCad & String(130, "-") & oImp.gPrnSaltoLinea
    sCad = sCad & gsCodUser
    sCadAux = sCadAux & sCad & oImp.gPrnSaltoPagina

    'rsCtas.MoveNext
    If rsCtas.EOF = True Then
       Exit Do
    End If
    rsCtas.MoveNext

Loop
sCad = sCad & oImp.gPrnDblAnchoOFF

ImpExtractosBatch = sCadAux
Set ofuni = Nothing
Set ofinc = Nothing


End Function

''Public Function ImpExtractosBatch(ByVal sCodAge As String, ByVal psdfecsis As Date, ByVal dfechai As Date, ByVal dFechaf As Date, ByVal NomPrint As String, _
''                                  ByVal gsCodUser As String, ByVal gsNomCmac As String, ByVal gsNomAge As String) As String
'
'
'Dim rsCtas As ADODB.Recordset, rsPer As ADODB.Recordset, rsMov As ADODB.Recordset
'Dim sCta As String
'
'Set rsCtas = DatosCtas(sCodAge)
'
''*********Para Cuentas **************'
'
'While Not rsCtas.EOF
'    Dim sCad As String, sMoneda As String, sCadAux As String
'    Dim nCarLin As Integer, nLinPag As Integer, nCntPag As Integer
'    Dim i As Integer, J As Integer
'    Dim sOperacion As String * 28
'    Dim sDocumento As String * 15
'    Dim sDeposito As String * 13
'    Dim sRetiro As String * 13
'    Dim sSaldoCnt As String * 14
'    Dim sAgencia  As String * 15
'    Dim sTotAbono As String * 13
'    Dim sTotCargo As String * 13
'    Dim sSaldoDisponible As String * 13
'    Dim sSaldoContable As String * 13
'    Dim sInteresMes As String * 13
'    Dim sTitRp1 As String, sTitRp2 As String, sNumPag As String
'    Dim ntotabono As String, ntotCargo As String, nDisp As String, nConta As String, smen As String
'    Dim nSalinicial As String, sFechaIni As String
'    Dim ofuni As New COMFunciones.FCOMImpresion
'    Dim ofunc As New COMFunciones.FCOMCadenas
'
'
'    sCad = ""
'    sCadAux = ""
'    nCarLin = 118
'    nLinPag = 65
'
'    sMoneda = IIf(rsCtas!nMoneda = gMonedaNacional, "SOLES", "DOLARES")
'    sTitRp1 = Space(55) & "EXTRACTO DE CUENTA"
''        If optTipoBus(1).Value Then
''            sTitRp2 = Space(55) & "ÚLTIMOS " & Trim(txtNumMov) & " MOVIMIENTOS "
''        Else
''                    dfechai As Date, ByVal dFechaf
''
'    sTitRp2 = Space(55) & "( DEL " & Format$(dfechai, "dd/MM/yyyy") & " AL " & Format$(dFechaf, "dd/MM/yyyy") & " )"
''        End If
'    sNumPag = ""
'    nCntPag = 0
'    smen = ""
'    Set rsMov = DatosMov(rsCtas!cCtaCod, dfechai, dFechaf, ntotabono, ntotCargo, nDisp, nConta, nSalinicial, sFechaIni, smen)
'
''DatosMov(ByVal sCuenta As String, dFecini As Date, dFecFin As Date, ByRef lblTotAbono As String, ByRef lblTotCargo As String, ByRef lblSaldoDisponible As String, ByRef lblSaldoContable As String, ByRef lblSaldoInicial As String, ByRef lblFecSaldIni As String, Optional ByRef sMensaje As String = "")
'
'
'    While Not rsMov.EOF
'       With rsMov
'             If nLinPag > 58 Then
'
'                If sNumPag <> "" Then
'                    sCad = sCad & Space(30) & String(nCarLin, "-") & oImp.gPrnSaltoLinea
'                    sCad = sCad & Space(30) & gsCodUser
'                    'sCad = sCad & oImp.gPrnSaltoPagina
'                End If
'
'                sNumPag = ofunc.FillNum(Trim(nCntPag), 4, " ")
'                sCad = sCad & oImp.gPrnSaltoLinea                                                                                                                    'ncarlin
'                sCad = sCad & ofuni.CabeRepo(gsNomCmac, gsNomAge, " SECCION AHORROS ", sMoneda, Format$(psdfecsis, "dd/mm/yyyy"), sTitRp1, sTitRp2, "", "", nCntPag, 80, 0, oImp) & oImp.gPrnSaltoLinea
'                'nCntPag = nCntPag + 1
'                sCad = sCad & Space(30) & "Cuenta No. :   " & rsCtas!cCtaCod & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
'                sCad = sCad & Space(30) & "CLIENTE" & Space(52) & "RELACION" & Space(30) & "DIRECCION" & oImp.gPrnSaltoLinea
'
'                Set rsPer = DatosCtasPer(rsCtas!cCtaCod)
'
'                While Not rsPer.EOF
'                    sCad = sCad & Space(30) & Left(Trim(rsPer!cpersnombre), 50) & Space(60 - Len(Left(Trim(rsPer!cpersnombre), 50))) & Trim(rsPer!Relacion) & Space(20 - Left(Len(Trim(rsPer!Relacion)), 15)) & Trim(rsPer!Direccion) & " " & Left(Trim(rsPer!cubigeodes), 20) & oImp.gPrnSaltoLinea
'                    rsPer.MoveNext
'                Wend
'
'
'                    'sCad = sCad & Space(30) & "------------------------" & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
'                    sCad = sCad & Space(30) & "SALDO AL " & sFechaIni & " : " & ofunc.JDNum(nSalinicial, 12, True, 7, 2) & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
'                    sCad = sCad & Space(30) & String(nCarLin, "-") & oImp.gPrnSaltoLinea
'                    'sCad = sCad & Space(30) & "  SALDO " & oImp.gPrnSaltoLinea
'                    sCad = sCad & Space(121) & "  SALDO " & oImp.gPrnSaltoLinea
'                    sCad = sCad & Space(30) & "      FECHAS        "
'                    sCad = sCad & "     TIPO DE OPERACION      "
'                    sCad = sCad & "   DOCUMENTO"
'                    sCad = sCad & "      DEPOSITOS   "
'                    sCad = sCad & "    RETIROS    "
'                    sCad = sCad & "CONTABLE "
'                    sCad = sCad & "   AGENCIA" & oImp.gPrnSaltoLinea
'                    sCad = sCad & Space(30) & String(nCarLin, "-") & oImp.gPrnSaltoLinea            ' hasta 160 caracteres x línea
'                    nLinPag = 31
'                    If (nCntPag Mod 3) = 0 Then
'                        sCadAux = sCadAux & sCad
'                        sCad = ""
'                    End If
'             End If
'             sCad = sCad & Space(30) & !dFecha & " "
'             sOperacion = !cOperacion & " "
'             sDocumento = !cDocumento & " "
'             RSet sDeposito = !nabono & " "
'             RSet sRetiro = !ncargo & " "
'             RSet sSaldoCnt = !nSaldoContable & " "
'             sAgencia = !cAgencia & " "
'
'             sCad = sCad & sOperacion
'             sCad = sCad & sDocumento
'             sCad = sCad & sDeposito
'             sCad = sCad & sRetiro
'             sCad = sCad & sSaldoCnt
'             sCad = sCad & sAgencia & oImp.gPrnSaltoLinea
'             nLinPag = nLinPag + 1
'             rsMov.MoveNext
'       End With
'
'    Wend
'
'       'ntotabono, ntotCargo, nDisp, nConta, nSalinicial, sFechaIni, smen
'            RSet sTotAbono = ntotabono
'            RSet sTotCargo = ntotCargo
'            RSet sSaldoDisponible = nDisp
'            RSet sSaldoContable = nConta
'            RSet sInteresMes = Format$(rsCtas!nIntAcum, "#,##0.00")
'            sCad = sCad & Space(30) & String(nCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
'            sCad = sCad & Space(30) & "  TOTAL    " & Space(52)
'            sCad = sCad & sTotAbono & " "
'            sCad = sCad & sTotCargo & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
'            sCad = sCad & Space(30) & "SALDO DISPONIBLE  " & Space(71) & nDisp & oImp.gPrnSaltoLinea
'            sCad = sCad & Space(30) & "SALDO CONTABLE    " & Space(71) & nConta & oImp.gPrnSaltoLinea
'            sCad = sCad & Space(30) & "INTERÉS DEL MES   " & Space(71) & sInteresMes & oImp.gPrnSaltoLinea
''            If Mid(sCuenta, 6, 3) = Producto.gCapPlazoFijo Then
''                sCad = sCad & Space(30) & "INTERÉS PAGADO    " & Space(80) & Format(nIntPag, "#0.00") & oImp.gPrnSaltoLinea
''            End If
'            sCad = sCad & Space(30) & String(nCarLin, "=") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
'            sCad = sCad & Space(30) & rsCtas!Estado & oImp.gPrnSaltoLinea    '   & oImp.gPrnSaltoPagina
'            sCad = sCad & Space(30) & String(nCarLin, "-") & oImp.gPrnSaltoLinea
'            sCad = sCad & Space(30) & gsCodUser
'            sCadAux = sCadAux & sCad & oImp.gPrnSaltoPagina
'
'            rsCtas.MoveNext
'
'Wend
'        ImpExtractosBatch = sCadAux
'        Set ofuni = Nothing
'        Set ofinc = Nothing
'End Function

Private Function DatosCtas(ByVal sCodAge As String) As ADODB.Recordset
Dim sql As String, rsTemp As ADODB.Recordset, sqlaux As String
 Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion

If sCodAge = "" Then
    sqlaux = ""
Else
    
    sqlaux = " and p.cctacod like '109" & sCodAge & Producto.gCapAhorros & "%'"
End If

sql = " select titular=(select top 1 e.cpersnombre from persona e join productopersona pp  on pp.cperscod=e.cperscod where pp.nprdpersrelac=10 and  pp.cctacod=p.cctacod ) ,p.cctacod,nmoneda=cast(substring(p.cctacod,9,1) as integer) ,c.nintacum,estado=k.cconsdescripcion  " _
      & " from producto p " _
      & " join captaciones c on c.cctacod=p.cctacod " _
      & " join captacahorros ca on ca.cctacod=p.cctacod " _
      & " join (select cconsdescripcion,nconsvalor from constante where nconscod=2001)k on k.nconsvalor=p.nprdestado " _
      & " where p.nprdestado not in (1300,1400) " _
      & " and ca.bordpag=1 " & sqlaux _
      & " order by  titular "
      '& " order by p.cctacod "
      
    Set rsTemp = New ADODB.Recordset
    rsTemp.CursorLocation = adUseClient
    Set rsTemp = oCon.CargaRecordSet(sql)
    Set DatosCtas = rsTemp
    
    oCon.CierraConexion
    Set rsTemp.ActiveConnection = Nothing
    Set rsTemp = Nothing
    Set oCon = Nothing
End Function
'By Capi 07082008
Public Function ReporteExtractoCuentas(ByVal pdFecIni As Date, ByVal pdFecFinal As Date, ByVal psCodAge As String, ByVal psCodPro As String, ByVal psCodInst As String, ByVal pnAccion As Integer) As ADODB.Recordset
    Dim sSql As String
    Dim oConecta As COMConecta.DCOMConecta
    Set oConecta = New COMConecta.DCOMConecta
    oConecta.AbreConexion
    sSql = " Exec stp_sel_ReporteExtractoCuentas '" & Format(pdFecIni, "yyyymmdd") & "','" & Format(pdFecFinal, "yyyymmdd") & "','" & psCodAge & "','" & psCodPro & "','" & psCodInst & "','" & pnAccion & "'"
    Set ReporteExtractoCuentas = oConecta.CargaRecordSet(sSql)
    oConecta.CierraConexion
    Set oConecta = Nothing
 End Function

Private Function DatosCtasPer(ByVal sCtaCod As String)
Dim sql As String, rsTemp As ADODB.Recordset
 Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion

    sql = " Select pp.cctacod,e.cpersnombre,direccion=e.cpersdireccdomicilio,u.cubigeodes,relacion=k.cconsdescripcion " _
          & " ,pp.nprdpersrelac " _
          & " from productopersona pp " _
          & " join persona e on e.cperscod=pp.cperscod " _
          & " left join ubigeo u on u.cubigeocod=e.cpersdireccubigeo " _
          & " join (select cconsdescripcion,nconsvalor from constante where nconscod=2005)k on k.nconsvalor=pp.nprdpersrelac " _
          & " where pp.cctacod='" & sCtaCod & "'" _
          & " order by pp.cctacod,k.cconsdescripcion desc "
          
    Set rsTemp = New ADODB.Recordset
    rsTemp.CursorLocation = adUseClient
    Set rsTemp = oCon.CargaRecordSet(sql)
    Set DatosCtasPer = rsTemp
    oCon.CierraConexion
     
    Set rsTemp.ActiveConnection = Nothing
    Set rsTemp = Nothing
    Set oCon = Nothing


End Function

Private Function DatosMov(ByVal sCuenta As String, dFecIni As Date, dFecFin As Date, ByRef lblTotAbono As String, ByRef lblTotCargo As String, ByRef lblSaldoDisponible As String, ByRef lblSaldoContable As String, ByRef lblSaldoInicial As String, ByRef lblFecSaldIni As String, Optional ByRef sMensaje As String = "", Optional gsCodUser As String) As ADODB.Recordset
    Dim clsMant As COMNCaptaGenerales.NCOMCaptaGenerales
    Dim rsCta As ADODB.Recordset
   
    Dim nAbonoTotal As Double, nCargoTotal As Double
    Dim rsTemp As ADODB.Recordset
   

    nAbonoTotal = 0
    nCargoTotal = 0

   Set clsMant = New COMNCaptaGenerales.NCOMCaptaGenerales
   Set rsCta = clsMant.GetMovimientosCuenta2(sCuenta, dFecIni, dFecFin, , False, gsCodUser, rsTemp)



If rsCta.EOF And rsCta.BOF Then
    
    sMensaje = "No se realiaron movimientos en este intervalo de fechas"
    Exit Function
Else
      
      Dim i As Integer, tmpdisp As Double, tmpcont As Double
      i = 0
        While Not rsCta.EOF
            nAbonoTotal = nAbonoTotal + rsCta!nAbono
            nCargoTotal = nCargoTotal + rsCta!nCargo
           
            If rsCta.RecordCount - 1 = i Then
                 tmpdisp = rsCta!nSaldoDisponible
                 tmpcont = rsCta!nSaldoContable
            
            End If
             i = i + 1
            rsCta.MoveNext
        Wend
        rsCta.MoveFirst
                        
        If rsTemp.EOF And rsTemp.BOF Then
            lblFecSaldIni = Format$(DateAdd("d", -1, dFecIni), "dd/mm/yyyy")
            lblSaldoInicial = "0.00"
        Else
            lblFecSaldIni = Left(rsTemp("dFecha"), 12)
            lblSaldoInicial = Format$(rsTemp("nSaldoContable"), "#,##0.00")
        End If
End If
        lblTotAbono = Format$(nAbonoTotal, "#,##0.00")
        lblTotCargo = Format$(nCargoTotal, "#,##0.00")
        lblSaldoDisponible = Format$(tmpdisp, "#,##0.00")
        lblSaldoContable = Format$(tmpcont, "#,##0.00")
   
Set DatosMov = rsCta
         
End Function
'dd/mm/yyyy
Public Function Reporte(psRep As String, psFecIni As String, psFecFin As String, pnMontoIni As Currency, pnMontoFin As Currency, _
                        psNomAge As String, psEmpresa As String, pdFecSis As Date, psCodAge As String, _
                        Optional psUser As String = "XXX", Optional psTextoCarta As String = "", Optional pnTipoCambio As Double = 1, _
                        Optional lsEstadosCheques_ As String = "", Optional lsOptionsCheques_ As String = "", Optional lsOrden_ As String, Optional lsCheck_ As String, Optional lsLlamada_ As String = "0", Optional lsrecepcion_ As String = "0", Optional PSpersoneria As Integer, _
                        Optional ByVal sProd As String = "", Optional ByRef lsMensaje As String, _
                        Optional psSubProd As String, Optional psFormaRet As String, _
                        Optional pnCondAho As Integer, Optional psCondVigCan As String, Optional ByVal pbaTasaPactada As Boolean = False, _
                        Optional ByVal pnEstadoGiro As Integer = 1) As String
                        'Optional pnCondAho As Integer, Optional psCondVigCan As String) As String
    'By Capi 13082008 se adiciono parametro opcional pbaTasaPactada
    'By EJVG 20110722 se adiciono parametro opcional pbaEstadoGiro
    Dim lscadena As String
    Dim lsRep As String
    Dim lsRepSub As String
    Dim gdFecSis As Date
    Dim oConst As COMDConstSistema.NCOMConstSistema
    Set oConst = New COMDConstSistema.NCOMConstSistema
    lsNomAge = psNomAge
    lsEmpresa = psEmpresa
    ldFecSis = pdFecSis
    ldFecRepo = CDate(pdFecSis)
    lsAgeCod = psCodAge
    gsCodAge = psCodAge
    lnRango = 54
    gdFecSis = pdFecSis
    Dim gsCodProAC As String
    Dim gsCodProPF As String
    Dim gsCodProCTS As String
    
    If Len(Trim(psUser)) = 0 Then
        psUser = "XXX"
    End If
    
    gsCodAge = psCodAge
    gsCodProAC = Producto.gCapAhorros
    gsCodProPF = Producto.gCapPlazoFijo
    gsCodProCTS = Producto.gCapCTS
    
    lnTipoPigno = oConst.LeeConstSistema(101)

    lsRep = psRep
    lsRepSub = lsRep
    If lsRepSub = gCapRepDiaCapEstadAho Then 'ok
        lscadena = lscadena & LlenaEDAC(1, psFecIni, psFecFin)
        lscadena = lscadena & LlenaEDAC(2, psFecIni, psFecFin)
    ElseIf lsRepSub = gCapRepDiaCapEstadPF Then 'ok
        lscadena = lscadena & LlenaEDPF(1, psFecIni, psFecFin)
        lscadena = lscadena & LlenaEDPF(2, psFecIni, psFecFin)
    ElseIf lsRepSub = gCapRepDiaCapEstadCTS Then 'ok
        lscadena = lscadena & LlenaEDCTS(1, psFecIni, psFecFin)
        lscadena = lscadena & LlenaEDCTS(2, psFecIni, psFecFin)
    ElseIf lsRepSub = gCapRepDiaCapCtasMov Then 'ok
        lscadena = lscadena & ReporteTrasTotSM("MOVIMIENTOS DE AHORRO", False, psUser, Format(CDate(psFecIni), "yyyymmdd"))
    ElseIf lsRepSub = gCapRepDiaCapSaldTpoCta Then 'ok
        lscadena = lscadena & SdosTipCta(lsAgeCod)
    ElseIf lsRepSub = gCapRepDiaCapEstratCta Then 'ok
        lscadena = lscadena & EstratDep(lsAgeCod, psFecIni)
    ElseIf lsRepSub = gCapRepDiaCapPFVenc Then 'ok
        lscadena = lscadena & RepPlazoFijovencimiento(CDate(psFecIni), CDate(psFecFin), psNomAge, psEmpresa, pdFecSis, gMonedaNacional)
        lscadena = lscadena & Chr(12) & RepPlazoFijovencimiento(CDate(psFecIni), CDate(psFecFin), psNomAge, psEmpresa, pdFecSis, gMonedaExtranjera)
    ElseIf lsRepSub = gCapRepDiaCapInact Then 'ok
        lscadena = lscadena & RepCtaIna
    ElseIf lsRepSub = gCapRepDiaCapConsInact Then 'ok
        lscadena = lscadena & ConsolidadoInactivas(CDate(psFecIni), CDate(psFecFin))
    ElseIf lsRepSub = gCapRepDiaCapApert Then 'Cuentas Aperturadas en el día 'ok
        lscadena = lscadena & RepCtaApe(CDate(psFecIni), CDate(psFecFin))
    ElseIf lsRepSub = gCapRepDiaCapCanc Then 'ok
        lscadena = lscadena & RepCtaCan(CDate(psFecIni), CDate(psFecFin), pbaTasaPactada)
    ElseIf lsRepSub = gCapRepDiaCartaRenPF Then 'ok
        lscadena = lscadena & AvisoRenovacionPF(CDate(psFecIni), psTextoCarta, psCodAge)
    ElseIf lsRepSub = 280232 Then 'ok
        lscadena = lscadena & ImprimeRep05(CDate(psFecIni), gsNomCmac)
    ElseIf lsRepSub = 280237 Then 'ok
        lscadena = lscadena & ImprimeSaldosCaptaciones(CDate(gdFecSis), CDate(psFecIni), lsEmpresa, psCodAge, psNomAge)
    ElseIf lsRepSub = 280238 Then 'ok GITU 08/05/2007 Se agrego el parametro de Cod. Agencia 18-05-2009 gitu
        lscadena = lscadena & ImprimeReportesSubProd(CDate(psFecIni), CDate(psFecFin), lsEmpresa, psSubProd, psFormaRet, pnCondAho, psCondVigCan, psCodAge)
    ElseIf lsRepSub = gCapRepDiaServGirosApert Then  'GIRO APE 'ok
        lscadena = lscadena & ImprimeRepGiros(CDate(psFecIni), CDate(psFecFin), "MSM", "GIROS REGISTRADOS - " & psCodAge, , psCodAge, pnEstadoGiro)
    ElseIf lsRepSub = gCapRepDiaServGirosCanc Then 'GIRO CAN 'ok
        lscadena = lscadena & ImprimeRepGiros(CDate(psFecIni), CDate(psFecFin), "MSM", "GIROS CANCELADOS - " & psCodAge, True, psCodAge, pnEstadoGiro)
    ElseIf lsRepSub = gCapRepDiaServConvCob Then  'SERVICIOS
        lscadena = lscadena & RepCtaCan(CDate(psFecIni), CDate(psFecFin))
        
        
    ElseIf lsRepSub = gCapRepMensCapSaldCtaAhoPN Then 'PERSONAS NATURALES CMCPL 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, pdFecSis, 1)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, pdFecSis, 1)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaAhoPJSFL Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurSFL, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurSFL, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaAhoPJCFL Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFL, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFL, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaAhoCMAC Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCMAC, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCMAC, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaAhoCRAC Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCRAC, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCRAC, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaAhoFoncodes Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLFONCODES, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLFONCODES, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaAhoCooperativa Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCooperativa, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCooperativa, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaAhoEdipyme Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLEdpyme, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLEdpyme, Moneda.gMonedaExtranjera, pdFecSis)
   ElseIf lsRepSub = "280632" Then 'ok
        lscadena = lscadena & GeneraRepInac(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaNacional, Format(gdFecSis, "mm/dd/yyyy"), 1)
        lscadena = lscadena & GeneraRepInac(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaExtranjera, Format(gdFecSis, "mm/dd/yyyy"), 1)
   ElseIf lsRepSub = "280633" Then 'ok
        lscadena = lscadena & GeneraRepInac(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaNacional, Format(gdFecSis, "mm/dd/yyyy"), 2)
        lscadena = lscadena & GeneraRepInac(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaExtranjera, Format(gdFecSis, "mm/dd/yyyy"), 2)
   ElseIf lsRepSub = "280634" Then 'ok
        lscadena = lscadena & GeneraRepBloq(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaNacional, 4)
        lscadena = lscadena & GeneraRepBloq(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaExtranjera, 4)
   ElseIf lsRepSub = "280635" Then 'ok
        lscadena = lscadena & GeneraRepBloq(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaNacional, 5)
        lscadena = lscadena & GeneraRepBloq(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaExtranjera, 5)
   ElseIf lsRepSub = "280636" Then 'ok
        lsAgeCod = "X4"
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaExtranjera, pdFecSis)
   ElseIf lsRepSub = "280637" Then 'ok
        lsAgeCod = "X2"
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaExtranjera, pdFecSis)
   ElseIf lsRepSub = "280639" Then
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaNacional, pdFecSis, 5)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaExtranjera, pdFecSis, 5)
   
    
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFPN Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFPJSFL Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurSFL, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurSFL, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFPJCFL Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFL, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFL, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFCMAC Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLCMAC, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLCMAC, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFCRAC Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLCRAC, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLCRAC, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFFoncodes Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLFONCODES, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLFONCODES, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFCooperativa Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLCooperativa, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLCooperativa, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFEdpyme Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLEdpyme, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLEdpyme, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFPNPJSFL Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PSpersoneria, Moneda.gMonedaNacional, pdFecSis, 5)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PSpersoneria, Moneda.gMonedaExtranjera, pdFecSis, 5)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFNascaPalpa Then 'ok
        lsAgeCod = "X4"
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PSpersoneria, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PSpersoneria, Moneda.gMonedaExtranjera, pdFecSis)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaPFCaneteMala Then 'ok
        lsAgeCod = "X2"
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PSpersoneria, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PSpersoneria, Moneda.gMonedaExtranjera, pdFecSis)
   ElseIf lsRepSub = gCapRepMensBloqCapPF Then 'ok
        lscadena = lscadena & GeneraRepBloq(Producto.gCapPlazoFijo, PSpersoneria, Moneda.gMonedaNacional, 4)
        lscadena = lscadena & GeneraRepBloq(Producto.gCapPlazoFijo, PSpersoneria, Moneda.gMonedaExtranjera, 4)
   ElseIf lsRepSub = "280631" Then 'ok
        lscadena = lscadena & GeneraRepBloq(Producto.gCapPlazoFijo, PSpersoneria, Moneda.gMonedaNacional, 5)
        lscadena = lscadena & GeneraRepBloq(Producto.gCapPlazoFijo, PSpersoneria, Moneda.gMonedaExtranjera, 5)
    
   '***Agregado por ELRO el 20111105, según Acta 307-2011/TI-D
    ElseIf lsRepSub = gCapRepMensCapSaldCtaAhoFinancieras Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLFinancieras, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLFinancieras, Moneda.gMonedaExtranjera, pdFecSis)

   ElseIf lsRepSub = gCapRepMensCapSaldCtaPFFinancieras Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLFinancieras, Moneda.gMonedaNacional, pdFecSis)
        lscadena = lscadena & GeneraSaldos(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFLFinancieras, Moneda.gMonedaExtranjera, pdFecSis)
   '***Fin Agregado por ELRO**********************************
    
    ElseIf lsRepSub = gCapRepMensCapSaldCtaCTS Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, pdFecSis, 1, "")
        lscadena = lscadena & GeneraSaldos(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, pdFecSis, 1, "")
    ElseIf lsRepSub = gCapRepMensCapSaldCtaCTSConvenio Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, pdFecSis, 2)
        lscadena = lscadena & GeneraSaldos(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, pdFecSis, 2)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaCTSExternos Then 'ok
        lscadena = lscadena & GeneraSaldos(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, pdFecSis, 3, lsMensaje)
        lscadena = lscadena & GeneraSaldos(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, pdFecSis, 3, lsMensaje)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaCTSNascaPalpa Then 'ok
        lsAgeCod = "X4"
        lscadena = lscadena & GeneraSaldos(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, pdFecSis, 1)
        lscadena = lscadena & GeneraSaldos(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, pdFecSis, 1)
    ElseIf lsRepSub = gCapRepMensCapSaldCtaCTSCaneteMala Then 'ok
        lsAgeCod = "X2"
        lscadena = lscadena & GeneraSaldos(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, pdFecSis, 1)
        lscadena = lscadena & GeneraSaldos(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, pdFecSis, 1)
   ElseIf lsRepSub = gCapRepMensBloqCapCTS Then
        lscadena = lscadena & GeneraRepBloq(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, 1)
        lscadena = lscadena & GeneraRepBloq(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, 1)
   ElseIf lsRepSub = gCapRepMensBloqCapCTSConvenio Then
        lscadena = lscadena & GeneraRepBloq(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, 2)
        lscadena = lscadena & GeneraRepBloq(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, 2)
   ElseIf lsRepSub = gCapRepMensBloqCapCTSExternos Then
        lscadena = lscadena & GeneraRepBloq(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, 3)
        lscadena = lscadena & GeneraRepBloq(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, 3)
        
        
   ElseIf lsRepSub = gCapRepMensCapListGralCtas Then 'ok
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurSFL, Moneda.gMonedaNacional, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurSFL, Moneda.gMonedaExtranjera, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFL, Moneda.gMonedaNacional, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFL, Moneda.gMonedaExtranjera, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCMAC, Moneda.gMonedaNacional, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCMAC, Moneda.gMonedaExtranjera, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCRAC, Moneda.gMonedaNacional, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCRAC, Moneda.gMonedaExtranjera, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCooperativa, Moneda.gMonedaNacional, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCooperativa, Moneda.gMonedaExtranjera, psFecIni, 0)
        lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLEdpyme, Moneda.gMonedaNacional, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLEdpyme, Moneda.gMonedaExtranjera, psFecIni, 0)
       
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurSFL, Moneda.gMonedaNacional, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurSFL, Moneda.gMonedaExtranjera, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFL, Moneda.gMonedaNacional, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFL, Moneda.gMonedaExtranjera, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCMAC, Moneda.gMonedaNacional, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCMAC, Moneda.gMonedaExtranjera, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCRAC, Moneda.gMonedaNacional, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCRAC, Moneda.gMonedaExtranjera, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCooperativa, Moneda.gMonedaNacional, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLCooperativa, Moneda.gMonedaExtranjera, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLEdpyme, Moneda.gMonedaNacional, psFecIni, 1)
       lscadena = lscadena & GenSdosFM(Producto.gCapAhorros, PersPersoneria.gPersonaJurCFLEdpyme, Moneda.gMonedaExtranjera, psFecIni, 1)
    
       lscadena = lscadena & GenSdosFM(Producto.gCapPlazoFijo, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapPlazoFijo, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurSFL, Moneda.gMonedaNacional, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurSFL, Moneda.gMonedaExtranjera, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFL, Moneda.gMonedaNacional, psFecIni, 0)
       lscadena = lscadena & GenSdosFM(Producto.gCapPlazoFijo, PersPersoneria.gPersonaJurCFL, Moneda.gMonedaExtranjera, psFecIni, 0)
    
       lscadena = lscadena & GenSdosFM(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, psFecIni, 0, gsInstCmac)
       lscadena = lscadena & GenSdosFM(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, psFecIni, 0, "")
       lscadena = lscadena & GenSdosFM(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaNacional, psFecIni, 0, gsInstCmac)
       lscadena = lscadena & GenSdosFM(Producto.gCapCTS, PersPersoneria.gPersonaNat, Moneda.gMonedaExtranjera, psFecIni, 0, "")
    ElseIf lsRepSub = "V03" Then
        lscadena = lscadena & CuentasInactivas(Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), gsNomAge, pdFecSis)
        lscadena = lscadena & CuentasInactivas(Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), gsNomAge, pdFecSis)
    
    ElseIf lsRepSub = "280701" Then 'ok
        lscadena = lscadena & PlazosFijoCancelayMontos(Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, gsNomAge, pdFecSis)
    ElseIf lsRepSub = "280702" Then 'ok
        lscadena = lscadena & PlazosFijoCancelayMontos(Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, gsNomAge, pdFecSis)
    ElseIf lsRepSub = "280703" Then 'ok
        lscadena = lscadena & PlazosFijoCancelayMontosEspecial(Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, gsNomAge, pdFecSis)
    ElseIf lsRepSub = "280704" Then 'ok
        lscadena = lscadena & PlazosFijoCancelayMontosEspecial(Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, gsNomAge, pdFecSis)
    
    ElseIf lsRepSub = "280705" Then 'ok
        lscadena = lscadena & ReportesExtornos(psCodAge, "REPORTES DE CUENTAS EXTORNADAS", Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, , psUser)
    
    ElseIf lsRepSub = "280706" Then 'ok
        'ahorros
        lscadena = lscadena & CuentasAperturadas(psCodAge, "CUENTAS DE AHORRO APERTURADAS SIN ORDEN DE PAGO ", Producto.gCapAhorros, 0, Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        lscadena = lscadena & CuentasAperturadas(psCodAge, "CUENTAS DE AHORRO APERTURADAS CON ORDEN DE PAGO ", Producto.gCapAhorros, 1, Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        lscadena = lscadena & CuentasAperturadas(psCodAge, "CUENTAS DE AHORRO APERTURADAS SIN ORDEN DE PAGO ", Producto.gCapAhorros, 0, Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        lscadena = lscadena & CuentasAperturadas(psCodAge, "CUENTAS DE AHORRO APERTURADAS CON ORDEN DE PAGO ", Producto.gCapAhorros, 1, Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        
        'plazo fijo
        lscadena = lscadena & CuentasAperturadas(psCodAge, "CUENTAS DE PLAZO FIJO APERTURADAS ", Producto.gCapPlazoFijo, 0, Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        lscadena = lscadena & CuentasAperturadas(psCodAge, "CUENTAS DE PLAZO FIJO APERTURADAS ", Producto.gCapPlazoFijo, 0, Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        
        'Cts
        lscadena = lscadena & CuentasAperturadas(psCodAge, "CUENTAS DE CTS APERTURADAS ", Producto.gCapCTS, 0, Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        lscadena = lscadena & CuentasAperturadas(psCodAge, "CUENTAS DE CTS APERTURADAS ", Producto.gCapCTS, 0, Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        
    ElseIf lsRepSub = "280707" Then 'ok
        'Canc. ahorros
        lscadena = lscadena & CuentasCanceladas(psCodAge, "CUENTAS DE AHORRO CANCELADAS SIN OREDN DE PAGO ", "232", 0, Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        lscadena = lscadena & CuentasCanceladas(psCodAge, "CUENTAS DE AHORRO CANCELADAS CON OREDN DE PAGO ", "232", 1, Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        lscadena = lscadena & CuentasCanceladas(psCodAge, "CUENTAS DE AHORRO CANCELADAS SIN OREDN DE PAGO ", "232", 0, Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        lscadena = lscadena & CuentasCanceladas(psCodAge, "CUENTAS DE AHORRO CANCELADAS CON OREDN DE PAGO ", "232", 1, Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        
        'Canc. plazo fijo
        lscadena = lscadena & CuentasCanceladas(psCodAge, "CUENTAS DE PLAZO FIJO CANCELADAS ", "233", 0, Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        lscadena = lscadena & CuentasCanceladas(psCodAge, "CUENTAS DE PLAZO FIJO CANCELADAS ", "233", 0, Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        
        'Canc. Cts
        lscadena = lscadena & CuentasCanceladas(psCodAge, "CUENTAS DE CTS CANCELADAS ", "233", 0, Moneda.gMonedaNacional, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
        lscadena = lscadena & CuentasCanceladas(psCodAge, "CUENTAS DE CTS CANCELADAS ", "233", 0, Moneda.gMonedaExtranjera, CDate(psFecIni), CDate(psFecFin), pnMontoIni, pnMontoFin, psNomAge, pdFecSis)
    
    ElseIf lsRepSub = "280710" Then
        '**** PARA EXTORNOS EN BATCH
        'lsCadena = lsCadena & ExtractosBatch(psCodAge, CDate(psFecini), CDate(psFecFin),)
           
    ElseIf lsRepSub = "280213" Then 'ok
        lscadena = lscadena & ProtocoloOperaciones("Protocolo del Dia Soles", 0, 1, psNomAge, psEmpresa, pdFecSis, gMonedaNacional, psUser, , CDate(psFecIni), psCodAge, lsOrden_, lsCheck_)
    ElseIf lsRepSub = "280214" Then 'ok
        lscadena = lscadena & ProtocoloOperaciones("Protocolo del Dia Dolares", 0, 1, psNomAge, psEmpresa, pdFecSis, gMonedaExtranjera, psUser, , CDate(psFecIni), psCodAge, lsOrden_, lsCheck_)
    ElseIf lsRepSub = "280215" Then 'ok
        lscadena = lscadena & ComVtaME(CDate(psFecIni), CDate(psFecFin), psCodAge)
    ElseIf lsRepSub = "280216" Then 'ok
    
        lscadena = lscadena & InfCajaGeneral(CDate(psFecIni), psCodAge, pdFecSis)
        
    ElseIf lsRepSub = "280217" Then 'ok
        Dim bHoy As Boolean
        bHoy = False
        If pdFecSis = CDate(psFecIni) Then bHoy = True
        lscadena = lscadena & SaldosDiarios(CDate(psFecIni), psCodAge, psNomAge, bHoy, psEmpresa)
    
    ElseIf lsRepSub = "280708" Then 'ok
    
    
        lscadena = lscadena & GetRepCapNMejoresClientes(CLng(pnMontoIni), pnTipoCambio, psCodAge, psEmpresa, psNomAge, pdFecSis)
        
    ElseIf lsRepSub = "280709" Then 'ok
    
       lscadena = lscadena & GetRepCapNMejoresClientesSIF(CLng(pnMontoIni), pnTipoCambio, psCodAge, psEmpresa, psNomAge, pdFecSis)
        
   ElseIf lsRepSub = "280719" Then
            
        lsMensaje = "ESTE REPORTE PUEDE DURAR UNOS MINUTOS....DESEA CONTINUAR?"
        lscadena = lscadena & GetCuentaCapAnt("232", pdFecha, psCodAge, psNomAge)
        
        
   ElseIf lsRepSub = "280720" Then
        lsMensaje = "ESTE REPORTE PUEDE DURAR UNOS MINUTOS....DESEA CONTINUAR?"
        lscadena = lscadena & GetCuentaCapAnt("233", pdFecha, psCodAge, psNomAge)
            
   ElseIf lsRepSub = "280721" Then
        lsMensaje = "ESTE REPORTE PUEDE DURAR UNOS MINUTOS....DESEA CONTINUAR?"
        lscadena = lscadena & GetCuentaCapAnt("234", pdFecha, psCodAge, psNomAge)
        
   ElseIf lsRepSub = "280722" Then
   
        lsMensaje = "ESTE REPORTE PUEDE DURAR UNOS MINUTOS....DESEA CONTINUAR?"
        lscadena = lscadena & GetCuentaCapInact("232", CDate(psFecIni), psCodAge, Moneda.gMonedaNacional, 1)
        lscadena = lscadena & GetCuentaCapInact("232", CDate(psFecIni), psCodAge, Moneda.gMonedaExtranjera, 1)
'                lsCadena = lsCadena & GetCuentaCapInact("232", CDate(psFecIni), psCodAge, Moneda.gMonedaNacional, 2)
'                lsCadena = lsCadena & GetCuentaCapInact("232", CDate(psFecIni), psCodAge, Moneda.gMonedaExtranjera, 2)
        
 '       End If
    ElseIf lsRepSub = "280723" Then
        
        lsMensaje = "Este reporte puede durar unos minutos."
        lscadena = lscadena & GetCuentaCapPromotores(psCodAge, "REPORTE DE APERTURAS POR PROMOTOR", CDate(psFecIni), CDate(psFecFin))
        
    ElseIf lsRepSub = "280224" Then
        lscadena = lscadena & RepCtaInmobilizada(CDate(psFecIni), CDate(psFecFin))
    ElseIf lsRepSub = "280225" Then
        lscadena = lscadena & ImpLavDineroD(CDate(psFecIni), CDate(psFecFin), psEmpresa, psNomAge, psCodAge, pdFecSis)
    ElseIf lsRepSub = "280227" Then
        lscadena = lscadena & ImpLavDineroAD(CDate(psFecIni), psEmpresa, psNomAge, psCodAge, pdFecSis)
    ElseIf lsRepSub = "280228" Then
        lscadena = lscadena & ImpLavDineroM(CDate(psFecIni), CDate(psFecFin), psEmpresa, psNomAge, psCodAge, pdFecSis)
    ElseIf lsRepSub = "280219" Then 'ok
        lscadena = lscadena & SobranteFaltante(CDate(psFecIni), CDate(psFecFin), psCodAge)   ' , psEmpresa, psNomAge, psCodAge, pdFecSis)
    ElseIf lsRepSub = "280220" Then 'ok
        lscadena = lscadena & GetOtrasOperaciones(CDate(psFecIni), CDate(psFecFin), psEmpresa, psNomAge, psCodAge, pdFecSis)
    '*** PEAC 20100524
    ElseIf lsRepSub = "280221" Then 'LISTADO DE CARGOS Y ABONOS
        lscadena = lscadena & ListadoDeCargosAbonos(CDate(psFecIni), CDate(psFecFin), psEmpresa, psNomAge, psCodAge, pdFecSis)
    '*** FIN PEAC
    ElseIf lsRepSub = "280230" Then 'Cheques x estado
        lscadena = lscadena & RepoChequesCompleto(psCodAge, CDate(psFecIni), CDate(psFecFin), lsEstadosCheques_, lsOptionsCheques_, 1, psNomAge, Format(pdFecSis, "dd/MM/YYYY"), sProd)
        If Len(Trim(lscadena)) > 0 Then
            lscadena = lscadena & Chr(12)
        End If
        lscadena = lscadena & RepoChequesCompleto(psCodAge, CDate(psFecIni), CDate(psFecFin), lsEstadosCheques_, lsOptionsCheques_, 2, psNomAge, Format(pdFecSis, "dd/MM/YYYY"), sProd)
    ElseIf lsRepSub = "280223" Then
        lscadena = lscadena & GetListaOPSolicitadas(CDate(psFecIni), CDate(psFecFin), psEmpresa, psNomAge, psCodAge, pdFecSis)
        
    ElseIf lsRepSub = "280231" Then
        'lsCadena = lsCadena & ImpLavDineroDR(CDate(psFecini), CDate(psFecFin), psEmpresa, psNomAge, psCodAge, pdFecSis)
        lscadena = ImpLavDineroDR2(CDate(psFecIni), CDate(psFecFin), psEmpresa, psNomAge, psCodAge, pdFecSis)
        
    ElseIf lsRepSub = "280222" Then 'ok
        If lsLlamada_ = "1" And lsrecepcion_ <> "1" Then
            lscadena = lscadena & GetListaLlamadasCMACS(CDate(psFecIni), CDate(psFecIni), psEmpresa, psNomAge, psCodAge, pdFecSis)
        ElseIf lsrecepcion_ = "1" And lsLlamada_ <> "1" Then
            lscadena = lscadena & GetListaRecepcionCMACS(CDate(psFecIni), CDate(psFecIni), psEmpresa, psNomAge, psCodAge, pdFecSis)
        ElseIf lsrecepcion_ = "1" And lsLlamada_ = "1" Then
            lscadena = lscadena & GetListaLlamadasCMACS(CDate(psFecIni), CDate(psFecIni), psEmpresa, psNomAge, psCodAge, pdFecSis)
            lscadena = lscadena & GetListaRecepcionCMACS(CDate(psFecIni), CDate(psFecIni), psEmpresa, psNomAge, psCodAge, pdFecSis)
        End If
    ElseIf lsRepSub = "280233" Then
            lscadena = lscadena & TransCTSLey28461(Moneda.gMonedaNacional, psCodAge, CDate(psFecIni), CDate(psFecFin)) & Chr(12)
            lscadena = lscadena & TransCTSLey28461(Moneda.gMonedaExtranjera, psCodAge, CDate(psFecIni), CDate(psFecFin))
   
    '***********PARA CONT
    
   ElseIf lsRepSub = 280801 Then
    lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapAhorros, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional)
    lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapAhorros, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera)
    
    
   ElseIf lsRepSub = 280802 Then
     lscadena = lscadena & Me.GeneraInactivasCierre(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaNacional, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), 3)
     lscadena = lscadena & Me.GeneraInactivasCierre(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaExtranjera, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), 3)
    
    
   ElseIf lsRepSub = 280803 Then
     lscadena = lscadena & Me.GeneraInactivasCierre(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaNacional, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), 4)
     lscadena = lscadena & Me.GeneraInactivasCierre(Producto.gCapAhorros, PSpersoneria, Moneda.gMonedaExtranjera, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), 4)
       
    
   ElseIf lsRepSub = 280804 Then
       lscadena = lscadena & GeneraSaldosCierre(Producto.gCapAhorros, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional)
       lscadena = lscadena & GeneraSaldosCierre(Producto.gCapAhorros, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera)
       
   ElseIf lsRepSub = 280805 Then
       lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapAhorros, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional, True)
       lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapAhorros, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera, True)
    
   ElseIf lsRepSub = 280811 Then
     lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapPlazoFijo, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional)
     lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapPlazoFijo, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera)
        
   ElseIf lsRepSub = 280812 Then
    lscadena = lscadena & GeneraSaldosCierre(Producto.gCapPlazoFijo, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional)
    lscadena = lscadena & GeneraSaldosCierre(Producto.gCapPlazoFijo, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera)
    

   ElseIf lsRepSub = 280813 Then
     lscadena = lscadena & Me.GeneraProvisionCierre(Producto.gCapPlazoFijo, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional)
     lscadena = lscadena & Me.GeneraProvisionCierre(Producto.gCapPlazoFijo, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera)
    
   ElseIf lsRepSub = 280814 Then
     lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapPlazoFijo, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional, True)
     lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapPlazoFijo, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera, True)
    
   ElseIf lsRepSub = 280821 Then
     lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapCTS, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional)
     lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapCTS, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera)
    

   ElseIf lsRepSub = 280822 Then
    lscadena = lscadena & GeneraSaldosCierre(Producto.gCapCTS, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional, False)
    lscadena = lscadena & GeneraSaldosCierre(Producto.gCapCTS, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera, False)
    
    
   ElseIf lsRepSub = 280823 Then
    lscadena = lscadena & GeneraSaldosCierre(Producto.gCapCTS, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional, True)
    lscadena = lscadena & GeneraSaldosCierre(Producto.gCapCTS, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera, True)
    
   ElseIf lsRepSub = 280824 Then
     lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapCTS, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaNacional, True)
     lscadena = lscadena & GeneraBloqueadasCierre(Producto.gCapCTS, PSpersoneria, CDate(psFecIni), IIf(psCodAge = "0", "", psCodAge), Moneda.gMonedaExtranjera, True)
    
   ElseIf lsRepSub = "280831" Then
     lscadena = lscadena & GeneraConsolidadaSaldosCierre(Producto.gCapAhorros, CDate(psFecIni), Moneda.gMonedaNacional)
    ' lsCadena = lsCadena & GeneraConsolidadaSaldosCierre(Producto.gCapAhorros, CDate(psFecIni), Moneda.gMonedaExtranjera)
    
        
   ElseIf lsRepSub = "280832" Then
     lscadena = lscadena & GeneraConsolidadaSaldosCierre(Producto.gCapPlazoFijo, CDate(psFecIni), Moneda.gMonedaNacional)
     'lsCadena = lsCadena & GeneraConsolidadaSaldosCierre(Producto.gCapPlazoFijo, CDate(psFecIni), Moneda.gMonedaExtranjera)
    
        
   ElseIf lsRepSub = "280833" Then
         lscadena = lscadena & GeneraConsolidadaSaldosCierre(Producto.gCapCTS, CDate(psFecIni), Moneda.gMonedaNacional)
      '   lsCadena = lsCadena & GeneraConsolidadaSaldosCierre(Producto.gCapCTS, CDate(psFecIni), Moneda.gMonedaExtranjera)
        
        
   ElseIf lsRepSub = "280834" Then
     lscadena = lscadena & GeneraConsolidadaBloqueadasCierre(Producto.gCapAhorros, CDate(psFecIni), Moneda.gMonedaNacional)
     'lsCadena = lsCadena & GeneraConsolidadaBloqueadasCierre(Producto.gCapAhorros, CDate(psFecIni), Moneda.gMonedaExtranjera)
    
        
   ElseIf lsRepSub = "280835" Then
    lscadena = lscadena & GeneraConsolidadaBloqueadasCierre(Producto.gCapPlazoFijo, CDate(psFecIni), Moneda.gMonedaNacional)
    'lsCadena = lsCadena & GeneraConsolidadaBloqueadasCierre(Producto.gCapPlazoFijo, CDate(psFecIni), Moneda.gMonedaExtranjera)
    
    
   ElseIf lsRepSub = "280836" Then
    lscadena = lscadena & GeneraConsolidadaBloqueadasCierre(Producto.gCapCTS, CDate(psFecIni), Moneda.gMonedaNacional)
   ' lsCadena = lsCadena & GeneraConsolidadaBloqueadasCierre(Producto.gCapCTS, CDate(psFecIni), Moneda.gMonedaExtranjera)
    
    
    
   ElseIf lsRepSub = "280837" Then
    lscadena = lscadena & GeneraConsolidadaInactivasCierre(Producto.gCapAhorros, CDate(psFecIni), Moneda.gMonedaNacional, 3)
    'lsCadena = lsCadena & GeneraConsolidadaInactivasCierre(Producto.gCapAhorros, CDate(psFecIni), Moneda.gMonedaExtranjera, 3)
    
    
   ElseIf lsRepSub = "280838" Then
    lscadena = lscadena & GeneraConsolidadaInactivasCierre(Producto.gCapAhorros, CDate(psFecIni), Moneda.gMonedaNacional, 4)
    'lsCadena = lsCadena & GeneraConsolidadaInactivasCierre(Producto.gCapAhorros, CDate(psFecIni), Moneda.gMonedaExtranjera, 4)
    
        
   ElseIf lsRepSub = "280839" Then
    lscadena = lscadena & GeneraConsolidadaProvisionCierre(Producto.gCapPlazoFijo, CDate(psFecIni), Moneda.gMonedaNacional, 5)
    'lsCadena = lsCadena & GeneraConsolidadaProvisionCierre(Producto.gCapPlazoFijo, CDate(psFecIni), Moneda.gMonedaExtranjera, 5)
    
   ElseIf lsRepSub = "280851" Then
   lscadena = lscadena & GeneraRepMejoresClientes(CLng(pnMontoIni), pnTipoCambio, psCodAge, CDate(psFecIni), 1)
    
   ElseIf lsRepSub = "280852" Then
    lscadena = lscadena & GeneraRepMejoresClientes(CLng(pnMontoIni), pnTipoCambio, psCodAge, CDate(psFecIni), 2)
   
   ElseIf lsRepSub = "280853" Then
    lscadena = lscadena & GeneraRepMejoresClientes(CLng(pnMontoIni), pnTipoCambio, psCodAge, CDate(psFecIni), 3, "232")
    
   ElseIf lsRepSub = "280854" Then
    lscadena = lscadena & GeneraRepMejoresClientes(CLng(pnMontoIni), pnTipoCambio, psCodAge, CDate(psFecIni), 3, "233")
    
   ElseIf lsRepSub = "280855" Then
    lscadena = lscadena & GeneraRepMejoresClientes(CLng(pnMontoIni), pnTipoCambio, psCodAge, CDate(psFecIni), 3, "234")
   
   ElseIf lsRepSub = "280856" Then
    lscadena = lscadena & GeneraRepMejoresClientes(CLng(pnMontoIni), pnTipoCambio, psCodAge, CDate(psFecIni), 4, "232")
    
   ElseIf lsRepSub = "280857" Then
    lscadena = lscadena & GeneraRepMejoresClientes(CLng(pnMontoIni), pnTipoCambio, psCodAge, CDate(psFecIni), 4, "233")
    
'*** PEAC 20080616
   ElseIf lsRepSub = gCapRepSeguiCtasAhoPandero Then
    lscadena = lscadena & GeneraRepSeguiCtasAhoPandero(psCodAge, CDate(psFecIni), CDate(psFecFin), pdFecSis, 4, "233")

    
'   ElseIf lsRepSub = "280858" Then
'    lsCadena = lsCadena & GeneraRepMejoresClientes(CLng(pnMontoIni), pnTipoCambio, psCodAge, CDate(psFecIni), 4, "234")
'
   
   
        
    '***********FIN PARA CONT
        
        If lsrecepcion_ = "1" Then
            If lsLlamada_ = "1" Then
                lscadena = lscadena & Chr(12)
            End If
            lscadena = lscadena & GetListaRecepcionCMACS(CDate(psFecIni), CDate(psFecIni), psEmpresa, psNomAge, psCodAge, pdFecSis)
        End If
    
    End If
    
    Reporte = lscadena
End Function

'MADM 20101012 parametro agencia
Public Function ReporteTrasTotSM(psTitulo As String, Optional pbFinPg As Boolean = True, Optional psCodUser As String = "XXX", Optional psFecha As String = "", Optional pscCodAge As String = "") As String
    
    Dim oRep As New COMDCaptaReportes 'MADM 20101012
    Dim rs As New ADODB.Recordset
          
    'On Error GoTo ERROR
    Dim lscadena As String
    Dim lsAdd As String
    lscadena = ""
    
    If pscCodAge <> "" Then
    
            Set rs = oRep.RecuperaRfxAgencia(pscCodAge)  'MADM 20101012
            Set oRep = Nothing
            
            If Not rs.EOF And Not rs.BOF Then
                For i = 0 To rs.RecordCount - 1
                    
                    psCodUser = rs("cUser")
                    
                    lsAdd = IIf(psFecha = "", "", " Del " & psFecha)
                    ReporteMovAC lscadena, "Detalle de Operaciones Ahorro - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovPF lscadena, "Detalle de Operaciones Plazo Fijo - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovCTS lscadena, "Detalle de Operaciones CTS - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovCreditos lscadena, "Detalle de Operaciones Creditos - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovPignoraticio lscadena, "Detalle de Operaciones Pignoraticio - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovJudicial lscadena, "Detalle de Operaciones Judicial - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    
                    PonerSalto lscadena
                    ReporteMovAC lscadena, "Detalle de Operaciones Ahorro - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovPF lscadena, "Detalle de Operaciones Plazo Fijo - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovCTS lscadena, "Detalle de Operaciones CTS - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovCreditos lscadena, "Detalle de Operaciones Creditos - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovPignoraticio lscadena, "Detalle de Operaciones Pignoraticio - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovJudicial lscadena, "Detalle de Operaciones Judicial - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    
                    PonerSalto lscadena
                    ReporteCompraVenta lscadena, "Detalle de Operaciones Compra Venta" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    
                    If pbFinPg Then lscadena = lscadena & Chr(12)
            
                    'QuitarSalto lsCadena
            
                    ReporteTrasTotSM = lscadena
                    
                    rs.MoveNext
                    
                  Next i
                  rs.Close
                  Set rs = Nothing
            End If
            
            Exit Function
        Else
            lsAdd = IIf(psFecha = "", "", " Del " & psFecha)
                    ReporteMovAC lscadena, "Detalle de Operaciones Ahorro - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovPF lscadena, "Detalle de Operaciones Plazo Fijo - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovCTS lscadena, "Detalle de Operaciones CTS - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovCreditos lscadena, "Detalle de Operaciones Creditos - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovPignoraticio lscadena, "Detalle de Operaciones Pignoraticio - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovJudicial lscadena, "Detalle de Operaciones Judicial - Soles" & lsAdd, 0, 0, Moneda.gMonedaNacional, psCodUser, psFecha
                    
                    PonerSalto lscadena
                    ReporteMovAC lscadena, "Detalle de Operaciones Ahorro - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovPF lscadena, "Detalle de Operaciones Plazo Fijo - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovCTS lscadena, "Detalle de Operaciones CTS - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovCreditos lscadena, "Detalle de Operaciones Creditos - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovPignoraticio lscadena, "Detalle de Operaciones Pignoraticio - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    PonerSalto lscadena
                    ReporteMovJudicial lscadena, "Detalle de Operaciones Judicial - Dolares" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    
                    PonerSalto lscadena
                    ReporteCompraVenta lscadena, "Detalle de Operaciones Compra Venta" & lsAdd, 0, 0, Moneda.gMonedaExtranjera, psCodUser, psFecha
                    
                    If pbFinPg Then lscadena = lscadena & Chr(12)
            
                    'QuitarSalto lsCadena
            
                    ReporteTrasTotSM = lscadena
            Exit Function
        End If
            
Error:
    'MsgBox "Error Realizando el Reporte de Movimientos de Cuentas: " & Err.Description, vbCritical, "Aviso"
    '************CODIGO ORIGINAL
End Function




'************************************************************************
'Ahorros
'********************************************************************************************
Public Sub ReporteMovAC(ByRef psCadenaRep As String, psTitulo As String, pnPagina As Long, pnItem As Long, Optional psMoneda As Moneda = gMonedaNacional, _
                        Optional psCodUser As String = "XXX", Optional psFecha As String = "")
    Dim SQL1 As String
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lnDep As Double
    Dim lnRet As Double
    Dim lbBan As Boolean
    
    Dim lnTotDep As Double
    Dim lnTotRet As Double
    
    Dim lsCabecera As String
    
    Dim i As Long
    Dim lsTEM As String
    Dim lsAdd As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    lnTotRet = 0
    lnTotDep = 0
    
    lsAdd = IIf(psFecha = "", "", " Del " & Right(psFecha, 2) & "/" & Mid(psFecha, 5, 2) & "/" & Left(psFecha, 4))
    
    If psCodUser = "XXX" Then
        lsCabecera = ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, Str(psMoneda))
    Else
        lsCabecera = ofuni.CabeceraPagina(psTitulo & " " & psCodUser, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, Str(psMoneda))
    End If
    
    lsTEM = psCadenaRep
    
    
    psCadenaRep = ""
    
    pnPagina = pnPagina - 1
    
    Call ReporteMovACDet(psCadenaRep, "Apertura de Cuentas de Ahorro en Efectivo" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovAhoApeEfec, , True))           'OK
    Call ReporteMovACDet(psCadenaRep, "Apertura de Cuentas de Ahorro con Cheque" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovAhoApeCheque, , True))          'OK
    Call ReporteMovACDet(psCadenaRep, "Apertura de Cuentas por Desembolsos" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovAhoApeDesembolso, , True))          'OK
    Call ReporteMovACDet(psCadenaRep, "Apertura de Cuentas por Transferencia" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovAhoApeTreansferencia, , True))    'OK
    Call ReporteMovACDet(psCadenaRep, "Movimientos Sin Dinero en Efectivo" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovAhoMovSinEfec, , True))     'OK
    Call MovimientoEfectivoAC(psCadenaRep, "Movimientos en Cuentas de Ahorro" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovAhoMovEfec, , True))
    Call ReporteMovACDet(psCadenaRep, "Cancelación de Cuentas de Ahorro" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovAhoCancelacion, , True))
    Call ReporteMovACDet(psCadenaRep, "Deposito s con Cheque en Cuentas de Ahorro" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovAhoDepCheque, , True))     'OK
    
    If lnTotRet <> 0 Or lnTotDep <> 0 Then
        psCadenaRep = lsCabecera + psCadenaRep
        QuitarSalto psCadenaRep
        psCadenaRep = psCadenaRep + ofuni.Encabezado("Resumen Total;15;" & Trim(Format(lnTotDep, "###,##0.00")) & ";57;" & Trim(Format(lnTotRet, "###,##0.00")) & ";20; ;26;", pnItem)
        psCadenaRep = psCadenaRep + ofuni.Encabezado("Monto Total;15;" & Trim(Format(lnTotDep - Abs(lnTotRet), "###,##0.00")) & ";57; ;46;", pnItem)
        psCadenaRep = psCadenaRep & Chr(12)
    End If

    pnItem = 0
    pnPagina = 0
    lnTotDep = 0
    lnTotRet = 0
    
    Call MovimientoExternoAC(psCadenaRep, "Cuentas de -Ahorro- Movidas por Otras Agencias y/o CMAC's" & lsAdd, pnPagina, pnItem, psMoneda, psCodUser, psFecha, CaptacOperacion.gAhoDepEfec & "','" & CaptacOperacion.gAhoRetEfec & "','" & CaptacOperacion.gAhoRetOP & "','" & CaptacOperacion.gAhoRetOPCanje & "','" & CaptacOperacion.gAhoRetOPCertCanje & "','" & CaptacOperacion.gAhoOPEmision & "','" & CaptacOperacion.gAhoRetOPCert & "','" & CaptacOperacion.gAhoRetOPCertCanje & "','" & CaptacOperacion.gAhoOPCertificacion & "','" & CaptacOperacion.gAhoRetAnulChq)
    Call MovimientoExternoAC(psCadenaRep, "Cuentas de -Ahorro- Canceladas por Otras Agencias y/o CMAC's" & lsAdd, pnPagina, pnItem, psMoneda, psCodUser, psFecha, CaptacOperacion.gAhoExtCancAct & "','" & CaptacOperacion.gAhoCancAct & "','" & CaptacOperacion.gAhoCancInact)
    Call MovimientoExternoAC(psCadenaRep, "Cuentas de -Ahorro- Movidas en Otras Agencias" & lsAdd, pnPagina, pnItem, psMoneda, psCodUser, psFecha, CaptacOperacion.gAhoDepEfec & "','" & CaptacOperacion.gAhoRetEfec & "','" & CaptacOperacion.gAhoRetOP & "','" & CaptacOperacion.gAhoRetOPCanje & "','" & CaptacOperacion.gAhoOPEmision & "','" & CaptacOperacion.gAhoRetOPCert & "','" & CaptacOperacion.gAhoRetOPCertCanje & "','" & CaptacOperacion.gAhoOPCertificacion & "','" & CaptacOperacion.gAhoRetAnulChq, True)
   ' Call MovimientoTramiteACCMAC(psCadenaRep, "Cuentas de -Ahorro- Movidas en CMACs" & lsAdd, pnPagina, pnItem, psMoneda, psCodUser, psFecha)
    
    psCadenaRep = lsTEM + psCadenaRep
    lsTEM = ""
    Set ofuni = Nothing
End Sub

Public Function ReporteMovACDet(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pnTotDep As Double, pnTotRet As Double, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "", Optional psTipoOpe As String)
    Dim SQL1 As String
    Dim RegTrandiaria As ADODB.Recordset
    Set RegTrandiaria = New ADODB.Recordset
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim i As Long
    Dim lnTDep As Double
    Dim lnTRet As Double
    Dim lnTDepT As Double
    Dim lnTRetT As Double
    Dim lnValor As Double
    Dim lbBan As Boolean
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(MC.cCtaCod,4,2) = '" & lsAgeCod & "' "
    End If
    
    lbBan = False
    
    lnTDep = 0
    lnTRet = 0
    lnTDepT = 0
    lnTRetT = 0
    
    oCon.AbreConexion
    
    If psCodUser = "XXX" Then
        SQL1 = " Select M.cMovNro, MC.cOpeCod, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And bOrdPag = 0 And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & " And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) " & sqlAdd & " And M.cMovNro Like '" & psFecha & "%' ORDER BY CA.cCtaCod"
    Else
        SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And bOrdPag = 0 And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & " And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) " & sqlAdd & "  And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY CA.cCtaCod"
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    If Not (RegTrandiaria.EOF And RegTrandiaria.BOF) Then
     lbBan = True
     psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "- Sin Orden de Pago -", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
     psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;16;Nro.Doc.;20;Monto;22;Usuario;10;Hora;17;Sald.Disp.;22;TInt;11;", pnItem)
    
     While Not RegTrandiaria.EOF
         
         If IsNull(RegTrandiaria!cNumDoc) Then
             lsDoc = " "
         Else
             lsDoc = RegTrandiaria!cNumDoc
         End If
         
         If RegTrandiaria!nMonTran >= 0 Then
             lnTDep = lnTDep + RegTrandiaria!nMonTran
         Else
             lnTRet = lnTRet + (RegTrandiaria!nMonTran * -1)
         End If
         
         If IsNull(RegTrandiaria!nSaldDispAC) Then
             lnValor = 0
         Else
             lnValor = RegTrandiaria!nSaldDispAC
         End If
         
         psCadena = psCadena & Space(20 - Len(RegTrandiaria!cCodCta)) & RegTrandiaria!cCodCta _
                             & Space(20 - Len(Trim(lsDoc))) & Trim(lsDoc) _
                             & Space(19 - Len(Format(RegTrandiaria!nMonTran, "###,##0.00"))) & Format(RegTrandiaria!nMonTran, "###,##0.00") _
                             & Space(10 - Len(Right(RegTrandiaria!cMovNro, 4))) & Right(RegTrandiaria!cMovNro, 4) _
                             & Space(17 - Len(Mid(RegTrandiaria!cMovNro, 9, 6)) - 2) & Mid(RegTrandiaria!cMovNro, 9, 2) & ":" & Mid(RegTrandiaria!cMovNro, 11, 2) & ":" & Mid(RegTrandiaria!cMovNro, 13, 2) _
                             & Space(22 - Len(Format(lnValor, "###,##0.00"))) & Format(lnValor, "###,##0.00") _
                             & Space(11 - Len(Format(RegTrandiaria!nTasaIntAC, "###,##0.00"))) & Format(RegTrandiaria!nTasaIntAC, "###,##0.00") & Chr(10)
                              
         pnItem = pnItem + 1
                 
         If pnItem = lnRango Then
             psCadena = psCadena & Chr(12)
             psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
             psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;16;Nro.Doc.;20;Monto;22;Usuario;10;Hora;17;Sald.Disp.;22;TInt;11;", pnItem)
         End If
         
         RegTrandiaria.MoveNext
       Wend
       
       psCadena = psCadena & ofuni.Encabezado("Resumen;16;" & Trim(Format(lnTDep, "###,##0.00")) & ";42; ;60;", pnItem)
           
        lnTDepT = lnTDepT + lnTDep
        lnTRetT = lnTRetT + lnTRet
        
        lnTDep = 0
        lnTRet = 0

        RegTrandiaria.Close
    End If
    Set RegTrandiaria = Nothing

'Orden de Pago
      
    
    If psCodUser = "XXX" Then
        SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And bOrdPag = 1 And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) " & sqlAdd & " And M.cMovNro Like '" & psFecha & "%' ORDER BY CA.cCtaCod"
    Else
        SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And bOrdPag = 1 And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2)  " & sqlAdd & " And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY CA.cCtaCod"
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If Not (RegTrandiaria.EOF And RegTrandiaria.BOF) Then
     If pnItem < lnRango And lbBan Then
        psCadena = psCadena & Chr(12)
     End If
    
     psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "- Con de Orden Pago-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
     psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;16;Nro.Doc.;20;Monto;22;Usuario;10;Hora;17;Sald.Disp.;22;TInt;11;", pnItem)
    
     While Not RegTrandiaria.EOF
         
         If IsNull(RegTrandiaria!cNumDoc) Then
             lsDoc = " "
         Else
             lsDoc = RegTrandiaria!cNumDoc
         End If
         
         If RegTrandiaria!nMonTran >= 0 Then
             lnTDep = lnTDep + RegTrandiaria!nMonTran
         Else
             lnTRet = lnTRet + (RegTrandiaria!nMonTran * -1)
         End If
         
         If IsNull(RegTrandiaria!nSaldDispAC) Then
             lnValor = 0
         Else
             lnValor = RegTrandiaria!nSaldDispAC
         End If
         
         psCadena = psCadena & Space(20 - Len(RegTrandiaria!cCodCta)) & RegTrandiaria!cCodCta _
                            & Space(20 - Len(Trim(lsDoc))) & Trim(lsDoc) _
                            & Space(19 - Len(Format(RegTrandiaria!nMonTran, "###,##0.00"))) & Format(RegTrandiaria!nMonTran, "###,##0.00") _
                            & Space(10 - Len(Right(RegTrandiaria!cMovNro, 4))) & Right(RegTrandiaria!cMovNro, 4) _
                            & Space(17 - Len(Left(RegTrandiaria!cMovNro, 6)) - 2) & Mid(RegTrandiaria!cMovNro, 9, 2) & ":" & Mid(RegTrandiaria!cMovNro, 11, 2) & ":" & Mid(RegTrandiaria!cMovNro, 13, 2) _
                            & Space(22 - Len(Format(lnValor, "###,##0.00"))) & Format(lnValor, "###,##0.00") _
                            & Space(11 - Len(Format(RegTrandiaria!nTasaIntAC, "###,##0.00"))) & Format(RegTrandiaria!nTasaIntAC, "###,##0.00") & Chr(10)
                            
         pnItem = pnItem + 1
                 
         If pnItem = lnRango Then
             psCadena = psCadena & Chr(12)
             psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
             psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;16;Nro.Doc.;20;Monto;22;Usuario;10;Hora;17;Sald.Disp.;22;TInt;11;", pnItem)
         End If
         
         RegTrandiaria.MoveNext
       Wend
       
       psCadena = psCadena & ofuni.Encabezado("Resumen;16;" & Trim(Format(lnTDep, "###,##0.00")) & ";43; ;59;", pnItem)
           
        lnTDepT = lnTDepT + lnTDep
        lnTRetT = lnTRetT + lnTRet
        
        lnTDep = 0
        lnTRet = 0

        RegTrandiaria.Close
    End If
    
    Set RegTrandiaria = Nothing
    
    If lnTRetT <> 0 Or lnTDepT <> 0 Then
        psCadena = psCadena & ofuni.Encabezado("Resumen;15;" & Trim(Format(lnTDepT, "###,##0.00")) & ";43; ;60;", pnItem)
        
        pnTotRet = pnTotRet + lnTRetT
        pnTotDep = pnTotDep + lnTDepT
        
        psCadena = psCadena & Chr(12)
    End If
    Set ofuni = Nothing
End Function

Public Function MovimientoEfectivoAC(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pnTotDep As Double, pnTotRet As Double, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "", Optional psTipoOpe As String)
    Dim SQL1 As String
    Dim RegTrandiaria As ADODB.Recordset
    Set RegTrandiaria = New ADODB.Recordset
    
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lsDep As String
    Dim lsRet As String
    
    Dim lnTDep As Double
    Dim lnTRet As Double
    
    Dim lnTDepT As Double
    Dim lnTRetT As Double
    Dim lnValor As Double
    Dim lnOpe As Double
    Dim lbBan As Boolean
    
    Dim i As Long
    Dim sqlAdd As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    lnTRet = 0
    lnTDep = 0
    
    oCon.AbreConexion
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(MC.cCtaCod,1,5) Like '___" & lsAgeCod & "' "
    End If
    
    
    If psCodUser = "XXX" Then
        SQL1 = " Select M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And bOrdPag = 0 And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) " & sqlAdd & " And M.cMovNro Like '" & psFecha & "%' ORDER BY CA.cCtaCod"
    Else
        SQL1 = " Select  M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And bOrdPag = 0 And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "   And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY CA.cCtaCod"
              '& " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY CA.cCtaCod"
    End If
    
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If Not (RegTrandiaria.BOF And RegTrandiaria.EOF) Then
        lbBan = True
        psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Efectivo-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
        psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;Sal.Cnt.Ant;20;Deposito;20;Retiro;20;Usu.;6;Hora;12;TInt;8;", pnItem)
        
        While Not RegTrandiaria.EOF
            
            If IsNull(RegTrandiaria!cNumDoc) Then
                lsDoc = " "
            Else
                lsDoc = RegTrandiaria!cNumDoc
            End If
                        
            If Left(RegTrandiaria!cCodOpe, 4) = Left(CaptacOperacion.gAhoDepEfec, 4) Or RegTrandiaria!cCodOpe = CaptacOperacion.gAhoTransAbono Then
                lsDep = Format(RegTrandiaria!nMonTran, "###,##0.00")
                lsRet = "0.00"
                lnTDep = lnTDep + RegTrandiaria!nMonTran
                lnOpe = RegTrandiaria!nMonTran
            Else
                lsDep = "0.00"
                lsRet = Format(-1 * RegTrandiaria!nMonTran, "###,##0.00")
                lnTRet = lnTRet + (RegTrandiaria!nMonTran * -1)
                lnOpe = RegTrandiaria!nMonTran * -1
            End If
            
            If IsNull(RegTrandiaria!nSaldCnt) Then
                lnValor = 0
            Else
                lnValor = RegTrandiaria!nSaldCnt
            End If
            
            psCadena = psCadena & Space(20 - Len(Trim(RegTrandiaria!cCodCta))) & Trim(RegTrandiaria!cCodCta) _
                               & Space(18 - Len(Trim(lsDoc))) & Trim(lsDoc) _
                               & Space(18 - Len(Format(lnValor - lnOpe, "###,##0.00"))) & Format(lnValor - lnOpe, "###,##0.00") _
                               & Space(18 - Len(lsDep)) & lsDep _
                               & Space(20 - Len(lsRet)) & lsRet _
                               & Space(2) & Right(RegTrandiaria!cMovNro, 4) _
                               & Space(2) & Mid(RegTrandiaria!cMovNro, 9, 2) & ":" & Mid(RegTrandiaria!cMovNro, 11, 2) & ":" & Mid(RegTrandiaria!cMovNro, 13, 2) _
                               & Space(8 - Len(Format(RegTrandiaria!nTasaIntAC, "###,##0.00"))) & Format(RegTrandiaria!nTasaIntAC, "###,##0.00") & Chr(10)
                               
            pnItem = pnItem + 1
                    
            If pnItem = lnRango Then
                psCadena = psCadena & Chr(12)
                psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Efectivo-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;Sal.Cnt.Ant;20;Deposito;20;Retiro;20;Usu.;6;Hora;12;TInt;8;", pnItem)
            End If
            
            RegTrandiaria.MoveNext
        Wend
        
        psCadena = psCadena & ofuni.Encabezado("Resumen;15;" & Format(lnTDep, "###,##0.00") & ";57;" & Format(lnTRet, "###,##0.00") & ";20; ;26;", pnItem)
        
        lnTRetT = lnTRet
        lnTDepT = lnTDep
            
        RegTrandiaria.Close
    End If
    
    'Ordenes de Pago
    lnTRet = 0
    lnTDep = 0
    
    If psCodUser = "XXX" Then
        SQL1 = " Select M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And bOrdPag = 1 And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) " & sqlAdd & " And M.cMovNro Like '" & psFecha & "%' ORDER BY CA.cCtaCod"
    Else
        SQL1 = " Select  M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And bOrdPag = 1 And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "   " & sqlAdd & " And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY CA.cCtaCod"
              '& " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) " & sqlAdd & " And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY CA.cCtaCod"
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If Not (RegTrandiaria.BOF And RegTrandiaria.EOF) Then
        If pnItem < lnRango And lbBan Then
            psCadena = psCadena & Chr(12)
        End If
        
        psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Orden de Pago-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
        psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;Sal.Cnt.Ant;20;Deposito;20;Retiro;20;Usu.;6;Hora;12;TInt;8;", pnItem)
        
        While Not RegTrandiaria.EOF
            
            If IsNull(RegTrandiaria!cNumDoc) Then
                lsDoc = " "
            Else
                lsDoc = RegTrandiaria!cNumDoc
            End If
            
            
            If Left(RegTrandiaria!cCodOpe, 4) = Left(CaptacOperacion.gAhoDepEfec, 4) Or RegTrandiaria!cCodOpe = CaptacOperacion.gAhoTransAbono Then
                lsDep = Format(RegTrandiaria!nMonTran, "###,##0.00")
                lsRet = "0.00"
                lnTDep = lnTDep + RegTrandiaria!nMonTran
                lnOpe = RegTrandiaria!nMonTran
            Else
                lsDep = "0.00"
                lsRet = Format(-1 * RegTrandiaria!nMonTran, "###,##0.00")
                lnTRet = lnTRet + (RegTrandiaria!nMonTran * -1)
                lnOpe = RegTrandiaria!nMonTran * -1
            End If
            
            If IsNull(RegTrandiaria!nSaldCnt) Then
                lnValor = 0
            Else
                lnValor = RegTrandiaria!nSaldCnt
            End If
            
            psCadena = psCadena & Space(20 - Len(Trim(RegTrandiaria!cCodCta))) & Trim(RegTrandiaria!cCodCta) _
                                & Space(18 - Len(Trim(lsDoc))) & Trim(lsDoc) _
                                & Space(18 - Len(Format(lnValor - lnOpe, "###,##0.00"))) & Format(lnValor - lnOpe, "###,##0.00") _
                                & Space(18 - Len(lsDep)) & lsDep _
                                & Space(20 - Len(lsRet)) & lsRet _
                                & Space(2) & Right(RegTrandiaria!cMovNro, 4) _
                                & Space(2) & Mid(RegTrandiaria!cMovNro, 9, 2) & ":" & Mid(RegTrandiaria!cMovNro, 11, 2) & ":" & Mid(RegTrandiaria!cMovNro, 13, 2) _
                                & Space(8 - Len(Format(RegTrandiaria!nTasaIntAC, "###,##0.00"))) & Format(RegTrandiaria!nTasaIntAC, "###,##0.00") & Chr(10)
                               
            pnItem = pnItem + 1
                    
            If pnItem = lnRango Then
                psCadena = psCadena & Chr(12)
                psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Orden de Pago-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;Sal.Cnt.Ant;20;Deposito;20;Retiro;20;Usu.;6;Hora;12;TInt;8;", pnItem)
            End If
            
            RegTrandiaria.MoveNext
        Wend
        
        lnTRetT = lnTRetT + lnTRet
        lnTDepT = lnTDepT + lnTDep
        
        psCadena = psCadena & ofuni.Encabezado("Resumen;15;" & Format(lnTDep, "###,##0.00") & ";57;" & Format(lnTRet, "###,##0.00") & ";20; ;26;", pnItem)
        
        RegTrandiaria.Close
        Set RegTrandiaria = Nothing
    End If
    
    If lnTRetT <> 0 Or lnTDepT <> 0 Then
        psCadena = psCadena & ofuni.Encabezado("Resumen;15;" & Format(lnTDepT, "###,##0.00") & ";57;" & Format(lnTRetT, "###,##0.00") & ";20; ;26;", pnItem)
        pnTotRet = pnTotRet + lnTRetT
        pnTotDep = pnTotDep + lnTDepT
        
        psCadena = psCadena & Chr(12)
    End If
    Set ofuni = Nothing
    
End Function

Private Sub PonerSalto(rtf As String)
    If rtf = "" Then Exit Sub
    If Right(rtf, 1) <> Chr(12) Then
        rtf = rtf & Chr(12)
    End If
End Sub

Private Sub QuitarSalto(rtf As String)
    If Right(rtf, 1) = Chr(12) Then
        rtf = Mid(rtf, 1, Len(rtf) - 1)
    End If
End Sub

'**********************************************************
'CMAC's
'**********************************************************
'Movimiento que se realiza con cuentas de esta agencia pero
'por otro servidor
'Public Function MovimientoExternoACCmact(psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pdFI As Date, pdFF As Date, Optional psMoneda As String = "1", Optional psCodUser As String = "XXX", Optional psTipoOpe As String) As String
'    Dim SQL1 As String
'    Dim RegTrandiaria As New ADODB.Recordset
'    Dim lsDoc As String
'    Dim lsCodCta As String
'    Dim lsDep As String
'    Dim lsRet As String
'    Dim lsCodUsu As String
'
'    Dim lnTDep As Double
'    Dim lnTRet As Double
'    Dim lnTDepTT As Double
'    Dim lnTRetTT As Double
'
'    Dim lbBan As Boolean
'
'    Dim I As Long
'
'    Dim lsGru As String
'
'    Dim lnTDepAge As Double
'    Dim lnTRetAge As Double
'
'    Dim lnTDepCMAC As Double
'    Dim lnTRetCMAC As Double
'
'    Dim lsNomOpe As String * 40
'    Dim lsProd As String
'    Dim lsOP As String
'
'    lnTRet = 0
'    lnTDep = 0
'    lnTRetTT = 0
'    lnTDepTT = 0
'
'    lbBan = False
'
'    Dim lsFI As String
'    Dim lsFF As String
'
'    lsFI = Format(pdFI, oFunF.gsFormatoFecha)
'    lsFF = Format(DateAdd("d", 1, pdFF), oFunF.gsFormatoFecha)
'
'    If psCodUser = "XXX" Then
'        SQL1 = "select dFecTran,nNumTran,cCodOpe,cGlosa,cNumDoc,cCodPers,cFlag,cCodCta,nMonTran,cCodAge,cCodUsu " _
'             & "from otrasope where ccodope in " _
'             & "(select ccodope from " & gcCentralCom & "Operacion where cGruProd in " _
'             & "(select cGruProd from " & gcCentralCom & "OpeGru where ccodtab = 'AA03' and cMovCaj = 'N' and cIngEgr = 'I')) and SubString(cCodCta,6,1) = '" & psMoneda & "' and cFlag is null and (dFecTran between '" & lsFI & "' and '" & lsFF & "') " _
'             & "Union " _
'             & "select dFecTran,nNumTran,cCodOpe,cGlosa,cNumDoc,cCodPers,cFlag,cCodCta,nMonTran = nMonTran * -1 ,cCodAge,cCodUsu " _
'             & "from otrasope where ccodope in " _
'             & "(select ccodope from " & gcCentralCom & "Operacion where cGruProd in " _
'             & "(select cGruProd from " & gcCentralCom & "OpeGru where ccodtab = 'AA03' and cMovCaj = 'N' and cIngEgr = 'E')) and SubString(cCodCta,6,1) = '" & psMoneda & "' and cFlag is null and (dFecTran between '" & lsFI & "' and '" & lsFF & "') order by cCodAge, dFecTran"
'    Else
'        SQL1 = "select dFecTran,nNumTran,cCodOpe,cGlosa,cNumDoc,cCodPers,cFlag,cCodCta,nMonTran,cCodAge,cCodUsu " _
'             & "from otrasope where ccodope in " _
'             & "(select ccodope from " & gcCentralCom & "Operacion where cGruProd in " _
'             & "(select cGruProd from " & gcCentralCom & "OpeGru where ccodtab = 'AA03' and cMovCaj = 'N' and cIngEgr = 'I')) and SubString(cCodCta,6,1) = '" & psMoneda & "' and cFlag is null and (dFecTran between '" & lsFI & "' and '" & lsFF & "') and cCodUsu = '" & psCodUser & "'" _
'             & "Union " _
'             & "select dFecTran,nNumTran,cCodOpe,cGlosa,cNumDoc,cCodPers,cFlag,cCodCta,nMonTran = nMonTran * -1 ,cCodAge,cCodUsu " _
'             & "from otrasope where ccodope in " _
'             & "(select ccodope from " & gcCentralCom & "Operacion where cGruProd in " _
'             & "(select cGruProd from " & gcCentralCom & "OpeGru where ccodtab = 'AA03' and cMovCaj = 'N' and cIngEgr = 'E')) and SubString(cCodCta,6,1) = '" & psMoneda & "' and cFlag is null and (dFecTran between '" & lsFI & "' and '" & lsFF & "') and cCodUsu = '" & psCodUser & "' order by cCodAge, dFecTran"
'    End If
'
'    'RegTrandiaria.Open SQL1, dbCmact, adOpenForwardOnly, adLockOptimistic, adCmdText
'
'    If Not RSVacio(RegTrandiaria) Then
'        lbBan = False
'        'psCadena = psCadena & CabeceraPagina(psTitulo, pnPagina, pnItem, psMoneda)
'        'psCadena = psCadena & Encabezado("NroDocCMAC;10;Tipo Operacion;40;Nro Cuenta;14;Deposito;17;Retiro;17;Usu;6;FechaHora;24;Pro.;4;OP;4;", pnItem)
'
'        lsGru = ""
'
'        lnTRetCMAC = 0
'        lnTDepCMAC = 0
'
'
'        While Not RegTrandiaria.EOF
'            lbBan = True
'            If lsGru <> "" And lsGru <> RegTrandiaria!cCodAge Then
'                psCadena = psCadena & Encabezado("Total Agencia;15; ;18;" & Format(lnTDepAge, "###,##0.00") & ";50;" & Format(lnTRetAge, "###,##0.00") & ";17; ;36;", pnItem)
'
'                If Mid(lsGru, 1, 3) <> Mid(RegTrandiaria!cCodAge, 1, 3) Then
'                    psCadena = psCadena & Encabezado("Total CMAC;15; ;18;" & Format(lnTDepCMAC, "###,##0.00") & ";50;" & Format(lnTRetCMAC, "###,##0.00") & ";17; ;36;", pnItem)
'                    lnTRetCMAC = 0
'                    lnTDepCMAC = 0
'                End If
'
'                lnTRetAge = 0
'                lnTDepAge = 0
'                lbBan = True
'            End If
'
'            If Len(RegTrandiaria!cCodCta) = 18 Then
'                If lsGru <> RegTrandiaria!cCodAge Then
'                    lsGru = RegTrandiaria!cCodAge
'                    psCadena = psCadena & Encabezado("Agencia: " & RegTrandiaria!cAgeDescripcion & ";32;", pnItem)
'                    lbBan = True
'                End If
'            ElseIf Len(RegTrandiaria!cCodCta) = 8 Then
'                If lsGru <> RegTrandiaria!cCodAge Then
'                    lsGru = RegTrandiaria!cCodAge
'                    psCadena = psCadena & Encabezado("Agencia: " & RegTrandiaria!cAgeDescripcion & ";32;", pnItem)
'                    lbBan = True
'                End If
'            End If
'
'            If IsNull(RegTrandiaria!cNumDoc) Then
'                lsDoc = " "
'            Else
'                lsDoc = RegTrandiaria!cNumDoc
'            End If
'
'            If RegTrandiaria!nMonTran >= 0 Then
'                lsDep = Format(RegTrandiaria!nMonTran, "###,##0.00")
'                lsRet = "0.00"
'                lnTDep = lnTDep + RegTrandiaria!nMonTran
'                lnTDepAge = lnTDepAge + RegTrandiaria!nMonTran
'                lnTDepCMAC = lnTDepCMAC + RegTrandiaria!nMonTran
'            Else
'                lsDep = "0.00"
'                lsRet = Format(RegTrandiaria!nMonTran, "###,##0.00")
'                lnTRet = lnTRet + (RegTrandiaria!nMonTran)
'                lnTRetAge = lnTRetAge + RegTrandiaria!nMonTran
'                lnTRetCMAC = lnTRetCMAC + RegTrandiaria!nMonTran
'            End If
'
'            If IsNull(RegTrandiaria!cCodUsu) Then
'                lsCodUsu = ""
'            Else
'                lsCodUsu = RegTrandiaria!cCodUsu
'            End If
'
'            lsProd = GetProducto(RegTrandiaria!cCodCta)
'            lsOP = IIf(VerificaCtaOP(RegTrandiaria!cCodCta), "OP", "")
'
'            lsNomOpe = GetNomOpe(RegTrandiaria!cCodOpe, 40)
'            'lsDoc
'            psCadena = psCadena & Space(10 - Len(lsDoc) - 3) & Mid(gsCodAge, 4, 2) & "-" & lsDoc _
'                               & Space(2) & lsNomOpe _
'                               & Space(2) & RegTrandiaria!cCodCta _
'                               & Space(17 - Len(lsDep)) & lsDep _
'                               & Space(17 - Len(lsRet)) & lsRet _
'                               & Space(6 - Len(lsCodUsu)) & lsCodUsu _
'                               & Space(24 - Len(Format(RegTrandiaria!dFectran, "dd/mm/yyyy hh:mm:ss AMPM"))) & Format(RegTrandiaria!dFectran, "dd/mm/yyyy hh:mm:ss AMPM") _
'                               & Space(4 - Len(lsProd)) & lsProd _
'                               & Space(3 - Len(lsOP)) & lsOP & Chr(10)
'            pnItem = pnItem + 1
'
'            If pnItem = lnRango Then
'                psCadena = psCadena & Chr(12)
'                psCadena = psCadena & CabeceraPagina(psTitulo & "-Efectivo-", pnPagina, pnItem, psMoneda)
'                psCadena = psCadena & Encabezado("NroDocCMAC;10;Tipo Operacion;40;Nro Cuenta;14;Deposito;17;Retiro;17;Usu;6;FechaHora;24;Pro.;4;OP;4;", pnItem)
'            End If
'
'            RegTrandiaria.MoveNext
'        Wend
'
'        If lbBan Then
'            psCadena = psCadena & Encabezado("Total Agencia;15; ;18;" & Format(lnTDepAge, "###,##0.00") & ";50;" & Format(lnTRetAge, "###,##0.00") & ";17; ;36;", pnItem)
'            psCadena = psCadena & Encabezado("Total CMAC;15; ;18;" & Format(lnTDepCMAC, "###,##0.00") & ";50;" & Format(lnTRetCMAC, "###,##0.00") & ";17; ;36;", pnItem)
'        End If
'        'psCadena = psCadena & Encabezado("Total ;30;" & Format(lnTDep, "###,##0.00") & ";53;" & Format(lnTRet, "###,##0.00") & ";17; ;36;", pnItem)
'
'        lnTRetTT = lnTRet
'        lnTDepTT = lnTDep
'
'        pnItem = pnItem + 1
'
'        RegTrandiaria.Close
'    End If
'    Set RegTrandiaria = Nothing
'
'    If lnTRetTT <> 0 Or lnTDepTT <> 0 Then
'        psCadena = psCadena & Encabezado("Total ;30;" & Format(lnTDepTT, "###,##0.00") & ";53;" & Format(lnTRetTT, "###,##0.00") & ";17; ;36;", pnItem)
'
'        psCadena = psCadena & Chr(12)
'    End If
'End Function

'Movimiento que se realiza con cuentas de esta agencia pero
'por otro servidor
Private Function MovimientoExternoAC(psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "", Optional psTipoOpe As String, Optional pbEsTramite As Boolean = False)
    Dim SQL1 As String
    Dim RegTrandiaria As ADODB.Recordset
    Set RegTrandiaria = New ADODB.Recordset
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lsDep As String
    Dim lsRet As String
    Dim lsCodUsu As String
    
    Dim lnTDep As Double
    Dim lnTRet As Double
    Dim lnTDepTT As Double
    Dim lnTRetTT As Double
    
    Dim lbBan As Boolean
    
    Dim i As Long
    
    Dim lsGru As String
    
    Dim lnTDepAge As Double
    Dim lnTRetAge As Double
    
    Dim lsCadAdd As String
    
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    oCon.AbreConexion
    
    lnTRet = 0
    lnTDep = 0
    lnTRetTT = 0
    lnTDepTT = 0
    
    lbBan = False

    If pbEsTramite Then
        If psCodUser = "XXX" Then
            SQL1 = " Select M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion , Substring(MC.cCtaCod,4,2) cCodAge" _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(MC.cCtaCod,4,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And bOrdPag = 0 And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(M.cMovNro,18,2) = '" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%' ORDER BY Substring(MC.cCtaCod,4,2), CA.cCtaCod"
        Else
            SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion, Substring(MC.cCtaCod,4,2) cCodAge " _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(MC.cCtaCod,4,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And bOrdPag = 0 And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(MC.cCtaCod,18,2) = '" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY Substring(MC.cCtaCod,4,2), CA.cCtaCod"
        End If
    Else
        If psCodUser = "XXX" Then
            SQL1 = " Select M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion , Substring(M.cMovNro,18,2) cCodAge" _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(M.cMovNro,18,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And bOrdPag = 0 And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(MC.cCtaCod,1,5) Like '___" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%' ORDER BY Substring(M.cMovNro,18,2), CA.cCtaCod"
        Else
            SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion, Substring(M.cMovNro,18,2) cCodAge " _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(M.cMovNro,18,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And bOrdPag = 0 And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(MC.cCtaCod,1,5) Like '___" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY Substring(M.cMovNro,18,2), CA.cCtaCod"
        End If
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If Not (RegTrandiaria.EOF And RegTrandiaria.BOF) Then
        lbBan = False
        psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Efectivo-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
        psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;Sald.Cnt.Ant.;20;Deposito;20;Retiro;20;Usu.R;6;Hora;12;TInt;8;", pnItem)
        
        lsGru = ""
        'Mid(RegTrandiaria!cMovNro, 9, 2) & ":" & Mid(RegTrandiaria!cMovNro, 11, 2) & ":" & Mid(RegTrandiaria!cMovNro, 13, 2)
        
        While Not RegTrandiaria.EOF
            lbBan = True
            If lsGru <> "" And lsGru <> RegTrandiaria!CCodage Then
                psCadena = psCadena & ofuni.Encabezado("Total Agencia;15;" & Format(lnTDepAge, "###,##0.00") & ";57;" & Format(lnTRetAge, "###,##0.00") & ";20; ;26;", pnItem)
                lnTRetAge = 0
                lnTDepAge = 0
                lbBan = True
            End If
            
            If Len(RegTrandiaria!cCodCta) = 18 Then
                If lsGru <> RegTrandiaria!CCodage Then
                    lsGru = RegTrandiaria!CCodage
                    psCadena = psCadena & ofuni.Encabezado("Agencia: " & RegTrandiaria!cAgeDescripcion & ";32;", pnItem)
                    lbBan = True
                End If
            ElseIf Len(RegTrandiaria!cCodCta) = 8 Then
                If lsGru <> RegTrandiaria!CCodage Then
                    lsGru = RegTrandiaria!CCodage
                    psCadena = psCadena & ofuni.Encabezado("Agencia: " & RegTrandiaria!cAgeDescripcion & ";32;", pnItem)
                    lbBan = True
                End If
            End If
            
            If IsNull(RegTrandiaria!cNumDoc) Then
                lsDoc = " "
            Else
                lsDoc = RegTrandiaria!cNumDoc
            End If
            
            If RegTrandiaria!nMonTran >= 0 Then
                lsDep = Format(RegTrandiaria!nMonTran, "###,##0.00")
                lsRet = "0.00"
                lnTDep = lnTDep + RegTrandiaria!nMonTran
                lnTDepAge = lnTDepAge + RegTrandiaria!nMonTran
            Else
                lsDep = "0.00"
                lsRet = Format(-1 * RegTrandiaria!nMonTran, "###,##0.00")
                lnTRet = lnTRet + (RegTrandiaria!nMonTran * -1)
                lnTRetAge = lnTRetAge + RegTrandiaria!nMonTran
            End If
            
            lsCodUsu = Right(RegTrandiaria!cMovNro, 4)

            psCadena = psCadena & Space(20 - Len(RegTrandiaria!cCodCta)) & RegTrandiaria!cCodCta _
                                & Space(18 - Len(Trim(lsDoc))) & Trim(lsDoc) _
                                & Space(19 - Len(Format(RegTrandiaria!nSaldCnt - RegTrandiaria!nMonTran, "###,##0.00"))) & Format(RegTrandiaria!nSaldCnt - RegTrandiaria!nMonTran, "###,##0.00") _
                                & Space(19 - Len(lsDep)) & lsDep _
                                & Space(19 - Len(lsRet)) & lsRet _
                                & Space(6 - Len(lsCodUsu)) & lsCodUsu _
                                & Space(2) & Mid(RegTrandiaria!cMovNro, 9, 2) & ":" & Mid(RegTrandiaria!cMovNro, 11, 2) & ":" & Mid(RegTrandiaria!cMovNro, 13, 2) _
                                & Space(8 - Len(Format(RegTrandiaria!nTasaIntAC, "###,##0.00"))) & Format(RegTrandiaria!nTasaIntAC, "###,##0.00") & Chr(10)
                               
            pnItem = pnItem + 1
                    
            If pnItem = lnRango Then
                psCadena = psCadena & Chr(12)
                psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Efectivo-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;Sald.Cnt.Ant.;20;Deposito;20;Retiro;20;Usu.R;6;Hora;12;TInt;8;", pnItem)
            End If
            
            RegTrandiaria.MoveNext
        Wend
        
        If lbBan Then psCadena = psCadena & ofuni.Encabezado("Total Agencia;15;" & Format(lnTDepAge, "###,##0.00") & ";57;" & Format(lnTRetAge, "###,##0.00") & ";20; ;26;", pnItem)
        
        psCadena = psCadena & ofuni.Encabezado("Total ;12;" & Format(lnTDep, "###,##0.00") & ";60;" & Format(lnTRet, "###,##0.00") & ";20; ;26;", pnItem)
    
        lnTRetTT = lnTRet
        lnTDepTT = lnTDep
   
        pnItem = pnItem + 1
        
        RegTrandiaria.Close
    End If
    Set RegTrandiaria = Nothing
   
    'Ordenes de Pago
    lnTRet = 0
    lnTDep = 0
    lnTRetAge = 0
    lnTDepAge = 0
    
    If psCodUser = "XXX" Then
        SQL1 = " Select M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion, Substring(MC.cCtaCod,4,2) cCodAge" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(M.cMovNro,18,2)" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And bOrdPag = 1 And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
              & " And Substring(MC.cCtaCod,1,5) Like '___" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%' ORDER BY Substring(MC.cCtaCod,4,2), CA.cCtaCod"
    Else
        SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion, Substring(MC.cCtaCod,4,2) cCodAge" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacAhorros CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(M.cMovNro,18,2)" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And bOrdPag = 1 And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
              & " And Substring(MC.cCtaCod,1,5) Like '___" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY Substring(MC.cCtaCod,4,2), CA.cCtaCod"
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If Not (RegTrandiaria.EOF And RegTrandiaria.BOF) Then
        If pnItem < lnRango And lbBan Then
            psCadena = psCadena & Chr(12)
        End If
        
        lbBan = False
        
        psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Orden de Pago-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
        psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;Sald.Cnt.Ant.;20;Deposito;20;Retiro;20;UsuR.;6;Hora;12;TInt;8;", pnItem)
    
        lsGru = ""
        
        While Not RegTrandiaria.EOF
            
            If lsGru <> "" And lsGru <> RegTrandiaria!CCodage Then
                psCadena = psCadena & ofuni.Encabezado("Total Agencia;15;" & Format(lnTDepAge, "###,##0.00") & ";57;" & Format(lnTRetAge, "###,##0.00") & ";20; ;26;", pnItem)
                lnTRetAge = 0
                lnTDepAge = 0
                lbBan = True
            End If
            
            If Len(RegTrandiaria!cCodCta) = 18 Then
                If lsGru <> RegTrandiaria!CCodage Then
                    lsGru = RegTrandiaria!CCodage
                    psCadena = psCadena & ofuni.Encabezado("Agencia: " & RegTrandiaria!cAgeDescripcion & ";32;", pnItem)
                    lbBan = True
                End If
            ElseIf Len(RegTrandiaria!cCodCta) = 8 Then
                If lsGru <> RegTrandiaria!CCodage Then
                    lsGru = RegTrandiaria!CCodage
                    psCadena = psCadena & ofuni.Encabezado("Agencia: " & RegTrandiaria!cAgeDescripcion & ";32;", pnItem)
                    lbBan = True
                End If
            End If
            
            If IsNull(RegTrandiaria!cNumDoc) Then
                lsDoc = " "
            Else
                lsDoc = Trim(RegTrandiaria!cNumDoc)
            End If
            
            If RegTrandiaria!nMonTran >= 0 Then
                lsDep = Format(RegTrandiaria!nMonTran, "###,##0.00")
                lsRet = "0.00"
                lnTDep = lnTDep + RegTrandiaria!nMonTran
                lnTDepAge = lnTDepAge + RegTrandiaria!nMonTran
            Else
                lsDep = "0.00"
                lsRet = Format(-1 * RegTrandiaria!nMonTran, "###,##0.00")
                lnTRet = lnTRet + (RegTrandiaria!nMonTran * -1)
                lnTRetAge = lnTRetAge + RegTrandiaria!nMonTran
            End If
            
            lsCodUsu = Right(RegTrandiaria!cMovNro, 4)
            
            psCadena = psCadena & Space(20 - Len(RegTrandiaria!cCodCta)) & RegTrandiaria!cCodCta _
                               & Space(18 - Len(Trim(lsDoc))) & Trim(lsDoc) _
                               & Space(19 - Len(Format(RegTrandiaria!nSaldCnt - RegTrandiaria!nMonTran, "###,##0.00"))) & Format(RegTrandiaria!nSaldCnt - RegTrandiaria!nMonTran, "###,##0.00") _
                               & Space(19 - Len(lsDep)) & lsDep _
                               & Space(19 - Len(lsRet)) & lsRet _
                               & Space(6 - Len(lsCodUsu)) & lsCodUsu _
                               & Space(2) & Mid(RegTrandiaria!cMovNro, 9, 2) & ":" & Mid(RegTrandiaria!cMovNro, 11, 2) & ":" & Mid(RegTrandiaria!cMovNro, 13, 2) _
                               & Space(8 - Len(Format(RegTrandiaria!nTasaIntAC, "###,##0.00"))) & Format(RegTrandiaria!nTasaIntAC, "###,##0.00") & Chr(10)
                               
            pnItem = pnItem + 1
                    
            If pnItem = lnRango Then
                psCadena = psCadena & Chr(12)
                psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Orden de Pago-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;Sald.Cnt.Ant.;20;Deposito;20;Retiro;20;UsuR.;6;Hora;12;TInt;8;", pnItem)
            End If
            
            RegTrandiaria.MoveNext
        Wend
        
        If lbBan Then psCadena = psCadena & ofuni.Encabezado("Total Agencia;15;" & Format(lnTDepAge, "###,##0.00") & ";57;" & Format(lnTRetAge, "###,##0.00") & ";20; ;26;", pnItem)
        
        psCadena = psCadena & ofuni.Encabezado("Total ;12;" & Format(lnTDep, "###,##0.00") & ";60;" & Format(lnTRet, "###,##0.00") & ";20; ;26;", pnItem)
        
        lnTRetTT = lnTRetTT + lnTRet
        lnTDepTT = lnTDepTT + lnTDep
        
        pnItem = pnItem + 1
        
        RegTrandiaria.Close
    End If
    Set RegTrandiaria = Nothing
    
    If lnTRetTT <> 0 Or lnTDepTT <> 0 Then
        psCadena = psCadena & ofuni.Encabezado("Total ;12;" & Format(lnTDepTT, "###,##0.00") & ";60;" & Format(lnTRetTT, "###,##0.00") & ";20; ;26;", pnItem)
        psCadena = psCadena & Chr(12)
    End If
     Set ofuni = Nothing
End Function

'************************************************************************
'PLAZO FIJO
'********************************************************************************************
Private Sub ReporteMovPF(ByRef psCadenaRep As String, psTitulo As String, pnPagina As Long, pnItem As Long, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "")
    Dim SQL1 As String
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lnDep As Double
    Dim lnRet As Double

    Dim lnTotDep As Double
    Dim lnTotRet As Double
    Dim lsCebecera As String

    Dim lsTEM As String
    Dim i As Long
    Dim lsAdd As String
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    lnTotRet = 0
    lnTotDep = 0

    lsAdd = IIf(psFecha = "", "", " Del " & Right(psFecha, 2) & "/" & Mid(psFecha, 5, 2) & "/" & Left(psFecha, 4))
    If psCodUser = "XXX" Then
        lsCebecera = ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    Else
        lsCebecera = ofuni.CabeceraPagina(psTitulo & " " & psCodUser, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    End If

    pnPagina = pnPagina - 1

    lsTEM = psCadenaRep

    psCadenaRep = ""

    Call ReporteAperturasPF(psCadenaRep, "Apertura de Cuentas PlazoFijo-Efectivo" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovPFApeEfec, , True))
    Call ReporteAperturasPF(psCadenaRep, "Movimientos en Efectivo de Cuentas de Plazo Fijo" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovPFMovEfec, , True))
    Call ReporteAperturasPF(psCadenaRep, "Apertura de Cuentas Plazo Fijo-Cheque" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovPFApeCheque, , True))
    Call ReporteAperturasPF(psCadenaRep, "Apertura de Cuentas Plazo Fijo-Transferencia" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovPFApeTreansferencia, , True))
    Call ReporteAperturasPF(psCadenaRep, "Movimientos Sin Efectivo de Cuentas de Plazo Fijo" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovPFMovSinEfec, , True))
    Call ReporteAperturasPF(psCadenaRep, "Cancelación de Cuentas Plazo Fijo" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovPFCancelacion, , True))

    If lnTotDep <> 0 Or lnTotRet <> 0 Then
        psCadenaRep = lsCebecera & psCadenaRep
        QuitarSalto psCadenaRep
        psCadenaRep = psCadenaRep & ofuni.Encabezado("Resumen Total;15;" & Trim(Format(lnTotDep, "###,##0.00")) & ";57;" & Trim(Format(lnTotRet, "###,##0.00")) & ";20; ;26;", pnItem)
        psCadenaRep = psCadenaRep & ofuni.Encabezado("Monto Total;15;" & Trim(Format(lnTotDep - lnTotRet, "###,##0.00")) & ";57; ;46;", pnItem)
        psCadenaRep = psCadenaRep & Chr(12)
    End If

    lnTotRet = 0
    lnTotDep = 0

    'Call MovimientoExternosPF(psCadenaRep, "Cuentas de -Plazo Fijo- Movidas por otras Agencias o CMAC's" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, CaptacOperacion.gPFRetInt & "','" & CaptacOperacion.gPFRetIntAboAho)
    'Call MovimientoExternosPF(psCadenaRep, "Cuentas Canceladas de -Plazo Fijo- por otras Agencias o CMAC's" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, CaptacOperacion.gPFCancelacion)
    'Call MovimientoExternosPF(psCadenaRep, "Cuentas de -Plazo Fijo- Movidas en otras Agencias o CMAC's" & lsAdd, pnPagina, pnItem, 0, 0, psMoneda, psCodUser, psFecha, CaptacOperacion.gPFRetInt & "','" & CaptacOperacion.gPFRetIntAboAho, True)

    psCadenaRep = lsTEM + psCadenaRep
    lsTEM = ""
    Set ofuni = Nothing
End Sub

Private Sub ReporteAperturasPF(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pnTotDep As Double, pnTotRet As Double, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "", Optional psTipoOpe As String)
    Dim SQL1 As String
    Dim RegTrandiaria As ADODB.Recordset
    Set RegTrandiaria = New ADODB.Recordset
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim i As Long
    Dim lnTDep As Double
    Dim lnTRet As Double
    Dim lnValor As Double
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    Dim sqlAdd As String
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(MC.cCtaCod,4,2) = '" & lsAgeCod & "' "
    End If
    
    If psCodUser = "XXX" Then
        SQL1 = " Select M.cMovNro, MC.cOpeCod, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispPF, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntPF, nPlazo Plazo, nSaldoContable nSaldCnt" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacPlazoFijo CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & " And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) " & sqlAdd & " And M.cMovNro Like '" & psFecha & "%' ORDER BY CA.cCtaCod"
    Else
        SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispPF, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntPF, nPlazo Plazo, nSaldoContable nSaldCnt" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacPlazoFijo CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & " And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) " & sqlAdd & "  And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY CA.cCtaCod"
    End If
    
    oCon.AbreConexion
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
     If RegTrandiaria.EOF And RegTrandiaria.BOF Then
         Exit Sub
     End If
     
     psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
     psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;15;Nro.Doc.;20;Monto;20;Usu.;9;Hora;15;Sald.Disp.;20;TInt;9;D.Plazo;10;", pnItem)
    
     While Not RegTrandiaria.EOF
         If IsNull(RegTrandiaria!cNumDoc) Then
             lsDoc = " "
         Else
             lsDoc = RegTrandiaria!cNumDoc
         End If
         
         If RegTrandiaria!nMonTran >= 0 Then
             lnTDep = lnTDep + RegTrandiaria!nMonTran
         Else
             lnTRet = lnTRet + (RegTrandiaria!nMonTran * -1)
         End If
         
         If IsNull(RegTrandiaria!nSaldCnt) Then
             lnValor = 0
         Else
             lnValor = RegTrandiaria!nSaldCnt
         End If
         
         psCadena = psCadena & Space(19 - Len(RegTrandiaria!cCodCta)) & RegTrandiaria!cCodCta _
                             & Space(18 - Len(Trim(lsDoc))) & Trim(lsDoc) _
                             & Space(18 - Len(Format(RegTrandiaria!nMonTran, "###,##0.00"))) & Format(RegTrandiaria!nMonTran, "###,##0.00") _
                             & Space(9 - Len(Right(RegTrandiaria!cMovNro, 4))) & Right(RegTrandiaria!cMovNro, 4) _
                             & Space(15 - 6) & Mid(RegTrandiaria!cMovNro, 9, 2) & ":" & Mid(RegTrandiaria!cMovNro, 11, 2) & ":" & Mid(RegTrandiaria!cMovNro, 13, 2) _
                             & Space(20 - Len(Format(lnValor, "###,##0.00"))) & Format(lnValor, "###,##0.00") _
                             & Space(9 - Len(Format(RegTrandiaria!nTasaIntPF, "###,##0.00"))) & Format(RegTrandiaria!nTasaIntPF, "###,##0.00") _
                             & Space(10 - Len(Str(RegTrandiaria!Plazo))) & Str(RegTrandiaria!Plazo) & Chr(10)
         pnItem = pnItem + 1
                 
         If pnItem = lnRango Then
             psCadena = psCadena & Chr(12)
             psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
             '****Modificado por ELRO el 20120817, según SATI INC1208160005
             'psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;15;Nro.Doc.;20;Monto;20;Usu.;9;Hora;15;Sald.Disp.;20;TInt;9;D.Plazo;10", pnItem)
             psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;15;Nro.Doc.;20;Monto;20;Usu.;9;Hora;15;Sald.Disp.;20;TInt;9;D.Plazo;10;", pnItem)
             '****Fin Modificado por ELRO el 20120817*********************
         End If
         
         RegTrandiaria.MoveNext
    Wend
    
    If lnTRet <> 0 Or lnTDep <> 0 Then
        psCadena = psCadena & ofuni.Encabezado("Resumen;15;" & Trim(Format(lnTDep, "###,##0.00")) & ";40; ;63;", pnItem)
        
        pnTotRet = pnTotRet + lnTRet
        pnTotDep = pnTotDep + lnTDep
        
        psCadena = psCadena & Chr(12)
    End If
    Set ofuni = Nothing
End Sub

'Operacioens hechas por otras agencias en este servidor
Private Function MovimientoExternosPF(psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pnTotDep As Double, pnTotRet As Double, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "", Optional psTipoOpe As String = "", Optional pbEsTramite As Boolean = False)
    Dim SQL1 As String
    Dim RegTrandiaria As ADODB.Recordset
    Set RegTrandiaria = New ADODB.Recordset
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lsDep As String
    Dim lsRet As String
    
    Dim lnTDep As Double
    Dim lnTRet As Double
    
    Dim lnTDepT As Double
    Dim lnTRetT As Double
    Dim lnValor As Double
    Dim lnOpe As Double
    
    Dim lsGru As String
    
    Dim lbBan As Boolean
    
    Dim lnTRetAge As Double
    Dim lnTDepAge As Double
    Dim lsCodUsuX As String
    
    
    lnTRetAge = 0
    lnTDepAge = 0

    
    Dim i As Long
    
    lnTRet = 0
    lnTDep = 0
    
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    oCon.AbreConexion
    
    If pbEsTramite Then
        If psCodUser = "XXX" Then
            SQL1 = " Select M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispPF, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion , Substring(MC.cCtaCod,4,2) cCodAge, nPlazo Plazo" _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacPlazoFijo CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(MC.cCtaCod,4,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(M.cMovNro,18,2) = '" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%' ORDER BY Substring(MC.cCtaCod,4,2), CA.cCtaCod"
        Else
            SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispPF, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion, Substring(MC.cCtaCod,4,2) cCodAge, nPlazo Plazo" _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacPlazoFijo CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(MC.cCtaCod,4,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(MC.cCtaCod,18,2) = '" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY Substring(MC.cCtaCod,4,2), CA.cCtaCod"
        End If
    Else
        If psCodUser = "XXX" Then
            SQL1 = " Select M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion , Substring(M.cMovNro,18,2) cCodAge, nPlazo Plazo" _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacPlazoFijo CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(M.cMovNro,18,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(MC.cCtaCod,1,5) Like '___" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%' ORDER BY Substring(M.cMovNro,18,2), CA.cCtaCod"
        Else
            SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion, Substring(M.cMovNro,18,2) cCodAge , nPlazo Plazo" _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacPlazoFijo CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(M.cMovNro,18,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(MC.cCtaCod,1,5) Like '___" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY Substring(M.cMovNro,18,2), CA.cCtaCod"
        End If
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If Not (RegTrandiaria.BOF And RegTrandiaria.EOF) Then
        psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Efectivo-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
        psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;IntDevAnt;20;Retiro;20;Usu.;10;Hora;17;TInt;9;Plazo;10;", pnItem)
        
        lsGru = ""
        lbBan = False
        
        While Not RegTrandiaria.EOF
            lbBan = True
            If lsGru <> "" And lsGru <> RegTrandiaria!CCodage Then
                psCadena = psCadena & ofuni.Encabezado("Total Agencia;15; ;37;" & Format(lnTRetAge * -1, "###,##0.00") & ";20; ;46;", pnItem)
                lnTRetAge = 0
                lnTDepAge = 0
                lbBan = True
            End If
            
            
'
            If Len(RegTrandiaria!cCodCta) = 18 Then
                If lsGru <> RegTrandiaria!CCodage Then
                    lsGru = RegTrandiaria!CCodage
                    psCadena = psCadena & ofuni.Encabezado("Agencia: " & RegTrandiaria!cAgeDescripcion & ";32;", pnItem)
                    lbBan = True
                End If
            ElseIf Len(RegTrandiaria!cCodCta) = 8 Then
                If lsGru <> RegTrandiaria!CCodage Then
                    lsGru = RegTrandiaria!CCodage
                    psCadena = psCadena & ofuni.Encabezado("Agencia: " & RegTrandiaria!cAgeDescripcion & ";32;", pnItem)
                    lbBan = True
                End If
            End If

            If IsNull(RegTrandiaria!cNumDoc) Then
                lsDoc = " "
            Else
                lsDoc = Trim(RegTrandiaria!cNumDoc)
            End If
            
            If RegTrandiaria!nMonTran >= 0 Then
                lsDep = Format(RegTrandiaria!nMonTran, "###,##0.00")
                lsRet = "0.00"
                lnTDep = lnTDep + RegTrandiaria!nMonTran
                lnOpe = RegTrandiaria!nMonTran
                lnTDepAge = lnTDepAge + RegTrandiaria!nMonTran
            Else
                lsDep = "0.00"
                lsRet = Format(-1 * RegTrandiaria!nMonTran, "###,##0.00")
                lnTRet = lnTRet + (RegTrandiaria!nMonTran * -1)
                lnOpe = RegTrandiaria!nMonTran
                lnTRetAge = lnTRetAge + RegTrandiaria!nMonTran
            End If
            
            If IsNull(RegTrandiaria!nIntDev) Then
                lnValor = 0
            Else
                lnValor = RegTrandiaria!nIntDev
            End If
            
            If IsNull(RegTrandiaria!cCodUsu) Then
                If IsNull(RegTrandiaria!cCodusurem) Then
                    lsCodUsuX = ""
                Else
                    lsCodUsuX = RegTrandiaria!cCodusurem
                End If
            Else
                lsCodUsuX = RegTrandiaria!cCodUsu
            End If
            
            psCadena = psCadena & Space(14 - Len(RegTrandiaria!cCodCta)) & RegTrandiaria!cCodCta _
                               & Space(18 - Len(Trim(lsDoc))) & Trim(lsDoc) _
                               & Space(20 - Len(Format(lnValor - lnOpe, "###,##0.00"))) & Format(lnValor - lnOpe, "###,##0.00") _
                               & Space(20 - Len(lsRet)) & lsRet _
                               & Space(10 - Len(lsCodUsuX)) & lsCodUsuX _
                               & Space(17 - Len(Format(RegTrandiaria!dFecTran, "hh:mm:ss AMPM"))) & Format(RegTrandiaria!dFecTran, "hh:mm:ss AMPM") _
                               & Space(8 - Len(Format(RegTrandiaria!nTasaIntPF, "###,##0.00"))) & Format(RegTrandiaria!nTasaIntPF, "###,##0.00") _
                               & Space(11 - Len(Str(RegTrandiaria!nPlazo))) & Str(RegTrandiaria!nPlazo) & Chr(10)
            
            'Str(RegTrandiaria!nPlazo)
            pnItem = pnItem + 1
                    
            If pnItem = lnRango Then
                psCadena = psCadena & Chr(12)
                psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Efectivo-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;IntDevAnt;20;Retiro;20;Usu.;10;Hora;17;TInt;9;Plazo;10;", pnItem)
            End If
            
            RegTrandiaria.MoveNext
        Wend
        
        If lbBan Then psCadena = psCadena & ofuni.Encabezado("Total Agencia;15; ;37;" & Format(lnTRetAge * -1, "###,##0.00") & ";20; ;46;", pnItem)
        
        lnTRetT = lnTRet
        lnTDepT = lnTDep
            
        RegTrandiaria.Close
    End If
    
    Set RegTrandiaria = Nothing
    
    If lnTRetT <> 0 Or lnTDepT <> 0 Then
        psCadena = psCadena & ofuni.Encabezado("Resumen;15; ;37;" & Format(lnTRetT, "###,##0.00") & ";20; ;46;", pnItem)
        pnTotRet = pnTotRet + lnTRetT
        pnTotDep = pnTotDep + lnTDepT
        
        psCadena = psCadena & Chr(12)
    End If
    
    Set ofuni = Nothing
End Function


'************************************************************************
'CTS
'********************************************************************************************
Private Sub ReporteMovCTS(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "")

    Dim SQL1 As String
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lnDep As Double
    Dim lnRet As Double

    Dim lnTotDep As Double
    Dim lnTotRet As Double
    Dim lsCebecera As String

    Dim lsTEM As String
    Dim i As Long
    Dim lsAdd As String
    
    Dim ofuni As New COMFunciones.FCOMImpresion

    lsAdd = IIf(psFecha = "", "", " Del " & Right(psFecha, 2) & "/" & Mid(psFecha, 5, 2) & "/" & Left(psFecha, 4))

    lnTotRet = 0
    lnTotDep = 0

    If psCodUser = "XXX" Then
        lsCebecera = ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    Else
        lsCebecera = ofuni.CabeceraPagina(psTitulo & " " & psCodUser, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    End If

    pnPagina = pnPagina - 1
    lsTEM = psCadena

    psCadena = ""

    Call ReporteAperturasCTS(psCadena, "Apertura de Cuentas CTS en Efectivo" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovCTSApeEfec, , True))
    Call ReporteAperturasCTS(psCadena, "Apertura de Cuentas CTS con Cheque" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovCTSApeCheque, , True))
    Call ReporteAperturasCTS(psCadena, "Apertura de Cuentas CTS con Trnasferencia" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovCTSApeTreansferencia, , True))
    Call ReporteAperturasCTS(psCadena, "Movimientos en Efectivo de Cuentas CTS" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovCTSMovEfec, , True))
    Call ReporteAperturasCTS(psCadena, "Movimientos Sin Efectivo de Cuentas CTS" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovCTSMovSinEfec, , True))
    Call ReporteAperturasCTS(psCadena, "Cancelación de Cuentas CTS" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovCTSCancelacion, , True))
    Call ReporteAperturasCTS(psCadena, "Depositos con Cheque en Cuentas CTS" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha, GetOpeGrupoRep(gCtasMovCTSDepCheque, , True))

    If lnTotRet <> 0 Or lnTotDep <> 0 Then
        psCadena = lsCebecera + psCadena
        QuitarSalto psCadena
        psCadena = psCadena & ofuni.Encabezado("Resumen Total;15;" & Trim(Format(lnTotDep, "###,##0.00")) & ";57;" & Trim(Format(lnTotRet, "###,##0.00")) & ";20; ;26;", pnItem)
        psCadena = psCadena & ofuni.Encabezado("Monto Total;15;" & Trim(Format(lnTotDep - lnTotRet, "###,##0.00")) & ";57; ;46;", pnItem)
        psCadena = psCadena & Chr(12)
    End If

    psCadena = lsTEM + psCadena
    lsTEM = ""
    Set ofuni = Nothing
End Sub

'************************************************************************
'OPeraciones de Creditos
'********************************************************************************************
Private Sub ReporteMovCreditos(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "")

    Dim SQL1 As String
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lnDep As Double
    Dim lnRet As Double

    Dim lnTotDep As Double
    Dim lnTotRet As Double
    Dim lsCebecera As String

    Dim lsTEM As String
    Dim i As Long
    Dim lsAdd As String
    
    Dim ofuni As New COMFunciones.FCOMImpresion

    lsAdd = IIf(psFecha = "", "", " Del " & Right(psFecha, 2) & "/" & Mid(psFecha, 5, 2) & "/" & Left(psFecha, 4))

    lnTotRet = 0
    lnTotDep = 0

    If psCodUser = "XXX" Then
        lsCebecera = ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    Else
        lsCebecera = ofuni.CabeceraPagina(psTitulo & " " & psCodUser, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    End If

    pnPagina = pnPagina - 1
    lsTEM = psCadena

    psCadena = ""
    lnRango = 58
    
    Call ReporteMovimientosCreditos(psCadena, "Operaciones de Creditos" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha)
    
    If lnTotRet <> 0 Or lnTotDep <> 0 Then
        psCadena = lsCebecera + psCadena
        QuitarSalto psCadena
        psCadena = psCadena & ofuni.Encabezado("Resumen Total;15;" & Trim(Format(Abs(lnTotRet), "###,##0.00")) & ";23;" & Trim(Format(lnTotDep, "###,##0.00")) & ";15; ;26;", pnItem)
        psCadena = psCadena & ofuni.Encabezado("Monto Total;15;" & Trim(Format(lnTotDep - Abs(lnTotRet), "###,##0.00")) & ";37; ;46;", pnItem)
        psCadena = psCadena & Chr(12)
    End If

    psCadena = lsTEM + psCadena
    lsTEM = ""
End Sub


Public Sub ReporteMovimientosCreditos(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pnTotDep As Double, pnTotRet As Double, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "")
    Dim SQL1 As String
    Dim RegTrandiaria As New ADODB.Recordset
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim i As Long
    Dim lnTDep As Double
    Dim lnTRet As Double
    Dim lnValor As Double
    Dim lnPorRet As Double
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    oCon.AbreConexion
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(MC.cCtaCod,4,2) = '" & lsAgeCod & "' "
    End If
    
    If psCodUser = "XXX" Then
        SQL1 = " Select M.cMovNro, MC.cCtaCod, P.CPERSNOMBRE, CASE WHEN MC.cOpeCod like '1001__' THEN "
        SQL1 = SQL1 & "        (Select SUM(nMonto) From MovColDet where nMovNro = MC.nMovNro and cOpeCod like '1001__' AND cCtaCod = MC.cCtaCod)"
        SQL1 = SQL1 & "          END as nDesembolso,"
        SQL1 = SQL1 & " CASE WHEN MC.cOpeCod like '100[234567]__' OR MC.cOpeCod in ('107001')  THEN"
        SQL1 = SQL1 & " (Select SUM(CASE WHEN nPrdConceptoCod=1106 THEN nMonto*-1 ELSE nMonto END) From MovColDet where nMovNro = MC.nMovNro and ( cOpeCod like '100[234567]__' OR cOpeCod in ('107001') OR cOpeCod LIKE '99%') AND cCtaCod = MC.cCtaCod )"
        SQL1 = SQL1 & " END As nPagos, RIGHT(m.cMovNro, 4) As cUser, SUBSTRING(m.cMovNro, 9, 2) + ':' + SUBSTRING(m.cMovNro, 11, 2) + ':' + SUBSTRING(m.cMovNro, 13, 2) As Hora ,"
        SQL1 = SQL1 & " ISNULL(left(dbo.fn_GetNombreDoc(MD.nDocTpo),15),'') AS nDocTpo , isnull(MD.cDocNro,'EFECTIVO') as cDocNro "
        SQL1 = SQL1 & " From Mov M"
        SQL1 = SQL1 & " Inner Join ("
        SQL1 = SQL1 & " Select * from MovCol where cOpeCod like '100[1234567]__' OR cOpeCod in ('107001') "
        SQL1 = SQL1 & " ) MC ON M.nMovNro = MC.nMovNro LEFT JOIN MOVDOC MD ON MD.NMOVNRO = M.NMOVNRO  "
        SQL1 = SQL1 & " JOIN PRODUCTOPERSONA R ON R.CCTACOD = MC.CCTACOD "
        SQL1 = SQL1 & " JOIN PERSONA P ON P.CPERSCOD = R.CPERSCOD AND R.nPrdPersRelac = 20 "
        SQL1 = SQL1 & " Where M.nMovFlag =0 and  Substring(MC.cCtaCod,9,1) = '" & psMoneda & "' "
        SQL1 = SQL1 & sqlAdd
        SQL1 = SQL1 & " And M.cMovNro Like '" & psFecha & "%' ORDER BY M.NMOVNRO"
            
    Else
    
        SQL1 = " Select M.cMovNro, MC.cCtaCod, P.CPERSNOMBRE, CASE WHEN MC.cOpeCod like '1001__' THEN "
        SQL1 = SQL1 & "        (Select SUM(nMonto) From MovColDet where nMovNro = MC.nMovNro and cOpeCod like '1001__' AND cCtaCod = MC.cCtaCod)"
        SQL1 = SQL1 & "          END as nDesembolso,"
        SQL1 = SQL1 & " CASE WHEN MC.cOpeCod like '100[234567]__' OR MC.cOpeCod in ('107001') THEN"
        SQL1 = SQL1 & " (Select SUM(CASE WHEN nPrdConceptoCod=1106 THEN nMonto*-1 ELSE nMonto END) From MovColDet where nMovNro = MC.nMovNro and ( cOpeCod like '100[234567]__' OR cOpeCod in ('107001')  OR cOpeCod LIKE '99%' ) AND cCtaCod = MC.cCtaCod)"
        SQL1 = SQL1 & " END As nPagos, RIGHT(m.cMovNro, 4) As cUser, SUBSTRING(m.cMovNro, 9, 2) + ':' + SUBSTRING(m.cMovNro, 11, 2) + ':' + SUBSTRING(m.cMovNro, 13, 2) As Hora ,"
        SQL1 = SQL1 & " ISNULL(left(dbo.fn_GetNombreDoc(MD.nDocTpo),15),'') AS nDocTpo , isnull(MD.cDocNro,'EFECTIVO') as cDocNro "
        SQL1 = SQL1 & " From Mov M"
        SQL1 = SQL1 & " Inner Join ("
        SQL1 = SQL1 & " Select * from MovCol where cOpeCod like '100[1234567]__' OR cOpeCod in ('107001') "
        SQL1 = SQL1 & " ) MC ON M.nMovNro = MC.nMovNro LEFT JOIN MOVDOC MD ON MD.NMOVNRO = M.NMOVNRO  "
        SQL1 = SQL1 & " JOIN PRODUCTOPERSONA R ON R.CCTACOD = MC.CCTACOD "
        SQL1 = SQL1 & " JOIN PERSONA P ON P.CPERSCOD = R.CPERSCOD AND R.nPrdPersRelac = 20 "
        SQL1 = SQL1 & " Where M.nMovFlag =0 and  Substring(MC.cCtaCod,9,1) = '" & psMoneda & "' "
        SQL1 = SQL1 & sqlAdd
        SQL1 = SQL1 & " And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY M.NMOVNRO"
            
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If RegTrandiaria.EOF And RegTrandiaria.BOF Then
        Exit Sub
    End If

    psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;20;Titular;40;Desembolso;20;Pagos;12;Usu.;10;Hora;15;TipoPago;15;", pnItem)
          
    While Not RegTrandiaria.EOF
                
        lsDoc = " "
                
        lnTRet = lnTRet - IIf(IsNull(RegTrandiaria!nDesembolso), 0, RegTrandiaria!nDesembolso)
        lnTDep = lnTDep + IIf(IsNull(RegTrandiaria!nPagos), 0, Abs(RegTrandiaria!nPagos))
                
        lnValor = 0
                
        psCadena = psCadena & Space(23 - Len(RegTrandiaria!cCtaCod)) & RegTrandiaria!cCtaCod & ofuni.ImpreFormat(RegTrandiaria!cpersnombre, 40) _
                    & Space(15 - Len(Format(IIf(IsNull(RegTrandiaria!nDesembolso), 0, RegTrandiaria!nDesembolso), "###,##0.00"))) & Format(IIf(IsNull(RegTrandiaria!nDesembolso), 0, RegTrandiaria!nDesembolso), "###,##0.00") _
                    & Space(15 - Len(Format(IIf(IsNull(RegTrandiaria!nPagos), 0, RegTrandiaria!nPagos), "###,##0.00"))) & Format(IIf(IsNull(RegTrandiaria!nPagos), 0, RegTrandiaria!nPagos), "###,##0.00") _
                    & Space(10 - Len(RegTrandiaria!cUser)) & RegTrandiaria!cUser _
                    & Space(17 - Len(Format(RegTrandiaria!Hora, "hh:mm:ss AMPM"))) & Format(RegTrandiaria!Hora, "hh:mm:ss AMPM") & ofuni.ImpreFormat(Trim(RegTrandiaria!nDocTpo) & IIf(Trim(RegTrandiaria!nDocTpo) = "", "", "-") & Trim(RegTrandiaria!cDocNro), 25, 2) _
                    & Chr(10)
        
        pnItem = pnItem + 1
                
        If pnItem = lnRango Then
            psCadena = psCadena & Chr(12)
            psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
            psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;20;Titular;40;Desembolso;20;Pagos;12;Usu.;10;Hora;15;TipoPago;15;", pnItem)
        End If
        
        RegTrandiaria.MoveNext
    Wend
    
    If lnTRet <> 0 Or lnTDep <> 0 Then
        'psCadena = psCadena & Encabezado("Resumen;16;" & Trim(Format(lnTDep, "###,##0.00")) & ";42; ;60;", pnItem)
        
        pnTotRet = pnTotRet + lnTRet
        pnTotDep = pnTotDep + lnTDep
        
        psCadena = psCadena & Chr(12)
    End If
    
    Set ofuni = Nothing
End Sub

'************************************************************************
'OPeraciones de Pignoraticio
'********************************************************************************************
Private Sub ReporteMovPignoraticio(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "")

    Dim SQL1 As String
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lnDep As Double
    Dim lnRet As Double

    Dim lnTotDep As Double
    Dim lnTotRet As Double
    Dim lsCebecera As String

    Dim lsTEM As String
    Dim i As Long
    Dim lsAdd As String
    
    Dim ofuni As New COMFunciones.FCOMImpresion

    lsAdd = IIf(psFecha = "", "", " Del " & Right(psFecha, 2) & "/" & Mid(psFecha, 5, 2) & "/" & Left(psFecha, 4))

    lnTotRet = 0
    lnTotDep = 0

    If psCodUser = "XXX" Then
        lsCebecera = ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    Else
        lsCebecera = ofuni.CabeceraPagina(psTitulo & " " & psCodUser, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    End If

    pnPagina = pnPagina - 1
    lsTEM = psCadena

    psCadena = ""
    lnRango = 58
    Call ReporteMovimientosPignoraticio(psCadena, "Operaciones de Pignoraticio" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha)
    
    If lnTotRet <> 0 Or lnTotDep <> 0 Then
        psCadena = lsCebecera + psCadena
        QuitarSalto psCadena
        psCadena = psCadena & ofuni.Encabezado("Resumen Total;15;" & Trim(Format(Abs(lnTotRet), "###,##0.00")) & ";23;" & Trim(Format(lnTotDep, "###,##0.00")) & ";15; ;26;", pnItem)
        psCadena = psCadena & ofuni.Encabezado("Monto Total;15;" & Trim(Format(lnTotDep - Abs(lnTotRet), "###,##0.00")) & ";37; ;46;", pnItem)
        psCadena = psCadena & Chr(12)
    End If

    psCadena = lsTEM + psCadena
    lsTEM = ""
    Set ofuni = Nothing
End Sub


Public Sub ReporteMovimientosPignoraticio(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pnTotDep As Double, pnTotRet As Double, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "")
    Dim SQL1 As String
    Dim RegTrandiaria As New ADODB.Recordset
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim i As Long
    Dim lnTDep As Double
    Dim lnTRet As Double
    Dim lnValor As Double
    Dim lnPorRet As Double
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    oCon.AbreConexion
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(MC.cCtaCod,4,2) = '" & lsAgeCod & "' "
    End If
    
    If psCodUser = "XXX" Then
    
        SQL1 = " Select M.cMovNro, MC.cCtaCod, CASE WHEN MC.cOpeCod = '120201' THEN "
        SQL1 = SQL1 & "        (Select SUM(nMonto) From MovCol where nMovNro = MC.nMovNro)"
        SQL1 = SQL1 & "          END as nDesembolso,"
        SQL1 = SQL1 & " CASE WHEN SUBSTRING(MC.cOpeCod,1,4) in ('1210','1211','1212','1216','1219','1261','1262','1263') THEN"
        SQL1 = SQL1 & " (Select SUM(nMonto) From MovCol where nMovNro = MC.nMovNro)"
        SQL1 = SQL1 & " END As nPagos, RIGHT(m.cMovNro, 4) As cUser, SUBSTRING(m.cMovNro, 9, 2) + ':' + SUBSTRING(m.cMovNro, 11, 2) + ':' + SUBSTRING(m.cMovNro, 13, 2) As Hora"
        SQL1 = SQL1 & " From Mov M"
        SQL1 = SQL1 & " Inner Join ("
        SQL1 = SQL1 & " Select * from MovCol where SUBSTRING(cOpeCod,1,4) in ('1210','1211','1212','1216','1219','1261','1262','1263')"
        SQL1 = SQL1 & " ) MC ON M.nMovNro = MC.nMovNro"
        SQL1 = SQL1 & " Where M.nMovFlag =0 and  Substring(MC.cCtaCod,9,1) = '" & psMoneda & "' "
        SQL1 = SQL1 & sqlAdd
        SQL1 = SQL1 & " And M.cMovNro Like '" & psFecha & "%' ORDER BY MC.cCtaCod"
            
    Else
    
        SQL1 = " Select M.cMovNro, MC.cCtaCod, CASE WHEN MC.cOpeCod = '120201' THEN "
        SQL1 = SQL1 & "        (Select SUM(nMonto) From MovCol where nMovNro = MC.nMovNro)"
        SQL1 = SQL1 & "          END as nDesembolso,"
        SQL1 = SQL1 & " CASE WHEN SUBSTRING(MC.cOpeCod,1,4) in ('1210','1211','1212','1216','1219','1261','1262','1263') THEN"
        SQL1 = SQL1 & "  (Select SUM(nMonto) From MovCol where nMovNro = MC.nMovNro)"
        SQL1 = SQL1 & " END As nPagos, RIGHT(m.cMovNro, 4) As cUser, SUBSTRING(m.cMovNro, 9, 2) + ':' + SUBSTRING(m.cMovNro, 11, 2) + ':' + SUBSTRING(m.cMovNro, 13, 2) As Hora"
        SQL1 = SQL1 & " From Mov M"
        SQL1 = SQL1 & " Inner Join ("
        SQL1 = SQL1 & " Select * from MovCol where SUBSTRING(cOpeCod,1,4) in ('1210','1211','1212','1216','1219','1261','1262','1263')"
        SQL1 = SQL1 & " ) MC ON M.nMovNro = MC.nMovNro"
        SQL1 = SQL1 & " Where M.nMovFlag =0 and  Substring(MC.cCtaCod,9,1) = '" & psMoneda & "' "
        SQL1 = SQL1 & sqlAdd
        SQL1 = SQL1 & " And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY MC.cCtaCod"
            
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If RegTrandiaria.EOF And RegTrandiaria.BOF Then
        Exit Sub
    End If

    psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;20;Desembolso;20;Pagos;12;Usu.;10;Hora;15;", pnItem)
          
    While Not RegTrandiaria.EOF
                
        lsDoc = " "
                
        lnTRet = lnTRet - IIf(IsNull(RegTrandiaria!nDesembolso), 0, RegTrandiaria!nDesembolso)
        lnTDep = lnTDep + IIf(IsNull(RegTrandiaria!nPagos), 0, Abs(RegTrandiaria!nPagos))
                
        lnValor = 0
                
        psCadena = psCadena & Space(23 - Len(RegTrandiaria!cCtaCod)) & RegTrandiaria!cCtaCod _
                    & Space(15 - Len(Format(IIf(IsNull(RegTrandiaria!nDesembolso), 0, RegTrandiaria!nDesembolso), "###,##0.00"))) & Format(IIf(IsNull(RegTrandiaria!nDesembolso), 0, RegTrandiaria!nDesembolso), "###,##0.00") _
                    & Space(15 - Len(Format(IIf(IsNull(RegTrandiaria!nPagos), 0, RegTrandiaria!nPagos), "###,##0.00"))) & Format(IIf(IsNull(RegTrandiaria!nPagos), 0, RegTrandiaria!nPagos), "###,##0.00") _
                    & Space(10 - Len(RegTrandiaria!cUser)) & RegTrandiaria!cUser _
                    & Space(17 - Len(Format(RegTrandiaria!Hora, "hh:mm:ss AMPM"))) & Format(RegTrandiaria!Hora, "hh:mm:ss AMPM") _
                    & Chr(10)
        
        pnItem = pnItem + 1
                
        If pnItem = lnRango Then
            psCadena = psCadena & Chr(12)
            psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
            psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;20;Desembolso;20;Pagos;12;Usu.;10;Hora;15;", pnItem)
        End If
        
        RegTrandiaria.MoveNext
    Wend
    
    If lnTRet <> 0 Or lnTDep <> 0 Then
        'psCadena = psCadena & Encabezado("Resumen;16;" & Trim(Format(lnTDep, "###,##0.00")) & ";42; ;60;", pnItem)
        
        pnTotRet = pnTotRet + lnTRet
        pnTotDep = pnTotDep + lnTDep
        
        psCadena = psCadena & Chr(12)
    End If
    Set ofuni = Nothing
End Sub


'************************************************************************
'OPeraciones de Judicial
'********************************************************************************************
Private Sub ReporteMovJudicial(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "")

    Dim SQL1 As String
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lnDep As Double
    Dim lnRet As Double

    Dim lnTotDep As Double
    Dim lnTotRet As Double
    Dim lsCebecera As String

    Dim lsTEM As String
    Dim i As Long
    Dim lsAdd As String
    
    Dim ofuni As New COMFunciones.FCOMImpresion

    lsAdd = IIf(psFecha = "", "", " Del " & Right(psFecha, 2) & "/" & Mid(psFecha, 5, 2) & "/" & Left(psFecha, 4))

    lnTotRet = 0
    lnTotDep = 0

    If psCodUser = "XXX" Then
        lsCebecera = ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    Else
        lsCebecera = ofuni.CabeceraPagina(psTitulo & " " & psCodUser, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    End If

    pnPagina = pnPagina - 1
    lsTEM = psCadena

    psCadena = ""
    lnRango = 58
    Call ReporteMovimientosJudicial(psCadena, "Operaciones de Judicial" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha)
    
    If lnTotRet <> 0 Or lnTotDep <> 0 Then
        psCadena = lsCebecera + psCadena
        QuitarSalto psCadena
        psCadena = psCadena & ofuni.Encabezado("Resumen Total;15;" & Trim(Format(Abs(lnTotRet), "###,##0.00")) & ";23;" & Trim(Format(lnTotDep, "###,##0.00")) & ";15; ;26;", pnItem)
        psCadena = psCadena & ofuni.Encabezado("Monto Total;15;" & Trim(Format(lnTotDep - Abs(lnTotRet), "###,##0.00")) & ";37; ;46;", pnItem)
        psCadena = psCadena & Chr(12)
    End If

    psCadena = lsTEM + psCadena
    lsTEM = ""
End Sub


Public Sub ReporteMovimientosJudicial(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pnTotDep As Double, pnTotRet As Double, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "")
    Dim SQL1 As String
    Dim RegTrandiaria As New ADODB.Recordset
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim i As Long
    Dim lnTDep As Double
    Dim lnTRet As Double
    Dim lnValor As Double
    Dim lnPorRet As Double
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    oCon.AbreConexion
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(MC.cCtaCod,4,2) = '" & lsAgeCod & "' "
    End If
    
    If psCodUser = "XXX" Then
    
        SQL1 = " Select M.cMovNro, MC.cCtaCod, 0 as nDesembolso,"
        SQL1 = SQL1 & " CASE WHEN SUBSTRING(MC.cOpeCod,1,4) in ('1302','1303','1304','1306') THEN"
        SQL1 = SQL1 & " (Select SUM(nMonto) From MovCol where nMovNro = MC.nMovNro)"
        SQL1 = SQL1 & " END As nPagos, RIGHT(m.cMovNro, 4) As cUser, SUBSTRING(m.cMovNro, 9, 2) + ':' + SUBSTRING(m.cMovNro, 11, 2) + ':' + SUBSTRING(m.cMovNro, 13, 2) As Hora"
        SQL1 = SQL1 & " From Mov M"
        SQL1 = SQL1 & " Inner Join ("
        SQL1 = SQL1 & " Select * from MovCol where SUBSTRING(cOpeCod,1,4) in ('1302','1303','1304','1306')"
        SQL1 = SQL1 & " ) MC ON M.nMovNro = MC.nMovNro"
        SQL1 = SQL1 & " Where M.nMovFlag =0 and  Substring(MC.cCtaCod,9,1) = '" & psMoneda & "' "
        SQL1 = SQL1 & sqlAdd
        SQL1 = SQL1 & " And M.cMovNro Like '" & psFecha & "%' ORDER BY MC.cCtaCod"
            
    Else
    
        SQL1 = " Select M.cMovNro, MC.cCtaCod, 0 as nDesembolso,"
        SQL1 = SQL1 & " CASE WHEN SUBSTRING(MC.cOpeCod,1,4) in ('1302','1303','1304','1306') THEN"
        SQL1 = SQL1 & " (Select SUM(nMonto) From MovCol where nMovNro = MC.nMovNro)"
        SQL1 = SQL1 & " END As nPagos, RIGHT(m.cMovNro, 4) As cUser, SUBSTRING(m.cMovNro, 9, 2) + ':' + SUBSTRING(m.cMovNro, 11, 2) + ':' + SUBSTRING(m.cMovNro, 13, 2) As Hora"
        SQL1 = SQL1 & " From Mov M"
        SQL1 = SQL1 & " Inner Join ("
        SQL1 = SQL1 & " Select * from MovCol where SUBSTRING(cOpeCod,1,4) in ('1302','1303','1304','1306')"
        SQL1 = SQL1 & " ) MC ON M.nMovNro = MC.nMovNro"
        SQL1 = SQL1 & " Where M.nMovFlag =0 and  Substring(MC.cCtaCod,9,1) = '" & psMoneda & "' "
        SQL1 = SQL1 & sqlAdd
        SQL1 = SQL1 & " And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY MC.cCtaCod"
            
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If RegTrandiaria.EOF And RegTrandiaria.BOF Then
        Exit Sub
    End If

    psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;20;Desembolso;20;Pagos;12;Usu.;10;Hora;15;", pnItem)
          
    While Not RegTrandiaria.EOF
                
        lsDoc = " "
                
        lnTRet = lnTRet - IIf(IsNull(RegTrandiaria!nDesembolso), 0, RegTrandiaria!nDesembolso)
        lnTDep = lnTDep + IIf(IsNull(RegTrandiaria!nPagos), 0, Abs(RegTrandiaria!nPagos))
                
        lnValor = 0
                
        psCadena = psCadena & Space(23 - Len(RegTrandiaria!cCtaCod)) & RegTrandiaria!cCtaCod _
                    & Space(15 - Len(Format(IIf(IsNull(RegTrandiaria!nDesembolso), 0, RegTrandiaria!nDesembolso), "###,##0.00"))) & Format(IIf(IsNull(RegTrandiaria!nDesembolso), 0, RegTrandiaria!nDesembolso), "###,##0.00") _
                    & Space(15 - Len(Format(IIf(IsNull(RegTrandiaria!nPagos), 0, RegTrandiaria!nPagos), "###,##0.00"))) & Format(IIf(IsNull(RegTrandiaria!nPagos), 0, RegTrandiaria!nPagos), "###,##0.00") _
                    & Space(10 - Len(RegTrandiaria!cUser)) & RegTrandiaria!cUser _
                    & Space(17 - Len(Format(RegTrandiaria!Hora, "hh:mm:ss AMPM"))) & Format(RegTrandiaria!Hora, "hh:mm:ss AMPM") _
                    & Chr(10)
        
        pnItem = pnItem + 1
                
        If pnItem = lnRango Then
            psCadena = psCadena & Chr(12)
            psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
            psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;20;Desembolso;20;Pagos;12;Usu.;10;Hora;15;", pnItem)
        End If
        
        RegTrandiaria.MoveNext
    Wend
    
    If lnTRet <> 0 Or lnTDep <> 0 Then
        'psCadena = psCadena & Encabezado("Resumen;16;" & Trim(Format(lnTDep, "###,##0.00")) & ";42; ;60;", pnItem)
        
        pnTotRet = pnTotRet + lnTRet
        pnTotDep = pnTotDep + lnTDep
        
        psCadena = psCadena & Chr(12)
    End If
    Set ofuni = Nothing
End Sub


'************************************************************************
'OPeraciones de CompraVenta
'********************************************************************************************
Private Sub ReporteCompraVenta(psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "")

    Dim SQL1 As String
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lnDep As Double
    Dim lnRet As Double

    Dim lnTotDep As Double
    Dim lnTotRet As Double
    Dim lsCebecera As String

    Dim lsTEM As String
    Dim i As Long
    Dim lsAdd As String
    
    Dim ofuni As New COMFunciones.FCOMImpresion

    lsAdd = IIf(psFecha = "", "", " Del " & Right(psFecha, 2) & "/" & Mid(psFecha, 5, 2) & "/" & Left(psFecha, 4))

    lnTotRet = 0
    lnTotDep = 0

    If psCodUser = "XXX" Then
        lsCebecera = ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    Else
        lsCebecera = ofuni.CabeceraPagina(psTitulo & " " & psCodUser, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    End If

    pnPagina = pnPagina - 1
    lsTEM = psCadena

    psCadena = ""
    lnRango = 58
    Call ReporteMovimientosCompraVenta(psCadena, "Operaciones de Compra Venta" & lsAdd, pnPagina, pnItem, lnTotDep, lnTotRet, psMoneda, psCodUser, psFecha)
    
    If lnTotRet <> 0 Or lnTotDep <> 0 Then
        psCadena = lsCebecera + psCadena
        QuitarSalto psCadena
        psCadena = psCadena & ofuni.Encabezado("Resumen Total;15;" & Trim(Format(lnTotDep, "###,##0.00")) & ";23;" & Trim(Format(lnTotRet, "###,##0.00")) & ";15; ;26;", pnItem)
        psCadena = psCadena & ofuni.Encabezado("Monto Total;15;" & Trim(Format(lnTotDep - Abs(lnTotRet), "###,##0.00")) & ";37; ;46;", pnItem)
        psCadena = psCadena & Chr(12)
    End If

    psCadena = lsTEM + psCadena
    lsTEM = ""
    Set ofuni = Nothing
End Sub


Public Sub ReporteMovimientosCompraVenta(psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pnTotDep As Double, pnTotRet As Double, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "")
    Dim SQL1 As String
    Dim RegTrandiaria As New ADODB.Recordset
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim i As Long
    Dim lnTDep As Double
    Dim lnTRet As Double
    Dim lnValor As Double
    Dim lnPorRet As Double
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    oCon.AbreConexion
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(MC.cCtaCod,4,2) = '" & lsAgeCod & "' "
    End If
    
    If psCodUser = "XXX" Then
    
        SQL1 = " select cOpeDesc=left(O.cOpeDesc+'                  ',23), MV.nMovImporte, RIGHT(m.cMovNro, 4) As cUser, SUBSTRING(m.cMovNro, 9, 2) + ':' + SUBSTRING(m.cMovNro, 11, 2) + ':' + SUBSTRING(m.cMovNro, 13, 2) As Hora"
        SQL1 = SQL1 & " from mov M Inner Join Opetpo O ON M.cOpeCod = O.cOpeCod"
        SQL1 = SQL1 & " Inner Join MovCompraVenta MV ON MV.nMovnro = M.nMovnro"
        SQL1 = SQL1 & " Where M.nMovFlag =0 "
        SQL1 = SQL1 & " And M.cMovNro Like '" & psFecha & "%' ORDER BY M.nMovNro"
            
    Else
    
        SQL1 = " select cOpeDesc=left(O.cOpeDesc+'                  ',23), MV.nMovImporte, RIGHT(m.cMovNro, 4) As cUser, SUBSTRING(m.cMovNro, 9, 2) + ':' + SUBSTRING(m.cMovNro, 11, 2) + ':' + SUBSTRING(m.cMovNro, 13, 2) As Hora"
        SQL1 = SQL1 & " from mov M Inner Join Opetpo O ON M.cOpeCod = O.cOpeCod"
        SQL1 = SQL1 & " Inner Join MovCompraVenta MV ON MV.nMovnro = M.nMovnro"
        SQL1 = SQL1 & " Where M.nMovFlag =0 "
        SQL1 = SQL1 & " And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY M.nMovNro"
            
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If RegTrandiaria.EOF And RegTrandiaria.BOF Then
        Exit Sub
    End If

    psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    psCadena = psCadena & ofuni.Encabezado("Operacion;20;Monto;20;Usu.;10;Hora;15;", pnItem)
          
    While Not RegTrandiaria.EOF
                
        lsDoc = " "
                
        lnTRet = lnTRet + IIf(IsNull(RegTrandiaria!nMovImporte), 0, RegTrandiaria!nMovImporte)
        lnTDep = lnTDep + IIf(IsNull(RegTrandiaria!nMovImporte), 0, Abs(RegTrandiaria!nMovImporte))
                
        lnValor = 0
                
        psCadena = psCadena & Space(23 - Len(RegTrandiaria!cOpeDesc)) & RegTrandiaria!cOpeDesc _
                    & Space(15 - Len(Format(IIf(IsNull(RegTrandiaria!nMovImporte), 0, RegTrandiaria!nMovImporte), "###,##0.00"))) & Format(IIf(IsNull(RegTrandiaria!nMovImporte), 0, RegTrandiaria!nMovImporte), "###,##0.00") _
                    & Space(10 - Len(RegTrandiaria!cUser)) & RegTrandiaria!cUser _
                    & Space(17 - Len(Format(RegTrandiaria!Hora, "hh:mm:ss AMPM"))) & Format(RegTrandiaria!Hora, "hh:mm:ss AMPM") _
                    & Chr(10)
        
        pnItem = pnItem + 1
                
        If pnItem = lnRango Then
            psCadena = psCadena & Chr(12)
            psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
            psCadena = psCadena & ofuni.Encabezado("Operacion;30;Monto;20;Usu.;10;Hora;15;", pnItem)
        End If
        
        RegTrandiaria.MoveNext
    Wend
    
    If lnTRet <> 0 Or lnTDep <> 0 Then
        'psCadena = psCadena & Encabezado("Resumen;16;" & Trim(Format(lnTDep, "###,##0.00")) & ";42; ;60;", pnItem)
        
        pnTotRet = pnTotRet + lnTRet
        pnTotDep = pnTotDep + lnTDep
        
        psCadena = psCadena & Chr(12)
    End If
    Set ofuni = Nothing
End Sub


Public Sub ReporteAperturasCTS(ByRef psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pnTotDep As Double, pnTotRet As Double, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "", Optional psTipoOpe As String)
    Dim SQL1 As String
    Dim RegTrandiaria As New ADODB.Recordset
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim i As Long
    Dim lnTDep As Double
    Dim lnTRet As Double
    Dim lnValor As Double
    Dim lnPorRet As Double
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    oCon.AbreConexion
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(MC.cCtaCod,4,2) = '" & lsAgeCod & "' "
    End If
    
    If psCodUser = "XXX" Then
        SQL1 = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cMovNro, MC.cOpeCod, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC, P.nSaldo nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaInt, Right(cMovNro,4) cCodUsu" _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacCTS CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & " And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) " & sqlAdd & " And M.cMovNro Like '" & psFecha & "%' ORDER BY CA.cCtaCod"
    Else
        SQL1 = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cMovNro, MC.cOpeCod, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
              & " nSaldoDisponible as nSaldDispAC , P.nSaldo nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaInt, Right(cMovNro,4) cCodUsu " _
              & " From Mov M" _
              & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
              & " Inner Join CaptacCTS CA On MC.cCtaCod = CA.cCtaCod" _
              & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
              & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
              & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
              & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
              & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & " And Substring(M.cMovNro,18,2) = Substring(MC.cCtaCod,4,2) " & sqlAdd & " And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY CA.cCtaCod"
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If RegTrandiaria.EOF And RegTrandiaria.BOF Then
        Exit Sub
    End If

    psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
    psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;16;Nro.Doc.;20;Monto;22;Usu.;10;Hora;17;Sald.Cnt;22;TInt;11;", pnItem)
   
    lnPorRet = 0.5 '(ReadParametros("23110") / 100)
   
    While Not RegTrandiaria.EOF
        
        If IsNull(RegTrandiaria!cNumDoc) Then
            lsDoc = " "
        Else
            lsDoc = RegTrandiaria!cNumDoc
        End If
        
        If RegTrandiaria!nMonTran >= 0 And Left(RegTrandiaria!copecod, 4) <> "2203" Then
            lnTDep = lnTDep + RegTrandiaria!nMonTran
        Else
            lnTRet = lnTRet + (RegTrandiaria!nMonTran * -1)
        End If
        
        If IsNull(RegTrandiaria!nSaldCnt) Then
            lnValor = 0
        Else
            lnValor = RegTrandiaria!nSaldCnt
        End If
        
        psCadena = psCadena & Space(18 - Len(RegTrandiaria!cCodCta)) & RegTrandiaria!cCodCta _
                    & Space(20 - Len(Trim(lsDoc))) & Trim(lsDoc) _
                    & Space(22 - Len(Format(RegTrandiaria!nMonTran, "###,##0.00"))) & Format(RegTrandiaria!nMonTran, "###,##0.00") _
                    & Space(10 - Len(RegTrandiaria!cCodUsu)) & RegTrandiaria!cCodUsu _
                    & Space(17 - Len(Format(RegTrandiaria!dFecTran, "hh:mm:ss AMPM"))) & Format(RegTrandiaria!dFecTran, "hh:mm:ss AMPM") _
                    & Space(22 - Len(Format(lnValor, "###,##0.00"))) & Format(lnValor, "###,##0.00") _
                    & Space(11 - Len(Format(RegTrandiaria!nTasaInt, "###,##0.00"))) & Format(RegTrandiaria!nTasaInt, "###,##0.00") & Chr(10)
        
        pnItem = pnItem + 1
                
        If pnItem = lnRango Then
            psCadena = psCadena & Chr(12)
            psCadena = psCadena & ofuni.CabeceraPagina(psTitulo, pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
            psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;16;Nro.Doc.;20;Monto;22;Usu.;10;Hora;17;Sald.Cnt;22;TInt;11;", pnItem)
        End If
        
        RegTrandiaria.MoveNext
    Wend
    
    If lnTRet <> 0 Or lnTDep <> 0 Then
        psCadena = psCadena & ofuni.Encabezado("Resumen;16;" & Trim(Format(lnTDep, "###,##0.00")) & ";42; ;60;", pnItem)
        
        pnTotRet = pnTotRet + lnTRet
        pnTotDep = pnTotDep + lnTDep
        
        psCadena = psCadena & Chr(12)
    End If
    Set ofuni = Nothing
End Sub

'Operacioens hechas por otras agencias en este servidor
Private Sub MovimientoExternosCTS(psCadena As String, psTitulo As String, pnPagina As Long, pnItem As Long, pnTotDep As Double, pnTotRet As Double, Optional psMoneda As Moneda = gMonedaNacional, Optional psCodUser As String = "XXX", Optional psFecha As String = "", Optional psTipoOpe As String = "", Optional pbEsTramite As Boolean = False)
    Dim SQL1 As String
    Dim RegTrandiaria As New ADODB.Recordset
    Dim lsDoc As String
    Dim lsCodCta As String
    Dim lsDep As String
    Dim lsRet As String
    
    Dim lnTDep As Double
    Dim lnTRet As Double
    
    Dim lnTDepT As Double
    Dim lnTRetT As Double
    Dim lnValor As Double
    Dim lnOpe As Double
    Dim lnPorRet As Double
    Dim lbBan  As Boolean
    Dim lsGru  As String
    Dim lnTRetAge As Currency
    Dim lnTDepAge As Currency
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim i As Long
    
    lnTRet = 0
    lnTDep = 0
    
    If pbEsTramite Then
        If psCodUser = "XXX" Then
            SQL1 = " Select M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
                 & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion , Substring(MC.cCtaCod,4,2) cCodAge" _
                 & " From Mov M" _
                 & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                 & " Inner Join CaptacCTS CA On MC.cCtaCod = CA.cCtaCod" _
                 & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                 & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                 & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(MC.cCtaCod,4,2)" _
                 & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                 & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
                 & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                 & " And Substring(M.cMovNro,18,2) = '" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%' ORDER BY Substring(MC.cCtaCod,4,2), CA.cCtaCod"
        Else
            SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion, Substring(MC.cCtaCod,4,2) cCodAge " _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacCTS CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(MC.cCtaCod,4,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(MC.cCtaCod,18,2) = '" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY Substring(MC.cCtaCod,4,2), CA.cCtaCod"
        End If
    Else
        If psCodUser = "XXX" Then
            SQL1 = " Select M.cMovNro, MC.cOpeCod cCodOpe, MC.cCtaCod cCodCta, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion , Substring(M.cMovNro,18,2) cCodAge" _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacCTS CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(M.cMovNro,18,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(MC.cCtaCod,1,5) Like '___" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%' ORDER BY Substring(M.cMovNro,18,2), CA.cCtaCod"
        Else
            SQL1 = " Select  M.cMovNro, MC.cOpeCod, MC.cCtaCod, cDocNro cNumDoc, abs(nMonto) nMontran," _
                  & " nSaldoDisponible as nSaldDispAC, nSaldoContable nSaldCnt, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaIntAC, AGE.cAgeDescripcion, Substring(M.cMovNro,18,2) cCodAge " _
                  & " From Mov M" _
                  & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
                  & " Inner Join CaptacCTS CA On MC.cCtaCod = CA.cCtaCod" _
                  & " Inner Join Producto P On P.cCtaCod = CA.cCtaCod" _
                  & " Left  Join MovDoc MD On M.nMovNro = MD.nMovNro" _
                  & " Inner Join Agencias AGE On AGE.cAgeCod = Substring(M.cMovNro,18,2)" _
                  & " Where Substring(MC.cCtaCod,9,1) = '" & psMoneda & "'" _
                  & " And MC.cOpeCod in ('" & psTipoOpe & "')" _
                  & " And M.nMovFlag = " & MovFlag.gMovFlagVigente & "  And Substring(M.cMovNro,18,2) <> Substring(MC.cCtaCod,4,2)" _
                  & " And Substring(MC.cCtaCod,1,5) Like '___" & lsAgeCod & "' And M.cMovNro Like '" & psFecha & "%" & psCodUser & "' ORDER BY Substring(M.cMovNro,18,2), CA.cCtaCod"
        End If
    End If
    
    Set RegTrandiaria = oCon.CargaRecordSet(SQL1)
    
    If Not (RegTrandiaria.BOF And RegTrandiaria.EOF) Then
        psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Efectivo-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
        psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;Sald.Cnt.Ant.;20;Deposito;20;Retiro;20;Usu.;6;Hora;12;TInt;8;", pnItem)
        
        lsGru = ""
        lnTRetAge = 0
        lnTDepAge = 0
        
        While Not RegTrandiaria.EOF
            lbBan = True
            If lsGru <> "" And lsGru <> RegTrandiaria!CCodage Then
                psCadena = psCadena & ofuni.Encabezado("Total Agencia;15;" & Format(lnTDepAge, "###,##0.00") & ";57;" & Format(lnTRetAge, "###,##0.00") & ";20; ;46;", pnItem)
                lnTRetAge = 0
                lnTDepAge = 0
                lbBan = True
            End If

            If Len(RegTrandiaria!cCodCta) = 12 Then
                If lsGru <> RegTrandiaria!CCodage Then
                    lsGru = RegTrandiaria!CCodage
                    psCadena = psCadena & ofuni.Encabezado("Agencia: " & RegTrandiaria!cAgeDescripcion & ";32;", pnItem)
                    lbBan = True
                End If
            End If
           
            If IsNull(RegTrandiaria!cNumDoc) Then
                lsDoc = " "
            Else
                lsDoc = RegTrandiaria!cNumDoc
            End If
            
            If RegTrandiaria!nMonTran >= 0 Then
                lsDep = Format(RegTrandiaria!nMonTran, "###,##0.00")
                lsRet = "0.00"
                lnTDep = lnTDep + RegTrandiaria!nMonTran
                lnOpe = RegTrandiaria!nMonTran
                lnTDepAge = lnTDepAge + RegTrandiaria!nMonTran
            Else
                lsDep = "0.00"
                lsRet = Format(-1 * RegTrandiaria!nMonTran, "###,##0.00")
                lnTRet = lnTRet + (RegTrandiaria!nMonTran * -1)
                lnOpe = RegTrandiaria!nMonTran
                lnTRetAge = lnTRetAge + (RegTrandiaria!nMonTran * -1)
            End If
            
            If IsNull(RegTrandiaria!nSaldCnt) Then
                lnValor = 0
            Else
                lnValor = RegTrandiaria!nSaldCnt
            End If
            
            psCadena = psCadena & Space(14 - Len(RegTrandiaria!cCodCta)) & RegTrandiaria!cCodCta _
                                & Space(18 - Len(Trim(lsDoc))) & Trim(lsDoc) _
                                & Space(20 - Len(Format(lnValor - lnOpe, "###,##0.00"))) & Format(lnValor - lnOpe, "###,##0.00") _
                                & Space(20 - Len(lsDep)) & lsDep _
                                & Space(20 - Len(lsRet)) & lsRet _
                                & Space(6 - Len(RegTrandiaria!cCodusurem)) & RegTrandiaria!cCodusurem _
                                & Space(12 - Len(Format(RegTrandiaria!dFecTran, "hh:mm:ss AMPM"))) & Format(RegTrandiaria!dFecTran, "hh:mm:ss AMPM") _
                                & Space(8 - Len(Format(RegTrandiaria!nTasaIntCTS, "###,##0.00"))) & Format(RegTrandiaria!nTasaIntCTS, "###,##0.00") & Chr(10)
                               
            pnItem = pnItem + 1
            
            If pnItem = lnRango Then
                psCadena = psCadena & Chr(12)
                psCadena = psCadena & ofuni.CabeceraPagina(psTitulo & "-Efectivo-", pnPagina, pnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                psCadena = psCadena & ofuni.Encabezado("Nro Cuenta;14;Nro.Doc.;18;Sald.Cnt.Ant.;20;Deposito;20;Retiro;20;Usu.;6;Hora;12;Sald.Cnt.;20;TInt;8;", pnItem)
            End If
            
            RegTrandiaria.MoveNext
        Wend
            
        If lbBan Then psCadena = psCadena & ofuni.Encabezado("Total Agencia;15;" & Format(lnTDepAge, "###,##0.00") & ";57;" & Format(lnTRetAge, "###,##0.00") & ";20; ;46;", pnItem)
        lnTRetT = lnTRet
        lnTDepT = lnTDep
            
        RegTrandiaria.Close
    End If
        
    Set RegTrandiaria = Nothing
    
    If lnTRetT <> 0 Or lnTDepT <> 0 Then
        psCadena = psCadena & ofuni.Encabezado("Resumen;15;" & Format(lnTDepT, "###,##0.00") & ";57;" & Format(lnTRetT, "###,##0.00") & ";20; ;25;", pnItem)
        pnTotRet = pnTotRet + lnTRetT
        pnTotDep = pnTotDep + lnTDepT
        psCadena = psCadena & Chr(12)
    End If
    Set ofuni = Nothing
End Sub

Public Function SdosTipCta(Optional psCodAge As String = "") As String
    Dim sPers As String * 31
    Dim lnNumRec As Currency
    Dim lnSdoPro As Currency
    Dim lnSdoTot As Currency
    Dim lnRecPro As Currency
    Dim sqlAgencia As String
    
    Dim lsMoneda As String
    Dim m As Moneda
    Dim P As PersPersoneria
    Dim lsQrySdo As String
    Dim rsSdo As New ADODB.Recordset
    Dim lnRegCod As Integer
    Dim lsValor As String, lsNumPag As String
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lsTipMon As String, lsTipPer As String
    Dim lnCarLin As Integer, lnCntPag As Integer
    Dim lnRecs01 As Integer, lnRecs02 As Integer
    Dim lnRecs03 As Integer, lnRecs04 As Integer
    Dim lnRecs05 As Integer, lnRecs06 As Integer
    Dim lnSdos01 As Currency, lnSdos02 As Currency
    Dim lnSdos03 As Currency, lnSdos04 As Currency
    Dim lnSdos05 As Currency, lnSdos06 As Currency
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    Dim sqlAdd As String
    
    lnRecs01 = 0: lnRecs02 = 0: lnRecs03 = 0: lnRecs04 = 0: lnRecs05 = 0: lnRecs06 = 0
    lnSdos01 = 0: lnSdos02 = 0: lnSdos03 = 0: lnSdos04 = 0: lnSdos05 = 0: lnSdos06 = 0
    
    lnCarLin = 170
    
    oCon.AbreConexion
    
    Set rsSdo = New ADODB.Recordset
    rsSdo.CursorLocation = adUseClient
    
    If psCodAge = "" Then
        sqlAgencia = ""
    Else
        sqlAgencia = " And Left(PR.cCtaCod,5) Like  '___" & psCodAge & "'"
    End If
    
    lsRTFRfm = ""
    
    For m = gMonedaNacional To gMonedaExtranjera
        lnCntPag = 1
        lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
        lsMoneda = IIf(m = Moneda.gMonedaNacional, "SOLES", "DOLARES")
        lsTitRp1 = "I N F O R M E   D E   S A L D O S   P O R   T I P O   D E   C U E N T A"
        lsTitRp2 = ""
        lsRTFRfm = lsRTFRfm & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1, lsTitRp2, lsMoneda, lsNumPag) & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(38, " ") & "        A  H  O  R  R  O  S               P L A Z O    F I J O                     C    T    S                       T  O  T  A  L  " & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(38, " ") & "A C T I V A S        I N A C T I V A S" & String(29, " ") & "C L I E N T E S        E M P L E A D O S      A C U M U L A D O" & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(8, " ") & "C O N C E P T O S" & String(8, " ")
        lsRTFRfm = lsRTFRfm & "NUMERO     S A L D O S NUMERO     S A L D O S NUMERO     S A L D O S NUMERO     S A L D O S NUMERO     S A L D O S NUMERO     S A L D O S" & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
        
        For P = gPersonaNat To gPersonaJurCFLEdpyme
            If (P < gPersonaJurCFLCMAC Or P >= gPersonaJurCFLCMAC) Then
                Select Case P
                    Case PersPersoneria.gPersonaNat
                        sPers = "PERSONA NATURAL"
                    Case PersPersoneria.gPersonaJurSFL
                        sPers = "PERSONA JUR. SIN FINES DE LUCRO"
                    Case PersPersoneria.gPersonaJurCFL
                        sPers = "PERSONA JUR. CON FINES DE LUCRO"
                    Case PersPersoneria.gPersonaJurCFLCMAC
                        sPers = "CAJAS MUNICIPALES"
                    Case PersPersoneria.gPersonaJurCFLCRAC
                        sPers = "CAJAS RURALES"
                    Case PersPersoneria.gPersonaJurCFLCooperativa
                        sPers = "COOPERATIVAS"
                    Case PersPersoneria.gPersonaJurCFLEdpyme
                        sPers = "EDPYMES"
                End Select
                lsRTFRfm = lsRTFRfm & sPers & "  "
                
                lsQrySdo = " SELECT ISNULL(COUNT(PR.cCtaCod),0) Num, ISNULL(SUM(nSaldo),0) nSdoCnt FROM Producto PR" _
                         & " Inner Join Captaciones CA On PR.cCtaCod = CA.cCtaCod Inner Join CaptacAhorros CAA On PR.cCtaCod = CAA.cCtaCod WHERE Left(nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "', '" & Left(CaptacEstado.gCapEstCancelada, 2) & "') AND bInactiva = 0" _
                         & " AND SUBSTRING(PR.cCtaCod,9,1) = '" & m & "' AND nPersoneria = '" & P & "'" & sqlAgencia
                If rsSdo.State = adStateOpen Then rsSdo.Close
                Set rsSdo = oCon.CargaRecordSet(lsQrySdo)
                If rsSdo.EOF And rsSdo.BOF Then
                    lnNumRec = 0: lnSdoPro = 0
                Else
                    lnNumRec = rsSdo!Num
                    lnSdoPro = rsSdo!nSdoCnt
                    lnSdoTot = lnSdoTot + lnSdoPro
                    lnRecPro = lnRecPro + lnNumRec
                End If
          
                lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnNumRec)), 6, False, 6, 0) & " "
                lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoPro)), 15, True, 9, 2) & " "
                lnRecs01 = lnRecs01 + lnNumRec
                lnSdos01 = lnSdos01 + lnSdoPro
        
                lsQrySdo = " SELECT ISNULL(COUNT(PR.cCtaCod),0) Num, ISNULL(SUM(nSaldo),0) nSdoCnt FROM Producto PR" _
                         & " Inner Join Captaciones CA On PR.cCtaCod = CA.cCtaCod Inner Join CaptacAhorros CAA On PR.cCtaCod = CAA.cCtaCod WHERE Left(nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "', '" & Left(CaptacEstado.gCapEstCancelada, 2) & "') AND bInactiva = 1" _
                         & " AND SUBSTRING(PR.cCtaCod,9,1) = '" & m & "' AND nPersoneria = '" & P & "'" & sqlAgencia
                If rsSdo.State = adStateOpen Then rsSdo.Close
                Set rsSdo = oCon.CargaRecordSet(lsQrySdo)
                
                If rsSdo.EOF And rsSdo.BOF Then
                    lnNumRec = 0: lnSdoPro = 0
                Else
                    lnNumRec = rsSdo!Num
                    lnSdoPro = rsSdo!nSdoCnt
                    lnSdoTot = lnSdoTot + lnSdoPro
                    lnRecPro = lnRecPro + lnNumRec
                End If
        
                lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnNumRec)), 6, False, 6, 0) & " "
                lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoPro)), 15, True, 9, 2) & " "
                lnRecs02 = lnRecs02 + lnNumRec
                lnSdos02 = lnSdos02 + lnSdoPro
                
                lsQrySdo = " SELECT ISNULL(COUNT(PR.cCtaCod),0) Num, ISNULL(SUM(nSaldo),0) nSdoCnt FROM Producto PR" _
                         & " Inner Join Captaciones CA On PR.cCtaCod = CA.cCtaCod Inner Join CaptacPlazoFijo CAA On PR.cCtaCod = CAA.cCtaCod WHERE Left(nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "', '" & Left(CaptacEstado.gCapEstCancelada, 2) & "')" _
                         & " AND SUBSTRING(PR.cCtaCod,9,1) = '" & m & "' AND nPersoneria = '" & P & "'" & sqlAgencia
                
                If rsSdo.State = adStateOpen Then rsSdo.Close
                Set rsSdo = oCon.CargaRecordSet(lsQrySdo)

                Set rsSdo.ActiveConnection = Nothing
                If rsSdo.EOF And rsSdo.BOF Then
                    lnNumRec = 0: lnSdoPro = 0
                Else
                    lnNumRec = rsSdo!Num
                    lnSdoPro = rsSdo!nSdoCnt
                    lnSdoTot = lnSdoTot + lnSdoPro
                    lnRecPro = lnRecPro + lnNumRec
                End If
                lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnNumRec)), 6, False, 6, 0) & " "
                lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoPro)), 15, True, 9, 2) & " "
                lnRecs03 = lnRecs03 + lnNumRec
                lnSdos03 = lnSdos03 + lnSdoPro
                    
                If P <> gPersonaJurCFLCMAC Then
                              
                    lsQrySdo = " SELECT ISNULL(COUNT(PR.cCtaCod),0) Num, ISNULL(SUM(nSaldo),0) nSdoCnt FROM Producto PR" _
                             & " Inner Join Captaciones CA On PR.cCtaCod = CA.cCtaCod Inner Join CaptacCTS CAA On PR.cCtaCod = CAA.cCtaCod WHERE Left(nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "', '" & Left(CaptacEstado.gCapEstCancelada, 2) & "')" _
                             & " AND SUBSTRING(PR.cCtaCod,9,1) = '" & m & "' AND nPersoneria = '" & P & "' AND cCodInst <> '" & gsInstCmac & "'" & sqlAgencia
                    
                    If rsSdo.State = adStateOpen Then rsSdo.Close
                    Set rsSdo = oCon.CargaRecordSet(lsQrySdo)
                    
                    If rsSdo.EOF And rsSdo.BOF Then
                       lnNumRec = 0: lnSdoPro = 0
                    Else
                       lnNumRec = rsSdo!Num
                       lnSdoPro = rsSdo!nSdoCnt
                       lnSdoTot = lnSdoTot + lnSdoPro
                       lnRecPro = lnRecPro + lnNumRec
                    End If
        
                    lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnNumRec)), 6, False, 6, 0) & " "
                    lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoPro)), 15, True, 9, 2) & " "
                    lnRecs04 = lnRecs04 + lnNumRec
                    lnSdos04 = lnSdos04 + lnSdoPro
                  
                    lsQrySdo = " SELECT ISNULL(COUNT(PR.cCtaCod),0) Num, ISNULL(SUM(nSaldo),0) nSdoCnt FROM Producto PR" _
                             & " Inner Join Captaciones CA On PR.cCtaCod = CA.cCtaCod Inner Join CaptacCTS CAA On PR.cCtaCod = CAA.cCtaCod WHERE Left(nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "', '" & Left(CaptacEstado.gCapEstCancelada, 2) & "')" _
                             & " AND SUBSTRING(PR.cCtaCod,9,1) = '" & m & "' AND nPersoneria = '" & P & "' AND cCodInst = '" & gsInstCmac & "'" & sqlAgencia
                    
                    If rsSdo.State = adStateOpen Then rsSdo.Close
                    Set rsSdo = oCon.CargaRecordSet(lsQrySdo)
                    
                    Set rsSdo.ActiveConnection = Nothing
                    If rsSdo.EOF And rsSdo.BOF Then
                        lnNumRec = 0: lnSdoPro = 0
                    Else
                        lnNumRec = rsSdo!Num
                        lnSdoPro = rsSdo!nSdoCnt
                        lnSdoTot = lnSdoTot + lnSdoPro
                        lnRecPro = lnRecPro + lnNumRec
                    End If
                    lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnNumRec)), 6, False, 6, 0) & " "
                    lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoPro)), 15, True, 9, 2) & " "
                    lnRecs05 = lnRecs05 + lnNumRec
                    lnSdos05 = lnSdos05 + lnSdoPro
                Else
                    lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(0)), 6, False, 6, 0) & " "
                    lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(0)), 15, True, 9, 2) & " "
                    lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(0)), 6, False, 6, 0) & " "
                    lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(0)), 15, True, 9, 2) & " "
                End If
                lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecPro)), 6, False, 6, 0) & " "
                lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoTot)), 15, True, 9, 2) & oImp.gPrnSaltoLinea
                lnRecs06 = lnRecs06 + lnRecPro
                lnSdos06 = lnSdos06 + lnSdoTot
                  
                lnSdoTot = 0: lnRecPro = 0
            End If
           
        Next P
        lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & "T  O  T  A  L  E  S" & String(14, " ")
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecs01)), 6, False, 6, 0) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdos01)), 15, True, 9, 2) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecs02)), 6, False, 6, 0) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdos02)), 15, True, 9, 2) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecs03)), 6, False, 6, 0) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdos03)), 15, True, 9, 2) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecs04)), 6, False, 6, 0) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdos04)), 15, True, 9, 2) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecs05)), 6, False, 6, 0) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdos05)), 15, True, 9, 2) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecs06)), 6, False, 6, 0) & " "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdos06)), 15, True, 9, 2) & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(lnCarLin, "=") & oImp.gPrnSaltoLinea
        If m < 2 Then
            lsRTFRfm = lsRTFRfm & oImp.gPrnSaltoPagina
            lsRTFRfm = lsRTFRfm & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
            lnRecs01 = 0: lnRecs02 = 0: lnRecs03 = 0: lnRecs04 = 0: lnRecs05 = 0: lnRecs06 = 0
            lnSdos01 = 0: lnSdos02 = 0: lnSdos03 = 0: lnSdos04 = 0: lnSdos05 = 0: lnSdos06 = 0
        End If
    Next m
    Set ofuni = Nothing
    Set ofunc = Nothing
    SdosTipCta = lsRTFRfm
End Function


'   ------------------------------------------------------------
'   Función _GlobalNameSpace
'   Propósito   :   Define cabecera del reporte
'   Parámetro(s):   pnCarLin -> Caracteres x linea del reporte
'                   psSeccio -> Area responsable
'                   psTitRp1 -> Titulo 1 del reporte
'                   psTitRp2 -> Titulo 2 del reporte
'                   psMoneda -> Tipo de Moneda
'   Creado      :   02/07/1999  -   FAOS
'   Modificado  :   02/07/1999  -   FAOS
'   ------------------------------------------------------------
'   Formato     :   CabeRepo()
Private Function CabeRepo(psCabe01 As String, psCabe02 As String, _
                         pnCarLin As Integer, psSeccio As String, _
                         psTitRp1 As String, psTitRp2 As String, _
                         psMoneda As String, psNumPag As String) As String

    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lsMoneda As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    lsTitRp1 = "": lsTitRp2 = ""
    CabeRepo = ""
    lsMoneda = ""
    lsMoneda = IIf(psMoneda = "", String(10, " "), " - " & psMoneda)
'    psCabe01 = ""
'    psCabe02 = ""
    
    '   Definición de Cabecera 1
 
    psCabe01 = ofuni.FillText(UCase(Trim(lsNomAge)) & lsMoneda, 36, " ")
    psCabe01 = psCabe01 & Space((pnCarLin - 36) - (Len(psCabe01) - 2))
    psCabe01 = psCabe01 & "PAGINA: " & psNumPag
    psCabe01 = psCabe01 & Space(5) & "FECHA: " & Format(ldFecRepo, ofunf.gsFormatoFechaView)
    '   Definición de Cabecera 2
    psCabe02 = ofuni.FillText(psSeccio, 19, " ")
    psCabe02 = psCabe02 & Space((pnCarLin - 19) - (Len(psCabe02) - 2))
    psCabe02 = psCabe02 & "HORA :   " & Format(Now(), "hh:mm:ss")
    '   Definición del Titulo del Reporte
    lsTitRp1 = String(Int((pnCarLin - Len(psTitRp1)) / 2), " ") & psTitRp1
    lsTitRp2 = String(Int((pnCarLin - Len(psTitRp2)) / 2), " ") & psTitRp2
    
    CabeRepo = CabeRepo & psCabe01 & oImp.gPrnSaltoLinea
    CabeRepo = CabeRepo & psCabe02 & oImp.gPrnSaltoLinea
    CabeRepo = CabeRepo & lsTitRp1 & oImp.gPrnSaltoLinea
    CabeRepo = CabeRepo & lsTitRp2
        
End Function


Public Function EstratDep(psCodAge As String, psFecha As String) As String
    Dim m As Moneda, P As Integer
    Dim lsQrySdo As String
    Dim rsQrySdo As New ADODB.Recordset
    Dim lnRegCod As Integer
    Dim lsValor As String, lsNumPag As String
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lsTipMon As String, lsTipPer As String
    Dim lnCarLin As Integer, lnCntPag As Integer
    Dim lnRecs01 As Integer, lnRecs02 As Integer
    Dim lnRecs03 As Integer, lnRecs04 As Integer
    Dim lnSdos01 As Currency, lnSdos02 As Currency
    Dim lnSdos03 As Currency, lnSdos04 As Currency
    Dim lnSaldos As Currency
    Dim lsLimite As String, lsLimInf As String, lsLimSup As String
    Dim i As Integer, J As Integer
    Dim lnTCFHoy As Currency, lnMinVal As Currency, lnMaxVal As Currency
    Dim lnLimInd As Integer
  
    Dim lsMoneda As String
    Dim lnRecPro As Currency
    Dim lnSdoTot As Currency
    Dim sqlAgencia As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    lsRTFRfm = ""
    
    If psCodAge = "" Then
        sqlAgencia = ""
    Else
        sqlAgencia = " And Left(PR.cCtaCod,5) Like '___" & psCodAge & "'"
    End If
    
    lnRecs01 = 0: lnRecs02 = 0: lnRecs03 = 0: lnRecs04 = 0
    lnSdos01 = 0: lnSdos02 = 0: lnSdos03 = 0: lnSdos04 = 0
    
    lnCarLin = 130
    lsLimite = "     100     500    1000    2000    5000   10000   25000   50000  100000999999999"
            
    oCon.AbreConexion
            
    For m = 1 To 2
       
        lsTipMon = Trim(Str(m))
        lnTCFHoy = IIf(lsTipMon = Moneda.gMonedaNacional, 3.48, 1)
        lnCntPag = 1
        lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
        lsMoneda = IIf(m = gMonedaNacional, "SOLES", "DOLARES")
        lsTitRp1 = "E S T R A T I F I C A C I O N   D E   L O S   D E P O S I T O S"
        lsTitRp2 = ""
        lsRTFRfm = lsRTFRfm & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1, lsTitRp2, lsMoneda, lsNumPag) & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(32, " ") & " A  H  O  R  R  O  S   P L A Z O  F I J O       C    T    S          T  O  T  A  L" & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(7, " ") & "R  A  N  G  O  S" & String(9, " ")
        lsRTFRfm = lsRTFRfm & "NUMERO   S A L D O S  NUMERO   S A L D O S  NUMERO   S A L D O S  NUMERO   S A L D O S" & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
        
        For P = 1 To 10
            lnLimInd = IIf(P > 1, P - 1, P)
            If P <> 1 Then
                lnMinVal = IIf(P > 1, CCur(Mid$(lsLimite, (lnLimInd * 8) - 7, 8)), 0) * lnTCFHoy + 0.001
            Else
                lnMinVal = IIf(P > 1, CCur(Mid$(lsLimite, (lnLimInd * 8) - 7, 8)), 0) * lnTCFHoy + 0
            End If
            lnMaxVal = CCur(Mid$(lsLimite, (P * 8) - 7, 8)) * lnTCFHoy
            lsLimInf = IIf(P > 1, "DE " & ofunc.JDNum(Trim(Str(lnMinVal)), 14, True, 11, 2) & " A ", "HASTA...............")
            If P > 9 Then
               lnMinVal = CCur(Mid$(lsLimite, (lnLimInd * 8) - 7, 8)) * lnTCFHoy
               lsLimInf = "MAYOR A............." & ofunc.JDNum(Trim(Str(lnMinVal)), 14, True, 11, 2)
               lnMinVal = lnMinVal + 0.01
               lsLimSup = ""
            Else
               lsLimSup = ofunc.JDNum(Trim(Str(lnMaxVal)), 14, True, 13, 2)
            End If
            
            lsRTFRfm = lsRTFRfm & lsLimInf & lsLimSup & "  "
            
            'lsQrySdo = " SELECT COUNT(*) AS nRecs, IsNull(SUM(nSaldo),0) AS nSdos " _
                     & " FROM       Producto PR" _
                     & " WHERE      Left(nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "', '" & Left(CaptacEstado.gCapEstCancelada, 2) & "') AND SUBSTRING(cCtaCod,9,1) = '" & lsTipMon & "' And Substring(cCtaCod,6,3) = '" & Producto.gCapAhorros & "'" _
                     & " AND        nSaldo BETWEEN " & lnMinVal & " AND " & lnMaxVal & " " & sqlAgencia
                     
'            lsQrySdo = " SELECT COUNT(*) AS nRecs, IsNull(SUM(nSaldo),0) AS nSdos " _
                     & " FROM       Producto PR" _
                     & " WHERE      Left(nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "', '" & Left(CaptacEstado.gCapEstCancelada, 2) & "') AND SUBSTRING(cCtaCod,9,1) = '" & lsTipMon & "' And Substring(cCtaCod,6,3) = '" & Producto.gCapAhorros & "'" _
                     & " AND        nSaldo BETWEEN " & lnMinVal & " AND " & lnMaxVal & " " & sqlAgencia
                     
            lsQrySdo = " Select COUNT(*) AS nRecs, IsNull(SUM(nSaldCnt),0) AS nSdos " _
                     & " From CapsaldosDiarios" _
                     & " Where dfecha >= '" & Format(CDate(psFecha), "mm/dd/yyyy") & "' And dfecha < '" & Format(DateAdd("d", 1, CDate(psFecha)), "mm/dd/yyyy") & "' AND SUBSTRING(cCtaCod,9,1) = '" & lsTipMon & "' And Substring(cCtaCod,6,3) = '" & Producto.gCapAhorros & "' /* And nTpoBloqueo not in (3,15) And nInmovilizada <> 1  */ " _
                     & " AND nSaldCnt BETWEEN " & lnMinVal & " AND " & lnMaxVal & " " & "And cCtaCod Like '___" & psCodAge & "%'"
            
            '& " Where Convert(varchar(8),dfecha,112) = '" & Format(CDate(psFecha), gsFormatoMovFecha) & "' AND SUBSTRING(cCtaCod,9,1) = '" & lsTipMon & "' And Substring(cCtaCod,6,3) = '" & Producto.gCapAhorros & "' And nTpoBloqueo not in (3,15) And nInmovilizada <> 1 And nCuentaCredMV <> 1 " _

            If rsQrySdo.State = adStateOpen Then rsQrySdo.Close
            
            Set rsQrySdo = oCon.CargaRecordSet(lsQrySdo)
              
            lnSaldos = 0: lnSaldos = IIf(IsNull(rsQrySdo!nSdos) = True, 0, rsQrySdo!nSdos)
            lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(rsQrySdo!nRecs)), 6, False, 6, 0) & "  "
            lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSaldos)), 14, True, 11, 2) & "  "
            lnRecs01 = lnRecs01 + rsQrySdo!nRecs:  lnSdos01 = lnSdos01 + lnSaldos
            lnRecPro = lnRecPro + rsQrySdo!nRecs:  lnSdoTot = lnSdoTot + lnSaldos
            
            'lsQrySdo = " SELECT COUNT(*) AS nRecs, IsNull(SUM(nSaldo),0) AS nSdos " _
                     & " FROM       Producto PR " _
                     & " WHERE      Left(nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "', '" & Left(CaptacEstado.gCapEstCancelada, 2) & "') AND SUBSTRING(cCtaCod,9,1) = '" & lsTipMon & "' And Substring(cCtaCod,6,3) = '" & Producto.gCapPlazoFijo & "'" _
                     & " AND        nSaldo BETWEEN " & lnMinVal & " AND " & lnMaxVal & " " & sqlAgencia
                     
            lsQrySdo = " Select COUNT(*) AS nRecs, IsNull(SUM(nSaldCnt),0) AS nSdos " _
                     & " From CapsaldosDiarios" _
                     & " Where dfecha >= '" & Format(CDate(psFecha), "mm/dd/yyyy") & "' And dfecha < '" & Format(DateAdd("d", 1, CDate(psFecha)), "mm/dd/yyyy") & "' AND SUBSTRING(cCtaCod,9,1) = '" & lsTipMon & "' And ( (Substring(cCtaCod,6,3) = '" & Producto.gCapPlazoFijo & "') /* Or ( (Substring(cCtaCod,6,3) in ('" & Producto.gCapAhorros & "', '" & Producto.gCapCTS & "') )  And (nTpoBloqueo in (3,15) or nInmovilizada = 1  )) */) " _
                     & " AND nSaldCnt BETWEEN " & lnMinVal & " AND " & lnMaxVal & " " & "And cCtaCod Like '___" & psCodAge & "%'"
                     
                     '& " Where Convert(varchar(8),dfecha,112) = '" & Format(CDate(psFecha), gsFormatoMovFecha) & "' AND SUBSTRING(cCtaCod,9,1) = '" & lsTipMon & "' And ( (Substring(cCtaCod,6,3) = '" & Producto.gCapPlazoFijo & "') Or ( (Substring(cCtaCod,6,3) in ('" & Producto.gCapAhorros & "', '" & Producto.gCapCTS & "') )  And (nTpoBloqueo in (3,15) or nInmovilizada = 1 or nCuentaCredMV = 1 ))) " _

            If rsQrySdo.State = adStateOpen Then rsQrySdo.Close
            
            Set rsQrySdo = oCon.CargaRecordSet(lsQrySdo)
              
            lnSaldos = 0: lnSaldos = IIf(IsNull(rsQrySdo!nSdos) = True, 0, rsQrySdo!nSdos)
            lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(rsQrySdo!nRecs)), 6, False, 6, 0) & "  "
            lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSaldos)), 14, True, 11, 2) & "  "
            lnRecs02 = lnRecs02 + rsQrySdo!nRecs:   lnSdos02 = lnSdos02 + lnSaldos
            lnRecPro = lnRecPro + rsQrySdo!nRecs:   lnSdoTot = lnSdoTot + lnSaldos
            
            'lsQrySdo = " SELECT COUNT(*) AS nRecs, IsNull(SUM(nSaldo),0) AS nSdos " _
                     & " FROM       Producto PR" _
                     & " WHERE      Left(nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "', '" & Left(CaptacEstado.gCapEstCancelada, 2) & "') AND SUBSTRING(cCtaCod,9,1) = '" & lsTipMon & "' And Substring(cCtaCod,6,3) = '" & Producto.gCapCTS & "'" _
                     & " AND        nSaldo BETWEEN " & lnMinVal & " AND " & lnMaxVal & " " & sqlAgencia
            
            lsQrySdo = " Select COUNT(*) AS nRecs, IsNull(SUM(nSaldCnt),0) AS nSdos " _
                     & " From CapsaldosDiarios" _
                     & " Where dfecha >= '" & Format(CDate(psFecha), "mm/dd/yyyy") & "' And dfecha < '" & Format(DateAdd("d", 1, CDate(psFecha)), "mm/dd/yyyy") & "' AND SUBSTRING(cCtaCod,9,1) = '" & lsTipMon & "' And Substring(cCtaCod,6,3) = '" & Producto.gCapCTS & "' /* And nTpoBloqueo not in (3,15) And nInmovilizada <> 1 */ " _
                     & " AND nSaldCnt BETWEEN " & lnMinVal & " AND " & lnMaxVal & " " & "And cCtaCod Like '___" & psCodAge & "%'"
            
            '& " Where Convert(varchar(8),dfecha,112) = '" & Format(CDate(psFecha), gsFormatoMovFecha) & "' AND SUBSTRING(cCtaCod,9,1) = '" & lsTipMon & "' And Substring(cCtaCod,6,3) = '" & Producto.gCapCTS & "' And nTpoBloqueo not in (3,15) And nInmovilizada <> 1 And nCuentaCredMV <> 1 " _

            If rsQrySdo.State = adStateOpen Then rsQrySdo.Close
            
            Set rsQrySdo = oCon.CargaRecordSet(lsQrySdo)
              
            lnSaldos = 0: lnSaldos = IIf(IsNull(rsQrySdo!nSdos) = True, 0, rsQrySdo!nSdos)
            lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(rsQrySdo!nRecs)), 6, False, 6, 0) & "  "
            lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSaldos)), 14, True, 11, 2) & "  "
            lnRecs03 = lnRecs03 + rsQrySdo!nRecs:    lnSdos03 = lnSdos03 + lnSaldos
            lnRecPro = lnRecPro + rsQrySdo!nRecs:    lnSdoTot = lnSdoTot + lnSaldos
            
            lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecPro)), 6, False, 6, 0) & "  "
            lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoTot)), 14, True, 11, 2) & oImp.gPrnSaltoLinea
            lnRecs04 = lnRecs04 + lnRecPro:    lnSdos04 = lnSdos04 + lnSdoTot
                  
            lnSdoTot = 0: lnRecPro = 0
        Next P
        
        lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & "T  O  T  A  L  E  S" & String(17, " ")
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecs01)), 6, False, 6, 0) & "  "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdos01)), 14, True, 11, 2) & "  "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecs02)), 6, False, 6, 0) & "  "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdos02)), 14, True, 11, 2) & "  "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecs03)), 6, False, 6, 0) & "  "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdos03)), 14, True, 11, 2) & "  "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnRecs04)), 6, False, 6, 0) & "  "
        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdos04)), 14, True, 11, 2) & oImp.gPrnSaltoLinea
        lsRTFRfm = lsRTFRfm & String(lnCarLin, "=") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoPagina
           
        lnRecs01 = 0: lnRecs02 = 0: lnRecs03 = 0: lnRecs04 = 0
        lnSdos01 = 0: lnSdos02 = 0: lnSdos03 = 0: lnSdos04 = 0
    Next m
    
    EstratDep = lsRTFRfm
    Set ofunc = Nothing
End Function

'   ------------------------------------------------------------
'   Función     :   CabeRepo
'   Propósito   :   Define cabecera del reporte
'   Parámetro(s):   pnCarLin -> Caracteres x linea del reporte
'                   psSeccio -> Area responsable
'                   psTitRp1 -> Titulo 1 del reporte
'                   psTitRp2 -> Titulo 2 del reporte
'                   psMoneda -> Tipo de Moneda
'   Creado      :   02/07/1999  -   FAOS
'   Modificado  :   02/07/1999  -   FAOS
'   ------------------------------------------------------------
'   Formato     :   CabeRepo()
Public Function CabeRepo1(psCabe01 As String, psCabe02 As String, _
                          pnCarLin As Integer, psSeccio As String, _
                          psTitRp1 As String, psTitRp2 As String, _
                          psMoneda As Moneda, psNumPag As String) As String

    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lsMoneda As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    lsTitRp1 = "": lsTitRp2 = ""
    CabeRepo1 = ""
    lsMoneda = ""
    lsMoneda = IIf(psMoneda = "", String(10, " "), " - " & psMoneda)
'    psCabe01 = ""
'    psCabe02 = ""
    
    '   Definición de Cabecera 1
 
    psCabe01 = ofuni.FillText(UCase(Trim(lsNomAge)) & lsMoneda, 36, " ")
    psCabe01 = psCabe01 & Space((pnCarLin - 36) - (Len(psCabe01) - 2))
    psCabe01 = psCabe01 & "PAGINA: " & psNumPag
    psCabe01 = psCabe01 & Space(5) & "FECHA: " & Format(ldFecSis, ofunf.gsFormatoFechaView)
    '   Definición de Cabecera 2
    psCabe02 = ofuni.FillText(psSeccio, 19, " ")
    psCabe02 = psCabe02 & Space((pnCarLin - 19) - (Len(psCabe02) - 2))
    psCabe02 = psCabe02 & "HORA :   " & Format(Now(), "hh:mm:ss")
    '   Definición del Titulo del Reporte
    lsTitRp1 = String(Int((pnCarLin - Len(psTitRp1)) / 2), " ") & psTitRp1
    lsTitRp2 = String(Int((pnCarLin - Len(psTitRp2)) / 2), " ") & psTitRp2
    
    CabeRepo1 = CabeRepo1 & psCabe01 & oImp.gPrnSaltoLinea
    CabeRepo1 = CabeRepo1 & psCabe02 & oImp.gPrnSaltoLinea
    CabeRepo1 = CabeRepo1 & lsTitRp1 & oImp.gPrnSaltoLinea
    CabeRepo1 = CabeRepo1 & lsTitRp2
        
End Function

Public Function LlenaEDAC(pnMoneda As Integer, pdFchPr1 As String, Optional pdFchPr2 As String) As String
    Dim rsQryEAC As ADODB.Recordset
    Set rsQryEAC = New ADODB.Recordset
    Dim lsQryEAC As String
    Dim ldFchIni As Date, ldFchFin As Date
    Dim lnCntMov As Integer
    Dim ldFchPro As Date
    Dim sqlAdd As String
    
    
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion
    
    lsRTFDat = ""
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And cCodAge = '" & lsAgeCod & "'"
    End If
    
    ldFchIni = CDate(pdFchPr1)
    ldFchFin = CDate(pdFchPr2)
    
    ReDim laMovDia(1 To 15, 1 To 1)
        lnTotA02 = 0: lnTotA03 = 0: lnTotA04 = 0: lnTotA05 = 0
        lnTotA06 = 0: lnTotA07 = 0: lnTotA08 = 0: lnTotA09 = 0
        lnTotA10 = 0: lnTotA11 = 0: lnTotA12 = 0: lnTotA13 = 0
        lnTotA14 = 0: lnTotA15 = 0
        lnCntMov = 0
        
        Do While ldFchIni <= ldFchFin
        
           lnCntMov = lnCntMov + 1
           ReDim Preserve laMovDia(1 To 15, 1 To lnCntMov)
           
           ldFchPro = ldFchIni
           
           lsQryEAC = " Select Convert(Varchar(8),dEstad,112) cUltimoMovimiento, Sum(nNumAper) nAperturasNum, Sum(nNumCanc) nCancelacionesNum," _
                    & " Sum(nMonAper) nAperturasMonto, Sum(nMonCanc) nCancelacionesMonto, Sum(nRetInt) nRetInt,  Sum(nRetInac) nRetiroIntacMon," _
                    & " Sum(nNumCancInac) nCancelacionesInacNum, Sum(nMonCancInac) nCancelacionesInacMonto, Sum(nNumDep) nDepositosNum, Sum(nMonDep) nDepositosMonto," _
                    & " Sum(nNumRet) nRetiroNum, Sum(nMonRet) nRetiroMonto, Sum(nIntCap) nInteresCapitalizados, Sum(Dia.nSaldo) nSaldo, Sum(DiaAnt.nSaldo) nSaldoAnterior," _
                    & " Sum(nMonChq) nChequeValorizacionMonto, Sum(NumCtas.NumCta) nCuentasVigentes," _
                    & " Sum(DiaSaldoCMAC.nSaldo) nSaldoCMAC, Sum(DiaSaldoCMAC.nMonChqVal) nChequeCMAC, SUM(nItf) as nItf " _
                    & " From CapEstadMovimiento Dia" _
                    & " Left Join" _
                    & " (Select Convert(Varchar(8),DateAdd(Day,1,dEstad),112) Fecha, Sum(nSaldo) nSaldo From CapEstadMovimiento" _
                    & " Where nProducto = '" & Producto.gCapAhorros & "' And nMoneda = " & Trim(Str(pnMoneda)) & " " & sqlAdd & " Group By Convert(Varchar(8),DateAdd(Day,1,dEstad),112)) As DiaAnt On DiaAnt.Fecha = Convert(Varchar(8),dEstad,112)" _
                    & " Inner Join" _
                    & " ( Select  Sum(nSaldo) nSaldo, Sum(nMonChqVal) nMonChqVal, Convert(Varchar(8),dEstad,112) Fecha"
                    
                    'lsQryEAC = lsQryEAC & "     From CapEstadSaldo where nProducto = '" & Producto.gCapAhorros & "' And nMoneda = " & Trim(Str(pnMoneda)) & " And nPersoneria = " & PersPersoneria.gPersonaJurCFLCMAC & " " & sqlAdd & " Group By Convert(Varchar(8),dEstad,112)) As DiaSaldoCMAC"
                    lsQryEAC = lsQryEAC & "     From CapEstadSaldo where nProducto = '" & Producto.gCapAhorros & "' And nMoneda = " & Trim(Str(pnMoneda)) & " " & sqlAdd & " Group By Convert(Varchar(8),dEstad,112)) As DiaSaldoCMAC"
                    
                    lsQryEAC = lsQryEAC & "         On DiaSaldoCMAC.Fecha = Convert(Varchar(8),dEstad,112)" _
                    & " Inner Join " _
                    & " (  Select sum(nNumCtas) NumCta, cCodAge cCodAgeC, Convert(Varchar(8),dEstad,112) Fecha " _
                    & "    From CapEstadSaldo DiaSaldo where nProducto = '" & Producto.gCapAhorros & "' And nMoneda = " & Trim(Str(pnMoneda)) & " " & sqlAdd & "  GroUp By Convert(Varchar(8),dEstad,112), cCodAge ) As NumCtas On NumCtas.Fecha = Convert(Varchar(8),Dia.dEstad,112) And Dia.cCodAge = NumCtas.cCodAgeC " _
                    & "  Where nProducto = '" & Producto.gCapAhorros & "' And nMoneda = " & Trim(Str(pnMoneda)) & " And dEstad Between '" & Format(CDate(ldFchPro), ofunf.gsFormatoFecha) & "' AND '" & Format(CDate(ldFchPro) + 1, ofunf.gsFormatoFecha) & "' " & sqlAdd & " Group By  Convert(Varchar(8),dEstad,112)"

           If rsQryEAC.State = adStateOpen Then rsQryEAC.Close
           
           Set rsQryEAC = oCon.CargaRecordSet(lsQryEAC)
       
           If rsQryEAC.EOF And rsQryEAC.BOF Then
              rsQryEAC.Close
              LlenaEDAC = ""
              laMovDia(1, lnCntMov) = Format(ldFchPro, ofunf.gsFormatoFechaView)
              For i = 2 To 15
                  laMovDia(i, lnCntMov) = 0
              Next i
           Else
           With rsQryEAC
                laMovDia(1, lnCntMov) = Mid(!cUltimoMovimiento, 7, 2) & "/" & Mid(!cUltimoMovimiento, 5, 2) & "/" & Left(!cUltimoMovimiento, 4)
                laMovDia(2, lnCntMov) = !nAperturasNum
                laMovDia(3, lnCntMov) = !nCancelacionesNum
                laMovDia(4, lnCntMov) = !nCancelacionesInacNum
                laMovDia(5, lnCntMov) = !nCuentasVigentes
                laMovDia(6, lnCntMov) = !nDepositosNum
                laMovDia(7, lnCntMov) = !nRetiroNum
                laMovDia(8, lnCntMov) = !nAperturasMonto
                laMovDia(9, lnCntMov) = !nCancelacionesMonto
                laMovDia(10, lnCntMov) = !nCancelacionesInacMonto
                laMovDia(11, lnCntMov) = !nDepositosMonto
                laMovDia(12, lnCntMov) = !nRetiroMonto + !nRetiroIntacMon
                laMovDia(13, lnCntMov) = !nInteresCapitalizados
                laMovDia(14, lnCntMov) = (!nSaldo + !nChequeValorizacionMonto + !nChequeCMAC)
                laMovDia(15, lnCntMov) = (!nITF)
                
                lnTotA02 = lnTotA02 + !nAperturasNum
                lnTotA03 = lnTotA03 + !nCancelacionesNum
                lnTotA04 = lnTotA04 + !nCancelacionesInacNum
                lnTotA05 = lnTotA05 + !nCuentasVigentes
                lnTotA06 = lnTotA06 + !nDepositosNum
                lnTotA07 = lnTotA07 + !nRetiroNum
                lnTotA08 = lnTotA08 + !nAperturasMonto
                lnTotA09 = lnTotA09 + !nCancelacionesMonto
                lnTotA10 = lnTotA10 + !nCancelacionesInacMonto
                lnTotA11 = lnTotA11 + !nDepositosMonto
                lnTotA12 = lnTotA12 + !nRetiroMonto + !nRetiroIntacMon
                lnTotA13 = lnTotA13 + !nInteresCapitalizados
                lnTotA15 = lnTotA15 + !nITF
                laMovDia(14, lnCntMov) = !nSaldo
           End With
           End If
           ldFchIni = DateAdd("d", 1, ldFchPro)
        Loop
        PrvEDAC pnMoneda
        
        LlenaEDAC = lsRTFDat
End Function

Public Function PrvEDAC(pnMoneda As Integer)
    Dim lnCarLin As Integer, i As Integer
    Dim lnCabece As Integer
    Dim lsTitRep As String, lsCabe01 As String, lsCabe02 As String
    Dim lnCntArr As Integer
    Dim lsMoneda As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    Dim lsAgencia As String
    If lsAgeCod = "" Then
        lsAgencia = ""
    Else
        lsAgencia = " Agencia '" & lsAgeCod & "'"
    End If
    
    lnCabece = 0
    lnCarLin = 146
    lsMoneda = IIf(pnMoneda = 1, "SOLES", "DOLARES")
    
    '   Definición de Cabecera 1
        lsCabe01 = UCase(Trim(lsNomAge)) & " - " & lsMoneda
        lsCabe01 = lsCabe01 & Space((lnCarLin - 34) - Len(lsCabe01))
        lsCabe01 = lsCabe01 & "PAGINA: " & ofunc.FillNum(Trim(Str(Printer.pAge)), 4, " ")
        lsCabe01 = lsCabe01 & Space(5) & "FECHA: " & Format(ldFecSis, ofunf.gsFormatoFechaView)
    '   Definición de Cabecera 2
        lsCabe02 = "SECCION AHORRO"
        lsCabe02 = lsCabe02 & Space((lnCarLin - 17) - Len(lsCabe02))
        lsCabe02 = lsCabe02 & "HORA :   " & Format(Now(), "hh:mm:ss")
    '   Definición del Titulo del Reporte
        If lsAgeCod = "" Then
            lsTitRep = "MOVIMIENTO DIARIO DE AHORRO CORRIENTE CONSOLIDADO"
        Else
            lsTitRep = "MOVIMIENTO DIARIO DE AHORRO CORRIENTE - AGENCIA " & lsAgeCod
        End If
        lsTitRep = String(Int((lnCarLin - Len(lsTitRep)) / 2), " ") & lsTitRep
    
    lsRTFDat = lsCabe01 & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & lsCabe02 & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & UCase(lsTitRep) & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & "    M O V I M I E N T O S" & Space(27) & "M   O   N   T   O   S" & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & "  FECHAS   "
    lsRTFDat = lsRTFDat & "APERT "
    lsRTFDat = lsRTFDat & "CANCE "
    lsRTFDat = lsRTFDat & "C.INA "
    lsRTFDat = lsRTFDat & "VIGEN "
    lsRTFDat = lsRTFDat & "DEPOS "
    lsRTFDat = lsRTFDat & "RETIR "
    lsRTFDat = lsRTFDat & "  APERTURAS "
    lsRTFDat = lsRTFDat & "   CANCELAC "
    lsRTFDat = lsRTFDat & " CANC.INACT "
    lsRTFDat = lsRTFDat & "    DEPOSITOS "
    lsRTFDat = lsRTFDat & "      RETIROS "
    lsRTFDat = lsRTFDat & "   INT.CAP. "
    lsRTFDat = lsRTFDat & "   ITF. "
    lsRTFDat = lsRTFDat & "   SALDO A.C." & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea           ' hasta 160 caracteres x línea
            
'       Línea de Impresión
    lnCntArr = UBound(laMovDia, 2)
    For i = 1 To lnCntArr
        lsRTFDat = lsRTFDat & laMovDia(1, i) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(2, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(3, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(4, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(5, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(6, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(7, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(8, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(9, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(10, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(11, i), 13, True, 10, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(12, i), 13, True, 10, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(13, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(15, i), 8, True, 6, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(14, i), 13, True, 10, 2) & oImp.gPrnSaltoLinea  '  Format(laMovDia(14, I), "@@@@@@@@@@@@") & oImp.gPrnSaltoLinea
        lnTotA05 = laMovDia(5, i)
    Next i
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
    lsRTFDat = lsRTFDat & "  TOTAL    "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA02), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA03), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA04), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA05), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA06), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA07), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA08), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA09), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA10), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA11), 13, True, 10, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA12), 13, True, 10, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA13), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA14), 6, True, 8, 2) & oImp.gPrnSaltoLinea  '   " "
        lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
    lsRTFDat = lsRTFDat & "PROMEDIO " & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & "DIARIO     "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA02 / lnCntArr), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA03 / lnCntArr), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA04 / lnCntArr), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA05), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA06 / lnCntArr), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA07 / lnCntArr), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA08 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA09 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA10 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA11 / lnCntArr), 13, True, 10, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA12 / lnCntArr), 13, True, 10, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA13 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA15 / lnCntArr), 6, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA14 / lnCntArr), 13, True, 10, 2) & Chr(10)
    lsRTFDat = lsRTFDat & String(lnCarLin, "=") & Chr(10) & Chr(12)              ' hasta 160 caracteres x línea
    Set ofunc = Nothing
End Function

Public Function LlenaEDPF(pnMoneda As Integer, pdFchPr1 As String, Optional pdFchPr2 As String) As String

    Dim rsQryEAC As New ADODB.Recordset
    Dim lsQryEAC As String
    Dim ldFchIni As Date, ldFchFin As Date
    Dim lnCntMov As Integer
    Dim ldFchPro As Date
    Dim lbCieMes As Boolean
    
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And cCodAge = '" & lsAgeCod & "'"
    End If
    
    oCon.AbreConexion
    
    ldFchIni = CDate(pdFchPr1)
    ldFchFin = CDate(pdFchPr2)
    ReDim laMovDia(1 To 11, 1 To 1)
        lnTotA02 = 0: lnTotA03 = 0: lnTotA04 = 0: lnTotA05 = 0
        lnTotA06 = 0: lnTotA07 = 0: lnTotA08 = 0: lnTotA09 = 0
        lnTotA10 = 0: lnTotA11 = 0
        
        lnCntMov = 0
        
        Do While ldFchIni <= ldFchFin
        
           lnCntMov = lnCntMov + 1
           ReDim Preserve laMovDia(1 To 11, 1 To lnCntMov)
           
           ldFchPro = ldFchIni
           
           'sQryEAC = " Select cCodAge, Convert(Varchar(8),dEstad,112) cUltimoMovimiento, nMoneda, nNumAper nAperturasNum, nNumCanc nCancelacionesNum," _
                    & " nMonAper nAperturasMonto, nMonCanc nCancelacionesMonto, nRetInt nMovimientosMonto, nRetInac nRetiroIntacMon," _
                    & " nNumCancInac nCancelacionesInacNum, nMonCancInac, nNumDep nDepositosNum, nMonDep nDepositosMonto," _
                    & " nNumRet nRetiroNum, nMonRet nRetiroMonto, nIntCap nIntnteresCapitalizado, Dia.nSaldo, DiaAnt.nSaldo nSaldoAnterior, " _
                    & " nMonChq nChequeValorizacionMonto, cUsuario, (Select sum(nNumCtas) From CapEstadSaldo DiaSaldo where nProducto =  '" & Producto.gCapPlazoFijo & "' And nMoneda = " & Trim(Str(pnMoneda)) & " And Convert(Varchar(8),Dia.dEstad,112) = Convert(Varchar(8),DiaSaldo.dEstad,112) ) nCuentasVigentes," _
                    & " DiaSaldoCMAC.nSaldo nSaldoCMAC, DiaSaldoCMAC.nMonChqVal nChequeCMAC" _
                    & " From CapEstadMovimiento Dia" _
                    & " Inner Join" _
                    & " (Select Convert(Varchar(8),DateAdd(Day,1,dEstad),112) Fecha, nSaldo From CapEstadMovimiento" _
                    & " Where nProducto = '" & Producto.gCapPlazoFijo & "' And nMoneda =  " & Trim(Str(pnMoneda)) & "  " & sqlAdd & ") As DiaAnt On DiaAnt.Fecha = Convert(Varchar(8),dEstad,112)" _
                    & " Inner Join" _
                    & " ( Select  nSaldo , nMonChqVal, Convert(Varchar(8),DateAdd(Day,1,dEstad),112) Fecha" _
                    & "     From CapEstadSaldo where nProducto = '" & Producto.gCapPlazoFijo & "' And nMoneda =  " & Trim(Str(pnMoneda)) & " And nPersoneria = " & PersPersoneria.gPersonaJurCFLCMAC & " " & sqlAdd & ") As DiaSaldoCMAC" _
                    & "      On DiaSaldoCMAC.Fecha = Convert(Varchar(8),dEstad,112)" _
                    & "  Where nProducto = '" & Producto.gCapPlazoFijo & "' And nMoneda = " & Trim(Str(pnMoneda)) & " And dEstad Between '" & Format(CDate(ldFchPro), oFunF.gsFormatoFecha) & "' AND '" & Format(CDate(ldFchPro) + 1, oFunF.gsFormatoFecha) & "' " & sqlAdd
           
           lsQryEAC = " Select Convert(Varchar(8),dEstad,112) cUltimoMovimiento, Sum(nNumAper) nAperturasNum, Sum(nNumCanc) nCancelacionesNum," _
                    & " Sum(nMonAper) nAperturasMonto, Sum(nMonCanc) nCancelacionesMonto, Sum(nRetInt) nMovimientosMonto,  Sum(nRetInac) nRetiroIntacMon," _
                    & " Sum(nNumCancInac) nCancelacionesInacNum, Sum(nMonCancInac) nCancelacionesInacMonto, Sum(nNumDep) nDepositosNum, Sum(nMonDep) nDepositosMonto," _
                    & " Sum(nNumRet) nRetiroNum, Sum(nMonRet) nRetiroMonto, Sum(nIntCap) nInteresCapitalizados, Sum(Dia.nSaldo) nSaldo, Sum(DiaAnt.nSaldo) nSaldoAnterior," _
                    & " Sum(nMonChq) nChequeValorizacionMonto, Sum(NumCtas.NumCta) nCuentasVigentes," _
                    & " Sum(DiaSaldoCMAC.nSaldo) nSaldoCMAC, Sum(DiaSaldoCMAC.nMonChqVal) nChequeCMAC, SUM(nItf) as nItf " _
                    & " From CapEstadMovimiento Dia" _
                    & " Left Join" _
                    & " (Select Convert(Varchar(8),DateAdd(Day,1,dEstad),112) Fecha, Sum(nSaldo) nSaldo From CapEstadMovimiento" _
                    & " Where nProducto = '" & Producto.gCapPlazoFijo & "' And nMoneda = " & Trim(Str(pnMoneda)) & " " & sqlAdd & " Group By Convert(Varchar(8),DateAdd(Day,1,dEstad),112)) As DiaAnt On DiaAnt.Fecha = Convert(Varchar(8),dEstad,112)" _
                    & " Inner Join" _
                    & " ( Select  Sum(nSaldo) nSaldo, Sum(nMonChqVal) nMonChqVal, Convert(Varchar(8),dEstad,112) Fecha"
                    
            'lsQryEAC = lsQryEAC & "     From CapEstadSaldo where nProducto = '" & Producto.gCapPlazoFijo & "' And nMoneda = " & Trim(Str(pnMoneda)) & " And nPersoneria = " & PersPersoneria.gPersonaJurCFLCMAC & " " & sqlAdd & " Group By Convert(Varchar(8),dEstad,112)) As DiaSaldoCMAC"
            lsQryEAC = lsQryEAC & "     From CapEstadSaldo where nProducto = '" & Producto.gCapPlazoFijo & "' And nMoneda = " & Trim(Str(pnMoneda)) & " " & sqlAdd & " Group By Convert(Varchar(8),dEstad,112)) As DiaSaldoCMAC"
            
            lsQryEAC = lsQryEAC & "         On DiaSaldoCMAC.Fecha = Convert(Varchar(8),dEstad,112)" _
                    & " Inner Join " _
                    & " (  Select sum(nNumCtas) NumCta, cCodAge cCodAgeC, Convert(Varchar(8),dEstad,112) Fecha " _
                    & "    From CapEstadSaldo DiaSaldo where nProducto = '" & Producto.gCapPlazoFijo & "' And nMoneda = " & Trim(Str(pnMoneda)) & " " & sqlAdd & "  GroUp By Convert(Varchar(8),dEstad,112), cCodAge ) As NumCtas On NumCtas.Fecha = Convert(Varchar(8),Dia.dEstad,112) And Dia.cCodAge = NumCtas.cCodAgeC " _
                    & "  Where nProducto = '" & Producto.gCapPlazoFijo & "' And nMoneda = " & Trim(Str(pnMoneda)) & " And dEstad Between '" & Format(CDate(ldFchPro), ofunf.gsFormatoFecha) & "' AND '" & Format(CDate(ldFchPro) + 1, ofunf.gsFormatoFecha) & "' " & sqlAdd & " Group By  Convert(Varchar(8),dEstad,112)"
           
           
           If rsQryEAC.State = adStateOpen Then rsQryEAC.Close
           
           Set rsQryEAC = oCon.CargaRecordSet(lsQryEAC)
       
           If (rsQryEAC.EOF) Then
              rsQryEAC.Close
              Set rsQryEAC = Nothing
              LlenaEDPF = ""
              laMovDia(1, lnCntMov) = Format(ldFchPro, ofunf.gsFormatoFechaView)
              For i = 2 To 11
                  laMovDia(i, lnCntMov) = 0
              Next i
           Else
           
           With rsQryEAC
                           
                laMovDia(1, lnCntMov) = Mid(!cUltimoMovimiento, 7, 2) & "/" & Mid(!cUltimoMovimiento, 5, 2) & "/" & Left(!cUltimoMovimiento, 4)
                laMovDia(2, lnCntMov) = !nAperturasNum
                laMovDia(3, lnCntMov) = !nCancelacionesNum
                laMovDia(4, lnCntMov) = !nRetiroNum
                laMovDia(5, lnCntMov) = !nCuentasVigentes
                laMovDia(6, lnCntMov) = !nAperturasMonto
                laMovDia(7, lnCntMov) = !nCancelacionesMonto
                laMovDia(8, lnCntMov) = !nMovimientosMonto
                laMovDia(9, lnCntMov) = !nInteresCapitalizados
                laMovDia(10, lnCntMov) = !nSaldo
                laMovDia(11, lnCntMov) = 0
                
                lnTotA02 = lnTotA02 + !nAperturasNum
                lnTotA03 = lnTotA03 + !nCancelacionesNum
                lnTotA04 = lnTotA04 + !nRetiroNum
                lnTotA05 = lnTotA05 + !nCuentasVigentes
                lnTotA06 = lnTotA06 + !nAperturasMonto
                lnTotA07 = lnTotA07 + !nCancelacionesMonto
                lnTotA08 = lnTotA08 + !nMovimientosMonto
                lnTotA09 = lnTotA09 + !nInteresCapitalizados
                lnTotA10 = lnTotA10 + !nSaldo
                lnTotA11 = 0
           End With
           End If
           ldFchIni = DateAdd("d", 1, ldFchPro)
        Loop
        
        If CierreRealizado(2) Then
           lbCieMes = True
        Else
           lbCieMes = False
        End If
        
        If lbCieMes Then
           lsQryEAC = "SELECT SUM(ABS(nIntAcum)) AS nIntDev FROM Captaciones CA Inner Join Producto PR ON CA.cCtaCod = PR.cCtaCod " _
                    & "WHERE SUBSTRING(CA.cCtaCod,9,1) = '" & Trim(Str(pnMoneda)) & "' AND Left(nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "', '" & Left(CaptacEstado.gCapEstCancelada, 2) & "') And Substring(CA.cCtaCod,6,3) = '233' "
           
           If rsQryEAC.State = adStateOpen Then rsQryEAC.Close
           Set rsQryEAC = oCon.CargaRecordSet(lsQryEAC)
        
           If rsQryEAC.EOF Then
              laMovDia(11, lnCntMov) = 0
              lnTotA11 = 0
           Else
              laMovDia(11, lnCntMov) = IIf(IsNull(rsQryEAC!nIntDev), 0, rsQryEAC!nIntDev)
              lnTotA11 = IIf(IsNull(rsQryEAC!nIntDev), 0, rsQryEAC!nIntDev)
           End If
        End If
        
        PrvEDPF pnMoneda
        LlenaEDPF = lsRTFDat
End Function

Public Function PrvEDPF(pnMoneda As Integer)
    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRep As String, lsCabe01 As String, lsCabe02 As String
    Dim lnCabece As Integer
    Dim lnCntArr As Integer
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    Dim lsAgencia As String
    If lsAgeCod = "" Then
        lsAgencia = ""
    Else
        lsAgencia = " Agencia '" & lsAgeCod & "'"
    End If
    
    lnCabece = 0
    lnCarLin = 110
    lsMoneda = IIf(pnMoneda = 1, "SOLES", "DOLARES")
    
    '   Definición de Cabecera 1
        lsCabe01 = UCase(Trim(lsNomAge)) & " - " & lsMoneda
        lsCabe01 = lsCabe01 & Space((lnCarLin - 34) - Len(lsCabe01))
        lsCabe01 = lsCabe01 & "PAGINA: " & ofunc.FillNum(Trim(Str(Printer.pAge)), 4, " ")
        lsCabe01 = lsCabe01 & Space(5) & "FECHA: " & Format(ldFecSis, ofunf.gsFormatoFechaView)
    '   Definición de Cabecera 2
        lsCabe02 = "SECCION AHORRO"
        lsCabe02 = lsCabe02 & Space((lnCarLin - 17) - Len(lsCabe02))
        lsCabe02 = lsCabe02 & "HORA :   " & Format(Now(), "hh:mm:ss")
    '   Definición del Titulo del Reporte
        If lsAgeCod = "" Then
            lsTitRep = "MOVIMIENTO DIARIO DE PLAZO FIJO CONSOLIDADO"
        Else
            lsTitRep = "MOVIMIENTO DIARIO DE PLAZO FIJO - AGENCIA " & lsAgeCod
        End If
        lsTitRep = String(Int((lnCarLin - Len(lsTitRep)) / 2), " ") & lsTitRep
    
    lsRTFDat = lsCabe01 & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & lsCabe02 & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & UCase(lsTitRep) & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & "       M O V I M I E N T O S" & Space(21) & "M   O   N   T   O   S" & String(16, " ")
    lsRTFDat = lsRTFDat & "  SALDOS PF " & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & "  FECHAS   "
    lsRTFDat = lsRTFDat & "APERT "
    lsRTFDat = lsRTFDat & "CANCE "
    lsRTFDat = lsRTFDat & "MOVIM "
    lsRTFDat = lsRTFDat & "VIGEN "
    lsRTFDat = lsRTFDat & "  APERTURAS "
    lsRTFDat = lsRTFDat & "   CANCELAC "
    lsRTFDat = lsRTFDat & " MOVIMIENTO "
    lsRTFDat = lsRTFDat & "   INT.CAP. "
    lsRTFDat = lsRTFDat & "      CAPITAL "
    lsRTFDat = lsRTFDat & "  INT.DEVENG." & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea           ' hasta 160 caracteres x línea
            
'       Línea de Impresión
    lnCntArr = UBound(laMovDia, 2)
    For i = 1 To lnCntArr
        lsRTFDat = lsRTFDat & laMovDia(1, i) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(2, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(3, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(4, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(5, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(6, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(7, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(8, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(9, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(10, i), 13, True, 10, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(11, i), 13, True, 10, 2) & oImp.gPrnSaltoLinea
        lnTotA05 = laMovDia(5, i)
    Next i
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
    lsRTFDat = lsRTFDat & "  TOTAL    "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA02), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA03), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA04), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA05), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA06), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA07), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA08), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA09), 11, True, 8, 2) & oImp.gPrnSaltoLinea
'    lsRTFDat = lsRTFDat & oFunC.JDNum(lnTotA10, 12, True) & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
    lsRTFDat = lsRTFDat & "PROMEDIO " & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & "DIARIO     "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA02 / lnCntArr), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA03 / lnCntArr), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA04 / lnCntArr), 5, False, 5, 0) & " "
'    lsRTFDat = lsRTFDat & oFunC.JDNum(Int(lnTotA05 / lnCntArr), 4, False, 4, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Int(lnTotA05), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA06 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA07 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA08 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA09 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA10 / lnCntArr), 13, True, 10, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA11 / lnCntArr), 13, True, 10, 2) & Chr(10)
    lsRTFDat = lsRTFDat & String(lnCarLin, "=") & oImp.gPrnSaltoLinea & Chr(12)              ' hasta 160 caracteres x línea
    Set ofunc = Nothing
End Function

Public Function LlenaEDCTS(pnMoneda As Integer, pdFchPr1 As String, Optional pdFchPr2 As String) As String
    
    Dim rsQryEAC As New ADODB.Recordset
    Dim lsQryEAC As String
    Dim ldFchIni As Date, ldFchFin As Date
    Dim lnCntMov As Integer
    Dim ldFchPro As Date
    Dim lbCieMes As Boolean
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    ldFchIni = CDate(pdFchPr1)
    ldFchFin = CDate(pdFchPr2)
    
    oCon.AbreConexion
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And cCodAge = '" & lsAgeCod & "'"
    End If
    
    ReDim laMovDia(1 To 14, 1 To 1)
    
        lnTotA02 = 0: lnTotA03 = 0: lnTotA04 = 0: lnTotA05 = 0
        lnTotA06 = 0: lnTotA07 = 0: lnTotA08 = 0: lnTotA09 = 0
        lnTotA10 = 0: lnTotA11 = 0: lnTotA12 = 0: lnTotA13 = 0
        lnTotA14 = 0
        lnCntMov = 0
        
        Do While ldFchIni <= ldFchFin
        
           lnCntMov = lnCntMov + 1
           ReDim Preserve laMovDia(1 To 14, 1 To lnCntMov)
           
           ldFchPro = ldFchIni
           
           lsQryEAC = " SELECT cUltimoMovimiento,nMoneda,nAperturasNum,nAperturasMonto,nCancelacionesNum,nCancelacionesMonto,nRetiroNum,nRetiroMonto,nRetiroIntCTS,nDepositosNum,nDepositosMonto,nCuentasVigentes,nInteresCapitalizado,nSaldoCTS,nSaldEmp,nChequeMonto,nChequeValorizacionMonto,nChequevalorizacionNum FROM Estadisticacts" _
                    & " WHERE nMoneda = '" & Trim(Str(pnMoneda)) & "' AND cUltimoMovimiento BETWEEN '" & Format(CDate(ldFchPro), "yyyymmdd") & "' AND '" & Format(CDate(ldFchPro) + 1, "yyyymmdd") & "' AND Substring(cUltimoMovimiento,18,2) = '" & lsAgeCod & "' Order by cUltimoMovimiento "
           
           
           lsQryEAC = " Select Convert(Varchar(8),dEstad,112) cUltimoMovimiento, Sum(nNumAper) nAperturasNum, Sum(nNumCanc) nCancelacionesNum," _
                    & " Sum(nMonAper) nAperturasMonto, Sum(nMonCanc) nCancelacionesMonto, Sum(nRetInt) nRetInt,  Sum(nRetInac) nRetiroIntacMon," _
                    & " Sum(nNumCancInac) nCancelacionesInacNum, Sum(nMonCancInac) nCancelacionesInacMonto, Sum(nNumDep) nDepositosNum, Sum(nMonDep) nDepositosMonto," _
                    & " Sum(nNumRet) nRetiroNum, Sum(nMonRet) nRetiroMonto, Sum(nIntCap) nInteresCapitalizados, Sum(Dia.nSaldo) nSaldo, Sum(DiaAnt.nSaldo) nSaldoAnterior," _
                    & " Sum(nMonChq) nChequeValorizacionMonto, Sum(NumCtas.NumCta) nCuentasVigentes," _
                    & " Sum(DiaSaldoCMAC.nSaldo) nSaldoCMAC, Sum(DiaSaldoCMAC.nMonChqVal) nChequeCMAC, Sum(NumCtas.SaldoEmp) SaldoEmp" _
                    & " From CapEstadMovimiento Dia" _
                    & " Left Join" _
                    & " (Select Convert(Varchar(8),DateAdd(Day,1,dEstad),112) Fecha, Sum(nSaldo) nSaldo From CapEstadMovimiento" _
                    & " Where nProducto = '" & Producto.gCapCTS & "' And nMoneda = " & Trim(Str(pnMoneda)) & " " & sqlAdd & " Group By Convert(Varchar(8),DateAdd(Day,1,dEstad),112)) As DiaAnt On DiaAnt.Fecha = Convert(Varchar(8),dEstad,112)" _
                    & " Left Join" _
                    & " ( Select  Sum(nSaldo) nSaldo, Sum(nMonChqVal) nMonChqVal, Convert(Varchar(8),dEstad,112) Fecha"
                    
            'lsQryEAC = lsQryEAC & "     From CapEstadSaldo where nProducto = '" & Producto.gCapCTS & "' And nMoneda = " & Trim(Str(pnMoneda)) & " And nPersoneria = " & PersPersoneria.gPersonaJurCFLCMAC & " " & sqlAdd & " Group By Convert(Varchar(8),dEstad,112)) As DiaSaldoCMAC"
            lsQryEAC = lsQryEAC & "     From CapEstadSaldo where nProducto = '" & Producto.gCapCTS & "' And nMoneda = " & Trim(Str(pnMoneda)) & " " & sqlAdd & " Group By Convert(Varchar(8),dEstad,112)) As DiaSaldoCMAC"
            
            lsQryEAC = lsQryEAC & "         On DiaSaldoCMAC.Fecha = Convert(Varchar(8),dEstad,112)" _
                    & " Inner Join " _
                    & " ( Select sum(nNumCtas) NumCta, sum(nSaldoInactEmp) SaldoEmp, cCodAge cCodAgeC, Convert(Varchar(8),dEstad,112) Fecha " _
                    & "   From CapEstadSaldo DiaSaldo where nProducto = '" & Producto.gCapCTS & "' And nMoneda = " & Trim(Str(pnMoneda)) & " " & sqlAdd & "  GroUp By Convert(Varchar(8),dEstad,112), cCodAge ) As NumCtas On NumCtas.Fecha = Convert(Varchar(8),Dia.dEstad,112) And Dia.cCodAge = NumCtas.cCodAgeC " _
                    & "   Where nProducto = '" & Producto.gCapCTS & "' And nMoneda = " & Trim(Str(pnMoneda)) & " And dEstad Between '" & Format(CDate(ldFchPro), ofunf.gsFormatoFecha) & "' AND '" & Format(CDate(ldFchPro) + 1, ofunf.gsFormatoFecha) & "' " & sqlAdd & " Group By  Convert(Varchar(8),dEstad,112)"
           
           
           If rsQryEAC.State = adStateOpen Then rsQryEAC.Close
           
           Set rsQryEAC = oCon.CargaRecordSet(lsQryEAC)
       
           If rsQryEAC.EOF Then
              rsQryEAC.Close
              Set rsQryEAC = Nothing
              LlenaEDCTS = ""
              laMovDia(1, lnCntMov) = Format(ldFchPro, ofunf.gsFormatoFechaView)
              For i = 2 To 14
                  laMovDia(i, lnCntMov) = 0
              Next i
'              Exit Function
           Else
           
           With rsQryEAC
                           
                laMovDia(1, lnCntMov) = Mid(!cUltimoMovimiento, 7, 2) & "/" & Mid(!cUltimoMovimiento, 5, 2) & "/" & Left(!cUltimoMovimiento, 4)
                laMovDia(2, lnCntMov) = !nAperturasNum
                laMovDia(3, lnCntMov) = !nCancelacionesNum
                laMovDia(4, lnCntMov) = !nCuentasVigentes
                laMovDia(5, lnCntMov) = !nDepositosNum
                laMovDia(6, lnCntMov) = !nRetiroNum
                laMovDia(7, lnCntMov) = !nAperturasMonto
                laMovDia(8, lnCntMov) = !nCancelacionesMonto
                laMovDia(9, lnCntMov) = !nDepositosMonto
                laMovDia(10, lnCntMov) = !nRetiroMonto
                laMovDia(11, lnCntMov) = !nInteresCapitalizados
                laMovDia(12, lnCntMov) = !nSaldo
                laMovDia(13, lnCntMov) = !SaldoEmp
                laMovDia(14, lnCntMov) = 0
                
                lnTotA02 = lnTotA02 + !nAperturasNum
                lnTotA03 = lnTotA03 + !nCancelacionesNum
                lnTotA04 = lnTotA04 + !nCuentasVigentes
                lnTotA05 = lnTotA05 + !nDepositosNum
                lnTotA06 = lnTotA06 + !nRetiroNum
                lnTotA07 = lnTotA07 + !nAperturasMonto
                lnTotA08 = lnTotA08 + !nCancelacionesMonto
                lnTotA09 = lnTotA09 + !nDepositosMonto
                lnTotA10 = lnTotA10 + !nRetiroMonto
                lnTotA11 = lnTotA11 + !nInteresCapitalizados
                lnTotA12 = lnTotA12 + !nSaldo
                lnTotA13 = lnTotA13 + !SaldoEmp
                lnTotA14 = 0
                
           End With
           End If
           ldFchIni = DateAdd("d", 1, ldFchPro)
        Loop

        If CierreRealizado(2) Then
           lbCieMes = True
        Else
           lbCieMes = False
        End If
        
        If lbCieMes Then
            ldFchIni = CDate(pdFchPr1)
            ldFchFin = CDate(pdFchPr2)
            lsQryEAC = " SELECT SUM(ABS(nMonTran)) AS nMonPro FROM TransAho " _
                     & " WHERE  cCodOpe = '" & 333 & "' AND (cFlag IS NULL OR cFlag <> 'X') " _
                     & " and    substring(cCodCta,6,1) = '" & Trim(Str(pnMoneda)) & "' " _
                     & " AND    (dFecTran BETWEEN '" & Format(ldFchIni, ofunf.gsFormatoFecha) & "' AND '" & Format(DateAdd("d", 1, ldFchFin), ofunf.gsFormatoFecha) & "') "
           
           'rsQryEAC.Open lsQryEAC, dbCmact, adOpenForwardOnly, adLockOptimistic, adCmdText
           If rsQryEAC.State = adStateOpen Then rsQryEAC.Close
           Set rsQryEAC = oCon.CargaRecordSet(lsQryEAC)
           
           If rsQryEAC.EOF Then
              laMovDia(14, lnCntMov) = 0
              lnTotA14 = 0
           Else
              laMovDia(14, lnCntMov) = IIf(IsNull(rsQryEAC!nMonPro), 0, rsQryEAC!nMonPro)
              lnTotA14 = IIf(IsNull(rsQryEAC!nMonPro), 0, rsQryEAC!nMonPro)
           End If
        End If
        
        PrvEDCTS pnMoneda
        LlenaEDCTS = lsRTFDat

       
End Function

Public Function PrvEDCTS(pnMoneda As Integer)
    
    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRep As String, lsCabe01 As String, lsCabe02 As String
    Dim lnCabece As Integer
    Dim lnCntArr As Integer
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    Dim lsAgencia As String
    If lsAgeCod = "" Then
        lsAgencia = ""
    Else
        lsAgencia = " Agencia '" & lsAgeCod & "'"
    End If
    
    lnCabece = 0
    lnCarLin = 142
    lsMoneda = IIf(pnMoneda = 1, "SOLES", "DOLARES")
    
    '   Definición de Cabecera 1
        lsCabe01 = UCase(Trim(lsNomAge)) & " - " & lsMoneda
        lsCabe01 = lsCabe01 & Space((lnCarLin - 34) - Len(lsCabe01))
        lsCabe01 = lsCabe01 & "PAGINA: " & ofunc.FillNum(Trim(Str(Printer.pAge)), 4, " ")
        lsCabe01 = lsCabe01 & Space(5) & "FECHA: " & Format(ldFecSis, ofunf.gsFormatoFechaView)
    '   Definición de Cabecera 2
        lsCabe02 = "SECCION AHORRO"
        lsCabe02 = lsCabe02 & Space((lnCarLin - 17) - Len(lsCabe02))
        lsCabe02 = lsCabe02 & "HORA :   " & Format(Now(), "hh:mm:ss")
    '   Definición del Titulo del Reporte
        If lsAgeCod = "" Then
            lsTitRep = "MOVIMIENTO DIARIO DE C T S - CONSOLIDADO"
        Else
            lsTitRep = "MOVIMIENTO DIARIO DE C T S - AGENCIA " & lsAgeCod
        End If
        lsTitRep = String(Int((lnCarLin - Len(lsTitRep)) / 2), " ") & lsTitRep
    
    lsRTFDat = lsCabe01 & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & lsCabe02 & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & UCase(lsTitRep) & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & "    M O V I M I E N T O S" & Space(27) & "M   O   N   T   O   S" & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & "  FECHAS   "
    lsRTFDat = lsRTFDat & "APERT "
    lsRTFDat = lsRTFDat & "CANCE "
    lsRTFDat = lsRTFDat & "VIGEN "
    lsRTFDat = lsRTFDat & "DEPOS "
    lsRTFDat = lsRTFDat & "RETIR "
    lsRTFDat = lsRTFDat & "  APERTURAS "
    lsRTFDat = lsRTFDat & "   CANCELAC "
    lsRTFDat = lsRTFDat & "  DEPOSITOS "
    lsRTFDat = lsRTFDat & "    RETIROS "
    lsRTFDat = lsRTFDat & "   INT.CAP. "
    lsRTFDat = lsRTFDat & "    SALDO CTS"
    lsRTFDat = lsRTFDat & "  SALDO EMPLEA"
    lsRTFDat = lsRTFDat & "   PROVISIONES" & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea           ' hasta 160 caracteres x línea
            
'       Línea de Impresión
    lnCntArr = UBound(laMovDia, 2)
    For i = 1 To lnCntArr
        lsRTFDat = lsRTFDat & laMovDia(1, i) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(2, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(3, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(4, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(5, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(6, i), 5, False, 5, 0) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(7, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(8, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(9, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(10, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(11, i), 11, True, 8, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(12, i), 13, True, 10, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(13, i), 13, True, 10, 2) & " "
        lsRTFDat = lsRTFDat & ofunc.JDNum(laMovDia(14, i), 13, True, 10, 2) & oImp.gPrnSaltoLinea  '  Format(laMovDia(14, I), "@@@@@@@@@@@@") & oImp.gPrnSaltoLinea
        lnTotA05 = laMovDia(5, i)
    Next i
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
    lsRTFDat = lsRTFDat & "  TOTAL    "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA02), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA03), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA04), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA05), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA06), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA07), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA08), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA09), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA10), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum(Str(lnTotA11), 11, True, 8, 2) & oImp.gPrnSaltoLinea
'    lsRTFDat = lsRTFDat & Format(Format(lnTotA13, "###,##0.00"), "@@@@@@@@@@") & oImp.gPrnSaltoLinea  '   " "
'    lsRTFDat = lsRTFDat & Format(Format(lnTotA14, "#,###,##0.00"), "@@@@@@@@@@@@") & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
    lsRTFDat = lsRTFDat & "PROMEDIO " & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & "DIARIO     "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA02 / lnCntArr), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA03 / lnCntArr), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA04 / lnCntArr), 5, False, 5, 0) & " "
'    lsRTFDat = lsRTFDat & oFunC.JDNum((lnTotA05 / lnCntArr),4, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA05), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA06 / lnCntArr), 5, False, 5, 0) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA07 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA08 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA09 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA10 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA11 / lnCntArr), 11, True, 8, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA12 / lnCntArr), 13, True, 10, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA13 / lnCntArr), 13, True, 10, 2) & " "
    lsRTFDat = lsRTFDat & ofunc.JDNum((lnTotA14 / lnCntArr), 13, True, 10, 2) & oImp.gPrnSaltoLinea
    lsRTFDat = lsRTFDat & String(lnCarLin, "=") & oImp.gPrnSaltoLinea & Chr(12)             ' hasta 160 caracteres x línea
    Set ofunc = Nothing
End Function


Public Function GenSdosFM(psTipAho As Producto, psTipPer As PersPersoneria, psTipMon As Moneda, _
                             psFchPro As String, Optional pbCtaIna As Byte = 0, _
                             Optional psCodIns As String = "") As String
    Dim lsQrySdo As String
    Dim rsQrySdo As ADODB.Recordset
    Set rsQrySdo = New ADODB.Recordset
    Dim lsInstit As String
    Dim lsMoneda As String
    Dim lsPerson As String
    Dim lsTipAho As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    
    Dim sqlAdd As String
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And PR.cCtaCod Like '___" & lsAgeCod & "%'"
    End If
    
    oCon.AbreConexion
    
    lsRTFRfm = ""
    
    lsMoneda = IIf(psTipMon = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    
    Select Case psTipPer
        Case PersPersoneria.gPersonaNat
             lsPerson = "PERSONA(S)  NATURAL(ES)" & IIf(psTipAho = Producto.gCapAhorros, IIf(pbCtaIna = 0, "  -  ACTIVA", "  -  INACTIVA"), "")
        Case PersPersoneria.gPersonaJurSFL
             lsPerson = "PERSONA(S)  JURIDICA(S)  SIN  FINES  DE  LUCRO" & IIf(psTipAho = Producto.gCapAhorros, IIf(pbCtaIna = 0, "  -  ACTIVA", "  -  INACTIVA"), "")
        Case PersPersoneria.gPersonaJurCFL
             lsPerson = "PERSONA(S)  JURIDICA(S)  CON  FINES  DE  LUCRO" & IIf(psTipAho = Producto.gCapAhorros, IIf(pbCtaIna = 0, "  -  ACTIVA", "  -  INACTIVA"), "")
        Case PersPersoneria.gPersonaJurCFLCMAC
             lsPerson = "PERSONA(S)  CMAC" & IIf(psTipAho = Producto.gCapAhorros, IIf(pbCtaIna = 0, "  -  ACTIVA", "  -  INACTIVA"), "")
        Case PersPersoneria.gPersonaJurCFLCRAC
             lsPerson = "PERSONA(S)  CRAC" & IIf(psTipAho = Producto.gCapAhorros, IIf(pbCtaIna = 0, "  -  ACTIVA", "  -  INACTIVA"), "")
        Case PersPersoneria.gPersonaJurCFLCooperativa
             lsPerson = "PERSONA(S)  COOPERATIVA(S)" & IIf(psTipAho = Producto.gCapAhorros, IIf(pbCtaIna = 0, "  -  ACTIVA", "  -  INACTIVA"), "")
        Case PersPersoneria.gPersonaJurCFLEdpyme
             lsPerson = "PERSONA(S)  EDPYME(S)" & IIf(psTipAho = Producto.gCapAhorros, IIf(pbCtaIna = 0, "  -  ACTIVA", "  -  INACTIVA"), "")
    End Select
        
    lsQrySdo = ""
    Select Case psTipAho
        Case Producto.gCapAhorros
   
             lsTipAho = "A H O R R O S"
             lsQrySdo = " SELECT PR.cCtaCod cCodCta, bOrdPag cOrdPag, CA.nSaldoDisp AS nSdoDis, PR.nSaldo AS nSdoCnt, dbo.GetInteresGanado(PR.cCtaCod,'" & Format(psFchPro, ofunf.gsFormatoFecha) & "','S') As nIntMes, CAA.nSaldoAnterior AS nSdoAnt, CAA.dUltContacto AS dUltMovAC, PE.cPersnombre cNomPers, PP.cPersCod cCodPers FROM Producto PR" _
                      & " INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod" _
                      & " INNER JOIN Persona PE ON Pp.cPersCod = PE.cPersCod" _
                      & " INNER JOIN Captaciones CA ON PR.cCtaCod = CA.cCtaCod" _
                      & " INNER JOIN CaptacAhorros CAA ON PR.cCtaCod = CAA.cCtaCod" _
                      & "" _
                      & " WHERE Left(PR.nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "') AND PE.nPersPersoneria = '" & psTipPer & "'" _
                      & " AND PP.nPrdPersRelac = " & CaptacRelacPersona.gCapRelPersTitular & " AND CAA.bInactiva = " & pbCtaIna & "" _
                      & " AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "' " & sqlAdd & "" _
                      & " ORDER BY AC.cOrdPag, AC.cCodCta"
        Case Producto.gCapPlazoFijo
             lsTipAho = "P L A Z O   F I J O"
             lsQrySdo = " SELECT CA.dApertura dAperPF, DateAdd(day, CAPF.nPlazo, CAPF.dRenovacion) AS dFchVct, CAPF.nPlazo, PR.cCtaCod cCodCta, PE.cPersNombre cNomPers, CA.nSaldoDisp AS nCapital, " _
                      & " CAPF.nIntPag, CA.nIntAcum, CAPF.nApertura, PR.nTasaInteres nTasaIntPF, CAPF.dAuxiliar AS dUltMovPF, PE.cPersCod " _
                      & " FROM Producto PR" _
                      & " Inner Join CaptacPlazoFijo CAPF On PR.cCtaCod = CAPF.cCtaCod INNER JOIN Captaciones CA ON CAPF.cCtaCod = CA.cCtaCod " _
                      & " INNER JOIN ProductoPersona PP ON CAPF.cCtaCod = PP.cCtaCod INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod " _
                      & " WHERE Left(PR.nPrdEstado,2) NOT IN ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "') AND PE.nPersPersoneria = '" & psTipPer & "' " _
                      & " AND PP.nPrdPersRelac = " & CaptacRelacPersona.gCapRelPersTitular & " AND SUBSTRING(CAPF.cCtaCod,9,1) =  '" & psTipMon & "'" _
                      & " AND SUBSTRING(CAPF.cCtaCod,9,1) = '" & psTipMon & "' " & sqlAdd & " " _
                      & " ORDER BY PR.cCtaCod"
        Case Producto.gCapCTS
             lsTipAho = "C T S"
             Select Case psCodIns
                Case gsInstCmac
                     lsPerson = "E M P L E A D O S    C M A C T"
                     lsInstit = "LTRIM(RTRIM(CTS.cCodInst)) = '" & gsInstCmac & "' "
                Case Else
                     lsPerson = "C L I E N T E S    C M A C T"
                     lsInstit = "LTRIM(RTRIM(CTS.cCodInst)) <> '" & gsInstCmac & "' "
             End Select
             lsQrySdo = " SELECT CA.dApertura dAperCTS, PR.cCtaCod cCodCta, CACTS.nSaldRetiro As nSdoDis, PR.nSaldo AS nSdoCnt, " _
                      & " CA.dUltCierre AS dUltMovCTS, 0 As nUltDep, PR.nSaldo As nCapital, dbo.GetInteresGanado(PR.cCtaCod,'" & Format(psFchPro, ofunf.gsFormatoFecha) & "','S') AS nIntMes, PE.cPersNombre cNomPers, PE.cPersCod cCodPers " _
                      & " FROM Producto PR  " _
                      & " INNER JOIN Captaciones CA ON CA.cCtaCod = PR.cCtaCod  INNER JOIN CaptacCTS CACTS ON CACTS.cCtaCod = PR.cCtaCod" _
                      & " INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod  INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod" _
                      & " WHERE Left(PR.nPRDEstado,2) NOT IN ('13','14') AND LTRIM(RTRIM(CACTS.cCodInst)) = '" & lsInstit & "'" _
                      & " AND PP.nPrdPersRelac = " & CaptacRelacPersona.gCapRelPersTitular & " AND SUBSTRING(CACTS.cCtaCod,9,1) = '" & psTipPer & "'" _
                      & " AND SUBSTRING(CACTS.cCtaCod,9,1) = '" & psTipMon & "' " & sqlAdd & " " _
                      & " ORDER BY PR.cCtaCod"
    
    End Select
    
    If lsQrySdo = "" Then
       Exit Function
    End If
    
    Set rsQrySdo = oCon.CargaRecordSet(lsQrySdo)
    
    If rsQrySdo.EOF And rsQrySdo.BOF Then
       lsRTFRfm = ""
       lsReporte = ""
       GenSdosFM = lsReporte
    Else
       lsRTFRfm = ""
       lsReporte = ""
       PrtSdosFM rsQrySdo, psTipMon, lsTipAho, lsPerson
       GenSdosFM = lsReporte
    End If
    rsQrySdo.Close
    Set rsQrySdo = Nothing
End Function


Private Sub PrtSdosFM(ByVal prQryDat As ADODB.Recordset, psMoneda As Moneda, psTipAho As String, psPerson As String)

    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lnTotDep As Currency, lnTotRet As Currency
    Dim lsCodPro As String, lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsSubTit As String, lnCntCta As Integer
    Dim lnSdoCnt As Currency, lnSdoDis As Currency
    Dim lnSumInt As Currency, lnTotInt As Currency
    Dim lnCapita As Currency, lsCodCta As String
    Dim lnCapiFi As Currency, lnSdDiFi As Currency, lnSdCnFi As Currency
    Dim lnCtaPag As Integer, lnTotCta As Integer
    Dim lnCntRel As Integer, lbCtaIde As Boolean
    Dim lnCalInt As Currency, lnNumDia As Integer
    Dim lnApertu As Currency       '   , lnCapita As Currency
    Dim lnIntDev As Currency, lnIntCal As Currency
    Dim lnTotalP As Currency, lnTotApe As Currency
    Dim lnTotCap As Currency, lnToInDv As Currency
    Dim lnToInCa As Currency, lnTotalF As Currency
    Dim lbCieMes As Boolean, lnIntCap As Currency
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    If CierreRealizado(2) Then
       lbCieMes = True
    Else
       lbCieMes = False
    End If
    
    lsNumPag = ""
    lnLinPag = 65
    lnCarLin = 112
    lsTitRp1 = "L I S T A D O   D E   C U E N T A S   D E   " & psTipAho
    lsTitRp2 = ""
    lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
    lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0
    lnApertu = 0: lnCapita = 0: lnIntDev = 0: lnIntCal = 0: lnTotalP = 0
    lnTotApe = 0: lnTotCap = 0: lnToInDv = 0: lnToInCa = 0: lnTotalF = 0
    
    lnCntPag = 0
    lbCtaIde = False
    With prQryDat
         Do While Not .EOF
            Select Case Mid$(!cCodCta, 6, 3)
               Case Producto.gCapAhorros
                    lsTitRp2 = IIf(Not !cOrdPag, "", " CON ORDEN DE PAGO  -  ") & psPerson
               Case Producto.gCapPlazoFijo
                    lsTitRp2 = psPerson
                    lnCarLin = 167
               Case Producto.gCapCTS
                    lsTitRp2 = psPerson
                    lnCarLin = 173
            End Select
            
            If lsTitRp2 <> lsCodPro Then
               If lsNumPag <> "" Then
                  If Mid$(!cCodCta, 6, 3) = Producto.gCapAhorros Then
                     lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                     lsRTFRfm = lsRTFRfm & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(21, " ")
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
                     lsRTFRfm = lsRTFRfm & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(24, " ")
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnCapiFi)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     lsRTFRfm = lsRTFRfm & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                     lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
                     lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0
                  Else
                     lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                     lsRTFRfm = lsRTFRfm & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(50, " ")
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnApertu)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnIntDev)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnIntCal)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotalP)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
                     lsRTFRfm = lsRTFRfm & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(53, " ")
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotApe)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotCap)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnToInDv)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnToInCa)), 12, True, 9, 2) & " "
                     lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotalF)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     lsRTFRfm = lsRTFRfm & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                     lnApertu = 0: lnCapita = 0: lnIntDev = 0: lnIntCal = 0: lnTotalP = 0
                     lnTotApe = 0: lnTotCap = 0: lnToInDv = 0: lnToInCa = 0: lnTotalF = 0
                  End If
               End If
               lsCodPro = lsTitRp2
               lnLinPag = 65
            End If
            
            If lnLinPag > 58 Then
               If lsNumPag <> "" Then
                  If lnSdoDis <> 0 Or lnCapita <> 0 Then
                     If Mid$(!cCodCta, 6, 3) = Producto.gCapAhorros Then
                        lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                        lsRTFRfm = lsRTFRfm & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(21, " ")
                        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                        lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                        lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
                     Else
                        lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                        lsRTFRfm = lsRTFRfm & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(50, " ")
                        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnApertu)), 12, True, 9, 2) & " "
                        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnIntDev)), 12, True, 9, 2) & " "
                        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnIntCal)), 12, True, 9, 2) & " "
                        lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotalP)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                        lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                        lnApertu = 0: lnCapita = 0: lnIntDev = 0: lnIntCal = 0: lnTotalP = 0
                     End If
                  End If
               End If
               
               lnCntPag = lnCntPag + 1
               lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
               lsRTFRfm = lsRTFRfm & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1, lsTitRp2, IIf(psMoneda = gMonedaExtranjera, "DOLARES", "SOLES"), lsNumPag) & oImp.gPrnSaltoLinea
               lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
               
               If Mid$(!cCodCta, 6, 3) = Producto.gCapAhorros Then
                  lsRTFRfm = lsRTFRfm & "CORRE-" & " "
                  lsRTFRfm = lsRTFRfm & "   NUMERO    " & String(10, " ")
'                  lsRTFRfm = lsRTFRfm & "  CUENTA  " & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "NOMBRE / RAZON SOCIAL" & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "     INTERES  " & " "
                  lsRTFRfm = lsRTFRfm & "  SALDO    " & " "
                  lsRTFRfm = lsRTFRfm & "   SALDO    " & " "
                  lsRTFRfm = lsRTFRfm & " ULTIMO  " & oImp.gPrnSaltoLinea
                  lsRTFRfm = lsRTFRfm & "LATIVO" & " "
                  lsRTFRfm = lsRTFRfm & "   CUENTA    " & String(10, " ")
'                  lsRTFRfm = lsRTFRfm & "ANTERIOR " & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "      DEL CLIENTE     " & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "    DEL MES  " & " "
                  lsRTFRfm = lsRTFRfm & "DISPONIBLE " & " "
                  lsRTFRfm = lsRTFRfm & "   CONTABLE  " & " "
                  lsRTFRfm = lsRTFRfm & "MOVIMIENTO" & oImp.gPrnSaltoLinea
               End If
               If Mid$(!cCodCta, 6, 3) = Producto.gCapPlazoFijo Then
'                  lnCarLin = 153
                  lsRTFRfm = lsRTFRfm & "CORRE-" & " "
                  lsRTFRfm = lsRTFRfm & "  FECHAS  " & " "
                  lsRTFRfm = lsRTFRfm & "  FECHAS  " & " "
                  lsRTFRfm = lsRTFRfm & "PLAZOS" & " "
                  lsRTFRfm = lsRTFRfm & "   NUMERO    " & String(10, " ")
'                  lsRTFRfm = lsRTFRfm & " CUENTA  " & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "NOMBRE / RAZON SOCIAL" & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "      DEPOSITO  " & " "
                  lsRTFRfm = lsRTFRfm & "            " & " "
                  lsRTFRfm = lsRTFRfm & "  INTERES   " & " "
                  lsRTFRfm = lsRTFRfm & "  INTERES   " & " "
                  lsRTFRfm = lsRTFRfm & "            " & " "
                  lsRTFRfm = lsRTFRfm & " ULTIMO" & oImp.gPrnSaltoLinea
                  lsRTFRfm = lsRTFRfm & "LATIVO" & " "
                  lsRTFRfm = lsRTFRfm & " APERTURA " & " "
                  lsRTFRfm = lsRTFRfm & "  VENCIM  " & " "
                  lsRTFRfm = lsRTFRfm & "(DIAS)" & " "
                  lsRTFRfm = lsRTFRfm & "   CUENTA    " & String(10, " ")
'                  lsRTFRfm = lsRTFRfm & "ANTERIOR " & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "     DEL CLIENTE     " & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "    APERTURA  " & " "
                  lsRTFRfm = lsRTFRfm & "  CAPITAL   " & " "
                  lsRTFRfm = lsRTFRfm & " DEVENGADO  " & " "
                  lsRTFRfm = lsRTFRfm & " CALCULADO  " & " "
                  lsRTFRfm = lsRTFRfm & "  T O T A L " & " "
                  lsRTFRfm = lsRTFRfm & "CONTACTO" & oImp.gPrnSaltoLinea
               End If
               If Mid$(!cCodCta, 6, 3) = Producto.gCapCTS Then
                  lsRTFRfm = lsRTFRfm & "CORRE-" & " "
                  lsRTFRfm = lsRTFRfm & "  FECHAS  " & " "
                  lsRTFRfm = lsRTFRfm & "  FECHAS  " & " "
                  lsRTFRfm = lsRTFRfm & "PLAZOS" & " "
                  lsRTFRfm = lsRTFRfm & "   NUMERO    " & String(10, " ")
'                  lsRTFRfm = lsRTFRfm & " CUENTA  " & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "NOMBRE / RAZON SOCIAL" & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "   ULTIMO   " & " "
                  lsRTFRfm = lsRTFRfm & "            " & " "
                  lsRTFRfm = lsRTFRfm & "   INTERES  " & " "
                  lsRTFRfm = lsRTFRfm & "   SALDO    " & " "
                  lsRTFRfm = lsRTFRfm & "   SALDO    " & " "
                  lsRTFRfm = lsRTFRfm & "    ULTIMO" & oImp.gPrnSaltoLinea
                  lsRTFRfm = lsRTFRfm & "LATIVO" & " "
                  lsRTFRfm = lsRTFRfm & " APERTURA " & " "
                  lsRTFRfm = lsRTFRfm & "  VENCIM  " & " "
                  lsRTFRfm = lsRTFRfm & "(DIAS)" & " "
                  lsRTFRfm = lsRTFRfm & "   CUENTA    " & String(10, " ")
'                  lsRTFRfm = lsRTFRfm & "ANTERIOR " & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "     DEL CLIENTE     " & String(10, " ")
                  lsRTFRfm = lsRTFRfm & "  DEPOSITO  " & " "
                  lsRTFRfm = lsRTFRfm & "  CAPITAL   " & " "
                  lsRTFRfm = lsRTFRfm & "  DEL MES   " & " "
                  lsRTFRfm = lsRTFRfm & "  DISPONIBLE" & " "
                  lsRTFRfm = lsRTFRfm & "  CONTABLE  " & " "
                  lsRTFRfm = lsRTFRfm & "  CONTACTO" & oImp.gPrnSaltoLinea
               End If
               
               lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea         ' hasta 160 caracteres x línea
               lnLinPag = 9
            End If
            lnCntRel = 0
            If !cCodCta = lsCodCta Then
                If lbCtaIde = False Then
                    Select Case Mid$(lsCodCta, 6, 3)
                        Case Producto.gCapAhorros
                            lsRTFRfm = lsRTFRfm & String(26, " ")
                            lnCntRel = lnCntRel + 1
                        Case Producto.gCapPlazoFijo
                            lsRTFRfm = lsRTFRfm & String(55, " ")
                            lnCntRel = lnCntRel + 1
                        Case Producto.gCapCTS
                            lsRTFRfm = lsRTFRfm & String(55, " ")
                            lnCntRel = lnCntRel + 1
                    End Select
                    lsRTFRfm = lsRTFRfm & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 40) & Chr(10)
                    lbCtaIde = True
               End If
            Else
               lsCodCta = !cCodCta
               lbCtaIde = False
               lnCtaPag = lnCtaPag + 1: lnTotCta = lnTotCta + 1
               
               Select Case Mid$(!cCodCta, 6, 3)
                  Case Producto.gCapAhorros
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotCta)), 6, False, 6, 0) & " "
                       lsRTFRfm = lsRTFRfm & !cCodCta & " "
'                       lsRTFRfm = lsRTFRfm & String(9, " ")
                       If Len(Trim(!cNomPers)) < 34 Then
                          lsRTFRfm = lsRTFRfm & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 34), 34, " ") & " "
                       Else
                          lsRTFRfm = lsRTFRfm & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 34) & " "
                       End If
                       lnIntCap = 0
                       If lbCieMes Then
                          lnIntCap = !nSdoDis - !nSdoAnt
                       Else
                          lnIntCap = !nIntMes
                       End If
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnIntCap)), 12, True, 9, 2) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(!nSdoDis, 12, True, 9, 2) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(!nSdoCnt, 12, True, 9, 2) & "   "
                       lsRTFRfm = lsRTFRfm & Format(!dUltMovAC, ofunf.gsFormatoFechaView) & Chr(10)
                       
                       lnCapita = lnCapita + lnIntCap: lnCapiFi = lnCapiFi + lnIntCap
                       lnSdoCnt = lnSdoCnt + !nSdoCnt
                       lnSdoDis = lnSdoDis + !nSdoDis
                       lnSdCnFi = lnSdCnFi + !nSdoCnt
                       lnSdDiFi = lnSdDiFi + !nSdoDis
                       lnCntRel = RelCta(!cCodCta, !cCodPers)
                       lbCtaIde = True
                  Case Producto.gCapPlazoFijo
                       lnCalInt = 0
                       lnNumDia = 0
                       lnNumDia = DateDiff("d", !dUltMovPF, !dFchVct) - 1
                       lnCalInt = GetInteres(!nTasaIntPF, (!nIntAcum + !nCapital), lnNumDia, False)
                       
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotCta)), 6, False, 6, 0) & " "
                       lsRTFRfm = lsRTFRfm & Format(!dAperPF, ofunf.gsFormatoFechaView) & " "
                       lsRTFRfm = lsRTFRfm & Format(!dFchVct, ofunf.gsFormatoFechaView) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(!nPlazo)), 6, False, 6, 0) & " "
                       lsRTFRfm = lsRTFRfm & !cCodCta & " "
'                       lsRTFRfm = lsRTFRfm & String(9, " ")
                       If Len(Trim(!cNomPers)) < 34 Then
                          lsRTFRfm = lsRTFRfm & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 34), 34, " ") & " "
                       Else
                          lsRTFRfm = lsRTFRfm & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 34) & " "
                       End If
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(!nApertura)), 12, True, 9, 2) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(!nCapital)), 12, True, 9, 2) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(!nIntAcum)), 12, True, 9, 2) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnCalInt)), 12, True, 9, 2) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(!nCapital + lnCalInt)), 12, True, 9, 2) & "   "
                       lsRTFRfm = lsRTFRfm & Format(!dUltMovPF, ofunf.gsFormatoFechaView) & oImp.gPrnSaltoLinea
                       
                       lnApertu = lnApertu + !nApertura: lnTotApe = lnTotApe + !nApertura
                       lnCapita = lnCapita + !nCapital: lnTotCap = lnTotCap + !nCapital
                       lnIntDev = lnIntDev + !nIntAcum: lnToInDv = lnToInDv + !nIntAcum
                       lnIntCal = lnIntCal + lnCalInt: lnToInCa = lnToInCa + lnCalInt
                       lnTotalP = lnTotalP + (!nCapital + lnCalInt)
                       lnTotalF = lnTotalF + (!nCapital + lnCalInt)
                       
                       lnCntRel = RelCta(!cCodCta, !cPersCod)
                       lbCtaIde = True
                  Case Producto.gCapCTS
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotCta)), 6, False, 6, 0) & " "
                       lsRTFRfm = lsRTFRfm & Format(!dAperCTS, ofunf.gsFormatoFechaView) & " "
                       lsRTFRfm = lsRTFRfm & String(10, " ") & " "
                       lsRTFRfm = lsRTFRfm & String(6, " ") & " "
                       lsRTFRfm = lsRTFRfm & !cCodCta & " "
'                       lsRTFRfm = lsRTFRfm & String(9, " ")
                       If Len(Trim(ofunc.PstaNombre(!cNomPers, False))) < 40 Then
                          lsRTFRfm = lsRTFRfm & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 40), 40, " ") & " "
                       Else
                          lsRTFRfm = lsRTFRfm & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 40) & " "
                       End If
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(!nUltDep, 12, True, 9, 2) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(!nCapital, 12, True, 9, 2) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(!nIntMes, 12, True, 9, 2) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(!nSdoDis, 12, True, 9, 2) & " "
                       lsRTFRfm = lsRTFRfm & ofunc.JDNum(!nSdoCnt, 12, True, 9, 2) & "   "
                     '  lsRTFRfm = lsRTFRfm & oFunC.JDNum(!CHEQUESENV, 12, True, 9, 2) & "   "
                       lsRTFRfm = lsRTFRfm & Format(!dUltMovCTS, ofunf.gsFormatoFechaView) & Chr(10)
                       
                       lnCapita = lnCapita + !nCapital
                       lnCapiFi = lnCapiFi + !nCapital
                       lnSdoCnt = lnSdoCnt + !nSdoCnt
                       lnSdoDis = lnSdoDis + !nSdoDis
                       lnSdCnFi = lnSdCnFi + !nSdoCnt
                       lnSdDiFi = lnSdDiFi + !nSdoDis
                       
                       lnApertu = lnApertu + !nUltDep: lnTotApe = lnTotApe + !nUltDep
                       lnCapita = lnCapita + !nCapital: lnTotCap = lnTotCap + !nCapital
                       lnIntDev = lnIntDev + !nIntMes: lnToInDv = lnToInDv + !nIntMes
                       lnIntCal = lnIntCal + !nSdoDis: lnToInCa = lnToInCa + !nSdoDis
                       lnTotalP = lnTotalP + !nSdoCnt: lnTotalF = lnTotalF + !nSdoCnt
                       
                       lnCntRel = RelCta(!cCodCta, !cCodPers)
                       lbCtaIde = True
               End Select
            End If
            lnCntCta = lnCntCta + 1
            lnLinPag = lnLinPag + lnCntRel + 1
            If lnCtaPag Mod 4 = 0 Then
                lsReporte = lsReporte & lsRTFRfm
                lsRTFRfm = ""
            End If
            .MoveNext
         Loop
    End With
    If prQryDat.EOF Then
       If Mid$(lsCodCta, 6, 3) = Producto.gCapAhorros Then
          lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
          lsRTFRfm = lsRTFRfm & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(21, " ")
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
          lsRTFRfm = lsRTFRfm & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(24, " ")
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnCapiFi)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          lsRTFRfm = lsRTFRfm & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
          lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
          lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0
       Else
          lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
          lsRTFRfm = lsRTFRfm & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(50, " ")
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnApertu)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnIntDev)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnIntCal)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotalP)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          lsRTFRfm = lsRTFRfm & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
          lsRTFRfm = lsRTFRfm & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(53, " ")
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotApe)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotCap)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnToInDv)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnToInCa)), 12, True, 9, 2) & " "
          lsRTFRfm = lsRTFRfm & ofunc.JDNum(Trim(Str(lnTotalF)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          lsRTFRfm = lsRTFRfm & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
          lnApertu = 0: lnCapita = 0: lnIntDev = 0: lnIntCal = 0: lnTotalP = 0
          lnTotApe = 0: lnTotCap = 0: lnToInDv = 0: lnToInCa = 0: lnTotalF = 0
       End If
    End If
    lsReporte = lsReporte & lsRTFRfm
    Set ofunc = Nothing
    Set ofuni = Nothing
End Sub

Private Function RelCta(psCodCta As String, psCodPer As String) As Integer
    Dim lsQrySd1 As String
    Dim rsQrySd1 As ADODB.Recordset
    Set rsQrySd1 = New ADODB.Recordset
    Dim lnCntRel As Integer
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    oCon.AbreConexion
    
    lsQrySd1 = " SELECT PP.cCtaCod, Left(CO.cConsDescripcion,2) cRelaCta, PE.cPersNombre " _
             & " FROM ProductoPersona PP " _
             & " INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod " _
             & " INNER JOIN Constante CO ON PP.nPrdPersRelac = CO.nConsValor And CO.nConsCod = 2005" _
             & " WHERE PP.cCtaCod = '" & psCodCta & "' AND PP.cPersCod <> '" & psCodPer & "' " _
             & " AND PP.nPrdPersRelac = 10"
    
    If lsQrySd1 = "" Then
       Exit Function
    End If
    If rsQrySd1.State = adStateOpen Then rsQrySd1.Close
    
    Set rsQrySd1 = oCon.CargaRecordSet(lsQrySd1)
    
    If rsQrySd1.EOF And rsQrySd1.BOF Then
       rsQrySd1.Close
       Set rsQrySd1 = Nothing
       RelCta = 0
       Exit Function
    Else
       lnCntRel = 0
       With rsQrySd1
            Do While Not .EOF
               Select Case Mid$(psCodCta, 6, 3)
                    Case Producto.gCapAhorros
                         lsRTFRfm = lsRTFRfm & String(26, " ")
                         lnCntRel = lnCntRel + 1
                    Case Producto.gCapPlazoFijo
                         lsRTFRfm = lsRTFRfm & String(55, " ")
                         lnCntRel = lnCntRel + 1
                    Case Producto.gCapCTS
                         lsRTFRfm = lsRTFRfm & String(55, " ")
                         lnCntRel = lnCntRel + 1
               End Select
               lsRTFRfm = lsRTFRfm & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cpersnombre), False), 34) & Chr(10)
               .MoveNext
            Loop
       End With
       rsQrySd1.Close
       Set rsQrySd1 = Nothing
       RelCta = lnCntRel
    End If
    Set ofunc = Nothing
    Set ofuni = Nothing
End Function


'***********************************************
' GetInteres: Funcion que devuelve el interes de la cuenta este interes puede ser
' simple o compuesto de acuerdo al ultimo argumento de la funcion
' si este es True es I simple de lo contrario sera compuesto
'***********************************************
Private Function GetInteres(pnTasa As Currency, pnSaldo As Currency, pnDias As Integer, Simple As Boolean) As Double
    Dim lnTasaEfec As Double
    
    If Simple Then
        If pnDias > 0 Then
            lnTasaEfec = (pnTasa / 100) / 360
            GetInteres = Round((lnTasaEfec) * pnDias * pnSaldo, 2)
        Else
            GetInteres = 0
        End If
    Else
        If pnDias > 0 Then
            lnTasaEfec = (pnTasa / 100) / 360
            GetInteres = Round((((lnTasaEfec + 1) ^ pnDias) - 1) * pnSaldo, 2)
        Else
            GetInteres = 0
        End If
    End If
End Function

Public Function GeneraRepInac(psTipAho As Producto, psTipPer As Integer, psTipMon As Moneda, _
                              psFecPro As String, Optional nTipo As Integer = 1) As String
   Dim lsQrySdo As String
   Dim rsQrySdo As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    
        
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And P.cCtaCod Like '___" & lsAgeCod & "%'"
    End If
  
   
    
    oCon.AbreConexion
    lsRTFSdo = ""
    lsMoneda = IIf(psTipMon = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    Select Case psTipPer
        Case PersPersoneria.gPersonaNat
            lsPerson = "PERSONA NATURAL"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurSFL
            lsPerson = "PERSONA JUR. SIN FINES DE LUCRO"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFL
            lsPerson = "PERSONA JUR. CON FINES DE LUCRO"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCMAC
            lsPerson = "CAJAS MUNICIPALES"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCRAC
            lsPerson = "CAJAS RURALES"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLFONCODES
             lsPerson = "FONCODES"
             sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCooperativa
            lsPerson = "COOPERATIVA"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLEdpyme
            lsPerson = "EDPYME"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
    End Select
    
    lsQrySdo = ""
    
        
            If nTipo = 1 Then
                    
                    lsQrySdo = " select p.cctacod,nSdoCnt=p.nsaldo,nsdodis=c.nsaldodisp, "
                    lsQrySdo = lsQrySdo & " tiempoinactiva=datediff(yy,dultcontacto,cast('" & psFecPro & "' as datetime)),Meses=(datediff(mm,dultcontacto,cast('" & psFecPro & "' as datetime)))%12,  "
                    lsQrySdo = lsQrySdo & " CordPag=ca.bordpag, "
                    lsQrySdo = lsQrySdo & " PE.cPersNombre cNomPers, PE.cPersCod cCodPers,a.cagecod,A.CAGEDESCRIPCION "
                    lsQrySdo = lsQrySdo & " from producto p "
                    lsQrySdo = lsQrySdo & " INNER JOIN ProductoPersona PP ON Pp.cCtaCod = P.cCtaCod "
                    lsQrySdo = lsQrySdo & " INNER JOIN Persona PE ON Pe.cPersCod = Pp.cPersCod "
                    lsQrySdo = lsQrySdo & " join captaciones c on c.cctacod=p.cctacod "
                    lsQrySdo = lsQrySdo & " join captacahorros ca on ca.cctacod=p.cctacod "
                    lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                    lsQrySdo = lsQrySdo & " where binactiva=1 and left(p.nprdestado,2) not in ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "') and PP.nPrdPersRelac = '" & gCapRelPersTitular & "' "
                    lsQrySdo = lsQrySdo & " and datediff(yy,dultcontacto,getdate())>=1 " & sqlAdd
                    lsQrySdo = lsQrySdo & " and SUBSTRING(P.cCtaCod,9,1)='" & psTipMon & "' and datediff(yy,dultcontacto,getdate())<2 "
                    lsQrySdo = lsQrySdo & " ORDER BY a.cagecod,ca.bOrdPag,p.cctacod"
                    
            ElseIf nTipo = 2 Then
                    
                    lsQrySdo = " select p.cctacod,nSdoCnt=p.nsaldo,nsdodis=c.nsaldodisp, "
                    lsQrySdo = lsQrySdo & " tiempoinactiva=datediff(yy,dultcontacto,cast('" & psFecPro & "' as datetime)),Meses=(datediff(mm,dultcontacto,cast('" & psFecPro & "' as datetime)))%12, "
                    lsQrySdo = lsQrySdo & " CordPag=ca.bordpag, "
                    lsQrySdo = lsQrySdo & " PE.cPersNombre cNomPers, PE.cPersCod cCodPers ,a.cagecod,A.CAGEDESCRIPCION "
                    lsQrySdo = lsQrySdo & " from producto p "
                    lsQrySdo = lsQrySdo & " INNER JOIN ProductoPersona PP ON Pp.cCtaCod = P.cCtaCod "
                    lsQrySdo = lsQrySdo & " INNER JOIN Persona PE ON Pe.cPersCod = Pp.cPersCod "
                    lsQrySdo = lsQrySdo & " join captaciones c on c.cctacod=p.cctacod "
                    lsQrySdo = lsQrySdo & " join captacahorros ca on ca.cctacod=p.cctacod "
                    lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                    lsQrySdo = lsQrySdo & " where binactiva=1 and left(p.nprdestado,2) not in ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "') and PP.nPrdPersRelac = '" & gCapRelPersTitular & "'" & sqlAdd
                    lsQrySdo = lsQrySdo & " and SUBSTRING(P.cCtaCod,9,1)='" & psTipMon & "' and datediff(yy,dultcontacto,getdate())>=2"
                    lsQrySdo = lsQrySdo & " ORDER BY a.cagecod,ca.bOrdPag,p.cctacod"
                    
            End If
                  
    
    If lsQrySdo = "" Then
       Exit Function
    End If
    
    If rsQrySdo.State = adStateOpen Then rsQrySdo.Close

    Set rsQrySdo = oCon.CargaRecordSet(lsQrySdo)
    
    If rsQrySdo.EOF And rsQrySdo.BOF Then
       lsRTFSdo = ""
       GeneraRepInac = lsRTFSdo
    Else
       PrtRepInac rsQrySdo, nTipo
       GeneraRepInac = lsRTFSdo
    End If
End Function

Private Function PrtRepInac(prQryDat As ADODB.Recordset, Optional nTipo As Integer = 1)
    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lnTotDep As Double, lnTotRet As Double
    Dim lsCodPro As String, lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsSubTit As String, lnCntCta As Integer
    Dim lnSdoCnt As Double, lnSdoDis As Double
    Dim lnSdCnFi  As Double, lnSdDiFi As Double
    Dim lnCapita As Double, lsCodCta As String
    Dim lnCapiFi As Double
    Dim lnCtaPag As Integer, lnTotCta As Integer
    Dim lnIntMes As Double, lnSdInFi As Double
    Dim lnCntRel As Integer
    Dim lbCtaIde As Boolean
    Dim lnIntCap As Double
    Dim lnIntDev As Double, lnCalInt As Double
    Dim lbCieMes As Boolean
    Dim lnNumDia As Integer, CCodage As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    If CierreRealizado(2) Then
        lbCieMes = True
    Else
        lbCieMes = False
    End If
    
    lsNumPag = ""
    lnLinPag = 65
    lnCarLin = 105
    lsTitRp1 = "REPORTE DE CUENTAS INACTIVAS" & IIf(nTipo = 1, "(DE 1 AÑO Y MENOS DE 2 AÑOS)", "(MAS DE 2 AÑOS)")
    lsTitRp2 = ""
    lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
    lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0
    lnCntPag = 0
    lbCtaIde = False
    
    With prQryDat
         Do While Not .EOF
             
               lnCarLin = 132
               lsTitRp2 = "AHORROS" & IIf(Not !cOrdPag, "", " CON ORDEN DE PAGO") & " - " & lsPerson
    
            
            If lsTitRp2 <> lsCodPro Then
               If lsNumPag <> "" Then
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(23, " ")
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                  
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(26, " ")
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapiFi)), 12, True, 9, 2) & " "
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
                  
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                                   
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                  lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
                  lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0
               End If
               lsCodPro = lsTitRp2
               lnLinPag = 65
            End If
            
            If lnLinPag > 58 Or CCodage <> !cAgeCod Then
               If lsNumPag <> "" Then
                  If lnSdoDis <> 0 Or lnCapita <> 0 Then
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                     lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(23, " ")
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                  
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                     lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
                  End If
               End If
               
               lnCntPag = lnCntPag + 1
               lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
               lsRTFSdo = lsRTFSdo & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1 + " AGENCIA: " + !cAgeDescripcion, lsTitRp2, lsMoneda, lsNumPag) & oImp.gPrnSaltoLinea
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
               
               
                  lsRTFSdo = lsRTFSdo & "   NUMERO    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "NOMBRE / RAZON SOCIAL" & String(20, " ")
                  lsRTFSdo = lsRTFSdo & "             "
                  lsRTFSdo = lsRTFSdo & "   SALDO     "
                  lsRTFSdo = lsRTFSdo & "   SALDO     "
                  lsRTFSdo = lsRTFSdo & "    TIEMPO INACTIVA    " & oImp.gPrnSaltoLinea
                  lsRTFSdo = lsRTFSdo & "   CUENTA    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "     DEL CLIENTE     " & String(20, " ")
                  lsRTFSdo = lsRTFSdo & "   CAPITAL   "
                  lsRTFSdo = lsRTFSdo & " DISPONIBLE  "
                  lsRTFSdo = lsRTFSdo & "  CONTABLE   "
                  lsRTFSdo = lsRTFSdo & "    (Años)  (Meses)    " & oImp.gPrnSaltoLinea
                  
               
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea         ' hasta 160 caracteres x línea
               lnLinPag = 9
            End If
            lnCntRel = 0
            If !cCtaCod = lsCodCta Then
               If lbCtaIde = False Then
                  lnCntRel = RelCta(!cCtaCod, !cCodPers)
                  lbCtaIde = True
               End If
            Else
               lsCodCta = !cCtaCod
               lbCtaIde = False
               lsRTFSdo = lsRTFSdo & !cCtaCod & " "
               If Len(Trim(!cNomPers)) < 50 Then
                  lsRTFSdo = lsRTFSdo & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), IIf(Mid$(!cCtaCod, 6, 3) = "233", 42, 43)), IIf(Mid$(!cCtaCod, 6, 3) = "233", 42, 43), " ") & " "
               Else
                  lsRTFSdo = lsRTFSdo & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), IIf(Mid$(!cCtaCod, 6, 3) = "233", 42, 43)) & " "
               End If
               lnCtaPag = lnCtaPag + 1: lnTotCta = lnTotCta + 1
               
               Select Case Mid$(!cCtaCod, 6, 3)
                  Case Producto.gCapAhorros
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum("0.00", 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoDis, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoCnt, 12, True, 9, 2) & " "
                  
                       lsRTFSdo = lsRTFSdo & Space(8) & ofuni.FillText(!tiempoinactiva & Space(8 - Len(!tiempoinactiva)) & !Meses, 25, " ") & Chr(10)
                       
                       lnCapita = lnCapita + 0: lnCapiFi = lnCapiFi + 0
                       lnSdoCnt = lnSdoCnt + !nSdoCnt
                       lnSdoDis = lnSdoDis + !nSdoDis
                       lnSdCnFi = lnSdCnFi + !nSdoCnt
                       lnSdDiFi = lnSdDiFi + !nSdoDis
                       lnCntRel = RelCta(!cCtaCod, !cCodPers)
                       lbCtaIde = True
                  
               End Select
            End If
            lnCntCta = lnCntCta + 1
            lnLinPag = lnLinPag + lnCntRel + 1
            
            CCodage = !cAgeCod
            .MoveNext
         Loop
    End With
    If prQryDat.EOF Then
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(23, " ")
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
      
         lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
         lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
              
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(26, " ")
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapiFi)), 12, True, 9, 2) & " "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
       
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       
       
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
       lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
       lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0
    End If
    Set ofuni = Nothing
    Set ofunc = Nothing
End Function



Public Function GeneraRepBloq(psTipAho As Producto, psTipPer As Integer, psTipMon As Moneda, _
                              Optional nTipo As Integer = 1) As String
    Dim lsQrySdo As String
    Dim rsQrySdo As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    
        
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And P.cCtaCod Like '___" & lsAgeCod & "%'"
    End If
    If psTipAho = gCapCTS Then
     sqlAdd = sqlAdd & " and pb.nblqmotivo in (3,15) "
    ElseIf nTipo = 4 Then
     sqlAdd = sqlAdd & " and pb.nblqmotivo=3 "
    ElseIf nTipo = 5 Then
     sqlAdd = sqlAdd & " and pb.nblqmotivo=15 "
    End If
    
    If nTipo = 2 Then
        sqlAdd = sqlAdd & " and CS.CCODINST='1089800000272' "
    ElseIf nTipo = 3 Then
        sqlAdd = sqlAdd & " and CS.CCODINST<>'1089800000272' "
    End If
    
    
    oCon.AbreConexion
    lsRTFSdo = ""
    lsMoneda = IIf(psTipMon = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    Select Case psTipPer
        Case PersPersoneria.gPersonaNat
            lsPerson = "PERSONA NATURAL"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurSFL
            lsPerson = "PERSONA JUR. SIN FINES DE LUCRO"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFL
            lsPerson = "PERSONA JUR. CON FINES DE LUCRO"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCMAC
            lsPerson = "CAJAS MUNICIPALES"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCRAC
            lsPerson = "CAJAS RURALES"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLFONCODES
             lsPerson = "FONCODES"
             sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCooperativa
            lsPerson = "COOPERATIVA"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLEdpyme
            lsPerson = "EDPYME"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
    End Select
    
    lsQrySdo = ""
    Select Case psTipAho
        Case Producto.gCapAhorros
            
          lsQrySdo = " Select p.cctacod,cordpag=ca.bordpag,cCodPers=PP.CPERSCOD,cNomPers=pe.cpersnombre,nCapital=0,nSdodis=c.nsaldodisp,c.nIntAcum AS nIntDev,nSdoCnt=p.nSaldo,Motivo=pb.cconsdescripcion,a.cagecod,A.CAGEDESCRIPCION "
          lsQrySdo = lsQrySdo & " from producto p "
          lsQrySdo = lsQrySdo & " inner join productopersona pp  on pp.cctacod=p.cctacod "
          lsQrySdo = lsQrySdo & " inner join captaciones c on c.cctacod=p.cctacod "
          lsQrySdo = lsQrySdo & " inner join captacahorros ca on ca.cctacod=c.cctacod "
          lsQrySdo = lsQrySdo & " inner join persona pe on pe.cperscod=pp.cperscod "
          lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(P.CCTACOD,4,2) "
          lsQrySdo = lsQrySdo & " inner join (SELECT distinct p1.nblqmotivo,p1.CCTACOD,p2.cconsdescripcion FROM PRODUCTOBLOQUEOS p1 "
          lsQrySdo = lsQrySdo & " inner join (select nconsvalor,cconsdescripcion from constante where nconscod='2007') p2 on p2.nconsvalor=p1.nblqmotivo "
          lsQrySdo = lsQrySdo & " WHERE  (CMOVNRODBL IS NULL OR CMOVNRODBL='')) PB ON PB.CCTACOD=P.CCTACOD "
          lsQrySdo = lsQrySdo & " WHERE   Left(P.nPrdEstado,2) In ('" & Left(CaptacEstado.gCapEstBloqRetiro, 2) & "','" & Left(CaptacEstado.gCapEstBloqTotal, 2) & "') "
          lsQrySdo = lsQrySdo & " AND PP.nPrdPersRelac in ('" & gCapRelPersTitular & "','" & gCapRelPersRepTitular & "') AND SUBSTRING(P.cCtaCod,9,1) = '" & psTipMon & "' " & sqlAdd & ""
          lsQrySdo = lsQrySdo & " ORDER BY a.cagecod,ca.bordpag,p.cctacod "
                      
        Case Producto.gCapPlazoFijo
        
            lsQrySdo = " Select p.cctacod,cCodPers=PP.CPERSCOD,cNomPers=pe.cpersnombre,nCapital=c.nsaldodisp,c.nIntAcum AS nIntDev,nSdoCont=p.nSaldo,Motivo=pb.cconsdescripcion,a.cagecod,A.CAGEDESCRIPCION "
            lsQrySdo = lsQrySdo & " from producto p "
            lsQrySdo = lsQrySdo & " inner join productopersona pp  on pp.cctacod=p.cctacod "
            lsQrySdo = lsQrySdo & " inner join captaciones c on c.cctacod=p.cctacod "
            lsQrySdo = lsQrySdo & " inner join captacplazofijo cs on cs.cctacod=c.cctacod "
            lsQrySdo = lsQrySdo & " inner join persona pe on pe.cperscod=pp.cperscod "
            lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(P.CCTACOD,4,2) "
            lsQrySdo = lsQrySdo & " inner join (SELECT distinct p1.nblqmotivo,p1.CCTACOD,p2.cconsdescripcion FROM PRODUCTOBLOQUEOS p1 "
            lsQrySdo = lsQrySdo & " inner join (select nconsvalor,cconsdescripcion from constante where nconscod='2007') p2 on p2.nconsvalor=p1.nblqmotivo "
            lsQrySdo = lsQrySdo & " WHERE  (CMOVNRODBL IS NULL OR CMOVNRODBL='')) PB ON PB.CCTACOD=P.CCTACOD "
            lsQrySdo = lsQrySdo & " WHERE   Left(P.nPrdEstado,2) In ('" & Left(CaptacEstado.gCapEstBloqRetiro, 2) & "','" & Left(CaptacEstado.gCapEstBloqTotal, 2) & "') "
            lsQrySdo = lsQrySdo & " AND PP.nPrdPersRelac in ('" & gCapRelPersTitular & "','" & gCapRelPersRepTitular & "') AND SUBSTRING(P.cCtaCod,9,1) = '" & psTipMon & "' " & sqlAdd & ""
            lsQrySdo = lsQrySdo & " ORDER BY a.cagecod,p.cctacod "

                      
        Case Producto.gCapCTS
             If psTipPer = PersPersoneria.gPersonaNat Then
                   lsQrySdo = "Select p.cctacod,cCodPers=PP.CPERSCOD,cNomPers=pe.cpersnombre,nCapital=c.nsaldodisp,nSdoDis=cs.nsaldretiro,nSdoCnt=p.nsaldo,Motivo=pb.cconsdescripcion,a.cagecod,A.CAGEDESCRIPCION  from producto p "
                   lsQrySdo = lsQrySdo & " inner join productopersona pp  on pp.cctacod=p.cctacod "
                   lsQrySdo = lsQrySdo & " inner join captaciones c on c.cctacod=p.cctacod "
                   lsQrySdo = lsQrySdo & " inner join captaccts cs on cs.cctacod=c.cctacod "
                   lsQrySdo = lsQrySdo & " inner join persona pe on pe.cperscod=pp.cperscod "
                   lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(P.CCTACOD,4,2) "
                   lsQrySdo = lsQrySdo & " inner join (SELECT distinct p1.nblqmotivo,p1.CCTACOD,p2.cconsdescripcion FROM PRODUCTOBLOQUEOS p1 "
                   lsQrySdo = lsQrySdo & " inner join (select nconsvalor,cconsdescripcion from constante where nconscod='2007') p2 on p2.nconsvalor=p1.nblqmotivo "
                   lsQrySdo = lsQrySdo & " WHERE  (CMOVNRODBL IS NULL OR CMOVNRODBL='')   ) PB ON PB.CCTACOD=P.CCTACOD "
                   lsQrySdo = lsQrySdo & " WHERE Left(P.nPrdEstado,2) In ('" & Left(CaptacEstado.gCapEstBloqRetiro, 2) & "','" & Left(CaptacEstado.gCapEstBloqTotal, 2) & "') "
                   lsQrySdo = lsQrySdo & " AND C.nPersoneria = '" & psTipPer & "' AND  PP.nPrdPersRelac = '" & gCapRelPersTitular & "' AND SUBSTRING(P.cCtaCod,9,1) = '" & psTipMon & "' " & sqlAdd & ""
                   lsQrySdo = lsQrySdo & " ORDER BY a.cagecod,p.cctacod "
                            
               
             End If 'RepEstratPlazoFijo
    End Select
    
    If lsQrySdo = "" Then
       Exit Function
    End If
    If rsQrySdo.State = adStateOpen Then rsQrySdo.Close

    Set rsQrySdo = oCon.CargaRecordSet(lsQrySdo)
    
    If rsQrySdo.EOF And rsQrySdo.BOF Then
       lsRTFSdo = ""
       GeneraRepBloq = lsRTFSdo
    Else
       PrtRepBloqueos rsQrySdo, nTipo
       GeneraRepBloq = lsRTFSdo
    End If


End Function

Private Function PrtRepBloqueos(prQryDat As ADODB.Recordset, Optional nTipo As Integer = 1)
    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lnTotDep As Double, lnTotRet As Double
    Dim lsCodPro As String, lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsSubTit As String, lnCntCta As Integer
    Dim lnSdoCnt As Double, lnSdoDis As Double
    Dim lnSdCnFi  As Double, lnSdDiFi As Double
    Dim lnCapita As Double, lsCodCta As String
    Dim lnCapiFi As Double
    Dim lnCtaPag As Integer, lnTotCta As Integer
    Dim lnIntMes As Double, lnSdInFi As Double
    Dim lnCntRel As Integer
    Dim lbCtaIde As Boolean
    Dim lnIntCap As Double
    Dim lnIntDev As Double, lnCalInt As Double
    Dim lbCieMes As Boolean
    Dim lnNumDia As Integer, CCodage As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    If CierreRealizado(2) Then
        lbCieMes = True
    Else
        lbCieMes = False
    End If
    
    lsNumPag = ""
    lnLinPag = 65
    lnCarLin = 105
    lsTitRp1 = "REPORTE DE CUENTAS BLOQUEADAS" & IIf(nTipo = 4, " CREDITOS DIRECTOS", IIf(nTipo = 5, " CREDITOS INDIRECTOS", ""))
    lsTitRp2 = ""
    lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
    lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0
    lnCntPag = 0
    lbCtaIde = False
    
    With prQryDat
         Do While Not .EOF
         
         
            Select Case Mid$(!cCtaCod, 6, 3)
               Case Producto.gCapAhorros
                    lnCarLin = 132
                    lsTitRp2 = "AHORROS" & IIf(Not !cOrdPag, "", " CON ORDEN DE PAGO") & " - " & lsPerson
               Case Producto.gCapPlazoFijo
                    lnCarLin = 119
                    lsTitRp2 = "PLAZO FIJO" & " - " & lsPerson
               Case Producto.gCapCTS
                    lnCarLin = 132
                    lsPerson = "PERSONA NATURAL - " '& IIf(LTrim(RTrim(!cCodInst)) = gsInstCmac, "EMPLEADOS", "CLIENTES")
                    lsTitRp2 = "C T S" & " - " & lsPerson & " " & IIf(nTipo = 2, "EMPLEADOS CMAC - CONVENIO", IIf(nTipo = 3, "OTRAS EMPRESAS - EXTERNOS", ""))
            End Select
            
            If lsTitRp2 <> lsCodPro Then
               If lsNumPag <> "" Then
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(22, " ")
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                  If Left(lsCodPro, 7) = "AHORROS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  Else
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                  End If
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(25, " ")
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapiFi)), 12, True, 9, 2) & " "
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
                  If Left(lsCodPro, 7) = "AHORROS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  Else
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  End If
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                  lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
                  lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0
               End If
               lsCodPro = lsTitRp2
               lnLinPag = 65
            End If
            
            If lnLinPag > 58 Or CCodage <> !cAgeCod Then
               If lsNumPag <> "" Then
                  If lnSdoDis <> 0 Or lnCapita <> 0 Then
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                     lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(22, " ")
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     If Left(lsCodPro, 7) = "AHORROS" Then
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     Else
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     End If
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                     lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
                  End If
               End If
               
               lnCntPag = lnCntPag + 1
               lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
               lsRTFSdo = lsRTFSdo & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1 + " AGENCIA: " + !cAgeDescripcion, lsTitRp2, lsMoneda, lsNumPag) & oImp.gPrnSaltoLinea
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
               If Mid$(!cCtaCod, 6, 3) = Producto.gCapPlazoFijo Then
                  lsRTFSdo = lsRTFSdo & "   NUMERO    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "NOMBRE / RAZON SOCIAL" & String(20, " ")
                  lsRTFSdo = lsRTFSdo & "             "
                  lsRTFSdo = lsRTFSdo & "   INTERES   "
                  lsRTFSdo = lsRTFSdo & "   SALDO     "
                  lsRTFSdo = lsRTFSdo & " MOTIVO     " & oImp.gPrnSaltoLinea
                  lsRTFSdo = lsRTFSdo & "   CUENTA    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "     DEL CLIENTE     " & String(20, " ")
                  lsRTFSdo = lsRTFSdo & "   CAPITAL   "
                  lsRTFSdo = lsRTFSdo & "  DEVENGADO  "
                  lsRTFSdo = lsRTFSdo & "  CONTABLE   " & ""
                  lsRTFSdo = lsRTFSdo & " DE BLOQUEO  " & oImp.gPrnSaltoLinea
               Else
                  lsRTFSdo = lsRTFSdo & "   NUMERO    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "NOMBRE / RAZON SOCIAL" & String(20, " ")
                  lsRTFSdo = lsRTFSdo & "             "
                  lsRTFSdo = lsRTFSdo & "   SALDO     "
                  lsRTFSdo = lsRTFSdo & "   SALDO     "
                  lsRTFSdo = lsRTFSdo & "   MOTIVO      " & oImp.gPrnSaltoLinea
                  lsRTFSdo = lsRTFSdo & "   CUENTA    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "     DEL CLIENTE     " & String(20, " ")
                  lsRTFSdo = lsRTFSdo & "   CAPITAL   "
                  lsRTFSdo = lsRTFSdo & " DISPONIBLE  "
                  lsRTFSdo = lsRTFSdo & "  CONTABLE   "
                  lsRTFSdo = lsRTFSdo & "   DE BLOQUEO  " & oImp.gPrnSaltoLinea
                  
               End If
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea         ' hasta 160 caracteres x línea
               lnLinPag = 9
            End If
            lnCntRel = 0
            If !cCtaCod = lsCodCta Then
               If lbCtaIde = False Then
                  lnCntRel = RelCta(!cCtaCod, !cCodPers)
                  lbCtaIde = True
               End If
            Else
               lsCodCta = !cCtaCod
               lbCtaIde = False
               lsRTFSdo = lsRTFSdo & !cCtaCod & " "
               If Len(Trim(!cNomPers)) < 50 Then
                  lsRTFSdo = lsRTFSdo & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), IIf(Mid$(!cCtaCod, 6, 3) = "233", 42, 43)), IIf(Mid$(!cCtaCod, 6, 3) = "233", 42, 43), " ") & " "
               Else
                  lsRTFSdo = lsRTFSdo & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), IIf(Mid$(!cCtaCod, 6, 3) = "233", 42, 43)) & " "
               End If
               lnCtaPag = lnCtaPag + 1: lnTotCta = lnTotCta + 1
               
               Select Case Mid$(!cCtaCod, 6, 3)
                  Case Producto.gCapAhorros
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum("0.00", 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoDis, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoCnt, 12, True, 9, 2) & " "

                       lnIntCap = 0
                       'If lbCieMes Then
                       '     lnIntCap = !nSdoDis - !nSdoAnt
                       'Else
                       '     lnIntCap = !nIntMes
                       'End If
                       'lsRTFSdo = lsRTFSdo & oFunC.JDNum(Trim(Str(lnIntCap)), 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & Space(8) & ofuni.FillText(!Motivo, 25, " ") & Chr(10)
                       
                       lnCapita = lnCapita + 0: lnCapiFi = lnCapiFi + 0
                       lnSdoCnt = lnSdoCnt + !nSdoCnt
                       lnSdoDis = lnSdoDis + !nSdoDis
                       lnSdCnFi = lnSdCnFi + !nSdoCnt
                       lnSdDiFi = lnSdDiFi + !nSdoDis
                       lnCntRel = RelCta(!cCtaCod, !cCodPers)
                       lbCtaIde = True
                  Case Producto.gCapPlazoFijo
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nCapital, 12, True, 9, 2) & " "
                       
                       'lnNumDia = DateDiff("d", !dUltMovPF, gdFecSis) - 1
                       
                       'Adicion Miguel 18-03-2004
                       lnCalInt = !nIntDev
                       
                       'lnCalInt = GetInteres(!nTasaInteres, (!nIntDev + !nCapital), lnNumDia, False)
                       
                       lnIntDev = lnCalInt
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntDev)), 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoCont, 12, True, 9, 2) & "   "
                       lsRTFSdo = lsRTFSdo & ofuni.FillText(!Motivo, 25, " ") & Chr(10)
                       
                       lnCapita = lnCapita + !nCapital
                       lnCapiFi = lnCapiFi + !nCapital
                       lnSdoDis = lnSdoDis + lnIntDev
                       lnSdDiFi = lnSdDiFi + lnIntDev
                       lnSdoCnt = lnSdoCnt + !nSdoCont
                       lnSdCnFi = lnSdCnFi + !nSdoCont
                       lnCntRel = RelCta(!cCtaCod, !cCodPers)
                       lbCtaIde = True
                  Case Producto.gCapCTS
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nCapital, 11, True, 8, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoDis, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoCnt, 12, True, 9, 2) & "     "
                       
                       lnIntCap = 0
'                       If lbCieMes Then
'                            lnIntCap = !nSdoDis - !nSdoAnt
'                       Else
'                            lnIntCap = !nIntMes
'                       End If
                       lsRTFSdo = lsRTFSdo & ofuni.FillText(!Motivo, 25, " ") & Chr(10)
                       
                       lnCapita = lnCapita + !nCapital
                       lnCapiFi = lnCapiFi + !nCapital
                       lnSdoCnt = lnSdoCnt + !nSdoCnt
                       lnSdCnFi = lnSdCnFi + !nSdoCnt
                       lnSdoDis = lnSdoDis + !nSdoDis
                       lnSdDiFi = lnSdDiFi + !nSdoDis
                       lnCntRel = RelCta(!cCtaCod, !cCodPers)
                       lbCtaIde = True
               End Select
            End If
            lnCntCta = lnCntCta + 1
            lnLinPag = lnLinPag + lnCntRel + 1
            
            CCodage = !cAgeCod
            .MoveNext
         Loop
    End With
    If prQryDat.EOF Then
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(22, " ")
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
       If Left(lsCodPro, 7) = "AHORROS" Then
         lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
         lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       
       Else
         lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          
       End If
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(25, " ")
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapiFi)), 12, True, 9, 2) & " "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
       If Left(lsCodPro, 7) = "AHORROS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       Else
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       End If
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
       lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0
       lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0
    End If
    Set ofunc = Nothing
    Set ofuni = Nothing
End Function

Public Function GeneraProvisionCierre(ByVal psTipAho As Producto, ByVal psTipPer As Integer, _
                                   ByVal psFchPro As Date, ByVal psAgeCod As String, _
                                   ByVal psMoneda As String) As String
                             
    Dim sSql As String
    Dim RSTMP As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String, lscad As String
    Dim nTipo As Integer
        
    If psAgeCod = "" Then
        sqlAdd = ""
    ElseIf psAgeCod <> "" Then
        sqlAdd = " And CS.cCtaCod Like '___" & psAgeCod & "%'"
    End If
    
    If psMoneda <> "" Then
        sqlAdd = sqlAdd & " and substring(cs.cctacod,9,1)='" & psMoneda & "'"
    End If
    
    lsMoneda = IIf(psMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    nTipo = 1
    
    If psTipPer = 0 Then
            nTipo = 0
    End If
    
    lsPerson = ""
    Select Case psTipPer
            Case PersPersoneria.gPersonaNat
                 lsPerson = "PERSONA NATURAL"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurSFL
                 lsPerson = "PERSONA JUR. SIN FINES DE LUCRO"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFL
                 lsPerson = "PERSONA JUR. CON FINES DE LUCRO"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLCMAC
                 lsPerson = "CAJAS MUNICIPALES"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLCRAC
                 lsPerson = "CAJAS RURALES"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLFONCODES
                 lsPerson = "FONCODES"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLCooperativa
                 lsPerson = "COOPERATIVA"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLEdpyme
                 lsPerson = "EDPYME"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
    End Select

    
        
    If psTipAho = gCapPlazoFijo Then
        sSql = "  SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=cs.cctacod )"
        sSql = sSql & " ,a.cagecod  ,A.CAGEDESCRIPCION,CS.CCTACOD,PERSONERIA=g.CCONSDESCRIPCION, g.npersoneria , nintdev=cs.ninteres, "
        sSql = sSql & "                  CS.NSALDCNT,CS.NSALDDISP, PORVALORIZAR=ISNULL(H.MONTO,0),MONEDA=case when substring(cs.cctacod,9,1)=1 then 'SOLES' ELSE 'DOLARES' END,"
        sSql = sSql & "                 PROVISION = m.nMonto"
        sSql = sSql & "                FROM CAPSALDOSDIARIOS CS"
        sSql = sSql & "                JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2)"
        sSql = sSql & "                JOIN (SELECT MC.NMONTO,MC.CCTACOD FROM MOV M    JOIN MOVCAP MC ON MC.NMOVNRO=M.NMOVNRO"
        sSql = sSql & "                WHERE MC.COPECOD= '210401' AND M.CMOVNRO LIKE '" & Format(psFchPro, "yyyymmdd") & "%'"
        sSql = sSql & "                    AND M.NMOVFLAG=0) M ON M.CCTACOD=CS.CCTACOD"
        sSql = sSql & "                JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION FROM CAPTACIONES C"
        sSql = sSql & "               JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA ) g  ON g .CCTACOD=CS.CCTACOD"
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
        sSql = sSql & "                WHERE CS.CCTACOD LIKE '109__233%' AND CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "'"
        sSql = sSql & " ORDER BY a.cagecod,g.npersoneria ,moneda,  cpersnombre ,CS.CCTACOD "
            
   
    End If
    
    If RSTMP.State = adStateOpen Then RSTMP.Close

    oCon.AbreConexion
    Set RSTMP = oCon.CargaRecordSet(sSql)
    
    lsRTFSdo = ""
    If RSTMP.EOF And RSTMP.BOF Then
       lscad = ""
       GeneraProvisionCierre = lsRTFSdo
    ElseIf psTipAho = gCapPlazoFijo Then
       PrtSaldosCierre RSTMP, nTipo, psFchPro, 5
       GeneraProvisionCierre = lsRTFSdo
    End If
    oCon.CierraConexion
    
    Set oCon = Nothing
                             
End Function

Public Function GeneraConsolidadaBloqueadasCierre(ByVal psTipAho As Producto, _
                                              ByVal psFchPro As Date, _
                                              ByVal psMoneda As String) As String
                                              
    Dim sSql As String
    Dim RSTMP As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String, lscad As String
    Dim nTipo As Integer
        
    If psAgeCod = "" Then
        sqlAdd = ""
    ElseIf psAgeCod <> "" Then
        sqlAdd = " And CS.cCtaCod Like '___" & psAgeCod & "%'"
    End If
    
    lsMoneda = IIf(psMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    nTipo = 1
    
    If psTipPer = 0 Then
            nTipo = 0
    End If
    
    If psTipAho = gCapCTS Then
         If bexternos = False Then
            sqlAdd = sqlAdd & " and c.tipo='CONVENIO' "
         Else
            sqlAdd = sqlAdd & " and c.tipo='EXTERNO' "
         End If
    End If
       
    
    If psTipAho = gCapAhorros Then
          
        sSql = " SELECT A.CAGEDESCRIPCION,PERSONERIA=C.CCONSDESCRIPCION,J.TIPOBLOQ,MOTIVO=K.CCONSDESCRIPCION, "
        sSql = sSql & " TOTALCNT=Sum (J.NSALDCNT), TOTALDISP=Sum(J.NSALDDISP) "
        sSql = sSql & " ,MONEDA=SUBSTRING(J.CCTACOD,9,1),TOTALPORVAL= Sum(isnull(h.monto,0)) "
        sSql = sSql & " From "
        sSql = sSql & " ( "
        sSql = sSql & " SELECT C.CCTACOD, "
        sSql = sSql & " TIPOBLOQ=c.ntpobloqueo, "
        sSql = sSql & " C.NSALDCNT , C.NSALDDISP "
        sSql = sSql & " FROM CAPSALDOSDIARIOS C "
        sSql = sSql & " WHERE C.CCTACOD LIKE '109__232%' "
        sSql = sSql & " AND CONVERT(CHAR(8),C.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' "
        sSql = sSql & " ) J "
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=J.CCTACOD "
        sSql = sSql & " JOIN ( SELECT * FROM CONSTANTE WHERE NCONSCOD=2007 AND NCONSVALOR IN (3,15))K ON K.NCONSVALOR=J.TIPOBLOQ "
        sSql = sSql & " JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION FROM CAPTACIONES C "
        sSql = sSql & " JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA )C ON C.CCTACOD=J.CCTACOD "
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(J.CCTACOD,4,2) "
        sSql = sSql & " GROUP BY A.CAGEDESCRIPCION,C.CCONSDESCRIPCION,J.TIPOBLOQ,K.CCONSDESCRIPCION,SUBSTRING(J.CCTACOD,9,1) "
        
    ElseIf psTipAho = gCapPlazoFijo Then
    
        sSql = " SELECT A.CAGEDESCRIPCION,PERSONERIA=C.CCONSDESCRIPCION,J.TIPOBLOQ,K.CCONSDESCRIPCION,"
        sSql = sSql & " TOTALCNT=Sum (J.NSALDCNT),TOTALDISP=Sum(J.NSALDDISP)"
        sSql = sSql & " ,MONEDA= SUBSTRING(J.CCTACOD,9,1),TOTALPORVAL= Sum(isnull(h.monto,0)) "
        sSql = sSql & " From"
        sSql = sSql & " ("
        sSql = sSql & " SELECT C.CCTACOD,"
        sSql = sSql & " TIPOBLOQ=c.ntpobloqueo,"
        sSql = sSql & " C.NSALDCNT , C.NSALDDISP"
        sSql = sSql & " FROM CAPSALDOSDIARIOS C"
        sSql = sSql & " WHERE C.CCTACOD LIKE '109__233%'"
        sSql = sSql & " AND CONVERT(CHAR(8),C.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "'"
        sSql = sSql & " ) J"
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=J.CCTACOD "
        sSql = sSql & " JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=2007 AND NCONSVALOR IN (3,15))K ON K.NCONSVALOR=J.TIPOBLOQ"
        sSql = sSql & " JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION FROM CAPTACIONES C"
        sSql = sSql & " JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA )C ON C.CCTACOD=J.CCTACOD"
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(J.CCTACOD,4,2)"
        sSql = sSql & " GROUP BY A.CAGEDESCRIPCION,C.CCONSDESCRIPCION,J.TIPOBLOQ,K.CCONSDESCRIPCION,SUBSTRING(J.CCTACOD,9,1)"
        
    ElseIf psTipAho = gCapCTS Then
    
        sSql = " SELECT A.CAGEDESCRIPCION,PERSONERIA=C.CCONSDESCRIPCION,J.TIPOBLOQ,K.CCONSDESCRIPCION, "
        sSql = sSql & "  TOTALCNT=Sum (J.NSALDCNT), TOTALDISP=Sum(J.NSALDDISP)"
        sSql = sSql & " ,MONEDA= SUBSTRING(J.CCTACOD,9,1) ,TOTALPORVAL= Sum(isnull(h.monto,0)), CT.TIPO"
        sSql = sSql & " From"
        sSql = sSql & " ("
        sSql = sSql & " SELECT C.CCTACOD,"
        sSql = sSql & " TIPOBLOQ=c.ntpobloqueo,"
        sSql = sSql & " C.NSALDCNT , C.NSALDDISP"
        sSql = sSql & "  FROM CAPSALDOSDIARIOS C"
        sSql = sSql & " WHERE C.CCTACOD LIKE '108__234%'"
        sSql = sSql & " AND CONVERT(CHAR(8),C.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "'"
        sSql = sSql & " ) J"
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=J.CCTACOD "
        sSql = sSql & " JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=2007 AND NCONSVALOR IN (3,15))K ON K.NCONSVALOR=J.TIPOBLOQ"
        sSql = sSql & " JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION FROM CAPTACIONES C"
        sSql = sSql & " JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA )C ON C.CCTACOD=J.CCTACOD"
        sSql = sSql & " JOIN (SELECT TIPO=CASE WHEN CCODINST='1089800000272' THEN 'CONVENIO' ELSE 'EXTERNO' END ,CCTACOD FROM  CAPTACCTS ) Ct ON Ct.CCTACOD=J.CCTACOD"
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(J.CCTACOD,4,2)"
        sSql = sSql & " GROUP BY A.CAGEDESCRIPCION ,SUBSTRING(J.CCTACOD,9,1), C.CCONSDESCRIPCION,J.TIPOBLOQ,K.CCONSDESCRIPCION,ct.tipo"
        
    End If
    
    If RSTMP.State = adStateOpen Then RSTMP.Close

    oCon.AbreConexion
    Set RSTMP = oCon.CargaRecordSet(sSql)
    
    lsRTFSdo = ""
    If RSTMP.EOF And RSTMP.BOF Then
       lscad = ""
       GeneraConsolidadaBloqueadasCierre = lsRTFSdo
    ElseIf psTipAho = gCapAhorros Then
       PrtSaldosCierreConsolidada RSTMP, nTipo, psFchPro, 2, CStr(psTipAho)
       GeneraConsolidadaBloqueadasCierre = lsRTFSdo
    ElseIf psTipAho = gCapPlazoFijo Then
       PrtSaldosCierreConsolidada RSTMP, nTipo, psFchPro, 2, CStr(psTipAho)
       GeneraConsolidadaBloqueadasCierre = lsRTFSdo
    ElseIf psTipAho = gCapCTS Then
       PrtSaldosCierreConsolidada RSTMP, nTipo, psFchPro, 2, CStr(psTipAho)
       GeneraConsolidadaBloqueadasCierre = lsRTFSdo
    End If
    oCon.CierraConexion
    
    Set oCon = Nothing
                                              
End Function


Public Function GeneraConsolidadaInactivasCierre(ByVal psTipAho As Producto, _
                                              ByVal psFchPro As Date, _
                                              ByVal psMoneda As String, _
                                              ByVal pnTipo As Integer) As String
                                              
    Dim sSql As String
    Dim RSTMP As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String, lscad As String
    Dim nTipo As Integer
        
'    If psAgecod = "" Then
'        sqlAdd = ""
'    ElseIf psAgecod <> "" Then
'        sqlAdd = " And CS.cCtaCod Like '___" & psAgecod & "%'"
'    End If
    
'    If psMoneda <> "" Then
'        sqlAdd = sqlAdd & " and substring(cs.cctacod,9,1)='" & psMoneda & "'"
'    End If
    
    lsMoneda = IIf(psMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    nTipo = 1
    
    If psTipPer = 0 Then
            nTipo = 0
    End If
    
    
    If pnTipo = 3 Then
          
        sSql = " SELECT  A.CAGEDESCRIPCION,PERSONERIA=C.CCONSDESCRIPCION ,"
        sSql = sSql & " TOTALCNT=SUM(CS.NSALDCNT),TOTALDISP=SUM(CS.NSALDDISP) ,"
        sSql = sSql & " MONEDA=SUBSTRING(cs.CCTACOD,9,1) ,TOTALPORVAL=SUM(ISNULL(H.MONTO,0)) "
        sSql = sSql & " FROM CAPSALDOSDIARIOS CS "
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2) "
        sSql = sSql & " JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION FROM CAPTACIONES C "
        sSql = sSql & " JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA ) C ON C.CCTACOD=CS.CCTACOD "
        sSql = sSql & " WHERE CS.CCTACOD LIKE '108__232%' AND CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' and cs.binactiva=1 "
        sSql = sSql & " AND  DATEDIFF(dd,CS.DULTCONTACTO,'" & Format(psFchPro, "mm/dd/yyyy") & "' )>=360"
        sSql = sSql & " AND  DATEDIFF(dd,CS.DULTCONTACTO,'" & Format(psFchPro, "mm/dd/yyyy") & "' )<720"
        sSql = sSql & " GROUP BY A.CAGEDESCRIPCION,substring(cs.cctacod,9,1),C.NPERSONERIA,C.CCONSDESCRIPCION"

        
    ElseIf pnTipo = 4 Then
    
        sSql = " SELECT A.CAGEDESCRIPCION,PERSONERIA=C.CCONSDESCRIPCION, "
        sSql = sSql & " TOTALCNT=SUM(CS.NSALDCNT),TOTALDISP=SUM(CS.NSALDDISP),"
        sSql = sSql & " MONEDA=SUBSTRING(cs.CCTACOD,9,1) ,TOTALPORVAL=SUM(ISNULL(H.MONTO,0))"
        sSql = sSql & " FROM CAPSALDOSDIARIOS CS"
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2)"
        sSql = sSql & " JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION FROM CAPTACIONES C"
        sSql = sSql & " JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA ) C ON C.CCTACOD=CS.CCTACOD"
        sSql = sSql & " WHERE CS.CCTACOD LIKE '108__232%' AND CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' and cs.binactiva=1"
        sSql = sSql & " AND  DATEDIFF(dd,CS.DULTCONTACTO,'" & Format(psFchPro, "mm/dd/yyyy") & "' )>=720"
        sSql = sSql & " GROUP BY A.CAGEDESCRIPCION,substring(cs.cctacod,9,1),C.NPERSONERIA,C.CCONSDESCRIPCION"

        
    End If
    
    If RSTMP.State = adStateOpen Then RSTMP.Close

    oCon.AbreConexion
    Set RSTMP = oCon.CargaRecordSet(sSql)
    
    lsRTFSdo = ""
    If RSTMP.EOF And RSTMP.BOF Then
       lscad = ""
       GeneraConsolidadaInactivasCierre = lsRTFSdo
    ElseIf psTipAho = gCapAhorros Then
       PrtSaldosCierreConsolidada RSTMP, nTipo, psFchPro, pnTipo, CStr(psTipAho)
       GeneraConsolidadaInactivasCierre = lsRTFSdo
'    ElseIf psTipAho = gCapPlazoFijo Then
'       PrtSaldosCierreConsolidada RSTMP, nTipo, psFchPro
'       GeneraConsolidadaInactivasCierre = lsRTFSdo
'    ElseIf psTipAho = gCapCTS Then
'        PrtSaldosCierreConsolidada RSTMP, nTipo, psFchPro
'        GeneraConsolidadaInactivasCierre = lsRTFSdo
    End If
    oCon.CierraConexion
    
    Set oCon = Nothing
                                              


End Function

Public Function GeneraConsolidadaProvisionCierre(ByVal psTipAho As Producto, _
                                              ByVal psFchPro As Date, _
                                              ByVal psMoneda As String, _
                                              ByVal pnTipo As Integer) As String
                                              
    Dim sSql As String
    Dim RSTMP As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String, lscad As String
    Dim nTipo As Integer
        
'    If psAgecod = "" Then
'        sqlAdd = ""
'    ElseIf psAgecod <> "" Then
'        sqlAdd = " And CS.cCtaCod Like '___" & psAgecod & "%'"
'    End If
    

    
    lsMoneda = IIf(psMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    nTipo = 1
    
    If psTipPer = 0 Then
            nTipo = 0
    End If
      
        sSql = " SELECT  A.CAGEDESCRIPCION,PERSONERIA=C.CCONSDESCRIPCION,"
        sSql = sSql & "   TOTALCNT=SUM(CS.NSALDCNT),TOTALDISP=SUM(CS.NSALDDISP),TOTALPORVAL=SUM(ISNULL(H.MONTO,0)), "
        sSql = sSql & "   MONEDA=SUBSTRING(cs.CCTACOD,9,1),"
        sSql = sSql & "   INTERESDEV = Sum(CS.nInteres)"
        sSql = sSql & "   FROM CAPSALDOSDIARIOS CS"
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
        sSql = sSql & "   JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION FROM CAPTACIONES C"
        sSql = sSql & "   JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA ) C ON C.CCTACOD=CS.CCTACOD"
        sSql = sSql & "   JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2)"
        sSql = sSql & "   WHERE CONVERT(CHAR(8),DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' AND CS.CCTACOD LIKE '108__233%'"
        sSql = sSql & "   GROUP BY A.CAGEDESCRIPCION,substring(cs.cctacod,9,1),C.NPERSONERIA,C.CCONSDESCRIPCION"
        
    
    
    If RSTMP.State = adStateOpen Then RSTMP.Close

    oCon.AbreConexion
    Set RSTMP = oCon.CargaRecordSet(sSql)
    
    lsRTFSdo = ""
    If RSTMP.EOF And RSTMP.BOF Then
       lscad = ""
       GeneraConsolidadaProvisionCierre = lsRTFSdo
       
    ElseIf psTipAho = gCapPlazoFijo Then
       PrtSaldosCierreConsolidada RSTMP, nTipo, psFchPro, pnTipo, CStr(psTipAho)
       GeneraConsolidadaProvisionCierre = lsRTFSdo
       
    End If
    oCon.CierraConexion
    
    Set oCon = Nothing


End Function


Public Function GeneraConsolidadaSaldosCierre(ByVal psTipAho As Producto, _
                                              ByVal psFchPro As Date, _
                                              ByVal psMoneda As String) As String
                                              
    Dim sSql As String
    Dim RSTMP As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String, lscad As String
    Dim nTipo As Integer
    
    lsMoneda = IIf(psMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    nTipo = 1
    
    If psTipPer = 0 Then
            nTipo = 0
    End If
        
    If psTipAho = gCapAhorros Then
          
        sSql = " SELECT  A.CAGEDESCRIPCION,"
        sSql = sSql & " MONEDA=SUBSTRING(CS.CCTACOD,9,1)   ,"
        sSql = sSql & " TOTALCNT=SUM(CS.NSALDCNT),TOTALDISP=SUM(CS.NSALDDISP), TOTALPORVAL=SUM(ISNULL(H.MONTO,0)),"
        sSql = sSql & " G.NPERSONERIA,"
        sSql = sSql & " Personeria = G.CCONSDESCRIPCION"
        sSql = sSql & " FROM CAPSALDOSDIARIOS CS"
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
        sSql = sSql & " join ( select * from  captaciones  c join constante k on k.nconsvalor=c.npersoneria where k.nconscod=1002) g on g.cctacod=cs.cctacod"
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2)"
        sSql = sSql & " WHERE CS.CCTACOD LIKE '108__232%' AND CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "'" & sqlAdd
        sSql = sSql & " GROUP BY SUBSTRING(CS.CCTACOD,9,1),A.CAGEDESCRIPCION,G.CCONSDESCRIPCION ,G.NPERSONERIA"
        sSql = sSql & " ORDER BY A.CAGEDESCRIPCION,SUBSTRING(CS.CCTACOD,9,1),G.NPERSONERIA"
        
    ElseIf psTipAho = gCapPlazoFijo Then
    
        sSql = " SELECT  A.CAGEDESCRIPCION,"
        sSql = sSql & " MONEDA=SUBSTRING(CS.CCTACOD,9,1)  ,"
        sSql = sSql & " TOTALCNT=SUM(CS.NSALDCNT),TOTALDISP=SUM(CS.NSALDDISP),  TOTALPORVAL=SUM(ISNULL(H.MONTO,0)),"
        sSql = sSql & " G.NPERSONERIA,"
        sSql = sSql & " Personeria = G.CCONSDESCRIPCION"
        sSql = sSql & " FROM CAPSALDOSDIARIOS CS"
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
        sSql = sSql & " join ( select * from  captaciones  c join constante k on k.nconsvalor=c.npersoneria where k.nconscod=1002) g on g.cctacod=cs.cctacod"
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2)"
        sSql = sSql & " WHERE CS.CCTACOD LIKE '108__233%' AND CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "'" & sqlAdd
        sSql = sSql & " GROUP BY SUBSTRING(CS.CCTACOD,9,1),A.CAGEDESCRIPCION,G.CCONSDESCRIPCION ,G.NPERSONERIA"
        sSql = sSql & " ORDER BY A.CAGEDESCRIPCION,SUBSTRING(CS.CCTACOD,9,1),G.NPERSONERIA"

        
    ElseIf psTipAho = gCapCTS Then
    
        sSql = " SELECT  A.CAGEDESCRIPCION,"
        sSql = sSql & " MONEDA= SUBSTRING(CS.CCTACOD,9,1) ,"
        sSql = sSql & " TOTALCNT=SUM(CS.NSALDCNT),TOTALDISP=SUM(CS.NSALDDISP),  TOTALPORVAL=SUM(ISNULL(H.MONTO,0)), "
        sSql = sSql & " G.NPERSONERIA,"
        sSql = sSql & " PERSONERIA=G.CCONSDESCRIPCION,TIPO"
        sSql = sSql & " FROM CAPSALDOSDIARIOS CS"
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
        sSql = sSql & " join ( select * from  captaciones  c join constante k on k.nconsvalor=c.npersoneria where k.nconscod=1002) g on g.cctacod=cs.cctacod"
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2)"
        sSql = sSql & " JOIN (SELECT TIPO=CASE WHEN CCODINST='1089800000272' THEN 'CONVENIO' ELSE 'EXTERNO' END ,CCTACOD FROM  CAPTACCTS ) C ON C.CCTACOD=CS.CCTACOD"
        sSql = sSql & " WHERE CS.CCTACOD LIKE '108__234%' AND CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "'" & sqlAdd
        sSql = sSql & " GROUP BY SUBSTRING(CS.CCTACOD,9,1),A.CAGEDESCRIPCION,G.CCONSDESCRIPCION ,G.NPERSONERIA,C.TIPO"
        sSql = sSql & " ORDER BY A.CAGEDESCRIPCION,SUBSTRING(CS.CCTACOD,9,1),G.NPERSONERIA"

        
    End If
    
    If RSTMP.State = adStateOpen Then RSTMP.Close

    oCon.AbreConexion
    Set RSTMP = oCon.CargaRecordSet(sSql)
    
    lsRTFSdo = ""
    If RSTMP.EOF And RSTMP.BOF Then
       lscad = ""
       GeneraConsolidadaSaldosCierre = lsRTFSdo
    ElseIf psTipAho = gCapAhorros Then
       PrtSaldosCierreConsolidada RSTMP, nTipo, psFchPro, 1, CStr(psTipAho)
       GeneraConsolidadaSaldosCierre = lsRTFSdo
    ElseIf psTipAho = gCapPlazoFijo Then
       PrtSaldosCierreConsolidada RSTMP, nTipo, psFchPro, 1, CStr(psTipAho)
       GeneraConsolidadaSaldosCierre = lsRTFSdo
    ElseIf psTipAho = gCapCTS Then
       PrtSaldosCierreConsolidada RSTMP, nTipo, psFchPro, 1, CStr(psTipAho)
       GeneraConsolidadaSaldosCierre = lsRTFSdo
    End If
    oCon.CierraConexion
    
    Set oCon = Nothing
                                              


End Function


Private Function PrtSaldosCierreConsolidada(rsData As ADODB.Recordset, Optional nTipo As Integer = 1, Optional pdCIerre As Date, Optional nrep As Integer = 1, Optional sProd As String)

    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lnTotDep As Double, lnTotRet As Double
    Dim lsCodPro As String, lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsSubTit As String, lnCntCta As Integer
    Dim lnSdoCnt As Double, lnSdoDis As Double
    Dim lnCapita As Double, lsCodCta As String
    Dim lnCapiFi As Double, lnSdDiFi As Double, lnSdDiFiDol As Double, lnSdCnFi As Double, lnSdCnFiDol As Double
    Dim lnCheEnV As Double, lnCheEnVFi As Double, lnCheEnVFiDol As Double
    Dim lnCtaPag As Integer, lnTotCta As Integer
    Dim lnIntMes As Double, lnSdInFi As Double, lnSdInFiDol As Double
    Dim lnCntRel As Integer
    Dim lbCtaIde As Boolean
    Dim lnIntCap As Double
    Dim lnIntDev As Double, lnCalInt As Double
    Dim lbCieMes As Boolean
    Dim lnNumDia As Integer, CCodage As String, cMoneda As String
    Dim lsCuenta As String
    Dim codigocta As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    If CierreRealizado(2) Then
        lbCieMes = True
    Else
        lbCieMes = False
    End If
    cMoneda = ""
    codigocta = ""
    lsNumPag = ""
    lnLinPag = 65
    lnCarLin = 105
    If nrep = 1 Then
        lsTitRp1 = "REPORTE CONSOLIDADO DE SALDOS DE CUENTA(S) AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
    ElseIf nrep = 2 Then
        lsTitRp1 = "REPORTE CONSOLIDADO DE SALDOS DE CUENTA(S) BLOQUEADAS AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
    ElseIf nrep = 3 Then
        lsTitRp1 = "REPORTE CONSOLIDADO DE SALDOS DE CUENTA(S) INACTIVAS(360-720 dias) AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
    ElseIf nrep = 4 Then
        lsTitRp1 = "REPORTE CONSOLIDADO DE SALDO DE CUENTA(S) INACTIVAS(mas de 720 dias) AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
    ElseIf nrep = 5 Then
        lsTitRp1 = "REPORTE CONSOLIDADO DE PROVISON DE CUENTA(S) AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
            
    End If
    
    
    lsTitRp2 = ""
    lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
    lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
    lnCntPag = 0
    lbCtaIde = False
    
    With rsData
         Do While Not .EOF
                  
            Select Case sProd
               Case Producto.gCapAhorros
                    lnCarLin = 132
                    lsTitRp2 = " AHORROS "
                    
               Case Producto.gCapPlazoFijo
                    lnCarLin = 119
                    lsTitRp2 = " PLAZO FIJO "
                    
               Case Producto.gCapCTS
                    lnCarLin = 132
                    lsTitRp2 = " CTS "
                    
            End Select
            
            If CCodage <> Trim(!cAgeDescripcion) Or (CCodage = Trim(!cAgeDescripcion) And cMoneda <> !Moneda) Then
               
            
               If lsNumPag <> "" Then
                  If lnSdoDis <> 0 Or lnCapita <> 0 Then
                  
                   
                     
                     lsRTFSdo = lsRTFSdo & Space(10) & "TOTALES " & IIf(cMoneda = 1, "SOLES  ", "DOLARES") & Space(8) & ":"
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 14, True, 11, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 14, True, 11, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 14, True, 11, 2) & " "
                                                                   
                        If nrep = 5 Then
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                        Else
                            lsRTFSdo = lsRTFSdo & Chr(10)
                        End If
                     If CCodage <> Trim(!cAgeDescripcion) Then
                        lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                     End If
                   End If
                     'lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                     lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
                End If
                  
                  
             End If
               
               lnCntPag = lnCntPag + 1
            
            If lnLinPag >= 65 Then
                lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
                lsRTFSdo = lsRTFSdo & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1, lsTitRp2, "", lsNumPag) & oImp.gPrnSaltoLinea
                lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                        
                    If sProd = CStr(Producto.gCapPlazoFijo) Then
                             
                             lsRTFSdo = lsRTFSdo & "        AGENCIA          "
                             lsRTFSdo = lsRTFSdo & " MONEDA   "
                             lsRTFSdo = lsRTFSdo & "    SALDO CONT "
                             lsRTFSdo = lsRTFSdo & "    SALDO DISP "
                       
                       If nrep <> 5 Then
                             lsRTFSdo = lsRTFSdo & "     CHEQUES "
                       End If
                       If nrep = 5 Then
                             lsRTFSdo = lsRTFSdo & "   CHEQUES   "
                             lsRTFSdo = lsRTFSdo & "   INT. DEV. "
                       End If
                             lsRTFSdo = lsRTFSdo & "   PERSONERIA     " & Chr(10)
                             
                    Else
                             lsRTFSdo = lsRTFSdo & "        AGENCIA          "
                             lsRTFSdo = lsRTFSdo & " MONEDA   "
                             lsRTFSdo = lsRTFSdo & "    SALDO CONT "
                             lsRTFSdo = lsRTFSdo & "    SALDO DISP "
                             lsRTFSdo = lsRTFSdo & "     CHEQUES "
                             If sProd <> Producto.gCapCTS Then
                                lsRTFSdo = lsRTFSdo & "   PERSONERIA     " & Chr(10)
                             Else
                                lsRTFSdo = lsRTFSdo & "   PERSONERIA     "
                                lsRTFSdo = lsRTFSdo & "  TIPO  " & Chr(10)
                             End If
                                            
                    End If
                             lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea         ' hasta 160 caracteres x línea
                             lnLinPag = 9
            End If
            
            lnCntRel = 0


               lbCtaIde = False
               lnCtaPag = lnCtaPag + 1: lnTotCta = lnTotCta + 1
                              
               If nrep = 5 Then
                        
                       lsRTFSdo = lsRTFSdo & IIf(CCodage = Trim(!cAgeDescripcion), "           ''       ", Trim(!cAgeDescripcion)) & " "
                       lsRTFSdo = lsRTFSdo & Space(25 - Len(IIf(CCodage = Trim(!cAgeDescripcion), "           ''       ", Trim(!cAgeDescripcion)))) & IIf(!Moneda = 1, "SOLES  ", "DOLARES") & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!TOTALCNT, 14, True, 11, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!TOTALDISP, 14, True, 11, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!TOTALPORVAL, 14, True, 11, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!INTERESDEV, 14, True, 11, 2) & "  "
                       lsRTFSdo = lsRTFSdo & !Personeria & " " & Chr(10)
                                                   
                       lnIntMes = lnIntMes + !INTERESDEV
                       If !Moneda = 1 Then
                        lnSdInFi = lnSdInFi + !INTERESDEV
                       Else
                         lnSdInFiDol = lnSdInFiDol + !INTERESDEV
                       End If
                        
                       lnSdoDis = lnSdoDis + !TOTALDISP
                       If !Moneda = 1 Then
                        lnSdDiFi = lnSdDiFi + !TOTALDISP
                       Else
                        lnSdDiFiDol = lnSdDiFiDol + !TOTALDISP
                       End If
                      
                       lnSdoCnt = lnSdoCnt + !TOTALCNT
                       If !Moneda = 1 Then
                        lnSdCnFi = lnSdCnFi + !TOTALCNT
                       Else
                         lnSdCnFiDol = lnSdCnFiDol + !TOTALCNT
                       End If
                       
                       lnCheEnV = lnCheEnV + !TOTALPORVAL
                       If !Moneda = 1 Then
                         lnCheEnVFi = lnCheEnVFi + !TOTALPORVAL
                       Else
                           lnCheEnVFiDol = lnCheEnVFiDol + !TOTALPORVAL
                       End If
                
                Else
                       lsRTFSdo = lsRTFSdo & IIf(CCodage = Trim(!cAgeDescripcion), "           ''       ", Trim(!cAgeDescripcion)) & " "
                       lsRTFSdo = lsRTFSdo & Space(25 - Len(IIf(CCodage = Trim(!cAgeDescripcion), "           ''       ", Trim(!cAgeDescripcion)))) & IIf(!Moneda = 1, "SOLES  ", "DOLARES") & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!TOTALCNT, 14, True, 11, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!TOTALDISP, 14, True, 11, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!TOTALPORVAL, 14, True, 11, 2) & "  "
                       If sProd <> Producto.gCapCTS Then
                          lsRTFSdo = lsRTFSdo & !Personeria & " " & Chr(10)
                       ElseIf sProd = Producto.gCapCTS Then
                          lsRTFSdo = lsRTFSdo & !Personeria & " "
                          lsRTFSdo = lsRTFSdo & !Tipo & " " & Chr(10)
                       End If
                          
                
                       lnSdoDis = lnSdoDis + !TOTALDISP
                       If !Moneda = 1 Then
                        lnSdDiFi = lnSdDiFi + !TOTALDISP
                       Else
                        lnSdDiFiDol = lnSdDiFiDol + !TOTALDISP
                       End If
                      
                       lnSdoCnt = lnSdoCnt + !TOTALCNT
                       If !Moneda = 1 Then
                        lnSdCnFi = lnSdCnFi + !TOTALCNT
                       Else
                        lnSdCnFiDol = lnSdCnFiDol + !TOTALCNT
                       End If
                       
                       lnCheEnV = lnCheEnV + !TOTALPORVAL
                       If !Moneda = 1 Then
                         lnCheEnVFi = lnCheEnVFi + !TOTALPORVAL
                       Else
                         lnCheEnVFiDol = lnCheEnVFiDol + !TOTALPORVAL
                       End If
                
                End If
               
               

            lnCntCta = lnCntCta + 1
            lnLinPag = lnLinPag + lnCntRel + 1

               
            CCodage = Trim(!cAgeDescripcion)
            cMoneda = !Moneda
            .MoveNext
         Loop
    End With
    If rsData.EOF Then
       
       
       lsRTFSdo = lsRTFSdo & Space(10) & "TOTALES " & IIf(cMoneda = 1, "SOLES  ", "DOLARES") & Space(8) & ":"
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 14, True, 11, 2) & " "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 14, True, 11, 2) & " "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 14, True, 11, 2) & " "
                                                                   
        If nrep = 5 Then
            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 14, True, 11, 2) & oImp.gPrnSaltoLinea
        Else
            lsRTFSdo = lsRTFSdo & Chr(10)
        End If

       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Total Registros en Soles          "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 14, True, 11, 2) & " "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 14, True, 11, 2) & " "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 14, True, 11, 2) & " "
          If nrep <> 5 Then
            lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoLinea
          End If
          If nrep = 5 Then
            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 14, True, 11, 2) & oImp.gPrnSaltoLinea
          End If
          
       'lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Total Registros en Dólares        "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFiDol)), 14, True, 11, 2) & " "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFiDol)), 14, True, 11, 2) & " "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFiDol)), 14, True, 11, 2) & " "
          If nrep <> 5 Then
            lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoLinea
          End If
          If nrep = 5 Then
            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFiDol)), 14, True, 11, 2) & oImp.gPrnSaltoLinea
          End If
      
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
       lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
       lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
    End If
    Set ofunc = Nothing
End Function


Public Function GeneraSaldosCierre(ByVal psTipAho As Producto, ByVal psTipPer As Integer, _
                                   ByVal psFchPro As Date, ByVal psAgeCod As String, _
                                   ByVal psMoneda As String, Optional bexternos As Boolean = False) As String
                             
    Dim sSql As String
    Dim RSTMP As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String, lscad As String
    Dim nTipo As Integer
        
    If psAgeCod = "" Then
        sqlAdd = ""
    ElseIf psAgeCod <> "" Then
        sqlAdd = " And CS.cCtaCod Like '___" & psAgeCod & "%'"
    End If
    
    If psMoneda <> "" Then
        sqlAdd = sqlAdd & " and substring(cs.cctacod,9,1)='" & psMoneda & "'"
    End If
    
    lsMoneda = IIf(psMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    nTipo = 1
    
    If psTipPer = 0 Then
            nTipo = 0
    End If
    
    If psTipAho = gCapCTS Then
         If bexternos = False Then
            sqlAdd = sqlAdd & " and c.tipo='CONVENIO' "
         Else
            sqlAdd = sqlAdd & " and c.tipo='EXTERNO' "
         End If
    End If
    
    
    lsPerson = ""
    Select Case psTipPer
            Case PersPersoneria.gPersonaNat
                 lsPerson = "PERSONA NATURAL"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurSFL
                 lsPerson = "PERSONA JUR. SIN FINES DE LUCRO"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFL
                 lsPerson = "PERSONA JUR. CON FINES DE LUCRO"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLCMAC
                 lsPerson = "CAJAS MUNICIPALES"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLCRAC
                 lsPerson = "CAJAS RURALES"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLFONCODES
                 lsPerson = "FONCODES"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLCooperativa
                 lsPerson = "COOPERATIVA"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLEdpyme
                 lsPerson = "EDPYME"
                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
    End Select
        
    
    If psTipAho = gCapAhorros Then
          
        sSql = " SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=cs.cctacod WHERE PP.NPRDPERSRELAC=10 ), "
        sSql = sSql & " a.cagecod,A.CAGEDESCRIPCION,CS.cCtaCod , CS.NSALDCNT, CS.NSALDDISP, CS.nInteres "
        sSql = sSql & " ,PERSONERIA=G.CCONSDESCRIPCION , "
        sSql = sSql & " MONEDA=CASE WHEN SUBSTRING(CS.CCTACOD,9,1)=1 THEN 'SOLES' ELSE 'DOLARES' END , CA.BORDPAG, g.npersoneria ,PORVALORIZAR=ISNULL(H.MONTO,0)"
        sSql = sSql & " FROM CAPSALDOSDIARIOS CS "
        sSql = sSql & " JOIN CAPTACAHORROs CA ON CA.CCTACOD=CS.CCTACOD "
        sSql = sSql & " join ( select * from  captaciones  c join constante k on k.nconsvalor=c.npersoneria where k.nconscod=1002) g on g.cctacod=cs.cctacod "
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2) "
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
        sSql = sSql & " WHERE CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' and substring(cs.cctacod,6,3)='" & psTipAho & "'" & sqlAdd
        sSql = sSql & " ORDER BY  a.cagecod,CA.BORDPAG ,g.npersoneria ,moneda,  cpersnombre ,CS.CCTACOD "
        
    ElseIf psTipAho = gCapPlazoFijo Then
    
        sSql = " SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=cs.cctacod WHERE PP.NPRDPERSRELAC=10 ), "
        sSql = sSql & " a.cagecod,A.CAGEDESCRIPCION,CS.cCtaCod , CS.NSALDCNT, CS.NSALDDISP, CS.nInteres "
        sSql = sSql & " ,PERSONERIA=G.CCONSDESCRIPCION , "
        sSql = sSql & " MONEDA=CASE WHEN SUBSTRING(CS.CCTACOD,9,1)=1 THEN 'SOLES' ELSE 'DOLARES' END , g.npersoneria ,PORVALORIZAR=ISNULL(H.MONTO,0)"
        sSql = sSql & " FROM CAPSALDOSDIARIOS CS "
        sSql = sSql & " join ( select * from  captaciones  c join constante k on k.nconsvalor=c.npersoneria where k.nconscod=1002) g on g.cctacod=cs.cctacod "
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2) "
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
        sSql = sSql & " WHERE CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' and substring(cs.cctacod,6,3)='" & psTipAho & "'" & sqlAdd
        sSql = sSql & " ORDER BY a.cagecod,g.npersoneria ,moneda,  cpersnombre ,CS.CCTACOD "
        
    ElseIf psTipAho = gCapCTS Then
    
        sSql = " SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=cs.cctacod WHERE PP.NPRDPERSRELAC=10 ), "
        sSql = sSql & " a.cagecod,A.CAGEDESCRIPCION,CS.cCtaCod , CS.NSALDCNT, CS.NSALDDISP, CS.nInteres "
        sSql = sSql & " ,PERSONERIA=G.CCONSDESCRIPCION , "
        sSql = sSql & " MONEDA=CASE WHEN SUBSTRING(CS.CCTACOD,9,1)=1 THEN 'SOLES' ELSE 'DOLARES' END,C.TIPO , g.npersoneria ,PORVALORIZAR=ISNULL(H.MONTO,0)"
        sSql = sSql & " FROM CAPSALDOSDIARIOS CS "
        sSql = sSql & " JOIN (SELECT TIPO=CASE WHEN CCODINST='1089800000272' THEN 'CONVENIO' ELSE 'EXTERNO' END ,CCTACOD FROM  CAPTACCTS ) C ON C.CCTACOD=CS.CCTACOD "
        sSql = sSql & " join ( select * from  captaciones  c join constante k on k.nconsvalor=c.npersoneria where k.nconscod=1002) g on g.cctacod=cs.cctacod "
        sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2) "
        sSql = sSql & " Left Join "
        sSql = sSql & "        ( "
        sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
        sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
        sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
        sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
        sSql = sSql & " GROUP BY DC.CCTACOD "
        sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
        sSql = sSql & " WHERE CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' and substring(cs.cctacod,6,3)='" & psTipAho & "'" & sqlAdd
        sSql = sSql & " ORDER BY a.cagecod,C.TIPO,moneda,  cpersnombre ,CS.CCTACOD "
        
    End If
    
    If RSTMP.State = adStateOpen Then RSTMP.Close

    oCon.AbreConexion
    Set RSTMP = oCon.CargaRecordSet(sSql)
    
    lsRTFSdo = ""
    If RSTMP.EOF And RSTMP.BOF Then
       lscad = ""
       GeneraSaldosCierre = lsRTFSdo
    ElseIf psTipAho = gCapAhorros Then
       PrtSaldosCierre RSTMP, nTipo, psFchPro
       GeneraSaldosCierre = lsRTFSdo
    ElseIf psTipAho = gCapPlazoFijo Then
       PrtSaldosCierre RSTMP, nTipo, psFchPro
       GeneraSaldosCierre = lsRTFSdo
    ElseIf psTipAho = gCapCTS Then
        PrtSaldosCierre RSTMP, nTipo, psFchPro
        GeneraSaldosCierre = lsRTFSdo
    End If
    oCon.CierraConexion
    
    Set oCon = Nothing
                             
End Function





Public Function GeneraInactivasCierre(psTipAho As Producto, psTipPer As Integer, psTipMon As Moneda, _
                                      psFchPro As Date, ByVal psAgeCod As String, pnTipo As Integer) As String

                         
    Dim sSql As String
    Dim RSTMP As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String, nTipo As Integer
    
        
    If lsAgeCod = "" Then
        sqlAdd = ""
    ElseIf lsAgeCod <> "" Then
        sqlAdd = " And CS.cCtaCod Like '___" & lsAgeCod & "%'"
    End If
    
    If psMoneda <> "" Then
        If sqlAdd = "" Then
            sqlAdd = sqlAdd & "  substring(J.cctacod,9,1)='" & psMoneda & "'"
        Else
            sqlAdd = sqlAdd & " and substring(J.cctacod,9,1)='" & psMoneda & "'"
        End If
    End If
    
    
    lsMoneda = IIf(psTipMon = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    
    
    oCon.AbreConexion
    lsRTFSdo = ""
    
    lsPerson = ""
    Select Case psTipPer
        Case PersPersoneria.gPersonaNat
            lsPerson = "PERSONA NATURAL"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurSFL
            lsPerson = "PERSONA JUR. SIN FINES DE LUCRO"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFL
            lsPerson = "PERSONA JUR. CON FINES DE LUCRO"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCMAC
            lsPerson = "CAJAS MUNICIPALES"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCRAC
            lsPerson = "CAJAS RURALES"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLFONCODES
             lsPerson = "FONCODES"
             sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCooperativa
            lsPerson = "COOPERATIVA"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLEdpyme
            lsPerson = "EDPYME"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
    End Select
    
    If psTipPer = 0 Then
            nTipo = 0
    End If
          
          
    If pnTipo = 3 Then
            sSql = " SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=cs.cctacod ) "
            sSql = sSql & " ,a.cagecod   ,A.CAGEDESCRIPCION,CS.CCTACOD,PERSONERIA=C.CCONSDESCRIPCION, c.npersoneria,"
            sSql = sSql & "     CS.NSALDCNT,CS.NSALDDISP,MONEDA=case when substring(cs.cctacod,9,1)=1 then 'SOLES' ELSE 'DOLARES' END"
            sSql = sSql & " ,Cs.DULTCONTACTO,DIAS=DATEDIFF(dd,Cs.DULTCONTACTO,CAST('" & Format(psFchPro, "mm/dd/yyyy") & "'  AS DATETIME)),PORVALORIZAR=ISNULL(H.MONTO,0) "
            sSql = sSql & " FROM CAPSALDOSDIARIOS CS "
            sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2) "
            sSql = sSql & " JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION FROM CAPTACIONES C "
            sSql = sSql & "        JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA ) C ON C.CCTACOD=CS.CCTACOD "
            sSql = sSql & " Left Join "
            sSql = sSql & "        ( "
            sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
            sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
            sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
            sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
            sSql = sSql & " GROUP BY DC.CCTACOD "
            sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
            sSql = sSql & " WHERE CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' and cs.binactiva=1 and substring(cs.cctacod,9,1)=" & psTipMon
            sSql = sSql & " AND  DATEDIFF(dd,CS.DULTCONTACTO,CAST('" & Format(psFchPro, "mm/dd/yyyy") & "'  AS DATETIME))>=360 "
            sSql = sSql & " AND  DATEDIFF(dd,CS.DULTCONTACTO,CAST('" & Format(psFchPro, "mm/dd/yyyy") & "'   AS DATETIME))<720 " & sqlAdd
            sSql = sSql & "    ORDER BY  a.cagecod,c.npersoneria ,moneda,  cpersnombre ,cs.CCTACOD "
            
    Else
            sSql = " SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=cs.cctacod ) "
            sSql = sSql & " ,a.cagecod   ,A.CAGEDESCRIPCION,CS.CCTACOD,PERSONERIA=C.CCONSDESCRIPCION, c.npersoneria, "
            sSql = sSql & "     CS.NSALDCNT,CS.NSALDDISP,MONEDA=case when substring(cs.cctacod,9,1)=1 then 'SOLES' ELSE 'DOLARES' END"
            sSql = sSql & " ,Cs.DULTCONTACTO,DIAS=DATEDIFF(dd,Cs.DULTCONTACTO,CAST('" & Format(psFchPro, "mm/dd/yyyy") & "'  AS DATETIME)),PORVALORIZAR=ISNULL(H.MONTO,0) "
            sSql = sSql & " FROM CAPSALDOSDIARIOS CS "
            sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2) "
            sSql = sSql & " JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION FROM CAPTACIONES C "
            sSql = sSql & "        JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA ) C ON C.CCTACOD=CS.CCTACOD "
            sSql = sSql & " Left Join "
            sSql = sSql & "        ( "
            sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
            sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
            sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
            sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
            sSql = sSql & " GROUP BY DC.CCTACOD "
            sSql = sSql & " ) H  ON H.CCTACOD=CS.CCTACOD "
            sSql = sSql & " WHERE CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' and cs.binactiva=1 and substring(cs.cctacod,9,1)=" & psTipMon
            sSql = sSql & " AND  DATEDIFF(dd,CS.DULTCONTACTO,CAST('" & Format(psFchPro, "mm/dd/yyyy") & "'  AS DATETIME))>=720 " & sqlAdd
            sSql = sSql & "    ORDER BY  a.cagecod,c.npersoneria ,moneda,  cpersnombre ,cs.CCTACOD "
    
    End If
    
    If sSql = "" Then
       Exit Function
    End If
    If RSTMP.State = adStateOpen Then RSTMP.Close

    Set RSTMP = oCon.CargaRecordSet(sSql)
    
    lsRTFSdo = ""
    
    If RSTMP.EOF And RSTMP.BOF Then
       lsRTFSdo = ""
       GeneraInactivasCierre = lsRTFSdo
    Else
       PrtSaldosCierre RSTMP, nTipo, psFchPro, pnTipo
       GeneraInactivasCierre = lsRTFSdo
    End If

            
            

End Function

Public Function GeneraBloqueadasCierre(ByVal psTipAho As Producto, ByVal psTipPer As Integer, _
                                   ByVal psFchPro As Date, ByVal psAgeCod As String, _
                                   ByVal psMoneda As String, _
                                   Optional ByVal bGeneral As Boolean = False) As String
                             
    Dim sSql As String
    Dim RSTMP As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String, lscad As String
    Dim nTipo As Integer
        
   
   sqlAdd = ""
   
    If psAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = "  J.cCtaCod Like '___" & lsAgeCod & "%'"
    End If
    
    
    If psMoneda <> "" Then
        If sqlAdd = "" Then
            sqlAdd = sqlAdd & "  substring(J.cctacod,9,1)='" & psMoneda & "'"
        Else
            sqlAdd = sqlAdd & " and substring(J.cctacod,9,1)='" & psMoneda & "'"
        End If
    End If
    
    
    lsMoneda = IIf(psMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    nTipo = 1
    
    If psTipPer = 0 Then
            nTipo = 0
    End If
    
'    If psTipAho = gCapCTS Then
'     sqlAdd = sqlAdd & " and pb.nblqmotivo in (3,15) "
'    ElseIf ntipo = 4 Then
'     sqlAdd = sqlAdd & " and pb.nblqmotivo=3 "
'    ElseIf ntipo = 5 Then
'     sqlAdd = sqlAdd & " and pb.nblqmotivo=15 "
'    End If
    
'    If psTipAho = gCapCTS Then
'        If pnTipo = 2 Then
'           If sqlAdd = "" Then
'              sqlAdd = sqlAdd & "  CS.CCODINST='1089800000272' "
'           Else
'              sqlAdd = sqlAdd & " and CS.CCODINST='1089800000272' "
'           End If
'        ElseIf pnTipo = 3 Then
'           If sqlAdd = "" Then
'               sqlAdd = sqlAdd & "  CS.CCODINST<>'1089800000272' "
'           Else
'               sqlAdd = sqlAdd & " and CS.CCODINST<>'1089800000272' "
'           End If
'        End If
'    End If
    
    oCon.AbreConexion
    lsRTFSdo = ""
    
    lsPerson = ""
    Select Case psTipPer
        Case PersPersoneria.gPersonaNat
            lsPerson = "PERSONA NATURAL"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurSFL
            lsPerson = "PERSONA JUR. SIN FINES DE LUCRO"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFL
            lsPerson = "PERSONA JUR. CON FINES DE LUCRO"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCMAC
            lsPerson = "CAJAS MUNICIPALES"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCRAC
            lsPerson = "CAJAS RURALES"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLFONCODES
             lsPerson = "FONCODES"
             sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLCooperativa
            lsPerson = "COOPERATIVA"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
        Case PersPersoneria.gPersonaJurCFLEdpyme
            lsPerson = "EDPYME"
            sqlAdd = sqlAdd & " and C.nPersoneria = '" & psTipPer & "'"
    End Select
    
    sSql = ""
    
    Select Case psTipAho
        Case Producto.gCapAhorros
                  
                sSql = "  SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=J.cctacod WHERE PP.NPRDPERSRELAC=10 ) "
                sSql = sSql & "  ,a.cagecod,A.CAGEDESCRIPCION,J.CCTACOD,PERSONERIA=C.CCONSDESCRIPCION,C.NPERSONERIA ,J.TIPOBLOQ,MOTIVO=K.CCONSDESCRIPCION,J.NSALDCNT,J.NSALDDISP,MONEDA= CASE WHEN SUBSTRING(J.CCTACOD,9,1)=1 THEN 'SOLES' ELSE 'DOLARES' END, J.NINTERES,PORVALORIZAR=ISNULL(H.MONTO,0),C.BORDPAG"
                sSql = sSql & "  From "
                sSql = sSql & "    ( "
                sSql = sSql & "  SELECT C.CCTACOD,"
                sSql = sSql & "        TIPOBLOQ=c.ntpobloqueo ,"
                sSql = sSql & "    C.NSALDCNT , C.NSALDDISP ,C.NINTERES "
                sSql = sSql & "    FROM CAPSALDOSDIARIOS C "
                sSql = sSql & "    WHERE C.CCTACOD LIKE '108__232%'"
                sSql = sSql & "    AND CONVERT(CHAR(8),C.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "'"
                sSql = sSql & "    ) J "
                If bGeneral = False Then
                    sSql = sSql & "    JOIN ( SELECT * FROM CONSTANTE WHERE NCONSCOD=2007 AND NCONSVALOR IN (3,15) )K ON K.NCONSVALOR=J.TIPOBLOQ "
                Else
                    sSql = sSql & "    JOIN ( SELECT * FROM CONSTANTE WHERE NCONSCOD=2007  )K ON K.NCONSVALOR=J.TIPOBLOQ "
                End If
                sSql = sSql & "    JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION,CA.BORDPAG FROM CAPTACIONES C "
                sSql = sSql & "    JOIN CAPTACAHORROS CA ON CA.CCTACOD=C.CCTACOD "
                sSql = sSql & "    JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA ) C ON C.CCTACOD=J.CCTACOD "
                sSql = sSql & "    JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(J.CCTACOD,4,2) "
                sSql = sSql & " Left Join "
                sSql = sSql & "        ( "
                sSql = sSql & " SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
                sSql = sSql & " JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
                sSql = sSql & " JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
                sSql = sSql & " WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
                sSql = sSql & " GROUP BY DC.CCTACOD "
                sSql = sSql & " ) H  ON H.CCTACOD=J.CCTACOD "
                sSql = sSql & IIf(sqlAdd = "", "", " WHERE ") & sqlAdd
                sSql = sSql & " ORDER BY  a.cagecod,c.npersoneria ,moneda,  k.CCONSDESCRIPCION ,cpersnombre , j.CCTACOD "
                              
        Case Producto.gCapPlazoFijo
                    
               sSql = " SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=J.cctacod WHERE PP.NPRDPERSRELAC=10)"
               sSql = sSql & " ,a.cagecod,A.CAGEDESCRIPCION,J.CCTACOD ,PERSONERIA=C.CCONSDESCRIPCION,C.NPERSONERIA ,J.TIPOBLOQ,MOTIVO=K.CCONSDESCRIPCION,J.NSALDCNT,J.NSALDDISP,MONEDA= CASE WHEN SUBSTRING(J.CCTACOD,9,1)=1 THEN 'SOLES' ELSE 'DOLARES' END, J.NINTERES, PORVALORIZAR=ISNULL(H.MONTO,0)"
               sSql = sSql & "  From"
               sSql = sSql & "  ("
               sSql = sSql & "     SELECT C.CCTACOD,"
               sSql = sSql & "     TIPOBLOQ=c.ntpobloqueo,"
               sSql = sSql & "     C.NSALDCNT , C.NSALDDISP ,C.NINTERES "
               sSql = sSql & "     FROM CAPSALDOSDIARIOS C"
               sSql = sSql & "     WHERE C.CCTACOD LIKE '108__233%'"
               sSql = sSql & "     AND CONVERT(CHAR(8),C.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "'"
               sSql = sSql & "     ) J"
               If bGeneral = False Then
                    sSql = sSql & "    JOIN ( SELECT * FROM CONSTANTE WHERE NCONSCOD=2007 AND NCONSVALOR IN (3,15) )K ON K.NCONSVALOR=J.TIPOBLOQ "
               Else
                    sSql = sSql & "    JOIN ( SELECT * FROM CONSTANTE WHERE NCONSCOD=2007  )K ON K.NCONSVALOR=J.TIPOBLOQ "
               End If
               'sSQL = sSQL & "     JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=2007 AND NCONSVALOR IN (3,15))K ON K.NCONSVALOR=J.TIPOBLOQ"
               sSql = sSql & "     JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION FROM CAPTACIONES C"
               sSql = sSql & "            JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA ) C ON C.CCTACOD=J.CCTACOD"
               sSql = sSql & "     JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(J.CCTACOD,4,2)"
               sSql = sSql & " Left Join "
               sSql = sSql & " ( "
               sSql = sSql & "    SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
               sSql = sSql & "    JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
               sSql = sSql & "    JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
               sSql = sSql & "    WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
               sSql = sSql & "    GROUP BY DC.CCTACOD "
               sSql = sSql & "  ) H  ON H.CCTACOD=J.CCTACOD "
               sSql = sSql & IIf(sqlAdd = "", "", " WHERE ") & sqlAdd
               sSql = sSql & " ORDER BY  a.cagecod,c.npersoneria ,moneda , k.CCONSDESCRIPCION ,  cpersnombre , j.CCTACOD "
                      
        Case Producto.gCapCTS
            
               sSql = " SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=J.cctacod WHERE PP.NPRDPERSRELAC=10)"
               sSql = sSql & " ,a.cagecod,A.CAGEDESCRIPCION,J.CCTACOD,PERSONERIA=C.CCONSDESCRIPCION ,C.NPERSONERIA,J.TIPOBLOQ,MOTIVO=K.CCONSDESCRIPCION,J.NSALDCNT,J.NSALDDISP, C.TIPO ,MONEDA= CASE WHEN SUBSTRING(J.CCTACOD,9,1)=1 THEN 'SOLES' ELSE 'DOLARES' END, J.NINTERES, PORVALORIZAR=ISNULL(H.MONTO,0) "
               sSql = sSql & " From"
               sSql = sSql & " ( "
               sSql = sSql & "     SELECT C.CCTACOD,"
               sSql = sSql & "     TIPOBLOQ=c.ntpobloqueo,"
               sSql = sSql & "     C.NSALDCNT , C.NSALDDISP ,C.NINTERES "
               sSql = sSql & "     FROM CAPSALDOSDIARIOS C"
               sSql = sSql & "     WHERE C.CCTACOD LIKE '108__234%'"
               sSql = sSql & "     AND CONVERT(CHAR(8),C.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "'"
               sSql = sSql & "      ) J "
               If bGeneral = False Then
                    sSql = sSql & "    JOIN ( SELECT * FROM CONSTANTE WHERE NCONSCOD=2007 AND NCONSVALOR IN (3,15) )K ON K.NCONSVALOR=J.TIPOBLOQ "
               Else
                    sSql = sSql & "    JOIN ( SELECT * FROM CONSTANTE WHERE NCONSCOD=2007  )K ON K.NCONSVALOR=J.TIPOBLOQ "
               End If
               'sSQL = sSQL & "      JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=2007 AND NCONSVALOR IN (3,15))K ON K.NCONSVALOR=J.TIPOBLOQ "
               sSql = sSql & "      JOIN ( SELECT C.CCTACOD,C.NPERSONERIA,K.CCONSDESCRIPCION, TIPO=CASE WHEN CT.CCODINST='1089800000272' THEN 'CONVENIO' ELSE 'EXTERNO' END FROM CAPTACIONES C "
               sSql = sSql & "             JOIN CAPTACCTS CT ON CT.CCTACOD=C.CCTACOD "
               sSql = sSql & "             JOIN (SELECT * FROM CONSTANTE WHERE NCONSCOD=1002) K ON K.NCONSVALOR=C.NPERSONERIA ) C ON C.CCTACOD=J.CCTACOD "
               sSql = sSql & "      JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(J.CCTACOD,4,2) "
               sSql = sSql & " Left Join "
               sSql = sSql & " ( "
               sSql = sSql & "    SELECT DC.CCTACOD,MONTO=SUM(DC.NMONTO) FROM DOCREC D "
               sSql = sSql & "    JOIN DOCRECCAPTA DC ON DC.CNRODOC=D.CNRODOC AND DC.CPERSCOD=D.CPERSCOD AND DC.CIFCTA=D.CIFCTA "
               sSql = sSql & "    JOIN DOCRECEST DE ON DE.CNRODOC=D.CNRODOC AND DE.CPERSCOD=D.CPERSCOD AND DE.CIFCTA=D.CIFCTA "
               sSql = sSql & "    WHERE CONVERT(CHAR(8),DVALORIZACION,112)>'" & Format(psFchPro, "yyyymmdd") & "' AND DE.NESTADO=1 AND DE.CMOVNRO LIKE '" & Format(psFchPro, "yyyymm") & "%'"
               sSql = sSql & "    GROUP BY DC.CCTACOD "
               sSql = sSql & "  ) H  ON H.CCTACOD=J.CCTACOD "
               sSql = sSql & IIf(sqlAdd = "", "", " WHERE ") & sqlAdd
               sSql = sSql & " ORDER BY  a.cagecod,TIPO , c.npersoneria ,moneda , k.CCONSDESCRIPCION ,  cpersnombre ,j.CCTACOD "
                                
    End Select
    
    If sSql = "" Then
       Exit Function
    End If
    If RSTMP.State = adStateOpen Then RSTMP.Close

    Set RSTMP = oCon.CargaRecordSet(sSql)
    
    lsRTFSdo = ""
    
    If RSTMP.EOF And RSTMP.BOF Then
       lsRTFSdo = ""
       GeneraBloqueadasCierre = lsRTFSdo
    Else
       PrtSaldosCierre RSTMP, nTipo, psFchPro, 2
       GeneraBloqueadasCierre = lsRTFSdo
    End If

End Function

Public Function GeneraSaldos(psTipAho As Producto, psTipPer As Integer, psTipMon As Moneda, _
                             psFchPro As Date, Optional nTipo As Integer = 1, Optional psPersCodEmpresa As String = "") As String
    Dim lsQrySdo As String
    Dim rsQrySdo As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    Dim lsMonedaNum As String
    
    
        
    If lsAgeCod = "" Then
        sqlAdd = ""
    ElseIf lsAgeCod <> "X4" And lsAgeCod <> "X2" Then
        sqlAdd = " And PR.cCtaCod Like '___" & lsAgeCod & "%'"
    End If
    
    If nTipo = 2 Then
        sqlAdd = sqlAdd & " and CAPCTS.CCODINST='1090100012521' "
    ElseIf nTipo = 3 Then
        If psPersCodEmpresa = "" Then
            sqlAdd = sqlAdd & " and CAPCTS.CCODINST<>'1090100012521'  "
        Else
            sqlAdd = sqlAdd & " and CAPCTS.CCODINST= '" & psPersCodEmpresa & "'  "
        End If
    ElseIf nTipo = 6 Then
          sqlAdd = sqlAdd & " and CAPCTS.CCODINST='1090100012521' and pr.nprdestado not in (1100,1200) and pr.cctacod not in (select cctacod from productobloqueos where nblqmotivo in (15,3) and cmovnrodbl is null and substring(cctacod,6,3)='" & Producto.gCapCTS & "') "
    End If
    

    
    oCon.AbreConexion
    lsRTFSdo = ""
    lsMoneda = IIf(psTipMon = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    
    If nTipo <> 5 Then
        Select Case psTipPer
            Case PersPersoneria.gPersonaNat
                 lsPerson = "PERSONA NATURAL"
                 sqlAdd = sqlAdd & " AND CAP.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurSFL
                 lsPerson = "PERSONA JUR. SIN FINES DE LUCRO"
                 sqlAdd = sqlAdd & " AND CAP.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFL
                 lsPerson = "PERSONA JUR. CON FINES DE LUCRO"
                 sqlAdd = sqlAdd & " AND CAP.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLCMAC
                 lsPerson = "CAJAS MUNICIPALES"
                 sqlAdd = sqlAdd & " AND CAP.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLCRAC
                 lsPerson = "CAJAS RURALES"
                 sqlAdd = sqlAdd & " AND CAP.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLFONCODES
                 lsPerson = "BANCOS"
                 sqlAdd = sqlAdd & " AND CAP.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLCooperativa
                 lsPerson = "COOPERATIVA"
                 sqlAdd = sqlAdd & " AND CAP.nPersoneria = '" & psTipPer & "'"
            Case PersPersoneria.gPersonaJurCFLEdpyme
                 lsPerson = "EDPYME"
                 sqlAdd = sqlAdd & " AND CAP.nPersoneria = '" & psTipPer & "'"
            '***Agregado por ELRO el 20111105, según Acta 307-2011/TI-D
            Case PersPersoneria.gPersonaJurCFLFinancieras
                 lsPerson = "FINANCIERA"
                 sqlAdd = sqlAdd & " AND CAP.nPersoneria = '" & psTipPer & "'"
            '***Fin Agregado por ELRO**********************************
        End Select
   End If
    
    
    If nTipo = 5 Then
        lsPerson = "PERS. NATURAL-JUR. SIN FINES LUCRO"
    End If
    
    lsQrySdo = ""
    Select Case psTipAho
         Case Producto.gCapAhorros
            If nTipo = 5 Then
                        
                        lsQrySdo = " SELECT PE.cPersDireccDomicilio,PR.cCtaCod cCodCta, CAPAHO.bOrdPag cOrdPag, CAP.nSaldoDisp AS nSdoDis, PR.nSaldo AS nSdoCnt,"
                        lsQrySdo = lsQrySdo & "  dbo.GetInteresGanado(PR.cCtaCod,'" & Format(psFchPro, ofunf.gsFormatoFecha) & "','S') AS nIntMes, PE.cPersNombre cNomPers, PE.cPersCod cCodPers, "
                        lsQrySdo = lsQrySdo & "  CAPAHO.dUltContacto AS dUltMovAC, PR.nTasaInteres nTasaIntAC, CAPAHO.nSaldoAnterior AS nSdoAnt, "
                        lsQrySdo = lsQrySdo & " a.cagecod,A.CAGEDESCRIPCION,CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ) "
                        lsQrySdo = lsQrySdo & "  FROM Producto PR "
                        lsQrySdo = lsQrySdo & " INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                        lsQrySdo = lsQrySdo & " INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN CaptacAhorros CAPAHO ON PR.cCtaCod = CAPAHO.cCtaCod "
                        lsQrySdo = lsQrySdo & " INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                        lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                        lsQrySdo = lsQrySdo & "  LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                        lsQrySdo = lsQrySdo & " INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & " LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & "  Where E2.cNroDoc Is Null "
                        lsQrySdo = lsQrySdo & "  GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                        lsQrySdo = lsQrySdo & " WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')"
                        lsQrySdo = lsQrySdo & " AND CAP.nPersoneria IN ('" & PersPersoneria.gPersonaNat & "','" & PersPersoneria.gPersonaJurSFL & "') AND  PP.nPrdPersRelac = '10' AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "'" & sqlAdd
                        lsQrySdo = lsQrySdo & " ORDER BY a.cagecod,CAPAHO.bOrdPag, PR.cCtaCod "
        
            Else
               
                   If lsAgeCod <> "X4" And lsAgeCod <> "X2" Then
                        lsQrySdo = " SELECT PE.cPersDireccDomicilio,PR.cCtaCod cCodCta, CAPAHO.bOrdPag cOrdPag, CAP.nSaldoDisp AS nSdoDis, PR.nSaldo AS nSdoCnt,"
                        lsQrySdo = lsQrySdo & "  dbo.GetInteresGanado(PR.cCtaCod,'" & Format(psFchPro, ofunf.gsFormatoFecha) & "','S') AS nIntMes, PE.cPersNombre cNomPers, PE.cPersCod cCodPers, "
                        lsQrySdo = lsQrySdo & "  CAPAHO.dUltContacto AS dUltMovAC, PR.nTasaInteres nTasaIntAC, CAPAHO.nSaldoAnterior AS nSdoAnt, "
                        lsQrySdo = lsQrySdo & " a.cagecod,A.CAGEDESCRIPCION,CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ) "
                        lsQrySdo = lsQrySdo & "  FROM Producto PR "
                        lsQrySdo = lsQrySdo & " INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                        lsQrySdo = lsQrySdo & " INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN CaptacAhorros CAPAHO ON PR.cCtaCod = CAPAHO.cCtaCod "
                        lsQrySdo = lsQrySdo & " INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                        lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                        lsQrySdo = lsQrySdo & "  LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                        lsQrySdo = lsQrySdo & " INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & " LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & "  Where E2.cNroDoc Is Null "
                        lsQrySdo = lsQrySdo & "  GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                        lsQrySdo = lsQrySdo & " WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')"
                        lsQrySdo = lsQrySdo & " AND  PP.nPrdPersRelac = '10' AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "'" & sqlAdd
                        lsQrySdo = lsQrySdo & " ORDER BY a.cagecod,CAPAHO.bOrdPag, PR.cCtaCod "
                   ElseIf lsAgeCod = "X4" Then
                        lsQrySdo = " SELECT PE.cPersDireccDomicilio,PR.cCtaCod cCodCta, CAPAHO.bOrdPag cOrdPag, CAP.nSaldoDisp AS nSdoDis, PR.nSaldo AS nSdoCnt,"
                        lsQrySdo = lsQrySdo & "  dbo.GetInteresGanado(PR.cCtaCod,'" & Format(psFchPro, ofunf.gsFormatoFecha) & "','S') AS nIntMes, PE.cPersNombre cNomPers, PE.cPersCod cCodPers, "
                        lsQrySdo = lsQrySdo & "  CAPAHO.dUltContacto AS dUltMovAC, PR.nTasaInteres nTasaIntAC, CAPAHO.nSaldoAnterior AS nSdoAnt, "
                        lsQrySdo = lsQrySdo & " cagecod='X4',CAGEDESCRIPCION='NASCA - PALPA',CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ) "
                        lsQrySdo = lsQrySdo & "  FROM Producto PR "
                        lsQrySdo = lsQrySdo & " INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                        lsQrySdo = lsQrySdo & " INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN CaptacAhorros CAPAHO ON PR.cCtaCod = CAPAHO.cCtaCod "
                        lsQrySdo = lsQrySdo & " INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                        'lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                        lsQrySdo = lsQrySdo & "  LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                        lsQrySdo = lsQrySdo & " INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & " LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & "  Where E2.cNroDoc Is Null "
                        lsQrySdo = lsQrySdo & "  GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                        lsQrySdo = lsQrySdo & " WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')"
                        lsQrySdo = lsQrySdo & " AND  PP.nPrdPersRelac = '10' AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "' and substring(PR.cCtaCod,4,2) in ('04','08')" & sqlAdd
                        lsQrySdo = lsQrySdo & " ORDER BY CAPAHO.bOrdPag, PR.cCtaCod "
                   ElseIf lsAgeCod = "X2" Then
                        lsQrySdo = " SELECT PE.cPersDireccDomicilio,PR.cCtaCod cCodCta, CAPAHO.bOrdPag cOrdPag, CAP.nSaldoDisp AS nSdoDis, PR.nSaldo AS nSdoCnt,"
                        lsQrySdo = lsQrySdo & "  dbo.GetInteresGanado(PR.cCtaCod,'" & Format(psFchPro, ofunf.gsFormatoFecha) & "','S') AS nIntMes, PE.cPersNombre cNomPers, PE.cPersCod cCodPers, "
                        lsQrySdo = lsQrySdo & "  CAPAHO.dUltContacto AS dUltMovAC, PR.nTasaInteres nTasaIntAC, CAPAHO.nSaldoAnterior AS nSdoAnt, "
                        lsQrySdo = lsQrySdo & " cagecod='X2',CAGEDESCRIPCION='CAÑETE - MALA',CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ) "
                        lsQrySdo = lsQrySdo & "  FROM Producto PR "
                        lsQrySdo = lsQrySdo & " INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                        lsQrySdo = lsQrySdo & " INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN CaptacAhorros CAPAHO ON PR.cCtaCod = CAPAHO.cCtaCod "
                        lsQrySdo = lsQrySdo & " INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                        'lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                        lsQrySdo = lsQrySdo & "  LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                        lsQrySdo = lsQrySdo & " INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & " LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & "  Where E2.cNroDoc Is Null "
                        lsQrySdo = lsQrySdo & "  GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                        lsQrySdo = lsQrySdo & " WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')"
                        lsQrySdo = lsQrySdo & " AND  PP.nPrdPersRelac = '10' AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "'and substring(PR.cCtaCod,4,2) in ('02','07') " & sqlAdd
                        lsQrySdo = lsQrySdo & " ORDER BY CAPAHO.bOrdPag, PR.cCtaCod "
                    End If
            End If

        Case Producto.gCapPlazoFijo
             
             If nTipo = 5 Then
                lsQrySdo = lsQrySdo & " SELECT PE.cPersDireccDomicilio,PR.cCtaCod cCodCta, CAP.nSaldoDisp AS nCapital, CAP.nIntAcum AS nIntDev,  PR.nSaldo AS nSdoCnt, "
                lsQrySdo = lsQrySdo & "  PE.cPersNombre cNomPers, PP.cPersCod cCodPers, PR.nTasaInteres, CAPPF.dAuxiliar AS dUltMovPF , "
                lsQrySdo = lsQrySdo & "  a.cagecod,A.CAGEDESCRIPCION,CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ),NPLAZO "
                lsQrySdo = lsQrySdo & "  FROM Producto PR "
                lsQrySdo = lsQrySdo & "  INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                lsQrySdo = lsQrySdo & "  INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                lsQrySdo = lsQrySdo & "  INNER JOIN CaptacPlazoFijo CAPPF ON PR.cCtaCod = CAPPF.cCtaCod "
                lsQrySdo = lsQrySdo & "  INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                lsQrySdo = lsQrySdo & "  inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                lsQrySdo = lsQrySdo & "  LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                lsQrySdo = lsQrySdo & "  INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                lsQrySdo = lsQrySdo & "  LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                lsQrySdo = lsQrySdo & "  Where E2.cNroDoc Is Null  GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                lsQrySdo = lsQrySdo & "  WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')"
                lsQrySdo = lsQrySdo & "  AND CAP.nPersoneria IN ('" & PersPersoneria.gPersonaNat & "','" & PersPersoneria.gPersonaJurSFL & "')  AND  PP.nPrdPersRelac in (10,12) AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "'" & sqlAdd
                lsQrySdo = lsQrySdo & "  ORDER BY a.cagecod,PR.cCtaCod ,PP.nPrdPersRelac "
              Else
                    If lsAgeCod <> "X4" And lsAgeCod <> "X2" Then
                        lsQrySdo = lsQrySdo & " SELECT PE.cPersDireccDomicilio,PR.cCtaCod cCodCta, CAP.nSaldoDisp AS nCapital, CAP.nIntAcum AS nIntDev,  PR.nSaldo AS nSdoCnt, "
                        lsQrySdo = lsQrySdo & "  PE.cPersNombre cNomPers, PP.cPersCod cCodPers, PR.nTasaInteres, CAPPF.dAuxiliar AS dUltMovPF , "
                        lsQrySdo = lsQrySdo & "  a.cagecod,A.CAGEDESCRIPCION,CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ),NPLAZO "
                        lsQrySdo = lsQrySdo & "  FROM Producto PR "
                        lsQrySdo = lsQrySdo & "  INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN CaptacPlazoFijo CAPPF ON PR.cCtaCod = CAPPF.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                        lsQrySdo = lsQrySdo & "  inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                        lsQrySdo = lsQrySdo & "  LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                        lsQrySdo = lsQrySdo & "  INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & "  LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & "  Where E2.cNroDoc Is Null  GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                        lsQrySdo = lsQrySdo & "  WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')"
                        lsQrySdo = lsQrySdo & "  AND  PP.nPrdPersRelac in (10,12) AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "' " & sqlAdd
                        lsQrySdo = lsQrySdo & "  ORDER BY a.cagecod,PR.cCtaCod  ,PP.nPrdPersRelac "
                    ElseIf lsAgeCod = "X4" Then
                        lsQrySdo = lsQrySdo & " SELECT PE.cPersDireccDomicilio,PR.cCtaCod cCodCta, CAP.nSaldoDisp AS nCapital, CAP.nIntAcum AS nIntDev,  PR.nSaldo AS nSdoCnt, "
                        lsQrySdo = lsQrySdo & "  PE.cPersNombre cNomPers, PP.cPersCod cCodPers, PR.nTasaInteres, CAPPF.dAuxiliar AS dUltMovPF , "
                        lsQrySdo = lsQrySdo & "  cagecod='X4',CAGEDESCRIPCION='NASCA - PALPA',CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ),NPLAZO "
                        lsQrySdo = lsQrySdo & "  FROM Producto PR "
                        lsQrySdo = lsQrySdo & "  INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN CaptacPlazoFijo CAPPF ON PR.cCtaCod = CAPPF.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                        'lsQrySdo = lsQrySdo & "  inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                        lsQrySdo = lsQrySdo & "  LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                        lsQrySdo = lsQrySdo & "  INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & "  LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & "  Where E2.cNroDoc Is Null  GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                        lsQrySdo = lsQrySdo & "  WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')"
                        lsQrySdo = lsQrySdo & "  AND  PP.nPrdPersRelac in (10,12) AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "' and substring(PR.cCtaCod,4,2) in ('04','08')" & sqlAdd
                        lsQrySdo = lsQrySdo & "  ORDER BY PR.cCtaCod ,PP.nPrdPersRelac "
                    ElseIf lsAgeCod = "X2" Then
                        lsQrySdo = lsQrySdo & " SELECT PE.cPersDireccDomicilio,PR.cCtaCod cCodCta, CAP.nSaldoDisp AS nCapital, CAP.nIntAcum AS nIntDev,  PR.nSaldo AS nSdoCnt, "
                        lsQrySdo = lsQrySdo & "  PE.cPersNombre cNomPers, PP.cPersCod cCodPers, PR.nTasaInteres, CAPPF.dAuxiliar AS dUltMovPF , "
                        lsQrySdo = lsQrySdo & "  cagecod='X2',CAGEDESCRIPCION='CAÑETE - MALA',CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ),NPLAZO "
                        lsQrySdo = lsQrySdo & "  FROM Producto PR "
                        lsQrySdo = lsQrySdo & "  INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN CaptacPlazoFijo CAPPF ON PR.cCtaCod = CAPPF.cCtaCod "
                        lsQrySdo = lsQrySdo & "  INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                        'lsQrySdo = lsQrySdo & "  inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                        lsQrySdo = lsQrySdo & "  LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                        lsQrySdo = lsQrySdo & "  INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & "  LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                        lsQrySdo = lsQrySdo & "  Where E2.cNroDoc Is Null  GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                        lsQrySdo = lsQrySdo & "  WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')"
                        lsQrySdo = lsQrySdo & "  AND  PP.nPrdPersRelac in (10,12) AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "' and substring(PR.cCtaCod,4,2) in ('02','07') " & sqlAdd
                        lsQrySdo = lsQrySdo & "  ORDER BY PR.cCtaCod,PP.nPrdPersRelac "
                    End If
              End If
                
                      
        Case Producto.gCapCTS
             If psTipPer = PersPersoneria.gPersonaNat Then
                
             If lsAgeCod <> "X4" And lsAgeCod <> "X2" Then
                lsQrySdo = "  SELECT PE.cPersDireccDomicilio,CAPCTS.cCtaCod cCodCta, CAPCTS.nSaldRetiro As nSdoDis, PR.nSaldo nSdoCnt,  CAP.nSaldoDisp As nCapital,dbo.GetInteresGanado(PR.cCtaCod,'" & Format(psFchPro, ofunf.gsFormatoFecha) & "','S') AS nIntMes, "
                lsQrySdo = lsQrySdo & " case when dbo.ultimodiames(dUltCierre)=1 then dUltCierre else dateadd(dd,1, dUltCierre) end AS dUltMovCTS, CAPCTS.cCodInst, PE.cPersNombre cNomPers, PP.cPersCod cCodPers, "
                lsQrySdo = lsQrySdo & " a.cagecod,A.CAGEDESCRIPCION,CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ) "
                lsQrySdo = lsQrySdo & " FROM Producto PR "
                lsQrySdo = lsQrySdo & " INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                lsQrySdo = lsQrySdo & " INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                lsQrySdo = lsQrySdo & " INNER JOIN CaptacCTS CAPCTS ON PR.cCtaCod = CAPCTS.cCtaCod "
                lsQrySdo = lsQrySdo & " INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                lsQrySdo = lsQrySdo & " LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                lsQrySdo = lsQrySdo & " INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                lsQrySdo = lsQrySdo & " LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                lsQrySdo = lsQrySdo & " Where E2.cNroDoc Is Null "
                lsQrySdo = lsQrySdo & " GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                lsQrySdo = lsQrySdo & " WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "') "
                lsQrySdo = lsQrySdo & " AND  PP.nPrdPersRelac = '10' AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "' " & sqlAdd
                lsQrySdo = lsQrySdo & " ORDER BY a.cagecod,CAPCTS.cCodInst, PR.cCtaCod "
             ElseIf lsAgeCod = "X4" Then
                lsQrySdo = "  SELECT PE.cPersDireccDomicilio,CAPCTS.cCtaCod cCodCta, CAPCTS.nSaldRetiro As nSdoDis, PR.nSaldo nSdoCnt,  CAP.nSaldoDisp As nCapital,dbo.GetInteresGanado(PR.cCtaCod,'" & Format(psFchPro, ofunf.gsFormatoFecha) & "','S') AS nIntMes, "
                lsQrySdo = lsQrySdo & " case when dbo.ultimodiames(dUltCierre)=1 then dUltCierre else dateadd(dd,1, dUltCierre) end AS dUltMovCTS, CAPCTS.cCodInst, PE.cPersNombre cNomPers, PP.cPersCod cCodPers, "
                lsQrySdo = lsQrySdo & " cagecod='X4',CAGEDESCRIPCION='NASCA - PALPA',CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ) "
                lsQrySdo = lsQrySdo & " FROM Producto PR "
                lsQrySdo = lsQrySdo & " INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                lsQrySdo = lsQrySdo & " INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                lsQrySdo = lsQrySdo & " INNER JOIN CaptacCTS CAPCTS ON PR.cCtaCod = CAPCTS.cCtaCod "
                lsQrySdo = lsQrySdo & " INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                'lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                lsQrySdo = lsQrySdo & " LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                lsQrySdo = lsQrySdo & " INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                lsQrySdo = lsQrySdo & " LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                lsQrySdo = lsQrySdo & " Where E2.cNroDoc Is Null "
                lsQrySdo = lsQrySdo & " GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                lsQrySdo = lsQrySdo & " WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "') "
                lsQrySdo = lsQrySdo & " AND  PP.nPrdPersRelac = '10' AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "' and substring(PR.cCtaCod,4,2) in ('04','08') " & sqlAdd
                lsQrySdo = lsQrySdo & " ORDER BY CAPCTS.cCodInst, PR.cCtaCod "
             ElseIf lsAgeCod = "X2" Then
                lsQrySdo = "  SELECT PE.cPersDireccDomicilio,CAPCTS.cCtaCod cCodCta, CAPCTS.nSaldRetiro As nSdoDis, PR.nSaldo nSdoCnt,  CAP.nSaldoDisp As nCapital,dbo.GetInteresGanado(PR.cCtaCod,'" & Format(psFchPro, ofunf.gsFormatoFecha) & "','S') AS nIntMes, "
                lsQrySdo = lsQrySdo & " case when dbo.ultimodiames(dUltCierre)=1 then dUltCierre else dateadd(dd,1, dUltCierre) end AS dUltMovCTS, CAPCTS.cCodInst, PE.cPersNombre cNomPers, PP.cPersCod cCodPers, "
                lsQrySdo = lsQrySdo & " cagecod='X2',CAGEDESCRIPCION='CAÑETE - MALA',CHEQUESENV=(CASE WHEN L.CCTACOD IS NULL THEN 0.00 ELSE L.MONTO  END ) "
                lsQrySdo = lsQrySdo & " FROM Producto PR "
                lsQrySdo = lsQrySdo & " INNER JOIN ProductoPersona PP ON PR.cCtaCod = PP.cCtaCod "
                lsQrySdo = lsQrySdo & " INNER JOIN Captaciones CAP ON PR.cCtaCod = CAP.cCtaCod "
                lsQrySdo = lsQrySdo & " INNER JOIN CaptacCTS CAPCTS ON PR.cCtaCod = CAPCTS.cCtaCod "
                lsQrySdo = lsQrySdo & " INNER JOIN Persona PE ON PP.cPersCod = PE.cPersCod "
                'lsQrySdo = lsQrySdo & " inner join agencias A ON A.CAGECOD=SUBSTRING(PP.CCTACOD,4,2) "
                lsQrySdo = lsQrySdo & " LEFT JOIN (select MONTO=SUM(NMONTO),CCTACOD from DOCRECCAPTA D "
                lsQrySdo = lsQrySdo & " INNER JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=1 AND CIFCTA IS NOT NULL) E1 ON E1.CNRODOC=D.CNRODOC AND E1.CIFCTA=D.CIFCTA "
                lsQrySdo = lsQrySdo & " LEFT JOIN (SELECT CNRODOC,CIFCTA FROM DOCRECEST WHERE NESTADO=2 AND CIFCTA IS NOT NULL ) E2 ON E2.CNRODOC=D.CNRODOC AND E2.CIFCTA=D.CIFCTA "
                lsQrySdo = lsQrySdo & " Where E2.cNroDoc Is Null "
                lsQrySdo = lsQrySdo & " GROUP BY D.CCTACOD) L ON L.CCTACOD=PP.CCTACOD "
                lsQrySdo = lsQrySdo & " WHERE Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "') "
                lsQrySdo = lsQrySdo & " AND  PP.nPrdPersRelac = '10' AND SUBSTRING(PR.cCtaCod,9,1) = '" & psTipMon & "'  and substring(PR.cCtaCod,4,2) in ('02','07') " & sqlAdd
                lsQrySdo = lsQrySdo & " ORDER BY CAPCTS.cCodInst, PR.cCtaCod "
                End If
             End If 'RepEstratPlazoFijo
    End Select
    If lsMoneda = "SOLES" Then
        lsMonedaNum = "1"
    Else
        lsMonedaNum = "2"
    End If
    If lsQrySdo = "" Then
       Exit Function
    End If
    If rsQrySdo.State = adStateOpen Then rsQrySdo.Close

    Set rsQrySdo = oCon.CargaRecordSet(lsQrySdo)
    
    If rsQrySdo.EOF And rsQrySdo.BOF Then
       lsRTFSdo = ""
       GeneraSaldos = lsRTFSdo
    ElseIf psTipAho = gCapAhorros Then
       PrtSaldos rsQrySdo, nTipo
       GeneraSaldos = lsRTFSdo
    ElseIf psTipAho = gCapPlazoFijo Then
       PrtSaldosTI rsQrySdo, nTipo, , lsMonedaNum
       GeneraSaldos = lsRTFSdo
    ElseIf psTipAho = gCapCTS Then
        PrtSaldos rsQrySdo, nTipo
       GeneraSaldos = lsRTFSdo
    End If
End Function

Private Function PrtSaldosTI(prQryDat As ADODB.Recordset, Optional nTipo As Integer = 1, Optional gdFecSis As Date, Optional psTipMon As String = "1")
    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lnTotDep As Double, lnTotRet As Double
    Dim lsCodPro As String, lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsSubTit As String, lnCntCta As Integer
    Dim lnSdoCnt As Double, lnSdoDis As Double
    Dim lnCapita As Double, lsCodCta As String
    Dim lnCapiFi As Double, lnSdDiFi As Double, lnSdCnFi As Double
    Dim lnCheEnV As Double, lnCheEnVFi As Double
    Dim lnCtaPag As Integer, lnTotCta As Integer
    Dim lnIntMes As Double, lnSdInFi As Double
    Dim lnCntRel As Integer
    Dim lbCtaIde As Boolean
    Dim lnIntCap As Double
    Dim lnIntDev As Double, lnCalInt As Double
    Dim lbCieMes As Boolean
    Dim lnNumDia As Integer, CCodage As String
    Dim lsCuenta As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim oDCtaCont As COMFunciones.FCOMFechas 'Agregado por ELRO el 20111105, según Acta 307-2011/TI-D
    
    'Dim codigocta As String
    If CierreRealizado(2) Then
        lbCieMes = True
    Else
        lbCieMes = False
    End If
    
    gdFecSis = Format(Now(), "dd/mm/yyyy")
    'codigocta = ""
    lsNumPag = ""
    lnLinPag = 65
    lnCarLin = 200
    lsTitRp1 = "REPORTE DE SALDO DE CUENTA(S)"
    lsTitRp2 = ""
    lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
    lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
    lnCntPag = 0
    lbCtaIde = False
    
    With prQryDat
         Do While Not .EOF
         
         
            Select Case Mid$(!cCodCta, 6, 3)
               Case Producto.gCapAhorros
                    lnCarLin = 132
                    lsTitRp2 = "AHORROS" & IIf(Not !cOrdPag, "", " CON ORDEN DE PAGO") & " - " & lsPerson
               Case Producto.gCapPlazoFijo
                    lnCarLin = 165
                    lsTitRp2 = "PLAZO FIJO" & " - " & lsPerson
         '      Case Producto.gCapCTS
          '          lnCarLin = 132
          '          lsPerson = "PERSONA NATURAL - " & IIf(LTrim(RTrim(!cCodInst)) = gsInstCmac, "EMPLEADOS", "CLIENTES")
          '          lsTitRp2 = "C T S" & " - " & lsPerson & " " & IIf(ntipo = 2, "EMPLEADOS CMAC - CONVENIO", IIf(ntipo = 3, "OTRAS EMPRESAS - EXTERNOS", ""))
            End Select
            
            If lsTitRp2 <> lsCodPro Then
               If lsNumPag <> "" Then
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(14, " ") & IIf(Mid$(!cCodCta, 6, 3) = Producto.gCapCTS, "", " ")
                  
                  
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 11, True, 9, 2) & ""
                  If Left(lsCodPro, 7) = "AHORROS" Then
                     
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                  Else
                  
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 11, True, 9, 2) & ""
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 11, True, 9, 2) & ""
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                  End If
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(17, " ") & IIf(Mid$(!cCodCta, 6, 3) = Producto.gCapCTS, "", " ")
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapiFi)), 11, True, 9, 2) & ""
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 11, True, 9, 2) & ""
                  If Left(lsCodPro, 7) = "AHORROS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & ""
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & ""
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  Else
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 11, True, 9, 2) & "" '& oImp.gPrnSaltoLinea
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  End If
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                  lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
                  lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
               End If
               lsCodPro = lsTitRp2
               lnLinPag = 65
            End If
            
            If lnLinPag > 58 Or CCodage <> !cAgeCod Then
               If lsNumPag <> "" Then
                  If lnSdoDis <> 0 Or lnCapita <> 0 Then
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                     lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(14, " ") & IIf(Mid$(!cCodCta, 6, 3) = Producto.gCapCTS, "", " ")
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 11, True, 9, 2) & ""
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 11, True, 9, 2) & ""
                     If Left(lsCodPro, 7) = "AHORROS" Then
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     Else
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 11, True, 9, 2) & ""  '& oImp.gPrnSaltoLinea
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     End If
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                     lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
                  End If
               End If
               
               lnCntPag = lnCntPag + 1
               lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
               lsRTFSdo = lsRTFSdo & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1 + " AGENCIA: " + !cAgeDescripcion, lsTitRp2, lsMoneda, lsNumPag) & oImp.gPrnSaltoLinea
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
               If Mid$(!cCodCta, 6, 3) = Producto.gCapPlazoFijo Then
                  lsRTFSdo = lsRTFSdo & "   NUMERO    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "NOMBRE / RAZON SOCIAL" & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "           "
                  lsRTFSdo = lsRTFSdo & "  INTERES  "
                  lsRTFSdo = lsRTFSdo & "   SALDO   " '& " "
                  lsRTFSdo = lsRTFSdo & "  CHEQUES  "
                  lsRTFSdo = lsRTFSdo & "       " '& " "
                  lsRTFSdo = lsRTFSdo & "  ULTIMO  " & oImp.gPrnSaltoLinea
                  lsRTFSdo = lsRTFSdo & "   CUENTA    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "     DEL CLIENTE     " & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "  CAPITAL  "
                  lsRTFSdo = lsRTFSdo & "  DEVENG.  "
                  lsRTFSdo = lsRTFSdo & "   CONT.   " '& " "
                  lsRTFSdo = lsRTFSdo & "EN VALORIZ."
                  lsRTFSdo = lsRTFSdo & " PLAZO " '& " "
                  lsRTFSdo = lsRTFSdo & "MOVIMIENTO    "
                  lsRTFSdo = lsRTFSdo & "DIRECCION" & oImp.gPrnSaltoLinea
               Else
                  lsRTFSdo = lsRTFSdo & "   NUMERO    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "NOMBRE / RAZON SOCIAL" & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "              "
                  lsRTFSdo = lsRTFSdo & "    SALDO     "
                  lsRTFSdo = lsRTFSdo & "    SALDO     "
                  lsRTFSdo = lsRTFSdo & "   CHEQUES    "
                  lsRTFSdo = lsRTFSdo & "   INTERESES  " & " "
                  lsRTFSdo = lsRTFSdo & "  ULTIMO" & oImp.gPrnSaltoLinea
                  lsRTFSdo = lsRTFSdo & "   CUENTA    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "     DEL CLIENTE     " & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "   CAPITAL   "
                  lsRTFSdo = lsRTFSdo & " DISPONIBLE  "
                  lsRTFSdo = lsRTFSdo & "  CONTABLE   "
                  lsRTFSdo = lsRTFSdo & " EN VALORIZ. "
                  lsRTFSdo = lsRTFSdo & "    DEL  MES" & " "
                  lsRTFSdo = lsRTFSdo & "MOVIMIENTO" & oImp.gPrnSaltoLinea
               End If
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea         ' hasta 160 caracteres x línea
               lnLinPag = 9
            End If
            lnCntRel = 0
            'If !ccodcta = lsCodCta Then
            '   If lbCtaIde = False Then
            '      lnCntRel = RelCta(!ccodcta, !cCodPers)
                  '********AGREGADOS MPBR*******
                   'lsRTFSdo = String(19, " ")
                   'If Len(Trim(!cNomPers)) < 50 Then
                    '    lsRTFSdo = lsRTFSdo & FillText(Left(oFunC.pstanombre(oFunI.ImpreCarEsp(!cNomPers), False), 37), 37, " ") & " "
                   'Else
                   '     lsRTFSdo = lsRTFSdo & Left(oFunC.pstanombre(oFunI.ImpreCarEsp(!cNomPers), False), 37) & " "
                   'End If
                  'lbCtaIde = False
                  '********AGREGADOS MPBR*********
            '      lbCtaIde = True
            '   End If
           ' Else
             If !cCodCta <> lsCodCta Then
                lsRTFSdo = lsRTFSdo & !cCodCta & " "
             Else
                lsRTFSdo = lsRTFSdo & String(19, " ")
             End If
               
               lbCtaIde = False
               
               If Len(Trim(!cNomPers)) < 50 Then
                  lsRTFSdo = lsRTFSdo & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 37), 37, " ") & "" & IIf(!cCodCta = lsCodCta, Chr(10), "")
               Else
                  lsRTFSdo = lsRTFSdo & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 37) & "" & IIf(!cCodCta = lsCodCta, Chr(10), "")
               End If
               lnCtaPag = lnCtaPag + 1: lnTotCta = lnTotCta + 1
               
               
             If !cCodCta <> lsCodCta Then
                Select Case Mid$(!cCodCta, 6, 3)
                       Case Producto.gCapAhorros
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum("0.00", 12, True, 9, 2) & " "
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoDis, 12, True, 9, 2) & " "
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoCnt, 12, True, 9, 2) & " "
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(!chequesenv, 12, True, 9, 2) & " "

                            lnIntCap = 0
                            If lbCieMes Then
                                 lnIntCap = !nSdoDis - !nSdoAnt
                            Else
                                 lnIntCap = !nIntMes
                            End If
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntCap)), 12, True, 9, 2) & " "
                            lsRTFSdo = lsRTFSdo & Format(!dUltMovAC, ofunf.gsFormatoFechaView) & Chr(10)
                            
                            lnCapita = lnCapita + 0: lnCapiFi = lnCapiFi + 0
                            lnSdoCnt = lnSdoCnt + !nSdoCnt
                            lnSdoDis = lnSdoDis + !nSdoDis
                            lnIntMes = lnIntMes + lnIntCap
                            lnSdCnFi = lnSdCnFi + !nSdoCnt
                            lnCheEnV = lnCheEnV + !chequesenv
                            lnCheEnVFi = lnCheEnVFi + !chequesenv
                            lnSdDiFi = lnSdDiFi + !nSdoDis
                            lnSdInFi = lnSdInFi + lnIntCap
                            lnCntRel = RelCta(!cCodCta, !cCodPers)
                            lbCtaIde = True
                        Case Producto.gCapPlazoFijo
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nCapital, 11, True, 9, 2) & ""
                            
                            lnNumDia = DateDiff("d", Format(!dUltMovPF, "dd/mm/yyyy"), gdFecSis) - 1
                            
                            'Adicion Miguel 18-03-2004
                            lnCalInt = !nIntDev
                            
                            'lnCalInt = GetInteres(!nTasaInteres, (!nIntDev + !nCapital), lnNumDia, False)
                            
                            lnIntDev = lnCalInt
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntDev)), 11, True, 9, 2) & ""
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoCnt, 11, True, 9, 2) & ""
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(!chequesenv, 11, True, 9, 2) & ""
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nPlazo, 7, True, 5, 0) & " "
                            lsRTFSdo = lsRTFSdo & Format(!dUltMovPF, ofunf.gsFormatoFechaView) & "      "
                            lsRTFSdo = lsRTFSdo & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cPersDireccDomicilio), False), 33), 33, " ") & Chr(10)
                            lnCapita = lnCapita + !nCapital
                            lnCapiFi = lnCapiFi + !nCapital
                            lnSdoDis = lnSdoDis + lnIntDev
                            lnSdDiFi = lnSdDiFi + lnIntDev
                            lnSdoCnt = lnSdoCnt + !nSdoCnt
                            lnSdCnFi = lnSdCnFi + !nSdoCnt
                            lnCheEnV = lnCheEnV + !chequesenv
                            lnCheEnVFi = lnCheEnVFi + !chequesenv
                            lnCntRel = RelCta(!cCodCta, !cCodPers)
                            lbCtaIde = True
                         Case Producto.gCapCTS
                           lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nCapital, 11, True, 8, 2) & " "
                           lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoDis, 12, True, 9, 2) & " "
                           lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoCnt, 12, True, 9, 2) & " "
                           lsRTFSdo = lsRTFSdo & ofunc.JDNum(!chequesenv, 12, True, 9, 2) & " "
                           lnIntCap = lsRTFSdo & ofunc.JDNum(!chequesenv, 12, True, 9, 2) & " "
    '                       If lbCieMes Then
    '                            lnIntCap = !nSdoDis - !nSdoAnt
    '                       Else
    '                            lnIntCap = !nIntMes
    '                       End If
                           lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntCap)), 12, True, 9, 2) & " "
                           lsRTFSdo = lsRTFSdo & Format(!dUltMovCTS, ofunf.gsFormatoFechaView) & Chr(10)
                           
                           lnCapita = lnCapita + !nCapital
                           lnCapiFi = lnCapiFi + !nCapital
                           lnSdoCnt = lnSdoCnt + !nSdoCnt
                           lnSdCnFi = lnSdCnFi + !nSdoCnt
                           lnCheEnV = lnCheEnV + !chequesenv
                           lnCheEnVFi = lnCheEnVFi + !chequesenv
                           lnSdoDis = lnSdoDis + !nSdoDis
                           lnSdDiFi = lnSdDiFi + !nSdoDis
                           lnIntMes = lnIntMes + lnIntCap
                           lnSdInFi = lnSdInFi + lnIntCap
                           lnCntRel = RelCta(!cCodCta, !cCodPers)
                           lbCtaIde = True
                       End Select
             End If
                lnCntCta = lnCntCta + 1
                lnLinPag = lnLinPag + lnCntRel + 1
                lsCuenta = Mid(!cCodCta, 6, 3)
            
                lsCodCta = !cCodCta
                CCodage = !cAgeCod
            'codigocta = !ccodcta
                .MoveNext
         Loop
    End With
    If prQryDat.EOF Then
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(14, " ") & IIf(lsCuenta = Producto.gCapCTS, "", " ")
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 11, True, 9, 2) & ""
       If Left(lsCodPro, 7) = "AHORROS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & ""
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & ""
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & ""
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       Else
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 11, True, 9, 2) & ""
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 11, True, 9, 2) & "" '& oImp.gPrnSaltoLinea
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       End If
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(17, " ") & IIf(lsCuenta = Producto.gCapCTS, "", " ")
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapiFi)), 11, True, 9, 2) & ""
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 11, True, 9, 2) & ""
       If Left(lsCodPro, 7) = "AHORROS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       Else
          Set oDCtaCont = New COMFunciones.FCOMFechas
          Call oDCtaCont.InsertaCtaContSaldoDiario("11" & psTipMon & "303_PF_1", gdFecSis, "280609", lnSdCnFi)
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 11, True, 9, 2) & "" '& oImp.gPrnSaltoLinea
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       End If
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
       lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
       lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
    End If
    Set ofunc = Nothing
    Set ofuni = Nothing
End Function

Private Function PrtSaldosCierre(rsData As ADODB.Recordset, Optional nTipo As Integer = 1, Optional pdCIerre As Date, Optional nrep As Integer = 1)

    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lnTotDep As Double, lnTotRet As Double
    Dim lsCodPro As String, lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsSubTit As String, lnCntCta As Integer
    Dim lnSdoCnt As Double, lnSdoDis As Double
    Dim lnCapita As Double, lsCodCta As String
    Dim lnCapiFi As Double, lnSdDiFi As Double, lnSdCnFi As Double
    Dim lnCheEnV As Double, lnCheEnVFi As Double
    Dim lnCtaPag As Integer, lnTotCta As Integer
    Dim lnIntMes As Double, lnSdInFi As Double
    Dim lnCntRel As Integer
    Dim lbCtaIde As Boolean
    Dim lnIntCap As Double
    Dim lnIntDev As Double, lnCalInt As Double
    Dim lbCieMes As Boolean
    Dim lnNumDia As Integer, CCodage As String
    Dim lsCuenta As String
    Dim codigocta As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    If CierreRealizado(2) Then
        lbCieMes = True
    Else
        lbCieMes = False
    End If
    
    
    
    codigocta = ""
    lsNumPag = ""
    lnLinPag = 65
    lnCarLin = 105
    If nrep = 1 Then
        lsTitRp1 = "REPORTE DE SALDO DE CUENTA(S) AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
    ElseIf nrep = 2 Then
        lsTitRp1 = "REPORTE DE SALDO DE CUENTA(S) BLOQUEADAS AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
    ElseIf nrep = 3 Then
        lsTitRp1 = "REPORTE DE SALDO DE CUENTA(S) INACTIVAS(360-720 dias) AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
    ElseIf nrep = 4 Then
        lsTitRp1 = "REPORTE DE SALDO DE CUENTA(S) INACTIVAS(mas de 720 dias) AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
    ElseIf nrep = 5 Then
        lsTitRp1 = "REPORTE DE PROVISON DE CUENTA(S) AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
    
        
    End If
    
    
    lsTitRp2 = ""
    lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
    lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
    lnCntPag = 0
    lbCtaIde = False
    
    With rsData
         Do While Not .EOF
         
        If nTipo = 0 Then
                 Select Case !nPersoneria
                    Case PersPersoneria.gPersonaNat
                         lsPerson = "PERSONA NATURAL"
                    Case PersPersoneria.gPersonaJurSFL
                         lsPerson = "PERSONA JUR. SIN FINES DE LUCRO"
                    Case PersPersoneria.gPersonaJurCFL
                         lsPerson = "PERSONA JUR. CON FINES DE LUCRO"
                    Case PersPersoneria.gPersonaJurCFLCMAC
                         lsPerson = "CAJAS MUNICIPALES"
                    Case PersPersoneria.gPersonaJurCFLCRAC
                         lsPerson = "CAJAS RURALES"
                    Case PersPersoneria.gPersonaJurCFLFONCODES
                         lsPerson = "FONCODES"
                    Case PersPersoneria.gPersonaJurCFLCooperativa
                         lsPerson = "COOPERATIVA"
                    Case PersPersoneria.gPersonaJurCFLEdpyme
                         lsPerson = "EDPYME"
              
                End Select
        End If
         
         
         
            Select Case Mid$(!cCtaCod, 6, 3)
               Case Producto.gCapAhorros
                    lnCarLin = 132
                    If nrep = 1 Then
                        lsTitRp2 = "AHORROS" & IIf(Not !bOrdPag, "", " CON ORDEN DE PAGO") & " - " & lsPerson
                    ElseIf nrep = 2 Then
                        lsTitRp2 = "AHORROS " & IIf(nrep = 2, !Motivo, "") & " - " & lsPerson
                    Else
                        lsTitRp2 = "AHORROS" & " - " & lsPerson
                    End If
                    
               Case Producto.gCapPlazoFijo
                    lnCarLin = 119
                    If nrep = 2 Then
                        lsTitRp2 = "PLAZO FIJO " & IIf(nrep = 2, !Motivo, "") & " - " & lsPerson
                    Else
                         lsTitRp2 = "PLAZO FIJO " & " - " & lsPerson
                    End If
               Case Producto.gCapCTS
                    lnCarLin = 132
                    lsPerson = "PERSONA NATURAL - " & IIf(LTrim(RTrim(!Tipo)) = "CONVENIO", "EMPLEADOS", "CLIENTES")
                    If nrep = 2 Then
                        lsTitRp2 = "CTS " & IIf(nrep = 2, !Motivo, "") & " - " & lsPerson & " " & IIf(LTrim(RTrim(!Tipo)) = "CONVENIO", "EMPLEADOS CMAC - CONVENIO", "OTRAS EMPRESAS - EXTERNOS")
                    Else
                        lsTitRp2 = "CTS " & " - " & lsPerson & " " & IIf(LTrim(RTrim(!Tipo)) = "CONVENIO", "EMPLEADOS CMAC - CONVENIO", "OTRAS EMPRESAS - EXTERNOS")
                    End If
            End Select
            
            If lsTitRp2 <> lsCodPro Then
               If lsNumPag <> "" Then
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(16, " ") & IIf(Mid$(!cCtaCod, 6, 3) = Producto.gCapCTS, "", " ")
                  
                  
                  'lsRTFSdo = lsRTFSdo & oFunC.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                  If Left(lsCodPro, 7) = "AHORROS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                  ElseIf Left(lsCodPro, 3) = "CTS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                  Else
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
                     
                     If nrep <> 5 Then
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     End If
                     
                     If nrep = 5 Then
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     End If
                  End If
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(19, " ") & IIf(Mid$(!cCtaCod, 6, 3) = Producto.gCapCTS, "", " ")
                  
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & " "
                  If Left(lsCodPro, 7) = "AHORROS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                  ElseIf Left(lsCodPro, 3) = "CTS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                  Else
                     
                     If nrep <> 5 Then
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     End If
                     If nrep = 5 Then
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & " "
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     End If
                     
                  End If
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                  lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
                  lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
               End If
               lsCodPro = lsTitRp2
               lnLinPag = 65
            End If
            
            If lnLinPag > 58 Or CCodage <> !cAgeCod Then
               If lsNumPag <> "" Then
                  If lnSdoDis <> 0 Or lnCapita <> 0 Then
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                     lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(16, " ") & IIf(Mid$(!cCtaCod, 6, 3) = Producto.gCapCTS, "", " ")
                     
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
                     
                     If Left(lsCodPro, 7) = "AHORROS" Then
                     
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                     ElseIf Left(lsCodPro, 3) = "CTS" Then
                     
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                      
                     Else
                        If nrep <> 5 Then
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                        End If
                        
                        If nrep = 5 Then
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                        End If
                        
                     End If
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                     lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
                  End If
               End If
               
               lnCntPag = lnCntPag + 1
               lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
               lsRTFSdo = lsRTFSdo & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1 + " AGENCIA: " + !cAgeDescripcion, lsTitRp2, lsMoneda, lsNumPag) & oImp.gPrnSaltoLinea
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
               If Mid$(!cCtaCod, 6, 3) = Producto.gCapPlazoFijo Then
                        lsRTFSdo = lsRTFSdo & "   NUMERO    " & String(10, " ")
                        lsRTFSdo = lsRTFSdo & " NOMBRE / RAZON SOCIAL" & String(14, " ")
                        lsRTFSdo = lsRTFSdo & "   SALDO    "
                        lsRTFSdo = lsRTFSdo & "   CHEQUES  "
                  
                  If nrep <> 5 Then
                        lsRTFSdo = lsRTFSdo & "   SALDO    " & oImp.gPrnSaltoLinea
                  End If
                  If nrep = 5 Then
                        lsRTFSdo = lsRTFSdo & "   SALDO    "
                        lsRTFSdo = lsRTFSdo & "   INTERES  " & oImp.gPrnSaltoLinea
                  End If
                        lsRTFSdo = lsRTFSdo & "   CUENTA   " & String(10, " ")
                        lsRTFSdo = lsRTFSdo & "     DEL CLIENTE      " & String(14, " ")
                        lsRTFSdo = lsRTFSdo & "  DISPONIBLE"
                        lsRTFSdo = lsRTFSdo & "EN VAORIZAC."
                                                      
                  If nrep <> 5 Then
                        lsRTFSdo = lsRTFSdo & "  CONTABLE  " & oImp.gPrnSaltoLinea
                  End If
                  If nrep = 5 Then
                        lsRTFSdo = lsRTFSdo & "  CONTABLE  "
                        lsRTFSdo = lsRTFSdo & "  DEVENGADO " & oImp.gPrnSaltoLinea
                  End If
                                                  
                  
                  
               Else
                If nrep = 3 Or nrep = 4 Then
                
                  lsRTFSdo = lsRTFSdo & "   NUMERO    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & " NOMBRE / RAZON SOCIAL" & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "   SALDO     "
                  lsRTFSdo = lsRTFSdo & " CHEQUES     "
                  lsRTFSdo = lsRTFSdo & "   SALDO     "
                  lsRTFSdo = lsRTFSdo & "  ULTIMO   "
                  lsRTFSdo = lsRTFSdo & " NUMERO  " & oImp.gPrnSaltoLinea
                  
                  lsRTFSdo = lsRTFSdo & "   CUENTA    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "     DEL CLIENTE     " & String(14, " ")
                  lsRTFSdo = lsRTFSdo & " DISPONIBLE  "
                  lsRTFSdo = lsRTFSdo & "EN VAORIZAC. "
                  lsRTFSdo = lsRTFSdo & "  CONTABLE   "
                  lsRTFSdo = lsRTFSdo & " CONTACTO  "
                  lsRTFSdo = lsRTFSdo & "  DIAS   " & oImp.gPrnSaltoLinea
                
                Else
                
                  lsRTFSdo = lsRTFSdo & "   NUMERO    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & " NOMBRE / RAZON SOCIAL" & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "   SALDO     "
                  lsRTFSdo = lsRTFSdo & " CHEQUES     "
                  lsRTFSdo = lsRTFSdo & "   SALDO     " & oImp.gPrnSaltoLinea
                  lsRTFSdo = lsRTFSdo & "   CUENTA    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "     DEL CLIENTE     " & String(14, " ")
                  lsRTFSdo = lsRTFSdo & " DISPONIBLE  "
                  lsRTFSdo = lsRTFSdo & "EN VAORIZAC. "
                  lsRTFSdo = lsRTFSdo & "  CONTABLE   " & oImp.gPrnSaltoLinea
                  
                 End If
               End If
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea         ' hasta 160 caracteres x línea
               lnLinPag = 9
            End If
            lnCntRel = 0
               
               lsCodCta = !cCtaCod
               lbCtaIde = False
               lsRTFSdo = lsRTFSdo & !cCtaCod & " "
               If Len(Trim(!cpersnombre)) < 50 Then
                  lsRTFSdo = lsRTFSdo & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cpersnombre), False), 37), 37, " ") & " "
               Else
                  lsRTFSdo = lsRTFSdo & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cpersnombre), False), 37) & " "
               End If
               lnCtaPag = lnCtaPag + 1: lnTotCta = lnTotCta + 1
               
               Select Case Mid$(!cCtaCod, 6, 3)
                  Case Producto.gCapAhorros
                  
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!NSALDDISP, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!PORVALORIZAR, 12, True, 9, 2) & " "
                                           
                       If nrep = 3 Or nrep = 4 Then
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSaldCnt, 12, True, 9, 2) & "   "
                            lsRTFSdo = lsRTFSdo & Format(!DULTCONTACTO, "dd/MM/yyyy") & "   "
                            lsRTFSdo = lsRTFSdo & !Dias & Chr(10)
                        
                       Else
                        
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSaldCnt, 12, True, 9, 2) & Chr(10)
                       End If
                  

                       lnIntCap = 0
                  
                       
                       lnCapita = lnCapita + 0: lnCapiFi = lnCapiFi + 0
                       lnSdoCnt = lnSdoCnt + !nSaldCnt
                       lnCheEnV = lnCheEnV + !PORVALORIZAR
                       
                       lnSdoDis = lnSdoDis + !NSALDDISP
               
                       lnSdCnFi = lnSdCnFi + !nSaldCnt
               
                       lnSdDiFi = lnSdDiFi + !NSALDDISP
               
                       lbCtaIde = True
                  Case Producto.gCapPlazoFijo
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!NSALDDISP, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!PORVALORIZAR, 12, True, 9, 2) & " "
                                            
                       'Adicion Miguel 18-03-2004
                       
                       If nrep <> 5 Then
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSaldCnt, 12, True, 9, 2) & " " & Chr(10)
                       End If
                       
                       If nrep = 5 Then
                            
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSaldCnt, 12, True, 9, 2) & " "
                            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntDev)), 12, True, 9, 2) & Chr(10)
                            
                             lnCalInt = !nIntDev
                             lnIntDev = lnCalInt
                      
                            lnIntMes = lnIntMes + lnIntDev
                            lnSdInFi = lnSdInFi + lnIntDev
                       End If
                  
                                                           
                       lnSdoDis = lnSdoDis + !NSALDDISP
                       lnSdDiFi = lnSdDiFi + !NSALDDISP
                      
                       lnSdoCnt = lnSdoCnt + !nSaldCnt
                       lnSdCnFi = lnSdCnFi + !nSaldCnt
                       
                       lnCheEnV = lnCheEnV + !PORVALORIZAR
                       lnCheEnVFi = lnCheEnVFi + !PORVALORIZAR
                                                                   
               
                      ' lnCntRel = RelCta(!cCtaCod, !cCodPers)
                       lbCtaIde = True
                  Case Producto.gCapCTS
               
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!NSALDDISP, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!PORVALORIZAR, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSaldCnt, 12, True, 9, 2) & Chr(10)
                                                             
                                          
                       lnSdoDis = lnSdoDis + !NSALDDISP
                       lnSdDiFi = lnSdDiFi + !NSALDDISP
                                              
                       lnSdoCnt = lnSdoCnt + !nSaldCnt
                       lnSdCnFi = lnSdCnFi + !nSaldCnt
                       
                       lnCheEnV = lnCheEnV + !PORVALORIZAR
                       lnCheEnVFi = lnCheEnVFi + !PORVALORIZAR
                       
                       lbCtaIde = True
               End Select
'            End If
            lnCntCta = lnCntCta + 1
            lnLinPag = lnLinPag + lnCntRel + 1
            lsCuenta = Mid(!cCtaCod, 6, 3)
               
            CCodage = !cAgeCod
            codigocta = !cCtaCod
            .MoveNext
         Loop
    End With
    If rsData.EOF Then
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(16, " ") & IIf(lsCuenta = Producto.gCapCTS, "", " ")
      ' lsRTFSdo = lsRTFSdo & oFunC.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
       If Left(lsCodPro, 7) = "AHORROS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          
       ElseIf Left(lsCodPro, 3) = "CTS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          
       Else
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
          
          If nrep <> 5 Then
             lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          End If
          
          If nrep = 5 Then
             lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
             lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          End If
          
       End If
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(19, " ") & IIf(lsCuenta = Producto.gCapCTS, "", " ")
       
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & " "
       If Left(lsCodPro, 7) = "AHORROS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
        
       ElseIf Left(lsCodPro, 3) = "CTS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
        
       Else
          
          If nrep <> 5 Then
            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          End If
          If nrep = 5 Then
            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & " "
            lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
          End If
          
       End If
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
       lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
       lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
    End If
    Set ofuni = Nothing
    Set ofunc = Nothing
End Function


Private Function PrtSaldos(prQryDat As ADODB.Recordset, Optional nTipo As Integer = 1)
    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lnTotDep As Double, lnTotRet As Double
    Dim lsCodPro As String, lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsSubTit As String, lnCntCta As Integer
    Dim lnSdoCnt As Double, lnSdoDis As Double
    Dim lnCapita As Double, lsCodCta As String
    Dim lnCapiFi As Double, lnSdDiFi As Double, lnSdCnFi As Double
    Dim lnCheEnV As Double, lnCheEnVFi As Double
    Dim lnCtaPag As Integer, lnTotCta As Integer
    Dim lnIntMes As Double, lnSdInFi As Double
    Dim lnCntRel As Integer
    Dim lbCtaIde As Boolean
    Dim lnIntCap As Double
    Dim lnIntDev As Double, lnCalInt As Double
    Dim lbCieMes As Boolean
    Dim lnNumDia As Integer, CCodage As String
    Dim lsCuenta As String
    Dim codigocta As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim ofunc As New COMFunciones.FCOMCadenas
    
        If CierreRealizado(2) Then
        lbCieMes = True
    Else
        lbCieMes = False
    End If
    
    codigocta = ""
    lsNumPag = ""
    lnLinPag = 65
    lnCarLin = 105
    lsTitRp1 = "REPORTE DE SALDO DE CUENTA(S)"
    lsTitRp2 = ""
    lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
    lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
    lnCntPag = 0
    lbCtaIde = False
    
    With prQryDat
         Do While Not .EOF
         
         
            Select Case Mid$(!cCodCta, 6, 3)
               Case Producto.gCapAhorros
                    lnCarLin = 132
                    lsTitRp2 = "AHORROS" & IIf(Not !cOrdPag, "", " CON ORDEN DE PAGO") & " - " & lsPerson
               Case Producto.gCapPlazoFijo
                    lnCarLin = 119
                    lsTitRp2 = "PLAZO FIJO" & " - " & lsPerson
               Case Producto.gCapCTS
                    lnCarLin = 132
                    lsPerson = "PERSONA NATURAL - " & IIf(LTrim(RTrim(!cCodInst)) = gsInstCmac, "EMPLEADOS", "CLIENTES")
                    lsTitRp2 = "CTS" & " - " & lsPerson & " " & IIf(nTipo = 2, "EMPLEADOS CMAC - CONVENIO", IIf(nTipo = 3, "OTRAS EMPRESAS - EXTERNOS", ""))
            End Select
            
            If lsTitRp2 <> lsCodPro Then
               If lsNumPag <> "" Then
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(16, " ") & IIf(Mid$(!cCodCta, 6, 3) = Producto.gCapCTS, "", " ")
                  
                  
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                  If Left(lsCodPro, 7) = "AHORROS" Then
                     
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                  ElseIf Left(lsCodPro, 3) = "CTS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                  Else
                  
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                  End If
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(19, " ") & IIf(Mid$(!cCodCta, 6, 3) = Producto.gCapCTS, "", " ")
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapiFi)), 12, True, 9, 2) & " "
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
                  If Left(lsCodPro, 7) = "AHORROS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  Else
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & " " '& oImp.gPrnSaltoLinea
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  End If
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                  lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
                  lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
               End If
               lsCodPro = lsTitRp2
               lnLinPag = 65
            End If
            
            If lnLinPag > 58 Or CCodage <> !cAgeCod Then
               If lsNumPag <> "" Then
                  If lnSdoDis <> 0 Or lnCapita <> 0 Then
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                     lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(16, " ") & IIf(Mid$(!cCodCta, 6, 3) = Producto.gCapCTS, "", " ")
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     If Left(lsCodPro, 7) = "AHORROS" Then
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     ElseIf Left(lsCodPro, 3) = "CTS" Then
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "  '& oImp.gPrnSaltoLinea
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                      
                     Else
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "  '& oImp.gPrnSaltoLinea
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     End If
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                     lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
                  End If
               End If
               
               lnCntPag = lnCntPag + 1
               lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
               lsRTFSdo = lsRTFSdo & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1 + " AGENCIA: " + !cAgeDescripcion, lsTitRp2, lsMoneda, lsNumPag) & oImp.gPrnSaltoLinea
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
               If Mid$(!cCodCta, 6, 3) = Producto.gCapPlazoFijo Then
                  lsRTFSdo = lsRTFSdo & "   NUMERO    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "NOMBRE / RAZON SOCIAL" & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "             "
                  lsRTFSdo = lsRTFSdo & "   INTERES   "
                  lsRTFSdo = lsRTFSdo & "   SALDO    " '& " "
                  lsRTFSdo = lsRTFSdo & "    CHEQUES  "
                  lsRTFSdo = lsRTFSdo & "    ULTIMO" & oImp.gPrnSaltoLinea
                  lsRTFSdo = lsRTFSdo & "   CUENTA    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "     DEL CLIENTE     " & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "   CAPITAL   "
                  lsRTFSdo = lsRTFSdo & "  DEVENGADO  "
                  lsRTFSdo = lsRTFSdo & "  CONTABLE  " '& " "
                  lsRTFSdo = lsRTFSdo & "   EN VALORIZ."
                  lsRTFSdo = lsRTFSdo & "MOVIMIENTO" & oImp.gPrnSaltoLinea
               Else
                  lsRTFSdo = lsRTFSdo & "   NUMERO    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "NOMBRE / RAZON SOCIAL" & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "             "
                  lsRTFSdo = lsRTFSdo & "   SALDO     "
                  lsRTFSdo = lsRTFSdo & "   SALDO     "
                  lsRTFSdo = lsRTFSdo & "  CHEQUES    "
                  lsRTFSdo = lsRTFSdo & "   INTERESES" & " "
                  lsRTFSdo = lsRTFSdo & "  ULTIMO" & oImp.gPrnSaltoLinea
                  lsRTFSdo = lsRTFSdo & "   CUENTA    " & String(10, " ")
                  lsRTFSdo = lsRTFSdo & "     DEL CLIENTE     " & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "   CAPITAL   "
                  lsRTFSdo = lsRTFSdo & " DISPONIBLE  "
                  lsRTFSdo = lsRTFSdo & "  CONTABLE   "
                  lsRTFSdo = lsRTFSdo & " EN VALORIZ. "
                  lsRTFSdo = lsRTFSdo & "    DEL  MES" & " "
                  lsRTFSdo = lsRTFSdo & "MOVIMIENTO" & oImp.gPrnSaltoLinea
               End If
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea         ' hasta 160 caracteres x línea
               lnLinPag = 9
            End If
            lnCntRel = 0
            If !cCodCta = lsCodCta Then
               If lbCtaIde = False Then
                  lnCntRel = RelCta(!cCodCta, !cCodPers)
                  '********AGREGADOS MPBR*******
                   'lsRTFSdo = String(19, " ")
                   'If Len(Trim(!cNomPers)) < 50 Then
                    '    lsRTFSdo = lsRTFSdo & FillText(Left(PstaNombre(oFunI.ImpreCarEsp(!cNomPers), False), 37), 37, " ") & " "
                   'Else
                   '     lsRTFSdo = lsRTFSdo & Left(PstaNombre(oFunI.ImpreCarEsp(!cNomPers), False), 37) & " "
                   'End If
                  'lbCtaIde = False
                  '********AGREGADOS MPBR*********
                  lbCtaIde = True
               End If
            Else
               lsCodCta = !cCodCta
               lbCtaIde = False
               lsRTFSdo = lsRTFSdo & !cCodCta & " "
               If Len(Trim(!cNomPers)) < 50 Then
                  lsRTFSdo = lsRTFSdo & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 37), 37, " ") & " "
               Else
                  lsRTFSdo = lsRTFSdo & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cNomPers), False), 37) & " "
               End If
               lnCtaPag = lnCtaPag + 1: lnTotCta = lnTotCta + 1
               
               Select Case Mid$(!cCodCta, 6, 3)
                  Case Producto.gCapAhorros
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum("0.00", 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoDis, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoCnt, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!chequesenv, 12, True, 9, 2) & " "

                       lnIntCap = 0
                       If lbCieMes Then
                            lnIntCap = !nSdoDis - !nSdoAnt
                       Else
                            lnIntCap = !nIntMes
                       End If
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntCap)), 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & Format(!dUltMovAC, ofunf.gsFormatoFechaView) & Chr(10)
                       
                       lnCapita = lnCapita + 0: lnCapiFi = lnCapiFi + 0
                       lnSdoCnt = lnSdoCnt + !nSdoCnt
                       lnSdoDis = lnSdoDis + !nSdoDis
                       lnIntMes = lnIntMes + lnIntCap
                       lnSdCnFi = lnSdCnFi + !nSdoCnt
                       lnCheEnV = lnCheEnV + !chequesenv
                       lnCheEnVFi = lnCheEnVFi + !chequesenv
                       lnSdDiFi = lnSdDiFi + !nSdoDis
                       lnSdInFi = lnSdInFi + lnIntCap
                       lnCntRel = RelCta(!cCodCta, !cCodPers)
                       lbCtaIde = True
                  Case Producto.gCapPlazoFijo
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nCapital, 12, True, 9, 2) & " "
                       
                       lnNumDia = DateDiff("d", !dUltMovPF, gdFecSis) - 1
                       
                       'Adicion Miguel 18-03-2004
                       lnCalInt = !nIntDev
                       
                       'lnCalInt = GetInteres(!nTasaInteres, (!nIntDev + !nCapital), lnNumDia, False)
                       
                       lnIntDev = lnCalInt
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntDev)), 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoCnt, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!chequesenv, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & Format(!dUltMovPF, ofunf.gsFormatoFechaView) & Chr(10)
                       
                       lnCapita = lnCapita + !nCapital
                       lnCapiFi = lnCapiFi + !nCapital
                       lnSdoDis = lnSdoDis + lnIntDev
                       lnSdDiFi = lnSdDiFi + lnIntDev
                       lnSdoCnt = lnSdoCnt + !nSdoCnt
                       lnSdCnFi = lnSdCnFi + !nSdoCnt
                       lnCheEnV = lnCheEnV + !chequesenv
                       lnCheEnVFi = lnCheEnVFi + !chequesenv
                       lnCntRel = RelCta(!cCodCta, !cCodPers)
                       lbCtaIde = True
                  Case Producto.gCapCTS
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nCapital, 11, True, 8, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoDis, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSdoCnt, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!chequesenv, 12, True, 9, 2) & " "
                       lnIntCap = !nIntMes
'                       If lbCieMes Then
'                            lnIntCap = !nSdoDis - !nSdoAnt
'                       Else
'                            lnIntCap = !nIntMes
'                       End If
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntCap)), 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & Format(!dUltMovCTS, ofunf.gsFormatoFechaView) & Chr(10)
                       
                       lnCapita = lnCapita + !nCapital
                       lnCapiFi = lnCapiFi + !nCapital
                       lnSdoCnt = lnSdoCnt + !nSdoCnt
                       lnSdCnFi = lnSdCnFi + !nSdoCnt
                       lnCheEnV = lnCheEnV + !chequesenv
                       lnCheEnVFi = lnCheEnVFi + !chequesenv
                       lnSdoDis = lnSdoDis + !nSdoDis
                       lnSdDiFi = lnSdDiFi + !nSdoDis
                       lnIntMes = lnIntMes + lnIntCap
                       lnSdInFi = lnSdInFi + lnIntCap
                       lnCntRel = RelCta(!cCodCta, !cCodPers)
                       lbCtaIde = True
               End Select
            End If
            lnCntCta = lnCntCta + 1
            lnLinPag = lnLinPag + lnCntRel + 1
            lsCuenta = Mid(!cCodCta, 6, 3)
               
            CCodage = !cAgeCod
            codigocta = !cCodCta
            .MoveNext
         Loop
    End With
    If prQryDat.EOF Then
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(16, " ") & IIf(lsCuenta = Producto.gCapCTS, "", " ")
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapita)), 12, True, 9, 2) & " "
       If Left(lsCodPro, 7) = "AHORROS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       ElseIf Left(lsCodPro, 3) = "CTS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnIntMes)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       Else
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & " " '& oImp.gPrnSaltoLinea
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnV)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       End If
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(19, " ") & IIf(lsCuenta = Producto.gCapCTS, "", " ")
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCapiFi)), 12, True, 9, 2) & " "
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
       If Left(lsCodPro, 7) = "AHORROS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       ElseIf Left(lsCodPro, 3) = "CTS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdInFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       Else
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & " " '& oImp.gPrnSaltoLinea
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnCheEnVFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       End If
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
       lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
       lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
    End If
    Set ofunc = Nothing
    Set ofuni = Nothing
End Function

Public Function ReporteNoCobroInactivas(Optional ByVal CCodage As String = "", Optional ByVal gdFecSis As Date) As String
 Dim oCon As COMConecta.DCOMConecta, sSql As String, rsTemp As ADODB.Recordset, sqlaux As String
 Dim ofunc As New COMFunciones.FCOMCadenas
 Dim ofuni As New COMFunciones.FCOMImpresion
 
 sqlaux = ""
 
 Set oCon = New COMConecta.DCOMConecta
 
 If CCodage <> "" Then
    sqlaux = " and substring(p.cctacod,4,2)='" & CCodage & "'"
 End If
    
     oCon.AbreConexion
     
        sSql = "  Select p.Cctacod, "
        sSql = sSql & " cpersnombre=( Select top  1  f.cpersnombre from persona f join  productopersona pp  on pp.cperscod=f.cperscod    where pp.nprdpersrelac=10 and pp.cctacod=p.cctacod ), "
        sSql = sSql & "  SaldoCnt=p.nsaldo,SaldoDisp=c.nsaldodisp "
        sSql = sSql & " from Producto p "
        sSql = sSql & " join Captaciones c on c.cctacod=p.cctacod "
        sSql = sSql & "  join CaptacAhorros ca on ca.cctacod=p.cctacod "
        sSql = sSql & " where p.nprdestado not in ('1400','1300' ) and ca.bnocobroinactivas=1 " & sqlaux
        sSql = sSql & "    ORDER BY substring(p.cctacod,4,2),CPERSNOMBRE  "
        
        
        Set rsTemp = oCon.CargaRecordSet(sSql)
               
    Dim lnCarLin As Integer, i As Integer
    Dim lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsCodAge As String
    Dim lsCuenta As String
    Dim ClsAge As COMDConstantes.DCOMAgencias
    Set ClsAge = New COMDConstantes.DCOMAgencias
    
    
    lsNumPag = ""
    'lnLinPag = 65
    lnCarLin = 95
    'lsTitRp1 = " REPORTE DE CUENTAS EXONERADAS DE COBRO DE INACTIVAS " & IIf(CcodAge <> "", clsage.NombreAgencia(CcodAge), "")
    lnLinPag = 0
    lsCodAge = ""
    
    lsRTFSdo = "" '& Chr(10) & Chr(10) & Chr(10) & Chr(10)
    
    i = i + 1
    While Not rsTemp.EOF
    
         If lsCodAge = "" Or lnLinPag > 65 Then
            
            lsRTFSdo = lsRTFSdo & Chr(10) & Chr(10) & Chr(10) & Chr(10)
            lsCodAge = CCodage
            lsRTFSdo = lsRTFSdo & Space(10) & "CMAC ICA" & Space(70) & "FECHA: " & gdFecSis & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(10) & Space(8) & Space(70) & "HORA:" & oCon.GetHoraServer() & Chr(10) & Chr(10)
            
            lsRTFSdo = lsRTFSdo & Space(15) & " REPORTE DE CUENTAS EXONERADAS DE COBRO DE INACTIVAS " & IIf(CCodage <> "", ClsAge.NombreAgencia(CCodage), "") & Chr(10) & Chr(10)
            
            
            lsRTFSdo = lsRTFSdo & Space(10) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
            lsRTFSdo = lsRTFSdo & Space(10) & "   NRO.   "
            lsRTFSdo = lsRTFSdo & "   CUENTA           "
            lsRTFSdo = lsRTFSdo & "   TITULAR                           "
            lsRTFSdo = lsRTFSdo & "   SALDO CONT. "
            lsRTFSdo = lsRTFSdo & "   SALDO DISP. " & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(10) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                        
         End If
                
            lsRTFSdo = lsRTFSdo & Space(8) & ofunc.FillNum(Trim(Str(i)), 10, " ") & Space(1) & Trim(rsTemp!cCtaCod) & Space(1) & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(rsTemp!cpersnombre), False), 37), 37, " ") & ofunc.JDNum(Trim(Str(rsTemp!SaldoCnt)), 11, True, 9, 2) & Space(3) & ofunc.JDNum(Trim(Str(rsTemp!SaldoDisp)), 11, True, 9, 2) & Chr(10)
             
            If lnLinPag = 65 Then
                lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoPagina
            End If
             
            lnLinPag = lnLinPag + 1
            i = i + 1
            
             rsTemp.MoveNext
    Wend
    
    
    ReporteNoCobroInactivas = lsRTFSdo
    Set ClsAge = Nothing
    Set rsTemp = Nothing
    Set oCon = Nothing
    Set ofunc = Nothing
    Set ofuni = Nothing
    'oCon.CierraConexion
    
End Function
Public Function CUPONIMPRIMIR(ByVal CnumSorteo As String, ByVal cNombre1 As String, ByVal cNumRangoIni As String, ByVal cNumRangoFin As String, ByVal cNumCuenta As String, ByVal cTipo As Integer, Optional ByVal CnumCupon As Long, Optional ByVal cNumRangoIniPrint As Long, Optional ByVal cNumRangoFinPrint As Long, Optional ByVal cNombre2 As String = "", Optional ByVal cNombre3 As String = "", Optional ByVal cNombre4 As String = "", Optional ByVal cNombre5 As String = "", Optional ByVal nNumCup As Integer = 0) As String
'clsage.NombreAgencia(CCodAge)
  Dim ClsAge As COMDConstantes.DCOMAgencias, CCodage As String
  Set ClsAge = New COMDConstantes.DCOMAgencias
  
   CCodage = Mid(cNumCuenta, 4, 2)
  
Dim sFecha As String, sHora As String
Dim sSep As Integer, sIni As Integer, sMax As Integer
Dim lsNegritaOn As String
Dim lsNegritaOff As String
Dim lsNroExt As String
Dim lnTope As Integer
Dim lsCadArg As String
Dim sCad As String



lnTope = 0 '6 'Tope de lineas en Boleta

lsNegritaOn = Chr$(27) + Chr$(71)
lsNegritaOff = Chr$(27) + Chr$(72)

'lsNroExt = Str(pnNumExt)


sCad = sCad & Chr$(27) & Chr$(64)

sCad = sCad & Chr$(27) & Chr$(50)   'espaciamiento lineas 1/6 pulg.
sCad = sCad & Chr$(27) & Chr$(67) & Chr$(21)
'sCad = sCad & Chr$(27) & Chr$(67) & Chr$(22)  'Longitud de página a 22 líneas'
sCad = sCad & Chr$(27) & Chr$(77)   'Tamaño 10 cpi
sCad = sCad & Chr$(27) + Chr$(107) + Chr$(0)     'Tipo de Letra Sans Serif
sCad = sCad & Chr$(27) + Chr$(18) ' cancela condensada
sCad = sCad & Chr$(27) + Chr$(72) ' desactiva negrita

sSep = 15
sIni = 1




'cNumRangoIni As String, ByVal cNumRangoFin

'scad = scad & oImp.gPrnSaltoLinea;
If cTipo = "1" Then
    sCad = sCad & lsNegritaOn 'Activa Negrita
    'sCad = sCad & Chr(10) & Chr(10) & Chr(10) & lsNegritaOn 'Activa Negrita
    sCad = sCad & lsNegritaOn     'Activa Negrita
    sCad = sCad & Space(sIni) & "CMACCUSCO - PREMIAHORRO " & CnumSorteo & " " & ClsAge.NombreAgencia(CCodage) & Chr(10)
    sCad = sCad & Space(sIni) & UCase(cNombre1) & Chr(10)
    sCad = sCad & Space(sIni) & UCase(cNombre2) & Chr(10)
    sCad = sCad & Space(sIni) & UCase(cNombre3) & Chr(10)
    sCad = sCad & Space(sIni) & UCase(cNombre4) & Chr(10)
    sCad = sCad & Space(sIni) & UCase(cNombre5) & Chr(10)
    sCad = sCad & Space(sIni) & "DEL CUPON NRO. " & cNumRangoIni & " AL " & cNumRangoFin & Space(1) & "Nro Cupones:" & CStr(nNumCup) & Chr(10)
    sCad = sCad & Space(sIni) & "NRO. CUENTA " & cNumCuenta & " " & Chr(10)
    sCad = sCad & Space(sIni) & "CMACCUSCO - PREMIAHORRO " & CnumSorteo & " " & ClsAge.NombreAgencia(CCodage) & Chr(10) & Chr(10) & Chr(12)
    sCad = sCad & lsNegritaOff 'Desactiva Negrita
        
ElseIf cTipo = "2" Then
    For i = cNumRangoIniPrint To cNumRangoFinPrint
            sCad = sCad & lsNegritaOn 'Activa Negrita
            sCad = sCad & Chr(10) & Chr(10) & Chr(10) & lsNegritaOn 'Activa Negrita
            sCad = sCad & Space(sIni) & "CMACCUSCO - PREMIAHORRO " & CStr(i) & Chr(10) & Chr(10)
            sCad = sCad & Space(sIni) & UCase(cNombre1) & Chr(10)
            sCad = sCad & "DEL CUPON NRO. " & cNumRangoIni & " AL " & cNumRangoFin & Chr(10)
            sCad = sCad & "RANGO IMPRESO DEL " & cNumRangoIniPrint & " AL " & cNumRangoFinPrint & Chr(10)
            sCad = sCad & "NRO. " & CnumCupon & Chr(10)
            sCad = sCad & "NRO. CUENTA " & cNumCuenta & " " & Chr(10)
            sCad = sCad & Space(sIni) & "CMACCUSCO - PREMIAHORRO " & CnumSorteo & Chr(10) & Chr(10) & Chr(12)
            sCad = sCad & lsNegritaOff 'Desactiva Negrita
        
    Next i
ElseIf cTipo = "3" Then
    
            sCad = sCad & lsNegritaOn 'Activa Negrita
            sCad = sCad & Chr(10) & Chr(10) & Chr(10) & lsNegritaOn 'Activa Negrita
            sCad = sCad & Space(sIni) & "CMACCUSCO - PREMIAHORRO " & CStr(i) & Chr(10) & Chr(10)
            sCad = sCad & Space(sIni) & UCase(cNombre1) & Chr(10)
            sCad = sCad & "DEL CUPON NRO. " & cNumRangoIni & " AL " & cNumRangoFin & Chr(10)
            sCad = sCad & "NRO. " & CnumCupon & Chr(10)
            sCad = sCad & "NRO. CUENTA " & cNumCuenta & " " & Chr(10)
            sCad = sCad & Space(sIni) & "CMACCUSCO - PREMIAHORRO " & CnumSorteo & Chr(10) & Chr(10) & Chr(12)
            sCad = sCad & lsNegritaOff 'Desactiva Negrita

End If

        CUPONIMPRIMIR = sCad
        Set ClsAge = Nothing
Exit Function
End Function
Public Function CONSOLIDADOSORTEO(ByVal CnumSorteo As String, Optional CCodage As String, Optional Ccodageant As String, Optional bFinal As Boolean = False, Optional ByRef ContaL As Integer) As String
Dim oCon As COMConecta.DCOMConecta, sSql As String, rsTemp As ADODB.Recordset, contalineas As Integer
    Set oCon = New COMConecta.DCOMConecta
    Set rsTemp = New ADODB.Recordset
    contalineas = 0
     oCon.AbreConexion
     If bFinal = False Then
             If CCodage = "00" Then
                sSql = "Select  c.cnumsorteo, cagecod=substring(cctacod,4,2),"
                sSql = sSql & " CANCELADOS=SUM(CASE WHEN BCANCELAR=1 and (NNUMGANADOR IS NULL or NNUMGANADOR=0) THEN NNUMTICKETS ELSE 0 END), "
                sSql = sSql & " ANULADOS=SUM(CASE WHEN BANULAR=1 THEN NNUMTICKETS ELSE 0 END), "
                'sSQL = sSQL & " ANULADOS_GANADORES=SUM(CASE WHEN BCANCELAR=1 AND  (NNUMGANADOR IS NOT NULL AND NNUMGANADOR<>0)  THEN NNUMTICKETS ELSE 0 END), "
                sSql = sSql & " ANULGANADORES=SUM(CASE WHEN BCANCELAR=1 AND  (NNUMGANADOR IS NOT NULL AND NNUMGANADOR<>0)  THEN NNUMTICKETS-1 ELSE 0 END), "
                sSql = sSql & " VIGENTES=SUM(CASE WHEN (BANULAR IS NULL AND BCANCELAR IS NULL)THEN NNUMTICKETS ELSE 0 END) "
                sSql = sSql & " From cuentasorteo C "
                sSql = sSql & " where LEFT(CNUMSORTEO,6)='" & CnumSorteo & "'  "
                sSql = sSql & " GROUP BY C.CNUMSORTEO ,substring(cctacod,4,2)"
                
             Else
                sSql = "Select  c.cnumsorteo, cagecod=substring(cctacod,4,2), "
                sSql = sSql & " CANCELADOS=SUM(CASE WHEN BCANCELAR=1 AND  (NNUMGANADOR IS NULL or NNUMGANADOR=0) THEN NNUMTICKETS ELSE 0 END), "
                sSql = sSql & " ANULADOS=SUM(CASE WHEN BANULAR=1 THEN NNUMTICKETS ELSE 0 END), "
                'sSQL = sSQL & " ANULADOS_GANADORES=SUM(CASE WHEN BCANCELAR=1 AND  (NNUMGANADOR IS NOT NULL AND NNUMGANADOR<>0)  THEN NNUMTICKETS ELSE 0 END), "
                sSql = sSql & " ANULGANADORES=SUM(CASE WHEN BCANCELAR=1 AND  (NNUMGANADOR IS NOT NULL AND NNUMGANADOR<>0)  THEN NNUMTICKETS-1 ELSE 0 END), "
                sSql = sSql & " VIGENTES=SUM(CASE WHEN (BANULAR IS NULL AND BCANCELAR IS NULL)THEN NNUMTICKETS ELSE 0 END) "
                sSql = sSql & " From cuentasorteo C "
                sSql = sSql & " where LEFT(CNUMSORTEO,6)='" & CnumSorteo & "'"   'and substring(cctacod,4,2)='" & CCodage & "' "
                sSql = sSql & " GROUP BY C.CNUMSORTEO ,substring(cctacod,4,2) "
                    
             End If
    Else
             If CCodage = "00" Then
                sSql = "Select  c.cnumsorteo, cagecod=substring(cctacod,4,2), "
                sSql = sSql & " GANADOS=SUM(CASE WHEN BGANADOR=1 AND (NNUMGANADOR IS NOT NULL AND NNUMGANADOR<>0) THEN 1 ELSE 0 END), "
                sSql = sSql & " CANCELADOS=SUM(CASE WHEN BCANCELAR=1 AND (NNUMGANADOR IS NULL OR NNUMGANADOR=0)  THEN NNUMTICKETS ELSE 0  END), "
                sSql = sSql & " ANULADOS=SUM(CASE WHEN BANULAR=1 THEN NNUMTICKETS ELSE 0 END), "
                sSql = sSql & " ANULGANADORES=SUM(CASE WHEN BCANCELAR=1 AND  (NNUMGANADOR IS NOT NULL AND NNUMGANADOR<>0)  THEN NNUMTICKETS ELSE 0 END), "
                sSql = sSql & " VIGENTES=SUM(CASE WHEN (BANULAR IS NULL AND BCANCELAR IS NULL)THEN NNUMTICKETS ELSE 0 END) "
                sSql = sSql & " From cuentasorteo C "
                sSql = sSql & " where LEFT(CNUMSORTEO,6)='" & CnumSorteo & "'"
                sSql = sSql & " GROUP BY C.CNUMSORTEO ,substring(cctacod,4,2)"
                
             Else
                sSql = "Select  c.cnumsorteo, cagecod=substring(cctacod,4,2),"
                sSql = sSql & " GANADOS=SUM(CASE WHEN BGANADOR=1 THEN 1 ELSE 0 END), "
                sSql = sSql & " CANCELADOS=SUM(CASE WHEN BCANCELAR=1 AND (NNUMGANADOR IS NULL OR NNUMGANADOR=0) THEN NNUMTICKETS ELSE 0  END), "
                sSql = sSql & " ANULADOS=SUM(CASE WHEN BANULAR=1 THEN NNUMTICKETS ELSE 0 END), "
                sSql = sSql & " ANULGANADORES=SUM(CASE WHEN BCANCELAR=1 AND  (NNUMGANADOR IS NOT NULL AND NNUMGANADOR<>0) THEN NNUMTICKETS-1 ELSE 0 END), "
                sSql = sSql & " VIGENTES=SUM(CASE WHEN (BANULAR IS NULL AND BCANCELAR IS NULL)THEN NNUMTICKETS ELSE 0 END) "
                sSql = sSql & " From cuentasorteo C "
                sSql = sSql & " where LEFT(CNUMSORTEO,6)='" & CnumSorteo & "'"  'and substring(cctacod,4,2)='" & CCodage & "' "
                sSql = sSql & " GROUP BY C.CNUMSORTEO ,substring(cctacod,4,2)"
                    
             End If
         
    End If
                
                
                Set rsTemp = oCon.CargaRecordSet(sSql)
                    
             oCon.CierraConexion
             
             
            Dim lnCarLin As Integer, i As Integer
            Dim lsNumPag As String
            Dim lnLinPag As Integer, lnCntPag As Integer
            Dim lsCodAge As String
            Dim lsCuenta As String
            Dim ClsAge As COMDConstantes.DCOMAgencias
            Set ClsAge = New COMDConstantes.DCOMAgencias
            Dim ofunc As New COMFunciones.FCOMCadenas
            
            
            lsNumPag = ""
            'lnLinPag = 65
            lnCarLin = 100
            'lsTitRp1 = " REPORTE DE CUENTAS EXONERADAS DE COBRO DE INACTIVAS " & IIf(CcodAge <> "", clsage.NombreAgencia(CcodAge), "")
            lnLinPag = 0
            'lsCodAge = Ccodageant
            lsCodAge = ""
            lsRTFSdo = "" '& Chr(10) & Chr(10) & Chr(10) & Chr(10)
            
            i = ContaL + 1
            
            
            While Not rsTemp.EOF
                        
                 
                  
                 If lsCodAge = "" Or ContaL > 50 Then 'Or lnLinPag > 65
                    
                 
'                    If Ccodageant <> rstemp!cAgeCod And Ccodageant <> "" Then
'                        lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoLinea
'                        Ccodageant = rstemp!cAgeCod
'
'                    End If
                   
                    
                    lsRTFSdo = lsRTFSdo & Chr(10) & Chr(10) & Chr(10) & Chr(10)
                    lsRTFSdo = lsRTFSdo & Space(10) & "CMAC ICA" & Space(70) & "FECHA: " & gdFecSis & Chr(10)
                    lsRTFSdo = lsRTFSdo & Space(10) & Space(8) & Space(70) & "HORA:" & oCon.GetHoraServer() & Chr(10) & Chr(10)
                    
                    lsRTFSdo = lsRTFSdo & Space(15) & " LISTADO CONSOLIDADO DE SORTEO  " & CnumSorteo & IIf(CCodage <> "", " - " & ClsAge.NombreAgencia(CCodage), "") & Chr(10) & Chr(10)
                    
                    
                        lsRTFSdo = lsRTFSdo & Space(4) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                        lsRTFSdo = lsRTFSdo & Space(4) & "NRO SORTEO.   "
                        lsRTFSdo = lsRTFSdo & "AGENCIA              "
                        lsRTFSdo = lsRTFSdo & "CANCELADOS  "
                        lsRTFSdo = lsRTFSdo & "ANULADOS    "
                    If bFinal = True Then
                        lsRTFSdo = lsRTFSdo & "GANADORES   "
                    End If
                        lsRTFSdo = lsRTFSdo & "ANUL-GANADOR"
                    
                
                        lsRTFSdo = lsRTFSdo & "  VIGENTES  " & oImp.gPrnSaltoLinea
                    lsRTFSdo = lsRTFSdo & Space(4) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                         lnLinPag = 0
                 End If
                        
                        
                    If bFinal = True Then
                         lsRTFSdo = lsRTFSdo & ofunc.FillNum(Trim(Str(i)), 5, " ") & Space(1) & Trim(rsTemp!CnumSorteo) & Space(1) & Left(Trim(ClsAge.NombreAgencia(rsTemp!cAgeCod)), 20) & Space(21 - Len(Left(Trim(ClsAge.NombreAgencia(rsTemp!cAgeCod)), 20))) & ofunc.JDNum(Trim(Str(rsTemp!CANCELADOS)), 11, True, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!ANULADOS)), 11, True, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!GANADOS)), 11, True, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!ANULGANADORES)), 11, True, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!VIGENTES)), 11, True, 11, 0) & Chr(10)
                    Else
                         lsRTFSdo = lsRTFSdo & ofunc.FillNum(Trim(Str(i)), 5, " ") & Space(1) & Trim(rsTemp!CnumSorteo) & Space(1) & Left(Trim(ClsAge.NombreAgencia(rsTemp!cAgeCod)), 20) & Space(21 - Len(Left(Trim(ClsAge.NombreAgencia(rsTemp!cAgeCod)), 20))) & ofunc.JDNum(Trim(Str(rsTemp!CANCELADOS)), 11, True, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!ANULADOS)), 11, True, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!ANULGANADORES)), 11, True, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!VIGENTES)), 11, True, 11, 0) & Chr(10)
                    End If
                    
                     
                    If contalineas = 50 Then
                        lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoPagina
                    End If
                     
                    lsCodAge = rsTemp!cAgeCod
                    
                    lnLinPag = lnLinPag + 1
                    contalineas = ContaL + 1
                    ContaL = contalineas
                    
                   i = ContaL + 1
                                
                               
                    rsTemp.MoveNext
                     
            Wend
     
  CONSOLIDADOSORTEO = lsRTFSdo
     
    Set rsTemp = Nothing
    Set oCon = Nothing
    Set ClsAge = Nothing
    Set ofunc = Nothing

End Function
Public Function CUPONESBATCH(ByVal CnumSorteo As String, ByVal CCodage As String, Optional Ccodageant As String, Optional ByVal RangoIni As String = "0", Optional ByVal RangoFin As String = "0", Optional ByVal nImpresiones As Long = 0, Optional ByRef rsTmpCup As Recordset) As String
  Dim oCon As COMConecta.DCOMConecta, sSql As String, rsTemp As ADODB.Recordset, rsRel As ADODB.Recordset
  Dim sDato(1 To 5) As String
  Dim clsMant As NCOMCaptaGenerales, i As Integer, sqlaux As String
  Dim ofunc As New COMFunciones.FCOMCadenas
  
  sqlaux = ""
     
  If RangoIni <> "0" And RangoFin <> "0" Then
    sqlaux = " and cast(c.nrangoini as int)>=cast( " & RangoIni & " as int ) and cast(c.nrangofin as int)<=cast( " & RangoFin & " as int )"
  End If
  If nImpresiones = 0 Then
    sqlaux = sqlaux & " and isnull(c.nimpresiones,0)=" & nImpresiones
  ElseIf nImpresiones = 1 Then
    sqlaux = sqlaux & " and c.nimpresiones>=" & nImpresiones
  End If
  
  
  
  Dim ClsAge As COMDConstantes.DCOMAgencias
  Set ClsAge = New COMDConstantes.DCOMAgencias
   
   Set clsMant = New COMNCaptaGenerales.NCOMCaptaGenerales
   
    Dim sFecha As String, sHora As String, sSep As Integer
    Dim sIni As Integer, lsNegritaOn As String, lsNegritaOff As String
    Dim lsNroExt As String, lnTope As Integer
    Dim sCad As String
  
  Set oCon = New COMConecta.DCOMConecta
  Set rsTemp = New ADODB.Recordset
  
  oCon.AbreConexion
      
      
    sSql = " Select c.cperscod,cNumCta=c.cctacod ,cnombre=p.cpersnombre,cNumRangoIni=c.nrangoini,cNumRangoFin=c.nrangofin,cNumCupones=c.nNumTickets from cuentasorteo c "
    sSql = sSql & " join persona p on p.cperscod=c.cperscod  WHERE left(CNUMSORTEO,6)='" & Left(CnumSorteo, 6) & "' and  substring(c.cctacod,4,2)='" & CCodage & "'"
    sSql = sSql & " and (bcancelar<>1 or bcancelar is null )  and (  banular<>1 or banular is null)  " & sqlaux
    sSql = sSql & " order by cast(nrangoini as int)"
    
    Set rsTemp = oCon.CargaRecordSet(sSql)
    
    Set rsTmpCup = rsTemp
      
     oCon.CierraConexion
     Set oCon = Nothing
     

    
    
    lnTope = 0 '6 'Tope de lineas en Boleta
    
    lsNegritaOn = Chr$(27) + Chr$(71)
    lsNegritaOff = Chr$(27) + Chr$(72)
   
    
    sCad = sCad & Chr$(27) & Chr$(64)
    
    sCad = sCad & Chr$(27) & Chr$(50)   'espaciamiento lineas 1/6 pulg.
    sCad = sCad & Chr$(27) & Chr$(67) & Chr$(21)
    'sCad = sCad & Chr$(27) & Chr$(67) & Chr$(22)  'Longitud de página a 22 líneas'
    sCad = sCad & Chr$(27) & Chr$(77)   'Tamaño 10 cpi
    sCad = sCad & Chr$(27) + Chr$(107) + Chr$(0)     'Tipo de Letra Sans Serif
    sCad = sCad & Chr$(27) + Chr$(18) ' cancela condensada
    sCad = sCad & Chr$(27) + Chr$(72) ' desactiva negrita
    
    sSep = 15
    sIni = 1

    
    
    
    'lsNomAge = sNomAge
    
    'cNumRangoIni As String, ByVal cNumRangoFin
    
    'scad = scad & oImp.gPrnSaltoLinea;
    While Not rsTemp.EOF
        sDato(1) = ""
        sDato(2) = ""
        sDato(3) = ""
        sDato(4) = ""
        sDato(5) = ""
        
    
        Set rsRel = clsMant.GetPersonaCuenta(rsTemp!cNumCta)
        i = 1
        Do While Not rsRel.EOF
            'grdCliente.AdicionaFila
            'grdCliente.TextMatrix(i, 0) = i
            'grdCliente.TextMatrix(i, 1) = UCase(oFunC.pstanombre(rsRel("Nombre")))
            'grdCliente.TextMatrix(i, 2) = rsRel("ID N°")
            sDato(i) = Trim(Left(UCase(ofunc.PstaNombre(rsRel("Nombre"))), 30)) & Space(31 - Len(Trim(Left(UCase(ofunc.PstaNombre(rsRel("Nombre"))), 30)))) & rsRel("ID N°")
            If i = 5 Then Exit Do
            i = i + 1
            rsRel.MoveNext
        Loop
        Set rsRel = Nothing
    
    
        sCad = sCad & lsNegritaOn 'Activa Negrita
        'sCad = sCad & Chr(10) & Chr(10) & Chr(10) & lsNegritaOn 'Activa Negrita
        sCad = sCad & lsNegritaOn    'Activa Negrita
        sCad = sCad & Space(sIni) & "CMACCUSCO - PREMIAHORRO " & CnumSorteo & " " & ClsAge.NombreAgencia(CCodage) & Chr(10) & Chr(10)
        sCad = sCad & Space(sIni) & UCase(sDato(1)) & Chr(10)
        sCad = sCad & Space(sIni) & UCase(sDato(2)) & Chr(10)
        sCad = sCad & Space(sIni) & UCase(sDato(3)) & Chr(10)
        sCad = sCad & Space(sIni) & UCase(sDato(4)) & Chr(10)
        sCad = sCad & Space(sIni) & UCase(sDato(5)) & Chr(10)
        sCad = sCad & Space(sIni) & "DEL CUPON NRO. " & rsTemp!cNumRangoIni & " AL " & rsTemp!cNumRangoFin & Space(1) & "Nro Cupones:" & CStr(rsTemp!cNumCupones) & Chr(10)
        sCad = sCad & Space(sIni) & "NRO. CUENTA " & rsTemp!cNumCta & " " & Chr(10)
        sCad = sCad & Space(sIni) & "CMACCUSCO - PREMIAHORRO " & CnumSorteo & " " & ClsAge.NombreAgencia(CCodage) & Chr(10) & Chr(10)
        sCad = sCad & lsNegritaOff 'Desactiva Negrita
        sCad = sCad & Chr(12)
        rsTemp.MoveNext
        
'        If Not RSTEMP.EOF Then
         
'        End If
        
    Wend
           
    CUPONESBATCH = sCad
    Set ClsAge = Nothing
    Set clsMant = Nothing
    Set ofunc = Nothing
End Function

Public Function PLANILLAGANADORES(ByVal CnumSorteo As String, Optional ByVal CCodage As String, Optional Ccodageant As String, Optional ByVal gdFecSis As Date) As String
Dim oCon As COMConecta.DCOMConecta, sSql As String, rsTemp As ADODB.Recordset, sqlaux As String, sNumSorteo As String
 
 sqlaux = ""
 
 If Left(CnumSorteo, 2) = "00" Then
    sqlaux = " and substring(cctacod,4,2)='" & CCodage & "'"
 End If
 
 Set oCon = New COMConecta.DCOMConecta
 
    
 Set rsTemp = New ADODB.Recordset
    
     oCon.AbreConexion
     
        sSql = "  Select   c.cnumsorteo, c.cctacod, c.nsaldo, c.cperscod,p.cpersnombre,"
        sSql = sSql & " C.NRANGOINI , C.NRANGOFIN, C.NNUMTICKETS, C.cMovNro, nNumganador "
        sSql = sSql & " From cuentasorteo C join persona p on p.cperscod=c.cperscod "
        sSql = sSql & " where c.bganador=1 and left(c.cnumsorteo,6)='" & CnumSorteo & "'" & sqlaux
        sSql = sSql & " order by p.cpersnombre "
        
         ' and substring(cctacod,4,2)='" & CCodage & "'"
        
        Set rsTemp = oCon.CargaRecordSet(sSql)
            
    
     
    Dim lnCarLin As Integer, i As Integer
    Dim lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsCodAge As String
    Dim lsCuenta As String
    Dim ClsAge As COMDConstantes.DCOMAgencias, CodSorteo As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    Set ClsAge = New COMDConstantes.DCOMAgencias
    
    
    lsNumPag = ""
    'lnLinPag = 65
    lnCarLin = 120
    'lsTitRp1 = " REPORTE DE CUENTAS EXONERADAS DE COBRO DE INACTIVAS " & IIf(CcodAge <> "", clsage.NombreAgencia(CcodAge), "")
    lnLinPag = 0
    lsCodAge = ""
    CodSorteo = ""
    
    lsRTFSdo = "" '& Chr(10) & Chr(10) & Chr(10) & Chr(10)
    
    i = i + 1
    
    
    While Not rsTemp.EOF
                
         
          
         If lsCodAge = "" Or lnLinPag > 50 Then
            If Ccodageant <> Mid(rsTemp!cCtaCod, 4, 2) And Ccodageant <> "" Then
                lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoPagina
                Ccodageant = Mid(rsTemp!cCtaCod, 4, 2)
            End If
           
            
            lsRTFSdo = lsRTFSdo & Chr(10) & Chr(10) & Chr(10) & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(10) & "CMAC ICA" & Space(70) & "FECHA: " & gdFecSis & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(10) & Space(8) & Space(70) & "HORA:" & oCon.GetHoraServer() & Chr(10) & Chr(10)
            
            lsRTFSdo = lsRTFSdo & Space(15) & " REPORTE CONSOLIDADO DE SORTEO  " & CnumSorteo & IIf(CCodage <> "", " - " & ClsAge.NombreAgencia(CCodage), "") & Chr(10) & Chr(10)
            
            
            lsRTFSdo = lsRTFSdo & Space(2) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
            lsRTFSdo = lsRTFSdo & Space(2) & "  NRO.   "
            lsRTFSdo = lsRTFSdo & "   CUENTA           "
            lsRTFSdo = lsRTFSdo & "   TITULAR                           "
            'lsRTFSdo = lsRTFSdo & "   SALDO   "
            lsRTFSdo = lsRTFSdo & "  NRO GANADOR"
            lsRTFSdo = lsRTFSdo & "  RANGO INI."
            lsRTFSdo = lsRTFSdo & "  RANGO FIN."
            lsRTFSdo = lsRTFSdo & "  NRO CUPONES" & oImp.gPrnSaltoLinea
            
            lsRTFSdo = lsRTFSdo & Space(2) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                 lnLinPag = 0
         End If
                
            'lsRTFSdo = lsRTFSdo & Space(1) & oFunC.FillNum(Trim(Str(i)), 8, " ") & Space(1) & Trim(RSTEMP!cCtaCod) & Space(1) & FillText(Left(oFunC.pstanombre(oFunI.ImpreCarEsp(RSTEMP!cPersNombre), False), 37), 37, " ") & oFunC.JDNum(Trim(Str(RSTEMP!nSaldo)), 11, True, 9, 2) & Space(1) & oFunC.JDNum(Trim(Str(RSTEMP!nNumganador)), 11, False, 11, 0) & Space(1) & oFunC.JDNum(Trim(Str(RSTEMP!NRANGOINI)), 11, False, 11, 0) & Space(1) & oFunC.JDNum(Trim(Str(RSTEMP!NRANGOFIN)), 11, False, 10, 0) & Space(1) & oFunC.JDNum(Trim(Str(RSTEMP!NNUMTICKETS)), 11, False, 10, 0) & Chr(10)
             lsRTFSdo = lsRTFSdo & Space(1) & ofunc.FillNum(Trim(Str(i)), 8, " ") & Space(1) & Trim(rsTemp!cCtaCod) & Space(1) & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(rsTemp!cpersnombre), False), 37), 37, " ") & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!nNumganador)), 11, False, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!NRANGOINI)), 11, False, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!NRANGOFIN)), 11, False, 10, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!NNUMTICKETS)), 11, False, 10, 0) & Chr(10)
             
            
            'If lsCodAge = "04" Then Stop
             
            If lnLinPag = 50 Then
                lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoPagina
            End If
             
            lsCodAge = Mid(rsTemp!cCtaCod, 4, 2)
           CodSorteo = rsTemp!CnumSorteo
            
            lnLinPag = lnLinPag + 1
            i = i + 1
                        
                       
            rsTemp.MoveNext
             
    Wend
     
  PLANILLAGANADORES = lsRTFSdo
     
    Set rsTemp = Nothing
    Set oCon = Nothing
    Set ClsAge = Nothing
    Set ofunc = Nothing
    Set ofuni = Nothing

End Function

Public Function CONSOLESTADO(ByVal CnumSorteo As String, Optional ByVal CCodage As String, Optional Ccodageant As String, Optional ByVal cEstado As String, Optional ByVal gdFecSis As Date) As String
Dim oCon As COMConecta.DCOMConecta, sSql As String, rsTemp As ADODB.Recordset, sqlaux As String, sNumSorteo As String
 
 sqlaux = ""
 If Left(CnumSorteo, 2) = "00" Then
    sqlaux = " and substring(cctacod,4,2)='" & CCodage & "'"
 End If
 
 Set oCon = New COMConecta.DCOMConecta
 
    
 Set rsTemp = New ADODB.Recordset
    
     oCon.AbreConexion
     
     If cEstado = "A" Then
     
        sSql = "  Select   c.cnumsorteo, c.cctacod, c.nsaldo, c.cperscod,p.cpersnombre,"
        sSql = sSql & " C.NRANGOINI , C.NRANGOFIN, C.NNUMTICKETS, C.cMovNro, nNumganador "
        sSql = sSql & " From cuentasorteo C join persona p on p.cperscod=c.cperscod "
        sSql = sSql & " where c.BANULAR=1 and left(c.cnumsorteo,6)='" & CnumSorteo & "'" & sqlaux
        sSql = sSql & " order by p.cpersnombre "
        'and substring(cctacod,4,2)='" & CCodage & "'"
     
     ElseIf cEstado = "C" Then
     
        sSql = "  Select   c.cnumsorteo, c.cctacod, c.nsaldo, c.cperscod,p.cpersnombre,"
        sSql = sSql & " C.NRANGOINI , C.NRANGOFIN, C.NNUMTICKETS, C.cMovNro, nNumganador "
        sSql = sSql & " From cuentasorteo C join persona p on p.cperscod=c.cperscod "
        sSql = sSql & " where c.BCANCELAR=1  and (nNumganador is null or nNumganador=0 ) and left(c.cnumsorteo,6)='" & CnumSorteo & "'" & sqlaux
        sSql = sSql & " order by p.cpersnombre "
        'and substring(cctacod,4,2)='" & CCodage & "'"
     
     End If
     
        
        Set rsTemp = oCon.CargaRecordSet(sSql)
            
     oCon.CierraConexion
     
     
    Dim lnCarLin As Integer, i As Integer
    Dim lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsCodAge As String
    Dim lsCuenta As String
    Dim ClsAge As COMDConstantes.DCOMAgencias, CodSorteo As String
    Dim ofuni As COMFunciones.FCOMImpresion
    Dim ofunc As COMFunciones.FCOMCadenas
    
    Set ClsAge = New COMDConstantes.DCOMAgencias
    
    
    lsNumPag = ""
    'lnLinPag = 65
    lnCarLin = 115
    'lsTitRp1 = " REPORTE DE CUENTAS EXONERADAS DE COBRO DE INACTIVAS " & IIf(CcodAge <> "", clsage.NombreAgencia(CcodAge), "")
    lnLinPag = 0
    lsCodAge = ""
    CodSorteo = ""
    
    lsRTFSdo = "" '& Chr(10) & Chr(10) & Chr(10) & Chr(10)
    
    i = i + 1
    
    
    While Not rsTemp.EOF
                
         
          
         If lsCodAge = "" Or lnLinPag > 50 Then
            If Ccodageant <> Mid(rsTemp!cCtaCod, 4, 2) And Ccodageant <> "" Then
                lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoPagina
                Ccodageant = Mid(rsTemp!cCtaCod, 4, 2)
            End If
           
            
            lsRTFSdo = lsRTFSdo & Chr(10) & Chr(10) & Chr(10) & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(10) & "CMAC ICA" & Space(70) & "FECHA: " & gdFecSis & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(10) & Space(8) & Space(70) & "HORA:" & oCon.GetHoraServer() & Chr(10) & Chr(10)
            
            lsRTFSdo = lsRTFSdo & Space(10) & " REPORTE CONSOLIDADO DE CUPONES " & IIf(cEstado = "C", "CANCELADOS", "ANULADOS") & " DE SORTEO  " & CnumSorteo & IIf(CCodage <> "", " - " & ClsAge.NombreAgencia(CCodage), "") & Chr(10) & Chr(10)
            
            
            lsRTFSdo = lsRTFSdo & Space(2) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
            lsRTFSdo = lsRTFSdo & Space(2) & "  NRO.   "
            lsRTFSdo = lsRTFSdo & "   CUENTA           "
            lsRTFSdo = lsRTFSdo & "   TITULAR                           "
           ' lsRTFSdo = lsRTFSdo & "   SALDO    "
            lsRTFSdo = lsRTFSdo & "  RANGO INI."
            lsRTFSdo = lsRTFSdo & "  RANGO FIN."
            lsRTFSdo = lsRTFSdo & "  NRO CUPONES " & oImp.gPrnSaltoLinea
            
            lsRTFSdo = lsRTFSdo & Space(2) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                 lnLinPag = 0
         End If
                
           ' lsRTFSdo = lsRTFSdo & Space(1) & oFunC.FillNum(Trim(Str(i)), 8, " ") & Space(1) & Trim(RSTEMP!cCtaCod) & Space(1) & FillText(Left(oFunC.pstanombre(oFunI.ImpreCarEsp(RSTEMP!cPersNombre), False), 37), 37, " ") & oFunC.JDNum(Trim(Str(RSTEMP!nSaldo)), 11, True, 9, 2) & Space(1) & oFunC.JDNum(Trim(Str(RSTEMP!NRANGOINI)), 11, False, 11, 0) & Space(1) & oFunC.JDNum(Trim(Str(RSTEMP!NRANGOFIN)), 11, False, 10, 0) & Space(1) & oFunC.JDNum(Trim(Str(RSTEMP!NNUMTICKETS)), 11, False, 10, 0) & Chr(10)
             lsRTFSdo = lsRTFSdo & Space(1) & ofunc.FillNum(Trim(Str(i)), 8, " ") & Space(1) & Trim(rsTemp!cCtaCod) & Space(1) & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(rsTemp!cpersnombre), False), 37), 37, " ") & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!NRANGOINI)), 11, False, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!NRANGOFIN)), 11, False, 10, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!NNUMTICKETS)), 11, False, 10, 0) & Chr(10)
             
            
            'If lsCodAge = "04" Then Stop
             
            If lnLinPag = 50 Then
                lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoPagina
            End If
             
            lsCodAge = Mid(rsTemp!cCtaCod, 4, 2)
            CnumSorteo = rsTemp!CnumSorteo
            
            lnLinPag = lnLinPag + 1
            i = i + 1
                        
                       
            rsTemp.MoveNext
             
    Wend
     
  CONSOLESTADO = lsRTFSdo
     
    Set rsTemp = Nothing
    Set oCon = Nothing
    Set ClsAge = Nothing
    Set ofunc = Nothing
    Set ofuni = Nothing

End Function



Public Function PLANILLACONSOLSORTEO(ByVal CnumSorteo As String, Optional ByVal CCodage As String, Optional Ccodageant As String, Optional tpoOrden As Integer, Optional ByVal gdFecSis As Date)
Dim oCon As COMConecta.DCOMConecta, sSql As String, rsTemp As ADODB.Recordset, sqlaux As String, sqlaux1 As String, sNumSorteo As String, nNroCupones As Long
 
 nNroCupones = 0
 
' sqlaux = " and c.cnumsorteo ='" & CnumSorteo & "'"
sqlaux = ""
If Left(CnumSorteo, 2) = "00" Then
    sqlaux = " and substring(c.cctacod,4,2)='" & CCodage & "'"
End If
 
 Set oCon = New COMConecta.DCOMConecta
 
 If tpoOrden = 1 Then
    sqlaux1 = " order by cast(C.nrangoini as int) "
 Else
    sqlaux1 = " order by p.cpersnombre "
 End If
    
 Set rsTemp = New ADODB.Recordset
    
     oCon.AbreConexion
     
        sSql = "  Select   c.cnumsorteo, c.cctacod, c.nsaldo, c.cperscod,p.cpersnombre,"
        sSql = sSql & " C.NRANGOINI , C.NRANGOFIN, C.NNUMTICKETS, C.cMovNro, bGanador, nNumganador, bCancelar, bAnular "
        sSql = sSql & " From cuentasorteo C join persona p on p.cperscod=c.cperscod "
        sSql = sSql & " where (bcancelar<>1 or bcancelar is null )  and (  banular<>1 or banular is null) and left(c.cnumsorteo,6) ='" & CnumSorteo & "'"
        sSql = sSql & sqlaux
        sSql = sSql & sqlaux1
        
        
        Set rsTemp = oCon.CargaRecordSet(sSql)
            
     oCon.CierraConexion
     
     
    Dim lnCarLin As Integer, i As Integer
    Dim lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsCodAge As String
    Dim lsCuenta As String
    Dim ClsAge As COMDConstantes.DCOMAgencias, CodSorteo As String
    Set ClsAge = New COMDConstantes.DCOMAgencias
    
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    lsNumPag = ""
    'lnLinPag = 65
    lnCarLin = 120
    'lsTitRp1 = " REPORTE DE CUENTAS EXONERADAS DE COBRO DE INACTIVAS " & IIf(CcodAge <> "", clsage.NombreAgencia(CcodAge), "")
    lnLinPag = 0
    lsCodAge = ""
    CodSorteo = ""
    
    lsRTFSdo = "" '& Chr(10) & Chr(10) & Chr(10) & Chr(10)
    
    i = i + 1
    
    
    While Not rsTemp.EOF
                
         
          
         If lsCodAge = "" Or lnLinPag > 50 Then
            If (Ccodageant <> Mid(rsTemp!cCtaCod, 4, 2) And Ccodageant <> "") Or (CodSorteo <> rsTemp!CnumSorteo And CodSorteo <> "") Then
                lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoPagina
                Ccodageant = Mid(rsTemp!cCtaCod, 4, 2)
            End If
           
            
            lsRTFSdo = lsRTFSdo & Chr(10) & Chr(10) & Chr(10) & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(10) & "CMAC ICA" & Space(70) & "FECHA: " & gdFecSis & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(10) & Space(8) & Space(70) & "HORA:" & oCon.GetHoraServer() & Chr(10) & Chr(10)
            
            lsRTFSdo = lsRTFSdo & Space(15) & " REPORTE CONSOLIDADO DE SORTEO  " & CnumSorteo & IIf(CCodage <> "", " - " & ClsAge.NombreAgencia(CCodage), "") & Chr(10) & Chr(10)
            
            
            lsRTFSdo = lsRTFSdo & Space(8) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
            lsRTFSdo = lsRTFSdo & Space(8) & "  NRO.   "
            lsRTFSdo = lsRTFSdo & "   CUENTA           "
            lsRTFSdo = lsRTFSdo & "   TITULAR                           "
        '    lsRTFSdo = lsRTFSdo & "   SALDO  "
            lsRTFSdo = lsRTFSdo & "  RANGO INICIAL "
            lsRTFSdo = lsRTFSdo & "  RANGO FINAL "
            lsRTFSdo = lsRTFSdo & "  NRO CUPONES " & oImp.gPrnSaltoLinea
            lsRTFSdo = lsRTFSdo & Space(8) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                 lnLinPag = 0
         End If
                
            'lsRTFSdo = lsRTFSdo & Space(6) & oFunC.FillNum(Trim(Str(i)), 8, " ") & Space(1) & Trim(RSTEMP!cCtaCod) & Space(1) & FillText(Left(oFunC.pstanombre(oFunI.ImpreCarEsp(RSTEMP!cPersNombre), False), 37), 37, " ") & oFunC.JDNum(Trim(Str(RSTEMP!nSaldo)), 11, True, 9, 2) & Space(1) & oFunC.JDNum(Trim(Str(RSTEMP!NRANGOINI)), 11, False, 11, 0) & Space(1) & oFunC.JDNum(Trim(Str(RSTEMP!NRANGOFIN)), 11, False, 11, 0) & Space(1) & oFunC.JDNum(Trim(Str(RSTEMP!NNUMTICKETS)), 11, False, 10, 0) & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(6) & ofunc.FillNum(Trim(Str(i)), 8, " ") & Space(1) & Trim(rsTemp!cCtaCod) & Space(1) & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(rsTemp!cpersnombre), False), 37), 37, " ") & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!NRANGOINI)), 11, False, 11, 0) & Space(2) & ofunc.JDNum(Trim(Str(rsTemp!NRANGOFIN)), 11, False, 11, 0) & Space(1) & ofunc.JDNum(Trim(Str(rsTemp!NNUMTICKETS)), 11, False, 10, 0) & Chr(10)
             
             nNroCupones = nNroCupones + rsTemp!NNUMTICKETS
            
            'If lsCodAge = "04" Then Stop
             
            If lnLinPag = 50 Then
                lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoPagina
            End If
             
            lsCodAge = Mid(rsTemp!cCtaCod, 4, 2)
            CodSorteo = rsTemp!CnumSorteo
            
            lnLinPag = lnLinPag + 1
            i = i + 1
                        
                       
            rsTemp.MoveNext
             
    Wend
     lsRTFSdo = lsRTFSdo & Space(8) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
     lsRTFSdo = lsRTFSdo & Space(78) & "TOTAL DE CUPONES: " & ofunc.JDNum(Trim(Str(nNroCupones)), 11, False, 10, 0) & Chr(10)
     
  PLANILLACONSOLSORTEO = lsRTFSdo
     
    Set rsTemp = Nothing
    Set oCon = Nothing
    Set ClsAge = Nothing
    Set ofuni = Nothing
    Set ofunc = Nothing

End Function

Public Function RepEstratPlazoFijo() As String
    Dim lsReporte As String
    Dim rsPlazo As ADODB.Recordset
    Set rsPlazo = New ADODB.Recordset
    Dim nPlazos As Integer
    Dim J As Integer
    Dim nRangos(1 To 6, 1 To 2) As Integer
    Dim sRangos(1 To 6) As String
    Dim nNum As Long, nNumCTS As Long
    Dim nMonto As Currency, nMontoCTS As Currency
    Dim lsNum As String, lsMonto As String
    Dim nTotalNum As Long
    Dim nTotalMonto As Currency
    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lsNumPag As String
    Dim lnLinPag As Integer
    Dim lsSubTit As String, lnCntCta As Integer
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim VSQL As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    oCon.AbreConexion
        
    nPlazos = 6
    
    nRangos(1, 1) = 0:      nRangos(1, 2) = 30
    nRangos(2, 1) = 31:     nRangos(2, 2) = 60
    nRangos(3, 1) = 61:     nRangos(3, 2) = 90
    nRangos(4, 1) = 91:     nRangos(4, 2) = 120
    nRangos(5, 1) = 121:    nRangos(5, 2) = 360
    nRangos(6, 1) = 361:    nRangos(6, 2) = 9999
    
    sRangos(1) = "Menor a 30  "
    sRangos(2) = "31 a 60     "
    sRangos(3) = "61 a 90     "
    sRangos(4) = "91 a 120    "
    sRangos(5) = "121 a 360   "
    sRangos(6) = "Mayor a 360 "
    
    lsNumPag = "   1"
    lnLinPag = 65
    lnCarLin = 105
    lsTitRp1 = "REPORTE DE PLAZO FIJO POR VENCIMIENTO"
    lsTitRp2 = ""
    lsReporte = CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1, lsTitRp2, "", lsNumPag) & oImp.gPrnSaltoLinea
    lsReporte = lsReporte & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
    
    For J = 1 To 2
        nTotalNum = 0
        nTotalMonto = 0
        If J = 1 Then
            lsReporte = lsReporte & "MONEDA NACIONAL" & oImp.gPrnSaltoLinea
        Else
            lsReporte = lsReporte & "MONEDA EXTRANJERA" & oImp.gPrnSaltoLinea
        End If
        lsReporte = lsReporte & String(17, "-") & oImp.gPrnSaltoLinea
        lsReporte = lsReporte & "PLAZO" & Space(20) & "NUMERO" & Space(18) & "MONTO" & oImp.gPrnSaltoLinea
        For i = 1 To nPlazos
            nNum = 0
            nMonto = 0
            VSQL = " Select Count(PR.cCtaCod) Num, Sum(nSaldo) Monto" _
                 & " From CaptacPlazoFijo PF " _
                 & " Inner Join Producto PR On PF.cCtaCod = PR.cCtaCod Where " _
                 & " nPlazo between " & nRangos(i, 1) & " and " & nRangos(i, 2) & " and " _
                 & " Left(nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')" _
                 & " And Substring(PR.cCtaCod,9,1) = '" & J & "'  And Left(PR.cCtaCod,5) Like '___" & lsAgeCod & "'"
            If rsPlazo.State = adStateOpen Then
                rsPlazo.Close
            End If
            
            Set rsPlazo = oCon.CargaRecordSet(VSQL)
            
            If rsPlazo.EOF And rsPlazo.BOF Then
                nNum = 0
                nMonto = 0
            Else
                nNum = IIf(IsNull(rsPlazo!Num), 0, rsPlazo!Num)
                nMonto = IIf(IsNull(rsPlazo!Monto), 0, rsPlazo!Monto)
            End If
            
            If i = 6 Then
                GetSaldoCTS J, nNumCTS, nMontoCTS
                nNum = nNum + nNumCTS
                nMonto = nMonto + nMontoCTS
            End If
            nTotalNum = nTotalNum + nNum
            nTotalMonto = nTotalMonto + nMonto
            lsNum = Str(nNum)
            lsMonto = Format$(nMonto, "#,##0.00")
            lsReporte = lsReporte & sRangos(i) & Space(14) & ofunc.JDNum(lsNum, 5, False, 5, 0) & Space(10) & ofunc.JDNum(lsMonto, 13, True, 10, 2) & oImp.gPrnSaltoLinea
        Next i
        lsReporte = lsReporte & "TOTAL       " & Space(14) & ofunc.JDNum(Str(nTotalNum), 5, False, 5, 0) & Space(10) & ofunc.JDNum(Str(nTotalMonto), 13, True, 10, 2) & oImp.gPrnSaltoLinea
        lsReporte = lsReporte & oImp.gPrnSaltoLinea
    Next J
    Set rsPlazo = Nothing
    RepEstratPlazoFijo = lsReporte
    Set ofunc = Nothing
End Function

Public Function RepPlazoFijovencimiento(pdIni As Date, pdFin As Date, pgsNomAge As String, pgsEmpresa As String, pgdFecSis As Date, pnMoneda As Moneda) As String
    Dim lscadena As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim lnPagina As Long
    Dim lnItem As Long
    Dim sql As String
    Dim lsCodCtaAnt As String
    Dim lsCodCta As String * 18
    Dim lsPersona As String * 40
    Dim lsApertura As String * 10
    Dim lsRelacion As String * 15
    Dim lsPlazo As String * 5
    Dim lsItem As String * 5
    Dim lsTEA As String * 8
    Dim lsVencimiento As String * 10
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim sqlAdd As String
    Dim lncontador As Integer
    Dim lsMonto As String * 15
    Dim lnMonto As Currency
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And cap.cctacod like '___" & lsAgeCod & "%'"
    End If
    
    sql = " Select CAP.cCtaCod, cPersNombre, dApertura, nPlazo, cConsDescripcion, PRD.nSaldo, dbo.ConvierteTNAaTEA(nTasaInteres) TEA, DateAdd(Day,nPlazo,dRenovacion) dVencimiento From Captaciones CAP" _
        & " Inner Join CaptacPlazoFijo CPF ON CAP.cCtaCod = CPF.cCtaCod" _
        & " Inner Join ProductoPersona PP ON CAP.cCtaCod = PP.cCtaCod" _
        & " Inner Join Producto PRD On PRD.cCtaCod = CAP.cCtaCod" _
        & " Inner Join Persona PE ON PP.cPersCod = PE.cPersCod" _
        & " Inner Join Constante CO On  PP.nPrdPersRelac = CO.nConsValor And nConsCod = 2005" _
        & " Where dRenovacion Between '" & Format(pdIni, ofunf.gsFormatoFecha) & "' And '" & Format(pdFin, ofunf.gsFormatoFecha) & "'" _
        & " And Left(nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "') And Substring(cap.cctacod,9,1) = " & pnMoneda & " " & sqlAdd & " order by cap.cctacod"

    oCon.AbreConexion
           
    Set rs = oCon.CargaRecordSet(sql)
    
    lscadena = ""
    lsCodCtaAnt = ""
    lncontador = 0
    lnMonto = 0
    If Not (rs.EOF And rs.BOF) Then
        lscadena = lscadena & ofuni.CabeceraPagina("VENCIMIENTO DE PLAZOS FIJOS", lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, pnMoneda)
        lscadena = lscadena & ofuni.Encabezado("Item;6; ;3;Cuenta;10; ;10;Apertura;8; ;2;Plazo;8;Saldo;15;Persona;20; ;23;Relacion;10; ;3;TEA;9;Vencimiento;14; ;1;", lnItem)
        
        While Not rs.EOF
            If lsCodCtaAnt = rs!cCtaCod Then
                lsCodCta = ""
                lsPersona = rs!cpersnombre
                lsApertura = ""
                lsRelacion = rs!cConsdescripcion
                lsPlazo = ""
                lsItem = ""
                lsMonto = ""
                lsTEA = ""
                lsVencimiento = ""
            Else
                lncontador = lncontador + 1
                lsCodCta = rs!cCtaCod
                lsPersona = rs!cpersnombre
                lsApertura = Format(rs!dApertura, ofunf.gsFormatoFechaView)
                lsRelacion = rs!cConsdescripcion
                RSet lsPlazo = rs!nPlazo
                lsItem = Format(lncontador, "00000")
                RSet lsMonto = Format(rs!nSaldo, "#,##0.00")
                RSet lsTEA = Format(rs!TEA, "#.0000")
                lsVencimiento = Format(rs!dVencimiento, ofunf.gsFormatoFechaView)
                lnMonto = lnMonto + rs!nSaldo
            End If
            lnItem = lnItem + 1
            
            lscadena = lscadena & "  " & lsItem & "  " & lsCodCta & "  " & lsApertura & "  " & lsPlazo & "  " & lsMonto & "  " & lsPersona & "  " & lsRelacion & lsTEA & "  " & lsVencimiento & Chr(10)
            
            If lnItem > 54 Then
                lscadena = lscadena & ofuni.CabeceraPagina("VENCIMIENTO DE PLAZOS FIJOS", lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, pnMoneda)
                lscadena = lscadena & ofuni.Encabezado("Item;6; ;3;Cuenta;10; ;10;Apertura;8; ;2;Plazo;8;Saldo;15;Persona;20; ;23;Relacion;10; ;3;TEA;9;Vencimiento;14; ;1;", lnItem)
            End If
            
            lsCodCtaAnt = rs!cCtaCod
            rs.MoveNext
        Wend
        
        RSet lsMonto = Format(lnMonto, "#,##0.00")
        lscadena = lscadena & ofuni.Encabezado(" ;47;" & lsMonto & ";16; ;79;", lnItem)
        
    End If
            
    RepPlazoFijovencimiento = lscadena
    Set ofuni = Nothing
End Function


Private Sub GetSaldoCTS(ByVal psMoneda As Moneda, ByRef pnNum As Long, ByRef pnMonto As Currency)
    Dim rsCTS As ADODB.Recordset
    Set rsCTS = New ADODB.Recordset
    Dim nNum As Long
    Dim nMonto As Currency
    Dim VSQL As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    oCon.AbreConexion
    
    VSQL = " Select Count(PR.cCtaCod) Num, Sum(nSaldo) Monto from Producto PR" _
         & " Inner Join CaptacCTS CTS On PR.cCtaCod = CTS.cCtaCod" _
         & " where Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')" _
         & " And Substring(PR.cCtaCod,9,1) = '" & psMoneda & "' And Left(PR.cCtaCod,5) Like '___" & lsAgeCod & "'"
    
    If rsCTS.State = adStateOpen Then
        rsCTS.Close
    End If
    
    Set rsCTS = oCon.CargaRecordSet(VSQL)
    
    If rsCTS.EOF And rsCTS.BOF Then
        pnNum = 0
        pnMonto = 0
    Else
        pnNum = IIf(IsNull(rsCTS!Num), 0, rsCTS!Num)
        pnMonto = IIf(IsNull(rsCTS!Monto), 0, rsCTS!Monto)
    End If
End Sub

Public Function RepCtaIna() As String
    Dim lscad As String
    lscad = ""
    lscad = lscad & GetCtaInaAho("AHORRO INACTIVAS SOLES - CON ORDEN PAGO -", Moneda.gMonedaNacional, Producto.gCapAhorros, 0, 0, 1, True)
    lscad = lscad & GetCtaInaAho("AHORRO INACTIVAS SOLES - SIN ORDEN PAGO -", Moneda.gMonedaNacional, Producto.gCapAhorros, 0, 0, 0, True)
    lscad = lscad & GetCtaInaAho("AHORRO INACTIVAS DOLARES - CON ORDEN PAGO -", Moneda.gMonedaExtranjera, Producto.gCapAhorros, 0, 0, 1, True)
    lscad = lscad & GetCtaInaAho("AHORRO INACTIVAS DOLARES - SIN ORDEN PAGO -", Moneda.gMonedaExtranjera, Producto.gCapAhorros, 0, 0, 0, True)
    RepCtaIna = lscad
End Function

Public Function RepCtaInmobilizada(pdFI As Date, pdFF As Date) As String
    Dim lscad As String
    lscad = ""
    lscad = lscad & GetCtaInmobilizadaAho("AHORRO INMOVILIZADA SOLES -", Moneda.gMonedaNacional, pdFI, pdFF, 0, 0, 1, True)
    lscad = lscad & GetCtaInmobilizadaAho("AHORRO INMOVILIZADA DOLARES -", Moneda.gMonedaExtranjera, pdFI, pdFF, 0, 0, 1, True)
    RepCtaInmobilizada = lscad
End Function


Public Function GetCtaInaAho(psTit As String, psMoneda As Moneda, psProd As String, lnPagina As Long, lnItem As Long, Optional psOrdPag As String = "S", Optional pbInactivas As Boolean = False) As String
    Dim sqlAho As String
    Dim rsAho As ADODB.Recordset
    Set rsAho = New ADODB.Recordset
    Dim lsCodCtaAnt As String
    
    Dim lsCodCta As String * 20
    Dim lsNomPers As String * 55
    Dim lnMonto  As Currency
    Dim lsMonto  As String * 12
    Dim lsFecha As String * 10
    Dim lsUltCnt As String * 10
    Dim lsContador As String * 4
    Dim lsUser As String * 4
    Dim lnAcum As Currency
    Dim lnAcumItem As Integer
    Dim lscadena As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim lncontador As Integer
    
    lscadena = ""
    sqlAho = " Select PR.cCtaCod Cuenta, PE.cPersNombre Nombre, PR.nSaldo Monto," _
           & " CAP.dApertura FechaApe, CAPAHO.dUltContacto dUltCntAC, Right(CAP.cUltimaActualizacion,4) cUser" _
           & " FROM Producto PR" _
           & " INNER JOIN CaptacAhorros CAPAHO On PR.cCtaCod = CAPAHO.cCtaCod" _
           & " INNER JOIN Captaciones CAP On PR.cCtaCod = CAP.cCtaCod" _
           & " INNER JOIN ProductoPersona PP On PP.cCtaCod = PR.cCtaCod" _
           & " INNER JOIN Persona PE On PP.cPersCod = PE.cPersCod" _
           & " WHERE bInactiva = 1 and bOrdPag = " & psOrdPag & " and SUBSTRING(PR.cCtaCod,9,1) = '" & psMoneda & "'" _
           & " And Left(PR.nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')" _
           & " ORDER BY PR.cCtaCod"
    
    oCon.AbreConexion
    Set rsAho = oCon.CargaRecordSet(sqlAho)
             
    If Not (rsAho.EOF And rsAho.BOF) Then
        lscadena = lscadena & ofuni.CabeceraPagina(psTit, lnPagina, lnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
        lscadena = lscadena & ofuni.Encabezado("ITEM;4;CUENTA;20;NOMBRE;25; ;32;SALDO;12; ;2;FEC.APE;10; ;2;ULT.CNT;10; ;1;Usu.;4; ;1;", lnItem)
        
        lsCodCtaAnt = ""
        lncontador = 0
        lnAcum = 0
        While Not rsAho.EOF
            If rsAho!cuenta <> lsCodCtaAnt Then
                lncontador = lncontador + 1
                lsContador = ofunc.FillNum(Str(lncontador), 4, "0")
                lnAcum = lnAcum + rsAho!Monto
                lnMonto = rsAho!Monto
                lsFecha = Format$(rsAho!FechaApe, ofunf.gsFormatoFechaView)
                lsUltCnt = Format$(rsAho!dUltcntAC, ofunf.gsFormatoFechaView)
                lsUser = rsAho!cUser
            Else
                lsContador = ""
                lnMonto = 0
                lsFecha = ""
                lsUltCnt = ""
                lsUser = ""
            End If
            lsCodCta = IIf(rsAho!cuenta = lsCodCtaAnt, "", rsAho!cuenta)
            lsNomPers = ofunc.PstaNombre(rsAho!NOMBRE)
            lsMonto = IIf(lnMonto = 0, "", ofunc.JDNum(Str(lnMonto), 12, True, 9, 2))
            lscadena = lscadena & lsContador & Space(2) & lsCodCta & lsNomPers & Space(2) & lsMonto & Space(2) & lsFecha & Space(2) & lsUltCnt & " " & lsUser & Chr(10)
            lnAcumItem = lnAcumItem + 1
            lnItem = lnItem + 1
            If lnItem = 54 Then
                lscadena = lscadena & Chr(12)
                lscadena = lscadena & ofuni.CabeceraPagina(psTit, lnPagina, lnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                lscadena = lscadena & ofuni.Encabezado("ITEM;4;CUENTA;20;NOMBRE;25; ;32;SALDO;12; ;2;FEC.APE;10; ;2;ULT.CNT;10; ;1;Usu.;4; ;1;", lnItem)
                lnItem = 0
            End If
        
            lsCodCtaAnt = rsAho!cuenta
            rsAho.MoveNext
        Wend
        lscadena = lscadena & oImp.gPrnSaltoLinea
        lscadena = lscadena & String(124, "=") & oImp.gPrnSaltoLinea
        lscadena = lscadena & lsContador & Space(20) & "TOTAL SALDO" & Space(46) & ofunc.JDNum(Trim(Str(lnAcum)), 14, True, 11, 2) & oImp.gPrnSaltoLinea
        lscadena = lscadena & String(124, "=") & oImp.gPrnSaltoLinea
        lscadena = lscadena & Chr(12)
    End If
    
    GetCtaInaAho = lscadena
    
    rsAho.Close
    Set rsAho = Nothing
    Set ofunc = Nothing
    Set ofuni = Nothing
    
End Function

Public Function GetCtaInmobilizadaAho(psTit As String, psMoneda As Moneda, pdIni As Date, pdFin As Date, lnPagina As Long, lnItem As Long, Optional psOrdPag As String = "S", Optional pbInactivas As Boolean = False) As String
    Dim sqlAho As String
    Dim rsAho As ADODB.Recordset
    Set rsAho = New ADODB.Recordset
    Dim lsCodCtaAnt As String
    
    Dim lsCodCta As String * 20
    Dim lnMonto  As Currency
    Dim lsMonto  As String * 12
    Dim lsFechaI As String * 10
    Dim lsFechaF As String * 10
    Dim lsContador As String * 4
    Dim lnAcum As Currency
    Dim lnAcumItem As Integer
    Dim lscadena As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lncontador As Integer
    Dim sqlAdd As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(MC.cCtaCod,4,2)  = '" & lsAgeCod & "'"
    End If
        
        
    lscadena = ""
    sqlAho = " Select MC.cCtaCod, PRD.nSaldo, 0 Interes, dbo.FechaMov(M.cMovNro) FFin, " _
           & " (Select dbo.FechaMov(Max(MA.cMovNro)) From Mov MA" _
           & " Inner Join MovCap MCA On MA.nMovNro = MCA.nMovNro" _
           & " Where MA.cOpeCod = '200803' And MA.nMovFlag = " & MovFlag.gMovFlagVigente & " And MCA.cCtaCod = MC.cCtaCod) FIni" _
           & " From Mov M" _
           & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
           & " Inner Join Producto PRD On PRD.cCtaCod = MC.cCtaCod" _
           & " Where M.cOpeCod = '200406'" _
           & " And Left(M.cMovNro,8) Between '" & Format(pdIni, "YYYYMMDD") & "' and  '" & Format(DateAdd("d", 1, pdFin), "YYYYMMDD") & "' And M.nMovFlag = " & MovFlag.gMovFlagVigente & "" _
           & " And Substring(MC.cCtaCod,9,1) = '" & psMoneda & "' " & sqlAdd
    
    oCon.AbreConexion
    Set rsAho = oCon.CargaRecordSet(sqlAho)
             
    If Not (rsAho.EOF And rsAho.BOF) Then
        lscadena = lscadena & ofuni.CabeceraPagina(psTit & " " & sqlAdd, lnPagina, lnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
        lscadena = lscadena & ofuni.Encabezado("Item;4; ;1;Inm.;10; ;5;Cancel;10; ;5;cCodCta;10; ;10;Saldo;10; ;5;Int.Ult.M;11;", lnItem)
        
        lncontador = 0
        lnAcum = 0
        While Not rsAho.EOF
            lncontador = lncontador + 1
            lsContador = Format(lncontador, "0000")
            lnAcum = lnAcum + rsAho!nSaldo
            lnAcumItem = lnAcumItem + 1
            
            lsCodCta = rsAho!cCtaCod
            RSet lsMonto = Format(rsAho!nSaldo, "#,##0.00")
            lsFechaI = rsAho!FIni
            lsFechaF = rsAho!FFin
            
            lscadena = lscadena & lsContador & " " & lsFechaI & " " & lsFechaF & " " & lsCodCta & " " & lsMonto & " " & lsContador & Chr(10)
            
            lnItem = lnItem + 1
            If lnItem = 54 Then
                lscadena = lscadena & Chr(12)
                lscadena = lscadena & ofuni.CabeceraPagina(psTit, lnPagina, lnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                lscadena = lscadena & ofuni.Encabezado("Inm.;10; ;5;Cancel;10; ;5;cCodCta;10; ;10;Saldo;10; ;5;Int.Ult.M;11;", lnItem)
                lnItem = 0
            End If
        
            lsCodCtaAnt = rsAho!cCodCta
            rsAho.MoveNext
        Wend
        
        lscadena = lscadena & oImp.gPrnSaltoLinea
        lscadena = lscadena & String(119, "=") & oImp.gPrnSaltoLinea
        lscadena = lscadena & lsContador & Space(20) & "TOTAL SALDO" & Space(50) & ofunc.JDNum(Trim(Str(lnAcum)), 14, True, 11, 2) & oImp.gPrnSaltoLinea
        lscadena = lscadena & String(119, "=") & oImp.gPrnSaltoLinea
        lscadena = lscadena & Chr(12)
    End If
    
    GetCtaInmobilizadaAho = lscadena
    
    rsAho.Close
    Set rsAho = Nothing
    Set ofunc = Nothing
    Set ofuni = Nothing
End Function


Public Function ImprimeRep05(ByVal sFecha As Date, ByVal gsNomCmac As String) As String

Dim oCon As COMConecta.DCOMConecta
Dim rs As ADODB.Recordset
Dim lscadena As String
Dim lsTitRp1 As String
Dim lsTitRp2 As String
Dim lsNumPag As String
Dim lsMoneda As String
Dim i As Integer
Dim sCad As String * 25
Dim nFila As Integer

Dim lsNOn As String
Dim lsNOff As String
     
Dim nNorCpaVta(0 To 1) As Currency
Dim nPromedio(0 To 1) As Currency
Dim nMayor(0 To 1) As Currency
Dim nMenor(0 To 1) As Currency
Dim lsHoja As String
Dim ofuni As New COMFunciones.FCOMImpresion

'sFecha = DateAdd("d", -1, "01/" & IIf(pnMes = 12, "01", IIf(pnMes < 9, "0" & Trim(Str(pnMes + 1)), Trim(Str(pnMes + 1)))) & "/" & Trim(Str(IIf(pnMes = 12, pnAnio + 1, pnAnio))))

Set oCon = New COMConecta.DCOMConecta
oCon.AbreConexion
Set rs = New ADODB.Recordset
 
'Valores Normales
'If gbBitCentral Then
   lscadena = "SELECT nvalvent, nvalcomp FROM TIPOCAMBIO WHERE CONVERT(VARCHAR(8), DFECCAMB, 112)='" & Format(sFecha, "YYYYMMdd") & "'"
'Else
'   lsCadena = "SELECT nvalvent, nvalcomp FROM DBCOMUNES..TIPCAMBIO WHERE CONVERT(VARCHAR(8), DFECCAMB, 112)='" & Format(sFecha, "YYYYMMdd") & "'"
'End If
Set rs = oCon.CargaRecordSet(lscadena)
    If rs.BOF Then
    Else
        nNorCpaVta(0) = rs!nValComp
        nNorCpaVta(1) = rs!nValVent
    End If

rs.Close
Set rs = Nothing

'Promedio, Mayor y Menor de las Operaciones
'If gbBitCentral Then
   lscadena = " Select case when vv.cOpeCod in (900022, 900025,400011, 400013) THEN 'C' "
   lscadena = lscadena & "      Else 'V' End cTipo, SUM(vv.nMovImporte) nMonto,"
   lscadena = lscadena & "      Round(SUM(vv.nMovImporte * nMovTpoCambio) / SUM(nMovImporte),4) nPromedio, Max(nMovTpoCambio) nMayor, Min(nMovTpoCambio) nMenor"
   lscadena = lscadena & " FROM ("
   lscadena = lscadena & " select m.copecod, mcv.nMovImporte, mtc.nMovTpoCambio"
   lscadena = lscadena & " from mov m join movcompraventa mcv on mcv.nmovnro = m.nmovnro"
   lscadena = lscadena & "    left join movtpocambio mtc on mtc.nmovnro = m.nmovnro"
   lscadena = lscadena & " where copecod like '90002%' and cmovnro like '" & Left(Format(sFecha, "YYYYMMdd"), 8) & "%'  and m.nmovestado = 10 and m.nmovflag = 0"
   lscadena = lscadena & " Union All"
   lscadena = lscadena & " select m.copecod, me.nMovMEImporte, mtc.nMovTpoCambio"
   lscadena = lscadena & " from mov m join movcta mc on mc.nmovnro = m.nmovnro"
   lscadena = lscadena & "      join movme me on me.nmovnro = mc.nmovnro and me.nmovitem = mc.nmovitem"
   lscadena = lscadena & "      join movtpocambio mtc on mtc.nmovnro = m.nmovnro"
   lscadena = lscadena & " where m.cmovnro like '" & Left(Format(sFecha, "YYYYMMdd"), 8) & "%' and m.copecod like '4000%' and m.nmovflag = 0"
   lscadena = lscadena & " and me.nmovmeimporte > 0"
   lscadena = lscadena & " ) VV"
   lscadena = lscadena & " group by case when vv.cOpeCod in (900022, 900025,400011, 400013) THEN 'C'"
   lscadena = lscadena & "    Else 'V' End"
'Else
'lsCadena = " SELECT case when CCODOPE = '230101' THEN 'C' Else 'V' End cTipo, AVG(nTipCambio) AS nPromedio, MAX(nTipCambio) AS nMayor, MIN(nTipCambio) AS nMenor  " & _
'           " From COMPRAVENTA " & _
'           " WHERE  CONVERT(VARCHAR(8), DFECTRAN, 112)='" & Format(sFecha, "YYYYMMdd") & "' " & _
'           " AND ( CCODOPE = '230101' OR CCODOPE='230102') " & _
'           " GROUP BY case when CCODOPE = '230101' THEN 'C' Else 'V' End "
'End If
Set rs = oCon.CargaRecordSet(lscadena)
If Not rs.BOF Then
    Do While Not rs.EOF
        If rs!cTipo = "C" Then
'            If gbBitCentral Then
               nNorCpaVta(0) = rs!nMonto
'            End If
            nPromedio(0) = rs!nPromedio
            nMayor(0) = rs!nMayor
            nMenor(0) = rs!nMenor
        Else
'            If gbBitCentral Then
               nNorCpaVta(1) = rs!nMonto
'            End If
            nPromedio(1) = rs!nPromedio
            nMayor(1) = rs!nMayor
            nMenor(1) = rs!nMenor
        End If
        rs.MoveNext
    Loop
End If
rs.Close
oCon.CierraConexion
Set oCon = Nothing

 
'Imprime la cabecera del reporte
lscadena = ""

lsNOn = Chr$(27) + Chr$(71)
lsNOff = Chr$(27) + Chr$(72)
    

lscadena = lsNOn & "SUPERINTENDENCIA DE BANCA Y SEGUROS " & Space(80) & " REPORTE NRO 05"
lscadena = lscadena & Chr(10) & "EMPRESA: " & gsNomCmac & Space(10) & " CODIGO: " & gsCodCMAC
lscadena = lscadena & Chr(10) & "FECHA: " & sFecha
lscadena = lscadena & Chr(10) & Chr(10)
lscadena = lscadena & Space(15) & " C O T I Z A C I O N   D E   O F E R T A   Y   D E M A N D A   D E   M O N E D A   E X T R A N J E R A   1/"
 
lscadena = lscadena & Chr(10) & "+---------------------------------+-------------------------+-----------------------------------------------------------------------------+ "
lscadena = lscadena & Chr(10) & "|       M  O  N  E  D  A  S       |      MONTO NEGOCIADO    |    T    I    P    O        D    E        C    A    M    B    I    O   2/    |"
lscadena = lscadena & Chr(10) & "|                                 |  E N  L A  M O N E D A  |     P R O M E D I O     |       M A X I M O       |       M I N I M O       |"
lscadena = lscadena & Chr(10) & "|                                 |   R E S P E C T I V A   |    P O N D E R A D O    |                         |                         |"
lscadena = lscadena & Chr(10) & "+---------------------------------+-------------------------+-------------------------+-------------------------+-------------------------+ " & lsNOff
lscadena = lscadena & Chr(10) & "+ DOLAR NORTEAMERICANO            |                         |                         |                         |                         | "
lscadena = lscadena & Chr(10) & "+                   C O M P R A   | " & ofuni.ImpreFormat(nNorCpaVta(0), 20, 2) & " | " & ofuni.ImpreFormat(nPromedio(0), 20, 2) & " | " & ofuni.ImpreFormat(nMayor(0), 20, 2) & " | " & ofuni.ImpreFormat(nMenor(0), 20, 2) & " | "
lscadena = lscadena & Chr(10) & "+                   V E N T A     | " & ofuni.ImpreFormat(nNorCpaVta(1), 20, 2) & " | " & ofuni.ImpreFormat(nPromedio(1), 20, 2) & " | " & ofuni.ImpreFormat(nMayor(1), 20, 2) & " | " & ofuni.ImpreFormat(nMenor(1), 20, 2) & " | "
lscadena = lscadena & Chr(10) & "+---------------------------------+-------------------------+-------------------------+-------------------------+-------------------------+ "
  
    For i = 1 To 10
        If i = 1 Then
            sCad = "EURO"
        ElseIf i = 2 Then
            sCad = "LIBRA ESTERLINA"
        ElseIf i = 3 Then
            sCad = "MARCO ALEMAN"
        ElseIf i = 4 Then
            sCad = "YEN JAPONES"
        ElseIf i = 5 Then
            sCad = "FRANCO SUIZO"
        ElseIf i = 6 Then
            sCad = "CHELIN AUSTRIACO"
        ElseIf i = 7 Then
            sCad = "FRANCO FRANCES"
        ElseIf i = 8 Then
            sCad = "CORONA SUECA"
        ElseIf i = 9 Then
            sCad = "FLORIN HOLANDES"
        'ElseIf i = 10 Then
        '    sCad = "DOLAR CANADIENSE"
        'ElseIf i = 11 Then
        '    scad = "FRANCO BELGA"
        'ElseIf i = 12 Then
        '    scad = "LIRA ITALIANA"
        'ElseIf i = 13 Then
        '   scad = "CORONA DANESA"
        'ElseIf i = 14 Then
        '    scad = "CORONA NORUEGA"
        ElseIf i = 10 Then
            sCad = "OTRAS MONEDAS 3/"
        End If
        lscadena = lscadena & Chr(10) & "+ " & sCad & "       |                         |                         |                         |                         | "
        lscadena = lscadena & Chr(10) & "+                   C O M P R A   | " & ofuni.ImpreFormat(0, 20, 2) & " | " & ofuni.ImpreFormat(0, 20, 2) & " | " & ofuni.ImpreFormat(0, 20, 2) & " | " & ofuni.ImpreFormat(0, 20, 2) & " | "
        lscadena = lscadena & Chr(10) & "+                   V E N T A     | " & ofuni.ImpreFormat(0, 20, 2) & " | " & ofuni.ImpreFormat(0, 20, 2) & " | " & ofuni.ImpreFormat(0, 20, 2) & " | " & ofuni.ImpreFormat(0, 20, 2) & " | "
        lscadena = lscadena & Chr(10) & "+---------------------------------+-------------------------+-------------------------+-------------------------+-------------------------+ "
    
    Next
    
    lscadena = lscadena & Chr(10) & "1/ No incluye operaciones con derivados"
    lscadena = lscadena & Chr(10) & "2/ Expresar a tres decimales"
    lscadena = lscadena & Chr(10) & "3/ Especificar cada moneda"
    
    lscadena = lscadena & Chr(10) & Chr(10) & Chr(10) & Space(38) & "___________________                         __________________________"
    lscadena = lscadena & Chr(10) & Space(40) & "GERENTE GENERAL                             FUNCIONARIO AUTORIZADO"
    
    ImprimeRep05 = lscadena
'    If Len(Trim(lsCadena)) > 0 Then
'        oPrevio.Show lsCadena, "COTIZACION DE OFERTA Y DEMANDA DE MONEDA EXTRANJERA", True, 66, gImpresora
'    Else
'        MsgBox "No existen datos que mostrar", vbInformation, "Aviso!!!"
'    End If


'lsHoja = "REPORTE_05"
'
'ExcelAddHoja lsHoja, xlLibro, xlHoja1
'xlHoja1.PageSetup.CenterHorizontally = True
'xlHoja1.PageSetup.Zoom = 90
'xlHoja1.PageSetup.Orientation = xlPortrait
'
'
'nfila = 1
'xlHoja1.Cells(nfila, 1) = "SUPERINTENDENCIA DE BANCA Y SEGUROS "
'xlHoja1.Cells(nfila, 5) = " REPORTE NRO 05"
'nfila = nfila + 1
'xlHoja1.Cells(nfila, 1) = "EMPRESA: " & gsNomCmac
'xlHoja1.Cells(nfila, 5) = " CODIGO: " & gsCodCMAC
'nfila = nfila + 1
'xlHoja1.Cells(nfila, 1) = "FECHA: " & sFecha
'nfila = nfila + 2
'xlHoja1.Cells(nfila, 1) = "COTIZACION DE OFERTA Y DEMANDA DE MONEDA EXTRANJERA 1/"
'
'nfila = nfila + 2
'xlHoja1.Cells(nfila, 1) = "MONEDAS"
'xlHoja1.Cells(nfila, 2) = "MONTO NEGOCIADO"
'xlHoja1.Cells(nfila, 3) = "TIPO DE CAMBIO 2/"
'nfila = nfila + 1
'xlHoja1.Cells(nfila, 2) = "EN LA MONEDA"
'xlHoja1.Cells(nfila, 3) = "PROMEDIO"
'xlHoja1.Cells(nfila, 4) = "MAXIMO"
'xlHoja1.Cells(nfila, 5) = "MINIMO"
'nfila = nfila + 1
'xlHoja1.Cells(nfila, 2) = "RESPECTIVA"
'xlHoja1.Cells(nfila, 3) = "PONDERADO"
'
'xlHoja1.Range("A1:D1").MergeCells = True
'xlHoja1.Range("A2:D2").MergeCells = True
'xlHoja1.Range("A3:B3").MergeCells = True
'xlHoja1.Range("A5:E5").MergeCells = True
'xlHoja1.Range("C7:E7").MergeCells = True
'
'xlHoja1.Range("A1:E9").Font.Bold = True
'xlHoja1.Range("A1:E3").HorizontalAlignment = xlLeft
'xlHoja1.Range("A5:E9").HorizontalAlignment = xlCenter
'
'ExcelCuadro xlHoja1, 1, 7, 5, 9, True, False
'ExcelCuadro xlHoja1, 3, 7, 5, 7, True, True
'
'
'nfila = nfila + 1
'xlHoja1.Cells(nfila, 1) = "DOLAR NORTEAMERICANO"
'xlHoja1.Range("A" & nfila & ":A" & nfila).Font.Bold = True
'nfila = nfila + 1
'xlHoja1.Cells(nfila, 1) = "COMPRA"
'xlHoja1.Range("A" & nfila & ":A" & nfila).HorizontalAlignment = xlRight
'xlHoja1.Cells(nfila, 2) = nNorCpaVta(0)
'xlHoja1.Cells(nfila, 3) = Format(nPromedio(0), "#,##0.000")
'xlHoja1.Cells(nfila, 4) = Format(nMayor(0), "#,##0.000")
'xlHoja1.Cells(nfila, 5) = Format(nMenor(0), "#,##0.000")
'xlHoja1.Range("B" & nfila & ":E" & nfila).NumberFormat = "#,#0.000"
'nfila = nfila + 1
'xlHoja1.Cells(nfila, 1) = "VENTA"
'xlHoja1.Range("A" & nfila & ":A" & nfila).HorizontalAlignment = xlRight
'xlHoja1.Cells(nfila, 2) = Format(nNorCpaVta(1), "#,##0.000")
'xlHoja1.Cells(nfila, 3) = Format(nPromedio(1), "#,##0.000")
'xlHoja1.Cells(nfila, 4) = Format(nMayor(1), "#,##0.000")
'xlHoja1.Cells(nfila, 5) = Format(nMenor(1), "#,##0.000")
'xlHoja1.Range("B" & nfila & ":E" & nfila).NumberFormat = "#,##0.000"
'
'ExcelCuadro xlHoja1, 1, nfila - 2, 5, nfila, True
'
'    For i = 1 To 10
'        If i = 1 Then
'            sCad = "EURO"
'        ElseIf i = 2 Then
'            sCad = "LIBRA ESTERLINA"
'        ElseIf i = 3 Then
'            sCad = "MARCO ALEMAN"
'        ElseIf i = 4 Then
'            sCad = "YEN JAPONES"
'        ElseIf i = 5 Then
'            sCad = "FRANCO SUIZO"
'        ElseIf i = 6 Then
'            sCad = "CHELIN AUSTRIACO"
'        ElseIf i = 7 Then
'            sCad = "FRANCO FRANCES"
'        ElseIf i = 8 Then
'            sCad = "CORONA SUECA"
'        ElseIf i = 9 Then
'            sCad = "FLORIN HOLANDES"
'        'ElseIf i = 10 Then
'        '    sCad = "DOLAR CANADIENSE"
'        'ElseIf i = 11 Then
'        '    scad = "FRANCO BELGA"
'        'ElseIf i = 12 Then
'        '    scad = "LIRA ITALIANA"
'        'ElseIf i = 13 Then
'        '   scad = "CORONA DANESA"
'        'ElseIf i = 14 Then
'        '    scad = "CORONA NORUEGA"
'        ElseIf i = 10 Then
'            sCad = "OTRAS MONEDAS 3/"
'        End If
'
'        nfila = nfila + 1
'        xlHoja1.Cells(nfila, 1) = sCad
'        xlHoja1.Range("A" & nfila & ":A" & nfila).Font.Bold = True
'        nfila = nfila + 1
'        xlHoja1.Cells(nfila, 1) = "COMPRA"
'        xlHoja1.Range("A" & nfila & ":A" & nfila).HorizontalAlignment = xlRight
'        xlHoja1.Cells(nfila, 2) = 0
'        xlHoja1.Cells(nfila, 3) = 0
'        xlHoja1.Cells(nfila, 4) = 0
'        xlHoja1.Cells(nfila, 5) = 0
'        xlHoja1.Range("B" & nfila & ":E" & nfila).NumberFormat = "#,##0.000"
'        nfila = nfila + 1
'        xlHoja1.Cells(nfila, 1) = "VENTA"
'        xlHoja1.Range("A" & nfila & ":A" & nfila).HorizontalAlignment = xlRight
'        xlHoja1.Cells(nfila, 2) = 0
'        xlHoja1.Cells(nfila, 3) = 0
'        xlHoja1.Cells(nfila, 4) = 0
'        xlHoja1.Cells(nfila, 5) = 0
'        xlHoja1.Range("B" & nfila & ":E" & nfila).NumberFormat = "#,##0.000"
'        ExcelCuadro xlHoja1, 1, nfila - 2, 5, nfila, True
'    Next
'
'    nfila = nfila + 1
'    xlHoja1.Cells(nfila, 1) = "1/ No incluye operaciones con derivados"
'
'    xlHoja1.Range("A" & nfila & ":B" & nfila).MergeCells = True
'    nfila = nfila + 1
'    xlHoja1.Cells(nfila, 1) = "2/ Expresar a tres decimales"
'    xlHoja1.Range("A" & nfila & ":B" & nfila).MergeCells = True
'    nfila = nfila + 1
'    xlHoja1.Cells(nfila, 1) = "3/ Especificar cada moneda"
'    xlHoja1.Range("A" & nfila & ":B" & nfila).MergeCells = True
'
'    nfila = nfila + 6
'    xlHoja1.Cells(nfila, 2) = "GERENTE GENERAL"
'    xlHoja1.Cells(nfila, 4) = "FUNCIONARIO AUTORIZADO"
'
'    xlHoja1.Range("A" & nfila & ":E" & nfila).Font.Bold = True
'
'    xlHoja1.Cells.Font.Name = "Arial"
'    xlHoja1.Cells.Font.Size = 8
'    xlHoja1.Cells.EntireColumn.AutoFit
'
'    xlHoja1.Range("B1:B1").ColumnWidth = 21.29
       
End Function
Public Function ImprimeSaldosCaptaciones(ByVal sFecSis As Date, _
ByVal sFecha As Date, ByVal gsNomCmac As String, ByVal psCodAge As String, _
ByVal psNomAge As String) As String

Dim oCon As COMConecta.DCOMConecta
Dim rs As ADODB.Recordset
Dim lscadena As String
Dim ofuni As New COMFunciones.FCOMImpresion
Set oCon = New COMConecta.DCOMConecta
oCon.AbreConexion
Set rs = New ADODB.Recordset



lscadena = " Select cAgeCod,cAgeDescripcion,nConsValor,cConsdescripcion,"
lscadena = lscadena & " Soles , Dolares,NumCuentas,NumClientes,"
lscadena = lscadena & " NumClientesReal=(   Select Count(Distinct PP.cPersCod)"
lscadena = lscadena & "                     From CapSaldosDiarios CS"
lscadena = lscadena & "                     Inner Join ProductoPersona PP On PP.cCtaCod=CS.cCtaCod And PP.nPrdPersRelac = 10"
lscadena = lscadena & "                     Where datediff(day,dfecha,'" & Format(sFecha, "MM/DD/YYYY") & "')=0"
lscadena = lscadena & "                  )"
lscadena = lscadena & " From"
lscadena = lscadena & " ("
lscadena = lscadena & "     select"
lscadena = lscadena & "     substring(cs.cctacod,4,2) Age, substring(cs.cctacod,6,3) Prod,"
lscadena = lscadena & "     sum(case when substring(cs.cctacod,9,1)= '1' then nSaldCnt else 0 end ) Soles,"
lscadena = lscadena & "     sum(case when substring(cs.cctacod,9,1)= '2' then nSaldCnt else 0 end ) Dolares,"
'By capi 23112008 segun acta 201-2008
lscadena = lscadena & "     count( Distinct CS.cCtaCod) NumCuentas,count( Distinct PP.cPersCod) NumClientes"
'

'By capi 23112008 segun acta 201-2008
'lscadena = lscadena & "     from capsaldosdiarios where"
'lscadena = lscadena & "     datediff(day,dfecha,'" & Format(sFecha, "MM/DD/YYYY") & "')=0 "
lscadena = lscadena & " from capsaldosdiarios CS"
lscadena = lscadena & " Inner Join ProductoPersona PP On PP.cCtaCod=CS.cCtaCod And nPrdPersRelac = 10"
'By capi 19022009 se modifico porque la suma de saldos se alteraba cuando una cuenta tenia mas de un titular
lscadena = lscadena & " And PP.cPersCod = (Select Max(cPersCod) From Productopersona Where cCtaCod = CS.cCtaCod And nPrdPersRelac = 10 )             "
'
lscadena = lscadena & " Where datediff(day,dfecha,'" & Format(sFecha, "MM/DD/YYYY") & "')=0 "
'

If psCodAge = "" Then
Else
    lscadena = lscadena & " and substring(cs.cctacod,4,2) = '" & psCodAge & "'"
End If
lscadena = lscadena & "     Group by substring(cs.cctacod,4,2),substring(cs.cctacod,6,3)"
lscadena = lscadena & " ) S"
lscadena = lscadena & " Inner Join Agencias A on cAgeCod = S.Age"
lscadena = lscadena & " Inner Join Constante C on nConsValor = convert(int,S.Prod) and nConsCod = 1001"
lscadena = lscadena & " Order by cAgeCod, nConsValor"
Set rs = oCon.CargaRecordSet(lscadena)
 
'Imprime la cabecera del reporte
lscadena = ""
lscadena = lscadena & gsNomCmac & " - " & psNomAge & Chr$(10)
lscadena = lscadena & " REPORTE DE SALDOS DE CAPTACIONES AL : " & Format(sFecha, "DD/MM/YYYY") & Chr$(10)

'By capi 23112008
'lscadena = lscadena & String(80, "-") & Chr$(10)
'lscadena = lscadena & ofuni.ImpreFormat("Agencia  ", 25) & ofuni.ImpreFormat(" Tipo Producto", 16) & ofuni.ImpreFormat("Saldo Soles", 15) & ofuni.ImpreFormat("Saldo Dolares", 15) & Chr$(10)
'lscadena = lscadena & String(80, "-") & Chr$(10)
lscadena = lscadena & String(120, "-") & Chr$(10)
lscadena = lscadena & ofuni.ImpreFormat("Agencia  ", 25) & ofuni.ImpreFormat(" Tipo Producto", 16) & ofuni.ImpreFormat("Saldo Soles", 15) & ofuni.ImpreFormat("Saldo Dolares", 15) & ofuni.ImpreFormat("Num Cuentas", 15) & ofuni.ImpreFormat("Num Clientes", 15) & Chr$(10)
lscadena = lscadena & String(120, "-") & Chr$(10)
'

                 
Do Until rs.EOF
    lscadena = lscadena & ofuni.ImpreFormat(rs!cAgeCod & " " & rs!cAgeDescripcion, 25) & ofuni.ImpreFormat(" - " & rs!nConsValor & " " & rs!cConsdescripcion, 12) & _
    ofuni.ImpreFormat(rs!Soles, 13) & ofuni.ImpreFormat(rs!Dolares, 13) & ofuni.ImpreFormat(rs!numcuentas, 13) & ofuni.ImpreFormat(rs!numclientes, 13) & Chr$(10)

    rs.MoveNext
Loop
If rs.RecordCount > 0 Then
    rs.MoveFirst
    lscadena = lscadena & Space(20) & "Numero Real Clientes...: " & rs!numclientesreal & Chr$(10)
    lscadena = lscadena & String(120, "-") & Chr$(12)
End If


ImprimeSaldosCaptaciones = lscadena
oCon.CierraConexion
Set oCon = Nothing
Set ofuni = Nothing
End Function

Function ConsolidadoInactivas(dFecIni As Date, dFecFin As Date) As String
    Dim SQL1 As String
    Dim Sql2 As String
    Dim Sql3 As String
    Dim rs1 As ADODB.Recordset
    Dim Rs2 As ADODB.Recordset
    Dim Rs3 As ADODB.Recordset
    Set rs1 = New ADODB.Recordset
    Set Rs2 = New ADODB.Recordset
    Set Rs3 = New ADODB.Recordset
    Dim lscad As String
    Dim lnNum1 As Long
    Dim lnMon1 As Currency
    Dim lnNum2 As Long
    Dim lnMon2 As Currency
    Dim lnNum3 As Long
    Dim lnMon3 As Currency
    Dim lnTotNumero As Long
    Dim lnTotMonto As Currency
    
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofunf As New COMFunciones.FCOMFechas
    
    oCon.AbreConexion
    lscad = lscad & Chr(10)
    lscad = lscad & Space(10) & "CAJA MAYNAS       " & Space(50) & ofunf.ArmaFecha(ldFecSis) & Chr(10)
    lscad = lscad & Space(10) & "                  " & Space(50) & Str(Time()) & Chr(10)
    lscad = lscad & Space(10) & Space(30) & "RESUMEN DE DESCUENTO DE INACTIVAS" & Chr(10)
    lscad = lscad & Space(10) & Space(30) & "---------------------------------" & Chr(10) & Chr(10)
    lscad = lscad & Space(10) & "Agencia : " & lsNomAge & Chr(10) & Chr(10)
    For i = 1 To 2
        lnNum1 = 0: lnMon1 = 0: lnNum2 = 0: lnMon2 = 0: lnNum3 = 0
        lnMon3 = 0: lnTotNumero = 0: lnTotMonto = 0
        SQL1 = " SELECT COUNT(MC.nMovNro) as Numero ,ISNull(Sum(MC.nMonto),0) as Monto FROM MOVCAP MC " _
             & " INNER JOIN MOV M On MC.nMovNro = M.nMOvNro WHERE MC.cOpeCod = '" & gAhoEstActInac & "'" _
             & " And Substring(MC.cCtaCod,9,1) = '" & i & "' And M.nMovFlag <> " & gMovFlagExtornado & " " _
             & " And M.cMovNro Between '" & Format(dFecIni, "YYYYMMDD") & "' and  '" & Format(DateAdd("d", 1, dFecFin), "YYYYMMDD") & "'"
        
        Sql2 = " SELECT COUNT(MC.nMovNro) as Numero , IsNull(Sum(MC.nMonto),0) as Monto FROM MOVCAP MC " _
             & " INNER JOIN MOV M On MC.nMovNro = M.nMOvNro WHERE MC.cOpeCod = '" & gAhoDctoInactiva & "'" _
             & " And Substring(MC.cCtaCod,9,1) = '" & i & "' And M.nMovFlag <> " & gMovFlagExtornado & " " _
             & " And M.cMovNro Between '" & Format(dFecIni, "YYYYMMDD") & "' and  '" & Format(DateAdd("d", 1, dFecFin), "YYYYMMDD") & "'"
             
        Sql3 = " SELECT COUNT(MC.nMovNro) as Numero , IsNull(Sum(MC.nMonto),0) as Monto FROM MOVCAP MC " _
             & " INNER JOIN MOV M On MC.nMovNro = M.nMOvNro WHERE MC.cOpeCod = '" & gAhoCancInact & "'" _
             & " And Substring(MC.cCtaCod,9,1) = '" & i & "' And M.nMovFlag <> " & gMovFlagExtornado & " " _
             & " And M.cMovNro Between '" & Format(dFecIni, "YYYYMMDD") & "' and  '" & Format(DateAdd("d", 1, dFecFin), "YYYYMMDD") & "'"
        
        Set rs1 = oCon.CargaRecordSet(SQL1)
        Set Rs2 = oCon.CargaRecordSet(Sql2)
        Set Rs3 = oCon.CargaRecordSet(Sql3)
        
        lnNum1 = IIf(rs1.EOF And rs1.BOF, 0, rs1!Numero)
        lnMon1 = IIf(rs1.EOF And rs1.BOF, 0, rs1!Monto)
        lnNum2 = IIf(Rs2.EOF And Rs2.BOF, 0, Rs2!Numero)
        lnMon2 = IIf(Rs2.EOF And Rs2.BOF, 0, Rs2!Monto)
        lnNum3 = IIf(Rs3.EOF And Rs3.BOF, 0, Rs3!Numero)
        lnMon3 = IIf(Rs3.EOF And Rs3.BOF, 0, Rs3!Monto)
        rs1.Close
        Rs2.Close
        Rs3.Close
        Set rs1 = Nothing
        Set Rs2 = Nothing
        Set Rs3 = Nothing
        lnTotNumero = lnNum2 + lnNum3
        lnTotMonto = lnMon2 + lnMon3
        
    lscad = lscad & Space(10) & "Moneda : " & IIf(i = 1, "SOLES", "DOLARES") & Chr(10)
    lscad = lscad & Space(10) & "-------------------------------------------------------------------------------------" & Chr(10)
    lscad = lscad & Space(10) & "Descripción                   " & Space(2) & "Nro     " & Space(2) & "     Monto     " & Chr(10)
    lscad = lscad & Space(10) & "-------------------------------------------------------------------------------------" & Chr(10)
    lscad = lscad & Space(10) & "Paso de Activas a Inactivas : " & Space(2) & ofunc.JDNum(Str(lnNum1), 6, False, 6, 0) & Space(2) & ofunc.JDNum(Str(lnMon1), 13, True, 10, 2) & Chr(10)
    lscad = lscad & Space(10) & "Descuento de Inactivas      : " & Space(2) & ofunc.JDNum(Str(lnNum2), 6, False, 6, 0) & Space(2) & ofunc.JDNum(Str(lnMon2), 13, True, 10, 2) & Chr(10)
    lscad = lscad & Space(10) & "Cancelación de Inactivas    : " & Space(2) & ofunc.JDNum(Str(lnNum3), 6, False, 6, 0) & Space(2) & ofunc.JDNum(Str(lnMon3), 13, True, 10, 2) & Chr(10) & Chr(10)
    lscad = lscad & Space(10) & "-------------------------------------------------------------------------------------" & Chr(10)
    lscad = lscad & Space(10) & "                      TOTAL : " & Space(2) & ofunc.JDNum(Str(lnTotNumero), 6, False, 6, 0) & Space(2) & ofunc.JDNum(Str(lnTotMonto), 13, True, 10, 2) & Chr(10)
    lscad = lscad & Space(10) & "-------------------------------------------------------------------------------------" & Chr(10) & Chr(10)
    Next
    ConsolidadoInactivas = lscad
    Set ofunc = Nothing
    Set ofunf = Nothing
End Function

Public Function RepCtaApe(pdFecIni As Date, pdFecFin As Date) As String
    Dim lscad As String
    Dim lsFechas As String
    
    lscad = ""
    lsFechas = " entre " & Format(pdFecIni, ofunf.gsFormatoFechaView) & " y " & Format(pdFecFin, ofunf.gsFormatoFechaView) & " "
    
    lscad = lscad & GetCtaApeAho("Cuentas de Ahorro Aperturadas SOLES" & lsFechas & "- Con Orden de Pago -", Moneda.gMonedaNacional, Producto.gCapAhorros, 0, 0, pdFecIni, pdFecFin, "1")
    lscad = lscad & GetCtaApeAho("Cuentas de Ahorro Aperturadas SOLES" & lsFechas & "- Sin Orden de Pago -", Moneda.gMonedaNacional, Producto.gCapAhorros, 0, 0, pdFecIni, pdFecFin, "0")
    lscad = lscad & GetCtaApeAho("Cuentas de Plazo Fijo SOLES" & lsFechas, Moneda.gMonedaNacional, Producto.gCapPlazoFijo, 0, 0, pdFecIni, pdFecFin)
    lscad = lscad & GetCtaApeAho("Cuentas de CTS SOLES" & lsFechas, Moneda.gMonedaNacional, Producto.gCapCTS, 0, 0, pdFecIni, pdFecFin)
    
    lscad = lscad & GetCtaApeAho("Cuentas de Ahorro DOLARES" & lsFechas & "- Con Orden de Pago -", Moneda.gMonedaExtranjera, Producto.gCapAhorros, 0, 0, pdFecIni, pdFecFin, "1")
    lscad = lscad & GetCtaApeAho("Cuentas de Ahorro DOLARES" & lsFechas & "- Sin Orden de Pago -", Moneda.gMonedaExtranjera, Producto.gCapAhorros, 0, 0, pdFecIni, pdFecFin, "0")
    lscad = lscad & GetCtaApeAho("Cuentas de Plazo Fijo DOLARES" & lsFechas, Moneda.gMonedaExtranjera, Producto.gCapPlazoFijo, 0, 0, pdFecIni, pdFecFin)
    lscad = lscad & GetCtaApeAho("Cuentas de CTS DOLARES" & lsFechas, Moneda.gMonedaExtranjera, Producto.gCapCTS, 0, 0, pdFecIni, pdFecFin)
    
    RepCtaApe = lscad
End Function

Private Function GetCtaApeAho(psTit As String, psMoneda As Moneda, psProd As String, lnPagina As Long, lnItem As Long, pdFecIni As Date, pdFecFin As Date, Optional psOrdPag As String = "S", Optional pbInactivas As Boolean = False) As String
    Dim sqlAho As String
    Dim rsAho As New ADODB.Recordset
    Dim lsCodCtaAnt As String
    
    Dim lsCodCta As String * 20
    Dim lsNomPers As String * 28
    Dim lnMonto  As Currency
    Dim lnMontoApe  As Currency
    Dim lsFecha As String * 24
    Dim lsTipPers As String * 15
    Dim lsContador As String * 4
    Dim lsUsu As String * 4
    Dim lsMonto As String
    Dim lsMontoApe As String
    Dim lscadena As String
    
    Dim lncontador As Integer
    
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    oCon.AbreConexion
    
    lscadena = ""
    
    sqlAho = DevQry(psProd, pdFecIni, pdFecFin, psOrdPag, psMoneda, pbInactivas)
    Set rsAho = oCon.CargaRecordSet(sqlAho)
             
    If Not (rsAho.EOF And rsAho.BOF) Then
        lscadena = lscadena & ofuni.CabeceraPagina(psTit, lnPagina, lnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
        lscadena = lscadena & ofuni.Encabezado("Item;6;Nro Cuenta;12; ;8;Nombre;20; ;9;Saldo.Disp;16; ;2;Fecha de Apertura;20;Personeria;16;Monto_Ape;18;Usu;6;", lnItem)
        
        lsCodCtaAnt = ""
        lncontador = 0
        
        While Not rsAho.EOF
            
            If rsAho!cuenta <> lsCodCtaAnt Then
                lncontador = lncontador + 1
                lsContador = ofunc.FillNum(Str(lncontador), 4, "0")
                lnMonto = rsAho!Monto
                lnMontoApe = rsAho!MontoApe
                lsMonto = Format$(lnMonto, "#,##0.00")
                lsMontoApe = Format$(lnMontoApe, "#,##0.00")
                lsUsu = rsAho!cUsu
            Else
                lsContador = ""
                lnMonto = 0
                lnMontoApe = 0
                lsMonto = ""
                lsMontoApe = ""
                lsUsu = ""
            End If
                
            lsCodCta = IIf(rsAho!cuenta = lsCodCtaAnt, "", rsAho!cuenta)
            lsNomPers = ofunc.PstaNombre(rsAho!NOMBRE)
            lsFecha = Format(rsAho!FechaApe, ofunf.gsFormatoFechaHoraView)
            lsTipPers = rsAho!Tipo
            
            lscadena = lscadena & lsContador & Space(2) & lsCodCta & lsNomPers & Space(2) & Space(15 - Len(lsMonto)) & lsMonto & Space(2) & lsFecha _
                     & lsTipPers & Space(15 - Len(lsMontoApe)) & lsMontoApe & "  " & lsUsu & Chr(10)
            
            lnItem = lnItem + 1
            If lnItem = 54 Then
                lscadena = lscadena & Chr(12)
                lscadena = lscadena & ofuni.CabeceraPagina(psTit, lnPagina, lnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                lscadena = lscadena & ofuni.Encabezado("Item;6;Nro Cuenta;12; ;8;Nombre;20; ;5;Saldo.Disp;16; ;2;Fecha de Apertura;20; ;4;Personeria;20;Monto_Ape;18;Usu;4;", lnItem)
                lnItem = 0
            End If
        
            lsCodCtaAnt = rsAho!cuenta
            rsAho.MoveNext
        Wend
        lscadena = lscadena & Chr(12)
    End If
    
    GetCtaApeAho = lscadena
    
    rsAho.Close
    Set rsAho = Nothing
    Set ofuni = Nothing
    Set ofunc = Nothing
End Function


Private Function GetCuentaCapAnt(ByVal psProd As String, ByVal pdFecha As Date, ByVal psAgencia As String, ByVal psNomAge As String) As String
    Dim sSql As String
    Dim rsAho As New ADODB.Recordset
    Dim lsCodCtaAnt As String
    Dim lsCodCta As String * 20
    Dim lsNomPers As String * 28
    Dim lnMonto  As Currency
    Dim lnMontoApe  As Currency
    Dim lsFecha As String * 24
    Dim lsTipPers As String * 15
    Dim lsContador As String * 4
    Dim lsUsu As String * 4
    Dim lsMonto As String
    Dim lsMontoApe As String
    Dim lscadena As String
    Dim lncontador As Integer
    Dim pCadena As String
    Dim vSaldo As Currency
    Dim vNumero As Currency
    Dim vLineas As Integer
    Dim vPage As Integer
        
    Dim paso1 As Boolean
    Dim ClsAge As COMDConstantes.DCOMAgencias
    Dim gdHoraGrab As String

    Set ClsAge = New COMDConstantes.DCOMAgencias
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    oCon.AbreConexion
    
    sSql = "    SELECT CODAGENCIA=A.CAGECOD,AGENCIA=A.CAGEDESCRIPCION, " _
               & "  PRODUCTO=CASE WHEN  SUBSTRING(P.CCTACOD,6,3)='232' THEN 'AHORROS'  WHEN  SUBSTRING(P.CCTACOD,6,3)='233' THEN  'PLAZO FIJO'   WHEN  SUBSTRING(P.CCTACOD,6,3)='234' THEN 'CTS'  END, " _
               & "  CUENTASIAF=ISNULL(R.CCTACODANT,'                  ') ,CUENTASICMAC=P.CCTACOD,ESTADO=case when p.nprdestado=1000 then 'ACTIVA' when p.nprdestado=1200 then 'BLOQUEO RETIRO' when p.nprdestado=1100 then 'BLOQUEO TOTAL' end," _
               & "  CLIENTE=(SELECT TOP 1 E.CPERSNOMBRE FROM PERSONA E JOIN PRODUCTOPERSONA PP ON PP.CPERSCOD=E.CPERSCOD WHERE PP.NPRDPERSRELAC=10 AND PP.CCTACOD=P.CCTACOD ),P.NSALDO,C.NSALDODISP,C.NINTACUM " _
               & "  FROM PRODUCTO P " _
               & "  JOIN CAPTACIONES C ON C.CCTACOD=P.CCTACOD " _
               & "  LEFT JOIN RELCUENTAS R ON R.CCTACOD=P.CCTACOD " _
               & "  JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(P.CCTACOD,4,2) " _
               & "  WHERE P.NPRDESTADO NOT IN (1300,1400) AND P.CCTACOD LIKE '108__" & psProd & "%' " _
               & "  and SUBSTRING(P.CCTACOD,4,2)='" & psAgencia & "'" _
               & "  ORDER BY CODAGENCIA,PRODUCTO,CUENTASICMAC "
    
    
    Set rsAho = oCon.CargaRecordSet(sSql)
             
    gdHoraGrab = Format(pdFecha & " " & Time, "dd/mm/yyyy hh:mm:ss")
    vPage = 1
    pCadena = pCadena & Chr(10)
    pCadena = pCadena & ofuni.ImpreFormat("CMAC MAYNAS", 35, 5) & Space(100) & "Página : " & ofuni.ImpreFormat(vPage, 6, 0) & Chr(10)
    pCadena = pCadena & ofuni.ImpreFormat(psNomAge, 35, 5) & Space(99) & Format(pdFecSis & " " & Time, "dd/mm/yyyy hh:mm") & Chr(10)
    'pCadena = pCadena & Space(4) & "Bovedas " & psBoveda & Chr(10)
    pCadena = pCadena & Space(30) & " LISTADO DE CUENTAS ANTERIORES - CUENTAS NUEVAS " & IIf(psProd = "232", "(AHORROS)", IIf(psProd = "233", "PLAZO FIJO", "CTS")) & Format(pdFecha, "dd/mm/yyyy") & " - " & ClsAge.NombreAgencia(psAgencia) & Chr(10)
    pCadena = pCadena & Space(30) & String(54, "=") & Chr(10)
    pCadena = pCadena & Chr(10)
    pCadena = pCadena & Space(1) & String(140, "-") & Chr(10)
    pCadena = pCadena & Space(1) & "CUENTA SIAFC         CUENTA SICMAC          ESTADO         CLIENTE                                   SALDO CONT.    SALDO DISP.    INT ACTUAL." & Chr(10)
    pCadena = pCadena & Space(1) & String(140, "-") & Chr(10)

vLineas = 13

lncontador = 0
While Not rsAho.EOF
        With rsAho
            pCadena = pCadena & Space(1) & !CUENTASIAF & Space(2) & !CUENTASICMAC & Space(4) & Trim(!Estado) & Space(16 - Len(Trim(!Estado))) & Trim(Left(!CLIENTE, 39)) & Space(40 - Len(Trim(Left(!CLIENTE, 39)))) & ofuni.ImpreFormat(!nSaldo, 10, 2, True) & Space(1) & ofuni.ImpreFormat(!nSaldoDisp, 10, 2, True) & Space(1) & ofuni.ImpreFormat(!nIntAcum, 10, 2, True) & Chr(10)
                    
          lncontador = lncontador + 1
            
        End With
        If vLineas > 66 Then  'pLineasMax
          vPage = vPage + 1
          pCadena = pCadena & Chr(12)
          pCadena = pCadena & Chr(10)
          pCadena = pCadena & ofuni.ImpreFormat("CMAC MAYNAS", 35, 5) & Space(100) & "Página : " & ofuni.ImpreFormat(vPage, 6, 0) & Chr(10)
          pCadena = pCadena & ofuni.ImpreFormat(psNomAge, 35, 5) & Space(99) & Format(pdFecSis & " " & Time, "dd/mm/yyyy hh:mm") & Chr(10)
         'pCadena = pCadena & Space(4) & "Bovedas " & psBoveda & Chr(10)
          pCadena = pCadena & Space(30) & " LISTADO DE CUENTAS ANTERIORES - CUENTAS NUEVAS " & IIf(psProd = "232", "(AHORROS)", IIf(psProd = "233", "PLAZO FIJO", "CTS")) & Format(pdFecha, "dd/mm/yyyy") & " - " & ClsAge.NombreAgencia(psAgencia) & Chr(10)
          pCadena = pCadena & Space(30) & String(54, "=") & Chr(10)
          pCadena = pCadena & Chr(10)
          pCadena = pCadena & Space(1) & String(140, "-") & Chr(10)
          pCadena = pCadena & Space(1) & "CUENTA SIAF         CUENTA SICMAC          ESTADO         CLIENTE                                   SALDO CONT.    SALDO DISP.    INT ACTUAL." & Chr(10)
          pCadena = pCadena & Space(1) & String(140, "-") & Chr(10)

          vLineas = 13
        End If
        vLineas = vLineas + 1
    rsAho.MoveNext
Wend

pCadena = pCadena & Space(2) & String(80, "-") & Chr(10)
pCadena = pCadena & Space(8) & "TOTAL CUENTAS: " & Space(1) & ofuni.ImpreFormat(lncontador, 6, 0) & Chr(10)
pCadena = pCadena & Space(2) & String(80, "-") & Chr(10)

'Devuelve cadena con Impresión
    GetCuentaCapAnt = pCadena & Chr(12)
Set ClsAge = Nothing
Set ofuni = Nothing
Set Co = Nothing
Set rsAho = Nothing

End Function

Public Function GetCuentaCapInact(ByVal psTipAho As Producto, _
                                   ByVal psFchPro As Date, ByVal psAgeCod As String, _
                                   ByVal psMoneda As String, ByVal pnTipo As Integer) As String
                             
    Dim sSql As String
    Dim RSTMP As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String, lscad As String
    'Dim nTipo As Integer
        
    If psAgeCod = "" Then
        sqlAdd = ""
    ElseIf psAgeCod <> "" Then
        sqlAdd = " And CS.cCtaCod Like '___" & psAgeCod & "%'"
    End If
    
    If psMoneda <> "" Then
        sqlAdd = sqlAdd & " and substring(cs.cctacod,9,1)='" & psMoneda & "'"
    End If
    
    lsMoneda = IIf(psMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES")
    nTipo = 1
    
    lsPerson = ""
    
    
'    Select Case psTipPer
'            Case PersPersoneria.gPersonaNat
'                 lsPerson = "PERSONA NATURAL"
'                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
'            Case PersPersoneria.gPersonaJurSFL
'                 lsPerson = "PERSONA JUR. SIN FINES DE LUCRO"
'                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
'            Case PersPersoneria.gPersonaJurCFL
'                 lsPerson = "PERSONA JUR. CON FINES DE LUCRO"
'                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
'            Case PersPersoneria.gPersonaJurCFLCMAC
'                 lsPerson = "CAJAS MUNICIPALES"
'                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
'            Case PersPersoneria.gPersonaJurCFLCRAC
'                 lsPerson = "CAJAS RURALES"
'                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
'            Case PersPersoneria.gPersonaJurCFLFONCODES
'                 lsPerson = "FONCODES"
'                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
'            Case PersPersoneria.gPersonaJurCFLCooperativa
'                 lsPerson = "COOPERATIVA"
'                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
'            Case PersPersoneria.gPersonaJurCFLEdpyme
'                 lsPerson = "EDPYME"
'                 sqlAdd = sqlAdd & " AND g.nPersoneria = '" & psTipPer & "'"
'    End Select
        
    
'    If psTipAho = gCapAhorros Then
'        If pnTipo = 1 Then
'
'                ssql = " SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=cs.cctacod WHERE PP.NPRDPERSRELAC=10 ), "
'                ssql = ssql & " a.cagecod,A.CAGEDESCRIPCION,codigosiaf=r.cctacodant ,CS.cCtaCod , CS.NSALDCNT, CS.NSALDDISP, CS.nInteres "
'                ssql = ssql & " ,PERSONERIA=G.CCONSDESCRIPCION , "
'                ssql = ssql & " MONEDA=CASE WHEN SUBSTRING(CS.CCTACOD,9,1)=1 THEN 'SOLES' ELSE 'DOLARES' END , CA.BORDPAG, g.npersoneria, cs.dultcontacto,TiempoInact=datediff(dd,cs.dultcontacto ,cs.dfecha ) "
'                ssql = ssql & " FROM CAPSALDOSDIARIOS CS "
'                ssql = ssql & " join relcuentas r on r.cctacod=cs.cctacod "
'                ssql = ssql & " JOIN CAPTACAHORROs CA ON CA.CCTACOD=CS.CCTACOD "
'                ssql = ssql & " join ( select * from  captaciones  c join constante k on k.nconsvalor=c.npersoneria where k.nconscod=1002) g on g.cctacod=cs.cctacod "
'                ssql = ssql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2) "
'                ssql = ssql & " WHERE CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' and substring(cs.cctacod,6,3)='" & psTipAho & "' and  datediff(dd,cs.dultcontacto ,cs.dfecha )<=720  and cs.binactiva=1 " & sqlAdd
'                'ssql = ssql & " ORDER BY  a.cagecod,CA.BORDPAG,g.npersoneria , moneda,TiempoInact,cpersnombre ,CS.CCTACOD "
'                ssql = ssql & " ORDER BY  isnull(r.cctacodant,cS.CCTACOD), moneda,a.cagecod "
'         ElseIf pnTipo = 2 Then
'
'                ssql = " SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=cs.cctacod WHERE PP.NPRDPERSRELAC=10 ), "
'                ssql = ssql & " a.cagecod,A.CAGEDESCRIPCION ,codigosiaf=r.cctacodant ,CS.cCtaCod , CS.NSALDCNT, CS.NSALDDISP, CS.nInteres "
'                ssql = ssql & " ,PERSONERIA=G.CCONSDESCRIPCION , "
'                ssql = ssql & " MONEDA=CASE WHEN SUBSTRING(CS.CCTACOD,9,1)=1 THEN 'SOLES' ELSE 'DOLARES' END , CA.BORDPAG, g.npersoneria, cs.dultcontacto,TiempoInact=datediff(dd,cs.dultcontacto ,cs.dfecha ) "
'                ssql = ssql & " FROM CAPSALDOSDIARIOS CS "
'                ssql = ssql & " join relcuentas r on r.cctacod=cs.cctacod "
'                ssql = ssql & " JOIN CAPTACAHORROs CA ON CA.CCTACOD=CS.CCTACOD "
'                ssql = ssql & " join ( select * from  captaciones  c join constante k on k.nconsvalor=c.npersoneria where k.nconscod=1002) g on g.cctacod=cs.cctacod "
'                ssql = ssql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2) "
'                ssql = ssql & " WHERE CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' and substring(cs.cctacod,6,3)='" & psTipAho & "' and  datediff(dd,cs.dultcontacto ,cs.dfecha )>720  and cs.binactiva=1 " & sqlAdd
'                'ssql = ssql & " ORDER BY  a.cagecod,CA.BORDPAG,g.npersoneria , moneda,TiempoInact,cpersnombre ,CS.CCTACOD "
'                ssql = ssql & " ORDER BY  isnull(r.cctacodant,cS.CCTACOD), moneda,a.cagecod"
'         End If
'
'    End If

                sSql = " SELECT cpersnombre=( SELECT top 1 E.CPERSNOMBRE FROM PRODUCTOPERSONA PP JOIN PERSONA E ON E.CPERSCOD=PP.CPERSCOD and pp.cctacod=cs.cctacod WHERE PP.NPRDPERSRELAC=10 ), "
                sSql = sSql & " a.cagecod,A.CAGEDESCRIPCION,codigosiaf=isnull(r.cctacodant,'                  ') ,CS.cCtaCod , CS.NSALDCNT, CS.NSALDDISP, CS.nInteres "
                sSql = sSql & " ,PERSONERIA=G.CCONSDESCRIPCION , "
                sSql = sSql & " MONEDA=CASE WHEN SUBSTRING(CS.CCTACOD,9,1)=1 THEN 'SOLES' ELSE 'DOLARES' END , CA.BORDPAG, g.npersoneria, cs.dultcontacto,TiempoInact=datediff(dd,cs.dultcontacto ,cs.dfecha ) "
                sSql = sSql & " FROM CAPSALDOSDIARIOS CS "
                sSql = sSql & " left join relcuentas r on r.cctacod=cs.cctacod "
                sSql = sSql & " JOIN CAPTACAHORROs CA ON CA.CCTACOD=CS.CCTACOD "
                sSql = sSql & " join ( select * from  captaciones  c join constante k on k.nconsvalor=c.npersoneria where k.nconscod=1002) g on g.cctacod=cs.cctacod "
                sSql = sSql & " JOIN AGENCIAS A ON A.CAGECOD=SUBSTRING(CS.CCTACOD,4,2) "
                sSql = sSql & " WHERE CONVERT(CHAR(8),CS.DFECHA,112)='" & Format(psFchPro, "yyyymmdd") & "' and substring(cs.cctacod,6,3)='" & psTipAho & "' and cs.binactiva=1 " & sqlAdd
                sSql = sSql & " ORDER BY  isnull(r.cctacodant,cS.CCTACOD), moneda,a.cagecod "

    
    If RSTMP.State = adStateOpen Then RSTMP.Close

    oCon.AbreConexion
    Set RSTMP = oCon.CargaRecordSet(sSql)
    
    lsRTFSdo = ""
    
    If RSTMP.EOF And RSTMP.BOF Then
       lscad = ""
       GetCuentaCapInact = lsRTFSdo
    ElseIf psTipAho = gCapAhorros Then
       PrtAntInactCierre RSTMP, pnTipo, psFchPro, pnTipo
       GetCuentaCapInact = lsRTFSdo
'    ElseIf psTipAho = gCapPlazoFijo Then
'       PrtAntInactCierre RSTMP, pnTipo, psFchPro
'       GetCuentaCapInact = lsRTFSdo
'    ElseIf psTipAho = gCapCTS Then
'        PrtAntInactCierre RSTMP, pnTipo, psFchPro
'        GetCuentaCapInact = lsRTFSdo
    End If
    
    oCon.CierraConexion
    
    Set oCon = Nothing
                             
End Function

Private Function PrtAntInactCierre(rsData As ADODB.Recordset, Optional nTipo As Integer = 1, Optional pdCIerre As Date, Optional nrep As Integer = 1)

    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lnTotDep As Double, lnTotRet As Double
    Dim lsCodPro As String, lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsSubTit As String, lnCntCta As Integer
    Dim lnSdoCnt As Double, lnSdoDis As Double
    Dim lnCapita As Double, lsCodCta As String
    Dim lnCapiFi As Double, lnSdDiFi As Double, lnSdCnFi As Double
    Dim lnCheEnV As Double, lnCheEnVFi As Double
    Dim lnCtaPag As Integer, lnTotCta As Integer
    Dim lnIntMes As Double, lnSdInFi As Double
    Dim lnCntRel As Integer
    Dim lbCtaIde As Boolean
    Dim lnIntCap As Double
    Dim lnIntDev As Double, lnCalInt As Double
    Dim lbCieMes As Boolean
    Dim lnNumDia As Integer, CCodage As String
    Dim lsCuenta As String
    Dim codigocta As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    If CierreRealizado(2) Then
        lbCieMes = True
    Else
        lbCieMes = False
    End If
    
    codigocta = ""
    lsNumPag = ""
    lnLinPag = 65
    lnCarLin = 105
'    If nrep = 1 Then
'        lsTitRp1 = "REPORTE DE SALDO DE CUENTA(S) INACTIVAS(360-720 dias) AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
'    ElseIf nrep = 2 Then
'        lsTitRp1 = "REPORTE DE SALDO DE CUENTA(S) INACTIVAS(mas de 720 dias) AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
'    End If
    
    lsTitRp1 = "REPORTE DE SALDO DE CUENTA(S) INACTIVAS AL CIERRE DEL " & Format(pdCIerre, "dd/MM/yyyy")
    
    
    lsTitRp2 = ""
    lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
    lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
    lnCntPag = 0
    lbCtaIde = False
    
    With rsData
         Do While Not .EOF
         
        If nTipo = 0 Then
                 Select Case !nPersoneria
                    Case PersPersoneria.gPersonaNat
                         lsPerson = "PERSONA NATURAL"
                    Case PersPersoneria.gPersonaJurSFL
                         lsPerson = "PERSONA JUR. SIN FINES DE LUCRO"
                    Case PersPersoneria.gPersonaJurCFL
                         lsPerson = "PERSONA JUR. CON FINES DE LUCRO"
                    Case PersPersoneria.gPersonaJurCFLCMAC
                         lsPerson = "CAJAS MUNICIPALES"
                    Case PersPersoneria.gPersonaJurCFLCRAC
                         lsPerson = "CAJAS RURALES"
                    Case PersPersoneria.gPersonaJurCFLFONCODES
                         lsPerson = "FONCODES"
                    Case PersPersoneria.gPersonaJurCFLCooperativa
                         lsPerson = "COOPERATIVA"
                    Case PersPersoneria.gPersonaJurCFLEdpyme
                         lsPerson = "EDPYME"
              
                End Select
        End If
                    lnCarLin = 132
                    lsTitRp2 = "AHORROS" '& " - " & lsPerson
            
            If lsTitRp2 <> lsCodPro Then
               If lsNumPag <> "" Then
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(16, " ")
                  
                                   
                  If Left(lsCodPro, 7) = "AHORROS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     
                     
                  End If
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
                  lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(19, " ")
                  'lsRTFSdo = lsRTFSdo & oFunC.JDNum(Trim(Str(lnCapiFi)), 12, True, 9, 2) & " "
                  lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
                  If Left(lsCodPro, 7) = "AHORROS" Then
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  
                  End If
                  lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                  lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
                  lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
               End If
               lsCodPro = lsTitRp2
               lnLinPag = 65
            End If
            
            If lnLinPag > 58 Or CCodage <> !cAgeCod Then
               If lsNumPag <> "" Then
                  If lnSdoDis <> 0 Or lnCapita <> 0 Then
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
                     lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(16, " ") & IIf(Mid$(!cCtaCod, 6, 3) = Producto.gCapCTS, "", " ")
                     
                     lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
                     If Left(lsCodPro, 7) = "AHORROS" Then
                        lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                     End If
                     lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
                     lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
                  End If
               End If
               
               lnCntPag = lnCntPag + 1
               lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
               lsRTFSdo = lsRTFSdo & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1 + " AGENCIA: " + !cAgeDescripcion, lsTitRp2, lsMoneda, lsNumPag) & oImp.gPrnSaltoLinea
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
               'If Mid$(!cCtaCod, 6, 3) = Producto.gCapPlazoFijo Then
                  lsRTFSdo = lsRTFSdo & "    NUMERO         " '& String(10, " ")
                  lsRTFSdo = lsRTFSdo & "    NUMERO         " '& String(10, " ")
                  lsRTFSdo = lsRTFSdo & "  NOMBRE / RAZON SOCIAL" & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "     SALDO     "
                  lsRTFSdo = lsRTFSdo & "     SALDO     "
                  lsRTFSdo = lsRTFSdo & "  ULT. CONTACTO "
                  lsRTFSdo = lsRTFSdo & "  DIAS INAC." & oImp.gPrnSaltoLinea
                  
                  lsRTFSdo = lsRTFSdo & "    CUENTA SIAFC   " '& String(10, " ")
                  lsRTFSdo = lsRTFSdo & "    CUENTA SICMACT " '& String(10, " ")
                  lsRTFSdo = lsRTFSdo & "     DEL CLIENTE       " & String(14, " ")
                  lsRTFSdo = lsRTFSdo & "   DISPONIBLE  "
                  lsRTFSdo = lsRTFSdo & "   CONTABLE    "
                  lsRTFSdo = lsRTFSdo & "    " & oImp.gPrnSaltoLinea
                                    
               lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea         ' hasta 160 caracteres x línea
               lnLinPag = 9
            End If
            lnCntRel = 0


               lsCodCta = !cCtaCod
               lbCtaIde = False
               lsRTFSdo = lsRTFSdo & !Codigosiaf & " "
               lsRTFSdo = lsRTFSdo & !cCtaCod & " "
               If Len(Trim(!cpersnombre)) < 50 Then
                  lsRTFSdo = lsRTFSdo & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cpersnombre), False), 37), 37, " ") & " "
               Else
                  lsRTFSdo = lsRTFSdo & Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(!cpersnombre), False), 37) & " "
               End If
               lnCtaPag = lnCtaPag + 1: lnTotCta = lnTotCta + 1
               
               Select Case Mid$(!cCtaCod, 6, 3)
                  Case Producto.gCapAhorros
                  
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!NSALDDISP, 12, True, 9, 2) & " "
                       lsRTFSdo = lsRTFSdo & ofunc.JDNum(!nSaldCnt, 12, True, 9, 2) & "          "
                       lsRTFSdo = lsRTFSdo & Format(!DULTCONTACTO, "dd/MM/yyyy") & "   "
                       lsRTFSdo = lsRTFSdo & !tiempoinact & Chr(10)
                       
                  

                       lnIntCap = 0
                  
                       
                       lnCapita = lnCapita + 0: lnCapiFi = lnCapiFi + 0
                       lnSdoCnt = lnSdoCnt + !nSaldCnt
                       lnSdoDis = lnSdoDis + !NSALDDISP
               
                       lnSdCnFi = lnSdCnFi + !nSaldCnt
               
                       lnSdDiFi = lnSdDiFi + !NSALDDISP
               
                       lbCtaIde = True
                  
               End Select
'            End If
            lnCntCta = lnCntCta + 1
            lnLinPag = lnLinPag + lnCntRel + 1
            lsCuenta = Mid(!cCtaCod, 6, 3)
               
            CCodage = !cAgeCod
            codigocta = !cCtaCod
            .MoveNext
         Loop
    End With
    If rsData.EOF Then
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea              ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Registros x Pag. " & ofunc.FillNum(Trim(Str(lnCtaPag)), 5, " ") & "   Total Pag. " & lsNumPag & String(16, " ")
      
       If Left(lsCodPro, 7) = "AHORROS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoDis)), 12, True, 9, 2) & " "
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdoCnt)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       End If
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "-") & oImp.gPrnSaltoLinea             ' hasta 160 caracteres x línea
       lsRTFSdo = lsRTFSdo & "Total Registros  " & ofunc.FillNum(Trim(Str(lnTotCta)), 5, " ") & "   Acum. Total " & String(19, " ")
       lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdDiFi)), 12, True, 9, 2) & " "
       
       If Left(lsCodPro, 7) = "AHORROS" Then
          lsRTFSdo = lsRTFSdo & ofunc.JDNum(Trim(Str(lnSdCnFi)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       End If
       
       lsRTFSdo = lsRTFSdo & String(lnCarLin, "=") & oImp.gPrnSaltoPagina             ' hasta 160 caracteres x línea
       lnCapita = 0: lnSdoCnt = 0: lnSdoDis = 0: lnCtaPag = 0: lnIntMes = 0: lnCheEnV = 0
       lnCapiFi = 0: lnSdCnFi = 0: lnSdDiFi = 0: lnTotCta = 0: lnSdInFi = 0: lnCheEnVFi = 0
    End If
    
    Set ofunc = Nothing
    Set ofuni = Nothing

End Function


Private Function DevQry(psCodProd As String, dFecIni As Date, dFecFin As Date, Optional psOrdPag As String = "S", Optional psMoneda As Moneda = gMonedaNacional, Optional pbInactivas As Boolean = False) As String
    Dim sqlAdd As String
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And PR.cCtaCod Like '___" & lsAgeCod & "%' "
    End If
    
    
    If pbInactivas Then
        DevQry = " Select Cuenta = A.cCodCta, Nombre = P.cNomPers, Monto = A.nSaldCntAC, FechaApe = A.dAperAC, " _
               & " UltCon = dUltCntAC FROM Ahorroc A Inner Join Perscuenta PC" _
               & " Inner Join Persona P On P.cCodPers = PC.cCodPers " _
               & " on A.cCodcTA = pC.cCodCta" _
               & " where bInactiva = 1 and cOrdPag = '" & psOrdPag & "' and substring(Aho.cCodCta,6,1) = '" & psMoneda & "' and cEstCtaAC not in ('C','U') order by Aho.cCodCta"
        Exit Function
    End If
    'Modi By GITU 2010-07-31 porque generaba un valor Nulo
    Select Case psCodProd
        Case gCapAhorros
            DevQry = " Select  PR.cCtaCod Cuenta, PE.cPersNombre Nombre, CAP.nSaldoDisp Monto, CAP.dApertura FechaApe," _
                   & " CO.cConsDescripcion Tipo, " _
                   & " IsNull(nMonto,0) MontoApe, ISNull((Select Right(cMovNro,4) From Mov M Where M.nMovnro = MC.nMovNro),'') cUsu" _
                   & " From Producto PR" _
                   & " Inner Join ProductoPersona PP On PR.cCtaCod = PP.cCtaCod" _
                   & " Inner Join Persona PE On PP.cPersCod  = PE.cPersCod" _
                   & " Inner Join Captaciones CAP On PR.cCtaCod = CAP.cCtaCod" _
                   & " Inner Join CaptacAhorros CAPAHO On PR.cCtaCod = CAPAHO.cCtaCod" _
                   & " Left Join MovCap MC On MC.cCtaCod = CAP.cCtaCod And MC.cOpeCod In ('" & GetOpeGrupoRep(, 1, False) & "')" _
                   & " Inner Join Constante CO On CAP.nPersoneria = nConsValor And nConsCod = 1002 " _
                   & " Where CAP.dApertura Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' And '" & Format(DateAdd("d", 1, dFecFin), ofunf.gsFormatoFecha) & "' and CAPAHO.bOrdPag = " & psOrdPag & "" _
                   & " And SubString(PR.cCtaCod,9,1) = '" & psMoneda & "' and Left(nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "') " & sqlAdd & "" _
                   & " Order By CAP.cCtaCod"
        Case gCapPlazoFijo
            DevQry = " Select  PR.cCtaCod Cuenta, PE.cPersNombre Nombre, CAP.nSaldoDisp Monto, CAP.dApertura FechaApe," _
                   & " CO.cConsDescripcion Tipo, " _
                   & " IsNull(nApertura,0) MontoApe, ISNull((Select Right(cMovNro,4) From Mov M Where M.nMovnro = MC.nMovNro),'') cUsu" _
                   & " From Producto PR" _
                   & " Inner Join ProductoPersona PP On PR.cCtaCod = PP.cCtaCod" _
                   & " Inner Join Persona PE On PP.cPersCod  = PE.cPersCod" _
                   & " Inner Join Captaciones CAP On PR.cCtaCod = CAP.cCtaCod" _
                   & " Inner Join CaptacPlazoFijo CAPPF On PR.cCtaCod = CAPPF.cCtaCod" _
                   & " Left Join MovCap MC On MC.cCtaCod = CAP.cCtaCod And MC.cOpeCod In ('" & GetOpeGrupoRep(, 3, False) & "')" _
                   & " Inner Join Constante CO On CAP.nPersoneria = nConsValor And nConsCod = 1002 " _
                   & " Where CAP.dApertura Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' And '" & Format(DateAdd("d", 1, dFecFin), ofunf.gsFormatoFecha) & "'" _
                   & " And SubString(PR.cCtaCod,9,1) = '" & psMoneda & "' and Left(nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "') " & sqlAdd & "" _
                   & " Order By CAP.cCtaCod"
        Case gCapCTS
            DevQry = " Select  PR.cCtaCod Cuenta, PE.cPersNombre Nombre, CAP.nSaldoDisp Monto, CAP.dApertura FechaApe," _
                   & " CO.cConsDescripcion Tipo, " _
                   & " IsNull(nMonto,0) MontoApe, ISNull((Select Right(cMovNro,4) From Mov M Where M.nMovnro = MC.nMovNro),'') cUsu" _
                   & " From Producto PR" _
                   & " Inner Join ProductoPersona PP On PR.cCtaCod = PP.cCtaCod" _
                   & " Inner Join Persona PE On PP.cPersCod  = PE.cPersCod" _
                   & " Inner Join Captaciones CAP On PR.cCtaCod = CAP.cCtaCod" _
                   & " Inner Join CaptacCTS CAPCTS On PR.cCtaCod = CAPCTS.cCtaCod" _
                   & " Left Join MovCap MC On MC.cCtaCod = CAP.cCtaCod And MC.cOpeCod In ('" & GetOpeGrupoRep(, 5, False) & "')" _
                   & " Inner Join Constante CO On CAP.nPersoneria = nConsValor And nConsCod = 1002 " _
                   & " Where CAP.dApertura Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' And '" & Format(DateAdd("d", 1, dFecFin), ofunf.gsFormatoFecha) & "'" _
                   & " And SubString(PR.cCtaCod,9,1) = '" & psMoneda & "' and Left(nPrdEstado,2) Not In ('" & Left(CaptacEstado.gCapEstAnulada, 2) & "','" & Left(CaptacEstado.gCapEstCancelada, 2) & "')" & sqlAdd & "" _
                   & " Order By CAP.cCtaCod"
    End Select
    'End GITU
End Function
'By Capi 13082008 se adiciono parametro opcional para imprimir solo cuentas a tasa pactada
'Public Function RepCtaCan(pdFecIni As Date, pdFecFin As Date) As String
Public Function RepCtaCan(pdFecIni As Date, pdFecFin As Date, Optional ByVal pbaTasaPactada As Boolean = False) As String
    Dim lscad As String
    Dim lsFechas As String
    
    lscad = ""
    lsFechas = " entre " & Format(pdFecIni, ofunf.gsFormatoFechaView) & " y " & Format(pdFecFin, ofunf.gsFormatoFechaView) & " "
    
    'By Capi 12082008 se adiciono parametro pbaTasaPactada que se usa solo en plazos fijos
    lscad = lscad & GetCtaCanAho("Cuentas Canceladas de Ahorro SOLES" & lsFechas & "- Con Orden de Pago -", Moneda.gMonedaNacional, Producto.gCapAhorros, 0, 0, pdFecIni, pdFecFin, "1", , pbaTasaPactada)
    lscad = lscad & GetCtaCanAho("Cuentas Canceladas de Ahorro SOLES" & lsFechas & "- Sin Orden de Pago -", Moneda.gMonedaNacional, Producto.gCapAhorros, 0, 0, pdFecIni, pdFecFin, "0", , pbaTasaPactada)
    lscad = lscad & GetCtaCanAho("Cuentas Canceladas de Plazo Fijo SOLES" & lsFechas & "", Moneda.gMonedaNacional, Producto.gCapPlazoFijo, 0, 0, pdFecIni, pdFecFin, , , pbaTasaPactada)
    lscad = lscad & GetCtaCanAho("Cuentas Canceladas de CTS SOLES" & lsFechas & "", Moneda.gMonedaNacional, Producto.gCapCTS, 0, 0, pdFecIni, pdFecFin, , , pbaTasaPactada)
    
    lscad = lscad & GetCtaCanAho("Cuentas Canceladas de Ahorro DOLARES" & lsFechas & "- Con Orden de Pago -", Moneda.gMonedaExtranjera, Producto.gCapAhorros, 0, 0, pdFecIni, pdFecFin, "1", , pbaTasaPactada)
    lscad = lscad & GetCtaCanAho("Cuentas Canceladas de Ahorro DOLARES" & lsFechas & "- Sin Orden de Pago -", Moneda.gMonedaExtranjera, Producto.gCapAhorros, 0, 0, pdFecIni, pdFecFin, "0", , pbaTasaPactada)
    lscad = lscad & GetCtaCanAho("Cuentas Canceladas de Plazo Fijo DOLARES" & lsFechas & "", Moneda.gMonedaExtranjera, Producto.gCapPlazoFijo, 0, 0, pdFecIni, pdFecFin, , , pbaTasaPactada)
    lscad = lscad & GetCtaCanAho("Cuentas Canceladas de CTS DOLARES" & lsFechas & "", Moneda.gMonedaExtranjera, Producto.gCapCTS, 0, 0, pdFecIni, pdFecFin, , , pbaTasaPactada)
    
    RepCtaCan = lscad
End Function
'By Capi 13082008 se adiciona parametro opcional pbaTasaPactada
Private Function GetCtaCanAho(psTit As String, psMoneda As Moneda, psProd As String, lnPagina As Long, lnItem As Long, pdFecIni As Date, pdFecFin As Date, Optional psOrdPag As String = "S", Optional pbInactivas As Boolean = False, Optional pbaTasaPactada As Boolean = False) As String
    Dim sqlAho As String
    Dim rsAho As ADODB.Recordset
    Set rsAho = New ADODB.Recordset
    Dim lsCodCtaAnt As String
    
    Dim lsCodCta As String * 20
    Dim lsNomPers As String * 28
    Dim lsDirPers As String * 40

    Dim lnMonto  As Currency
    Dim lsFecha As String * 24
    Dim lsTipPers As String * 30
    Dim lsContador As String * 4
    Dim lscadena As String
    Dim lncontador As Integer
    
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    Dim lsUsu As String
    Dim lnTasaEfectiva As Double
    Dim lsTasaEfecita As String
    
    oCon.AbreConexion
    
    Dim lsMonto As String
    lscadena = ""
    
    'By Capi 13082008 se agrego parametro pbaTasaPactada
    'sqlAho = DevQryCan(psProd, pdFecIni, pdFecFin, psOrdPag, psMoneda)
    sqlAho = DevQryCan(psProd, pdFecIni, pdFecFin, psOrdPag, psMoneda, pbaTasaPactada)
    
    Set rsAho = oCon.CargaRecordSet(sqlAho)
             
    If Not (rsAho.EOF And rsAho.BOF) Then
        If pbaTasaPactada = True Then
            lscadena = lscadena & ofuni.CabeceraPagina(psTit & " A TASA PACTADA", lnPagina, lnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
            lscadena = lscadena & ofuni.Encabezado("Item;6;Nro Cuenta;12; ;8;Nombre;25; ;5;Monto;16; ;2;Fecha de Cancelacion;22; ;4;Tasa;6;Personeria;16;Usuario;18;Direccion;30; ;10;", lnItem)
        Else
            lscadena = lscadena & ofuni.CabeceraPagina(psTit, lnPagina, lnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
            lscadena = lscadena & ofuni.Encabezado("Item;6;Nro Cuenta;12; ;8;Nombre;25; ;5;Monto;16; ;2;Fecha de Cancelacion;22; ;4;Personeria;16;Usuario;18;Direccion;30; ;10;", lnItem)
        End If
        
        lsCodCtaAnt = ""
        lncontador = 0
        
        While Not rsAho.EOF
            
            If rsAho!cuenta <> lsCodCtaAnt Then
                'TODOCOMPLETA
                lncontador = lncontador + 1
                lsContador = ofunc.FillNum(Str(lncontador), 6, "0")
                lsCodCta = rsAho!cuenta
                lnMonto = rsAho!Monto
                lsMonto = Space(18 - Len(Format(lnMonto, "#,##0.00"))) & Format(lnMonto, "#,##0.00")
                lsFecha = Format(rsAho!FechaCancel, ofunf.gsFormatoFechaHoraView)
                lsUsu = rsAho!Usu
                lsTipPers = rsAho!Tipo
                'By Capi 14082008
                If pbaTasaPactada = True And psProd = gCapPlazoFijo Then
                    lnTasaEfectiva = Round(((1 + rsAho!TasaNominal / 36000) ^ 360 - 1) * 100, 2)
                    lsTasaEfectiva = Space(6 - Len(Format(lnTasaEfectiva, "##0.00"))) & Format(lnTasaEfectiva, "##0.00")
                End If
                '
            Else
                lsContador = ""
                lsCodCta = ""
                lsMonto = Space(18)
                lsFecha = ""
                lsUsu = "    "
                lsTipPers = ""
                lsTasaEfectiva = Space(6)
            End If
            
            lsNomPers = ofunc.PstaNombre(rsAho!NOMBRE)
            lsDirPers = rsAho!Direccion
            
            'By Capi 14082008
            If pbaTasaPactada = True Then
                lscadena = lscadena & lsContador & Space(2) & lsCodCta & lsNomPers & Space(1) & lsMonto & Space(2) & lsFecha & " -" & Trim(lsTasaEfectiva) & "- " & Space(2) & lsTipPers & lsUsu & "  " & Trim(lsDirPers) & Chr(10)
            Else
                lscadena = lscadena & lsContador & Space(2) & lsCodCta & lsNomPers & Space(1) & lsMonto & Space(2) & lsFecha & lsTipPers & lsUsu & "  " & lsDirPers & Chr(10)
            End If
            lnItem = lnItem + 1
            If lnItem = 54 Then
                lscadena = lscadena & Chr(12)
                If pbaTasaPactada = True Then
                    lscadena = lscadena & ofuni.CabeceraPagina(psTit & " A TASA PACTADA", lnPagina, lnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                    lscadena = lscadena & ofuni.Encabezado("Item;6;Nro Cuenta;12; ;8;Nombre;25; ;5;Monto;16; ;2;Fecha de Cancelacion;22; ;4;Tasa;6;Personeria;16;Usuario;18;Direccion;30; ;10;", lnItem)
                Else
                    lscadena = lscadena & ofuni.CabeceraPagina(psTit, lnPagina, lnItem, lsNomAge, lsEmpresa, ldFecSis, psMoneda)
                    lscadena = lscadena & ofuni.Encabezado("Item;6;Nro Cuenta;12; ;8;Nombre;25; ;5;Monto;16; ;2;Fecha de Cancelacion;22; ;4;Personeria;16;Usuario;18;Direccion;30; ;10;", lnItem)
                End If
                lnItem = 0
            End If
        
            lsCodCtaAnt = rsAho!cuenta
            rsAho.MoveNext
        Wend
        lscadena = lscadena & Chr(12)
    End If
    
    GetCtaCanAho = lscadena
    
    rsAho.Close
    Set rsAho = Nothing
    Set ofuni = Nothing
    Set ofunc = Nothing
End Function
'By Capi 13082008 se adiciono parametro opcional pbaTasaPactada
Private Function DevQryCan(psCodProd As String, dFecIni As Date, dFecFin As Date, Optional psOrdPag As String = "S", Optional psMoneda As Moneda = gMonedaNacional, Optional ByVal pbaTasaPactada As Boolean = False) As String
    Dim sqlAdd As String
    Dim sqlCodCan As String
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And P.cCtaCod Like '___" & lsAgeCod & "%' "
    End If
    ' MICA 22-Maro-2004
    Select Case psCodProd
        Case Producto.gCapAhorros
            sqlCodCan = "2004%"
        Case Producto.gCapPlazoFijo
            sqlCodCan = "2103%"
        Case Producto.gCapCTS
            sqlCodCan = "2204%"
    End Select
    
    ' Modificacion MICA 22/Marzo/2004
    
    'By Capi 13082008 aqui es la variacion de consulta
    
    If pbaTasaPactada = True Then
        If Producto.gCapPlazoFijo Then
               'Mody By GITU 03-06-2010 Generaba un error
               DevQryCan = " Select Right(H.cMovNro,4) Usu, P.cCtaCod Cuenta, PE.cPersNombre Nombre, PE.cPersDireccDomicilio Direccion, " _
                    & " C.nSaldoDisp Monto, dbo.FechaHoraMov(H.cMovNro) FechaCancel,TasaNominal=CCT.nTasaCambio, CO.cConsDescripcion Tipo" _
                    & " From Producto P " _
                    & " Inner Join ProductoPersona PP On P.cCtaCod = PP.cCtaCod " _
                    & " Inner Join Persona PE On PP.cPersCod  = PE.cPersCod " _
                    & " Inner Join (select MC.cCtaCod, max(M.cMoVnro) cMovNro from MovCap MC inner join Mov m on M.nMovNro=MC.nMovNro " _
                    & " Where MC.cOpeCod like '" & sqlCodCan & "' group by MC.cCtaCod) H on H.cCtaCod=P.cCtaCod " _
                    & " Inner Join Captaciones C On P.cCtaCod = C.cCtaCod " _
                    & " Inner Join CaptacPlazoFijo CPF on CPF.cCtaCod= C.cCtaCod And bTasaPactada=1" _
                    & " Inner Join CapCambioTasa CCT on CCT.cCtaCod= C.cCtaCod And CCT.nTasaAnterior=CCT.nTasaCambio And CCT.cActiva='S'" _
                    & " Inner Join Constante CO On C.nPersoneria = nConsValor And nConsCod = 1002" _
                    & " Where Left(H.cMovNro,8) Between '" & Format(dFecIni, "yyyymmdd") & "' And '" & Format(dFecFin, "yyyymmdd") & "'" _
                    & " And substring(P.cCtaCod,9,1) = '" & psMoneda & "'" _
                    & " And Left(P.nPrdEstado,2) In ('" & Left(CaptacEstado.gCapEstCancelada, 2) & "') " & sqlAdd & " Order By P.cCtaCod"
                    
'                    & " Case C.nPersoneria When 1 then 'PERSONA NATURAL' When 2 then 'PERSONA JURIDICA SIN FINES DE LUCRO' "
'                    & " When 3 then 'PERSONA JURIDICA CON FINES DE LUCRO' When 4 then 'CMAC' When 5 then 'CRAC' "
'                    & " When 6 then 'COOPERATIVA' When 7 then 'EDPYME' End  Tipo "

         End If
    Else
    
    Select Case psCodProd
        Case Producto.gCapAhorros
            
            DevQryCan = "Select Right(H.cMovNro,4) Usu, P.cCtaCod Cuenta, PE.cPersNombre Nombre, PE.cPersDireccDomicilio Direccion, " _
                        & " C.nSaldoDisp Monto, dbo.FechaHoraMov(H.cMovNro) FechaCancel, CO.cConsDescripcion Tipo" _
                        & " From Producto P " _
                        & " Inner Join ProductoPersona PP On P.cCtaCod = PP.cCtaCod " _
                        & " Inner Join Persona PE On PP.cPersCod  = PE.cPersCod " _
                        & " Inner Join (select MC.cCtaCod, max(M.cMoVnro) cMovNro from MovCap MC inner join Mov m on M.nMovNro=MC.nMovNro " _
                        & " Where MC.cOpeCod like '" & sqlCodCan & "' group by MC.cCtaCod) H on H.cCtaCod=P.cCtaCod " _
                        & " Inner Join CaptacAhorros CA On P.cCtaCod = CA.cCtaCod " _
                        & " Inner Join Captaciones C On P.cCtaCod = C.cCtaCod " _
                        & " Inner Join Constante CO On C.nPersoneria = nConsValor And nConsCod = 1002" _
                        & " Where  Left(H.cMovNro,8) Between '" & Format(dFecIni, "yyyymmdd") & "' And  '" & Format(dFecFin, "yyyymmdd") & "'" _
                        & " And CA.bOrdPag = " & psOrdPag & " And substring(P.cCtaCod,9,1) = '" & psMoneda & "'" _
                        & " And Left(P.nPrdEstado,2) In ('" & Left(CaptacEstado.gCapEstCancelada, 2) & "') " & sqlAdd & " Order By P.cCtaCod "

'            & " Case C.nPersoneria When 1 then 'PERSONA NATURAL' When 2 then 'PERSONA JURIDICA SIN FINES DE LUCRO' "
'            & " When 3 then 'PERSONA JURIDICA CON FINES DE LUCRO' When 4 then 'CMAC' When 5 then 'CRAC' "
'            & " When 6 then 'COOPERATIVA' When 7 then 'EDPYME' End  Tipo "
                      
        Case Producto.gCapPlazoFijo
            'DevQryCan = " Select  Right(CAP.cUltimaActualizacion,4) Usu, PR.cCtaCod Cuenta, PE.cPersNombre Nombre, CAP.nSaldoDisp Monto," _
                      & " " _
                      & " " _
                      & " " _
                      & " " _
                      & " " _
                      & " " _
                      & " " _
                      & " dbo.FechaHoraMov(CAP.cUltimaActualizacion) FechaCancel," _
                      & " Case CAP.nPersoneria" _
                      & " When " & PersPersoneria.gPersonaNat & " then 'PERSONA NATURAL'" _
                      & " When " & PersPersoneria.gPersonaJurSFL & " then 'PERSONA JURIDICA SIN FINES DE LUCRO'" _
                      & " When " & PersPersoneria.gPersonaJurCFL & " then 'PERSONA JURIDICA CON FINES DE LUCRO'" _
                      & " When " & PersPersoneria.gPersonaJurCFLCMAC & " then 'CMAC'" _
                      & " When " & PersPersoneria.gPersonaJurCFLCRAC & " then 'CRAC'" _
                      & " When " & PersPersoneria.gPersonaJurSFLFoncodes & " then 'FONCODES' " _
                      & " End  Tipo" _
                      & " From Producto PR" _
                      & " Inner Join ProductoPersona PP On PR.cCtaCod = PP.cCtaCod" _
                      & " Inner Join Persona PE On PP.cPersCod  = PE.cPersCod" _
                      & " Inner Join Captaciones CAP On PR.cCtaCod = CAP.cCtaCod" _
                      & " Inner Join CaptacPlazoFijo CAPPF On PR.cCtaCod = CAPPF.cCtaCod" _
                      & " Where  CAP.cUltimaActualizacion Between '" & Format(dFecIni, gsFormatoMovFecha) & "' and  '" & Format(DateAdd("d", 1, dFecFin), gsFormatoMovFecha) & "'" _
                      & " And Substring(PR.cCtaCod,9,1) = '" & psMoneda & "'" _
                      & " And Left(PR.nPrdEstado,2) In ('" & Left(CaptacEstado.gCapEstCancelada, 2) & "') " & sqlAdd & " Order By PR.cCtaCod"
        
        
             DevQryCan = " Select Right(H.cMovNro,4) Usu, P.cCtaCod Cuenta, PE.cPersNombre Nombre, PE.cPersDireccDomicilio Direccion, " _
                    & " C.nSaldoDisp Monto, dbo.FechaHoraMov(H.cMovNro) FechaCancel, CO.cConsDescripcion Tipo" _
                    & " From Producto P " _
                    & " Inner Join ProductoPersona PP On P.cCtaCod = PP.cCtaCod " _
                    & " Inner Join Persona PE On PP.cPersCod  = PE.cPersCod " _
                    & " Inner Join (select MC.cCtaCod, max(M.cMoVnro) cMovNro from MovCap MC inner join Mov m on M.nMovNro=MC.nMovNro " _
                    & " Where MC.cOpeCod like '" & sqlCodCan & "' group by MC.cCtaCod) H on H.cCtaCod=P.cCtaCod " _
                    & " Inner Join Captaciones C On P.cCtaCod = C.cCtaCod " _
                    & " Inner Join CaptacPlazoFijo CPF on CPF.cCtaCod= C.cCtaCod " _
                    & " Inner Join Constante CO On C.nPersoneria = nConsValor And nConsCod = 1002" _
                    & " Where Left(H.cMovNro,8) Between '" & Format(dFecIni, "yyyymmdd") & "' And '" & Format(dFecFin, "yyyymmdd") & "'" _
                    & " And substring(P.cCtaCod,9,1) = '" & psMoneda & "'" _
                    & " And Left(P.nPrdEstado,2) In ('" & Left(CaptacEstado.gCapEstCancelada, 2) & "') " & sqlAdd & " Order By P.cCtaCod"
            
'            & " Case C.nPersoneria When 1 then 'PERSONA NATURAL' When 2 then 'PERSONA JURIDICA SIN FINES DE LUCRO' "
'            & " When 3 then 'PERSONA JURIDICA CON FINES DE LUCRO' When 4 then 'CMAC' When 5 then 'CRAC' "
'            & " When 6 then 'COOPERATIVA' When 7 then 'EDPYME' End  Tipo
       Case Producto.gCapCTS
            'DevQryCan = " Select  Right(CAP.cUltimaActualizacion,4) Usu, PR.cCtaCod Cuenta, PE.cPersNombre Nombre, CAP.nSaldoDisp Monto," _
                      & " " _
                      & " " _
                      & " " _
                      & " " _
                      & " " _
                      & " " _
                      & " " _
                      & " dbo.FechaHoraMov(CAP.cUltimaActualizacion) FechaCancel," _
                      & " Case CAP.nPersoneria" _
                      & " When " & PersPersoneria.gPersonaNat & " then 'PERSONA NATURAL'" _
                      & " When " & PersPersoneria.gPersonaJurSFL & " then 'PERSONA JURIDICA SIN FINES DE LUCRO'" _
                      & " When " & PersPersoneria.gPersonaJurCFL & " then 'PERSONA JURIDICA CON FINES DE LUCRO'" _
                      & " When " & PersPersoneria.gPersonaJurCFLCMAC & " then 'CMAC'" _
                      & " When " & PersPersoneria.gPersonaJurCFLCRAC & " then 'CRAC'" _
                      & " When " & PersPersoneria.gPersonaJurSFLFoncodes & " then 'FONCODES' " _
                      & " End  Tipo" _
                      & " From Producto PR" _
                      & " Inner Join ProductoPersona PP On PR.cCtaCod = PP.cCtaCod" _
                      & " Inner Join Persona PE On PP.cPersCod  = PE.cPersCod" _
                      & " Inner Join Captaciones CAP On PR.cCtaCod = CAP.cCtaCod" _
                      & " Inner Join CaptacCTS CAPCTS On PR.cCtaCod = CAPCTS.cCtaCod" _
                      & " Where  CAP.cUltimaActualizacion between '" & Format(dFecIni, gsFormatoMovFecha) & "' and  '" & Format(DateAdd("d", 1, dFecFin), gsFormatoMovFecha) & "'" _
                      & " And Substring(PR.cCtaCod,9,1) = '" & psMoneda & "'" _
                      & " And Left(PR.nPrdEstado,2) In ('" & Left(CaptacEstado.gCapEstCancelada, 2) & "') " & sqlAdd & " Order By PR.cCtaCod"
                      
       DevQryCan = " Select Right(H.cMovNro,4) Usu, P.cCtaCod Cuenta, PE.cPersNombre Nombre, PE.cPersDireccDomicilio Direccion, " _
                    & " C.nSaldoDisp Monto, dbo.FechaHoraMov(H.cMovNro) FechaCancel, CO.cConsDescripcion Tipo" _
                    & " From Producto P " _
                    & " Inner Join ProductoPersona PP On P.cCtaCod = PP.cCtaCod " _
                    & " Inner Join Persona PE On PP.cPersCod  = PE.cPersCod " _
                    & " Inner Join (select MC.cCtaCod, max(M.cMoVnro) cMovNro from MovCap MC inner join Mov m on M.nMovNro=MC.nMovNro " _
                    & " Where MC.cOpeCod like '" & sqlCodCan & "' group by MC.cCtaCod) H on H.cCtaCod=P.cCtaCod " _
                    & " Inner Join Captaciones C On P.cCtaCod = C.cCtaCod " _
                    & " Inner Join CaptacCTS CTS on CTS.cCtaCod= C.cCtaCod " _
                    & "Inner Join Constante CO On C.nPersoneria = nConsValor And nConsCod = 1002" _
                    & " Where Left(H.cMovNro,8) Between '" & Format(dFecIni, "yyyymmdd") & "' And '" & Format(dFecFin, "yyyymmdd") & "'" _
                    & " And substring(P.cCtaCod,9,1) = '" & psMoneda & "'" _
                    & " And Left(P.nPrdEstado,2) In ('" & Left(CaptacEstado.gCapEstCancelada, 2) & "') " & sqlAdd & " Order By P.cCtaCod"
                
'        & " Case C.nPersoneria When 1 then 'PERSONA NATURAL' When 2 then 'PERSONA JURIDICA SIN FINES DE LUCRO' " _
'        & " When 3 then 'PERSONA JURIDICA CON FINES DE LUCRO' When 4 then 'CMAC' When 5 then 'CRAC' " _
'        & " When 6 then 'COOPERATIVA' When 7 then 'EDPYME' End  Tipo " _
'End Gitu
    End Select
    End If
End Function

Private Function CuentasInactivas(pMoneda As String, dFecIni As Date, dFecFin As Date, ByVal gsNomAge As String, ByVal gdFecSis As Date) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim SQL1 As String
    Dim CuentaA As String
    Dim vLineas As Integer
    Dim vPag As Integer
    Dim TDesc As Currency
    Dim RCapital As Currency
    Dim lscad As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim ofunc As New COMFunciones.FCOMCadenas
   Dim ofunfe As New COMFunciones.FCOMFechas
    
    oCon.AbreConexion
    
    sql = " SELECT ISNULL(CANT.cCtaCodAnt,'') cCtaCodAnt, CAPAHO.cCtaCod cCodCta, MC.nSaldoDisponible nSaldDispAC, CAPAHO.nSaldoAnterior nSaldAntAC, MC.nMonto nMonTran, CAPAHO.dUltContacto dUltCntAC" _
        & " FROM CaptacAhorros CAPAHO" _
        & " Inner Join MovCap MC On CAPAHO.cCtaCod = MC.cCtaCod" _
        & " Inner Join Mov M On MC.nMovNro = M.nMovNro" _
        & " Left  Join CaptacCtaAntRel CANT On  CAPAHO.cCtaCod = CANT.cCtaCod" _
        & " WHERE MC.cOpeCod in ('" & gAhoCancInact & "','" & gAhoEstActInac & "') And Substring(CAPAHO.cCtaCod,9,1) = '" & pMoneda & "'" _
        & " And M.nMovFlag <> " & gMovFlagExtornado & "" _
        & " And M.cMovNro Between '" & Format(dFecIni, "YYYYMMDD") & "' and  '" & Format(DateAdd("d", 1, dFecFin), "YYYYMMDD") & "'"
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
     vPag = 1
     lscad = lscad & Chr(10)
     lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & "Maynas " + ofunfe.ArmaFecha(gdFecSis) & Space(4) & "Pagina: " + Format(vPag, "####") + Chr(10) + Chr(10)
     lscad = lscad & Space(20) & "LISTADO DE CUENTAS INACTIVAS EN " + IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
     lscad = lscad & "CUENTA " & Space(5) & "CUENTAANT" & Space(5) & "S.ANTERIOR" & Space(5) & "S.DISPONIBLE" & Space(3) & "R.CAPITAL" & Space(2) & "F.ULTCONTACTO" & Space(5) + Chr(10)
     lscad = lscad & String(90, "=") + Chr(10)
     Do While Not rs.EOF
        CuentaA = rs!CctacodAnt
        RCapital = Abs(rs!nMonto)
        lscad = lscad & rs!cCodCta & Space(2) + CuentaA & ofunc.JDNum(rs!nsaldantac, 13, True, 11, 2) & Space(2)
        lscad = lscad & ofunc.JDNum(rs!nSaldDispAC, 13, True, 11, 2) & Space(4) & ofunc.JDNum(Str(RCapital), 6, True, 4, 2) & Space(8) & Format(rs!dUltcntAC, ofunf.gsFormatoFechaView) + Chr(10)
        TDesc = TDesc + RCapital
        rs.MoveNext
        vLineas = vLineas + 1
        If vLineas > 52 Then
            vPag = vPag + 1
            lscad = lscad & Chr(10) & "Resumen :" & Space(38) & ofunc.JDNum(Str(TDesc), 13, True, 11, 2) + Chr(10)
            lscad = lscad & Chr(12)
            lscad = lscad & Chr(10)
            lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & "Maynas " + ofunfe.ArmaFecha(gdFecSis) & Space(4) & "Pagina: " + Format(vPag, "####") + Chr(10) + Chr(10)
            lscad = lscad & Space(20) & "LISTADO DE CUENTAS INACTIVAS EN " + IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
            lscad = lscad & "CUENTA " & Space(5) & "CUENTAANT" & Space(5) & "S.ANTERIOR" & Space(5) & "S.DISPONIBLE" & Space(3) & "R.CAPITAL" & Space(2) & "F.ULTCONTACTO" & Space(5) + Chr(10)
            lscad = lscad & String(90, "=") + Chr(10)
            vLineas = 1
        End If
     Loop
       lscad = lscad & Chr(10) & "Total Resumen :" & Space(32) & ofunc.JDNum(Str(TDesc), 13, True, 11, 2) + Chr(10)
    End If
    rs.Close
    Set rs = Nothing
    CuentasInactivas = IIf(lscad <> "", lscad & Chr(12), "")
    Set ofunc = Nothing
End Function


Private Function CuentasInmobilizadas(pMoneda As String, dFecIni As Date, dFecFin As Date, ByVal gsNomAge As String, ByVal gdFecSis As Date) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim SQL1 As String
    Dim CuentaA As String
    Dim vLineas As Integer
    Dim vPag As Integer
    Dim TDesc As Currency
    Dim RCapital As Currency
    Dim lscad As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofunfe As New COMFunciones.FCOMCadenas
    
    oCon.AbreConexion
    
    sql = " Select MC.cCtaCod, PRD.nSaldo, 0 Interes, dbo.FechaMov(M.cMovNro) FFin, " _
        & " (Select dbo.FechaMov(Max(MA.cMovNro)) From Mov MA" _
        & " Inner Join MovCap MCA On MA.nMovNro = MCA.nMovNro" _
        & " Where MA.cOpeCod = '200803' And MA.nMovFlag = " & MovFlag.gMovFlagVigente & " And MCA.cCtaCod = MC.cCtaCod) FIni" _
        & " From Mov M" _
        & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
        & " Inner Join Producto PRD On PRD.cCtaCod = MC.cCtaCod" _
        & " Where M.cOpeCod = '200406'" _
        & " And Left(M.cMovNro,8) Between '" & Format(dFecIni, "YYYYMMDD") & "' and  '" & Format(DateAdd("d", 1, dFecFin), "YYYYMMDD") & "' And M.nMovFlag = " & MovFlag.gMovFlagVigente & "" _
        & " And Substring(MC.cCtaCod,9,1) = '" & pMoneda & "'"

    If Not (rs.EOF And rs.BOF) Then
     vPag = 1
     lscad = lscad & Chr(10)
     lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & "Maynas " + ofunfe.ArmaFecha(gdFecSis) & Space(4) & "Pagina: " + Format(vPag, "####") + Chr(10) + Chr(10)
     lscad = lscad & Space(20) & "LISTADO DE CUENTAS INACTIVAS EN " + IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
     lscad = lscad & "CUENTA " & Space(5) & "CUENTAANT" & Space(5) & "S.ANTERIOR" & Space(5) & "S.DISPONIBLE" & Space(3) & "R.CAPITAL" & Space(2) & "F.ULTCONTACTO" & Space(5) + Chr(10)
     lscad = lscad & String(90, "=") + Chr(10)
     Do While Not rs.EOF
        CuentaA = rs!CctacodAnt
        RCapital = Abs(rs!nMonto)
        lscad = lscad & rs!cCodCta & Space(2) + CuentaA & ofunc.JDNum(rs!nsaldantac, 13, True, 11, 2) & Space(2)
        lscad = lscad & ofunc.JDNum(rs!nSaldDispAC, 13, True, 11, 2) & Space(4) & ofunc.JDNum(Str(RCapital), 6, True, 4, 2) & Space(8) & Format(rs!dUltcntAC, ofunf.gsFormatoFechaView) + Chr(10)
        TDesc = TDesc + RCapital
        rs.MoveNext
        vLineas = vLineas + 1
        If vLineas > 52 Then
            vPag = vPag + 1
            lscad = lscad & Chr(10) & "Resumen :" & Space(38) & ofunc.JDNum(Str(TDesc), 13, True, 11, 2) + Chr(10)
            lscad = lscad & Chr(12)
            lscad = lscad & Chr(10)
            lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & "Maynas " + ofunfe.ArmaFecha(gdFecSis) & Space(4) & "Pagina: " + Format(vPag, "####") + Chr(10) + Chr(10)
            lscad = lscad & Space(20) & "LISTADO DE CUENTAS INACTIVAS EN " + IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
            lscad = lscad & "CUENTA " & Space(5) & "CUENTAANT" & Space(5) & "S.ANTERIOR" & Space(5) & "S.DISPONIBLE" & Space(3) & "R.CAPITAL" & Space(2) & "F.ULTCONTACTO" & Space(5) + Chr(10)
            lscad = lscad & String(90, "=") + Chr(10)
            vLineas = 1
        End If
     Loop
       lscad = lscad & Chr(10) & "Total Resumen :" & Space(32) & ofunc.JDNum(Str(TDesc), 13, True, 11, 2) + Chr(10)
    End If
    rs.Close
    Set rs = Nothing
    CuentasInmobilizadas = IIf(lscad <> "", lscad & Chr(12), "")
    Set ofunc = Nothing
End Function



Public Function GetOpeGrupoRep(Optional pnGrupoCtaMov As CuentasMovidas = gCtasMovAhoApeCheque, Optional pnGrupoEstados As Integer = 0, Optional pbCuentasMovidas As Boolean = True) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lscadena As String
    
    If pbCuentasMovidas Then
         sql = " Select cOpeCod From OpeTpoGrupo where nGrupoCtaMov = " & pnGrupoCtaMov
    Else
        sql = " Select cOpeCod From OpeTpoGrupo where nGrupoApeCanCtas = " & pnGrupoEstados
    End If
    
    oCon.AbreConexion
    
    Set rs = oCon.CargaRecordSet(sql)
    lscadena = ""
    
    If rs.EOF And rs.BOF Then
        GetOpeGrupoRep = ""
    Else
        While Not rs.EOF
            If lscadena = "" Then
                lscadena = rs.Fields(0)
            Else
                lscadena = lscadena & "','" & rs.Fields(0)
            End If
            
            rs.MoveNext
        Wend
    End If
    
    rs.Close
    oCon.CierraConexion
    GetOpeGrupoRep = lscadena
End Function

Public Function ImprimeRepGiros(ByVal dInicio As Date, ByVal dFin As Date, _
        ByVal sConvenio As String, ByVal sTitulo As String, Optional pbCancelacion As Boolean = False, Optional psAgeCod As String = "", Optional pnEstadoGiro As Integer = 1) As String
        'EJVG 20110722 se agregó pnEstadoGiro
    Dim rsMov As ADODB.Recordset
    Dim nTotMonto As Double, nTotComision As Double
    Dim nCarLin As Integer
    Dim sTitRp1 As String
    Dim sTitRp2 As String
    Dim sMoneda As String, sNumPag As String, sFchtra As String
    Dim nLinPag As Integer, nCntPag As Integer
    Dim sFecha As String * 10
    Dim sFechaC As String * 10
    Dim sCuenta As String * 18
    Dim sRemitente As String * 35, sDestinatario As String * 35
    Dim sAgencia As String * 17
    Dim sUser As String * 10
    Dim sUserCobra As String * 10 'EJVG 20110723
    Dim nItem As Integer
    Dim sCad As String, sCuentaAux As String, sItem As String * 4
    Dim sMonto As String * 12, sComision As String * 12
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim i As Moneda
    Dim sql As String
    Dim lsOpeCodGiro As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    If Not pbCancelacion Then
        lsOpeCodGiro = "310[12]"
    Else
        lsOpeCodGiro = "310[3]"
    End If
    
    If Not oCon.AbreConexion Then
        ImprimeRepGiros = "No Existe una conexion activa con la Agencia Principal"
        Exit Function
    End If
    
    Set rsMov = New ADODB.Recordset
    rsMov.CursorLocation = adUseClient
    sCad = ""
    For i = Moneda.gMonedaNacional To Moneda.gMonedaExtranjera
        nTotMonto = 0
        nTotComision = 0
        
        'AGREGÓ JIPR20190314 INICIO
        sql = "exec stp_sel_280301ReporteDiarioGiros '" & Format(dInicio, "yyyymmdd") & "','" & Format(dFin, "yyyymmdd") & "'," & pnEstadoGiro & ",'" & psAgeCod & "','" & pbCancelacion & "'," & i 'JIPR20190601 ," & i
        'AGREGÓ JIPR20190314 FIN
        
        If rsMov.State = adStateOpen Then rsMov.Close
        
        Set rsMov = oCon.CargaRecordSet(sql)
        Set rsMov.ActiveConnection = Nothing
        
        If Not (rsMov.EOF And rsMov.BOF) Then
            sNumPag = ""
            nLinPag = 0
            nCarLin = 190
            sTitRp1 = sTitulo
            sTitRp2 = "DEL " & Format$(dInicio, ofunf.gsFormatoFechaView) & " AL " & Format$(dFin, ofunf.gsFormatoFechaView)
            nCntPag = 1
            nItem = 0
            sMoneda = IIf(i = 1, "SOLES", "DOLARES")
            sNumPag = ofunc.FillNum(Trim(Str(nCntPag)), 4, " ")
            If sCad <> "" Then sCad = sCad & Chr(12)
            sCad = sCad & CabeRepo("", "", nCarLin, "SECCION AHORROS", sTitRp1, sTitRp2, sMoneda, sNumPag) & Chr(10)
            sCad = sCad & String(nCarLin, "=") & Chr(10)
            sCad = sCad & "ITEM FECHA            CODIGO              REMITENTE                            DESTINATARIO                         MONTO     COMISION      AGE.DEST.      USR - AGE  F.COBRO   USR-AGE COBRA" & Chr(10) 'EJVG 20110723 add USR-AGE COBRA
            sCad = sCad & String(nCarLin, "=") & Chr(10)
            nLinPag = 8
            
            sCuentaAux = ""
            Do While Not rsMov.EOF
                If sCuentaAux <> rsMov("cCtaCod") Then
                    nItem = nItem + 1
                    RSet sItem = Trim(nItem)
                    sFecha = Format$(rsMov("dVigencia"), ofunf.gsFormatoFechaView)
                    sCuenta = rsMov("cCtaCod")
                    sRemitente = ofunc.PstaNombre(rsMov("cRemitente"), False)
                    RSet sMonto = Format$(rsMov("nMonto"), "#,##0.00")
                    RSet sComision = Format$(rsMov("nComision"), "#,##0.00")
                    sAgencia = rsMov("cAgencia")
                    sUser = rsMov("cUser")
                    sFechaC = Format$(rsMov("dCancela"), ofunf.gsFormatoFechaView)
                    sUserCobra = rsMov("cUserCobra") 'EJVG 20110723
                Else
                    sItem = ""
                    sFecha = ""
                    sCuenta = ""
                    sRemitente = ""
                    sMonto = ""
                    sComision = ""
                    sAgencia = ""
                    gsCodAge = ""
                    sUser = ""
                    sFechaC = ""
                    sUserCobra = ""
                End If
                sCuentaAux = rsMov("cCtaCod")
                sDestinatario = IIf(rsMov("cCodDest") = "", rsMov("cDestinatario"), ofunc.PstaNombre(rsMov("cDestinatario"), False))
                If nLinPag > 58 Then
                    sCad = sCad & Chr(12)
                    nCntPag = nCntPag + 1
                    sNumPag = ofunc.FillNum(Trim(Str(nCntPag)), 4, " ")
                    sCad = sCad & CabeRepo("", "", nCarLin, "SECCION AHORROS", sTitRp1, sTitRp2, sMoneda, sNumPag) & Chr(10)
                    sCad = sCad & String(nCarLin, "=") & Chr(10)
                    sCad = sCad & "ITEM FECHA            CODIGO              REMITENTE                            DESTINATARIO                         MONTO     COMISION      AGE.DEST.      USR - AGE  F.COBRO   USR-AGE COBRA" & Chr(10)
                    sCad = sCad & String(nCarLin, "=") & Chr(10)
                    nLinPag = 8
                End If
                sCad = sCad & sItem & " " & sFecha & " " & sCuenta & " " & sRemitente & "  " & sDestinatario & "  " & sMonto & " " & sComision & "  " & sAgencia & "  " & sUser & " " & sFechaC & "  " & sUserCobra & Chr(10)
                nLinPag = nLinPag + 1
                nTotMonto = nTotMonto + rsMov("nMonto")
                nTotComision = nTotComision + rsMov("nComision")
                rsMov.MoveNext
            Loop
            RSet sMonto = Format$(nTotMonto, "#,##0.00")
            RSet sComision = Format$(nTotComision, "#,##0.00")
            sCad = sCad & String(nCarLin, "-") & Chr(10)
            sCad = sCad & String(115, " ") & "TOTAL  " & sMonto & " " & sComision & Chr(10)
            sCad = sCad & String(nCarLin, "-") & Chr(10)
        Else
            sCad = sCad & ""
        End If
    Next i
    rsMov.Close
    Set rsMov = Nothing
    ImprimeRepGiros = sCad
    Set ofunc = Nothing
End Function
Private Function TransCTSLey28461(ByVal pMoneda As String, Optional ByVal pCodAge As String = "", Optional ByVal dFecIni As Date = "01/01/1900", Optional ByVal dFecFin As Date = "01/01/1900") As String
 Dim rsMov As ADODB.Recordset
    Dim nCarLin As Integer
    Dim sTitRp1 As String
    Dim sTitRp2 As String
    Dim sMoneda As String, sNumPag As String, sFchtra As String
    Dim nLinPag As Integer, nCntPag As Integer
    Dim sFecha As String * 10
    Dim sTotMonto As String * 12, sTotDisp As String * 12, sTotInta As String * 12
    Dim sPorDisp As String * 12, sPorInta As String * 12
    Dim sCuenta As String * 18
    Dim sCliente As String * 30
    Dim sAgencia As String * 22
    Dim nItem As Integer
    Dim sCad As String, sCuentaAux As String, sItem As String * 4
    Dim sMonto As String * 12, sComision As String * 12
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim i As Moneda
    Dim sql As String
    Dim lsOpeCod As String, sqlaux As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    lsOpeCod = "220303"
    
    sqlaux = ""
    
    If dFecIni <> "01/01/1900" And dFecFin <> "01/01/1900" Then
            sqlaux = " and left(m.cmovnro,8)>='" & Format(dFecIni, "yyyymmdd") & "' and left(m.cmovnro,8)<='" & Format(dFecFin, "yyyymmdd") & "'"
    End If
    
    If Trim(pCodAge) <> "" Then
            sqlaux = sqlaux & " and substring(mc.cctacod,4,2)='" & pCodAge & "'"
    End If
    
    
    If Not oCon.AbreConexion Then
        TransCTSLey28461 = "No Existe una conexion activa con la Agencia Principal"
        Exit Function
    End If
    
    Set rsMov = New ADODB.Recordset
    rsMov.CursorLocation = adUseClient
    sCad = ""
    
        nTotMonto = 0
        
         sql = " SELECT MC.NMOVNRO,MC.CCTACOD,P.CPERSNOMBRE,FECHA=CAST( LEFT(M.CMOVNRO,8) AS DATETIME), "
         sql = sql & "  TOTAL=MC.NMONTO,A.CAGEDESCRIPCION, "
         sql = sql & " DISPONIBLE=MC.NMONTO-(SELECT MD.NMONTO FROM MOVCAPDET MD WHERE MD.NMOVNRO=MC.NMOVNRO AND MD.NCONCEPTOCOD=30), "
         sql = sql & " INTANGIBLE=(SELECT MD.NMONTO FROM MOVCAPDET MD WHERE MD.NMOVNRO=MC.NMOVNRO AND MD.NCONCEPTOCOD=30), "
         sql = sql & " PORDISPONIBLE=(SELECT Mp.nporcentajedisp FROM MOVparamcts Mp WHERE Mp.NMOVNRO=MC.NMOVNRO) , "
         sql = sql & " PORINTANGIBLE=(SELECT mp.nporcentajeinta FROM MOVparamcts Mp WHERE Mp.NMOVNRO=MC.NMOVNRO) "
         sql = sql & " FROM MOV M "
         sql = sql & " JOIN MOVCAP MC ON MC.NMOVNRO=M.NMOVNRO "
         sql = sql & " JOIN PRODUCTOPERSONA PP ON PP.CCTACOD=MC.CCTACOD "
         sql = sql & " JOIN AGENCIAs A ON A.cAGEcod=SUBSTRING(MC.CCTACOD,4,2) "
         sql = sql & " JOIN PERSONA P ON P.CPERSCOD=PP.CPERSCOD "
         sql = sql & " WHERE MC.COPECOD='220303' AND SUBSTRING(MC.CCTACOD,9,1)='" & pMoneda & "' AND M.NMOVFLAG=0 " & sqlaux
         sql = sql & " order by LEFT(M.CMOVNRO,8),mc.cctacod "
        
        
        If rsMov.State = adStateOpen Then rsMov.Close
        
        Set rsMov = oCon.CargaRecordSet(sql)
        Set rsMov.ActiveConnection = Nothing
        sAgencia = ""
        
        
        
        If Not (rsMov.EOF And rsMov.BOF) Then
            sNumPag = ""
            nLinPag = 0
            sAgencia = rsMov("cAgeDescripcion")
            nCarLin = 145
            sTitRp1 = "REPORTE DE TRANSACCIONES CTS - RETIRO LEY 28461 "
            sTitRp2 = "DEL " & Format$(dFecIni, ofunf.gsFormatoFechaView) & " AL " & Format$(dFecFin, ofunf.gsFormatoFechaView)
            nCntPag = 1
            nItem = 0
            sMoneda = IIf(pMoneda = 1, "SOLES", "DOLARES")
            sNumPag = ofunc.FillNum(Trim(Str(nCntPag)), 4, " ")
            If sCad <> "" Then sCad = sCad & Chr(12)
            sCad = sCad & CabeRepo("", "", nCarLin, "SECCION AHORROS", sTitRp1 & " " & sAgencia, sTitRp2, sMoneda, sNumPag) & Chr(10)
            sCad = sCad & String(nCarLin, "=") & Chr(10)
            sCad = sCad & "ITEM  CUENTA               CLIENTE                         FECHA      MONTO TOTAL  MONTO DISP.  MONTO INT.   DISP.(%)  INTA.(%) " & Chr(10)
            sCad = sCad & String(nCarLin, "=") & Chr(10)
            nLinPag = 7
            sCuentaAux = ""
            
            
            Do While Not rsMov.EOF
                If sCuentaAux <> rsMov("cCtaCod") Then
                    nItem = nItem + 1
                    RSet sItem = Trim(nItem)
                    sCuenta = rsMov("cCtaCod")
                    sCliente = rsMov("cPersnombre")
                    sFecha = Format$(rsMov("Fecha"), ofunf.gsFormatoFechaView)
                    sTotMonto = rsMov("Total")
                    sTotDisp = rsMov("Disponible")
                    sTotInta = rsMov("Intangible")
                    sPorDisp = rsMov("PorDisponible")
                    sPorInta = rsMov("PorIntangible")
                    'sAgencia = rsMov("cAgeDescripcion")
                    
                Else
                    sItem = ""
                    sCuenta = ""
                    sCliente = ""
                    sFecha = ""
                    sTotMonto = ""
                    sTotDisp = ""
                    sTotInta = ""
                    sPorDisp = ""
                    sPorInta = ""
                End If
                sCuentaAux = rsMov("cCtaCod")
                'sDestinatario = IIf(rsMov("cCodDest") = "", rsMov("cDestinatario"), PstaNombre(rsMov("cDestinatario"), False))
                If nLinPag > 58 Or Trim(sAgencia) <> Trim(rsMov("cAgeDescripcion")) Then
                    If Trim(sAgencia) <> Trim(rsMov("cAgeDescripcion")) Then
                        nItem = 1
                        sItem = "   1"
                    End If
                    
                    sCad = sCad & Chr(12)
                    nCntPag = nCntPag + 1
                    sNumPag = ofunc.FillNum(Trim(Str(nCntPag)), 4, " ")
                    sCad = sCad & CabeRepo("", "", nCarLin, "SECCION AHORROS", sTitRp1 & " " & rsMov("cAgedescripcion"), sTitRp2, sMoneda, sNumPag) & Chr(10)
                    sCad = sCad & String(nCarLin, "=") & Chr(10)
                    sCad = sCad & "ITEM  CUENTA               CLIENTE                         FECHA      MONTO TOTAL  MONTO DISP.  MONTO INT.   DISP.(%)  INTA.(%) " & Chr(10)
                    sCad = sCad & String(nCarLin, "=") & Chr(10)
                    nLinPag = 7
                    
                End If
                'sCad = sCad & sItem & " " & sFecha & " " & sCuenta & " " & sRemitente & "  " & sDestinatario & "  " & sMonto & " " & sComision & "  " & sAgencia & Chr(10)
                sCad = sCad & sItem & " " & sCuenta & " " & sCliente & "     " & sFecha & " " & sTotMonto & " " & sTotDisp & " " & sTotInta & " " & sPorDisp & " " & sPorInta & Chr(10)
                nLinPag = nLinPag + 1
                'nTotMonto = nTotMonto + rsMov("nMonto")
                sAgencia = rsMov("cAgeDescripcion")
                
                rsMov.MoveNext
            Loop
            'RSet sMonto = Format$(nTotMonto, "#,##0.00")
            sCad = sCad & String(nCarLin, "-") & Chr(10)
            'sCad = sCad & String(96, " ") & "TOTAL  " & sMonto & "  " & sComision & Chr(10)
            'sCad = sCad & String(nCarLin, "-") & Chr(10)
        Else
            sCad = sCad & ""
        End If
    
    rsMov.Close
    Set rsMov = Nothing
    TransCTSLey28461 = sCad
    Set ofuni = Nothing

End Function

Private Function TransCTSDetalle(ByVal psCtaCod As String, Optional ByVal dFecIni As Date = "01/01/1900", Optional ByVal dFecFin As Date = "01/01/1900") As String
 Dim rsMov As ADODB.Recordset
    Dim nCarLin As Integer
    Dim sTitRp1 As String
    Dim sTitRp2 As String
    Dim sMoneda As String, sNumPag As String, sFchtra As String
    Dim nLinPag As Integer, nCntPag As Integer
    Dim sFecha As String * 10
    Dim sTotMonto As String * 12, sTotDisp As String * 12, sTotInta As String * 12
    Dim sPorDisp As String * 12, sPorInta As String * 12
    Dim sCuenta As String * 18
    Dim sCliente As String * 30
    Dim sAgencia As String * 22
    Dim nItem As Integer
    Dim sCad As String, sCuentaAux As String, sItem As String * 4
    Dim sMonto As String * 12, sComision As String * 12
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim i As Moneda
    Dim sql As String
    Dim lsOpeCod As String, sqlaux As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    
    lsOpeCod = "220303"
    
    sqlaux = ""
    
    If dFecIni <> "01/01/1900" And dFecFin <> "01/01/1900" Then
            sqlaux = " and left(m.cmovnro,8)>='" & Format(dFecIni, "yyyymmdd") & "' and left(m.cmovnro,8)<='" & Format(dFecFin, "yyyymmdd") & "'"
    End If
    
    If Trim(pCodAge) <> "" Then
            sqlaux = sqlaux & " and substring(mc.cctacod,4,2)='" & pCodAge & "'"
    End If
    
    
    If Not oCon.AbreConexion Then
        TransCTSDetalle = "No Existe una conexion activa con la Agencia Principal"
        Exit Function
    End If
    
    Set rsMov = New ADODB.Recordset
    rsMov.CursorLocation = adUseClient
    sCad = ""
    
        nTotMonto = 0
        
         sql = " SELECT MC.NMOVNRO,MC.CCTACOD,P.CPERSNOMBRE,FECHA=CAST( LEFT(M.CMOVNRO,8) AS DATETIME), "
         sql = sql & "  TOTAL=MC.NMONTO,A.CAGEDESCRIPCION, "
         sql = sql & " DISPONIBLE=MC.NMONTO-(SELECT MD.NMONTO FROM MOVCAPDET MD WHERE MD.NMOVNRO=MC.NMOVNRO AND MD.NCONCEPTOCOD=30), "
         sql = sql & " INTANGIBLE=(SELECT MD.NMONTO FROM MOVCAPDET MD WHERE MD.NMOVNRO=MC.NMOVNRO AND MD.NCONCEPTOCOD=30), "
         sql = sql & " PORDISPONIBLE=(SELECT Mp.nporcentajedisp FROM MOVparamcts Mp WHERE Mp.NMOVNRO=MC.NMOVNRO) , "
         sql = sql & " PORINTANGIBLE=(SELECT mp.nporcentajeinta FROM MOVparamcts Mp WHERE Mp.NMOVNRO=MC.NMOVNRO) "
         sql = sql & " FROM MOV M "
         sql = sql & " JOIN MOVCAP MC ON MC.NMOVNRO=M.NMOVNRO "
         sql = sql & " JOIN PRODUCTOPERSONA PP ON PP.CCTACOD=MC.CCTACOD "
         sql = sql & " JOIN AGENCIAs A ON A.cAGEcod=SUBSTRING(MC.CCTACOD,4,2) "
         sql = sql & " JOIN PERSONA P ON P.CPERSCOD=PP.CPERSCOD "
         sql = sql & " WHERE MC.COPECOD='220303' AND SUBSTRING(MC.CCTACOD,9,1)='" & pMoneda & "' AND M.NMOVFLAG=0 " & sqlaux
         sql = sql & " order by LEFT(M.CMOVNRO,8),mc.cctacod "
        
        
        If rsMov.State = adStateOpen Then rsMov.Close
        
        Set rsMov = oCon.CargaRecordSet(sql)
        Set rsMov.ActiveConnection = Nothing
        sAgencia = ""
        
        
        
        If Not (rsMov.EOF And rsMov.BOF) Then
            sNumPag = ""
            nLinPag = 0
            sAgencia = rsMov("cAgeDescripcion")
            nCarLin = 145
            sTitRp1 = "REPORTE DE TRANSACCIONES CTS - RETIRO LEY 28461 "
            sTitRp2 = "DEL " & Format$(dFecIni, ofunf.gsFormatoFechaView) & " AL " & Format$(dFecFin, ofunf.gsFormatoFechaView)
            nCntPag = 1
            nItem = 0
            sMoneda = IIf(pMoneda = 1, "SOLES", "DOLARES")
            sNumPag = ofunc.FillNum(Trim(Str(nCntPag)), 4, " ")
            If sCad <> "" Then sCad = sCad & Chr(12)
            sCad = sCad & CabeRepo("", "", nCarLin, "SECCION AHORROS", sTitRp1 & " " & sAgencia, sTitRp2, sMoneda, sNumPag) & Chr(10)
            sCad = sCad & String(nCarLin, "=") & Chr(10)
            sCad = sCad & "ITEM  CUENTA               CLIENTE                         FECHA      MONTO TOTAL  MONTO DISP.  MONTO INT.   DISP.(%)  INTA.(%) " & Chr(10)
            sCad = sCad & String(nCarLin, "=") & Chr(10)
            nLinPag = 7
            sCuentaAux = ""
            
            
            Do While Not rsMov.EOF
                If sCuentaAux <> rsMov("cCtaCod") Then
                    nItem = nItem + 1
                    RSet sItem = Trim(nItem)
                    sCuenta = rsMov("cCtaCod")
                    sCliente = rsMov("cPersnombre")
                    sFecha = Format$(rsMov("Fecha"), ofunf.gsFormatoFechaView)
                    sTotMonto = rsMov("Total")
                    sTotDisp = rsMov("Disponible")
                    sTotInta = rsMov("Intangible")
                    sPorDisp = rsMov("PorDisponible")
                    sPorInta = rsMov("PorIntangible")
                    'sAgencia = rsMov("cAgeDescripcion")
                    
                Else
                    sItem = ""
                    sCuenta = ""
                    sCliente = ""
                    sFecha = ""
                    sTotMonto = ""
                    sTotDisp = ""
                    sTotInta = ""
                    sPorDisp = ""
                    sPorInta = ""
                End If
                sCuentaAux = rsMov("cCtaCod")
                'sDestinatario = IIf(rsMov("cCodDest") = "", rsMov("cDestinatario"), oFunC.pstanombre(rsMov("cDestinatario"), False))
                If nLinPag > 58 Or Trim(sAgencia) <> Trim(rsMov("cAgeDescripcion")) Then
                    If Trim(sAgencia) <> Trim(rsMov("cAgeDescripcion")) Then
                        nItem = 1
                        sItem = "   1"
                    End If
                    
                    sCad = sCad & Chr(12)
                    nCntPag = nCntPag + 1
                    sNumPag = ofunc.FillNum(Trim(Str(nCntPag)), 4, " ")
                    sCad = sCad & CabeRepo("", "", nCarLin, "SECCION AHORROS", sTitRp1 & " " & rsMov("cAgedescripcion"), sTitRp2, sMoneda, sNumPag) & Chr(10)
                    sCad = sCad & String(nCarLin, "=") & Chr(10)
                    sCad = sCad & "ITEM  CUENTA               CLIENTE                         FECHA      MONTO TOTAL  MONTO DISP.  MONTO INT.   DISP.(%)  INTA.(%) " & Chr(10)
                    sCad = sCad & String(nCarLin, "=") & Chr(10)
                    nLinPag = 7
                    
                End If
                'sCad = sCad & sItem & " " & sFecha & " " & sCuenta & " " & sRemitente & "  " & sDestinatario & "  " & sMonto & " " & sComision & "  " & sAgencia & Chr(10)
                sCad = sCad & sItem & " " & sCuenta & " " & sCliente & "     " & sFecha & " " & sTotMonto & " " & sTotDisp & " " & sTotInta & " " & sPorDisp & " " & sPorInta & Chr(10)
                nLinPag = nLinPag + 1
                'nTotMonto = nTotMonto + rsMov("nMonto")
                sAgencia = rsMov("cAgeDescripcion")
                
                rsMov.MoveNext
            Loop
            'RSet sMonto = Format$(nTotMonto, "#,##0.00")
            sCad = sCad & String(nCarLin, "-") & Chr(10)
            'sCad = sCad & String(96, " ") & "TOTAL  " & sMonto & "  " & sComision & Chr(10)
            'sCad = sCad & String(nCarLin, "-") & Chr(10)
        Else
            sCad = sCad & ""
        End If
    
    rsMov.Close
    Set rsMov = Nothing
    TransCTSDetalle = sCad
    Set ofuni = Nothing

End Function




Private Function PlazosFijoCancelayMontos(pMoneda As String, dFecIni As Date, dFecFin As Date, pnMontoIni As Currency, pnMontoFin As Currency, ByVal gsNomAge As String, ByVal gdFecSis As Date) As String
    Dim sql As String, sCuentaAux As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim SQL1 As String
    Dim CuentaA As String
    Dim vLineas As Integer
    Dim vPag As Integer
    Dim lnTotal As Currency
    Dim RCapital As Currency
    Dim lscad As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim lsCtaCod As String * 18
    Dim lsSaldo As String * 15
    Dim lsApertura As String * 10
    Dim lsVencimiento As String * 10
    Dim lsPlazo As String * 5
    Dim lsNombre As String * 25
    Dim lsDireccion As String * 25
    Dim lsFono As String * 6
    Dim sqlAdd As String
    Dim lsCtaCodAnt As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofunfe As New COMFunciones.FCOMFechas
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Left(CAP.cCtaCod,5) Like '___" & lsAgeCod & "'"
    End If
    
    oCon.AbreConexion
    
    sql = " Select PRD.cCtaCod, PRD.nSaldo, CAP.dApertura, PF.nPlazo, DateAdd(day,PF.nPlazo,CAP.dApertura) FFin, " _
        & "     VW.cPersNombre , VW.cPersDireccDomicilio, ISNULL(VW.cPersTelefono,'') cPersTelefono" _
        & " From Producto PRD" _
        & " Inner Join Captaciones CAP ON PRD.cCtaCod = CAP.cCtaCod" _
        & " Inner Join CaptacPlazoFijo PF ON CAP.cCtaCod = PF.cCtaCod" _
        & " Inner Join (" _
        & "         Select PE.cPersNombre, PE.cPersDireccDomicilio, cPersTelefono, PP.cCtaCod From ProductoPersona PP" _
        & "             Inner Join Persona PE On PP.cPersCod = PE.cPersCod" _
        & "             Where nPrdPersRelac = 10) As VW On VW.cCtaCod = PF.cCtaCod" _
        & " Where DateAdd(day,PF.nPlazo,CAP.dApertura) Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' And '" & Format(DateAdd("d", 1, dFecFin), ofunf.gsFormatoFecha) & "' And nSaldo Between " & pnMontoIni & " And " & pnMontoFin & "" _
        & " " & sqlAdd & " And Left(PRD.nPrdEstado,2) Not In (" & Left(CaptacEstado.gCapEstAnulada, 2) & "," & Left(CaptacEstado.gCapEstCancelada, 2) & ") And Substring(CAP.cCtaCod,9,1) = '" & pMoneda & "' "
    sql = sql & " ORDER BY PRD.cCtaCod "
    Set rs = oCon.CargaRecordSet(sql)
    'dFecIni , dFecFin, pnMontoIni, pnMontoFin


    If Not (rs.EOF And rs.BOF) Then
     vPag = 1
     lscad = lscad & Chr(10)
     lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & lsEmpresa & " " & ofunfe.ArmaFecha(gdFecSis) & Space(4) & "Pagina: " & Format(vPag, "####") & Chr(10) & Chr(10)
     lscad = lscad & Space(10) & "LISTADO DE PLAZO FIJO (ANALISIS) EN " + IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") & " Entre :  " & Format(dFecIni, ofunf.gsFormatoFecha) & " - " & Format(dFecFin, ofunf.gsFormatoFecha) & " y " & Format(pnMontoIni, "#,##0.00") & " - " & Format(pnMontoFin, "#,##0.00") & Chr(10) & Chr(10)
     lscad = lscad & String(130, "=") & Chr(10)
     lscad = lscad & "CUENTA " & Space(25) & "NOMBRE" & Space(15) & "DIRECCION" & Space(12) & "TLFNO" & Space(12) & "MONTO" & Space(5) & "F.INI." & Space(5) & "F.FIN." & Space(5) & "PLAZO" & Chr(10)
     lscad = lscad & String(130, "=") & Chr(10)
     sCuentaAux = ""
     Do While Not rs.EOF
        
        If lsCtaCodAnt <> rs!cCtaCod Then
            lsCtaCod = rs!cCtaCod
            RSet lsSaldo = Format(rs!nSaldo, "#,##0.00")
            lsApertura = Format(rs!dApertura, ofunf.gsFormatoFechaView)
            lsVencimiento = Format(rs!dApertura, ofunf.gsFormatoFechaView)
            RSet lsPlazo = rs!nPlazo
            lsNombre = rs!cpersnombre
            lsDireccion = rs!cPersDireccDomicilio
            lsFono = rs!cPersTelefono
            lnTotal = lnTotal + rs!nSaldo
        Else
            lsCtaCod = ""
            RSet lsSaldo = ""
            lsApertura = ""
            lsVencimiento = ""
            RSet lsPlazo = ""
            lsNombre = rs!cpersnombre
            lsDireccion = rs!cPersDireccDomicilio
            lsFono = rs!cPersTelefono
        End If
                
                
        lscad = lscad & lsCtaCod & Space(2) & lsNombre & Space(2) & lsDireccion & Space(2) & lsFono & Space(2) & lsSaldo & Space(2) & lsApertura & Space(2) & lsVencimiento & Space(2) & lsPlazo & Chr(10)
        
        
        lsCtaCodAnt = rs!cCtaCod
        
        rs.MoveNext
        vLineas = vLineas + 1
        If vLineas > 52 Then
            vPag = vPag + 1
            lscad = lscad & Chr(10) & "Resumen :" & Space(38) & ofunc.JDNum(Str(lnTotal), 13, True, 11, 2) & Chr(10)
            lscad = lscad & Chr(12)
            lscad = lscad & Chr(10)
            lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & lsEmpresa & " " & ofunfe.ArmaFecha(gdFecSis) & Space(4) & "Pagina: " & Format(vPag, "####") & Chr(10) & Chr(10)
            lscad = lscad & Space(20) & "LISTADO DE PLAZO FIJO (ANALISIS) EN " + IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
            lscad = lscad & String(130, "=") & Chr(10)
            lscad = lscad & "CUENTA " & Space(25) & "NOMBRE" & Space(15) & "DIRECCION" & Space(12) & "TLFNO" & Space(12) & "MONTO" & Space(5) & "F.INI." & Space(5) & "F.FIN." & Space(5) & "PLAZO" & Chr(10)
            lscad = lscad & String(130, "=") & Chr(10)
            vLineas = 1
        End If
     Loop
    lsCtaCod = ""
    RSet lsSaldo = Format(lnTotal, "#,##0.00")
    lsApertura = ""
    lsVencimiento = ""
    lsPlazo = ""
    lsNombre = ""
    lsDireccion = ""
    lsFono = ""
    lscad = lscad & String(130, "=") & Chr(10)
    lscad = lscad & lsCtaCod & Space(2) & lsNombre & Space(2) & lsDireccion & Space(2) & lsFono & Space(2) & lsSaldo & Space(2) & lsApertura & Space(2) & lsVencimiento & Space(2) & lsPlazo & Chr(10)

    End If
    rs.Close
    Set rs = Nothing
    PlazosFijoCancelayMontos = IIf(lscad <> "", lscad & Chr(12), "")
    Set ofunc = Nothing
    
End Function

Private Function PlazosFijoCancelayMontosEspecial(pMoneda As String, dFecIni As Date, dFecFin As Date, pnMontoIni As Currency, pnMontoFin As Currency, ByVal gsNomAge As String, ByVal gdFecSis As Date) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim SQL1 As String
    Dim CuentaA As String
    Dim vLineas As Integer
    Dim vPag As Integer
    Dim lnTotal As Currency
    Dim RCapital As Currency
    Dim lscad As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim lsCtaCod As String * 18
    Dim lsSaldo As String * 15
    Dim lsApertura As String * 10
    Dim lsVencimiento As String * 10
    Dim lsPlazo As String * 5
    Dim lsNombre As String * 40
    Dim lsDireccion As String * 40
    Dim lsFono As String * 6
    Dim sqlAdd As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofunfe As New COMFunciones.FCOMFechas
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Left(CAP.cCtaCod,5) Like '___" & lsAgeCod & "'"
    End If
    
    
    oCon.AbreConexion
    
    sql = " Select  PRD.cCtaCod, PRD.nSaldo, CAP.dApertura, PF.nPlazo, DateAdd(day,PF.nPlazo,CAP.dApertura) FFin, " _
        & "     VW.cPersNombre , VW.cPersDireccDomicilio, VW.cPersTelefono" _
        & " From Producto PRD" _
        & " Inner Join Captaciones CAP ON PRD.cCtaCod = CAP.cCtaCod" _
        & " Inner Join CaptacPlazoFijo PF ON CAP.cCtaCod = PF.cCtaCod" _
        & " Inner Join (" _
        & "         Select PE.cPersNombre, PE.cPersDireccDomicilio + '-' + (Select cUbiGeoDescripcion From UbicacionGeografica UG Where UG.cUbiGeoCod = PE.cPersDireccUbiGeo) cPersDireccDomicilio, cPersTelefono, PP.cCtaCod From ProductoPersona PP" _
        & "             Inner Join Persona PE On PP.cPersCod = PE.cPersCod" _
        & "             Where nPrdPersRelac = 10) As VW On VW.cCtaCod = PF.cCtaCod" _
        & " Where DateAdd(day,PF.nPlazo,CAP.dApertura) Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' And '" & Format(DateAdd("d", 1, dFecFin), ofunf.gsFormatoFecha) & "' And nSaldo Between " & pnMontoIni & " And " & pnMontoFin & "" _
        & " " & sqlAdd & " And Left(PRD.nPrdEstado,2) Not In (" & Left(CaptacEstado.gCapEstAnulada, 2) & "," & Left(CaptacEstado.gCapEstCancelada, 2) & ") And Substring(CAP.cCtaCod,9,1) = '" & pMoneda & "' And nPrdTasaInteres = " & gCapTasaPreferencial
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
     vPag = 1
     lscad = lscad & Chr(10)
     lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & "Maynas " & ofunfe.ArmaFecha(gdFecSis) & Space(4) & "Pagina: " & Format(vPag, "####") & Chr(10) & Chr(10)
     lscad = lscad & Space(20) & "LISTADO DE PLAZO FIJO (TASA PREFERENCIAL) EN " & IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
     lscad = lscad & "CUENTA " & Space(25) & "NOMBRE" & Space(35) & "DIRECCION" & Space(40) & "MONTO" & Space(5) & "F.INI." & Space(5) & "F.FIN." & Space(5) & "PLAZO" & Chr(10)
     lscad = lscad & String(160, "=") & Chr(10)
     Do While Not rs.EOF
        lsCtaCod = rs!cCtaCod
        RSet lsSaldo = Format(rs!nSaldo, "#,##0.00")
        lsApertura = Format(rs!dApertura, ofunf.gsFormatoFechaView)
        lsVencimiento = Format(rs!dApertura, ofunf.gsFormatoFechaView)
        RSet lsPlazo = rs!nPlazo
        lsNombre = rs!cpersnombre
        lsDireccion = rs!cPersDireccDomicilio
        lsFono = rs!cPersTelefono
        
        lscad = lscad & lsCtaCod & Space(2) & lsNombre & Space(2) & lsDireccion & Space(2) & lsFono & Space(2) & lsSaldo & Space(2) & lsApertura & Space(2) & lsVencimiento & Space(2) & lsPlazo & Chr(10)
        
        lnTotal = lnTotal + rs!nSaldo
        
        rs.MoveNext
        vLineas = vLineas + 1
        If vLineas > 52 Then
            vPag = vPag + 1
            lscad = lscad & Chr(10) & "Resumen :" & Space(38) & ofunc.JDNum(Str(lnTotal), 13, True, 11, 2) & Chr(10)
            lscad = lscad & Chr(12)
            lscad = lscad & Chr(10)
            lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & "Maynas " & ofunfe.ArmaFecha(gdFecSis) & Space(4) & "Pagina: " & Format(vPag, "####") & Chr(10) & Chr(10)
            lscad = lscad & Space(20) & "LISTADO DE PLAZO FIJO (TASA PREFERENCIAL) " + IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
            lscad = lscad & "CUENTA " & Space(25) & "NOMBRE" & Space(35) & "DIRECCION" & Space(40) & "MONTO" & Space(5) & "F.INI." & Space(5) & "F.FIN." & Space(5) & "PLAZO" & Chr(10)
            lscad = lscad & String(160, "=") & Chr(10)
            vLineas = 1
        End If
     Loop
    lsCtaCod = ""
    RSet lsSaldo = Format(lnTotal, "#,##0.00")
    lsApertura = ""
    lsVencimiento = ""
    lsPlazo = ""
    lsNombre = ""
    lsDireccion = ""
    lsFono = ""
    lscad = lscad & String(160, "=") & Chr(10)
    lscad = lscad & lsCtaCod & Space(2) & lsNombre & Space(2) & lsDireccion & Space(2) & lsFono & Space(2) & lsSaldo & Space(2) & lsApertura & Space(2) & lsVencimiento & Space(2) & lsPlazo & Chr(10)
    
    End If
    rs.Close
    Set rs = Nothing
    PlazosFijoCancelayMontosEspecial = IIf(lscad <> "", lscad & Chr(12), "")
    Set ofunc = Nothing
End Function

Public Function AvisoRenovacionPF(ByVal pdFecha As Date, ByVal psTextoCarta As String, Optional ByVal psCodAge As String) As String
Dim sql As String
Dim rs As ADODB.Recordset
Dim oCon As COMConecta.DCOMConecta
Dim lscad As String
Dim lsCarta As String
Dim lsFechaIni As String
Dim lsFechaFin As String
Dim ofunc As New COMFunciones.FCOMCadenas
Dim ofuni As New COMFunciones.FCOMImpresion

lsFechaFin = Mid(CStr(pdFecha), 7, 4) & Mid(CStr(pdFecha), 4, 2) & Mid(CStr(pdFecha), 1, 2)
lsFechaIni = Mid(CStr(pdFecha), 7, 4) & Mid(CStr(pdFecha), 4, 2) & Mid(CStr(DateAdd("d", -1, pdFecha)), 1, 2)

Set oCon = New COMConecta.DCOMConecta

    oCon.AbreConexion

    sql = "SELECT C.cCtaCod, cPersNombre, cPersDireccDomicilio, cUbiGeoDescripcion, nPlazo, dbo.ConvierteTNAaTEA(nTasaInteres) nTasaInteres, nSaldo CapitalAct,  " _
        & "nSaldoDisponible - nMonto CapitalIni, nMonto Interes, DATEADD(dd, 0, dRenovacion) FechaVencimiento, " _
        & "DATEADD(dd, nPlazo, dRenovacion) FechaVencAct, " _
        & "nInteres = (SELECT SUM(nMonto) " _
        & "             FROM MOVCAP MC1 INNER JOIN MOV M1 ON MC1.nMovNro = M1.nMovNro " _
        & "                     INNER JOIN CAPTACPLAZOFIJO PF ON MC1.cCtacod = PF.cCtaCod " _
        & "                     WHERE M1.cOpeCod = 210201 AND nMovFlag <> 2 AND MC1.cCtaCod = C.cCtaCod " _
        & "                             AND SUBSTRING(M1.cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "') " _
        & "FROM PRODUCTO P INNER JOIN CAPTACIONES C ON P.cCtaCod = C.cCtaCod " _
        & "                INNER JOIN CAPTACPLAZOFIJO PF ON C.cCtaCod = PF.cCtaCod " _
        & "                INNER JOIN MOVCAP MC ON MC.cCtaCod = C.cCtaCod INNER JOIN MOV M ON MC.nMovNro = M.nMovNro " _
        & "                INNER JOIN PRODUCTOPERSONA PP ON PF.cCtaCod = PP.cCtaCod INNER JOIN PERSONA T ON PP.cPersCod = T.cPersCod " _
        & "                INNER JOIN UBICACIONGEOGRAFICA U ON T.cPersDireccUbiGeo = U.cUbiGeoCod " _
        & "WHERE dApertura <> dRenovacion AND DATEDIFF(dd, dRenovacion, '" & Format(pdFecha, ofunf.gsFormatoFecha) & "') BETWEEN 0 AND 1 " _
        & "      AND M.cOpeCod = '210501' AND nMovFlag <> 2 AND nPrdPersRelac = 10 AND " _
        & " SUBSTRING(M.cMovNro, 1, 8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "'"
        
        If psCodAge <> "" Then
            sql = sql & " AND SUBSTRING(C.cCtaCod,4,2) = '" & psCodAge & "'"
        End If
        
        sql = sql & " ORDER BY C.cCtaCod "
        
    Set rs = oCon.CargaRecordSet(sql)
            
    If Not (rs.EOF And rs.BOF) Then
            
        Do While Not rs.EOF
        
             lsCarta = psTextoCarta
             lsCarta = Replace(lsCarta, "<<FECHA>>", Format(pdFecha, "dddd,d mmmm yyyy"), , 1, vbTextCompare)
             lsCarta = Replace(lsCarta, "<<NOMBRE>>", ofunc.PstaNombre(rs!cpersnombre, False), , 1, vbTextCompare)
             lsCarta = Replace(lsCarta, "<<CUENTA>>", rs!cCtaCod, , 2, vbTextCompare)
             lsCarta = Replace(lsCarta, "<<CAPITALINI>>", ofuni.ImpreFormat(rs!CapitalIni, 7, 2, True), , 1, vbTextCompare)
             lsCarta = Replace(lsCarta, "<<PLAZO>>", "      " + ofuni.ImpreFormat(rs!nPlazo, 4, False), , 2, vbTextCompare)
             lsCarta = Replace(lsCarta, "<<FECHAVENCANT>>", Format(rs!FechaVencimiento, gcFormatoFechaView), , 2, vbTextCompare)
             lsCarta = Replace(lsCarta, "<<INTGANADOS>>", ofuni.ImpreFormat(rs!Interes + IIf(IsNull(rs!nInteres), 0, rs!nInteres), 7, 2, True), , 1, vbTextCompare)
             lsCarta = Replace(lsCarta, "<<CAPITALACT>>", ofuni.ImpreFormat(rs!CapitalAct, 7, 2, True), , 2, vbTextCompare)
             lsCarta = Replace(lsCarta, "<<FECHAVENCNUE>>", Format(rs!FechaVencAct, gcFormatoFechaView), , 1, vbTextCompare)
             lsCarta = Replace(lsCarta, "<<TASAINTACT>>", ofuni.ImpreFormat(rs!ntasainteres, 3, 2, True), , 1, vbTextCompare)
             lsCarta = Replace(lsCarta, "<<DIRECCION>>", rs!cPersDireccDomicilio & " - " + rs!cUbiGeoDescripcion, , 1, vbTextCompare)
             
             lscad = lscad & lsCarta & Chr(12)
         
             rs.MoveNext
         Loop
                      
       AvisoRenovacionPF = lscad
               
    End If
        
End Function
  
  
Public Function ProtocoloOperaciones(ByVal psTitulo As String, pnPagina As Long, pnItem As Long, pgsNomAge As String, _
                            pgsEmpresa As String, pgdFecSis As Date, Optional pnMoneda As Moneda = gMonedaNacional, _
                            Optional psUsuario As String = "XXX", Optional pbSalto As Boolean = True, _
                            Optional psFecha As String = "", Optional psAgencia As String = "", Optional lsOrden As String = "", Optional lsCheck As String = "") As String
    Dim sql As String
    Dim rs As New ADODB.Recordset
    Dim lsDoc As String * 18
    Dim lsCodCta As String
    Dim lsNomOpe As String * 33
    Dim lsCodUsu As String, sTitulo1 As String
    Dim lbBan As Boolean
    Dim lscadena As String
    Dim lbHoy As Boolean
    Dim i As Long
    Dim lsFec As String
    Dim sqlAdd As String
    Dim ldIni As Date
    Dim ldFin As Date
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnLineas As Integer
    Dim oFun As New COMFunciones.FCOMVarPublicas
    Dim nMonto As Double
    Dim nCantidad As Long
    Dim nCantidadT As Long
    Dim nMontoT As Double
    Dim sTEmpoOpe As String
    Dim sOperacionTempo As String * 33
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    lbHoy = IIf(psFecha = Format$(pgdFecSis, ofunf.gsFormatoFechaView) Or psFecha = "", True, False)
    
    If psAgencia <> "" Then
        sqlAdd = " And SubString(M.cMovNro,18,2) = '" & psAgencia & "'"
    Else
        sqlAdd = ""
    End If
    
    lbBan = False
    lsFec = Format$(CDate(psFecha), "dd mmm yyyy")
    
    ldIni = CDate(psFecha)
    ldFin = DateAdd("d", 1, CDate(psFecha))
    lnRango = 58
    
    oCon.AbreConexion
    
    'Ahorros
    If psUsuario = "XXX" Then
        sTitulo1 = psTitulo & " DEL " & UCase(lsFec) & " - "
    
        sql = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cOpeCod, M.nMovNro nNumTran, Right(M.cMovNro,4) cCodUsu, O.cOpeDesc cNomOpe, O.cOpeCod, " _
            & " Ope.cCtaCod cCodCta, Ope.cDocNro cNumDoc, Ope.Monto nMonTran , SubString(M.cMovNro,18,2) cCodAge" _
            & " From Mov M" _
            & " Inner Join OpeTpo O On M.cOpeCod = O.cOpeCod" _
            & " Inner Join" _
            & "     (Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovCapDet MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where nConceptoCod In (1,2) And M.nMovFlag = 0 And Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "     Union" _
            & "     Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovColDet MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "     Union"
            
            sql = sql & "   Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cNumRecibo cCtaCod, '' cDocNro" _
                & "         From MovServicios MC" _
                & "         Inner Join Mov M On MC.nMovNro = M.nMovNro" _
                & "         Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
                & "     Group By M.nMovNro, M.cOpeCod, MC.cNumRecibo  ) As Ope On Ope.nMovNro = M.nMovNro" _
                & " Where (SubString(M.cOpeCod,1,1) = '2' Or M.cOpeCod like '3%') And Substring(Ope.cCtaCod,9,1) = '" & pnMoneda & "' " _
                & " And M.nMovFlag = 0 " & sqlAdd
                
            If lsOrden = "1" Then
                sql = sql & " Order by nNumTran"
            ElseIf lsOrden = "2" Then
                sql = sql & " Order By O.cOpeCod "
            End If
                
                ' Where ... and substring(M.cMovNro,18,2) = '" & psAgencia & "'
    Else
        sTitulo1 = psTitulo & " - " & psUsuario & " - " & " DEL " & UCase(lsFec) & " - "
        sql = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cOpeCod, M.nMovNro nNumTran, Right(M.cMovNro,4) cCodUsu, O.cOpeDesc cNomOpe, O.cOpeCod, " _
            & " Ope.cCtaCod cCodCta, Ope.cDocNro cNumDoc, Ope.Monto nMonTran , SubString(M.cMovNro,18,2) cCodAge" _
            & " From Mov M" _
            & " Inner Join OpeTpo O On M.cOpeCod = O.cOpeCod" _
            & " Inner Join" _
            & "     (Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovCapDet MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where nConceptoCod In (1,2) And M.nMovFlag = 0 And Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "     Union" _
            & "     Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovColDet MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "     Union"
            
            sql = sql & "   Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cNumRecibo cCtaCod, '' cDocNro" _
                & "         From MovServicios MC" _
                & "         Inner Join Mov M On MC.nMovNro = M.nMovNro" _
                & "         Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
                & "     Group By M.nMovNro, M.cOpeCod, MC.cNumRecibo  ) As Ope On Ope.nMovNro = M.nMovNro" _
                & " Where (SubString(M.cOpeCod,1,1) = '2') And Substring(Ope.cCtaCod,9,1) = '" & pnMoneda & "'" _
                & " And M.nMovFlag = 0 " & sqlAdd & "  And  Right(M.cMovNro,4) = '" & psUsuario & "' "
                
            If lsOrden = "1" Then
                sql = sql & " Order by nNumTran"
            ElseIf lsOrden = "2" Then
                sql = sql & " Order By O.cOpeCod "
            End If
                
            ' And ... and substring(M.cMovNro,18,2) = '" & psAgencia & "'
            
    End If
    
    Set oFun = Nothing
    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF) Then
    
        PonerSalto lscadena
        lbBan = True
        
        lscadena = lscadena & ofuni.CabeceraPagina(sTitulo1 & " AHORRO", pnPagina, pnItem, pgsNomAge, pgsEmpresa, pgdFecSis, pnMoneda)
        lscadena = lscadena & ofuni.Encabezado("Nro.Tran;10;Nro Cuenta;16;Tip.Ope.;24;Nro.Doc.;20;Monto;20;Usu.;12;Agencia;8;Hora;7; ;6;Cod.Ope.;8;", pnItem)
        
        sTEmpoOpe = rs!copecod
        sOperacionTempo = rs!cNomOpe
        nMonto = 0
        nCantidad = 0
        
        While Not rs.EOF
            
            If lsOrden = "2" Then 'por codigo de operacion
                If sTEmpoOpe <> rs!copecod Then
                    If lsCheck <> "1" Then
                        lscadena = lscadena & String(131, "-") & Chr(10)
                    End If
                    
                    lscadena = lscadena & Space(26) & "Total " & sOperacionTempo & Space(7) & "(" & ofuni.ImpreFormat(nCantidad, 6, 0) & ")" & Space(1) & Space(13 - Len(Format(nMonto * 1, "###,##0.00"))) & Format(nMonto * 1, "###,##0.00") & Space(28) & " [" & sTEmpoOpe & "]" & Chr(10)
                    
                    'lsCadena = lsCadena & ImpreFormat(nMonto, 10, 2)
                    
                    'lsCadena = lsCadena & Space(14 - Len(Format(nMonto * 1, "###,##0.00"))) & Format(nMonto * 1, "###,##0.00") & Space(27) & " [" & sTEmpoOpe & "]" & Chr(10)
                    
                    If lsCheck <> "1" Then
                        lscadena = lscadena & Chr(10)
                    End If
                    
                    lsNomOpe = rs!cNomOpe
                    sOperacionTempo = rs!cNomOpe
                    nMonto = rs!nMonTran
                    sTEmpoOpe = rs!copecod
                    nCantidad = 1
                Else
                    nMonto = nMonto + rs!nMonTran
                    nCantidad = nCantidad + 1
                End If
                nMontoT = nMontoT + rs!nMonTran
                nCantidadT = nCantidadT + 1
            End If
            
            
            If IsNull(rs!cNumDoc) Then
                lsDoc = " "
            Else
                lsDoc = rs!cNumDoc
            End If
            
            If IsNull(rs!cCodCta) Then
                lsCodCta = " "
            Else
                lsCodCta = rs!cCodCta
            End If
            
            If IsNull(rs!cCodUsu) Then
                If IsNull(rs!cCodusurem) Then
                    lsCodUsu = ""
                Else
                    lsCodUsu = rs!cCodusurem
                End If
            Else
                lsCodUsu = rs!cCodUsu
            End If

            i = 1

            lsNomOpe = rs!cNomOpe
            If lsCheck <> "1" Then
            lscadena = lscadena & Space(10 - Len(Str(rs!nNumTran))) & Str(rs!nNumTran) _
                                & Space(20 - Len(lsCodCta)) & lsCodCta _
                                & Space(2) & Trim(lsNomOpe) _
                                & Space(26 - Len(Trim(lsDoc)) + 20 - Len(Trim(lsNomOpe))) & Trim(lsDoc) _
                                & Space(16 - Len(Format(rs!nMonTran * i, "###,##0.00"))) & Format(rs!nMonTran * i, "###,##0.00") _
                                & Space(7 - Len(lsCodUsu)) & lsCodUsu _
                                & Space(7 - Len(rs!CCodage)) & rs!CCodage _
                                & Space(14 - Len(Format(rs!dFecTran, "hh:mm:ss AMPM"))) & Format(rs!dFecTran, "hh:mm:ss AMPM") & " [" & rs!copecod & "]" & oImp.gPrnSaltoLinea
            End If
            pnItem = pnItem + 1
                    
            If pnItem = lnRango Then
                lscadena = lscadena & oImp.gPrnSaltoPagina
                lscadena = lscadena + ofuni.CabeceraPagina(sTitulo1 & " AHORRO", pnPagina, pnItem, pgsNomAge, pgsEmpresa, pgdFecSis, pnMoneda)
                lscadena = lscadena & ofuni.Encabezado("Nro.Tran;10;Nro Cuenta;16;Tip.Ope.;24;Nro.Doc.;20;Monto;20;Usu.;12;Agencia;8;Hora;7; ;6;Cod.Ope.;8;", pnItem)
            End If
            
            rs.MoveNext
        Wend
        
        If lsOrden = "2" Then 'por codigo de operacion
            If lsCheck <> "1" Then
                lscadena = lscadena & String(131, "-") & Chr(10)
            End If
            lscadena = lscadena & Space(26) & "Total " & sOperacionTempo & Space(7) & "(" & ofuni.ImpreFormat(nCantidad, 6, 0) & ")" & Space(1) & Space(13 - Len(Format(nMonto * 1, "###,##0.00"))) & Format(nMonto * 1, "###,##0.00") & Space(28) & " [" & sTEmpoOpe & "]" & Chr(10)
        End If
        
        'If lsOrden = "2" Then 'por codigo de operacion
        '    lsCadena = lsCadena & String(122, "=") & Chr(10)
        '    sOperacionTempo = ""
        '    lsCadena = lsCadena & Space(26) & "TOTAL " & sOperacionTempo & Space(7) & "(" & ImpreFormat(nCantidadT, 6, 0) & ")" & Space(1) & ImpreFormat(nMontoT, 10, 2) & Chr(10) & Chr(10)
        'End If
        
    End If
    
    rs.Close
    Set rs = Nothing
    
    nCantidadT = 0
    nMontoT = 0
    
    'Prendario
    If psUsuario = "XXX" Then
        sTitulo1 = psTitulo & " DEL " & UCase(lsFec) & " - "
        sql = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cOpeCod, M.nMovNro nNumTran, Right(M.cMovNro,4) cCodUsu, O.cOpeDesc cNomOpe, O.cOpeCod, " _
            & " Ope.cCtaCod cCodCta, Ope.cDocNro cNumDoc, Ope.Monto nMonTran , SubString(M.cMovNro,18,2) cCodAge" _
            & " From Mov M" _
            & " Inner Join OpeTpo O On M.cOpeCod = O.cOpeCod" _
            & " Inner Join" _
            & "     (Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovCapDet MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where nConceptoCod In (1,2) And M.nMovFlag = 0 And Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "     Union" _
            & "     Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovCol MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro) As Ope On Ope.nMovNro = M.nMovNro" _
            & " Where (SubString(M.cOpeCod,1,2) In ('12') Or M.cOpeCod like '32%') And Substring(Ope.cCtaCod,9,1) = '" & pnMoneda & "' " _
            & " And M.nMovFlag = 0 " & sqlAdd & "  " 'Order by nNumTran"
            
            If lsOrden = "1" Then
                sql = sql & " Order by nNumTran"
            ElseIf lsOrden = "2" Then
                sql = sql & " Order By O.cOpeCod "
            End If
            
            'Where ... and substring(M.cMovNro,18,2) = '" & psAgencia & "'
    Else
        sTitulo1 = psTitulo & " - " & psUsuario & " - " & " del " & UCase(lsFec) & " - "
        sql = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cOpeCod, M.nMovNro nNumTran, Right(M.cMovNro,4) cCodUsu, O.cOpeDesc cNomOpe, O.cOpeCod, " _
            & " Ope.cCtaCod cCodCta, Ope.cDocNro cNumDoc, Ope.Monto nMonTran , SubString(M.cMovNro,18,2) cCodAge" _
            & " From Mov M" _
            & " Inner Join OpeTpo O On M.cOpeCod = O.cOpeCod" _
            & " Inner Join" _
            & "     (Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovCapDet MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where nConceptoCod In (1,2) And M.nMovFlag = 0 And Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "     Union" _
            & "     Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovCol MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro) As Ope On Ope.nMovNro = M.nMovNro" _
            & " Where (SubString(M.cOpeCod,1,2) In ('12') Or M.cOpeCod like '31%') And Substring(Ope.cCtaCod,9,1) = '" & pnMoneda & "'" _
            & " And M.nMovFlag = 0 " & sqlAdd & "  And  Right(M.cMovNro,4) = '" & psUsuario & "' " 'Order by nNumTran"
            
            If lsOrden = "1" Then
                sql = sql & " Order by nNumTran"
            ElseIf lsOrden = "2" Then
                sql = sql & " Order By O.cOpeCod "
            End If
            
            'And ... and substring(M.cMovNro,18,2) = '" & psAgencia & "'
     End If
    
    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF) Then
        PonerSalto lscadena
        
        lbBan = True
        
        lscadena = lscadena + ofuni.CabeceraPagina(sTitulo1 & " PRENDARIO", pnPagina, pnItem, pgsNomAge, pgsEmpresa, pgdFecSis, pnMoneda)
        lscadena = lscadena & ofuni.Encabezado("Nro.Tran;10;Nro Cuenta;16;Tip.Ope.;24;Nro.Doc.;20;Monto;20;Usu.;12;Agencia;8;Hora;7; ;6;Cod.Ope.;8;", pnItem)
        
        sTEmpoOpe = rs!copecod
        sOperacionTempo = rs!cNomOpe
        nMonto = 0
        nCantidad = 0
        
        While Not rs.EOF
            
            If lsOrden = "2" Then 'por codigo de operacion
                If sTEmpoOpe <> rs!copecod Then
                    If lsCheck <> "1" Then
                        lscadena = lscadena & String(131, "-") & Chr(10)
                    End If
                    lscadena = lscadena & Space(26) & "Total " & sOperacionTempo & Space(7) & "(" & ofuni.ImpreFormat(nCantidad, 6, 0) & ")" & Space(1) & Space(13 - Len(Format(nMonto * 1, "###,##0.00"))) & Format(nMonto * 1, "###,##0.00") & Space(28) & " [" & sTEmpoOpe & "]" & Chr(10)
                    If lsCheck <> "1" Then
                        lscadena = lscadena & Chr(10)
                    End If
                    lsNomOpe = rs!cNomOpe
                    sOperacionTempo = rs!cNomOpe
                    nMonto = rs!nMonTran
                    sTEmpoOpe = rs!copecod
                    nCantidad = 1
                Else
                    nMonto = nMonto + rs!nMonTran
                    nCantidad = nCantidad + 1
                End If
                nMontoT = nMontoT + rs!nMonTran
                nCantidadT = nCantidadT + 1
            End If
            
            If IsNull(rs!cNumDoc) Then
                lsDoc = " "
            Else
                lsDoc = rs!cNumDoc
            End If
            
            If IsNull(rs!cCodCta) Then
                lsCodCta = " "
            Else
                lsCodCta = rs!cCodCta
            End If
            
            If IsNull(rs!cCodUsu) Then
                If IsNull(rs!cCodusurem) Then
                    lsCodUsu = ""
                Else
                    lsCodUsu = rs!cCodusurem
                End If
            Else
                lsCodUsu = rs!cCodUsu
            End If
            
            lsNomOpe = rs!cNomOpe
            If lsCheck <> "1" Then
            lscadena = lscadena & Space(10 - Len(Str(rs!nNumTran))) & Str(rs!nNumTran) _
                                & Space(20 - Len(lsCodCta)) & lsCodCta _
                                & Space(2) & Trim(lsNomOpe) _
                                & Space(26 - Len(Trim(lsDoc)) + 20 - Len(Trim(lsNomOpe))) & Trim(lsDoc) _
                                & Space(16 - Len(Format(rs!nMonTran, "###,##0.00"))) & Format(rs!nMonTran, "###,##0.00") _
                                & Space(7 - Len(lsCodUsu)) & lsCodUsu _
                                & Space(7 - Len(rs!CCodage)) & rs!CCodage _
                                & Space(14 - Len(Format(rs!dFecTran, "hh:mm:ss AMPM"))) & Format(rs!dFecTran, "hh:mm:ss AMPM") & " [" & rs!copecod & "]" & oImp.gPrnSaltoLinea
            End If
            pnItem = pnItem + 1
                    
            If pnItem = lnRango Then
                lscadena = lscadena & oImp.gPrnSaltoPagina
                lscadena = lscadena & ofuni.CabeceraPagina(sTitulo1 & " PRENDARIO", pnPagina, pnItem, pgsNomAge, pgsEmpresa, pgdFecSis, pnMoneda)
                lscadena = lscadena & ofuni.Encabezado("Nro.Tran;10;Nro Cuenta;16;Tip.Ope.;24;Nro.Doc.;20;Monto;20;Usu.;12;Agencia;8;Hora;7; ;6;Cod.Ope.;8;", pnItem)
            End If
            
            rs.MoveNext
        Wend
        
        If lsOrden = "2" Then 'por codigo de operacion
            lscadena = lscadena & String(131, "-") & Chr(10)
            lscadena = lscadena & Space(26) & "Total " & sOperacionTempo & Space(7) & "(" & ofuni.ImpreFormat(nCantidad, 6, 0) & ")" & Space(1) & Space(13 - Len(Format(nMonto * 1, "###,##0.00"))) & Format(nMonto * 1, "###,##0.00") & Space(28) & " [" & sTEmpoOpe & "]" & Chr(10)
        End If
        
        'If lsOrden = "2" Then 'por codigo de operacion
        '    lsCadena = lsCadena & String(122, "=") & Chr(10)
        '    sOperacionTempo = ""
        '    lsCadena = lsCadena & Space(26) & "TOTAL " & sOperacionTempo & Space(7) & "(" & ImpreFormat(nCantidadT, 6, 0) & ")" & Space(1) & ImpreFormat(nMontoT, 10, 2) & Chr(10) & Chr(10)
        'End If
        
    End If
    
    rs.Close
    Set rs = Nothing
    
    nCantidadT = 0
    nMontoT = 0
    
    'Creditos
    If psUsuario = "XXX" Then
        sTitulo1 = psTitulo & " DEL " & UCase(lsFec) & " - "
        sql = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cOpeCod, M.nMovNro nNumTran, Right(M.cMovNro,4) cCodUsu, O.cOpeDesc cNomOpe, O.cOpeCod, " _
            & " Ope.cCtaCod cCodCta, Ope.cDocNro cNumDoc, Ope.Monto nMonTran , SubString(M.cMovNro,18,2) cCodAge" _
            & " From Mov M" _
            & " Inner Join OpeTpo O On M.cOpeCod = O.cOpeCod" _
            & " Inner Join" _
            & "     (Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovCapDet MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where nConceptoCod In (1,2) And M.nMovFlag = 0 And Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "     Union" _
            & "     Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovColDet MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where (Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "')" _
            & " AND nPrdConceptoCod NOT IN (8102, 8503, 8504, 8502,8505)" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro) As Ope On Ope.nMovNro = M.nMovNro" _
            & " Where (SubString(M.cOpeCod,1,2) In ('10','13','14','15') Or M.cOpeCod like '33%') And Substring(Ope.cCtaCod,9,1) = '" & pnMoneda & "' " _
            & " And M.nMovFlag = 0 " & sqlAdd & "  " 'Order by nNumTran"
        
            If lsOrden = "1" Then
                sql = sql & " Order by nNumTran"
            ElseIf lsOrden = "2" Then
                sql = sql & " Order By O.cOpeCod "
            End If
        
        'Where ... and substring(M.cMovNro,18,2) = '" & psAgencia & "'
        
    Else
        sTitulo1 = psTitulo & " - " & psUsuario & " - " & " DEL " & UCase(lsFec) & " - "
        sql = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cOpeCod, M.nMovNro nNumTran, Right(M.cMovNro,4) cCodUsu, O.cOpeDesc cNomOpe, O.cOpeCod, " _
            & " Ope.cCtaCod cCodCta, Ope.cDocNro cNumDoc, Ope.Monto nMonTran , SubString(M.cMovNro,18,2) cCodAge" _
            & " From Mov M" _
            & " Inner Join OpeTpo O On M.cOpeCod = O.cOpeCod" _
            & " Inner Join" _
            & "     (Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovCapDet MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where nConceptoCod In (1,2) And M.nMovFlag = 0 And Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "     Union" _
            & "     Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _
            & "         From MovColDet MC" _
            & "         Inner Join Mov M On MC.nMovNro = M.nMovNro And MC.cOpeCod = M.cOpeCod" _
            & "         Left Join  MovDoc MD On MD.nMovNro = MC.nMovNro" _
            & "         Where (Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "')" _
            & " AND nPrdConceptoCod NOT IN (8102, 8503, 8504, 8502, 8505) " _
            & "     Group By M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro) As Ope On Ope.nMovNro = M.nMovNro" _
            & " Where (SubString(M.cOpeCod,1,2) In ('10','13','14','15') Or M.cOpeCod like '33%') And Substring(Ope.cCtaCod,9,1) = '" & pnMoneda & "'" _
            & " And M.nMovFlag = 0 " & sqlAdd & "  And  Right(M.cMovNro,4) = '" & psUsuario & "' " 'Order by nNumTran"
            
            If lsOrden = "1" Then
                sql = sql & " Order by nNumTran"
            ElseIf lsOrden = "2" Then
                sql = sql & " Order By O.cOpeCod "
            End If
            
            'And ... and substring(M.cMovNro,18,2) = '" & psAgencia & "'
    End If
'            & "     Select Sum(Case nPrdConceptoCod WHEN 8502 THEN 0 WHEN 8505 THEN 0 WHEN 8508 THEN 0 ELSE nMonto END) Monto, M.nMovNro, M.cOpeCod, MC.cCtaCod, MD.cDocNro" _

    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF) Then
        PonerSalto lscadena
        lbBan = True
        
        lscadena = lscadena + ofuni.CabeceraPagina(sTitulo1 & " CREDITO", pnPagina, pnItem, pgsNomAge, pgsEmpresa, pgdFecSis, pnMoneda)
        lscadena = lscadena & ofuni.Encabezado("Nro.Tran;10;Nro Cuenta;16;Tip.Ope.;24;Nro.Doc.;20;Monto;20;Usu.;12;Agencia;8;Hora;7; ;6;Cod.Ope.;8;", pnItem)
        
        sTEmpoOpe = rs!copecod
        sOperacionTempo = rs!cNomOpe
        nMonto = 0
        nCantidad = 0
        
        While Not rs.EOF
            
            If lsOrden = "2" Then 'por codigo de operacion
                If sTEmpoOpe <> rs!copecod Then
                    If lsCheck <> "1" Then
                        lscadena = lscadena & String(131, "-") & Chr(10)
                    End If
                    lscadena = lscadena & Space(26) & "Total " & sOperacionTempo & Space(7) & "(" & ofuni.ImpreFormat(nCantidad, 6, 0) & ")" & Space(1) & Space(13 - Len(Format(nMonto * 1, "###,##0.00"))) & Format(nMonto * 1, "###,##0.00") & Space(28) & " [" & sTEmpoOpe & "]" & Chr(10)
                    If lsCheck <> "1" Then
                        lscadena = lscadena & Chr(10)
                    End If
                    lsNomOpe = rs!cNomOpe
                    sOperacionTempo = rs!cNomOpe
                    nMonto = rs!nMonTran
                    sTEmpoOpe = rs!copecod
                    nCantidad = 1
                Else
                    nMonto = nMonto + rs!nMonTran
                    nCantidad = nCantidad + 1
                End If
                nMontoT = nMontoT + rs!nMonTran
                nCantidadT = nCantidadT + 1
            End If
            
            If IsNull(rs!cNumDoc) Then
                lsDoc = " "
            Else
                lsDoc = rs!cNumDoc
            End If
            
            If IsNull(rs!cCodCta) Then
                lsCodCta = " "
            Else
                lsCodCta = rs!cCodCta
            End If
            
            If IsNull(rs!cCodUsu) Then
                If IsNull(rs!cCodusurem) Then
                    lsCodUsu = ""
                Else
                    lsCodUsu = rs!cCodusurem
                End If
            Else
                lsCodUsu = rs!cCodUsu
            End If
            
            lsNomOpe = Mid(rs!cNomOpe, 1, 26)
            If lsCheck <> "1" Then
            lscadena = lscadena & Space(10 - Len(Str(rs!nNumTran))) & Str(rs!nNumTran) _
                                & Space(20 - Len(lsCodCta)) & lsCodCta _
                                & Space(2) & Trim(lsNomOpe) _
                                & Space(26 - Len(Trim(lsDoc)) + 20 - Len(Trim(lsNomOpe))) & Trim(lsDoc) _
                                & Space(16 - Len(Format(rs!nMonTran, "###,##0.00"))) & Format(rs!nMonTran, "###,##0.00") _
                                & Space(7 - Len(lsCodUsu)) & lsCodUsu _
                                & Space(7 - Len(rs!CCodage)) & rs!CCodage _
                                & Space(14 - Len(Format(rs!dFecTran, "hh:mm:ss AMPM"))) & Format(rs!dFecTran, "hh:mm:ss AMPM") & " [" & rs!copecod & "]" & oImp.gPrnSaltoLinea
            End If
            pnItem = pnItem + 1
                    
            If pnItem = lnRango Then
                lscadena = lscadena & oImp.gPrnSaltoPagina
                lscadena = lscadena & ofuni.CabeceraPagina(sTitulo1 & " CREDITO", pnPagina, pnItem, pgsNomAge, pgsEmpresa, pgdFecSis, pnMoneda)
                lscadena = lscadena & ofuni.Encabezado("Nro.Tran;10;Nro Cuenta;16;Tip.Ope.;24;Nro.Doc.;20;Monto;20;Usu.;12;Agencia;8;Hora;7; ;6;Cod.Ope.;8;", pnItem)
            End If
            
            rs.MoveNext
        Wend
        
        If lsOrden = "2" Then 'por codigo de operacion
            If lsCheck <> "1" Then
                lscadena = lscadena & String(131, "-") & Chr(10)
            End If
            lscadena = lscadena & Space(26) & "Total " & sOperacionTempo & Space(7) & "(" & ofuni.ImpreFormat(nCantidad, 6, 0) & ")" & Space(1) & Space(13 - Len(Format(nMonto * 1, "###,##0.00"))) & Format(nMonto * 1, "###,##0.00") & Space(28) & " [" & sTEmpoOpe & "]" & Chr(10)
        End If
        
        'If lsOrden = "2" Then 'por codigo de operacion
        '    lsCadena = lsCadena & String(122, "=") & Chr(10)
        '    sOperacionTempo = ""
        '    lsCadena = lsCadena & Space(26) & "TOTAL " & sOperacionTempo & Space(7) & "(" & ImpreFormat(nCantidadT, 6, 0) & ")" & Space(1) & ImpreFormat(nMontoT, 10, 2) & Chr(10) & Chr(10)
        'End If
        
    End If
    
    rs.Close
    Set rs = Nothing
    
    nCantidadT = 0
    nMontoT = 0
    
    'Otros
    If psUsuario = "XXX" Then
        sTitulo1 = psTitulo & " DEL " & UCase(lsFec) & " - "
        
        sql = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cOpeCod, M.nMovNro nNumTran, Right(M.cMovNro,4) cCodUsu, O.cOpeDesc cNomOpe, O.cOpeCod, " _
            & " Ope.cCtaCod cCodCta, Ope.cDocNro cNumDoc, Ope.Monto nMonTran , SubString(M.cMovNro,18,2) cCodAge" _
            & " From Mov M" _
            & " Inner Join OpeTpo O On M.cOpeCod = O.cOpeCod" _
            & " Inner Join" _
            & "     (Select Sum(nMovImporte) Monto, M.nMovNro, M.cOpeCod, '000000002' cCtaCod, '' cDocNro     " _
            & "         From MovCompraVenta MC" _
            & "             Inner Join Mov M On MC.nMovNro = M.nMovNro" _
            & "     Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & " Group By M.nMovNro, M.cOpeCod" _
            & " Union" _
            & " Select Sum(nMovImporte) Monto, M.nMovNro, M.cOpeCod, '00000000' + ltrim(rtrim(str(MC.nMoneda))) cCtaCod, Mc.cNroDoc" _
            & "     From MovOpeVarias MC " _
            & "     Inner Join Mov M On MC.nMovNro = M.nMovNro " _
            & "     Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, '00000000' + ltrim(rtrim(str(MC.nMoneda))), MC.cNroDoc" _
            & " Union" _
            & "     Select Sum(nMovImporte) Monto, M.nMovNro, M.cOpeCod, '00000000' + ltrim(rtrim(str(MC.nMoneda))) cCtaCod, 'Dest : ' + MC.cUsuDest cNroDoc" _
            & "     From MovHabDevCajero MC" _
            & "     Inner Join Mov M On MC.nMovNro = M.nMovNro" _
            & "     Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, '00000000' + ltrim(rtrim(str(MC.nMoneda))), MC.cUsuDest"
            
        sql = sql & " Union" _
            & "     Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, '00000000' + LTrim(RTrim(Str(MC.nMoneda))) cCtaCod, MC.cNumRecibo cNroDoc" _
            & "     From MovServicios MC" _
            & "     Inner Join Mov M On MC.nMovNro = M.nMovNro" _
            & "     Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
            & "     Group By M.nMovNro, M.cOpeCod, '00000000' + ltrim(rtrim(str(MC.nMoneda))), MC.cNumRecibo" _
            & " ) As Ope On Ope.nMovNro = M.nMovNro" _
            & " Where  Substring(Ope.cCtaCod,9,1) = '" & pnMoneda & "'" _
            & " And M.nMovFlag = 0 " & sqlAdd
            
            
            If lsOrden = "1" Then
                sql = sql & " Order by nNumTran"
            ElseIf lsOrden = "2" Then
                sql = sql & " Order By O.cOpeCod "
            End If
            
   Else
        sTitulo1 = psTitulo & " - " & psUsuario & " - " & " DEL " & UCase(lsFec) & " - "
'        sql = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cOpeCod, M.nMovNro nNumTran, Right(M.cMovNro,4) cCodUsu, O.cOpeDesc cNomOpe, O.cOpeCod, " _
'            & " Ope.cCtaCod cCodCta, Ope.cDocNro cNumDoc, Ope.Monto nMonTran , SubString(M.cMovNro,18,2) cCodAge" _
'            & " From Mov M" _
'            & " Inner Join OpeTpo O On M.cOpeCod = O.cOpeCod" _
'            & " Inner Join" _
'            & "     (Select Sum(nMovImporte) Monto, M.nMovNro, M.cOpeCod, '000000002' cCtaCod, '' cDocNro     " _
'            & "         From MovCompraVenta MC" _
'            & "             Inner Join Mov M On MC.nMovNro = M.nMovNro" _
'            & "     Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
'            & " Group By M.nMovNro, M.cOpeCod" _
'            & " Union" _
'            & " Select Sum(nMovImporte) Monto, M.nMovNro, M.cOpeCod, '00000000' + ltrim(rtrim(str(MC.nMoneda))) cCtaCod, Mc.cNroDoc" _
'            & "     From MovOpeVarias MC " _
'            & "     Inner Join Mov M On MC.nMovNro = M.nMovNro " _
'            & "     Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
'            & "     Group By M.nMovNro, M.cOpeCod, '00000000' + ltrim(rtrim(str(MC.nMoneda))), MC.cNroDoc" _
'            & " Union" _
'            & "     Select Sum(nMovImporte) Monto, M.nMovNro, M.cOpeCod, '00000000' + LTrim(RTrim(Str(MC.nMoneda))) cCtaCod, 'Dest : ' + MC.cUsuDest cNroDoc" _
'            & "     From MovHabDevCajero MC" _
'            & "     Inner Join Mov M On MC.nMovNro = M.nMovNro" _
'            & "     Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
'            & "     Group By M.nMovNro, M.cOpeCod, '00000000' + ltrim(rtrim(str(MC.nMoneda))), MC.cUsuDest"
'
'        sql = sql & " Union" _
'            & "     Select Sum(nMonto) Monto, M.nMovNro, M.cOpeCod, '00000000' + LTrim(RTrim(Str(MC.nMoneda))) cCtaCod, MC.cNumRecibo cNroDoc" _
'            & "     From MovServicios MC" _
'            & "     Inner Join Mov M On MC.nMovNro = M.nMovNro" _
'            & "     Where Left(M.cMovNro,8) Between '" & Format(ldIni, oFun.gsFormatoMovFecha) & "' And '" & Format(ldFin, oFun.gsFormatoMovFecha) & "'" _
'            & "     Group By M.nMovNro, M.cOpeCod, '00000000' + ltrim(rtrim(str(MC.nMoneda))), MC.cNumRecibo" _
'            & " ) As Ope On Ope.nMovNro = M.nMovNro" _
'            & " Where  Substring(Ope.cCtaCod,9,1) = '" & pnMoneda & "'" _
'            & " And M.nMovFlag = 0 " & sqlAdd & "  And  Right(M.cMovNro,4) = '" & psUsuario & "'"
            
            sql = " Select dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cOpeCod, M.nMovNro nNumTran, Right(M.cMovNro,4) cCodUsu, O.cOpeDesc cNomOpe, O.cOpeCod, " _
            & " Ope.cCtaCod cCodCta, Ope.cDocNro cNumDoc, Ope.Monto nMonTran , SubString(M.cMovNro,18,2) cCodAge" _
            & " From Mov M" _
            & " Inner Join OpeTpo O On M.cOpeCod = O.cOpeCod" _
            & " Inner Join" _
            & "     (Select Sum(nMovImporte) Monto, MC.nMovNro, '000000002' cCtaCod, '' cDocNro     " _
            & "         From MovCompraVenta MC" _
            & " Group By MC.nMovNro" _
            & " Union" _
            & " Select Sum(nMovImporte) Monto, MC.nMovNro, '00000000' + ltrim(rtrim(str(MC.nMoneda))) cCtaCod, Mc.cNroDoc" _
            & "     From MovOpeVarias MC " _
            & "     Group By MC.nMovNro, '00000000' + ltrim(rtrim(str(MC.nMoneda))), MC.cNroDoc" _
            & " Union" _
            & "     Select Sum(nMovImporte) Monto, MC.nMovNro, '00000000' + LTrim(RTrim(Str(MC.nMoneda))) cCtaCod, 'Dest : ' + MC.cUsuDest cNroDoc" _
            & "     From MovHabDevCajero MC" _
            & "     Group By MC.nMovNro, '00000000' + ltrim(rtrim(str(MC.nMoneda))), MC.cUsuDest"
            
        sql = sql & " Union" _
            & "     Select Sum(nMonto) Monto, MC.nMovNro, '00000000' + LTrim(RTrim(Str(MC.nMoneda))) cCtaCod, MC.cNumRecibo cNroDoc" _
            & "     From MovServicios MC" _
            & "     Group By MC.nMovNro, '00000000' + ltrim(rtrim(str(MC.nMoneda))), MC.cNumRecibo" _
            & " ) As Ope On Ope.nMovNro = M.nMovNro" _
            & " Where  Substring(Ope.cCtaCod,9,1) = '" & pnMoneda & "'" _
            & " And M.nMovFlag = 0 " & sqlAdd & "  And  Right(M.cMovNro,4) = '" & psUsuario & "'" _
            & " And Left(M.cMovNro,8) = '" & Format(ldIni, oFun.gsFormatoMovFecha) & "'"
            
            If lsOrden = "1" Then
                sql = sql & " Order by nNumTran"
            ElseIf lsOrden = "2" Then
                sql = sql & " Order By O.cOpeCod "
            End If
            
    End If
    
    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF) Then
        PonerSalto lscadena
        lbBan = True
        
        lscadena = lscadena + ofuni.CabeceraPagina(sTitulo1 & " OTROS", pnPagina, pnItem, pgsNomAge, pgsEmpresa, pgdFecSis, pnMoneda)
        lscadena = lscadena & ofuni.Encabezado("Nro.Tran;10;Nro Cuenta;16;Tip.Ope.;24;Nro.Doc.;20;Monto;20;Usu.;12;Agencia;8;Hora;7; ;6;Cod.Ope.;8;", pnItem)
        
        sTEmpoOpe = rs!copecod
        sOperacionTempo = rs!cNomOpe
        nMonto = 0
        nCantidad = 0
        
        While Not rs.EOF
            
            If lsOrden = "2" Then 'por codigo de operacion
                If sTEmpoOpe <> rs!copecod Then
                    If lsCheck <> "1" Then
                        lscadena = lscadena & String(131, "-") & Chr(10)
                    End If
                    lscadena = lscadena & Space(26) & "Total " & sOperacionTempo & Space(7) & "(" & ofuni.ImpreFormat(nCantidad, 6, 0) & ")" & Space(1) & Space(13 - Len(Format(nMonto * 1, "###,##0.00"))) & Format(nMonto * 1, "###,##0.00") & Space(28) & " [" & sTEmpoOpe & "]" & Chr(10)
                    If lsCheck <> "1" Then
                        lscadena = lscadena & Chr(10)
                    End If
                    lsNomOpe = rs!cNomOpe
                    sOperacionTempo = rs!cNomOpe
                    nMonto = rs!nMonTran
                    sTEmpoOpe = rs!copecod
                    nCantidad = 1
                Else
                    nMonto = nMonto + rs!nMonTran
                    nCantidad = nCantidad + 1
                End If
                nMontoT = nMontoT + rs!nMonTran
                nCantidadT = nCantidadT + 1
            End If
            
            If IsNull(rs!cNumDoc) Then
                lsDoc = " "
            Else
                lsDoc = rs!cNumDoc
            End If
            
            If IsNull(rs!cCodCta) Then
                lsCodCta = " "
            Else
                lsCodCta = rs!cCodCta
            End If
            
            If IsNull(rs!cCodUsu) Then
                If IsNull(rs!cCodusurem) Then
                    lsCodUsu = ""
                Else
                    lsCodUsu = rs!cCodusurem
                End If
            Else
                lsCodUsu = rs!cCodUsu
            End If
            
            lsNomOpe = Mid(rs!cNomOpe, 1, 26)
            If lsCheck <> "1" Then
            lscadena = lscadena & Space(10 - Len(Str(rs!nNumTran))) & Str(rs!nNumTran) _
                                & Space(20 - Len(lsCodCta)) & lsCodCta _
                                & Space(2) & Trim(lsNomOpe) _
                                & Space(26 - Len(Trim(lsDoc)) + 20 - Len(Trim(lsNomOpe))) & Trim(lsDoc) _
                                & Space(16 - Len(Format(rs!nMonTran, "###,##0.00"))) & Format(rs!nMonTran, "###,##0.00") _
                                & Space(7 - Len(lsCodUsu)) & lsCodUsu _
                                & Space(7 - Len(rs!CCodage)) & rs!CCodage _
                                & Space(14 - Len(Format(rs!dFecTran, "hh:mm:ss AMPM"))) & Format(rs!dFecTran, "hh:mm:ss AMPM") & " [" & rs!copecod & "]" & oImp.gPrnSaltoLinea
            End If
            pnItem = pnItem + 1
                    
            If pnItem = lnRango Then
                lscadena = lscadena & oImp.gPrnSaltoPagina
                lscadena = lscadena & ofuni.CabeceraPagina(sTitulo1 & " CREDITO", pnPagina, pnItem, pgsNomAge, pgsEmpresa, pgdFecSis, pnMoneda)
                lscadena = lscadena & ofuni.Encabezado("Nro.Tran;10;Nro Cuenta;16;Tip.Ope.;24;Nro.Doc.;20;Monto;20;Usu.;12;Agencia;8;Hora;7; ;6;Cod.Ope.;8;", pnItem)
            End If
            
            rs.MoveNext
        Wend
        
        If lsOrden = "2" Then 'por codigo de operacion
            If lsCheck <> "1" Then
                lscadena = lscadena & String(131, "-") & Chr(10)
            End If
            lscadena = lscadena & Space(26) & "Total " & sOperacionTempo & Space(7) & "(" & ofuni.ImpreFormat(nCantidad, 6, 0) & ")" & Space(1) & Space(13 - Len(Format(nMonto * 1, "###,##0.00"))) & Format(nMonto * 1, "###,##0.00") & Space(28) & " [" & sTEmpoOpe & "]" & Chr(10)
        End If
        
        'If lsOrden = "2" Then 'por codigo de operacion
        '    lsCadena = lsCadena & String(122, "=") & Chr(10)
        '    sOperacionTempo = ""
        '    lsCadena = lsCadena & Space(26) & "TOTAL " & sOperacionTempo & Space(7) & "(" & ImpreFormat(nCantidadT, 6, 0) & ")" & Space(1) & ImpreFormat(nMontoT, 10, 2) & Chr(10) & Chr(10)
        'End If
        
    End If
    
    rs.Close
    Set rs = Nothing
    
    If pbSalto Then lscadena = lscadena & oImp.gPrnSaltoPagina
    
    ProtocoloOperaciones = lscadena
    
    Set ofuni = Nothing
    
End Function

'
Public Function ComVtaME(ByVal pdIni As Date, ByVal pdFin As Date, psAge As String) As String
    Dim lsQryOpe As String
    Dim rsQryOpe As ADODB.Recordset
    Set rsQryOpe = New ADODB.Recordset
    
    
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    Dim lsRTFCaj As String
    
    If psAge = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(M.cMovNro,18,2) = '" & psAge & "'"
    End If
    
    
    lsRTFCaj = ""
    
    oCon.AbreConexion
    
    lsQryOpe = ""
    lsQryOpe = " SELECT dbo.FechaHoraMov(M.cMovNro) dFecTran, M.cOpeCod cCodOpe, M.nMovNro nNumTran, PE.cPersNombre cNomPers, CV.nMovImporte nMonTran, MTC.nMovTpoCambio nTipcambio, (CV.nMovImporte*MTC.nMovTpoCambio) AS nConv, Right(M.cMovNro,4) cCodUsu  " _
             & " FROM        Mov M" _
             & " INNER JOIN  MovCompraVenta CV ON CV.nMovNro = M.nMovNro" _
             & " INNER JOIN  Persona PE ON PE.cPersCod = CV.cPersCod" _
             & " INNER JOIN  MovTpoCambio MTC ON MTC.nMovNro = M.nMovNro" _
             & " WHERE       M.cOpeCod IN ('" & gOpeCajeroMECompra & "','" & gOpeCajeroMEVenta & "','" & gOpeCajeroMECompraEsp & "', '" & gOpeCajeroMEVentaEsp & "') AND" _
             & " LEFT (M.cMovNro, 8) >= '" & Format(pdIni, "YYYYMMdd") & "' and LEFT (M.cMovNro, 8) <='" & Format(pdFin, "YYYYMMdd") & "' AND M.nMovFlag = " & MovFlag.gMovFlagVigente _
             & "  " & sqlAdd _
             & " ORDER BY M.cOpeCod"
            
            'Left(M.cMovNro,8) BETWEEN '" & Format(pdIni, gsFormatoMovFecha) & "' AND '" & Format(DateAdd("d", 1, pdFin), gsFormatoMovFecha) & "'
             
    If rsQryOpe.State = adStateOpen Then rsQryOpe.Close
    Set rsQryOpe = oCon.CargaRecordSet(lsQryOpe)
    
    If (rsQryOpe.EOF) Then
       lsRTFCaj = ""
    Else
       lsRTFCaj = PrtComVta(rsQryOpe, pdIni, pdFin)
    End If
    ComVtaME = lsRTFCaj
End Function

Private Function PrtComVta(prQryDat As ADODB.Recordset, pdIni As Date, pdFin As Date) As String

    Dim lnCarLin As Integer, i As Integer
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim lnSumMon As Currency, lnSumCon As Currency
    Dim lsCodPro As String, lsNumPag As String
    Dim lnLinPag As Integer, lnCntPag As Integer
    Dim lsSubTit As String, lsCodCta As String
    Dim lnPosDer As Integer, lsCodMon As String
    Dim lsRTFCaj As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
  
    lsNumPag = ""
    lnLinPag = 65
    lnCarLin = 112
    lsTitRp1 = "LISTADO DIARIO MONEDA EXTRANJERA " & lsAgeCod
    If pdIni = pdFin Then
        lsTitRp2 = "DEL " & Format(CDate(pdIni), "dd mmmm yyyy")
    Else
        lsTitRp2 = "DEL " & pdIni & " AL " & pdFin
    End If
    lnCntPag = 0
    
    
    With prQryDat
         Do While Not .EOF
            If !cCodOpe <> lsCodMon Then
               If !cCodOpe = gOpeCajeroMECompra Then
                    lsSubTit = " - COMPRA"
               ElseIf !cCodOpe = gOpeCajeroMECompraEsp Then
                    lsSubTit = " - COMPRA ESPECIAL"
               ElseIf !cCodOpe = gOpeCajeroMEVenta Then
                    lsSubTit = " - VENTA"
               ElseIf !cCodOpe = gOpeCajeroMEVentaEsp Then
                    lsSubTit = " - VENTA ESPECIAL"
               End If
               If lsNumPag <> "" Then
                  lsRTFCaj = lsRTFCaj & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                  lsRTFCaj = lsRTFCaj & "Total" & String(37, " ")
                  lsRTFCaj = lsRTFCaj & ofunc.JDNum(Trim(Str(lnSumMon)), 12, True, 9, 2) & String(13, " ")
                  lsRTFCaj = lsRTFCaj & ofunc.JDNum(Trim(Str(lnSumCon)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
                  lsRTFCaj = lsRTFCaj & String(lnCarLin, "=") & oImp.gPrnSaltoPagina
                  lsCodMon = !cCodOpe
                  lnSumMon = 0: lnSumCon = 0
               End If
               lsCodMon = !cCodOpe
               lnLinPag = 65
            End If
            
            
            If lnLinPag > 58 Then
               If lsNumPag <> "" Then
                  If lnSumMon <> 0 Or lnSumCon <> 0 Then
                     lsRTFCaj = lsRTFCaj & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                     lsRTFCaj = lsRTFCaj & "Total" & String(37, " ")
                     lsRTFCaj = lsRTFCaj & ofunc.JDNum(Trim(Str(lnSumMon)), 12, True, 9, 2) & String(13, " ")
                     lsRTFCaj = lsRTFCaj & ofunc.JDNum(Trim(Str(lnSumCon)), 12, True, 9, 2) & oImp.gPrnSaltoLinea & oImp.gPrnSaltoPagina
                  End If
                  lsCodMon = !cCodOpe
                  lnSumMon = 0: lnSumCon = 0
               End If
               
               lnCntPag = lnCntPag + 1
               lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
               lsMoneda = "SOLES"
               
               lsRTFCaj = lsRTFCaj & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1 & lsSubTit, lsTitRp2, String(7, " "), lsNumPag) & oImp.gPrnSaltoLinea
               
               lsRTFCaj = lsRTFCaj & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
               lsRTFCaj = lsRTFCaj & "NUMERO "
               lsRTFCaj = lsRTFCaj & String(12, " ") & "C L I E N T E" & String(11, " ") & "    "
               lsRTFCaj = lsRTFCaj & "DOLARES" & "    "
               lsRTFCaj = lsRTFCaj & "CAMBIO" & "          "
               lsRTFCaj = lsRTFCaj & "SOLES" & "  "
               lsRTFCaj = lsRTFCaj & "USUARIO" & "     "
               lsRTFCaj = lsRTFCaj & "FECHA / HORA" & oImp.gPrnSaltoLinea
               lsRTFCaj = lsRTFCaj & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
               lnLinPag = 9
            End If
            lsRTFCaj = lsRTFCaj & ofunc.JDNum(Trim(Str(!nNumTran)), 6, False, 6, 0) & "   "
            
            If Len(Trim(ofuni.ImpreCarEsp(ofunc.PstaNombre(!cNomPers, False)))) >= 30 Then
               lsRTFCaj = lsRTFCaj & Left(ofuni.ImpreCarEsp(ofunc.PstaNombre(!cNomPers, False)), 30) & "   "
            Else
               lsRTFCaj = lsRTFCaj & ofuni.FillText(Trim(ofuni.ImpreCarEsp(ofunc.PstaNombre(!cNomPers, False))), 30, " ") & "   "
            End If
            
            lsRTFCaj = lsRTFCaj & ofunc.JDNum(Trim(Str(!nMonTran)), 12, True, 9, 2) & "   "
            lsRTFCaj = lsRTFCaj & ofunc.JDNum(Trim(Str(!nTipCambio)), 7, True, 3, 3) & "   "
            lsRTFCaj = lsRTFCaj & ofunc.JDNum(Trim(Str(!nConv)), 12, True, 9, 2) & "   "
            lsRTFCaj = lsRTFCaj & !cCodUsu & "   "
            lsRTFCaj = lsRTFCaj & UCase(Format(!dFecTran, "dd/MM/YYYY") & " " & Format(!dFecTran, "hh:mm:ss AMPM")) & oImp.gPrnSaltoLinea
            lnSumMon = lnSumMon + !nMonTran
            lnSumCon = lnSumCon + !nConv
            lnLinPag = lnLinPag + 1
            .MoveNext
         Loop
    End With

    
    If prQryDat.EOF Then
       lsRTFCaj = lsRTFCaj & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
       lsRTFCaj = lsRTFCaj & "Total" & String(37, " ")
       lsRTFCaj = lsRTFCaj & ofunc.JDNum(Trim(Str(lnSumMon)), 12, True, 9, 2) & String(13, " ")
       lsRTFCaj = lsRTFCaj & ofunc.JDNum(Trim(Str(lnSumCon)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
       lsRTFCaj = lsRTFCaj & String(lnCarLin, "=") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoPagina
    End If
    PrtComVta = lsRTFCaj
    Set ofunc = Nothing
    Set ofuni = Nothing
    
End Function


Public Function InfCajaGeneral(Optional ByVal pdFec As Date, Optional ByVal sCodAge As String = "", Optional ByVal gdFecSis As Date) As String
    Dim sql As String
    Dim rs As New ADODB.Recordset
    Dim pR As String
    Dim BLMS As String
    Dim BLMD As String
    Dim Total As Currency
    Dim TOTALD As Currency
    Dim NegritaOn As String
    Dim NegritaOff As String
    Dim MMS(50) As String
    Dim MMD(50) As String
    Dim BMS(50) As String
    Dim BMD(50) As String
    Dim SQL1 As String
    Dim rs1 As New ADODB.Recordset
    Dim i As Integer
    Dim Check As Boolean
    Dim Check2 As Boolean
    Dim lsTitRp1 As String, lsTitRp2 As String
    Dim sCad As String
    Dim lnCarLin As Integer
    Dim bHoy As Boolean
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim ofunc As New COMFunciones.FCOMCadenas


    oCon.AbreConexion
    
    bHoy = False
    If DateDiff("d", pdFec, gdFecSis) = 0 Then bHoy = True
    If bHoy Then
        'Verifica que se haya generado el cierre de dia o el cierre de mes para generar
        'los mensajes de prevención correctos
        If CierreRealizado Then
            If VerificaDiaHabil(gdFecSis, 3) Then
                If CierreRealizado(2) Then
                    lsTitRp2 = "USO DE CONTABILIDAD Y CAJA GENERAL"
                Else
                    lsTitRp2 = "NO VALIDO (ANTES DEL CIERRE DEL MES)"
                End If
            Else
                lsTitRp2 = "USO DE CONTABILIDAD Y CAJA GENERAL"
            End If
        Else
            lsTitRp2 = "NO VALIDO (ANTES DEL CIERRE DEL DIA)"
        End If
    Else
        lsTitRp2 = UCase(Format$(pdFec, "dd mmmm yyyy"))
    End If
    
    'Obtiene el nombre de las monedas en soles
    SQL1 = "Select nEfectivoValor from Efectivo Where cEfectivoCod Like '1M%' Order By nEfectivoValor Desc"
    Set rs1 = oCon.CargaRecordSet(SQL1)
    i = 1
    If rs1.EOF And rs1.BOF Then
     MMS(1) = 0
    Else
        Do While Not rs1.EOF
           MMS(i) = Trim(rs1!nEfectivoValor)
           rs1.MoveNext
           i = i + 1
        Loop
    End If
    rs1.Close
    'Obtiene el nombre de las Monedas Dolares
    SQL1 = "Select nEfectivoValor from Efectivo Where cEfectivoCod Like '2M%' Order By nEfectivoValor Desc"
    Set rs1 = oCon.CargaRecordSet(SQL1)
    i = 1
    If (rs1.EOF) Then
     MMD(1) = 0
    Else
        Do While Not rs1.EOF
           MMD(i) = Trim(rs1!nEfectivoValor)
           rs1.MoveNext
           i = i + 1
        Loop
    End If
    rs1.Close
    
    'Obtiene el nombre de las Billetes Soles
    SQL1 = "Select nEfectivoValor from Efectivo Where cEfectivoCod Like '1B%' Order By nEfectivoValor Desc"
    Set rs1 = oCon.CargaRecordSet(SQL1)
    i = 1
    If (rs1.EOF) Then
     BMS(1) = 0
    Else
        Do While Not rs1.EOF
           BMS(i) = Trim(rs1!nEfectivoValor)
           rs1.MoveNext
           i = i + 1
        Loop
    End If
    rs1.Close
    
    'Obtiene el nombre de las Billetes Dolares
    SQL1 = "Select nEfectivoValor from Efectivo Where cEfectivoCod Like '2B%' Order By nEfectivoValor Desc"
    Set rs1 = oCon.CargaRecordSet(SQL1)
    i = 1
    If (rs1.EOF) Then
     BMD(1) = 0
    Else
        Do While Not rs1.EOF
           BMD(i) = Trim(rs1!nEfectivoValor)
           rs1.MoveNext
           i = i + 1
        Loop
    End If
    rs1.Close
    
    NegritaOn = gPrnBoldON
    NegritaOff = gPrnBoldOFF
    TB = 0
    TBD = 0
    lnCarLin = 122
    
    Dim ClsAge As COMDConstantes.DCOMAgencias
    Set ClsAge = New COMDConstantes.DCOMAgencias
    
    
    
    lsTitRp1 = "INFORME PARA CAJA GENERAL " & IIf(sCodAge <> "", " - " & ClsAge.NombreAgencia(sCodAge), "")
    sCad = sCad & CabeRepo("", "", lnCarLin, "", lsTitRp1, lsTitRp2, "", "") & oImp.gPrnSaltoLinea
    
    '*** AHORROS SOLES y DOLARES*****************************************************
    sCad = sCad & NegritaOn & "I ." & Space(2) & "AHORROS" & NegritaOff & oImp.gPrnSaltoLinea
    sCad = sCad & NegritaOn & Space(3) & "1.1  Moneda Nacional  " & Space(10) & "#" & Space(15) & "Saldos"
    sCad = sCad & Space(5) & "1.2  Moneda Extranjera" & Space(13) & "#" & Space(15) & "Saldos" & NegritaOff & oImp.gPrnSaltoLinea
    sCad = sCad & Ahorros(pdFec, sCodAge)
    sCad = sCad & oImp.gPrnSaltoLinea
    
      '****CREDITOS SOLES Y DOLARES ****
    sCad = sCad & NegritaOn & "II. " & "CREDITOS" & NegritaOff & oImp.gPrnSaltoLinea
    sCad = sCad & NegritaOn & Space(3) & "2.1  Moneda Nacional  " & Space(10) & "#" & Space(15) & "Saldos"
    sCad = sCad & Space(5) & "2.2  Moneda Extranjera" & Space(13) & "#" & Space(15) & "Saldos" & NegritaOff & oImp.gPrnSaltoLinea
    sCad = sCad & Creditos(pdFec)
    sCad = sCad & oImp.gPrnSaltoLinea
    
    '********** PRENDARIO *************************
    sCad = sCad & NegritaOn & "III." & Space(2) & "CREDITO PRENDARIO" & Space(12) & "#" & Space(10) & "Gramos" & Space(10) & "Saldos" + NegritaOff & oImp.gPrnSaltoLinea
     pR = DP("V", pdFec)
    sCad = sCad & Space(8) & "Cred. Vigentes    " & Space(2) & ofunc.JDNum(pR, 10, False, 8, 0) & Space(4) & ofunc.JDNum(NumP, 12, False, 12, 2) & Space(4) & ofunc.JDNum(SalP, 13, True, 11, 2) & oImp.gPrnSaltoLinea
     pR = DP("A", pdFec)
    sCad = sCad & Space(8) & "Cred. Adjudicados " & Space(2) & ofunc.JDNum(pR, 10, False, 8, 0) & Space(4) & ofunc.JDNum(NumP, 12, False, 12, 2) & Space(4) & ofunc.JDNum(SalP, 13, True, 11, 2) & oImp.gPrnSaltoLinea
     pR = DP("D", pdFec)
    sCad = sCad & Space(8) & "Cred. Diferidos   " & Space(2) & ofunc.JDNum(pR, 10, False, 8, 0) & Space(4) & ofunc.JDNum(NumP, 12, False, 12, 2) & Space(4) & ofunc.JDNum(SalP, 13, True, 11, 2) & oImp.gPrnSaltoLinea
         
    '************CAJA ******************
    sCad = sCad & NegritaOn & "IV. " & Space(3) & "CAJA" + NegritaOff & oImp.gPrnSaltoLinea
    'MONEDA NACIONAL
    sCad = sCad & NegritaOn & Space(3) & "4.1  Moneda Nacional" & Space(43) & "4.2  Moneda Extranjera" + NegritaOff & oImp.gPrnSaltoLinea
    'BILLETES SOLES
    sCad = sCad & Space(8) & "Billetes" & Space(53) & "Billetes" & oImp.gPrnSaltoLinea

    For i = 1 To 50
     If BMS(i) <> "" And BMD(i) <> "" Then
     BLMS = BL("1", BMS(i), "B", pdFec)
     BLMD = BL("2", BMD(i), "B", pdFec)
     
     sCad = sCad & Space(13) & ofunc.JDNum(BMS(i), 8, True, 6, 2) & Space(10) & ofunc.JDNum(Str(CA), 9, True, 9, 0) & Space(4) & ofunc.JDNum(BLMS, 13, True, 11, 2) & Space(15) & ofunc.JDNum(BMD(i), 8, True, 6, 2) & Space(10) & ofunc.JDNum(Str(CAE), 9, True, 9, 0) & Space(4) & ofunc.JDNum(BLMD, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    Else
        If BMS(i) = "" And BMD(i) = "" Then
         Exit For
        End If
        If BMS(i) = "" Then
        BLMD = BL("2", BMD(i), "B", pdFec)
        sCad = sCad & Space(72) & ofunc.JDNum(BMD(i), 8, True, 6, 2) & Space(10) & ofunc.JDNum(Str(CAE), 9, True, 9, 0) & Space(4) & ofunc.JDNum(BLMD, 13, True, 11, 2) & oImp.gPrnSaltoLinea
        End If
        If BMD(i) = "" Then
        BLMS = BL("1", BMS(i), "B", pdFec)
        sCad = sCad & Space(13) & ofunc.JDNum(BMS(i), 8, True, 6, 2) & Space(10) & ofunc.JDNum(Str(CA), 9, True, 9, 0) & Space(4) & ofunc.JDNum(BLMS, 13, True, 11, 2)
        End If
    End If
    Next
    sCad = sCad & NegritaOn & Space(13) & "Total Billetes " & Space(16) & ofunc.JDNum(Str(TB), 13, True, 11, 2) & Space(13) & "Total Billetes " & Space(18) & ofunc.JDNum(Str(TBD), 13, True, 11, 2) & NegritaOff & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    Total = Total + TB
    TOTALD = TOTALD + TBD
    TB = 0
    TBD = 0
    
    
    sCad = sCad & Space(8) & "Monedas " & Space(53) & "Monedas " & oImp.gPrnSaltoLinea
    For i = 1 To 50
        If MMS(i) <> "" And MMD(i) <> "" Then
          BLMS = BL("1", MMS(i), "M", pdFec)
          BLMD = BL("2", MMD(i), "M", pdFec)
          sCad = sCad & Space(13) & ofunc.JDNum(MMS(i), 8, True, 6, 2) & Space(10) & ofunc.JDNum(Str(CA), 9, True, 9, 0) & Space(4) & ofunc.JDNum(BLMS, 13, True, 11, 2) & Space(15) & ofunc.JDNum(MMD(i), 8, True, 6, 2) & Space(10) & ofunc.JDNum(Str(CAE), 9, True, 9, 0) & Space(4) & ofunc.JDNum(BLMD, 13, True, 11, 2) & oImp.gPrnSaltoLinea
         Else
            If MMS(i) = "" And MMD(i) = "" Then
              Exit For
            End If
            If MMS(i) = "" Then
            BLMD = BL("2", MMD(i), "M", pdFec)
            sCad = sCad & Space(72) & ofunc.JDNum(MMD(i), 8, True, 6, 2) & Space(10) & ofunc.JDNum(Str(CAE), 9, True, 9, 0) & Space(4) & ofunc.JDNum(BLMD, 13, True, 11, 2) & oImp.gPrnSaltoLinea
            End If
            If MMD(i) = "" Then
            BLMS = BL("1", MMS(i), "M", pdFec)
            sCad = sCad & Space(13) & ofunc.JDNum(MMS(i), 8, True, 6, 2) & Space(10) & ofunc.JDNum(Str(CA), 9, True, 9, 0) & Space(4) & ofunc.JDNum(BLMS, 13, True, 11, 2) & oImp.gPrnSaltoLinea
            End If
        End If
    Next
    sCad = sCad & NegritaOn & Space(14) & "Total Monedas " & Space(16) & ofunc.JDNum(Str(TB), 13, True, 11, 2) & Space(14) & "Total Monedas " & Space(18) & ofunc.JDNum(Str(TBD), 13, True, 11, 2) & NegritaOff & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    Total = Total + TB
    TOTALD = TOTALD + TBD
    sCad = sCad & NegritaOn & Space(14) & "         TOTAL" & Space(16) & ofunc.JDNum(Str(Total), 13, True, 11, 2) & Space(14) & "        TOTAL " & Space(16) & ofunc.JDNum(Str(TOTALD), 13, True, 11, 2) + NegritaOff & oImp.gPrnSaltoLinea
    sCad = sCad & oImp.gPrnSaltoPagina
    Set ofunc = Nothing
    InfCajaGeneral = sCad
End Function


Public Function SaldosDiarios(ByVal dFec As Date, ByVal sAgecod As String, _
    ByVal sAgeNom As String, ByVal bHoy As Boolean, ByVal sNomCmac As String) As String
    Dim cad As String
    Dim NON As String, lsQryOpe As String
    Dim NOF As String, rsQryOpe2 As ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    
    Set oCon = New COMConecta.DCOMConecta
    
    Dim nNorCpaVta(0 To 1) As Currency
    Dim nPromedio(0 To 1) As Currency
    Dim nMayor(0 To 1) As Currency
    Dim nMenor(0 To 1) As Currency
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim ofunf As New COMFunciones.FCOMFechas
    
    NON = gPrnBoldON
    NOF = gPrnBoldOFF
    cad = cad & NON & sNomCmac & oImp.gPrnSaltoLinea
    cad = cad & sAgeNom & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    cad = cad & "A:        CONTABILIDAD -  " & ldFecRepo & oImp.gPrnSaltoLinea
    cad = cad & "DE:       " + UCase(sAgeNom) & Space(20) & "Fecha : " + UCase(ofunf.ArmaFecha(dFec)) + NOF & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    cad = cad & String(80, "=") & oImp.gPrnSaltoLinea
    cad = cad & NON & Space(25) & "SALDOS DIARIOS DE MONEDA EXTRANJERA" + NOF & oImp.gPrnSaltoLinea
    cad = cad & String(80, "=") & oImp.gPrnSaltoLinea
    cad = cad & Space(35) & "EN U.S DOLARES " & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    cad = cad & "1. CAJA             " & Space(40) & ofunc.JDNum(DCaja(dFec, sAgecod), 13, True, 11, 2) & oImp.gPrnSaltoLinea
    cad = cad & "2. COLOCACIONES     " & Space(40) & ofunc.JDNum(DColocaciones(dFec, sAgecod, , bHoy), 13, True, 11, 2) & oImp.gPrnSaltoLinea
    cad = cad & "3. DEPOSITOS DE AHORRO" & Space(38) & ofunc.JDNum(DAhorro(dFec, sAgecod, , bHoy), 13, True, 11, 2) & oImp.gPrnSaltoLinea
    cad = cad & "4. DEPOSITOS A PLAZO" & Space(40) & ofunc.JDNum(DPlazo(dFec, sAgecod, , bHoy), 13, True, 11, 2) & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    cad = cad & String(80, "=") & oImp.gPrnSaltoLinea
    cad = cad & Space(25) + NON & "REPORTE DE COMPRA Y VENTA DE DOLARES" + NOF & oImp.gPrnSaltoLinea
    cad = cad & String(80, "=") & oImp.gPrnSaltoLinea

    cad = cad & NON & "REPORTE DE COMPRAS:" + NOF & oImp.gPrnSaltoLinea
    cad = cad & oImp.gPrnSaltoLinea
    cad = cad & Space(5) & "CANTIDAD COMPRADA EN DOLARES" & Space(27) & ofunc.JDNum(CompraVenta("C", dFec), 13, True, 11, 2) & oImp.gPrnSaltoLinea
    cad = cad & Space(5) & "IMPORTE PAGADO EN SOLES     " & Space(27) & ofunc.JDNum(ImpSoles, 13, True, 11, 2) & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea

    cad = cad & NON & "REPORTE DE VENTAS:" + NOF & oImp.gPrnSaltoLinea
    cad = cad & oImp.gPrnSaltoLinea
    cad = cad & Space(5) & "CANTIDAD VENDIDA EN DOLARES " & Space(27) & ofunc.JDNum(CompraVenta("V", dFec), 13, True, 11, 2) & oImp.gPrnSaltoLinea
    cad = cad & Space(5) & "IMPORTE COBRADO EN SOLES    " & Space(27) & ofunc.JDNum(ImpSoles, 13, True, 11, 2) & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    cad = cad & NON & "TIPOS DE CAMBIO DEL DIA" + NOF & oImp.gPrnSaltoLinea
    cad = cad & oImp.gPrnSaltoLinea
    cad = cad & "TIPO DE CAMBIO DE COMPRA    " & oImp.gPrnSaltoLinea
    TCambio dFec
    For i = 1 To K - 1
        cad = cad & Space(5) & "Hora:  " + DHora(i) & Space(40) & ofunc.JDNum(tc(i), 8, True, 6, 2) & ofunc.JDNum(TCE(i), 8, True, 6, 2) & oImp.gPrnSaltoLinea
    Next
        cad = cad & "TIPO DE CAMBIO DE VENTA     " & oImp.gPrnSaltoLinea
    For i = 1 To K - 1
        cad = cad & Space(5) & "Hora:  " + DHora(i) & Space(40) & ofunc.JDNum(TV(i), 8, True, 6, 2) & ofunc.JDNum(TVE(i), 8, True, 6, 2) & oImp.gPrnSaltoLinea
    Next
    
   
    lsQryOpe = ""
    lsQryOpe = " Select case when vv.cOpeCod in (900022, 900025,400011, 400013) THEN 'C' "
    lsQryOpe = lsQryOpe & "      Else 'V' End cTipo, SUM(vv.nMovImporte) nMonto,"
    lsQryOpe = lsQryOpe & "      Round(SUM(vv.nMovImporte * nMovTpoCambio) / SUM(nMovImporte),4) nPromedio, Max(nMovTpoCambio) nMayor, Min(nMovTpoCambio) nMenor"
    lsQryOpe = lsQryOpe & " FROM ("
    lsQryOpe = lsQryOpe & " select m.copecod, mcv.nMovImporte, mtc.nMovTpoCambio"
    lsQryOpe = lsQryOpe & " from mov m join movcompraventa mcv on mcv.nmovnro = m.nmovnro"
    lsQryOpe = lsQryOpe & "    left join movtpocambio mtc on mtc.nmovnro = m.nmovnro"
    lsQryOpe = lsQryOpe & " where copecod like '90002%' and left(cmovnro,8) = '" & Format(dFec, "YYYYMMdd") & "'  and m.nmovestado = 10 and m.nmovflag = 0"
    lsQryOpe = lsQryOpe & " Union All"
    lsQryOpe = lsQryOpe & " select m.copecod, me.nMovMEImporte, mtc.nMovTpoCambio "
    lsQryOpe = lsQryOpe & " from mov m join movcta mc on mc.nmovnro = m.nmovnro "
    lsQryOpe = lsQryOpe & "      join movme me on me.nmovnro = mc.nmovnro and me.nmovitem = mc.nmovitem "
    lsQryOpe = lsQryOpe & "      join movtpocambio mtc on mtc.nmovnro = m.nmovnro "
    lsQryOpe = lsQryOpe & " where  left(cmovnro,8) >= '" & Format(pdIni, "YYYYMMdd") & "' and left(cmovnro,8)<= '" & Format(pdFin, "YYYYMMdd") & "' and m.copecod like '4000%' and m.nmovflag = 0"
    lsQryOpe = lsQryOpe & " and me.nmovmeimporte > 0 "
    lsQryOpe = lsQryOpe & " ) VV "
    lsQryOpe = lsQryOpe & " group by case when vv.cOpeCod in (900022, 900025,400011, 400013) THEN 'C' "
    lsQryOpe = lsQryOpe & "    Else 'V' End "
    
    oCon.AbreConexion
    Set rsQryOpe2 = New ADODB.Recordset
    Set rsQryOpe2 = oCon.CargaRecordSet(lsQryOpe)
    
    With rsQryOpe2
        If Not rsQryOpe2.EOF Then
                Do While Not rsQryOpe2.EOF
                    If !cTipo = "C" Then
                        nNorCpaVta(0) = !nMonto
                        nPromedio(0) = !nPromedio
                        nMayor(0) = !nMayor
                        nMenor(0) = !nMenor
                    Else
                        nNorCpaVta(1) = !nMonto
                        nPromedio(1) = !nPromedio
                        nMayor(1) = !nMayor
                        nMenor(1) = !nMenor
                    End If
                    .MoveNext
                Loop
         End If
    End With
 rsQryOpe2.Close
 oCon.CierraConexion
 Set oCon = Nothing
    
    cad = cad & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    cad = cad & String(80, "=") & oImp.gPrnSaltoLinea
    cad = cad & NON & Space(10) & " COTIZACION DE OFERTA Y DEMANDA DE MONEDA EXTRANJERA" & NOF & oImp.gPrnSaltoLinea
    cad = cad & String(80, "=") & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    cad = cad & " DOLAR NORTEAMERICANO " & oImp.gPrnSaltoLinea & oImp.gPrnSaltoLinea
    cad = cad & "         MONTO NEGOCIADO  PROMEDIO PONDERADO      MAXIMO        MINIMO" & Chr(10)
    cad = cad & "COMPRA: " & ofuni.ImpreFormat(nNorCpaVta(0), 10, 2) & "  " & ofuni.ImpreFormat(nPromedio(0), 10, 2) & "     " & ofuni.ImpreFormat(nMayor(0), 10, 2) & "  " & ofuni.ImpreFormat(nMenor(0), 10, 2) & "  " & Chr(10)
    cad = cad & "VENTA : " & ofuni.ImpreFormat(nNorCpaVta(1), 10, 2) & "  " & ofuni.ImpreFormat(nPromedio(1), 10, 2) & "     " & ofuni.ImpreFormat(nMayor(1), 10, 2) & "  " & ofuni.ImpreFormat(nMenor(1), 10, 2) & "  " & Chr(10)
    Set ofunc = Nothing
    Set ofuni = Nothing
    Set ofunf = Nothing
 SaldosDiarios = cad
End Function


Public Function CierreRealizado(Optional pnTipo As Integer = 1) As Boolean
    Dim oConst As COMDConstSistema.NCOMConstSistema
    Set oConst = New COMDConstSistema.NCOMConstSistema
    
    If pnTipo = 1 Then
        CierreRealizado = IIf(oConst.LeeConstSistema(gConstSistCierreSistema) = oConst.LeeConstSistema(gConstSistFechaSistema), True, False)
    ElseIf pnTipo = 2 Then
        CierreRealizado = IIf(oConst.LeeConstSistema(gConstSistCierreMesNegocio) = oConst.LeeConstSistema(gConstSistFechaSistema), True, False)
    End If
End Function

Private Function VerificaDiaHabil(ByVal pdFecha As Date, pnTipo As Integer) As Boolean
    Dim lsFchPro As String
    Dim ldFchPro As Date
    Dim lnMes As Integer
    Dim ldAno As Date
    Dim ofunc As New COMFunciones.FCOMCadenas
    ldAno = pdFecha
    lnMes = Month(pdFecha)
    If lnMes = 12 Then
        lnMes = 0
        ldAno = DateAdd("yyyy", 1, ldAno)
    End If
Select Case pnTipo
    Case 1
    '   Busca Primer día del mes
        lsFchPro = "01" & "/" & ofunc.FillNum(Trim(Str(lnMes + 1)), 2, "0") & "/" & Trim(Str(Year(ldAno)))
        ldFchPro = CDate(lsFchPro)
    Case 2
    '   Busca día anterior al último día del mes para procesar descuento por Inactivas
        lsFchPro = "01" & "/" & ofunc.FillNum(Trim(Str(lnMes + 1)), 2, "0") & "/" & Trim(Str(Year(ldAno)))
        ldFchPro = DateAdd("d", -2, CDate(lsFchPro))
    Case 3
    '   Busca ultimo día del mes para procesar Cierre de Mes
        lsFchPro = "01" & "/" & ofunc.FillNum(Trim(Str(lnMes + 1)), 2, "0") & "/" & Trim(Str(Year(ldAno)))
        ldFchPro = DateAdd("d", -1, CDate(lsFchPro))
End Select
If pdFecha = ldFchPro Then
    VerificaDiaHabil = True
Else
    VerificaDiaHabil = False
End If
End Function


Private Function Ahorros(ByVal pdFec As Date, Optional ByVal sCodAge As String = "") As String
    Dim TotalAMN As Double, TotalAME As Double
    Dim TotalAIMN As Double, TotalAIME As Double
    Dim SalAIMN As Double, SalAIME As Double
    Dim sCad As String
    Dim TcMN As Double, TcME As Double ' TOTAL CHEQUES
    Dim NegritaOn As String
    Dim NegritaOff As String
    NegritaOn = gPrnBoldON
    NegritaOff = gPrnBoldOFF
    Dim RegMN As Long, RegME As Long
    Dim SaldCmact As String
    Dim RegCmacS As Integer
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim oDCtaCont As COMFunciones.FCOMFechas
    Dim nSaldCont As Currency
    TotalAIMN = 0
    TotalAIME = 0
    SalAIMN = 0
    SalAIME = 0


    'Inicializamos las variables de totales
    TotalAMN = 0: TotalAME = 0
    TcMN = 0: TcME = 0
    RegMN = 0: RegME = 0
    sCad = ""
    '************ Depositos de Ahorro y CPE/Recursos Propios ****************'
    'Cajas Municipales : Depósitos de Ahorros
    SaldCmact = SaldosInstFinanc(gMonedaNacional, pdFec, Producto.gCapAhorros, gPersonaJurCFLCMAC, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "CMACS Dep. Ahorros  " & Space(5) & ofunc.JDNum(Str(RegCmacS), 6, False, 6, 0) & Space(7) & ofunc.JDNum(SaldCmact, 13, True, 11, 2)
    TotalAIMN = TotalAIMN + RegCmacS
    SalAIMN = SalAIMN + SaldCmact
    
    SaldCmact = SaldosInstFinanc(gMonedaExtranjera, pdFec, Producto.gCapAhorros, gPersonaJurCFLCMAC, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "CMACS Dep. Ahorros  " & Space(5) & ofunc.JDNum(Str(RegCmacS), 9, False, 9, 0) & Space(8) & ofunc.JDNum(SaldCmact, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    
    TotalAIME = TotalAIME + RegCmacS
    SalAIME = SalAIME + SaldCmact
    
    'Cajas Municipales : Depósitos a Plazo
    SaldCmact = SaldosInstFinanc(gMonedaNacional, pdFec, Producto.gCapPlazoFijo, gPersonaJurCFLCMAC, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "CMACS Dep. a Plazo  " & Space(5) & ofunc.JDNum(Str(RegCmacS), 6, False, 6, 0) & Space(7) & ofunc.JDNum(SaldCmact, 13, True, 11, 2)
    
    TotalAIMN = TotalAIMN + RegCmacS
    SalAIMN = SalAIMN + SaldCmact
    
    SaldCmact = SaldosInstFinanc(gMonedaExtranjera, pdFec, Producto.gCapPlazoFijo, gPersonaJurCFLCMAC, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "CMACS Dep. a Plazo  " & Space(5) & ofunc.JDNum(Str(RegCmacS), 9, False, 9, 0) & Space(8) & ofunc.JDNum(SaldCmact, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    
    TotalAIME = TotalAIME + RegCmacS
    SalAIME = SalAIME + SaldCmact
    
    
    'Otras Instituciones Financieras : Depósitos de Ahorros
    RegCmacS = 0
    RegCmacStemp = 0
    
    SaldCmact = SaldosInstFinanc(gMonedaNacional, pdFec, Producto.gCapAhorros, gPersonaJurCFLCRAC, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "CRAC Dep. Ahorros   " & Space(5) & ofunc.JDNum(Str(RegCmacS), 6, False, 6, 0) & Space(7) & ofunc.JDNum(SaldCmact, 13, True, 11, 2)
    TotalAIMN = TotalAIMN + RegCmacS
    SalAIMN = SalAIMN + SaldCmact
    
           
    SaldCmact = SaldosInstFinanc(gMonedaExtranjera, pdFec, Producto.gCapAhorros, gPersonaJurCFLCRAC, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "CRAC Dep. Ahorros   " & Space(5) & ofunc.JDNum(Str(RegCmacS), 9, False, 9, 0) & Space(8) & ofunc.JDNum(SaldCmact, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    TotalAIME = TotalAIME + RegCmacS
    SalAIME = SalAIME + SaldCmact
    
    
    'Otras Instituciones Financieras : Depósitos de Ahorros
    SaldCmact = SaldosInstFinanc(gMonedaNacional, pdFec, Producto.gCapPlazoFijo, gPersonaJurCFLCRAC, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "CRAC Dep. a Plazo   " & Space(5) & ofunc.JDNum(Str(RegCmacS), 6, False, 6, 0) & Space(7) & ofunc.JDNum(SaldCmact, 13, True, 11, 2)
    TotalAIMN = TotalAIMN + RegCmacS
    SalAIMN = SalAIMN + SaldCmact
    
    
    SaldCmact = SaldosInstFinanc(gMonedaExtranjera, pdFec, Producto.gCapPlazoFijo, gPersonaJurCFLCRAC, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "CRAC Dep. a Plazo   " & Space(5) & ofunc.JDNum(Str(RegCmacS), 9, False, 9, 0) & Space(8) & ofunc.JDNum(SaldCmact, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    TotalAIME = TotalAIME + RegCmacS
    SalAIME = SalAIME + SaldCmact
    
    
    'BANCOS : Depósitos de Ahorros
    RegCmacS = 0
    RegCmacStemp = 0
    
    SaldCmact = SaldosInstFinanc(gMonedaNacional, pdFec, Producto.gCapAhorros, gPersonaJurCFLFONCODES, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "BANCOS Dep. Ahorros " & Space(5) & ofunc.JDNum(Str(RegCmacS), 6, False, 6, 0) & Space(7) & ofunc.JDNum(SaldCmact, 13, True, 11, 2)
    TotalAIMN = TotalAIMN + RegCmacS
    SalAIMN = SalAIMN + SaldCmact
    
           
    SaldCmact = SaldosInstFinanc(gMonedaExtranjera, pdFec, Producto.gCapAhorros, gPersonaJurCFLFONCODES, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "BANCOS Dep. Ahorros " & Space(5) & ofunc.JDNum(Str(RegCmacS), 9, False, 9, 0) & Space(8) & ofunc.JDNum(SaldCmact, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    TotalAIME = TotalAIME + RegCmacS
    SalAIME = SalAIME + SaldCmact
    
    
    'Otras Instituciones Financieras : Depósitos de Ahorros
    SaldCmact = SaldosInstFinanc(gMonedaNacional, pdFec, Producto.gCapPlazoFijo, gPersonaJurCFLFONCODES, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "BANCOS Dep. a Plazo " & Space(5) & ofunc.JDNum(Str(RegCmacS), 6, False, 6, 0) & Space(7) & ofunc.JDNum(SaldCmact, 13, True, 11, 2)
    TotalAIMN = TotalAIMN + RegCmacS
    SalAIMN = SalAIMN + SaldCmact
    
    
    SaldCmact = SaldosInstFinanc(gMonedaExtranjera, pdFec, Producto.gCapPlazoFijo, gPersonaJurCFLFONCODES, sCodAge)
    RegCmacS = RegCmacStemp
    sCad = sCad & Space(8) & "BANCOS Dep. a Plazo " & Space(5) & ofunc.JDNum(Str(RegCmacS), 9, False, 9, 0) & Space(8) & ofunc.JDNum(SaldCmact, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    TotalAIME = TotalAIME + RegCmacS
    SalAIME = SalAIME + SaldCmact
    
    DA Producto.gCapAhorros, gMonedaNacional, pdFec, , sCodAge
    TotalAMN = TotalAMN + CCur(SalA) + SalAIMN
    RegMN = RegMN + CLng(NumA) + TotalAIMN
    sCad = sCad & Space(8) & "Depósitos de Ahorro " & Space(5) & ofunc.JDNum(NumA, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalA, 13, True, 10, 2)
    
    Set oDCtaCont = New COMFunciones.FCOMFechas
    Call oDCtaCont.InsertaCtaContSaldoDiario("2112", pdFec, "280216", SalA)
    
    
    DA Producto.gCapAhorros, gMonedaExtranjera, pdFec, , sCodAge
    RegME = RegME + CLng(NumA) + TotalAIME
    TotalAME = TotalAME + CCur(SalA) + SalAIME
    sCad = sCad & Space(8) & "Depósitos de Ahorro " & Space(5) & ofunc.JDNum(NumA, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalA, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    
    Call oDCtaCont.InsertaCtaContSaldoDiario("2122", pdFec, "280216", SalA)
    
    DA Producto.gCapPlazoFijo, gMonedaNacional, pdFec, , sCodAge
    TotalAMN = TotalAMN + CCur(SalA)
    RegMN = RegMN + CLng(NumA)
    Call oDCtaCont.InsertaCtaContSaldoDiario("2313_5", pdFec, "280216", SalA)
    sCad = sCad & Space(8) & "Depósitos a Plazo   " & Space(5) & ofunc.JDNum(NumA, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalA, 13, True, 10, 2)
    
    
    DA Producto.gCapPlazoFijo, gMonedaExtranjera, pdFec, , sCodAge
    TotalAME = TotalAME + CCur(SalA)
    RegME = RegME + CLng(NumA)
    Call oDCtaCont.InsertaCtaContSaldoDiario("2323_5", pdFec, "280216", SalA)
    sCad = sCad & Space(8) & "Depósitos a Plazo   " & Space(5) & ofunc.JDNum(NumA, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalA, 13, True, 11, 2) & oImp.gPrnSaltoLinea
       
    
    '*******PARA CTS
    DA Producto.gCapCTS, gMonedaNacional, pdFec, , sCodAge
    Call oDCtaCont.InsertaCtaContSaldoDiario("211305_6", pdFec, "280216", SalA)
    sCad = sCad & Space(8) & "Depósitos de CTS  " & Space(4) & ofunc.JDNum(NumA, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalA, 13, True, 11, 2)
    TotalAMN = TotalAMN + CCur(SalA)
    RegMN = RegMN + CLng(NumA)
    
    DA Producto.gCapCTS, gMonedaExtranjera, pdFec, , sCodAge
    Call oDCtaCont.InsertaCtaContSaldoDiario("212305_6", pdFec, "280216", SalA)
    sCad = sCad & Space(7) & "Depósitos a CTS  " & Space(10) & ofunc.JDNum(NumA, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalA, 13, True, 10, 2) & oImp.gPrnSaltoLinea
    TotalAME = TotalAME + CCur(SalA)
    RegME = RegME + CLng(NumA)
          
    '*******PARA CTS
     
    DA "Cheques", gMonedaNacional, pdFec, Producto.gCapAhorros, sCodAge
    RegMN = RegMN + CLng(NumA)
    TcMN = TcMN + CCur(SalA)
    Call oDCtaCont.InsertaCtaContSaldoDiario("111601_7", pdFec, "280216", SalA)
    sCad = sCad & Space(8) & "AC/Cheques Valorización" & Space(2) & ofunc.JDNum(NumA, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalA, 13, True, 10, 2)
    DA "Cheques", gMonedaExtranjera, pdFec, Producto.gCapAhorros, sCodAge
    RegME = RegME + CLng(NumA)
    TcME = TcME + CCur(SalA)
    Call oDCtaCont.InsertaCtaContSaldoDiario("112601_7", pdFec, "280216", SalA)
    sCad = sCad & Space(8) & "AC/Cheques Valorización" & Space(2) & ofunc.JDNum(NumA, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalA, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    DA "Cheques", gMonedaNacional, pdFec, Producto.gCapPlazoFijo, sCodAge
    TcMN = TcMN + CCur(SalA)
    RegMN = RegMN + CLng(NumA)
    Call oDCtaCont.InsertaCtaContSaldoDiario("111602_8", pdFec, "280216", SalA)
    sCad = sCad & Space(8) & "PF/Cheques Valorización" & Space(2) & ofunc.JDNum(NumA, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalA, 13, True, 10, 2)
    DA "Cheques", gMonedaExtranjera, pdFec, Producto.gCapPlazoFijo, sCodAge
    TcME = TcME + CCur(SalA)
    RegME = RegME + CLng(NumA)
    Call oDCtaCont.InsertaCtaContSaldoDiario("112602_8", pdFec, "280216", SalA)
    sCad = sCad & Space(8) & "PF/Cheques Valorización" & Space(2) & ofunc.JDNum(NumA, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalA, 13, False, 11, 2) & oImp.gPrnSaltoLinea
    DA "Cheques", gMonedaNacional, pdFec, Producto.gCapCTS, sCodAge
    TcMN = TcMN + CCur(SalA)
    RegMN = RegMN + CLng(NumA)
    Call oDCtaCont.InsertaCtaContSaldoDiario("111603_9", pdFec, "280216", SalA)
    sCad = sCad & Space(8) & "CTS/Cheques Valorización" & Space(1) & ofunc.JDNum(NumA, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalA, 13, True, 10, 2)
    DA "Cheques", gMonedaExtranjera, pdFec, Producto.gCapCTS, sCodAge
    TcME = TcME + CCur(SalA)
    RegME = RegME + CLng(NumA)
    Call oDCtaCont.InsertaCtaContSaldoDiario("112603_9", pdFec, "280216", SalA)
    sCad = sCad & Space(8) & "CTS/Cheques Valorización" & Space(1) & ofunc.JDNum(NumA, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalA, 13, False, 11, 2) & oImp.gPrnSaltoLinea
       
    
    
    TotalAMN = TotalAMN - TcMN
    TotalAME = TotalAME - TcME
    
    sCad = sCad & NegritaOn & Space(15) & "Total Disp." & Space(4) & ofunc.JDNum(Str(RegMN), 10, False, 10, 0) & Space(7) & ofunc.JDNum(Str(TotalAMN), 13, True, 10, 2)
    sCad = sCad & Space(20) & "Total Disp." & Space(3) & ofunc.JDNum(Str(RegME), 9, False, 9, 0) & Space(8) & ofunc.JDNum(Str(TotalAME), 13, True, 11, 2) & oImp.gPrnSaltoLinea
    sCad = sCad & NegritaOn & Space(15) & "Total Cont." & Space(4) & ofunc.JDNum(Str(RegMN), 10, False, 10, 0) & Space(7) & ofunc.JDNum(Str(TotalAMN + TcMN), 13, True, 10, 2)
    sCad = sCad & Space(20) & "Total Cont." & Space(3) & ofunc.JDNum(Str(RegME), 9, False, 9, 0) & Space(8) & ofunc.JDNum(Str(TotalAME + TcME), 13, True, 11, 2) & oImp.gPrnSaltoLinea
    
    
    'Devuelve la cadena generada
    Ahorros = sCad
End Function


Private Function Creditos(ByVal pdFec As Date) As String
    Dim sCad As String
    Dim TotalCMN As Double, TotalCME As Double
    Dim stCPEMN As Double, stCPEME As Double
    Dim stPPMN As Double, stPPME As Double
    Dim NegritaOn As String
    Dim NegritaOff As String
    Dim RegCMN As Long, RegCME As Long
    Dim stRegCPEMN As Long, stRegCPEME As Long
    Dim stRegPPMN As Long, stRegPPME As Long
    Dim ofunc As New COMFunciones.FCOMCadenas
    NegritaOn = gPrnBoldON
    NegritaOff = gPrnBoldOFF
    
    stCPEMN = 0: stCPEME = 0
    stPPMN = 0: stPPME = 0
    TotalCMN = 0: TotalCME = 0
    stRegCPEMN = 0: stRegCPEME = 0
    stRegPPMN = 0: stRegPPME = 0
    RegCMN = 0: RegCME = 0
    '************ CPE/Recursos Propios ****************'
    DC "2", "01", "1", pdFec      'CPE/Rec Prop
    TotalCMN = TotalCMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    stRegCPEMN = stRegCPEMN + CLng(NumC)
    stCPEMN = stCPEMN + CCur(SalC)
    sCad = sCad & Space(8) & "CPE/Recursos Propios" & Space(5) & ofunc.JDNum(NumC, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "2", "01", "2", pdFec  'CPE/Rec Prop
    TotalCME = TotalCME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    stRegCPEME = stRegCPEME + CLng(NumC)
    stCPEME = stCPEME + CCur(SalC)
    sCad = sCad & Space(8) & "CPE/Recursos Propios" & Space(5) & ofunc.JDNum(NumC, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, True, 11, 2) & oImp.gPrnSaltoLinea
      
    DC "2", "02", "1", pdFec  ' CPE/Foncode
    TotalCMN = TotalCMN + CCur(SalC)
    stRegCPEMN = stRegCPEMN + CLng(NumC)
    stCPEMN = stCPEMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    sCad = sCad & Space(8) & "CPE/Foncodes        " & Space(5) & ofunc.JDNum(NumC, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "2", "02", "2", pdFec ' CPE/Foncode
    TotalCME = TotalCME + CCur(SalC)
    stRegCPEME = stRegCPEME + CLng(NumC)
    stCPEME = stCPEME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    sCad = sCad & Space(8) & "CPE/Foncodes        " & Space(5) & ofunc.JDNum(NumC, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, True, 11, 2) & oImp.gPrnSaltoLinea
      
    DC "2','4", "02', '03','05','07", "1", pdFec  ' CPE/Cofide -- CPE/Cofide Microglobal / CPE/PROPEM
    TotalCMN = TotalCMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    stRegCPEMN = stRegCPEMN + CLng(NumC)
    stCPEMN = stCPEMN + CCur(SalC)
    sCad = sCad & Space(8) & "CPE/Cofide          " & Space(5) & ofunc.JDNum(NumC, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "2','4", "02', '03','05','07", "2", pdFec   ' CPE/Cofide -- CPE/Cofide Microglobal
    TotalCME = TotalCME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    stRegCPEME = stRegCPEME + CLng(NumC)
    stCPEME = stCPEME + CCur(SalC)
    sCad = sCad & Space(8) & "CPE/Cofide          " & Space(5) & ofunc.JDNum(NumC, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, True, 11, 2) & oImp.gPrnSaltoLinea
     
    DC "2", "04", "1", pdFec   ' CPE/BID
    TotalCMN = TotalCMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    stRegCPEMN = stRegCPEMN + CLng(NumC)
    stCPEMN = stCPEMN + CCur(SalC)
    sCad = sCad & Space(8) & "CPE/BID             " & Space(5) & ofunc.JDNum(NumC, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "2", "04", "2", pdFec  ' CPE/BID
    TotalCME = TotalCME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    stRegCPEME = stRegCPEME + CLng(NumC)
    stCPEME = stCPEME + CCur(SalC)
    sCad = sCad & Space(8) & "CPE/BID             " & Space(5) & ofunc.JDNum(NumC, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, True, 11, 2) & oImp.gPrnSaltoLinea
      
    DC "2", "06", "1", pdFec  'CPE/Habitat  ' Nuevo
    TotalCMN = TotalCMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    stRegCPEMN = stRegCPEMN + CLng(NumC)
    stCPEMN = stCPEMN + CCur(SalC)
    sCad = sCad & Space(8) & "CPE/Habitat Prod.   " & Space(5) & ofunc.JDNum(NumC, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "2", "06", "2", pdFec  'CPE/Habitat  ' Nuevo
    TotalCME = TotalCME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    stRegCPEME = stRegCPEME + CLng(NumC)
    stCPEME = stCPEME + CCur(SalC)
    sCad = sCad & Space(8) & "CPE/Habitat Prod.   " & Space(5) & ofunc.JDNum(NumC, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, False, 11, 2) & oImp.gPrnSaltoLinea
    
    'Sub Total CPE
    sCad = sCad & Space(15) & NegritaOn & "Sub Total" & Space(9) & ofunc.JDNum(Str(stRegCPEMN), 6, False, 6, 0) & Space(7) & ofunc.JDNum(Str(stCPEMN), 13, True, 11, 2)
    sCad = sCad & Space(15) & "Sub Total" & Space(8) & ofunc.JDNum(Str(stRegCPEME), 10, False, 10, 0) & Space(8) & ofunc.JDNum(Str(stCPEME), 13, True, 11, 2) + NegritaOff & oImp.gPrnSaltoLinea
    
    DC "3", "01", "1", pdFec   ' PP/Dscto Planill
    TotalCMN = TotalCMN + CCur(SalC)
    stPPMN = stPPMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    stRegPPMN = stRegPPMN + CLng(NumC)
    sCad = sCad & Space(8) & "PP/Prestamo Consumo " & Space(5) & ofunc.JDNum(NumC, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "3", "01", "2", pdFec ' Creditos Conumo --PP/Dscto Planill
    TotalCME = TotalCME + CCur(SalC)
    stPPME = stPPME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    stRegPPME = stRegPPME + CLng(NumC)
    sCad = sCad & Space(8) & "PP/Prestamo Consumo " & Space(5) & ofunc.JDNum(NumC, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    
    DC "3", "04", "1", pdFec ' PP/Usos Divers
    TotalCMN = TotalCMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    stRegPPMN = stRegPPMN + CLng(NumC)
    stPPMN = stPPMN + CCur(SalC)
    sCad = sCad & Space(8) & "PP/Usos Diversos    " & Space(5) & ofunc.JDNum(NumC, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "3", "04", "2", pdFec ' PP/Usos Divers
    TotalCME = TotalCME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    stRegPPME = stRegPPME + CLng(NumC)
    stPPME = stPPME + CCur(SalC)
    sCad = sCad & Space(8) & "PP/Usos Diversos    " & Space(5) & ofunc.JDNum(NumC, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, True, 11, 2) & oImp.gPrnSaltoLinea
     
    DC "3", "02", "1", pdFec  ' PP/PF
    TotalCMN = TotalCMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    stRegPPMN = stRegPPMN + CLng(NumC)
    stPPMN = stPPMN + CCur(SalC)
    sCad = sCad & Space(8) & "PP/Plazo Fijo       " & Space(5) & ofunc.JDNum(NumC, 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "3", "02", "2", pdFec  ' PP/PF
    TotalCME = TotalCME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    stRegPPME = stRegPPME + CLng(NumC)
    stPPME = stPPME + CCur(SalC)
    sCad = sCad & Space(8) & "PP/Plazo Fijo       " & Space(5) & ofunc.JDNum(NumC, 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    
    DC "3", "03", "1", pdFec ' PP/CTS
    TotalCMN = TotalCMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    stRegPPMN = stRegPPMN + CLng(NumC)
    stPPMN = stPPMN + CCur(SalC)
    sCad = sCad & Space(8) & "PP/CTS              " & Space(5) & ofunc.JDNum(Str(NumC), 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "3", "03", "2", pdFec ' PP/CTS
    TotalCME = TotalCME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    stRegPPME = stRegPPME + CLng(NumC)
    stPPME = stPPME + CCur(SalC)
    sCad = sCad & Space(8) & "PP/CTS              " & Space(5) & ofunc.JDNum(Str(NumC), 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    
    DC "3", "20", "1", pdFec  ' ADM/TRAB
    TotalCMN = TotalCMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    stRegPPMN = stRegPPMN + CLng(NumC)
    stPPMN = stPPMN + CCur(SalC)
    sCad = sCad & Space(8) & "ADM/Trabajador      " & Space(5) & ofunc.JDNum(Str(NumC), 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "3", "20", "2", pdFec  ' ADM/TRAB
    TotalCME = TotalCME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    stRegPPME = stRegPPME + CLng(NumC)
    stPPME = stPPME + CCur(SalC)
    sCad = sCad & Space(8) & "ADM/Trabajador      " & Space(5) & ofunc.JDNum(Str(NumC), 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    
    'Subtotal PP
    sCad = sCad & Space(15) & NegritaOn & "Sub Total" & Space(9) & ofunc.JDNum(Str(stRegPPMN), 6, False, 6, 0) & Space(7) & ofunc.JDNum(Str(stPPMN), 13, True, 11, 2)
    sCad = sCad & Space(15) & "Sub Total" & Space(8) & ofunc.JDNum(Str(stRegPPME), 10, False, 10, 0) & Space(8) & ofunc.JDNum(Str(stPPME), 13, True, 11, 2) + NegritaOff + oImp.gPrnSaltoLinea
    
    DC "A", "01", "1", pdFec  ' AGRICOLA
    TotalCMN = TotalCMN + CCur(SalC)
    RegCMN = RegCMN + CLng(NumC)
    sCad = sCad & Space(8) & "Agricola            " & Space(5) & ofunc.JDNum(Str(NumC), 6, False, 6, 0) & Space(7) & ofunc.JDNum(SalC, 13, True, 11, 2)
    DC "A", "01", "2", pdFec  ' AGRICOLA
    TotalCME = TotalCME + CCur(SalC)
    RegCME = RegCME + CLng(NumC)
    sCad = sCad & Space(8) & "Agricola            " & Space(5) & ofunc.JDNum(Str(NumC), 9, False, 9, 0) & Space(8) & ofunc.JDNum(SalC, 13, True, 11, 2) & oImp.gPrnSaltoLinea
    
    ' Total Créditos
    sCad = sCad & NegritaOn & Space(15) & "Total    " & Space(9) & ofunc.JDNum(Str(RegCMN), 6, False, 6, 0) & Space(7) & ofunc.JDNum(Str(TotalCMN), 13, True, 11, 2)
    sCad = sCad & Space(15) & "Total    " & Space(8) & ofunc.JDNum(Str(RegCME), 10, False, 10, 0) & Space(8) & ofunc.JDNum(Str(TotalCME), 13, True, 11, 2) + NegritaOff + oImp.gPrnSaltoLinea
    
    'Devuelve la cadena generada
    Creditos = sCad
End Function




Private Function DP(ByVal Estado As String, Optional ByVal dFec As Date) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim bHoy As Boolean
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    oCon.AbreConexion
    
    bHoy = True
  '  If DateDiff("d", dFec, gdFecSis) = 0 Then bHoy = True
    
    If bHoy Then
        If gsCodAge <> "" Then
            sqlAdd = " And P.cCtaCod Like '___" & Right(gsCodAge, 2) & "%' "
            
        Else
            sqlAdd = ""
        End If
    Else
        If gsCodAge <> "" Then
            sqlAdd = " And cCodAge Like '%" & Right(gsCodAge, 2) & "'"
        Else
            sqlAdd = ""
        End If
    End If
    
    Select Case Estado
        Case "V"  'Desembolsado, vencido, en remate y renovado
            If bHoy Then
                If lnTipoPigno = 2 Then
                    sql = " Select Count(*) nNum, IsNull(Sum(nOro),0) nOro, IsNull((Select Sum(PRD.nSaldo) nSaldo " _
                        & " From ColocPigno CO Inner Join Producto PRD On CO.cCtaCod = PRD.cCtaCod " _
                        & " Where PRD.nPRDEstado In ('2802','2803','2804') " & sqlAdd & "),0) nSaldo From" _
                        & " (Select CO.cCtaCod, Sum(nPesoNeto) nOro, Sum(PRD.nSaldo) nSaldo from ColocPigno CO" _
                        & " Inner Join Producto PRD On CO.cCtaCod = PRD.cCtaCod " _
                        & " Inner Join ColocPigJoyaTasacion CPT On CO.cCtaCod = CPT.cCtaCod And CO.nTipoTasacion = CPT.nTipoTasacion" _
                        & "  Where PRD.nPRDEstado In ('2802','2803','2804','2807') " & sqlAdd & " and  DateDiff(dd,prd.dprdestado,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0  Group By CO.cCtaCod) As REP"
                Else
'                    SQL = " Select Count(*) nNum, IsNull(Sum(nOro),0) nOro, IsNull(Sum(nSaldo),0) nSaldo From" _
'                        & " (Select CO.cCtaCod, Sum(nPesoNeto) nOro, Sum(PRD.nSaldo) nSaldo from ColocPigno CO" _
'                        & " Inner Join Producto PRD On CO.cCtaCod = PRD.cCtaCod " _
'                        & " Inner Join ColocPigJoyaTasacion CPT On CO.cCtaCod = CPT.cCtaCod And CO.nTipoTasacion = CPT.nTipoTasacion" _
'                        & "  Where PRD.nPRDEstado In ('2101','2104','2106','2107') " & sqlAdd & " Group By CO.cCtaCod) As REP"
                        
                        sql = " select nnum=count(*),noro=isnull(sum(oroneto),0 ),nsaldo=isnull(sum(nsaldo),0 ) "
                        sql = sql & " from (select p.cctacod,oroneto=sum(cd.npesoneto), p.nsaldo "
                        sql = sql & "    from colocpigjoyadet cd "
                        sql = sql & "     join producto p on p.cctacod=cd.cctacod "
                        sql = sql & "    where p.nprdestado In ('2101','2104','2106','2107')" & sqlAdd & "  "
                        sql = sql & "  group by p.cctacod, p.nsaldo     )  as rep "
        
                        
                        
                End If
            Else
                sql = "Select Sum(nNumCredVig) nNum, Sum(nOroVig) nOro, Sum(nCapVig) nSaldo FROM ColocEstadDiaPrenda " _
                    & " WHERE DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " & sqlAdd
            End If
           
        Case "A" ' Adjudicado
            If bHoy Then
                If lnTipoPigno = 2 Then
                    sql = " Select Count(*) nNum, IsNull(Sum(nOro),0) nOro, IsNull((Select Sum(PRD.nSaldo) nSaldo " _
                        & " From ColocPigno CO Inner Join Producto PRD On CO.cCtaCod = PRD.cCtaCod " _
                        & " Where PRD.nPRDEstado In ('2812') " & sqlAdd & "),0) nSaldo From" _
                        & " (Select CO.cCtaCod, Sum(nPesoNeto) nOro, Sum(PRD.nSaldo) nSaldo from ColocPigno CO" _
                        & " Inner Join Producto PRD On CO.cCtaCod = PRD.cCtaCod " _
                        & " Inner Join ColocPigJoyaTasacion CPT On CO.cCtaCod = CPT.cCtaCod And CO.nTipoTasacion = CPT.nTipoTasacion" _
                        & "  Where PRD.nPRDEstado In ('2812') " & sqlAdd & "   and  DateDiff(dd,prd.dprdestado,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0     Group By CO.cCtaCod) As REP"

                Else
'                    SQL = " Select Count(*) nNum, IsNull(Sum(nOro),0) nOro, IsNull(Sum(nSaldo),0) nSaldo From" _
'                        & " (Select CO.cCtaCod, Sum(nPesoNeto) nOro, Sum(PRD.nSaldo) nSaldo from ColocPigno CO" _
'                        & " Inner Join Producto PRD On CO.cCtaCod = PRD.cCtaCod " _
'                        & " Inner Join ColocPigJoyaTasacion CPT On CO.cCtaCod = CPT.cCtaCod And CO.nTipoTasacion = CPT.nTipoTasacion" _
'                        & "  Where PRD.nPRDEstado In ('2108') " & sqlAdd & " Group By CO.cCtaCod) As REP"

                      sql = " select nnum=count(*),noro=isnull(sum(oroneto),0 ),nsaldo=isnull(sum(nsaldo),0 ) "
                    sql = sql & " from (select p.cctacod,oroneto=sum(cd.npesoneto), p.nsaldo "
                    sql = sql & "    from colocpigjoyadet cd "
                    sql = sql & "     join producto p on p.cctacod=cd.cctacod "
                    sql = sql & "    where p.nprdestado='2108' " & sqlAdd & "   "
                    sql = sql & "  group by p.cctacod, p.nsaldo     )  as rep "
   


                End If
            Else
                sql = "Select Sum(nNumCredAdj) nNum, Sum(nOroAdj) nOro, Sum(nCapAdj) nSaldo FROM ColocEstadDiaPrenda " _
                    & "WHERE DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " & sqlAdd
            End If
        Case "D" 'Diferido
            If bHoy Then
                sql = "SELECT IsNull(count(cCodCta),0) nNum, IsNull(sum(nOroNeto),0) nOro, IsNull(sum(nSaldoCap),0) nSaldo " _
                    & "FROM CREDPRENDA WHERE cEstado IN ('2')"
                If lnTipoPigno = 2 Then
'                    SQL = " Select Count(*) nNum, IsNull(Sum(nOro),0) nOro, IsNull((Select Sum(PRD.nSaldo) nSaldo from ColocPigno CO Inner Join Producto PRD On CO.cCtaCod = PRD.cCtaCod Where PRD.nPRDEstado In ('2102')),0) nSaldo From" _
'                        & " (Select CO.cCtaCod, Sum(nPesoNeto) nOro, Sum(PRD.nSaldo) nSaldo from ColocPigno CO" _
'                        & " Inner Join Producto PRD On CO.cCtaCod = PRD.cCtaCod " _
'                        & " Inner Join ColocPigJoyaTasacion CPT On CO.cCtaCod = CPT.cCtaCod And CO.nTipoTasacion = CPT.nTipoTasacion" _
'                        & "  Where PRD.nPRDEstado In ('2102') " & sqlAdd & " Group By CO.cCtaCod) As REP"
'*****
             


                Else
'                    SQL = " Select Count(*) nNum, IsNull(Sum(nOro),0) nOro, IsNull(Sum(nSaldo),0) nSaldo From" _
'                        & " (Select CO.cCtaCod, Sum(nPesoNeto) nOro, Sum(PRD.nSaldo) nSaldo from ColocPigno CO" _
'                        & " Inner Join Producto PRD On CO.cCtaCod = PRD.cCtaCod " _
'                        & " Inner Join ColocPigJoyaTasacion CPT On CO.cCtaCod = CPT.cCtaCod And CO.nTipoTasacion = CPT.nTipoTasacion" _
'                        & "  Where PRD.nPRDEstado In ('2108') " & sqlAdd & " Group By CO.cCtaCod) As REP"

                    sql = " select nnum=count(*), noro=isnull(sum(oroneto),0 ),nsaldo=isnull(sum(nsaldo),0 ) "
                    sql = sql & " from (select p.cctacod,oroneto=sum(cd.npesoneto), p.nsaldo "
                    sql = sql & "    from colocpigjoyadet cd "
                    sql = sql & "     join producto p on p.cctacod=cd.cctacod "
                    sql = sql & "    where p.nprdestado='2102' " & sqlAdd & " "
                    sql = sql & "  group by p.cctacod, p.nsaldo     )  as rep "

             

                End If
            Else
                sql = "Select Sum(nNumCredDif) nNum, Sum(nOroDif) nOro, nSaldo = 0 FROM ColocEstadDiaPrenda " _
                    & "WHERE DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " & sqlAdd
            End If
    End Select
    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    If rs.EOF And rs.BOF Then
        DP = "0"
        NumP = "0"
        SalP = "0"
    Else
        DP = Str(IIf(IsNull(rs!nNum), 0, rs!nNum))
        NumP = Str(IIf(IsNull(rs!nOro), 0, rs!nOro))
        SalP = Str(IIf(IsNull(rs!nSaldo), 0, rs!nSaldo))
    End If
    rs.Close
    Set rs = Nothing
    Set ofunc = Nothing
End Function

Private Function BL(ByVal Moneda As String, ByVal ValMon As String, ByVal TipMon As String, ByVal dFec As Date) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    oCon.AbreConexion
    
    sql = " Select IsNull(Sum(IsNull(MUE.nMonto,0)),0) Monto from MovUserEfectivo MUE" _
        & " Inner Join Mov M On MUE.nMovNro = M.nMovNro Inner Join Efectivo E On E.cEfectivoCod = MUE.cEfectivoCod " _
        & " Where M.cOpeCod in ('901007', '901016') And Left(E.cEfectivoCod ,2) = '" & Moneda & TipMon & "' And nEfectivoValor = " & ValMon & " And Left(M.cMovNro,8) = '" & Format(dFec, "YYYYMMDD") & "'"
    
    If gsCodAge <> "" Then
        sql = sql & " And Substring(M.cMovNro, 18,2) = '" & Right(gsCodAge, 2) & "'"
    End If
    
    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    If rs.EOF And rs.BOF Then
      BL = "0"
      Select Case Moneda
           Case gMonedaNacional
             CA = 0
           Case gMonedaExtranjera
             CAE = 0
       End Select
      
    Else
      Select Case Moneda
         Case gMonedaNacional:
            CA = rs!Monto / Val(ValMon)
            BL = CCur(rs!Monto)
            TB = TB + BL
         Case gMonedaExtranjera:
            If Val(ValMon) = 0 Then ValMon = 1
            CAE = rs!Monto / Val(ValMon)
            BL = CCur(rs!Monto)
            TBD = TBD + BL
      End Select
    End If
    rs.Close
    Set rs = Nothing
End Function


Private Sub DC(ByVal TipCre As String, ByVal Fondo As String, ByVal pnMoneda As Moneda, ByVal dFec As Date, Optional ByVal gdFecSis As Date)
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim bHoy As Boolean
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
     
    oCon.AbreConexion
    
    bHoy = False
    If DateDiff("d", dFec, gdFecSis) = 0 Then bHoy = True
    'substring(cLineaCred,3,1) = '1' AND
    Select Case TipCre
        Case "2", "2','4"  ' CPE
            If bHoy Then
                sql = "SELECT IsNull(COUNT(PRD.cCtaCod),0) nNum, IsNull(SUM(nSaldo),0) nSaldo FROM Colocaciones CO Inner Join Producto PRD ON CO.cCtaCod = PRD.cCtaCod " _
                    & "WHERE substring(cLineaCred,7,1) IN ('" & TipCre & "','1') AND " _
                    & "" _
                    & "substring(cLineaCred,1,2) IN ('" & Fondo & "') AND " _
                    & "SUBSTRING(cLineaCred,5,1) = '" & pnMoneda & "' " _
                    & "AND PRD.nPRDEstado Like '20[23]%'  And Substring(PRD.cCtaCod,6,3) <> '" & Producto.gColConsuPrendario & "'"
                If gsCodAge <> "" Then
                    sql = sql & " And Substring(PRD.cCtaCod,4,2) = '" & Right(gsCodAge, 2) & "'"
                End If
            Else
                sql = "SELECT IsNull(SUM(nNumSaldos),0) nNum, IsNull(SUM(nSaldoCap),0) nSaldo FROM ColocEstadDiaCred " _
                    & "WHERE substring(cLineaCred,7,1) IN ('" & TipCre & "','1') AND " _
                    & " " _
                    & "substring(cLineaCred,1,2) IN ('" & Fondo & "') AND " _
                    & "SUBSTRING(cLineaCred,5,1) = '" & pnMoneda & "' " _
                    & "AND DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0"
                If gsCodAge <> "" Then
                    sql = sql & " And cCodAge = '" & Right(gsCodAge, 2) & "'"
                End If
            End If
        Case "3" 'PP
            If bHoy Then
                sql = " SELECT IsNull(count(PRD.cCtaCod),0) nNum, IsNull(SUM(nSaldo),0) nSaldo FROM Colocaciones CO Inner Join Producto PRD ON CO.cCtaCod = PRD.cCtaCod " _
                    & " WHERE substring(cLineaCred,7,1) = '" & TipCre & "' AND " _
                    & " substring(cLineaCred,1,2) = '" & Fondo & "' AND " _
                    & " SUBSTRING(cLineaCred,5,1) = '" & pnMoneda & "' " _
                    & " AND PRD.nPRDEstado Like '20[23]%'  And Substring(PRD.cCtaCod,6,3) <> '" & Producto.gColConsuPrendario & "'"
                If gsCodAge <> "" Then
                    sql = sql & " And Substring(PRD.cCtaCod,4,2) = '" & Right(gsCodAge, 2) & "'"
                End If
            Else
                sql = "SELECT IsNull(SUM(nNumSaldos),0) nNum, IsNull(SUM(nSaldoCap),0) nSaldo FROM ColocEstadDiaCred " _
                    & "WHERE substring(cLineaCred,7,1) = '" & TipCre & "' AND " _
                    & "substring(cLineaCred,1,2) = '" & Fondo & "' AND " _
                    & "SUBSTRING(cLineaCred,5,1) = '" & pnMoneda & "' " _
                    & "AND nSaldoCap <> 0 AND DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0"
                    'se agrego el nsaldocap<>0 para validacion de la misma WARO 08/06/2004
                If gsCodAge <> "" Then
                    sql = sql & " And cCodAge = '" & Right(gsCodAge, 2) & "'"
                End If
            End If
        Case "A" ' AGRIC
            If bHoy Then
                sql = " SELECT IsNull(count(PRD.cCtaCod),0) nNum, IsNull(SUM(nSaldo),0) nSaldo FROM Colocaciones CO Inner Join Producto PRD ON CO.cCtaCod = PRD.cCtaCod " _
                    & " WHERE substring(cLineaCred,1,1) IN ('1','2') AND " _
                    & " substring(cLineaCred,3,1) = '2' AND " _
                    & " SUBSTRING(cLineaCred,5,1) = '" & pnMoneda & "' " _
                    & " AND PRD.nPRDEstado Like '20[23]%' And Substring(PRD.cCtaCod,6,3) <> '" & Producto.gColConsuPrendario & "'"
                If gsCodAge <> "" Then
                    sql = sql & " And Substring(PRD.cCtaCod,4,2) = '" & Right(gsCodAge, 2) & "'"
                End If
                
            Else
                sql = "SELECT IsNull(SUM(nNumSaldos),0) nNum, IsNull(SUM(nSaldoCap),0) nSaldo FROM ColocEstadDiaCred " _
                    & "WHERE substring(cLineaCred,1,1) IN ('1','2') AND " _
                    & "substring(cLineaCred,3,1) = '2' AND " _
                    & "SUBSTRING(cLineaCred,5,1) = '" & pnMoneda & "' " _
                    & "AND DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0"
                If gsCodAge <> "" Then
                    sql = sql & " And cCodAge = '" & Right(gsCodAge, 2) & "'"
                End If
            End If
    End Select
    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    If rs.EOF And rs.BOF Then
        NumC = "0"
        SalC = "0"
    Else
        NumC = Str(rs!nNum)
        SalC = Str(rs!nSaldo)
    End If
    rs.Close
    Set rs = Nothing
End Sub


Private Sub DA(ByVal Producto As String, ByVal Moneda As String, ByVal dFec As Date, Optional chqProd As String = "1", Optional ByVal sCodAge As String = "", Optional gdFecSis As Date)
    Dim sql As String, sqlaux As String
    Dim bHoy As Boolean
    Dim rs As ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    oCon.AbreConexion
    
'    If sCodAge = "" Then
'       sqlaux = ""
'    Else
'       sqlaux = " "
'    End If
    
    bHoy = False
    If DateDiff("d", dFec, gdFecSis) = 0 Then bHoy = True
    
    Select Case Producto
        Case gCapAhorros
            If bHoy Then
                sql = " Select IsNull(COUNT(cCtaCod),0) nNum, IsNull(SUM(nSaldo),0) nSaldo" _
                    & " From Producto where Substring(cCtaCod,6,4) = '" & gCapAhorros & Moneda & "' And nPrdEstado Not In ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "')"
            Else
                'Sql = " Select nNumCtas nNum, nSaldo nSaldo" _    consulta original 3 linea WARO 29/05/2004
                '    & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, oFunF.gsFormatoFecha) & "') = 0 " _
                '    & " And nMoneda = '" & Moneda & "' And nProducto = '" & gCapAhorros & "'"
                                
                sql = " Select IsNull(SUM(nNumCtas),0) nNum, IsNull(SUM(nSaldo),0) nSaldo" _
                    & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " _
                    & " And nMoneda = '" & Moneda & "' And nProducto = '" & gCapAhorros & "'"
                'modificado las 3 lineas superiores para efecto de cuentade num cuentas y suma de ahorros
            End If
            If sCodAge <> "" Then
                'sql = sql & " And cCodAge = '" & Right(gsCodAge, 2) & "'" cons original al 27/052004 'solo habia esta linea
                If bHoy Then                                                    ' waro agregado
                    sql = sql & " And Substring(Producto.cCtaCod,4,2) = '" & sCodAge & "'" 'waro agregado
                Else                                                            'waro agregado
                    sql = sql & " And cCodAge = '" & sCodAge & "'"   'waro agregado
                End If                                                          'waro agregado
            End If
       Case gCapPlazoFijo
            If bHoy Then
                '****ORIGINAL
               ' sql = " Select IsNull(COUNT(cCtaCod),0) nNum, IsNull(SUM(nSaldo),0) nSaldo" _
               '     & " From Producto where Substring(cCtaCod,6,4) In ('" & gCapPlazoFijo & Moneda & "','" & gCapCTS & Moneda & "') And nPrdEstado Not In ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "')"
                sql = " Select IsNull(COUNT(cCtaCod),0) nNum, IsNull(SUM(nSaldo),0) nSaldo" _
                    & " From Producto where Substring(cCtaCod,6,4) ='" & gCapPlazoFijo & Moneda & "' And nPrdEstado Not In ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "')"
               
            Else
               ' Sql = " Select nNumCtas nNum, nSaldo nSaldo " _  consulta original al 29/05/2004
               '     & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, oFunF.gsFormatoFecha) & "') = 0 " _
               '     & " And nMoneda = '" & Moneda & "'  And nProducto In ('" & gCapPlazoFijo & "','" & gCapCTS & "') "
                    
                '******original
'                sql = " Select IsNull(SUM(nNumCtas),0) nNum, IsNull(SUM(nSaldo),0) nSaldo " _
'                    & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, oFunF.gsFormatoFecha) & "') = 0 " _
'                    & " And nMoneda = '" & Moneda & "'  And nProducto In ('" & gCapPlazoFijo & "','" & gCapCTS & "') "
                
                 sql = " Select IsNull(SUM(nNumCtas),0) nNum, IsNull(SUM(nSaldo),0) nSaldo " _
                    & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " _
                    & " And nMoneda = '" & Moneda & "'  And nProducto ='" & gCapPlazoFijo & "'"
                
                
            End If
            If sCodAge <> "" Then
                'sql = sql & " And cCodAge = '" & Right(gsCodAge, 2) & "'" 'consulta original 27052004 solohabia esta linea
                If bHoy Then                                                    ' waro agregado
                    sql = sql & " And Substring(Producto.cCtaCod,4,2) = '" & Right(sCodAge, 2) & "'" 'waro agregado
                Else                                                            'waro agregado
                    sql = sql & " And cCodAge = '" & Right(sCodAge, 2) & "'"   'waro agregado
                End If                                                          'waro agregado
                
            End If
       Case gCapCTS
            If bHoy Then
                sql = " Select IsNull(COUNT(cCtaCod),0) nNum, IsNull(SUM(nSaldo),0) nSaldo" _
                    & " From Producto where Substring(cCtaCod,6,4) = '" & gCapCTS & Moneda & "' And nPrdEstado Not In ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "')"
            Else
               ' Sql = " Select nNumCtas nNum, nSaldo nSaldo " _  consulta original al 29/05/2004
               '     & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, oFunF.gsFormatoFecha) & "') = 0 " _
               '     & " And nMoneda = '" & Moneda & "'  And nProducto In ('" & gCapPlazoFijo & "','" & gCapCTS & "') "
                    
                sql = " Select IsNull(SUM(nNumCtas),0) nNum, IsNull(SUM(nSaldo),0) nSaldo " _
                    & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " _
                    & " And nMoneda = '" & Moneda & "'  And nProducto='" & gCapCTS & "'"
                'modificado el 29/05/2004 por la opcion de cuenta cuentas y suma cuentas
            End If
            If sCodAge <> "" Then
                'sql = sql & " And cCodAge = '" & Right(gsCodAge, 2) & "'" 'consulta original 27052004 solohabia esta linea
                If bHoy Then                                                    ' waro agregado
                    sql = sql & " And Substring(Producto.cCtaCod,4,2) = '" & Right(sCodAge, 2) & "'" 'waro agregado
                Else                                                            'waro agregado
                    sql = sql & " And cCodAge = '" & Right(sCodAge, 2) & "'"   'waro agregado
                End If                                                          'waro agregado
                
            End If
       Case "Cheques"
             Select Case chqProd
                 Case gCapAhorros
                    If bHoy Then
                        sql = " Select IsNull(COUNT(DRC.cCtaCod),0) nNum, IsNull(sum(DRC.nMonto),0) nSaldo  From DocRec DR" _
                            & " Inner Join DocRecCapta DRC On" _
                            & " DR.nTpoDoc = DRC.nTpoDoc And DR.cNroDoc = DRC.cNroDoc And DR.cPersCod = DRC.cPersCod And DR.cIFTpo = DRC.cIFTpo" _
                            & " Where DR.nEstado = 1 And substring(DRC.cCtaCod,6,4) = '" & gCapAhorros & Moneda & "'"
                        If sCodAge <> "" Then
                            sql = sql & "  And  substring(DRC.cCtaCod,4,2) = '" & gsCodAge & "'"
                        End If
                    Else
                       'sql = " Select IsNull(COUNT(nNumChqVal),0) nNum, IsNull(sum(nMonChqVal),0) nSaldo " _
                       '   & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, oFunF.gsFormatoFecha) & "') = 0 " _
                       '   & " And nMoneda = '" & Moneda & "' And nProducto = '" & gCapAhorros & "'"
                       'Se agrego en la sgte linea de sql la variable para la agencia
                       
                        sql = " Select IsNull(SUM(nNumChqVal),0) nNum, IsNull(sum(nMonChqVal),0) nSaldo " _
                           & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " _
                           & " And nMoneda = '" & Moneda & "' And nNumChqVal <> 0 " & " And nProducto = '" & gCapAhorros & "'"
                            'modificado laS 3 Lineas superiores para que no sea tomado los valores 0  WARO
                      
                         If sCodAge <> "" Then
                            sql = sql & "  And  cCodAge = '" & sCodAge & "'"
                        End If
                            
                    End If
                    
                 Case gCapPlazoFijo
                    If bHoy Then
                        sql = " Select IsNull(COUNT(DRC.cCtaCod),0) nNum, IsNull(sum(DRC.nMonto),0) nSaldo  From DocRec DR" _
                            & " Inner Join DocRecCapta DRC On" _
                            & " DR.nTpoDoc = DRC.nTpoDoc And DR.cNroDoc = DRC.cNroDoc And DR.cPersCod = DRC.cPersCod And DR.cIFTpo = DRC.cIFTpo" _
                            & " Where DR.nEstado = 1 And substring(DRC.cCtaCod,6,4) = '" & gCapPlazoFijo & Moneda & "'"
                        
                        If sCodAge <> "" Then
                            sql = sql & "  And  substring(DRC.cCtaCod,4,2) = '" & sCodAge & "'"
                        End If
                    
                    Else
                        sql = " Select IsNull(Sum(nNumChqVal),0) nNum, IsNull(sum(nMonChqVal),0) nSaldo " _
                            & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " _
                            & " And nMoneda = " & Moneda & " and nNumChqVal <>0" & " And nProducto = '" & gCapPlazoFijo & "'"
                        'modificado por WARO 29/05/2004
                        
                        If gsCodAge <> "" Then
                            sql = sql & "  And  cCodAge = '" & sCodAge & "'"
                        End If
                    End If
                 Case gCapCTS
                    If bHoy Then
                        sql = " Select IsNull(COUNT(DRC.cCtaCod),0) nNum, IsNull(sum(DRC.nMonto),0) nSaldo  From DocRec DR" _
                            & " Inner Join DocRecCapta DRC On" _
                            & " DR.nTpoDoc = DRC.nTpoDoc And DR.cNroDoc = DRC.cNroDoc And DR.cPersCod = DRC.cPersCod And DR.cIFTpo = DRC.cIFTpo" _
                            & " Where DR.nEstado = 1 And substring(DRC.cCtaCod,6,4) = '" & gCapCTS & Moneda & "'"
                        
                        If sCodAge <> "" Then
                            sql = sql & "  And  substring(DRC.cCtaCod,4,2) = '" & sCodAge & "'"
                        End If
                    Else
                        sql = " Select IsNull(sum(nNumChqVal),0) nNum, IsNull(sum(nMonChqVal),0) nSaldo " _
                            & " FROM CapEstadSaldo WHERE DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " _
                            & " And nMoneda = '" & Moneda & "' And nProducto = '" & gCapCTS & "'"


                        If sCodAge <> "" Then
                            sql = sql & "  And  cCodAge = '" & sCodAge & "'"
                        End If
                    End If
              End Select
    End Select
    Set rs = New ADODB.Recordset
    rs.CursorLocation = adUseClient
    Set rs = oCon.CargaRecordSet(sql)
    Set rs.ActiveConnection = Nothing
    If rs.EOF And rs.BOF Then
        NumA = "0"
        SalA = "0"
    Else
        NumA = IIf(IsNull(rs!nNum), "0", Str(rs!nNum))
        SalA = IIf(IsNull(rs!nSaldo), "0", Str(rs!nSaldo))
    End If
    rs.Close
    Set rs = Nothing
End Sub


Private Function SaldosInstFinanc(ByVal Moneda As Moneda, ByVal dFec As Date, _
            ByVal sProducto As String, ByVal sInstFinanc As PersPersoneria, Optional ByVal sCodAge As String = "") As String
            
    Dim sql As String, sqlaux As String, sqlper As String
    Dim rs As ADODB.Recordset
    Dim bHoy As Boolean
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim RegCmacS As Integer
    
    
    If sInstFinanc = gPersonaJurCFLCRAC Then
    'MIOL 20120712 'INC1207110014' *************************************
        sqlper = " nPersoneria = '" & sInstFinanc & "' "
    'sqlper = " nPersoneria IN( '" & sInstFinanc & "','" & gPersonaJurCFLCooperativa & "','" & gPersonaJurCFLEdpyme & "','" & gPersonaJurCFLFONCODES & "') "
'    ElseIf sInstFinanc = gPersonaJurCFLEdpyme Then
'        sqlper = " nPersoneria IN( '" & sInstFinanc & "','" & gPersonaJurCFLCooperativa & "','" & gPersonaJurCFLEdpyme & "','" & gPersonaJurCFLFONCODES & "') "
    'END MIOL **********************************************************
    Else
        sqlper = " nPersoneria = '" & sInstFinanc & "' "
        
    End If
    
    
    
    
    oCon.AbreConexion
    If sCodAge = "" Then
        sqlaux = ""
    Else
        sqlaux = "  and substring(CAP.cctacod,4,2)='" & sCodAge & "'"
    End If
    
    bHoy = False
    If DateDiff("d", dFec, gdFecSis) = 0 Then bHoy = True
    
    If bHoy Then
        'sql = " Select IsNull(Count(PRD.cCtaCod),0) nNum, IsNull(SUM(nSaldo),0) nSaldo FROM Producto PRD" _
        '    & " Inner Join Captaciones CAP ON PRD.cCtaCod = CAP.cCtaCod Where " _
        '    & " nPersoneria = '" & sInstFinanc & "' And PRD.nPrdEstado Not In ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "')" _
        '    & " And Substring(PRD.cCtaCod, 6,4) = '" & Trim(sProducto) & Trim(Str(Moneda)) & "'" & sqlaux
        
        sql = " Select IsNull(Count(PRD.cCtaCod),0) nNum, IsNull(SUM(nSaldo),0) nSaldo FROM Producto PRD" _
            & " Inner Join Captaciones CAP ON PRD.cCtaCod = CAP.cCtaCod Where " _
            & sqlper & " And PRD.nPrdEstado Not In ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "')" _
            & " And Substring(PRD.cCtaCod, 6,4) = '" & Trim(sProducto) & Trim(Str(Moneda)) & "'" & "  and substring(CAP.ccodage,4,2)='" & sCodAge & "'"
        
        
        
    Else
        'sql = "Select nNumCtas nNum, nSaldo nSaldo From CapEstadSaldo CAP " _
        '    & "Where DateDiff(dd,dEstad,'" & Format$(dFec, oFunF.gsFormatoFecha) & "') = 0 " _
        '    & "And nMoneda = " & Moneda & " And nProducto = " & sProducto & " And nPersoneria = " & sInstFinanc & sqlaux
        
        sql = "Select nNumCtas nNum, nSaldo nSaldo From CapEstadSaldo CAP " _
            & "Where DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " _
            & "And nMoneda = " & Moneda & " And nProducto = " & sProducto & " And " & sqlper & "  and substring(CAP.ccodage,4,2)='" & sCodAge & "'"
        
    End If
    Set rs = New ADODB.Recordset
    rs.CursorLocation = adUseClient
    Set rs = oCon.CargaRecordSet(sql)
    Set rs.ActiveConnection = Nothing
    If rs.EOF And rs.BOF Then
        RegCmacS = 0
        SaldosInstFinanc = "0"
    Else
        RegCmacS = IIf(IsNull(rs!nNum), 0, rs!nNum)
        RegCmacStemp = RegCmacS
        SaldosInstFinanc = IIf(IsNull(rs!nSaldo), "0", Str(rs!nSaldo))
    End If
    rs.Close
    Set rs = Nothing
End Function

Public Function GetDataCapNMejoresClientes(pnNumero As Long, lnTipoCambio As Double, psAgeCod As String, pgsEmpresa As String, pgsNomAge As String, pgdFecSis As Date, ByVal nTipo As Integer) As ADODB.Recordset
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    
    Dim lncontador As Long
    
    Dim lscadena As String
    
    Dim lsCod As String * 10
    Dim lsNom As String * 35
    Dim lsDir As String * 35
    Dim lsSaldo As String * 20
    Dim lsFono As String * 10
    Dim lsNac As String * 10
    Dim lsZon As String * 25
    Dim lsContador As String * 4
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
    Dim sqlAdd As String
    Dim lsAgenciasComentario As String
    lscadena = ""
    

    
  If psAgeCod = "" Then
    sqlAdd = ""
    lsAgenciasComentario = ""
  Else
    sqlAdd = " And SubString(A.cCtaCod,4,2) = '" & psAgeCod & "'"
    lsAgenciasComentario = " Agencia = " & psAgeCod
  End If
 
If nTipo = 1 Then
    
    sql = " SELECT TOP " & pnNumero & " cCodPers=F.PERSCOD,cNomPers=P.CPERSNOMBRE,cDirPers=P.CPERSDIRECCDOMICILIO, cTelPers=P.cPersTelefono,nSaldo=SUM(F.NSALDO),dFecNac=P.dPersNacCreac,Zona=ISNULL(Z.cUbiGeoDescripcion,'')  " _
          & " From (SELECT DISTINCT PERSCOD=( Select top 1 PP.CPERSCOD from productopersona pp where pp.nprdpersrelac=" & CaptacRelacPersona.gCapRelPersTitular & " AND PP.CCTACOD=A.CCTACOD ) ,A.CCTACOD, " _
          & " nSaldo =SUM(CASE SUBSTRING(A.cCtaCod,9,1) WHEN '1' THEN A.nSaldo WHEN '2' THEN A.nSaldo*" & lnTipoCambio & " END) " _
          & " FROM Producto A " _
          & " WHERE A.nPrdEstado  NOT IN ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "') " _
          & " And Substring(A.cCtaCod,6,3) In ('" & Producto.gCapAhorros & "','" & Producto.gCapPlazoFijo & "','" & Producto.gCapCTS & "')  " & sqlAdd & "" _
          & "  GROUP BY A.CCTACOD ) F " _
          & " JOIN PERSONA P ON P.CPERSCOD=F.PERSCOD " _
          & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod " _
          & " GROUP BY  F.PERSCOD,P.CPERSNOMBRE,P.CPERSDIRECCDOMICILIO, P.cPersTelefono,P.CPERSDIRECCDOMICILIO,P.dPersNacCreac,Z.cUbiGeoDescripcion " _
          & " ORDER BY SUM(F.NSALDO) DESC "
          
 Else
 
     sql = " SELECT TOP " & pnNumero & " cCodPers=F.PERSCOD,cNomPers=P.CPERSNOMBRE,cDirPers=P.CPERSDIRECCDOMICILIO, cTelPers=P.cPersTelefono,nSaldo=SUM(F.NSALDO),dFecNac=P.dPersNacCreac,Zona=ISNULL(Z.cUbiGeoDescripcion,'')  " _
          & " From (SELECT DISTINCT PERSCOD=( Select top 1 PP.CPERSCOD from productopersona pp where pp.nprdpersrelac=" & CaptacRelacPersona.gCapRelPersTitular & " AND PP.CCTACOD=A.CCTACOD ) ,A.CCTACOD, " _
          & " nSaldo =SUM(CASE SUBSTRING(A.cCtaCod,9,1) WHEN '1' THEN A.nSaldo WHEN '2' THEN A.nSaldo*" & lnTipoCambio & " END) " _
          & " FROM Producto A " _
          & " WHERE A.nPrdEstado  NOT IN ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "') " _
          & " And Substring(A.cCtaCod,6,3) In ('" & Producto.gCapAhorros & "','" & Producto.gCapPlazoFijo & "','" & Producto.gCapCTS & "')  " & sqlAdd & "" _
          & "  GROUP BY A.CCTACOD ) F " _
          & " JOIN PERSONA P ON P.CPERSCOD=F.PERSCOD " _
          & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod " _
          & " WHERE P.NPERSPERSONERIA NOT IN (" & PersPersoneria.gPersonaJurCFLCMAC & "," & PersPersoneria.gPersonaJurCFLCRAC & "," & PersPersoneria.gPersonaJurCFLFONCODES & "," & PersPersoneria.gPersonaJurCFLCooperativa & "," & PersPersoneria.gPersonaJurCFLEdpyme & ")" _
          & " GROUP BY  F.PERSCOD,P.CPERSNOMBRE,P.CPERSDIRECCDOMICILIO, P.cPersTelefono,P.CPERSDIRECCDOMICILIO,P.dPersNacCreac,Z.cUbiGeoDescripcion  " _
          & " ORDER BY SUM(F.NSALDO) DESC "

 
 End If
    
    
    oCon.AbreConexion
    
    Set rs = oCon.CargaRecordSet(sql)
    
'    lsCadena = ""
'    lsCadena = lsCadena & CabeceraPagina("MEJORES " & pnNumero & " MEJORES CLIENTES" & lsAgenciasComentario, lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, , False)
'    lsCadena = lsCadena & Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;12;", lnItem)
'
'    lnContador = 0
'
'    While Not rs.EOF
'        lnContador = lnContador + 1
'        lsCod = rs!cCodPers
'        lsNom = rs!cNomPers
'        lsDir = rs!cDirPers
'        RSet lsSaldo = Format(rs!nSaldo, "#,##0.00")
'        lsFono = rs!cTelPers & ""
'        lsNac = Format(rs!dFecNac, oFunF.gsFormatoFechaView)
'        lsZon = rs!Zona
'
'        lsCadena = lsCadena & Format(lnContador, "0000") & "  " & lsCod & "  " & lsNom & "  " & lsDir & "  " & lsSaldo & "  " & lsFono & "  " & lsNac & "  " & lsZon & Chr(10)
'
'        lnItem = lnItem + 1
'
'        If lnItem > 54 Then
'            lnItem = 0
'            lsCadena = lsCadena & Chr(12)
'            lsCadena = lsCadena & CabeceraPagina("MEJORES " & pnNumero & " MEJORES CLIENTES" & lsAgenciasComentario, lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, , False)
'            lsCadena = lsCadena & Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;12;", lnItem)
'        End If
'
'        rs.MoveNext
'    Wend
   Set GetDataCapNMejoresClientes = rs
    oCon.CierraConexion
    Set rs = Nothing
    Set oCon = Nothing

End Function

Public Function GetRepMejoresClientesN(ByVal pnNumero As Long, ByVal lnTipoCambio As Double, ByVal psAgeCod As String, ByVal psFecPro As Date, ByVal pnTipo As Integer, Optional prod As String = "") As ADODB.Recordset
Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    
    Dim lncontador As Long
    Dim lscadena As String
    Dim lsCod As String * 10
    Dim lsNom As String * 35
    Dim lsDir As String * 35
    Dim lsSaldo As String * 20
    Dim lsFono As String * 10
    Dim lsNac As String * 10
    Dim lsZon As String * 25
    Dim lsContador As String * 4
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
    Dim sqlAdd As String, sqlaux As String
    Dim lsAgenciasComentario As String
    
    
    If psAgeCod = "" Then
            sqlAdd = ""
            lsAgenciasComentario = ""
    Else
            Dim ClsAge As COMDConstantes.DCOMAgencias
            Set ClsAge = New COMDConstantes.DCOMAgencias
            sqlAdd = " and SubString(A.cCtaCod,4,2) = '" & psAgeCod & "'"
            lsAgenciasComentario = " Agencia = " & psAgeCod & " " & ClsAge.NombreAgencia(psAgeCod)
            
    End If
    
    If prod <> "" Then
        If pnTipo = 3 Then
           sqlaux = " WHERE P.NPERSPERSONERIA NOT IN (4,5,6,7,8)"
        End If
        
    End If
    
    
    Select Case pnTipo
    Case 1
      '****SINIF
         sql = " SELECT TOP " & pnNumero & " cCodPers=F.PERSCOD,cNomPers=P.CPERSNOMBRE,cDirPers=P.CPERSDIRECCDOMICILIO, cTelPers=P.cPersTelefono,nSaldo=SUM(F.NSALDcnt),dFecNac=P.dPersNacCreac,Zona=ISNULL(Z.cUbiGeoDescripcion,'')   "
         sql = sql & "  From ("
         sql = sql & "  SELECT DISTINCT PERSCOD=( Select top 1 PP.CPERSCOD from productopersona pp where pp.nprdpersrelac=10 AND PP.CCTACOD=A.CCTACOD ) ,A.CCTACOD,  nSaldcnt =SUM(CASE SUBSTRING(A.cCtaCod,9,1) WHEN '1' THEN A.nSaldcnt WHEN '2' THEN A.nSaldcnt*" & lnTipoCambio & " END)"
         sql = sql & "  FROM capsaldosdiarios A"
         sql = sql & "  WHERE   Substring(A.cCtaCod,6,3) In ('232','233','234')"
         sql = sql & "  and convert(char(8),a.dfecha,112)='" & Format(psFecPro, "yyyymmdd") & "'" & sqlAdd
         sql = sql & "  GROUP BY A.CCTACOD"
         sql = sql & "  ) F"
         sql = sql & " JOIN PERSONA P ON P.CPERSCOD=F.PERSCOD"
         sql = sql & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod"
         sql = sql & " WHERE P.NPERSPERSONERIA NOT IN (4,5,6,7,8)"
         sql = sql & " GROUP BY  F.PERSCOD,P.CPERSNOMBRE,P.CPERSDIRECCDOMICILIO, P.cPersTelefono,P.CPERSDIRECCDOMICILIO,P.dPersNacCreac,Z.cUbiGeoDescripcion"
         sql = sql & " ORDER BY SUM(F.NSALDcnt) DESC"

    
    Case 2
     '****CONIF
     
     sql = " SELECT TOP " & pnNumero & " cCodPers=F.PERSCOD,cNomPers=P.CPERSNOMBRE,cDirPers=P.CPERSDIRECCDOMICILIO, cTelPers=P.cPersTelefono,nSaldo=SUM(F.NSALDcnt),dFecNac=P.dPersNacCreac,Zona=ISNULL(Z.cUbiGeoDescripcion,'')"
     sql = sql & " From ("
     sql = sql & " SELECT DISTINCT PERSCOD=( Select top 1 PP.CPERSCOD from productopersona pp where pp.nprdpersrelac=10 AND PP.CCTACOD=A.CCTACOD ) ,A.CCTACOD,  nSaldcnt =SUM(CASE SUBSTRING(A.cCtaCod,9,1) WHEN '1' THEN A.nSaldcnt WHEN '2' THEN A.nSaldcnt*" & lnTipoCambio & "   END)"
     sql = sql & "   FROM capsaldosdiarios A"
     sql = sql & " WHERE   Substring(A.cCtaCod,6,3) In ('232','233','234')"
     sql = sql & "   and convert(char(8),a.dfecha,112)='" & Format(psFecPro, "yyyymmdd") & "'" & sqlAdd
     sql = sql & "   GROUP BY A.CCTACOD"
     sql = sql & "   ) F"
     sql = sql & " JOIN PERSONA P ON P.CPERSCOD=F.PERSCOD"
     sql = sql & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod"
     sql = sql & " GROUP BY  F.PERSCOD,P.CPERSNOMBRE,P.CPERSDIRECCDOMICILIO, P.cPersTelefono,P.CPERSDIRECCDOMICILIO,P.dPersNacCreac,Z.cUbiGeoDescripcion   ORDER BY SUM(F.NSALDcnt) DESC"

    Case Else
     '*****POR PROD
     
     sql = " SELECT TOP " & pnNumero & " cCodPers=F.PERSCOD,cNomPers=P.CPERSNOMBRE,cDirPers=P.CPERSDIRECCDOMICILIO, cTelPers=P.cPersTelefono,nSaldo=SUM(F.NSALDcnt),dFecNac=P.dPersNacCreac,Zona=ISNULL(Z.cUbiGeoDescripcion,'')"
     sql = sql & " From ("
     sql = sql & " SELECT DISTINCT PERSCOD=( Select top 1 PP.CPERSCOD from productopersona pp where pp.nprdpersrelac=10 AND PP.CCTACOD=A.CCTACOD ) ,A.CCTACOD,  nSaldcnt =SUM(CASE SUBSTRING(A.cCtaCod,9,1) WHEN '1' THEN A.nSaldcnt WHEN '2' THEN A.nSaldcnt*" & lnTipoCambio & "   END)"
     sql = sql & "   FROM capsaldosdiarios A"
     sql = sql & " WHERE   Substring(A.cCtaCod,6,3)='" & prod & "'"
     sql = sql & "   and convert(char(8),a.dfecha,112)='" & Format(psFecPro, "yyyymmdd") & "'" & sqlAdd
     sql = sql & "   GROUP BY A.CCTACOD"
     sql = sql & "   ) F"
     sql = sql & " JOIN PERSONA P ON P.CPERSCOD=F.PERSCOD"
     sql = sql & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod"
     sql = sql & sqlaux
     sql = sql & " GROUP BY  F.PERSCOD,P.CPERSNOMBRE,P.CPERSDIRECCDOMICILIO, P.cPersTelefono,P.CPERSDIRECCDOMICILIO,P.dPersNacCreac,Z.cUbiGeoDescripcion   ORDER BY SUM(F.NSALDcnt) DESC"
         
    End Select


    oCon.AbreConexion
    
    Set rs = oCon.CargaRecordSet(sql)
    
'    lsCadena = ""
'    lsCadena = lsCadena & CabeceraPagina("MEJORES " & pnNumero & " MEJORES CLIENTES " & IIf(pnTipo = 1 Or pnTipo = 3, "( SIN IFIS)", "(CON IFIS)") & IIf(Prod <> "", IIf(Prod = "232", "AHORROS", IIf(Prod = "233", "PLAZO FIJO", "CTS"))) & lsAgenciasComentario, lnPagina, lnItem, psAgecod, "", psFecPro, , False)
'    lsCadena = lsCadena & Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;6;", lnItem)
'
'    lnContador = 0
    
'    While Not rs.EOF
'        lnContador = lnContador + 1
'        lsCod = rs!cCodPers
'        lsNom = rs!cNomPers
'        lsDir = rs!cDirPers
'        RSet lsSaldo = Format(rs!nSaldo, "#,##0.00")
'        lsFono = rs!cTelPers & ""
'        lsNac = Format(rs!dFecNac, oFunF.gsFormatoFechaView)
'        lsZon = rs!Zona
'
'        lsCadena = lsCadena & Format(lnContador, "0000") & "  " & lsCod & "  " & lsNom & "  " & lsDir & "  " & lsSaldo & "  " & lsFono & "  " & lsNac & "  " & lsZon & Chr(10)
'
'        lnItem = lnItem + 1
'
'        If lnItem > 54 Then
'            lnItem = 0
'            lsCadena = lsCadena & Chr(12)
'            lsCadena = lsCadena & CabeceraPagina("MEJORES " & pnNumero & " MEJORES CLIENTES" & lsAgenciasComentario, lnPagina, lnItem, psAgecod, "", psFecPro, , False)
'            lsCadena = lsCadena & Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;12;", lnItem)
'        End If
'
'        rs.MoveNext
'    Wend
    If Not rs.EOF Then
        Set GetRepMejoresClientesN = rs
    Else
        Set GetRepMejoresClientesN = Nothing
    End If
    
    oCon.CierraConexion
    Set rs = Nothing
    Set oCon = Nothing
    Set ClsAge = Nothing
   
End Function


Public Function GeneraRepMejoresClientes(ByVal pnNumero As Long, ByVal lnTipoCambio As Double, ByVal psAgeCod As String, ByVal psFecPro As Date, ByVal pnTipo As Integer, Optional prod As String = "") As String
Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    
    Dim lncontador As Long
    Dim lscadena As String
    Dim lsCod As String * 10
    Dim lsNom As String * 35
    Dim lsDir As String * 35
    Dim lsSaldo As String * 20
    Dim lsFono As String * 10
    Dim lsNac As String * 10
    Dim lsZon As String * 25
    Dim lsContador As String * 4
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
    Dim sqlAdd As String, sqlaux As String
    Dim lsAgenciasComentario As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    If psAgeCod = "" Then
            sqlAdd = ""
            lsAgenciasComentario = ""
    Else
            Dim ClsAge As COMDConstantes.DCOMAgencias
            Set ClsAge = New COMDConstantes.DCOMAgencias
            sqlAdd = " and SubString(A.cCtaCod,4,2) = '" & psAgeCod & "'"
            lsAgenciasComentario = " Agencia = " & psAgeCod & " " & ClsAge.NombreAgencia(psAgeCod)
                  
            
    End If
    
    If prod <> "" Then
        If pnTipo = 3 Then
           sqlaux = " WHERE P.NPERSPERSONERIA NOT IN (4,5,6,7,8)"
        End If
        
    End If
    
    
    Select Case pnTipo
    Case 1
      '****SINIF
         sql = " SELECT TOP " & pnNumero & " cCodPers=F.PERSCOD,cNomPers=P.CPERSNOMBRE,cDirPers=P.CPERSDIRECCDOMICILIO, cTelPers=P.cPersTelefono,nSaldo=SUM(F.NSALDcnt),dFecNac=P.dPersNacCreac,Zona=ISNULL(Z.cUbiGeoDescripcion,'')   "
         sql = sql & "  From ("
         sql = sql & "  SELECT DISTINCT PERSCOD=( Select top 1 PP.CPERSCOD from productopersona pp where pp.nprdpersrelac=10 AND PP.CCTACOD=A.CCTACOD ) ,A.CCTACOD,  nSaldcnt =SUM(CASE SUBSTRING(A.cCtaCod,9,1) WHEN '1' THEN A.nSaldcnt WHEN '2' THEN A.nSaldcnt*" & lnTipoCambio & " END)"
         sql = sql & "  FROM capsaldosdiarios A"
         sql = sql & "  WHERE   Substring(A.cCtaCod,6,3) In ('232','233','234')"
         sql = sql & "  and convert(char(8),a.dfecha,112)='" & Format(psFecPro, "yyyymmdd") & "'" & sqlAdd
         sql = sql & "  GROUP BY A.CCTACOD"
         sql = sql & "  ) F"
         sql = sql & " JOIN PERSONA P ON P.CPERSCOD=F.PERSCOD"
         sql = sql & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod"
         sql = sql & " WHERE P.NPERSPERSONERIA NOT IN (4,5,6,7,8)"
         sql = sql & " GROUP BY  F.PERSCOD,P.CPERSNOMBRE,P.CPERSDIRECCDOMICILIO, P.cPersTelefono,P.CPERSDIRECCDOMICILIO,P.dPersNacCreac,Z.cUbiGeoDescripcion"
         sql = sql & " ORDER BY SUM(F.NSALDcnt) DESC"

    
    Case 2
     '****CONIF
     
     sql = " SELECT TOP " & pnNumero & " cCodPers=F.PERSCOD,cNomPers=P.CPERSNOMBRE,cDirPers=P.CPERSDIRECCDOMICILIO, cTelPers=P.cPersTelefono,nSaldo=SUM(F.NSALDcnt),dFecNac=P.dPersNacCreac,Zona=ISNULL(Z.cUbiGeoDescripcion,'')"
     sql = sql & " From ("
     sql = sql & " SELECT DISTINCT PERSCOD=( Select top 1 PP.CPERSCOD from productopersona pp where pp.nprdpersrelac=10 AND PP.CCTACOD=A.CCTACOD ) ,A.CCTACOD,  nSaldcnt =SUM(CASE SUBSTRING(A.cCtaCod,9,1) WHEN '1' THEN A.nSaldcnt WHEN '2' THEN A.nSaldcnt*" & lnTipoCambio & "   END)"
     sql = sql & "   FROM capsaldosdiarios A"
     sql = sql & " WHERE   Substring(A.cCtaCod,6,3) In ('232','233','234')"
     sql = sql & "   and convert(char(8),a.dfecha,112)='" & Format(psFecPro, "yyyymmdd") & "'" & sqlAdd
     sql = sql & "   GROUP BY A.CCTACOD"
     sql = sql & "   ) F"
     sql = sql & " JOIN PERSONA P ON P.CPERSCOD=F.PERSCOD"
     sql = sql & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod"
     sql = sql & " GROUP BY  F.PERSCOD,P.CPERSNOMBRE,P.CPERSDIRECCDOMICILIO, P.cPersTelefono,P.CPERSDIRECCDOMICILIO,P.dPersNacCreac,Z.cUbiGeoDescripcion   ORDER BY SUM(F.NSALDcnt) DESC"

    Case Else
     '*****POR PROD
     
     sql = " SELECT TOP " & pnNumero & " cCodPers=F.PERSCOD,cNomPers=P.CPERSNOMBRE,cDirPers=P.CPERSDIRECCDOMICILIO, cTelPers=P.cPersTelefono,nSaldo=SUM(F.NSALDcnt),dFecNac=P.dPersNacCreac,Zona=ISNULL(Z.cUbiGeoDescripcion,'')"
     sql = sql & " From ("
     sql = sql & " SELECT DISTINCT PERSCOD=( Select top 1 PP.CPERSCOD from productopersona pp where pp.nprdpersrelac=10 AND PP.CCTACOD=A.CCTACOD ) ,A.CCTACOD,  nSaldcnt =SUM(CASE SUBSTRING(A.cCtaCod,9,1) WHEN '1' THEN A.nSaldcnt WHEN '2' THEN A.nSaldcnt*" & lnTipoCambio & "   END)"
     sql = sql & "   FROM capsaldosdiarios A"
     sql = sql & " WHERE   Substring(A.cCtaCod,6,3)='" & prod & "'"
     sql = sql & "   and convert(char(8),a.dfecha,112)='" & Format(psFecPro, "yyyymmdd") & "'" & sqlAdd
     sql = sql & "   GROUP BY A.CCTACOD"
     sql = sql & "   ) F"
     sql = sql & " JOIN PERSONA P ON P.CPERSCOD=F.PERSCOD"
     sql = sql & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod"
     sql = sql & sqlaux
     sql = sql & " GROUP BY  F.PERSCOD,P.CPERSNOMBRE,P.CPERSDIRECCDOMICILIO, P.cPersTelefono,P.CPERSDIRECCDOMICILIO,P.dPersNacCreac,Z.cUbiGeoDescripcion   ORDER BY SUM(F.NSALDcnt) DESC"
         
    End Select


    oCon.AbreConexion
    
    Set rs = oCon.CargaRecordSet(sql)
    
    Dim sProd As String
    If prod = "232" Then
        sProd = " AHORROS"
    ElseIf prod = "233" Then
        sProd = " PLAZO FIJO"
    ElseIf prod = "234" Then
        sProd = " CTS"
    End If
    
    
    lscadena = ""
    lscadena = lscadena & ofuni.CabeceraPagina("MEJORES " & pnNumero & " MEJORES CLIENTES " & IIf(pnTipo = 1 Or pnTipo = 3, "( SIN IFIS)", "(CON IFIS)") & sProd & lsAgenciasComentario, lnPagina, lnItem, psAgeCod, "", psFecPro, , False)
    lscadena = lscadena & ofuni.Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;6;", lnItem)

    lncontador = 0
    
    While Not rs.EOF
        lncontador = lncontador + 1
        lsCod = rs!cCodPers
        lsNom = rs!cNomPers
        lsDir = rs!cDirPers
        RSet lsSaldo = Format(rs!nSaldo, "#,##0.00")
        lsFono = rs!cTelPers & ""
        lsNac = Format(rs!dFecNac, ofunf.gsFormatoFechaView)
        lsZon = rs!Zona

        lscadena = lscadena & Format(lncontador, "0000") & "  " & lsCod & "  " & lsNom & "  " & lsDir & "  " & lsSaldo & "  " & lsFono & "  " & lsNac & "  " & lsZon & Chr(10)

        lnItem = lnItem + 1

        If lnItem > 54 Then
            lnItem = 0
            lscadena = lscadena & Chr(12)
            lscadena = lscadena & ofuni.CabeceraPagina("MEJORES " & pnNumero & " MEJORES CLIENTES " & IIf(pnTipo = 1 Or pnTipo = 3, "( SIN IFIS)", "(CON IFIS)") & sProd & lsAgenciasComentario, lnPagina, lnItem, psAgeCod, "", psFecPro, , False)
            lscadena = lscadena & ofuni.Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;12;", lnItem)
        End If

        rs.MoveNext
    Wend
    
    oCon.CierraConexion
    Set rs = Nothing
    Set oCon = Nothing
    Set ClsAge = Nothing
    
   GeneraRepMejoresClientes = lscadena
    



End Function


Public Function GetRepCapNMejoresClientes(pnNumero As Long, lnTipoCambio As Double, psAgeCod As String, pgsEmpresa As String, pgsNomAge As String, pgdFecSis As Date) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    
    Dim lncontador As Long
    
    Dim lscadena As String
    
    Dim lsCod As String * 10
    Dim lsNom As String * 35
    Dim lsDir As String * 35
    Dim lsSaldo As String * 20
    Dim lsFono As String * 10
    Dim lsNac As String * 10
    Dim lsZon As String * 25
    Dim lsContador As String * 4
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
    Dim sqlAdd As String
    Dim lsAgenciasComentario As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    lscadena = ""
    
    'GetTipCambio pdIni
     
    'lnTipoCambio = gnTipCambio
     
 '  sql = " Select TOP " & pnNumero & " TA.cCodPers, P.cNomPers, TA.nSaldo, P.cDirPers, P.cTelPers," _
        & " P.dFecNac, ISNULL(Z.cDesZon,'') Zona FROM (" _
        & "     Select T.cCodPers, SUM(T.nSaldo) nSaldo FROM (" _
        & "         Select PC.cCodPers, A.cCodCta, nSaldo = CASE SUBSTRING(A.cCodCta,6,1)" _
        & "             WHEN '1' THEN A.nSaldCntAC WHEN '2' THEN A.nSaldCntAC*" & lnTipoCambio & " END" _
        & "         FROM AhorroCConsol A INNER JOIN PersCuentaConsol PC ON A.cCodCta = PC.cCodCta WHERE A.cEstCtaAC" _
        & "         NOT IN ('C','U') AND PC.cRelaCta = 'TI'" _
        & " Union" _
        & " Select PC.cCodPers, A.cCodCta, nSaldo = CASE SUBSTRING(A.cCodCta,6,1)" _
        & "         WHEN '1' THEN A.nSaldCntPF WHEN '2' THEN A.nSaldCntPF*" & lnTipoCambio & " END" _
        & "         from PlazoFijoConsol A Inner Join PersCuentaConsol PC on A.cCodCta = PC.cCodCta Where" _
        & "         A.cEstCtaPF not in ('C','U') and PC.cRelaCta = 'TI'" _
        & " Union" _
        & " Select PC.cCodPers, A.cCodCta, nSaldo = CASE SUBSTRING(A.cCodCta,6,1)" _
        & "         WHEN '1' THEN A.nSaldCntCTS WHEN '2' THEN A.nSaldCntCTS*" & lnTipoCambio & " END" _
        & "         from CTSConsol A Inner Join PersCuentaConsol PC on A.cCodCta = PC.cCodCta Where" _
        & "         A.cEstCtaCTS not in ('C','U') and PC.cRelaCta = 'TI'" _
        & "     ) T GROUP BY T.cCodPers" _
        & " ) TA INNER JOIN " & gcCentralPers & "Persona P LEFT JOIN " & gcCentralCom & "Zonas Z ON P.cCodZon = Z.cCodZon" _
        & " ON TA.cCodPers = P.cCodPers ORDER BY TA.nSaldo DESC"
    
'    oCon.AbreConexionRemota "07", , , "05"
    
  If psAgeCod = "" Then
    sqlAdd = ""
    lsAgenciasComentario = ""
  Else
    sqlAdd = " And SubString(A.cCtaCod,4,2) = '" & psAgeCod & "'"
    lsAgenciasComentario = " Agencia = " & psAgeCod
  End If
'***Query anterior*****
'  sql = " Select TOP " & pnNumero & " TA.cPersCod cCodPers, P.cPersNombre cNomPers, TA.nSaldo, P.cPersDireccDomicilio cDirPers, P.cPersTelefono cTelPers," _
'        & " P.dPersNacCreac dFecNac, ISNULL(Z.cUbiGeoDescripcion,'') Zona FROM (" _
'        & "     Select T.cPersCod , SUM(T.nSaldo) nSaldo FROM (" _
'        & "         Select PC.cPersCod , A.cCtaCod, nSaldo = CASE SUBSTRING(A.cCtaCod,9,1)" _
'        & "             WHEN '1' THEN A.nSaldo WHEN '2' THEN A.nSaldo*" & lnTipoCambio & " END" _
'        & "         FROM Producto A INNER JOIN ProductoPersona PC ON A.cCtaCod = PC.cCtaCod WHERE A.nPrdEstado" _
'        & "         NOT IN ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "') AND PC.nPrdPersRelac = " & CaptacRelacPersona.gCapRelPersTitular & "" _
'        & "         And Substring(A.cCtaCod,6,3) In ('" & Producto.gCapAhorros & "','" & Producto.gCapPlazoFijo & "','" & Producto.gCapCTS & "') " & sqlAdd & ") T GROUP BY T.cPersCod" _
'        & " ) TA INNER JOIN Persona P" _
'        & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod" _
'        & " ON TA.cPersCod = P.cPersCod ORDER BY TA.nSaldo DESC"
'
    
    sql = " SELECT TOP " & pnNumero & " cCodPers=F.PERSCOD,cNomPers=P.CPERSNOMBRE,cDirPers=P.CPERSDIRECCDOMICILIO, cTelPers=P.cPersTelefono,nSaldo=SUM(F.NSALDO),dFecNac=P.dPersNacCreac,Zona=ISNULL(Z.cUbiGeoDescripcion,'')  " _
          & " From (SELECT DISTINCT PERSCOD=( Select top 1 PP.CPERSCOD from productopersona pp where pp.nprdpersrelac=" & CaptacRelacPersona.gCapRelPersTitular & " AND PP.CCTACOD=A.CCTACOD ) ,A.CCTACOD, " _
          & " nSaldo =SUM(CASE SUBSTRING(A.cCtaCod,9,1) WHEN '1' THEN A.nSaldo WHEN '2' THEN A.nSaldo*" & lnTipoCambio & " END) " _
          & " FROM Producto A " _
          & " WHERE A.nPrdEstado  NOT IN ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "') " _
          & " And Substring(A.cCtaCod,6,3) In ('" & Producto.gCapAhorros & "','" & Producto.gCapPlazoFijo & "','" & Producto.gCapCTS & "')  " & sqlAdd & "" _
          & "  GROUP BY A.CCTACOD ) F " _
          & " JOIN PERSONA P ON P.CPERSCOD=F.PERSCOD " _
          & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod " _
          & " GROUP BY  F.PERSCOD,P.CPERSNOMBRE,P.CPERSDIRECCDOMICILIO, P.cPersTelefono,P.CPERSDIRECCDOMICILIO,P.dPersNacCreac,Z.cUbiGeoDescripcion " _
          & " ORDER BY SUM(F.NSALDO) DESC "
    
    
    
    oCon.AbreConexion
    
    Set rs = oCon.CargaRecordSet(sql)
    
    lscadena = ""
    lscadena = lscadena & ofuni.CabeceraPagina("MEJORES " & pnNumero & " MEJORES CLIENTES" & lsAgenciasComentario, lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, , False)
    'lsCadena = lsCadena & Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;12;", lnItem)
    lscadena = lscadena & ofuni.Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;6;", lnItem)

    lncontador = 0
    
    While Not rs.EOF
        lncontador = lncontador + 1
        lsCod = rs!cCodPers
        lsNom = rs!cNomPers
        lsDir = rs!cDirPers
        RSet lsSaldo = Format(rs!nSaldo, "#,##0.00")
        lsFono = rs!cTelPers & ""
        lsNac = Format(rs!dFecNac, ofunf.gsFormatoFechaView)
        lsZon = rs!Zona

        lscadena = lscadena & Format(lncontador, "0000") & "  " & lsCod & "  " & lsNom & "  " & lsDir & "  " & lsSaldo & "  " & lsFono & "  " & lsNac & "  " & lsZon & Chr(10)

        lnItem = lnItem + 1

        If lnItem > 54 Then
            lnItem = 0
            lscadena = lscadena & Chr(12)
            lscadena = lscadena & ofuni.CabeceraPagina("MEJORES " & pnNumero & " MEJORES CLIENTES" & lsAgenciasComentario, lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, , False)
            lscadena = lscadena & ofuni.Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;12;", lnItem)
        End If

        rs.MoveNext
    Wend
    
    oCon.CierraConexion
    Set rs = Nothing
    Set oCon = Nothing
    Set ofuni = Nothing
    GetRepCapNMejoresClientes = lscadena
End Function

Public Function GetRepCapNMejoresClientesSIF(pnNumero As Long, lnTipoCambio As Double, psAgeCod As String, pgsEmpresa As String, pgsNomAge As String, pgdFecSis As Date) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
        
    Dim lncontador As Long
    
    Dim lscadena As String
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    Dim lsCod As String * 10
    Dim lsNom As String * 35
    Dim lsDir As String * 35
    Dim lsSaldo As String * 20
    Dim lsFono As String * 10
    Dim lsNac As String * 10
    Dim lsZon As String * 25
    Dim lsContador As String * 4
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
    Dim sqlAdd As String
    Dim lsAgenciasComentario As String
    Dim ofuin As New COMFunciones.FCOMImpresion
    lscadena = ""
    
    
    
  If psAgeCod = "" Then
    sqlAdd = ""
    lsAgenciasComentario = ""
  Else
    sqlAdd = " And SubString(A.cCtaCod,4,2) = '" & psAgeCod & "'"
    lsAgenciasComentario = " Agencia = " & psAgeCod
  End If
  
'  sql = " Select TOP " & pnNumero & " TA.cPersCod cCodPers, P.cPersNombre cNomPers, TA.nSaldo, P.cPersDireccDomicilio cDirPers, P.cPersTelefono cTelPers," _
'        & " P.dPersNacCreac dFecNac, ISNULL(Z.cUbiGeoDescripcion,'') Zona FROM (" _
'        & "     Select T.cPersCod , SUM(T.nSaldo) nSaldo FROM (" _
'        & "         Select PC.cPersCod , A.cCtaCod, nSaldo = CASE SUBSTRING(A.cCtaCod,9,1)" _
'        & "             WHEN '1' THEN A.nSaldo WHEN '2' THEN A.nSaldo*" & lnTipoCambio & " END" _
'        & "         FROM Producto A INNER JOIN ProductoPersona PC ON A.cCtaCod = PC.cCtaCod WHERE A.nPrdEstado" _
'        & "         NOT IN ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "') AND PC.nPrdPersRelac = " & CaptacRelacPersona.gCapRelPersTitular & "" _
'        & "         And Substring(A.cCtaCod,6,3) In ('" & Producto.gCapAhorros & "','" & Producto.gCapPlazoFijo & "','" & Producto.gCapCTS & "') " & sqlAdd & ") T GROUP BY T.cPersCod" _
'        & " ) TA INNER JOIN Persona P" _
'        & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod" _
'        & " ON TA.cPersCod = P.cPersCod  " _
'        & " WHERE P.NPERSPERSONERIA NOT IN (" & PersPersoneria.gPersonaJurCFLCMAC & "," & PersPersoneria.gPersonaJurCFLCRAC & "," & PersPersoneria.gPersonaJurCFLFONCODES & "," & PersPersoneria.gPersonaJurCFLCooperativa & "," & PersPersoneria.gPersonaJurCFLEdpyme & ")" _
'        & " ORDER BY TA.nSaldo DESC"
    
 sql = " SELECT TOP " & pnNumero & " cCodPers=F.PERSCOD,cNomPers=P.CPERSNOMBRE,cDirPers=P.CPERSDIRECCDOMICILIO, cTelPers=P.cPersTelefono,nSaldo=SUM(F.NSALDO),dFecNac=P.dPersNacCreac,Zona=ISNULL(Z.cUbiGeoDescripcion,'')  " _
          & " From (SELECT DISTINCT PERSCOD=( Select top 1 PP.CPERSCOD from productopersona pp where pp.nprdpersrelac=" & CaptacRelacPersona.gCapRelPersTitular & " AND PP.CCTACOD=A.CCTACOD ) ,A.CCTACOD, " _
          & " nSaldo =SUM(CASE SUBSTRING(A.cCtaCod,9,1) WHEN '1' THEN A.nSaldo WHEN '2' THEN A.nSaldo*" & lnTipoCambio & " END) " _
          & " FROM Producto A " _
          & " WHERE A.nPrdEstado  NOT IN ('" & CaptacEstado.gCapEstAnulada & "','" & CaptacEstado.gCapEstCancelada & "') " _
          & " And Substring(A.cCtaCod,6,3) In ('" & Producto.gCapAhorros & "','" & Producto.gCapPlazoFijo & "','" & Producto.gCapCTS & "')  " & sqlAdd & "" _
          & "  GROUP BY A.CCTACOD ) F " _
          & " JOIN PERSONA P ON P.CPERSCOD=F.PERSCOD " _
          & " LEFT JOIN UbicacionGeografica Z ON P.cPersDireccUbiGeo = Z.cUbiGeoCod " _
          & " WHERE P.NPERSPERSONERIA NOT IN (" & PersPersoneria.gPersonaJurCFLCMAC & "," & PersPersoneria.gPersonaJurCFLCRAC & "," & PersPersoneria.gPersonaJurCFLFONCODES & "," & PersPersoneria.gPersonaJurCFLCooperativa & "," & PersPersoneria.gPersonaJurCFLEdpyme & ")" _
          & " GROUP BY  F.PERSCOD,P.CPERSNOMBRE,P.CPERSDIRECCDOMICILIO, P.cPersTelefono,P.CPERSDIRECCDOMICILIO,P.dPersNacCreac,Z.cUbiGeoDescripcion  " _
          & " ORDER BY SUM(F.NSALDO) DESC "
    
    oCon.AbreConexion
    
    Set rs = oCon.CargaRecordSet(sql)

    lscadena = ""
    lscadena = lscadena & ofuni.CabeceraPagina("MEJORES " & pnNumero & " MEJORES CLIENTES" & lsAgenciasComentario, lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, , False)
    lscadena = lscadena & ofuni.Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;12;", lnItem)

    lncontador = 0
    
    While Not rs.EOF
        lncontador = lncontador + 1
        lsCod = rs!cCodPers
        lsNom = rs!cNomPers
        lsDir = rs!cDirPers
        RSet lsSaldo = Format(rs!nSaldo, "#,##0.00")
        lsFono = rs!cTelPers & ""
        lsNac = Format(rs!dFecNac, ofunf.gsFormatoFechaView)
        lsZon = rs!Zona

        lscadena = lscadena & Format(lncontador, "0000") & "  " & lsCod & "  " & lsNom & "  " & lsDir & "  " & lsSaldo & "  " & lsFono & "  " & lsNac & "  " & lsZon & Chr(10)

        lnItem = lnItem + 1

        If lnItem > 54 Then
            lnItem = 0
            lscadena = lscadena & Chr(12)
            lscadena = lscadena & ofuni.CabeceraPagina("MEJORES " & pnNumero & " MEJORES CLIENTES" & lsAgenciasComentario, lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, , False)
            lscadena = lscadena & ofuni.Encabezado("Item;4; ;2;Codigo;7; ;5;Nombre;15; ;22;Dirección;15; ;22;Saldo;18; ;4;Fono;5; ;7;Fec.Nac;8; ;4;Zona;15; ;12;", lnItem)
        End If

        rs.MoveNext
    Wend
    
    rs.Close
    
    GetRepCapNMejoresClientesSIF = lscadena
End Function

Public Function CuentasAperturadas(pAge As String, pTitulo As String, pTipoCta As String, pOrden As Integer, pMoneda As String, dFecIni As Date, dFecFin As Date, pnMontoIni As Currency, pnMontoFin As Currency, ByVal gsNomAge As String, ByVal gdFecSis As Date) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim SQL1 As String
    Dim CuentaA As String
    Dim vLineas As Integer
    Dim vPag As Integer
    Dim lnTotal As Currency
    Dim RCapital As Currency
    Dim lscad As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim lsCtaCod As String * 18
    Dim lsSaldo As String * 15
    Dim lsApertura As String * 10
    Dim lsVencimiento As String
    Dim lsPlazo As String * 5
    Dim lsNombre As String * 40
    Dim lsDireccion As String * 40
    Dim lsFono As String * 6
    Dim sqlAdd As String
    Dim lsCtaCodAnt As String
    Dim ofunfe As New COMFunciones.FCOMFechas
    
    If pAge <> "" Then
        sqlAdd = " and substring(Cp.cCtaCod,4,2) = '" & pAge & "'"
    Else
        sqlAdd = ""
    End If
    
    
    oCon.AbreConexion
    Select Case pTipoCta
    Case "232"
    sql = "Select Cp.cCtaCod, P.cPersNombre, Cp.nSaldoDisp, "
    sql = sql & " Cp.dApertura from Captaciones Cp "
    sql = sql & " Inner Join Producto Pro on Pro.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join CaptacAhorros  CA on  CA.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join ProductoPersona PP on PP.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join Persona P on  P.cPersCod=PP.cPersCod "
    sql = sql & " where substring(Cp.cCtaCod,6,3)='" & pTipoCta & "' and PP.nPrdPersRelac=" & gCapRelPersTitular
    sql = sql & " and substring(Cp.cCtaCod,9,1)='" & pMoneda & "' and Pro.nPrdEstado in (1000,1100,1101,1200,1201) and "
    sql = sql & " Cp.dApertura Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' and '" & Format(dFecFin, ofunf.gsFormatoFecha) & "' "
    sql = sql & " " & sqlAdd & " and CA.bOrdPag=" & pOrden
    sql = sql & " Order by Cp.cCtacod "
    
    Case "233"
    sql = "Select Cp.cCtaCod, P.cPersNombre, Cp.nSaldoDisp, "
    sql = sql & " Cp.dApertura from Captaciones Cp "
    sql = sql & " Inner Join Producto Pro on Pro.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join CaptacPlazoFijo  CPF on  CPF.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join ProductoPersona PP on PP.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join Persona P on  P.cPersCod=PP.cPersCod "
    sql = sql & " where PP.nPrdPersRelac=" & gCapRelPersTitular
    sql = sql & " and substring(Cp.cCtaCod,9,1)='" & pMoneda & "' and Pro.nPrdEstado in (1000,1100,1101,1200,1201) and "
    sql = sql & " Cp.dApertura Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' and '" & Format(dFecFin, ofunf.gsFormatoFecha) & "' "
    sql = sql & "  " & sqlAdd & " "
    sql = sql & " Order by Cp.cCtacod "
    
    Case "234"
        sql = "Select Cp.cCtaCod, P.cPersNombre, Cp.nSaldoDisp, "
    sql = sql & " Cp.dApertura from Captaciones Cp "
    sql = sql & " Inner Join Producto Pro on Pro.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join CaptacCTS CTS on  CTS.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join ProductoPersona PP on PP.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join Persona P on  P.cPersCod=PP.cPersCod "
    sql = sql & " where PP.nPrdPersRelac=" & gCapRelPersTitular
    sql = sql & " and substring(Cp.cCtaCod,9,1)='" & pMoneda & "' and Pro.nPrdEstado in (1000,1100,1101,1200,1201) and "
    sql = sql & " Cp.dApertura Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' and '" & Format(dFecFin, ofunf.gsFormatoFecha) & "' "
    sql = sql & "  " & sqlAdd & "  "
    sql = sql & " Order by Cp.cCtacod "
    End Select
    
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
     vPag = 1
     lscad = lscad & Chr(10)
     lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & "Maynas " & Format(gdFecSis, "dddd, dd mmmm yyyy") & Space(4) & "Pagina: " & Format(vPag, "####") & Chr(10) & Chr(10)
     lscad = lscad & Space(20) & pTitulo & "EN " & IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
     lscad = lscad & "CUENTA " & Space(25) & "NOMBRE" & Space(35) & "MONTO" & Space(5) & "F. APER" & Chr(10)
     lscad = lscad & String(100, "=") & Chr(10)
     Do While Not rs.EOF
        lsCtaCod = rs!cCtaCod
        
        If lsCtaCodAnt = rs!cCtaCod Then
            lsSaldo = ""
            lsVencimiento = ""
        Else
            RSet lsSaldo = Format(rs!nSaldoDisp, "#,##0.00")
            lsVencimiento = Format(rs!dApertura, ofunf.gsFormatoFechaView)
        End If
        lsNombre = rs!cpersnombre
                
        lscad = lscad & lsCtaCod & Space(2) & lsNombre & Space(2) & lsSaldo & Space(2) & lsVencimiento & Chr(10)
        
        lsCtaCodAnt = rs!cCtaCod
        rs.MoveNext
        vLineas = vLineas + 1
        
        If vLineas > 52 Then
            vPag = vPag + 1
            lscad = lscad & Chr(12)
            lscad = lscad & Chr(10)
            lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & "Maynas " & ofunfe.ArmaFecha(gdFecSis) & Space(4) & "Pagina: " & Format(vPag, "####") & Chr(10) & Chr(10)
            lscad = lscad & Space(20) & pTitulo & "EN " & IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
            lscad = lscad & "CUENTA " & Space(25) & "NOMBRE" & Space(35) & Space(40) & "MONTO" & Space(5) & "F. APER" & Chr(10)
            lscad = lscad & String(160, "=") & Chr(10)
            vLineas = 1
        End If
     Loop
    
    End If
    rs.Close
    Set rs = Nothing
    CuentasAperturadas = IIf(lscad <> "", lscad & Chr(12), "")
End Function

Public Function CuentasCanceladas(pAge As String, pTitulo As String, pTipoCta As String, pOrden As Integer, pMoneda As String, dFecIni As Date, dFecFin As Date, pnMontoIni As Currency, pnMontoFin As Currency, ByVal gsNomAge As String, ByVal gdFecSis As Date) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim SQL1 As String
    Dim CuentaA As String
    Dim vLineas As Integer
    Dim vPag As Integer
    Dim lnTotal As Currency
    Dim RCapital As Currency
    Dim lscad As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    
    Dim lsCtaCod As String * 18
    Dim lsSaldo As String * 15
    Dim lsApertura As String * 10
    Dim lsVencimiento As String
    Dim lsPlazo As String * 5
    Dim lsNombre As String * 40
    Dim lsDireccion As String * 40
    Dim lsFono As String * 6
    Dim sqlAdd As String
    Dim ofunfe As New COMFunciones.FCOMFechas
    
    If pAge <> "" Then
        sqlAdd = " and substring(Cp.cCtaCod,4,2) = '" & pAge & "'"
    Else
        sqlAdd = ""
    End If
    
    oCon.AbreConexion
    Select Case pTipoCta
    Case "232"
    sql = "Select Cp.cCtaCod, P.cPersNombre, Cp.nSaldoDisp, "
    sql = sql & " Cp.dApertura from Captaciones Cp "
    sql = sql & " Inner Join Producto Pro on Pro.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join CaptacAhorros  CA on  CA.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join ProductoPersona PP on PP.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join Persona P on  P.cPersCod=PP.cPersCod "
    sql = sql & " where substring(Cp.cCtaCod,6,3)='" & pTipoCta & "' and PP.nPrdPersRelac=" & gCapRelPersTitular
    sql = sql & " and substring(Cp.cCtaCod,9,1)='" & pMoneda & "' and Pro.nPrdEstado in (1300,1301,1400,1401) and "
    sql = sql & " Cp.dApertura Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' and '" & Format(dFecFin, ofunf.gsFormatoFecha) & "' "
    sql = sql & sqlAdd & " and CA.bOrdPag=" & pOrden
    sql = sql & " Order by Cp.cCtacod "
    
    Case "233"
    sql = "Select Cp.cCtaCod, P.cPersNombre, Cp.nSaldoDisp, "
    sql = sql & " Cp.dApertura from Captaciones Cp "
    sql = sql & " Inner Join Producto Pro on Pro.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join CaptacPlazoFijo  CPF on  CPF.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join ProductoPersona PP on PP.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join Persona P on  P.cPersCod=PP.cPersCod "
    sql = sql & " where PP.nPrdPersRelac=" & gCapRelPersTitular
    sql = sql & " and substring(Cp.cCtaCod,9,1)='" & pMoneda & "' and Pro.nPrdEstado in (1300,1301,1400,1401) and "
    sql = sql & " Cp.dApertura Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' and '" & Format(dFecFin, ofunf.gsFormatoFecha) & "' "
    sql = sql & sqlAdd
    sql = sql & " Order by Cp.cCtacod "
    
    Case "234"
        sql = "Select Cp.cCtaCod, P.cPersNombre, Cp.nSaldoDisp, "
    sql = sql & " Cp.dApertura from Captaciones Cp "
    sql = sql & " Inner Join Producto Pro on Pro.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join CaptacPCTS  CTS on  CTS.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join ProductoPersona PP on PP.cCtaCod=Cp.cCtaCod "
    sql = sql & " Inner Join Persona P on  P.cPersCod=PP.cPersCod "
    sql = sql & " where PP.nPrdPersRelac=" & gCapRelPersTitular
    sql = sql & " and substring(Cp.cCtaCod,9,1)='" & pMoneda & "' and Pro.nPrdEstado in (1300,1301,1400,1401) and "
    sql = sql & " Cp.dApertura Between '" & Format(dFecIni, ofunf.gsFormatoFecha) & "' and '" & Format(dFecFin, ofunf.gsFormatoFecha) & "' "
    sql = sql & sqlAdd
    sql = sql & " Order by Cp.cCtacod "
    End Select
    
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
     vPag = 1
     lscad = lscad & Chr(10)
     lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & "Maynas " & Format(gdFecSis, "dddd, dd mmmm yyyy") & Space(4) & "Pagina: " & Format(vPag, "####") & Chr(10) & Chr(10)
     lscad = lscad & Space(20) & pTitulo & "EN " & IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
     lscad = lscad & "CUENTA " & Space(25) & "NOMBRE" & Space(35) & "MONTO" & Space(5) & "F. APER" & Chr(10)
     lscad = lscad & String(100, "=") & Chr(10)
     Do While Not rs.EOF
        lsCtaCod = rs!cCtaCod
        RSet lsSaldo = Format(rs!nSaldoDisp, "#,##0.00")
        lsVencimiento = Format(rs!dApertura, ofunf.gsFormatoFechaView)
        lsNombre = rs!cpersnombre
                
        lscad = lscad & lsCtaCod & Space(2) & lsNombre & Space(2) & lsSaldo & Space(2) & Format(rs!dApertura, ofunf.gsFormatoFechaView) & Chr(10)
        
        rs.MoveNext
        vLineas = vLineas + 1
        
        If vLineas > 52 Then
            vPag = vPag + 1
            lscad = lscad & Chr(12)
            lscad = lscad & Chr(10)
            lscad = lscad & gsNomAge & Space(5) & "Sección Ahorro" & Space(5) & "Maynas " & ofunfe.ArmaFecha(gdFecSis) & Space(4) & "Pagina: " & Format(vPag, "####") & Chr(10) & Chr(10)
            lscad = lscad & Space(20) & pTitulo & "EN " & IIf(pMoneda = Moneda.gMonedaNacional, "SOLES", "DOLARES") + Chr(10) + Chr(10)
            lscad = lscad & "CUENTA " & Space(25) & "NOMBRE" & Space(35) & Space(40) & "MONTO" & Space(5) & "F. APER" & Chr(10)
            lscad = lscad & String(160, "=") & Chr(10)
            vLineas = 1
        End If
     Loop
    
    End If
    rs.Close
    Set rs = Nothing
    CuentasCanceladas = IIf(lscad <> "", lscad & Chr(12), "")
End Function

Public Function ReportesExtornos(pAge As String, pTitulo As String, pMoneda As String, _
        dFecIni As Date, dFecFin As Date, pnMontoIni As Currency, pnMontoFin As Currency, _
        sNomAge As String, Optional ByVal gdFecSis As Date, Optional psUser As String) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim SQL1 As String
    Dim CuentaA As String * 18
    Dim vLineas As Integer
    Dim vPag As Integer
    Dim lnTotal As Currency
    Dim RCapital As Currency
    Dim lscad As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lsAgencias As String * 19
    Dim lsCtaCod As String * 18
    Dim lsMovNro As String * 10
    Dim lsMonto As String * 10
    
    Dim lsNomOpe As String, lsDoc As String, lsUsuario As String
    Dim sTitulo2 As String
    Dim lsFecha As Date
    
    Dim lnMonedaAnt As Integer
    
    Dim lnCorr As Integer
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    If dFecIni = dFecFin Then
        sTitulo2 = "DEL " & Format$(dFecIni, gcFormatoFechaView)
    Else
        sTitulo2 = "DEL " & Format$(dFecIni, gcFormatoFechaView) & " AL " & Format$(dFecFin, gcFormatoFechaView)
    End If
    
    oCon.AbreConexion
    
    sql = "Select Distinct M.nMovNro,  O.cOpeDesc + ' ' + Replace(Replace(m.cMovDesc,Char(10),' '),Char(13),' ') cOpeDesc, IsNull((Select cDocDesc from Documento where nDocTpo=MD.nDocTpo),IsNull((Select cUsuDest from MovHabDevCajero MHC Where MHC.nMovNro = M.nMovNro),'')) Documento , M.cMovNro, substring(M.cMovNro,22,4) Usuario,"
    sql = sql & " IsNull(MC.cCtaCod,(Select Top 1 cNumRecibo FROM MovServiciosDet MM Where MM.nMovNro = M.nMovNro)) CTA, Agencia=(Select cAgeDescripcion from Agencias where substring(M.cMovNro,18,2)= cAgeCod), "
    sql = sql & "     IsNull((Select Top 1  nMovImporte From MovHabDevCajero A Where M.nMovNro = A.nMovNro),"
    sql = sql & "      IsNull((Select Top 1  nMonto From MovCap A Where M.nMovNro = A.nMovNro And A.cCtaCod = MC.cCtaCod),"
    sql = sql & "       IsNull((Select Top 1  nMonto from MovCol A Where M.nMovNro = A.nMovNro And A.cCtaCod = MCO.cCtaCod),"
    sql = sql & "        IsNull((Select Top 1  nMonto from MovServicios A Where M.nMovNro = A.nMovNro),"
    sql = sql & "         IsNull((Select Top 1 nMovImporte from MovOpeVarias A Where M.nMovNro = A.nMovNro),0))))) Monto,"
    sql = sql & "     IsNull((Select Top 1 nMoneda From MovHabDevCajero A Where M.nMovNro = A.nMovNro),"
    sql = sql & "      IsNull((Select Top 1 Substring(A.cCtaCod,9,1) From MovCap A Where M.nMovNro = A.nMovNro),"
    sql = sql & "       IsNull((Select Top 1 Substring(A.cCtaCod,9,1) from MovCol A Where M.nMovNro = A.nMovNro),"
    sql = sql & "        IsNull((Select Top 1 nMoneda from MovServicios A Where M.nMovNro = A.nMovNro),"
    sql = sql & "         IsNull((Select Top 1 nMoneda from MovOpeVarias A Where M.nMovNro = A.nMovNro),0))))) Moneda,"
    sql = sql & " convert(datetime,convert(varchar(8),cMovNro,103),103)  Fecha From Mov M"
    sql = sql & " Left  Join MovCap MC on MC.nMovNro=M.nMovNro"
    sql = sql & " Left  Join MovCol MCO on MCO.nMovNro=M.nMovNro"
    sql = sql & " Inner Join OpeTpo O on O.copeCod = M.cOpeCod"
    sql = sql & " left outer join MovDoc MD on MD.nMovNro=M.nMovNro"
    sql = sql & " where " & IIf(psUser = "XXX", "", " M.cMovNro Like '%" & psUser & "' And ") & " substring(M.cOpeCod,1,1) In ('2','1','9','3','') and M.nMovFlag <> " & MovFlag.gMovFlagVigente & ""
    sql = sql & " And Left(cMovNro,8) Between '" & Format(dFecIni, "YYYYMMDD") & "' And '" & Format(dFecFin, "YYYYMMDD") & "'"
    If pAge <> "" Then sql = sql & " and substring(M.cMovNro,18,2) = '" & pAge & "' "
    sql = sql & " And M.cOpeCod Not Like '1[034]9[012]%' And M.cOpeCod Not Like '129%'"
    sql = sql & " And M.cOpeCod Not like '1009%'"
    sql = sql & " And M.cOpeCod Not Like '159%' And M.cOpeCod Not Like '1[25]9%'"
    sql = sql & " And M.cOpeCod Not Like '2[3457]%' And M.cOpeCod Not Like '3[569]%'"
    sql = sql & " And M.cOpeCod Not Like '90900[0-3]%' And M.cOpeCod Not Like '90900[0-6]%'"
    sql = sql & " And M.cOpeCod Not Like '90103[0-9]%' And M.cOpeCod Not Like '90102[1-9]%'"
    sql = sql & " And M.cOpeCod Not Like '90003[6-9]%' And M.cOpeCod Not Like '90004[4-6]%'"
    sql = sql & " ORDER BY Moneda, M.cMovNro"
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
     vPag = 0
     
     lnCorr = 0
     
     lnMonedaAnt = -1
     
     Do While Not rs.EOF
        If lnMonedaAnt <> rs!Moneda Then
             vPag = vPag + 1
             If lscad <> "" Then
                lscad = lscad & String(151, "-") & Chr(10)
                lscad = lscad & Chr(12)
             End If
             lscad = lscad & Chr(10)
             lscad = lscad & lsEmpresa & IIf(rs!Moneda = 1, "-SOLES  ", IIf(rs!Moneda = 2, "-DOLARES", "        ")) & Space(52) & Format(gdFecSis & " " & Time, "dd/mm/yyyy hh:mm:ss") & Space(20) & "Pagina: " & Format(vPag, "####") & Chr(10)
             lscad = lscad & sNomAge & oImp.gPrnSaltoLinea
             lscad = lscad & Space(Int((151 - Len(pTitulo)) / 2)) & pTitulo & Chr(10)
             lscad = lscad & Space(Int((151 - Len(sTitulo2)) / 2)) & sTitulo2 & Chr(10) & oImp.gPrnSaltoLinea
        
             lscad = lscad & String(151, "=") & Chr(10)
             lscad = lscad & "ITEM    NRO.MOV  OPERACION " & Space(37) & "DOCUMENTO" & "            MONTO " & Space(4) & "USU." & Space(5) & "NRO CUENTA" & Space(10) & "AGENCIA" & Space(10) & "   FECHA" & Chr(10)
             lscad = lscad & String(151, "=") & Chr(10)
        End If
        
        
        lsNomOpe = rs!cOpeDesc
        lsDoc = rs!Documento
        lsUsuario = rs!Usuario
        lsFecha = Format(rs!fecha, ofunf.gsFormatoFechaView)
        CuentaA = rs!Cta & ""
        lsAgencias = rs!Agencia & ""
        lnCorr = lnCorr + 1
        RSet lsMovNro = rs!nMovNro
        RSet lsMonto = Format(rs!Monto, "#,##0.00")
        
        lscad = lscad & Format(lnCorr, "0000") & Space(2) & lsMovNro & "  " & ofuni.ImpreFormat(lsNomOpe, 45, 0) & Space(2) & ofuni.ImpreFormat(lsDoc, 15, 0) & Space(2) & lsMonto & Space(2) & lsUsuario & Space(2) & CuentaA & Space(2) & lsAgencias & Space(2) & lsFecha & Chr(10)
        
        lnMonedaAnt = rs!Moneda
        rs.MoveNext
        vLineas = vLineas + 1
        
        If vLineas > 52 Then
            If rs.EOF Then Exit Do 'NRLO20180413 CORREO20180413-VIBR
            vPag = vPag + 1
            lscad = lscad & Chr(12)
            lscad = lscad & Chr(10)
            lscad = lscad & Chr(10)
            lscad = lscad & Chr(10)
            
            lscad = lscad & lsEmpresa & IIf(rs!Moneda = 1, "-SOLES  ", IIf(rs!Moneda = 2, "-DOLARES", "        ")) & Space(52) & Format(gdFecSis & " " & Time, "dd/mm/yyyy hh:mm:ss") & Space(20) & "Pagina: " & Format(vPag, "####") & Chr(10)
            lscad = lscad & sNomAge & oImp.gPrnSaltoLinea
            lscad = lscad & Space(Int((151 - Len(pTitulo)) / 2)) & pTitulo & Chr(10)
            lscad = lscad & Space(Int((151 - Len(sTitulo2)) / 2)) & sTitulo2 & Chr(10) & oImp.gPrnSaltoLinea
            
            lscad = lscad & String(151, "=") & Chr(10)
            lscad = lscad & "ITEM    NRO.MOV  OPERACION " & Space(37) & "DOCUMENTO" & "            MONTO " & Space(4) & "USU." & Space(5) & "NRO CUENTA" & Space(10) & "AGENCIA" & Space(10) & "   FECHA" & Chr(10)
            lscad = lscad & String(151, "=") & Chr(10)
            vLineas = 1
        End If
     Loop
     lscad = lscad & String(151, "-") & Chr(10)
    
    
    End If
    rs.Close
    Set rs = Nothing
    ReportesExtornos = IIf(lscad <> "", lscad & Chr(12), "")
    Set ofuni = Nothing
    
End Function

Private Function DCaja(ByVal dFec As Date, Optional sAgencia As String = "", _
            Optional nMoneda As Moneda = gMonedaExtranjera) As String
    
    Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
    
    oCon.AbreConexion
    
    If sAgencia = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(M.cMovNro,18,2) = '" & sAgencia & "'"
    End If
    
    sql = "Select ISNULL(Sum(E.nMonto),0) Caja from MovUserEfectivo E JOIN Mov M On E.nMovNro = M.nMovNro " _
        & "Where M.cMovNro Like '" & Format$(dFec, "YYYYMMDD") & "%' And M.nMovFlag = 0 And " _
        & "E.cEfectivoCod Like '" & nMoneda & "%' And M.cOpeCod IN ('" & gOpeHabCajRegEfect & "','" & gOpeBoveAgeRegEfect & "') " & sqlAdd
    
    Set rs = oCon.CargaRecordSet(sql)
    
    If rs.EOF And rs.BOF Then
        DCaja = "0"
    Else
        DCaja = Format$(rs!CAJA, "#,#00.00")
    End If
    rs.Close
    Set rs = Nothing
End Function

Private Function DColocaciones(ByVal dFec As Date, Optional sAgencia As String = "", _
        Optional nMoneda As Moneda = gMonedaExtranjera, Optional bHoy As Boolean = False) As String
    
    Dim sSql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim sqlAdd As String
        
    If sAgencia = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And SUBSTRING(P.cCtaCod,4,2) = '" & sAgencia & "'"
        If Not bHoy Then sqlAdd = " And cCodAge = '" & sAgencia & "'"
    End If
    
    oCon.AbreConexion
    If bHoy Then
        sSql = "Select ISNULL(SUM(nSaldo),0) nSaldo From Producto P JOIN Colocaciones C ON P.cCtaCod = C.cCtaCod " _
            & "Where P.nPrdEstado IN (2020,2021,2022,2023,2030,2031,2032,2033,2802,2803,2804) And " _
            & "SUBSTRING(P.cCtaCod,9,1) = '" & nMoneda & "' " & sqlAdd
    Else
        sSql = "SELECT IsNull(SUM(nSaldoCap),0) nSaldo FROM ColocEstadDiaCred Where " _
        & "SUBSTRING(cLineaCred,6,1) = '" & nMoneda & "' And DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " & sqlAdd
    End If
    
    Set rs = oCon.CargaRecordSet(sSql)
    
    If rs.EOF And rs.BOF Then
      DColocaciones = "0.00"
    Else
      DColocaciones = Format$(rs!nSaldo, "#,#00.00")
    End If
    rs.Close
    Set rs = Nothing
End Function

Private Function DPlazo(ByVal dFec As Date, Optional sAgencia As String = "", _
        Optional nMoneda As Moneda = gMonedaExtranjera, Optional bHoy As Boolean = False) As String
    
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Dim sqlAdd As String
    
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion
    
    If sAgencia = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And cCodAge =  '" & sAgencia & "'"
        If bHoy Then sqlAdd = " And SUBSTRING(P.cCtaCod,4,2) = '" & sAgencia & "'"
    End If
            
    If bHoy Then
        sql = "Select ISNULL(SUM(nSaldo),0) nSaldo from Producto P JOIN Captaciones C ON P.cCtaCod = C.cCtaCod " _
            & "Where P.nPrdEstado NOT IN (" & gCapEstCancelada & "," & gCapEstAnulada & ") And " _
            & "SUBSTRING(P.cCtaCod,9,1) = '" & nMoneda & "' And SUBSTRING(P.cCtaCod,6,3) " _
            & "IN ('" & gCapPlazoFijo & "','" & gCapCTS & "')  " & sqlAdd
    Else
        sql = "Select IsNUll(Sum(nSaldo),0) nSaldo from CapEstadSaldo  " _
            & "Where nProducto In (" & gCapPlazoFijo & "," & gCapCTS & ") And nMoneda = " & nMoneda & " And " _
            & "DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " & sqlAdd
    End If
    
    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    If rs.EOF And rs.BOF Then
        DPlazo = "0"
    Else
        DPlazo = Format(rs!nSaldo, "#,#00.00")
    End If
    rs.Close
    Set rs = Nothing
End Function

Private Function DAhorro(ByVal dFec As Date, Optional sAgencia As String = "", _
        Optional nMoneda As Moneda = gMonedaExtranjera, Optional bHoy As Boolean = False) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion
    
    Dim sqlAdd As String
        
    
    If sAgencia = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And cCodAge =  '" & sAgencia & "'"
        If bHoy Then sqlAdd = " And SUBSTRING(P.cCtaCod,4,2) = '" & sAgencia & "'"
    End If
            
    If bHoy Then
        sql = "Select ISNULL(SUM(nSaldo),0) nSaldo from Producto P JOIN Captaciones C ON P.cCtaCod = C.cCtaCod " _
            & "Where P.nPrdEstado NOT IN (" & gCapEstCancelada & "," & gCapEstAnulada & ") And " _
            & "SUBSTRING(P.cCtaCod,9,1) = '" & nMoneda & "' And SUBSTRING(P.cCtaCod,6,3) = '" & gCapAhorros & "' " & sqlAdd
    Else
        sql = "Select IsNUll(Sum(nSaldo),0) nSaldo from CapEstadSaldo  " _
            & "Where nProducto = '" & gCapAhorros & "' And nMoneda = " & gMonedaExtranjera & " And " _
            & "DateDiff(dd,dEstad,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0 " & sqlAdd
    End If
    
    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    If rs.EOF And rs.BOF Then
        DAhorro = "0"
    Else
        DAhorro = Format(rs!nSaldo, "#,#00.00")
    End If
    rs.Close
    Set rs = Nothing
End Function

Private Function CompraVenta(TIP As String, ByVal dFec As Date) As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion
    
    Dim sqlAdd As String
    
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(M.cMovNro,18,2) = '" & lsAgeCod & "'"
    End If
    
    Select Case TIP
        Case "C"
            sql = " SELECT IsNull(Sum(CV.nMovImporte),0) MontoME, IsNull(sum(CV.nMovImporte * MTC.nMovTpoCambio),0) MontoMN From Mov M Inner Join MovCompraVenta CV ON CV.nMovNro = M.nMovNro INNER JOIN  MovTpoCambio MTC ON MTC.nMovNro = M.nMovNro" _
                & " WHERE M.cOpeCod In ('" & gOpeCajeroMECompra & "','" & gOpeCajeroMECompraEsp & "') and (M.nMovFlag = " & MovFlag.gMovFlagVigente & ") " _
                & " And M.cMovNro Like '" & Format(dFec, "YYYYMMDD") & "%'" & sqlAdd
        Case "V"
            sql = " SELECT IsNull(Sum(CV.nMovImporte),0) MontoME, IsNull(sum(CV.nMovImporte * MTC.nMovTpoCambio),0) MontoMN From Mov M Inner Join MovCompraVenta CV ON CV.nMovNro = M.nMovNro INNER JOIN  MovTpoCambio MTC ON MTC.nMovNro = M.nMovNro" _
                & " WHERE M.cOpeCod In ('" & gOpeCajeroMEVenta & "','" & gOpeCajeroMEVentaEsp & "') and (M.nMovFlag = " & MovFlag.gMovFlagVigente & ") " _
                & " And M.cMovNro Like '" & Format(dFec, "YYYYMMDD") & "%'" & sqlAdd
    End Select
    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    If rs.EOF And rs.BOF Then
       CompraVenta = "0"
       ImpSoles = "0"
    Else
       CompraVenta = Format(rs!MontoME, "#,##0.00")
       ImpSoles = Format(rs!MontoMN, "#,##0.00")
    End If
    rs.Close
    Set rs = Nothing
End Function

Private Sub TCambio(ByVal dFec As Date)
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion
    
    K = 1
    
    Dim sqlAdd As String
        
    If lsAgeCod = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(M.cMovNro,18,2) = '" & lsAgeCod & "'"
    End If
    
    sql = "SELECT dFecCamb, nValComp nValComp, nValVent nValVent, nValCompEsp nValCompEsp, nValVentEsp nValVentEsp FROM TipoCambio " _
        & " where DateDiff(dd,dFecCamb,'" & Format$(dFec, ofunf.gsFormatoFecha) & "') = 0"
    Set rs = New ADODB.Recordset
    Set rs = oCon.CargaRecordSet(sql)
    
    If rs.EOF And rs.BOF Then
        DHora(1) = "00:00:00"
        tc(1) = "0"
        TV(1) = "0"
        K = 2
    Else
        Do While Not rs.EOF
            DHora(K) = Format(rs!dFecCamb, "hh:mm:ss")
            tc(K) = Format(rs!nValComp, "#,#00.00")
            TV(K) = Format(rs!nValVent, "#,#00.00")
            
            TCE(K) = Format(rs!nValCompEsp, "#,#00.00")
            TVE(K) = Format(rs!nValVentEsp, "#,#00.00")

            K = K + 1
            rs.MoveNext
        Loop
    End If
    rs.Close
    Set rs = Nothing
End Sub

Public Function ImpLavDineroD(ByVal psFechaIni As String, ByVal psFechaFin As String, ByVal psNomCmac As String, _
                              ByVal psNomAge As String, ByVal psCodAge As String, pdFecSis As Date) As String
                              
Dim sql As String
Dim oCon As COMConecta.DCOMConecta
Dim rs As ADODB.Recordset
Dim lsImpre As String
Dim lsFecha As String
Dim oGen As COMDConstSistema.DCOMGeneral
Dim lnMontoMenLD As Currency
Dim lsCliente As String * 30
Dim lnMontoED As Currency
Dim lnTMontoS As Currency
Dim lnTMontoED As Currency
Dim lnTMontoD As Currency
Dim lnItem As Long
Dim lsDocId As String * 11
Dim lsAgencia As String * 15
Dim lsFechaTrans As String * 19
Dim lsCtaCod As String * 18, lsFechas As String * 10
Dim lsProducto As String * 10, lsOperacion As String * 20
Dim lnTipoCambio As Currency
Dim lnContPag As Integer
Dim lnContLin As Integer
Dim lsFechaIni As String, lsFechaFin As String
Dim lnMovNro As Long
Dim sqlaux1 As String
Dim ofuni As New COMFunciones.FCOMImpresion

    lsFechaIni = Mid(psFechaIni, 7, 4) & Mid(psFechaIni, 4, 2) & Mid(psFechaIni, 1, 2)
    lsFechaFin = Mid(psFechaFin, 7, 4) & Mid(psFechaFin, 4, 2) & Mid(psFechaFin, 1, 2)
    
    Set oGen = New COMDConstSistema.DCOMGeneral
        lnMontoMenLD = oGen.GetParametro(2000, 2032)
    Set oGen = Nothing

    lnContPag = 1:  lnItem = 0
    lsImpre = ""
    
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion

    sql = "SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, ofunf.gsFormatoFecha) & "'), dFecCamb) = 0 ORDER BY dFecCamb "

    Set rs = oCon.CargaRecordSet(sql)
        If Not (rs.EOF And rs.BOF) Then
            lnTipoCambio = rs!nValPond
        Else
            lnTipoCambio = 0
        End If
    Set rs = Nothing
    
    lsImpre = lsImpre & Space(5) & psNomCmac & Space(75) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & " " & Format(oCon.GetHoraServer(), "hh:mm:ss AMPM") & Chr(10)
    lsImpre = lsImpre & Space(5) & psNomAge & Space(30) & "OPERACIONES EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
    lsImpre = lsImpre & Space(10) & "Pag. " & lnContPag & Chr(10)
    lsImpre = lsImpre & Space(60) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
    
    lsImpre = lsImpre & String(136, "-") & Chr(10)
    'lsImpre = lsImpre & "ITEM" & Space(15) & "CLIENTE" & Space(14) & "DOC. ID" & Space(11)
    lsImpre = lsImpre & "ITEM" & Space(3)
    lsImpre = lsImpre & "AGENCIA" & Space(10) & "FECHA TRANSACCION" & Space(2) & "PRODUCTO" & Space(5) & "OPERACION"
    lsImpre = lsImpre & Space(15) & "CUENTA" & Space(15) & "MONTO SOLES" & Space(4)
    lsImpre = lsImpre & "MONTO DOLAR" & Space(2) & "USUARIO" & Chr(10)
     '& "EQUIV. DOLAR" & Space(3)
    '& Space(4) & "TOTAL DOLAR" & Space(2) & "USUARIO" & Chr(10)
    lsImpre = lsImpre & String(136, "-") & Chr(10)
    
    lnContLin = 7
        
'    sql = "SELECT nMovNro, cPersNombre, cPersIDNro,  cAgeDescripcion, Agencia, cMovNro, TipoProd, cOpeDesc, " _
'        & "cCtaCod, MontoS, MontoD, Usuario FROM (" _
'        & "SELECT LD.nMovNro, cPersNombre, cPersIDNro,  cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
'        & "TipoProd = '', cOpeDesc, cCtaCod = '', MontoS = 0, nMovImporte MontoD, SUBSTRING(cMovNro, 22,4) Usuario " _
'        & "FROM MOVCOMPRAVENTA CV INNER JOIN PERSONA P ON CV.cPersCod = P.cPersCod " _
'        & "INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod INNER JOIN MOV M ON M.nMovNro = CV.nMovNro " _
'        & "INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = CV.nMovNro " _
'        & "INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
'        & "WHERE cPersIDTpo in (1,2) AND SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "' " _
'        & " AND M.nMovFlag = 0 "

    sql = "SELECT distinct nMovNro, cAgeDescripcion, Agencia, cMovNro, TipoProd, cOpeDesc, " _
        & "cCtaCod,MONTOS,MONTOD,NMonto= case when  MontoS=0 then MontoD else montoS end , Usuario FROM (" _
        & "SELECT LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
        & "TipoProd = '', cOpeDesc, cCtaCod = '', MontoS = 0, nMovImporte MontoD, SUBSTRING(cMovNro, 22,4) Usuario " _
        & "FROM MOVCOMPRAVENTA CV " _
        & "INNER JOIN MOV M ON M.nMovNro = CV.nMovNro " _
        & "INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = CV.nMovNro " _
        & "INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
        & "WHERE SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "' " _
        & " AND M.nMovFlag = 0 "



    If psCodAge <> "" Then
        sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
    End If
    

'    sql = sql & " UNION ALL " _
'        & "SELECT LD.nMovNro, cPersNombre, cPersIDNro,  cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
'        & "TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 232 THEN 'AHORROS' WHEN 233 THEN 'PLAZOFIJO' WHEN 234 " _
'        & "THEN 'CTS' END, cOpeDesc, MC.cCtaCod, " _
'        & "MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
'        & "MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, SUBSTRING(cMovNro, 22,4) Usuario " _
'        & "FROM MOVCAP MC INNER JOIN PRODUCTOPERSONA PP ON PP.cCtaCod = MC.cCtaCod INNER JOIN " _
'        & "PERSONA P ON PP.cPersCod = P.cPersCod " _
'        & "INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
'        & "INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = MC.nMovNro " _
'        & "INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
'        & "WHERE cPersIDTpo IN (1,2) AND SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & " ' " _
'        & " AND M.nMovFlag = 0 "

sql = sql & " UNION ALL " _
          & " SELECT distinct LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
          & " TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 232 THEN 'AHORROS' WHEN 233 THEN 'PLAZOFIJO' WHEN 234 " _
          & " THEN 'CTS' END, cOpeDesc, MC.cCtaCod, " _
          & " MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
          & " MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, SUBSTRING(cMovNro, 22,4) Usuario " _
          & " FROM MOVCAP MC " _
          & " INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
          & " INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = MC.nMovNro " _
          & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
          & " WHERE mc.copecod not like  '99%' and  SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & " ' " _
          & " AND M.nMovFlag = 0 "


    If psCodAge <> "" Then
        sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
    End If
'****ANTES PARA COLOCACIONES
'    sql = sql & "UNION ALL " _
'        & " SELECT LD.nMovNro, cPersNombre, cPersIDNro,  cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, " _
'        & " cMovNro, TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END , " _
'        & " cOpeDesc, MC.cCtaCod, MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
'        & " MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, " _
'        & " SUBSTRING(cMovNro, 22,4) Usuario " _
'        & " FROM MOVCOL MC INNER JOIN PRODUCTOPERSONA PP ON PP.cCtaCod = MC.cCtaCod " _
'        & " INNER JOIN PERSONA P ON PP.cPersCod = P.cPersCod INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod " _
'        & " INNER JOIN MOV M ON M.nMovNro = MC.nMovNro INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = MC.nMovNro " _
'        & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
'        & " WHERE cPersIDTpo IN (1,2) AND SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & " ' AND '" _
'        & lsFechaFin & "' AND M.nMovFlag = 0 AND nPrdPersRelac = 20 "

'******ANTES PARA COLOCACIONES

    If psCodAge <> "" Then
        sqlaux1 = " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
    End If
'    sql = sql & " Union All " _
'        & " SELECT LD.nMovNro, cPersNombre, cPersIDNro,  cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia,  cMovNro, " _
'        & " TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END ,  cOpeDesc, MC.cCtaCod, " _
'        & " MontoS = SUM(CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN MC.nMonto ELSE 0 END) , " _
'        & " MontoD = SUM(CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN MC.nMonto ELSE 0 END) , " _
'        & " SUBSTRING(cMovNro, 22,4) Usuario " _
'        & " FROM MOVCOL MC " _
'        & " INNER JOIN PRODUCTOPERSONA PP ON PP.cCtaCod = MC.cCtaCod " _
'        & " INNER JOIN PERSONA P ON PP.cPersCod = P.cPersCod " _
'        & " INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod " _
'        & " INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
'        & " INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = MC.nMovNro " _
'        & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod " _
'        & " INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
'        & " WHERE cPersIDTpo IN (1,2) AND SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "'" _
'        & " AND M.nMovFlag = 0 AND nPrdPersRelac = 20   " & sqlaux1 _
'        & " And  not MC.cOpeCod like '107[123456789]%'" _
'        & " GROUP BY LD.nMovNro, cPersNombre, cPersIDNro,  cAgeDescripcion, SUBSTRING(cMovNro, 18,2) ,  cMovNro, " _
'        & " CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END ,  cOpeDesc, MC.cCtaCod "

       sql = sql & " Union All " _
                 & " SELECT distinct LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia,  cMovNro, " _
                 & " TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END ,  cOpeDesc, MC.cCtaCod, " _
                 & " MontoS = SUM(CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN MC.nMonto ELSE 0 END) , " _
                 & " MontoD = SUM(CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN MC.nMonto ELSE 0 END) , " _
                 & " SUBSTRING(cMovNro, 22,4) Usuario " _
                 & " FROM MOVCOL MC " _
                 & " INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
                 & " INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = MC.nMovNro " _
                 & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod " _
                 & " INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
                 & " WHERE mc.copecod not like  '99%' and  SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "'" _
                 & " AND M.nMovFlag = 0 " & sqlaux1 _
                 & " And  not MC.cOpeCod like '107[123456789]%'" _
                 & " GROUP BY LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) ,  cMovNro, " _
                 & " CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END ,  cOpeDesc, MC.cCtaCod "



    

    sql = sql & ")S ORDER BY nMovNro"
    
    Set rs = oCon.CargaRecordSet(sql)
    oCon.CierraConexion
    Set oCon = Nothing
    
    If Not (rs.EOF And rs.BOF) Then
        Do While Not rs.EOF
        
            'lsCliente = PstaNombre(rs!cPersNombre)
           ' lsDocId = rs!cPersIdNro
            lsAgencia = Mid(rs!cAgeDescripcion, 9)
            lsFechaTrans = Mid(rs!cMovNro, 7, 2) & "/" & Mid(rs!cMovNro, 5, 2) & "/" & Mid(rs!cMovNro, 1, 4) & " " & Mid(rs!cMovNro, 9, 2) + ":" & Mid(rs!cMovNro, 11, 2) & ":" & Mid(rs!cMovNro, 13, 2)
            lsProducto = rs!TipoProd
            lsOperacion = rs!cOpeDesc
            lsCtaCod = rs!cCtaCod
            If lnTipoCambio > 0 Then
                lnMontoED = rs!MontoS / lnTipoCambio
            End If

            If lnMovNro <> rs!nMovNro Then
                lnItem = lnItem + 1
                'lsImpre = lsImpre & oFunI.ImpreFormat(lnItem, 3, 0) & Space(3) & oFunI.ImpreCarEsp(lsCliente) & Space(3) & lsDocId & Space(5)
                lsImpre = lsImpre & ofuni.ImpreFormat(lnItem, 3, 0) & Space(3)
                lsImpre = lsImpre & ofuni.ImpreCarEsp(lsAgencia) & Space(2) & lsFechaTrans & Space(3) & ofuni.ImpreCarEsp(lsProducto) & Space(2)
                lsImpre = lsImpre & ofuni.ImpreCarEsp(lsOperacion) & Space(3) & lsCtaCod & Space(3) & ofuni.ImpreFormat(rs!MontoS, 9, 2, True) & Space(3)
                'lsImpre = lsImpre & oFunI.ImpreCarEsp(lsOperacion) & Space(3) & lsCtaCod & Space(3) & oFunI.ImpreFormat(rs!nMonto, 9, 2, True) & Space(3)
                'lsImpre = lsImpre & oFunI.ImpreFormat(lnMontoED, 9, 2, True) & Space(3) & oFunI.ImpreFormat(rs!MontoD, 9, 2)
                lsImpre = lsImpre & ofuni.ImpreFormat(rs!MontoD, 9, 2)
                'lsImpre = lsImpre & Space(3) & oFunI.ImpreFormat(lnMontoED + rs!MontoD, 9, 2) & Space(1) & rs!Usuario & Chr(10)
                lsImpre = lsImpre & Space(1) & rs!Usuario & Chr(10)
                lnContLin = lnContLin + 1
                lnTMontoS = lnTMontoS + rs!MontoS
                lnTMontoED = lnTMontoED + lnMontoED
                lnTMontoD = lnTMontoD + rs!MontoD
'            Else
'                lsImpre = lsImpre & Space(6) & oFunI.ImpreCarEsp(lsCliente) & Space(3) & lsDocId & Chr(10)
'                lnContLin = lnContLin + 1
            End If
            
            lnMovNro = rs!nMovNro
            
            If lnContLin >= 60 Then
                lnContPag = lnContPag + 1
                lsImpre = lsImpre & Chr(12)
                
                lsImpre = lsImpre & Space(5) & psNomCmac & Space(75) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & " " & Format(oCon.GetHoraServer(), "hh:mm:ss AMPM") & Chr(10)
                lsImpre = lsImpre & Space(5) & psNomAge & Space(30) & "OPERACIONES EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
                lsImpre = lsImpre & Space(10) & "Pag. " & lnContPag & Chr(10)
                lsImpre = lsImpre & Space(60) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
    
                
               ' lsImpre = lsImpre & Space(5) & psNomCmac & Space(170) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & " " & Format(GetHoraServer(), "hh:mm:ss AMPM") & Chr(10)
               ' lsImpre = lsImpre & Space(5) & psNomAge & Space(58) & "OPERACIONES EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
               ' lsImpre = lsImpre & Space(72) & "Pag. " & lnContPag & Chr(10) & Chr(10) & Chr(10)
                
'                lsImpre = lsImpre & String(168, "-") & Chr(10)
'               ' lsImpre = lsImpre & "ITEM" & Space(15) & "CLIENTE" & Space(14) & "DOC. ID" & Space(11)
'                lsImpre = lsImpre & "ITEM" & Space(5)
'                lsImpre = lsImpre & "AGENCIA" & Space(10) & "FECHA TRANSACCION" & Space(5) & "PRODUCTO" & Space(11) & "OPERACION"
'                lsImpre = lsImpre & Space(15) & "CUENTA" & Space(12) & "MONTO SOLES" & Space(5) & "EQUIV. DOLAR" & Space(5)
'                lsImpre = lsImpre & "MONTO DOLAR" & Space(5) & "TOTAL DOLAR" & Space(3) & "USUARIO" & Chr(10)
'                lsImpre = lsImpre & String(168, "-") & Chr(10)
                
                
                lsImpre = lsImpre & String(136, "-") & Chr(10)
                'lsImpre = lsImpre & "ITEM" & Space(15) & "CLIENTE" & Space(14) & "DOC. ID" & Space(11)
                'lsImpre = lsImpre & "ITEM" & Space(3)
                'lsImpre = lsImpre & "AGENCIA" & Space(10) & "FECHA TRANSACCION" & Space(2) & "PRODUCTO" & Space(5) & "OPERACION"
                'lsImpre = lsImpre & Space(15) & "CUENTA" & Space(15) & "MONTO SOLES" & Space(3) & "EQUIV. DOLAR" & Space(3)
                'lsImpre = lsImpre & "MONTO DOLAR" & Space(3) & "TOTAL DOLAR" & Space(2) & "USUARIO" & Chr(10)
                lsImpre = lsImpre & "ITEM" & Space(3)
                lsImpre = lsImpre & "AGENCIA" & Space(10) & "FECHA TRANSACCION" & Space(2) & "PRODUCTO" & Space(5) & "OPERACION"
                lsImpre = lsImpre & Space(15) & "CUENTA" & Space(15) & "MONTO SOLES" & Space(4)
                lsImpre = lsImpre & "MONTO DOLAR" & Space(2) & "USUARIO" & Chr(10)
                lsImpre = lsImpre & String(136, "-") & Chr(10)
    
                
                
                lnContLin = 7
                
            End If
            
            rs.MoveNext
        Loop
        
        'lsImpre = lsImpre & String(229, "-") & Chr(10)
        lsImpre = lsImpre & String(168, "-") & Chr(10)
'        lsImpre = lsImpre & Space(10) & "TOTAL   :  " & oFunI.ImpreFormat(lnItem, 3, 0) & Space(75) & oFunI.ImpreFormat(lnTMontoS, 11, 2, True) & Space(1)
'        lsImpre = lsImpre & oFunI.ImpreFormat(lnTMontoED, 11, 2, True) & Space(1) & oFunI.ImpreFormat(lnTMontoD, 11, 2, True) & Space(1)
'        lsImpre = lsImpre & oFunI.ImpreFormat(lnTMontoED + lnTMontoD, 11, 2, True) & Chr(10)
        lsImpre = lsImpre & Space(10) & "TOTAL   :  " & ofuni.ImpreFormat(lnItem, 3, 0) & Space(75) & ofuni.ImpreFormat(lnTMontoS, 11, 2, True) & Space(1)
        lsImpre = lsImpre & ofuni.ImpreFormat(lnTMontoD, 11, 2, True) & Space(1)
        lsImpre = lsImpre & Chr(10)

        lsImpre = lsImpre & String(168, "-") & Chr(10)
        
        Set rs = Nothing
    End If
    ImpLavDineroD = lsImpre
    Set ofuni = Nothing
End Function

Public Function ImpLavDineroDR(ByVal psFechaIni As String, ByVal psFechaFin As String, ByVal psNomCmac As String, _
                              ByVal psNomAge As String, ByVal psCodAge As String, pdFecSis As Date) As String
                              
Dim sql As String
Dim oCon As COMConecta.DCOMConecta
Dim rs As ADODB.Recordset
Dim lsImpre As String
Dim lsFecha As String
Dim oGen As COMDConstSistema.DCOMGeneral
Dim lnMontoMenLD As Currency
Dim lsCliente As String * 30
Dim lnMontoED As Currency
Dim lnTMontoS As Currency
Dim lnTMontoED As Currency
Dim lnTMontoD As Currency
Dim lnItem As Long
Dim lsDocId As String * 11
Dim lsAgencia As String * 15
Dim lsFechaTrans As String * 19
Dim lsCtaCod As String * 18, lsFechas As String * 10
Dim lsProducto As String * 10, lsOperacion As String * 14
Dim lsPerNomCta As String, lsDICta As String, lsPerNomTra As String, lsDITRa As String, lsPerNomBen As String, lsDIBen As String
Dim lnSaldoFIn As Currency, lsnFila As String, lsnTran As String
Dim lnTipoCambio As Currency
Dim lnContPag As Integer
Dim lnContLin As Integer
Dim lsFechaIni As String, lsFechaFin As String
Dim lnMovNro As Long
Dim sqlaux1 As String
Dim ofuni As New COMFunciones.FCOMImpresion

    lsFechaIni = Mid(psFechaIni, 7, 4) & Mid(psFechaIni, 4, 2) & Mid(psFechaIni, 1, 2)
    lsFechaFin = Mid(psFechaFin, 7, 4) & Mid(psFechaFin, 4, 2) & Mid(psFechaFin, 1, 2)
    
    Set oGen = New COMDConstSistema.DCOMConstSistema
        lnMontoMenLD = oGen.GetParametro(2000, 2032)
    Set oGen = Nothing

    lnContPag = 1:  lnItem = 0
    lsImpre = ""
    
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion

    sql = "SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, ofunf.gsFormatoFecha) & "'), dFecCamb) = 0 ORDER BY dFecCamb "

    Set rs = oCon.CargaRecordSet(sql)
        If Not (rs.EOF And rs.BOF) Then
            lnTipoCambio = rs!nValPond
        Else
            lnTipoCambio = 0
        End If
    Set rs = Nothing
    
    Dim ClsAge As COMDConstantes.DCOMAgencias, NomAgeImp As String
    Set ClsAge = New COMDConstantes.DCOMAgencias
    
    NomAgeImp = ""
    If psCodAge <> "" Then
        NomAgeImp = UCase(ClsAge.NombreAgencia(psCodAge))
    End If
        
    lsImpre = lsImpre & Chr$(27) & Chr$(77)
    
    lsImpre = lsImpre & Space(5) & psNomCmac & Space(170) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & oCon.GetHoraServer() & Chr(10)
    lsImpre = lsImpre & Space(5) & psNomAge & Space(58) & "OPERACIONES EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
    lsImpre = lsImpre & Space(72) & "Pag. " & lnContPag & Chr(10)
    lsImpre = lsImpre & Space(70) & IIf(psCodAge <> "", NomAgeImp, Space(20)) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
    
    lsImpre = lsImpre & String(220, "-") & Chr(10)
    
     If psCodAge = "" Then
              lsImpre = lsImpre & "AGENCIA    " & Space(2)
     End If
    
    lsImpre = lsImpre & "FECHA TRANSACCION" & Space(3) & "NOMBRE CLIENTE   (POO)   " & Space(1) & "No DOC.(POO)" & Space(1) & "CUENTA" & Space(13) & "No OP." & Space(1) & "No RUT." & Space(1) & "PRODUCTO  " & Space(1) & "OPERACION"
    lsImpre = lsImpre & Space(6) & "MONTO OP." & Space(1) & "SDO. FINAL  " & Space(1) & "NOMBRE CLIENTE   (PRO)  " & Space(1) & "No DOC.(PRO)" & Space(1) & "NOMBRE CLIENTE   (PBO)   " & Space(1) & "No DOC.(PBO)" & Space(1)
    lsImpre = lsImpre & "USUARIO" & Chr(10)
    lsImpre = lsImpre & String(220, "-") & Chr(10)
    
    
    lnContLin = 7
        

    sql = "SELECT distinct nMovNro, cAgeDescripcion, Agencia,cMovNro, TipoProd, cOpeDesc,  " _
        & " cCtaCod, MontoS, MontoD, Usuario, " _
        & " sperCuenta,  spernomCuenta=e1.cpersnombre,dni1=(Select top 1 cpersidnro from persid where cpersidtpo in (1,2) and cperscod=sperCuenta ), " _
        & " sperTran,  spernomTran=e2.cpersnombre ,dni2=(Select top 1 cpersidnro from persid where cpersidtpo in (1,2) and cperscod=sperTran) , " _
        & " sperBen, spernomBen= e3.cpersnombre ,dni3=(Select top 1 cpersidnro from persid where cpersidtpo in (1,2) and cperscod=sperBen ) , sSdoFinal , nfila, NroTran=dbo.GetNroTranCta(cctacod,nmovnro)   " _
        & " FROM ( " _
        & " SELECT LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
        & " TipoProd = '', cOpeDesc, cCtaCod = '', MontoS = 0, nMovImporte MontoD, sperCuenta='', sperTran='', sperBen='',sSdoFinal=0.00 , ld.nfila , SUBSTRING(cMovNro, 22,4) Usuario " _
        & " FROM MOVCOMPRAVENTA CV " _
        & " INNER JOIN MOV M ON M.nMovNro = CV.nMovNro " _
        & " INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = CV.nMovNro " _
        & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
        & " WHERE SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "' " _
        & " AND M.nMovFlag = 0 "



    If psCodAge <> "" Then
        sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
    End If
    


sql = sql & " UNION ALL " _
          & " SELECT distinct LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
          & " TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 232 THEN 'AHORROS' WHEN 233 THEN 'PLAZOFIJO' WHEN 234 " _
          & " THEN 'CTS' END, cOpeDesc, MC.cCtaCod, " _
          & " MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
          & " MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, " _
          & " sperCuenta=(Select top 1 cperscod from productopersona pp where pp.cctacod=mc.cctacod and pp.nprdpersrelac=10  ), " _
          & " sperTran=ld.cperscod, " _
          & " sperBen=isnull(ld.cperscodben,ld.cperscod) ,sSdoFinal=mc.nsaldocontable ,  ld.nfila , " _
          & " SUBSTRING(cMovNro, 22,4) Usuario " _
          & " FROM MOVCAP MC " _
          & " INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
          & " INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = MC.nMovNro " _
          & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
          & " WHERE mc.copecod not like  '9901%' and  SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & " ' " _
          & " AND M.nMovFlag = 0 "


    If psCodAge <> "" Then
        sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
    End If

    If psCodAge <> "" Then
        sqlaux1 = " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
    End If

       sql = sql & " Union All " _
                 & " SELECT distinct LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia,  cMovNro, " _
                 & " TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END ,  cOpeDesc, MC.cCtaCod, " _
                 & " MontoS = SUM(CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN MC.nMonto ELSE 0 END) , " _
                 & " MontoD = SUM(CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN MC.nMonto ELSE 0 END) , " _
                 & " sperCuenta=(Select top 1 cperscod from productopersona pp where pp.cctacod=mc.cctacod and pp.nprdpersrelac=20 ), " _
                 & " sperTran=ld.cperscod, sperBen=isnull(ld.cperscodben,ld.cperscod) ,sSdoFinal=isnull(mc.nsaldocap,0.00) , ld.nfila  , " _
                 & " SUBSTRING(cMovNro, 22,4) Usuario " _
                 & " FROM MOVCOL MC " _
                 & " INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
                 & " INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = MC.nMovNro " _
                 & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod " _
                 & " INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
                 & " WHERE mc.copecod not like  '9901%' and  SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "'" _
                 & " AND M.nMovFlag = 0 " & sqlaux1 _
                 & " And  not MC.cOpeCod like '107[123456789]%'" _
                 & " GROUP BY LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) ,  cMovNro, ld.cperscod,ld.cperscodben,mc.nsaldocap,ld.nfila, " _
                 & " CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END ,  cOpeDesc, MC.cCtaCod "



    

    sql = sql & " )S  " _
          & " join persona e1 on e1.cperscod=sperCuenta " _
          & " join persona e2 on e2.cperscod=spertran " _
          & " join persona e3 on e3.cperscod=sperBen  " _
          & " ORDER BY cMovNro"
    
    Set rs = oCon.CargaRecordSet(sql)
    oCon.CierraConexion
    Set oCon = Nothing
    
    If Not (rs.EOF And rs.BOF) Then
        Do While Not rs.EOF
        
            'lsCliente = PstaNombre(rs!cPersNombre)
           ' lsDocId = rs!cPersIdNro
            lsAgencia = Mid(Trim(rs!cAgeDescripcion), 9)
            lsFechaTrans = Mid(rs!cMovNro, 7, 2) & "/" & Mid(rs!cMovNro, 5, 2) & "/" & Mid(rs!cMovNro, 1, 4) & " " & Mid(rs!cMovNro, 9, 2) + ":" & Mid(rs!cMovNro, 11, 2) & ":" & Mid(rs!cMovNro, 13, 2)
            lsProducto = rs!TipoProd
            lsOperacion = UCase(Left(Trim(rs!cOpeDesc), 14))
            lsCtaCod = rs!cCtaCod
            lsPerNomCta = Left(Trim(rs!spernomcuenta), 25)
            lsDICta = Left(Trim(IIf(IsNull(rs!dni1), "        ", rs!dni1)), 12)
            lsPerNomTra = Left(Trim(rs!spernomtran), 25)
            lsDITRa = Left(Trim(IIf(IsNull(rs!dni2), "        ", rs!dni2)), 12)
            lsPerNomBen = Left(Trim(rs!spernomben), 25)
            lsDIBen = Left(Trim(IIf(IsNull(rs!dni3), "        ", rs!dni3)), 12)
            lnSaldoFIn = rs!sSdoFinal
            lsnFila = Format(rs!nFila, "000000")
            lsnTran = Format(rs!nrotran, "000000")
            
            If lnTipoCambio > 0 Then
                lnMontoED = rs!MontoS / lnTipoCambio
            End If

            If lnMovNro <> rs!nMovNro Then
                lnItem = lnItem + 1
                'lsImpre = lsImpre & oFunI.ImpreFormat(lnItem, 3, 0) & Space(3) & oFunI.ImpreCarEsp(lsCliente) & Space(3) & lsDocId & Space(5)
                'lsImpre = lsImpre & oFunI.ImpreFormat(lnItem, 3, 0) & Space(3)
                If psCodAge = "" Then
                    lsImpre = lsImpre & ofuni.ImpreCarEsp(lsAgencia) & Space(1)
                End If
                
                lsImpre = lsImpre & lsFechaTrans & Space(1) & ofuni.ImpreCarEsp(lsPerNomCta) & Space(26 - Len(lsPerNomCta)) & lsDICta & Space(13 - Len(lsDICta)) & lsCtaCod & Space(1) & lsnTran & Space(1) & lsnFila & Space(1) & ofuni.ImpreCarEsp(lsProducto) & Space(1)
                lsImpre = lsImpre & ofuni.ImpreCarEsp(lsOperacion) & Space(15 - Len(lsOperacion)) & ofuni.ImpreFormat(IIf(rs!MontoS = 0, rs!MontoS, rs!MontoD), 9, 2, True) & Space(1)
                lsImpre = lsImpre & ofuni.ImpreFormat(lnSaldoFIn, 10, 2, True) & Space(1)
                lsImpre = lsImpre & ofuni.ImpreCarEsp(lsPerNomTra) & Space(26 - Len(lsPerNomTra)) & lsDITRa & Space(13 - Len(lsDITRa)) & ofuni.ImpreCarEsp(lsPerNomBen) & Space(26 - Len(lsPerNomBen)) & lsDIBen & Space(13 - Len(lsDIBen)) & rs!Usuario & Chr(10)
                
                lnContLin = lnContLin + 1
                lnTMontoS = lnTMontoS + rs!MontoS
                lnTMontoED = lnTMontoED + lnMontoED
                lnTMontoD = lnTMontoD + rs!MontoD
'            Else
'                lsImpre = lsImpre & Space(6) & oFunI.ImpreCarEsp(lsCliente) & Space(3) & lsDocId & Chr(10)
'                lnContLin = lnContLin + 1
            End If
            
            lnMovNro = rs!nMovNro
            
            If lnContLin >= 60 Then
                lnContPag = lnContPag + 1
                lsImpre = lsImpre & Chr(12)
                
                lsImpre = lsImpre & Space(5) & psNomCmac & Space(170) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & oCon.GetHoraServer() & Chr(10)
                lsImpre = lsImpre & Space(5) & psNomAge & Space(58) & "OPERACIONES EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
                lsImpre = lsImpre & Space(72) & "Pag. " & lnContPag & Chr(10) & Chr(10) & Chr(10)
                lsImpre = lsImpre & Space(70) & IIf(psCodAge <> "", NomAgeImp, Space(20)) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
               
                
             lsImpre = lsImpre & String(220, "-") & Chr(10)
                If psCodAge = "" Then
                    lsImpre = lsImpre & "AGENCIA    " & Space(2)
                End If
             lsImpre = lsImpre & "FECHA TRANSACCION" & Space(3) & "NOMBRE CLIENTE   (POO)   " & Space(1) & "No DOC.(POO)" & Space(1) & "CUENTA" & Space(13) & "No OP." & Space(1) & "No RUT." & Space(1) & "PRODUCTO  " & Space(1) & "OPERACION"
             lsImpre = lsImpre & Space(6) & "MONTO OP." & Space(1) & "SDO. FINAL  " & Space(1) & "NOMBRE CLIENTE   (PRO)  " & Space(1) & "No DOC.(PRO)" & Space(1) & "NOMBRE CLIENTE   (PBO)   " & Space(1) & "No DOC.(PBO)" & Space(1)
             lsImpre = lsImpre & "USUARIO" & Chr(10)
             lsImpre = lsImpre & String(220, "-") & Chr(10)
    
                               
                lnContLin = 7
                
            End If
            
            rs.MoveNext
        Loop
        
        'lsImpre = lsImpre & String(229, "-") & Chr(10)
        lsImpre = lsImpre & String(220, "-") & Chr(10)
        lsImpre = lsImpre & Space(10) & "TOTAL   :  " & ofuni.ImpreFormat(lnItem, 3, 0) & Space(75) & ofuni.ImpreFormat(lnTMontoS, 11, 2, True) & Space(1)
        lsImpre = lsImpre & ofuni.ImpreFormat(lnTMontoED, 11, 2, True) & Space(1) & ofuni.ImpreFormat(lnTMontoD, 11, 2, True) & Space(1)
        lsImpre = lsImpre & ofuni.ImpreFormat(lnTMontoED + lnTMontoD, 11, 2, True) & Chr(10)
        lsImpre = lsImpre & String(220, "-") & Chr(10)
        
        Set rs = Nothing
    End If

    ImpLavDineroDR = lsImpre
    Set ofuni = Nothing
    Set ClsAge = Nothing
End Function

Public Function ImpLavDineroDR2(ByVal psFechaIni As String, ByVal psFechaFin As String, ByVal psNomCmac As String, _
                              ByVal psNomAge As String, ByVal psCodAge As String, pdFecSis As Date) As String
                              
Dim sql As String
Dim oCon As COMConecta.DCOMConecta
Dim rs As Recordset
Dim lsImpre As String
Dim lsFecha As String
Dim oGen As COMDConstSistema.DCOMGeneral
Dim lnMontoMenLD As Currency
Dim lsCliente As String * 30
Dim lnMontoED As Currency
Dim lnTMontoS As Currency
Dim lnTMontoED As Currency
Dim lnTMontoD As Currency
Dim lnItem As Long
Dim lsDocId As String * 11
Dim lsAgencia As String * 15
Dim lsFechaTrans As String * 19
Dim lsCtaCod As String * 18, lsFechas As String * 10
Dim lsProducto As String * 10, lsOperacion As String * 14
Dim lsPerNomCta As String, lsDICta As String, lsPerNomTra As String, lsDITRa As String, lsPerNomBen As String, lsDIBen As String
Dim lnSaldoFIn As Currency, lsnFila As String, lsnTran As String
Dim lnTipoCambio As Currency
Dim lnContPag As Integer
Dim lnContLin As Integer
Dim lsFechaIni As String, lsFechaFin As String
Dim lnMovNro As Long
Dim sqlaux1 As String

Dim ofuni As New COMFunciones.FCOMImpresion
Dim ofunc As New COMFunciones.FCOMCadenas

    lsFechaIni = Mid(psFechaIni, 7, 4) & Mid(psFechaIni, 4, 2) & Mid(psFechaIni, 1, 2)
    lsFechaFin = Mid(psFechaFin, 7, 4) & Mid(psFechaFin, 4, 2) & Mid(psFechaFin, 1, 2)
    
    Set oGen = New COMDConstSistema.DCOMGeneral
        lnMontoMenLD = oGen.GetParametro(2000, 2032)
    Set oGen = Nothing

    lnContPag = 1:  lnItem = 0
    lsImpre = ""
    
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion

    sql = "SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, ofunf.gsFormatoFecha) & "'), dFecCamb) = 0 ORDER BY dFecCamb "

    Set rs = oCon.CargaRecordSet(sql)
        If Not (rs.EOF And rs.BOF) Then
            lnTipoCambio = rs!nValPond
        Else
            lnTipoCambio = 0
        End If
    Set rs = Nothing
    
    Dim ClsAge As COMDConstantes.DCOMAgencias, NomAgeImp As String
    Set ClsAge = New COMDConstantes.DCOMAgencias
    
    NomAgeImp = ""
    If psCodAge <> "" Then
        NomAgeImp = UCase(ClsAge.NombreAgencia(psCodAge))
    End If
        
    lsImpre = lsImpre & Chr$(27) & Chr$(77)
    
    lsImpre = lsImpre & Space(5) & psNomCmac & Space(170) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & oCon.GetHoraServer() & Chr(10)
    lsImpre = lsImpre & Space(5) & psNomAge & Space(58) & "OPERACIONES EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
    lsImpre = lsImpre & Space(72) & "Pag. " & lnContPag & Chr(10)
    lsImpre = lsImpre & Space(70) & IIf(psCodAge <> "", NomAgeImp, Space(20)) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
    
    lsImpre = lsImpre & String(220, "-") & Chr(10)
    
     If psCodAge = "" Then
              lsImpre = lsImpre & "AGENCIA    " & Space(2)
     End If
    
    lsImpre = lsImpre & "FECHA TRANSACCION" & Space(3) & "NOMBRE CLIENTE   (POO)   " & Space(1) & "No DOC.(POO)" & Space(1) & "CUENTA" & Space(13) & "No OP." & Space(1) & "No RUT." & Space(1) & "PRODUCTO  " & Space(1) & "OPERACION"
    lsImpre = lsImpre & Space(6) & "MONTO OP." & Space(1) & "SDO. FINAL  " & Space(1) & "NOMBRE CLIENTE   (PRO)  " & Space(1) & "No DOC.(PRO)" & Space(1) & "NOMBRE CLIENTE   (PBO)   " & Space(1) & "No DOC.(PBO)" & Space(1)
    lsImpre = lsImpre & "USUARIO" & Chr(10)
    lsImpre = lsImpre & String(220, "-") & Chr(10)
    
    
    lnContLin = 7
        

    sql = "SELECT distinct nMovNro, cAgeDescripcion, Agencia,cMovNro=substring(cMovnro, 7, 2) + '/' + substring(cMovnro, 5, 2) + '/' + substring(cMovnro, 1, 4) + ' ' + substring(cMovnro, 9, 2) + ':' + substring(cMovnro, 11, 2) + ':' + substring(cMovnro, 13, 2)  , TipoProd, cOpeDesc,  " _
        & " cCtaCod,nMontos=case when MontoS=0 then MontoD else montoS end ,MontoS,MontoD, Usuario, " _
        & " sperCuenta,  spernomCuenta=e1.cpersnombre,dni1=(Select top 1 cpersidnro from persid where cpersidtpo in (1,2) and cperscod=sperCuenta ), " _
        & " sperTran,  spernomTran=e2.cpersnombre ,dni2=(Select top 1 cpersidnro from persid where cpersidtpo in (1,2) and cperscod=sperTran) , " _
        & " sperBen, spernomBen= e3.cpersnombre ,dni3=(Select top 1 cpersidnro from persid where cpersidtpo in (1,2) and cperscod=sperBen ) , sSdoFinal , nfila= dbo.GetNroLavDinero(Nmovnro)  , NroTran=dbo.GetNroTranCta(cctacod,nmovnro)   " _
        & " FROM ( " _
        & " SELECT LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
        & " TipoProd = '', cOpeDesc, cCtaCod = '', MontoS = 0, nMovImporte MontoD, sperCuenta='', sperTran='', sperBen='',sSdoFinal=0.00 ,  SUBSTRING(cMovNro, 22,4) Usuario " _
        & " FROM MOVCOMPRAVENTA CV " _
        & " INNER JOIN MOV M ON M.nMovNro = CV.nMovNro " _
        & " INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = CV.nMovNro " _
        & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
        & " WHERE SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "' " _
        & " AND M.nMovFlag = 0 "



    If psCodAge <> "" Then
        sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
    End If
    


sql = sql & " UNION ALL " _
          & " SELECT distinct LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
          & " TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 232 THEN 'AHORROS' WHEN 233 THEN 'PLAZOFIJO' WHEN 234 " _
          & " THEN 'CTS' END, cOpeDesc, MC.cCtaCod, " _
          & " MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
          & " MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, " _
          & " sperCuenta=(Select top 1 cperscod from productopersona pp where pp.cctacod=mc.cctacod and pp.nprdpersrelac=10  ), " _
          & " sperTran=ld.cperscod, " _
          & " sperBen=isnull(ld.cperscodben,ld.cperscod) ,sSdoFinal=mc.nsaldocontable ,   " _
          & " SUBSTRING(cMovNro, 22,4) Usuario " _
          & " FROM MOVCAP MC " _
          & " INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
          & " INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = MC.nMovNro " _
          & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
          & " WHERE mc.copecod not like  '99%' and  SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & " ' " _
          & " AND M.nMovFlag = 0 "


    If psCodAge <> "" Then
        sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
    End If

    If psCodAge <> "" Then
        sqlaux1 = " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
    End If

       sql = sql & " Union All " _
                 & " SELECT distinct LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia,  cMovNro, " _
                 & " TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END ,  cOpeDesc, MC.cCtaCod, " _
                 & " MontoS = SUM(CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN MC.nMonto ELSE 0 END) , " _
                 & " MontoD = SUM(CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN MC.nMonto ELSE 0 END) , " _
                 & " sperCuenta=(Select top 1 cperscod from productopersona pp where pp.cctacod=mc.cctacod and pp.nprdpersrelac=20 ), " _
                 & " sperTran=ld.cperscod, sperBen=isnull(ld.cperscodben,ld.cperscod) ,sSdoFinal=isnull(mc.nsaldocap,0.00) ,  " _
                 & " SUBSTRING(cMovNro, 22,4) Usuario " _
                 & " FROM MOVCOL MC " _
                 & " INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
                 & " INNER JOIN MOVLAVDINERO LD ON LD.nMovNro = MC.nMovNro " _
                 & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod " _
                 & " INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
                 & " WHERE mc.copecod not like  '99%' and  SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "'" _
                 & " AND M.nMovFlag = 0 " & sqlaux1 _
                 & " And  not MC.cOpeCod like '107[123456789]%'" _
                 & " GROUP BY LD.nMovNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) ,  cMovNro, ld.cperscod,ld.cperscodben,mc.nsaldocap, " _
                 & " CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END ,  cOpeDesc, MC.cCtaCod "



    

    sql = sql & " )S  " _
          & " join persona e1 on e1.cperscod=sperCuenta " _
          & " join persona e2 on e2.cperscod=spertran " _
          & " join persona e3 on e3.cperscod=sperBen  " _
          & " ORDER BY nmovnro"
    
    Set rs = oCon.CargaRecordSet(sql)
    oCon.CierraConexion
    Set oCon = Nothing
    
    If Not (rs.EOF And rs.BOF) Then
    
'    Dim oRep As DRLAVADO
'    Set oRep = New DRLAVADO
'    oRep.Orientation = rptOrientLandscape
'    Set oRep.DataSource = rs
'            oRep.Sections("CABEZA").Controls("LBLAGENCIA").Caption = NomAgeImp
'            oRep.Sections("CABEZA").Controls("LBLTIT2").Caption = "MONTO >= A: U$ " & lnMontoMenLD & " DEL " & psFechaIni & " AL " & psFechaFin
'            oRep.Sections("CABEZA").Controls("LBLIMPRESO").Caption = "IMPRESO: " & Format(pdFecSis, "dd/mm/yyyy") & " " & Format(GetHoraServer(), "hh:mm:ss AMPM")
'
'
'    oRep.Show 1

    Set oRep = Nothing
        Do While Not rs.EOF

            'lsCliente = PstaNombre(rs!cPersNombre)
           ' lsDocId = rs!cPersIdNro
            lsAgencia = Mid(Trim(rs!cAgeDescripcion), 9)
            lsFechaTrans = Mid(rs!cMovNro, 7, 2) & "/" & Mid(rs!cMovNro, 5, 2) & "/" & Mid(rs!cMovNro, 1, 4) & " " & Mid(rs!cMovNro, 9, 2) + ":" & Mid(rs!cMovNro, 11, 2) & ":" & Mid(rs!cMovNro, 13, 2)
            lsProducto = rs!TipoProd
            lsOperacion = UCase(Left(Trim(rs!cOpeDesc), 14))
            lsCtaCod = rs!cCtaCod
            lsPerNomCta = Left(Trim(rs!spernomcuenta), 25)
            lsDICta = Left(Trim(IIf(IsNull(rs!dni1), "        ", rs!dni1)), 12)
            lsPerNomTra = Left(Trim(rs!spernomtran), 25)
            lsDITRa = Left(Trim(IIf(IsNull(rs!dni2), "        ", rs!dni2)), 12)
            lsPerNomBen = Left(Trim(rs!spernomben), 25)
            lsDIBen = Left(Trim(IIf(IsNull(rs!dni3), "        ", rs!dni3)), 12)
            lnSaldoFIn = rs!sSdoFinal
            lsnFila = Format(rs!nFila, "000000")
            lsnTran = Format(rs!nrotran, "000000")

            If lnTipoCambio > 0 Then
                lnMontoED = rs!nMontoS / lnTipoCambio
            End If

            If lnMovNro <> rs!nMovNro Then
                lnItem = lnItem + 1
                'lsImpre = lsImpre & oFunI.ImpreFormat(lnItem, 3, 0) & Space(3) & oFunI.ImpreCarEsp(lsCliente) & Space(3) & lsDocId & Space(5)
                'lsImpre = lsImpre & oFunI.ImpreFormat(lnItem, 3, 0) & Space(3)
                If psCodAge = "" Then
                    lsImpre = lsImpre & ofuni.ImpreCarEsp(lsAgencia) & Space(1)
                End If

                lsImpre = lsImpre & lsFechaTrans & Space(1) & ofuni.ImpreCarEsp(lsPerNomCta) & Space(26 - Len(lsPerNomCta)) & lsDICta & Space(13 - Len(lsDICta)) & lsCtaCod & Space(1) & lsnTran & Space(1) & lsnFila & Space(1) & ofuni.ImpreCarEsp(lsProducto) & Space(1)
                lsImpre = lsImpre & ofuni.ImpreCarEsp(lsOperacion) & Space(15 - Len(lsOperacion)) & ofuni.ImpreFormat(rs!nMontoS, 9, 2, True) & Space(1)
                lsImpre = lsImpre & ofuni.ImpreFormat(lnSaldoFIn, 10, 2, True) & Space(1)
                lsImpre = lsImpre & ofuni.ImpreCarEsp(lsPerNomTra) & Space(26 - Len(lsPerNomTra)) & lsDITRa & Space(13 - Len(lsDITRa)) & ofuni.ImpreCarEsp(lsPerNomBen) & Space(26 - Len(lsPerNomBen)) & lsDIBen & Space(13 - Len(lsDIBen)) & rs!Usuario & Chr(10)

                lnContLin = lnContLin + 1
                lnTMontoS = lnTMontoS + rs!MontoS
                lnTMontoED = lnTMontoED + lnMontoED
                lnTMontoD = lnTMontoD + rs!MontoD
'            Else
'                lsImpre = lsImpre & Space(6) & oFunI.ImpreCarEsp(lsCliente) & Space(3) & lsDocId & Chr(10)
'                lnContLin = lnContLin + 1
            End If

            lnMovNro = rs!nMovNro

            If lnContLin >= 60 Then
                lnContPag = lnContPag + 1
                lsImpre = lsImpre & Chr(12)

                lsImpre = lsImpre & Space(5) & psNomCmac & Space(170) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & oCon.GetHoraServer() & Chr(10)
                lsImpre = lsImpre & Space(5) & psNomAge & Space(58) & "OPERACIONES EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
                lsImpre = lsImpre & Space(72) & "Pag. " & lnContPag & Chr(10) & Chr(10) & Chr(10)
                lsImpre = lsImpre & Space(70) & IIf(psCodAge <> "", NomAgeImp, Space(20)) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)


             lsImpre = lsImpre & String(220, "-") & Chr(10)
                If psCodAge = "" Then
                    lsImpre = lsImpre & "AGENCIA    " & Space(2)
                End If
             lsImpre = lsImpre & "FECHA TRANSACCION" & Space(3) & "NOMBRE CLIENTE   (POO)   " & Space(1) & "No DOC.(POO)" & Space(1) & "CUENTA" & Space(13) & "No OP." & Space(1) & "No RUT." & Space(1) & "PRODUCTO  " & Space(1) & "OPERACION"
             lsImpre = lsImpre & Space(6) & "MONTO OP." & Space(1) & "SDO. FINAL  " & Space(1) & "NOMBRE CLIENTE   (PRO)  " & Space(1) & "No DOC.(PRO)" & Space(1) & "NOMBRE CLIENTE   (PBO)   " & Space(1) & "No DOC.(PBO)" & Space(1)
             lsImpre = lsImpre & "USUARIO" & Chr(10)
             lsImpre = lsImpre & String(220, "-") & Chr(10)


                lnContLin = 7

            End If

            rs.MoveNext
        Loop
        
        lsImpre = lsImpre & String(229, "-") & Chr(10)
        lsImpre = lsImpre & String(220, "-") & Chr(10)
        lsImpre = lsImpre & Space(10) & "TOTAL   :  " & ofuni.ImpreFormat(lnItem, 3, 0) & Space(75) & ofuni.ImpreFormat(lnTMontoS, 11, 2, True) & Space(1)
        lsImpre = lsImpre & ofuni.ImpreFormat(lnTMontoED, 11, 2, True) & Space(1) & ofuni.ImpreFormat(lnTMontoD, 11, 2, True) & Space(1)
        lsImpre = lsImpre & ofuni.ImpreFormat(lnTMontoED + lnTMontoD, 11, 2, True) & Chr(10)
        lsImpre = lsImpre & String(220, "-") & Chr(10)
        
        Set rs = Nothing
    End If

    ImpLavDineroDR2 = lsImpre
    
End Function






Public Function ImpLavDineroM(ByVal psFechaIni As String, ByVal psFechaFin As String, ByVal psNomCmac As String, _
                              ByVal psNomAge As String, ByVal psCodAge As String, pdFecSis As Date) As String

Dim sql As String
Dim oCon As COMConecta.DCOMConecta
Dim rs As ADODB.Recordset
Dim rsDet As ADODB.Recordset
Dim lsImpre As String
Dim oGen As COMDConstSistema.DCOMGeneral
Dim lnMontoMenLD As Currency
Dim lsCliente As String * 40
Dim lnMontoED As Currency
Dim lnTCMontoS As Currency
Dim lnTCMontoED As Currency
Dim lnTCMontoD As Currency
Dim lnTMontoS As Currency
Dim lnTMontoED As Currency
Dim lnTMontoD As Currency
Dim lnItem As Long, lnTCItem As Long, lnTItem As Long
Dim lsDocId As String * 8
Dim lsAgencia As String * 15, lsFechaTrans As String * 19
Dim lsCtaCod As String * 18, lsFechas As String * 10
Dim lsProducto As String * 10, lsOperacion As String * 15
Dim lnTipoCambio As Currency
Dim lnContPag As Integer
Dim lnContLin As Integer
Dim lsFechaIni As String, lsFechaFin As String
Dim ofuni As New COMFunciones.FCOMImpresion
Dim ofunc As New COMFunciones.FCOMCadenas

    Set oGen = New COMDConstSistema.DCOMGeneral
        lnMontoMenLD = oGen.GetParametro(2000, 2033)
    Set oGen = Nothing

    lnContPag = 1:  lnItem = 0
    lnTCItem = 0: lnTItem = 0
    lsImpre = ""
    
    lsFechaIni = Mid(psFechaIni, 7, 4) & Mid(psFechaIni, 4, 2) & Mid(psFechaIni, 1, 2)
    lsFechaFin = Mid(psFechaFin, 7, 4) & Mid(psFechaFin, 4, 2) & Mid(psFechaFin, 1, 2)
        
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion

    'Sql = "SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, oFunF.gsFormatoFecha) & "'), dFecCamb) = 0 ORDER BY dFecCamb"

    sql = "SELECT TOP 1 nValFijo FROM TIPOCAMBIO WHERE datediff(d, dateadd(d, 1 , '" _
        & Format(psFechaFin, ofunf.gsFormatoFecha) & "'), dFecCamb) = 0 ORDER BY dFecCamb"

    Set rs = oCon.CargaRecordSet(sql)
        If Not (rs.EOF And rs.BOF) Then
            lnTipoCambio = rs!nValFijo
        Else
            lnTipoCambio = 0
        End If
    Set rs = Nothing
      
    lsImpre = lsImpre & psNomCmac & Space(125) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & " " & Format(oCon.GetHoraServer(), "hh:mm:ss AMPM") & Chr(10)
    lsImpre = lsImpre & psNomAge & Space(18) & "OPERACIONES ACUMULADAS MENSUALES EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
    lsImpre = lsImpre & Space(46) & "Pag. " & lnContPag & Chr(10)
    lsImpre = lsImpre & Space(80) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
    
    lnContLin = 4
    
    'Sql = " SELECT C.cPersCod, cPersNombre, cPersIDNro, Monto FROM " _
        & " (SELECT cPersCod, SUM(MontoS/TipoCambio + MontoD) AS Monto FROM " _
        & " (SELECT CV.cPersCod, MontoS = 0, nMovImporte MontoD, " _
        & " TipoCambio = (SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, oFunF.gsFormatoFecha) & "'), dFecCamb) = 0) " _
        & " FROM MOVCOMPRAVENTA CV INNER JOIN MOV M ON CV.nMovNro = M.nMovNro " _
        & " WHERE SUBSTRING(cMovNro,1,8) BETWEEN '" _
        & lsFechaIni & "' AND '" & lsFechaFin & "' AND M.nMovFlag = 0 "
       
       sql = " SELECT C.cPersCod, cPersNombre, cPersIDNro, Monto FROM " _
        & " (SELECT cPersCod, SUM(MontoS/TipoCambio + MontoD) AS Monto FROM " _
        & " (SELECT CV.cPersCod, MontoS = 0, nMovImporte MontoD, " _
        & " TipoCambio = (SELECT TOP 1 nValFijo FROM TIPOCAMBIO WHERE datediff(d, dateadd(d,1 , '" _
        & Format(psFechaFin, ofunf.gsFormatoFecha) & "'), dFecCamb) = 0) " _
        & " FROM MOVCOMPRAVENTA CV INNER JOIN MOV M ON CV.nMovNro = M.nMovNro " _
        & " WHERE SUBSTRING(cMovNro,1,8) BETWEEN '" _
        & lsFechaIni & "' AND '" & lsFechaFin & "' AND M.nMovFlag = 0 "
   
   If psCodAge <> "" Then
        sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
   End If
   
'   sql = sql & "UNION All " _
        & " SELECT cPersCod = (SELECT TOP 1 cPersCod FROM PRODUCTOPERSONA PP WHERE PP.cCtaCod = MC.cCtaCod ORDER BY cPersCod), " _
        & " MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
        & " MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, " _
        & " TipoCambio = (SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, oFunF.gsFormatoFecha) & "'), dFecCamb) = 0) " _
        & " FROM MOVCAP MC INNER JOIN MOV M ON MC.nMovNro = M.nMovNro AND SUBSTRING(cMovNro,1,8) BETWEEN '" _
        & lsFechaIni & "' AND '" & lsFechaFin & "' AND M.nMovFlag = 0 AND " _
        & " M.cOpeCod in (" _
        & " SELECT GO.cOpeCod From GrupoOpe G JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
        & " WHERE G.nEfectivo = 1 and not cOpeCod like '9010%' and cOpeCod not in (401401, 402401) " _
        & " And cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "
   
   sql = sql & "UNION All " _
        & " SELECT cPersCod = (SELECT TOP 1 cPersCod FROM PRODUCTOPERSONA PP WHERE   pp.nprdpersrelac=10 and PP.cCtaCod = MC.cCtaCod ORDER BY cPersCod), " _
        & " MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
        & " MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, " _
        & " TipoCambio = (SELECT TOP 1 nValFijo FROM TIPOCAMBIO WHERE datediff(d, dateadd(d,1, '" _
        & Format(psFechaFin, ofunf.gsFormatoFecha) & "'), dFecCamb) = 0) " _
        & " FROM MOVCAP MC " _
        & " INNER JOIN MOV M ON MC.nMovNro = M.nMovNro AND SUBSTRING(cMovNro,1,8) BETWEEN '" _
        & lsFechaIni & "' AND '" & lsFechaFin & "' AND M.nMovFlag = 0  and " _
        & " Mc.cOpeCod not in (401401, 402401) and  Mc.cOpeCod not like '9010%'  and Mc.cOpeCod not like '99%' and mc.copecod not in ('201001','210701','220601') "
        
    If psCodAge <> "" Then
         sql = sql & " AND SUBSTRING(MC.cCtaCod, 4,2) = '" & psCodAge & "'"
    End If
        
    'Sql = Sql & "UNION All " _
        & "SELECT cPersCod, " _
        & "MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
        & "MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, " _
        & "TipoCambio = (SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, oFunF.gsFormatoFecha) & "'), dFecCamb) = 0) " _
        & "FROM MOVCOL MC " _
        & " inner join productopersona pp on MC.cctacod=pp.cctacod " _
        & " INNER JOIN MOV M ON MC.nMovNro = M.nMovNro AND SUBSTRING(cMovNro,1,8) BETWEEN '" _
        & lsFechaIni & "' AND '" & lsFechaFin & "' AND M.nMovFlag = 0 AND pp.nprdPersRelac=20 AND " _
        & " M.cOpeCod in (" _
        & " SELECT GO.cOpeCod From GrupoOpe G JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
        & " WHERE G.nEfectivo = 1 and not cOpeCod like '9010%' and cOpeCod not in (401401, 402401) " _
        & " And cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "
  
'*************MODIFICADO
'    sql = sql & "UNION All " _
'        & "SELECT cPersCod, " _
'        & "MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
'        & "MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, " _
'        & "TipoCambio = (SELECT TOP 1 nValFijo FROM TIPOCAMBIO WHERE datediff(d, dateadd(d, 1, '" _
'        & Format(psFechaFin, oFunF.gsFormatoFecha) & "'), dFecCamb) = 0) " _
'        & "FROM MOVCOL MC " _
'        & " inner join productopersona pp on MC.cctacod=pp.cctacod " _
'        & " INNER JOIN MOV M ON MC.nMovNro = M.nMovNro AND SUBSTRING(cMovNro,1,8) BETWEEN '" _
'        & lsFechaIni & "' AND '" & lsFechaFin & "' AND M.nMovFlag = 0 AND pp.nprdPersRelac=20 AND " _
'        & " M.cOpeCod in (" _
'        & " SELECT GO.cOpeCod From GrupoOpe G JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
'        & " WHERE G.nEfectivo = 1 and not cOpeCod like '9010%' and cOpeCod not in (401401, 402401) " _
'        & " And cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "
                   
        sql = sql & "UNION ALL " _
            & " SELECT pp.cPersCod, " _
            & " MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
            & " MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, " _
            & " TipoCambio = (SELECT TOP 1 nValFijo " _
            & " From TipoCambio " _
            & " WHERE datediff(d, dateadd(d, 1, '" & Format(psFechaFin, ofunf.gsFormatoFecha) & "'), dFecCamb) = 0) " _
            & "   From  MOVCOL MC " _
            & "   Inner Join productopersona pp on MC.cctacod=pp.cctacod and pp.nprdpersrelac=20 " _
            & " Inner Join colocaccred cc on cc.cctacod=mc.cctacod " _
            & " Inner Join  MOV M ON MC.nMovNro = M.nMovNro AND SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "' AND M.nMovFlag = 0 " _
            & " And  pp.nprdPersRelac=20 AND  Mc.cOpeCod in ( SELECT GO.cOpeCod " _
            & "                                             From GrupoOpe G JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
            & "                                            WHERE G.nEfectivo = 1 and not cOpeCod like '9010%' and cOpeCod not in (401401, 402401) and copecod not like '99%') "
            '& "                                             And cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "

                   
                   
                   
                   
'*************************
                   
    If psCodAge <> "" Then
         sql = sql & " AND SUBSTRING(MC.cCtaCod, 4,2) = '" & psCodAge & "'"
    End If
        
    sql = sql & ") S " _
        & "GROUP BY cPersCod) C " _
        & "INNER JOIN PERSONA P On C.cPersCod = P.cPersCod INNER JOIN PERSID DI ON DI.cPersCod = C.cPersCod " _
        & "WHERE Monto >= " & lnMontoMenLD & " AND cPersIDTpo in (1,2) "
        
     'Sql = Sql & ") S " _
        & "GROUP BY cPersCod) C " _
        & "INNER JOIN PERSONA P On C.cPersCod = P.cPersCod " _
        & "WHERE Monto >= " & lnMontoMenLD & ""
        
        
    Set rs = oCon.CargaRecordSet(sql)

    If Not (rs.EOF And rs.BOF) Then
        Do While Not rs.EOF
                
            If lnContLin > 52 Then
                lnContPag = lnContPag + 1
                lsImpre = lsImpre & Chr(12)
                lsImpre = lsImpre & psNomCmac & Space(125) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & oCon.GetHoraServer() & Chr(10)
                lsImpre = lsImpre & psNomAge & Space(18) & "OPERACIONES ACUMULADAS MENSUALES EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
                lsImpre = lsImpre & Space(46) & "Pag. " & lnContPag & Chr(10)
                lsImpre = lsImpre & Space(80) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
                lnContLin = 4
            End If
            
            lsCliente = ofunc.PstaNombre(rs!cpersnombre)
            lsDocId = rs!cPersIdNro
            
            lsImpre = lsImpre & rs!cPersCod & Space(3) & ofuni.ImpreCarEsp(lsCliente) & Space(5) & lsDocId & Chr(10)
            
            lsImpre = lsImpre & String(180, "-") & Chr(10)
            lsImpre = lsImpre & "ITEM" & Space(3) & "AGENCIA" & Space(13) & "FECHA TRANSACCION" & Space(5) & "PRODUCTO"
            lsImpre = lsImpre & Space(8) & "OPERACION" & Space(15) & "CUENTA" & Space(14) & "MONTO SOLES" & Space(5)
            lsImpre = lsImpre & "EQUIV. DOLAR" & Space(5) & "MONTO DOLAR" & Space(5) & "TOTAL DOLAR" & Space(4) & "USUARIO" & Chr(10)
            lsImpre = lsImpre & String(180, "-") & Chr(10)
            
            lnContLin = lnContLin + 4
            
            sql = " SELECT nMovNro, cPersNombre, cPersIDNro, cAgeDescripcion, Agencia, cMovNro, TipoProd, cOpeDesc, " _
                & " cCtaCod, MontoS, MontoD, SUBSTRING(cMovNro, 22,4) Usuario FROM (" _
                & " SELECT M.nMovNro, cPersNombre, cPersIDNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
                & " TipoProd = '', cOpeDesc, cCtaCod = '', MontoS = 0, nMovImporte MontoD, SUBSTRING(cMovNro, 22,4) Usuario  " _
                & " FROM MOVCOMPRAVENTA CV INNER JOIN PERSONA P ON CV.cPersCod = P.cPersCod " _
                & " INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod INNER JOIN MOV M ON M.nMovNro = CV.nMovNro " _
                & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod " _
                & " INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
                & " WHERE cPersIDTpo in (1,2) AND CV.cPersCod = '" & rs!cPersCod & "' AND SUBSTRING(cMovNro,1,8) BETWEEN '" _
                & lsFechaIni & "' AND '" & lsFechaFin & "' "
                
            If psCodAge <> "" Then
                sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "' "
            End If
                
            'sql = sql & "UNION All " _
                & "SELECT M.nMovNro, cPersNombre, cPersIDNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
                & "TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 232 THEN 'AHORROS' WHEN 233 " _
                & "THEN 'PLAZOFIJO' WHEN 234 THEN 'CTS' END, cOpeDesc, MC.cCtaCod, " _
                & "MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
                & "MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, SUBSTRING(cMovNro, 22,4) Usuario " _
                & "FROM MOVCAP MC INNER JOIN PRODUCTOPERSONA PP ON PP.cCtaCod = MC.cCtaCod INNER JOIN " _
                & "PERSONA P ON PP.cPersCod = P.cPersCod " _
                & "INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
                & "INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
                & "WHERE cPersIDTpo in (1,2) AND PP.cPersCod = '" & Rs!cPersCod _
                & "' AND SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "' AND " _
                & " M.cOpeCod in (" _
                & " SELECT GO.cOpeCod From GrupoOpe G JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
                & " WHERE G.nEfectivo = 1 and not cOpeCod like '9010%' and cOpeCod not in (401401, 402401) " _
                & " And cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "
                
             sql = sql & " UNION All " _
                & "SELECT  M.nMovNro, cPersNombre, cPersIDNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
                & "TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 232 THEN 'AHORROS' WHEN 233 " _
                & "THEN 'PLAZOFIJO' WHEN 234 THEN 'CTS' END, cOpeDesc, MC.cCtaCod, " _
                & "MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
                & "MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, SUBSTRING(cMovNro, 22,4) Usuario " _
                & "FROM MOVCAP MC INNER JOIN PRODUCTOPERSONA PP ON PP.cCtaCod = MC.cCtaCod INNER JOIN " _
                & "PERSONA P ON PP.cPersCod = P.cPersCod " _
                & "INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
                & "INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
                & "WHERE cPersIDTpo in (1,2) AND PP.cPersCod = '" & rs!cPersCod _
                & "' AND SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "' AND pp.nprdPersRelac=10 AND " _
                & " MC.cOpeCod not in (401401, 402401) and  MC.cOpeCod not like '9010%' and m.nmovflag=0 and mc.copecod not like '99%' and mc.copecod not in ('201001','210701','220601')  "
                                
             If psCodAge <> "" Then
                sql = sql & " AND SUBSTRING(MC.cCtaCod, 4,2) = '" & psCodAge & "' "
             End If
                                
'             sql = sql & "UNION All " _
'                & "SELECT M.nMovNro, cPersNombre, cPersIDNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, " _
'                & " cMovNro, TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END, " _
'                & " cOpeDesc, MC.cCtaCod, MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
'                & "MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, SUBSTRING(cMovNro, 22,4) Usuario " _
'                & "FROM MOVCOL MC INNER JOIN PRODUCTOPERSONA PP ON PP.cCtaCod = MC.cCtaCod INNER JOIN " _
'                & "PERSONA P ON PP.cPersCod = P.cPersCod " _
'                & "INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
'                & "INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
'                & "WHERE cPersIDTpo in (1,2) AND PP.cPersCod = '" & rs!cPersCod _
'                & "' AND SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "' AND nPrdPersRelac = 20 AND " _
'                & " M.cOpeCod in (" _
'                & " SELECT GO.cOpeCod From GrupoOpe G JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
'                & " WHERE G.nEfectivo = 1 and not cOpeCod like '9010%' and cOpeCod not in (401401, 402401) " _
'                & " And cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "
                
               
              sql = sql & " UNION ALL " _
                 & " SELECT  M.nMovNro, cPersNombre, cPersIDNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia,  cMovNro, " _
                 & " TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END, " _
                 & " cOpeDesc, MC.cCtaCod, MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
                 & " MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, SUBSTRING(cMovNro, 22,4) Usuario " _
                 & " FROM MOVCOL MC " _
                 & " INNER JOIN PRODUCTOPERSONA PP ON PP.cCtaCod = MC.cCtaCod and PP.nPrdPersRelac=20 " _
                 & " LEFT JOIN COLOCACCRED CC ON CC.cCtaCod=PP.cCtaCod " _
                 & " INNER JOIN PERSONA P ON  P.cPersCod=PP.cPersCod  " _
                 & " INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod " _
                 & " INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
                 & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod " _
                 & " INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
                 & " WHERE cPersIDTpo in (1,2) AND PP.cPersCod = '" & rs!cPersCod & "' AND SUBSTRING(cMovNro,1,8) BETWEEN '" & lsFechaIni & "' AND '" & lsFechaFin & "' AND " _
                 & " nPrdPersRelac = 20 AND  Mc.cOpeCod in ( SELECT GO.cOpeCod " _
                 & " From GrupoOpe G " _
                 & " JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
                 & " WHERE G.nEfectivo = 1 and not cOpeCod like '9010%' and cOpeCod not in (401401, 402401) and copecod not like '99%' ) "
                 '& " And  cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "
                                           
                                           
                                           
                                           
                                           
             If psCodAge <> "" Then
                sql = sql & " AND SUBSTRING(MC.cCtaCod, 4,2) = '" & psCodAge & "'"
             End If
                                
           sql = sql & ") S ORDER BY cMovNro"
           
            Set rsDet = oCon.CargaRecordSet(sql)
            lnItem = 0
            lnTCItem = 0
            lnTCMontoS = 0
            lnTCMontoED = 0
            lnTCMontoD = 0
            
            If Not rsDet.EOF And Not rs.BOF Then
                Do While Not rsDet.EOF
                
                    If lnContLin >= 60 Then
                        lnContPag = lnContPag + 1
                        lsImpre = lsImpre & Chr(12)
                        
                        lsImpre = lsImpre & psNomCmac & Space(125) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & oCon.GetHoraServer() & Chr(10)
                        lsImpre = lsImpre & psNomAge & Space(18) & "OPERACIONES ACUMULADAS MENSUALES EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
                        lsImpre = lsImpre & Space(46) & "Pag. " & lnContPag & Chr(10)
                        lsImpre = lsImpre & Space(80) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
                        
                        lsImpre = lsImpre & String(180, "-") & Chr(10)
                        lsImpre = lsImpre & "ITEM" & Space(3) & "AGENCIA" & Space(13) & "FECHA TRANSACCION" & Space(5) & "PRODUCTO"
                        lsImpre = lsImpre & Space(8) & "OPERACION" & Space(15) & "CUENTA" & Space(14) & "MONTO SOLES" & Space(5)
                        lsImpre = lsImpre & "EQUIV. DOLAR" & Space(5) & "MONTO DOLAR" & Space(5) & "TOTAL DOLAR" & Space(4) & "USUARIO" & Chr(10)
                        lsImpre = lsImpre & String(180, "-") & Chr(10)
                
                        lnContLin = 7
                    End If
                    
                    lnItem = lnItem + 1
                    lsAgencia = Mid(rsDet!cAgeDescripcion, 9)
                    lsFechaTrans = Mid(rsDet!cMovNro, 7, 2) & "/" & Mid(rsDet!cMovNro, 5, 2) & "/" & Mid(rsDet!cMovNro, 1, 4) & " " & Mid(rsDet!cMovNro, 9, 2) & ":" & Mid(rsDet!cMovNro, 11, 2) & ":" & Mid(rsDet!cMovNro, 13, 2)
                    lsProducto = rsDet!TipoProd
                    lsOperacion = rsDet!cOpeDesc
                    lsCtaCod = rsDet!cCtaCod
                    lnMontoED = Format(rsDet!MontoS / lnTipoCambio, "#0.00")
                    
                    lsImpre = lsImpre & ofuni.ImpreFormat(lnItem, 3, 0) & Space(3) & lsAgencia & Space(5) & lsFechaTrans
                    lsImpre = lsImpre & Space(5) & lsProducto & Space(5) & lsOperacion & Space(5) & lsCtaCod & Space(5)
                    lsImpre = lsImpre & ofuni.ImpreFormat(rsDet!MontoS, 11, 2, True) & Space(3) & ofuni.ImpreFormat(lnMontoED, 11, 2, True)
                    lsImpre = lsImpre & Space(3) & ofuni.ImpreFormat(rsDet!MontoD, 11, 2) & Space(3)
                    lsImpre = lsImpre & ofuni.ImpreFormat(lnMontoED + rsDet!MontoD, 11, 2) & Space(3) & rsDet!Usuario & Chr(10)
                    
                    lnContLin = lnContLin + 1
                    
                    lnTCItem = lnTCItem + 1
                    lnTCMontoS = lnTCMontoS + rsDet!MontoS
                    lnTCMontoED = lnTCMontoED + lnMontoED
                    lnTCMontoD = lnTCMontoD + rsDet!MontoD
                
                    rsDet.MoveNext
                Loop
            End If
            
            lsImpre = lsImpre & String(181, "-") & Chr(10)
            lsImpre = lsImpre & Space(5) & "TOTAL CLIENTE  :  " & ofuni.ImpreFormat(lnTCItem, 3, 0) & Space(80) & ofuni.ImpreFormat(lnTCMontoS, 13, 2, True) & Space(1)
            lsImpre = lsImpre & ofuni.ImpreFormat(lnTCMontoED, 13, 2, True) & Space(1) & ofuni.ImpreFormat(lnTCMontoD, 13, 2, True) & Space(1)
            lsImpre = lsImpre & ofuni.ImpreFormat(lnTCMontoED + lnTCMontoD, 13, 2, True) & Chr(10)
            lsImpre = lsImpre & String(181, "-") & Chr(10) & Chr(10)
            
            lnContLin = lnContLin + 3
            
            lnTItem = lnTItem + lnTCItem
            lnTMontoS = lnTMontoS + lnTCMontoS
            lnTMontoED = lnTMontoED + lnTCMontoED
            lnTMontoD = lnTMontoD + lnTCMontoD
            
            Set rsDet = Nothing
            rs.MoveNext
        Loop
    End If

    lsImpre = lsImpre & String(181, "-") & Chr(10)
    lsImpre = lsImpre & Space(5) & "TOTAL          :  " & ofuni.ImpreFormat(lnTItem, 3, 0) & Space(80) & ofuni.ImpreFormat(lnTMontoS, 13, 2, True) & Space(1)
    lsImpre = lsImpre & ofuni.ImpreFormat(lnTMontoED, 13, 2, True) & Space(1) & ofuni.ImpreFormat(lnTMontoD, 13, 2, True) & Space(1)
    lsImpre = lsImpre & ofuni.ImpreFormat(lnTMontoED + lnTMontoD, 13, 2, True) & Chr(10)
    lsImpre = lsImpre & String(181, "-") & Chr(10)
    
    Set rs = Nothing
     
    Set ofuni = Nothing
    Set ofunc = Nothing
    ImpLavDineroM = lsImpre
    
End Function

Public Function ImpLavDineroAD(ByVal psFechaIni As String, ByVal psNomCmac As String, _
                              ByVal psNomAge As String, ByVal psCodAge As String, pdFecSis As Date) As String

Dim sql As String
Dim oCon As COMConecta.DCOMConecta
Dim rs As ADODB.Recordset
Dim rsDet As ADODB.Recordset
Dim lsImpre As String
Dim oGen As COMDConstSistema.DCOMGeneral
Dim lnMontoMenLD As Currency
Dim lsCliente As String * 40
Dim lnMontoED As Currency
Dim lnTCMontoS As Currency
Dim lnTCMontoED As Currency
Dim lnTCMontoD As Currency
Dim lnTMontoS As Currency
Dim lnTMontoED As Currency
Dim lnTMontoD As Currency
Dim lnItem As Long, lnTCItem As Long, lnTItem As Long
Dim lsDocId As String * 8
Dim lsAgencia As String * 15, lsFechaTrans As String * 19
Dim lsCtaCod As String * 18, lsFechas As String * 10
Dim lsProducto As String * 10, lsOperacion As String * 15
Dim lnTipoCambio As Currency
Dim lnContPag As Integer
Dim lnContLin As Integer
Dim lsFechaIni As String, lsFechaFin As String
Dim ofuni As New COMFunciones.FCOMImpresion
Dim ofunc As New COMFunciones.FCOMCadenas
Dim oFunV As New COMFunciones.FCOMVarPublicas


    Set oGen = New COMDConstSistema.DCOMGeneral
        lnMontoMenLD = oGen.GetParametro(2000, 2032)
    

    lnContPag = 1:  lnItem = 0
    lnTCItem = 0: lnTItem = 0
    lsImpre = ""
    
    lsFechaIni = Mid(psFechaIni, 7, 4) & Mid(psFechaIni, 4, 2) & Mid(psFechaIni, 1, 2)
        
    Set oCon = New COMConecta.DCOMConecta
    oCon.AbreConexion

    sql = "SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, oFunV.gsFormatoFecha) & "'), dFecCamb) = 0 ORDER BY dFecCamb"

    Set rs = oCon.CargaRecordSet(sql)
        If Not (rs.EOF And rs.BOF) Then
            lnTipoCambio = rs!nValPond
        Else
            lnTipoCambio = 0
        End If
    Set rs = Nothing
        
    lsImpre = lsImpre & psNomCmac & Space(125) & "Fecha : " & Format(oGen.FechaHora(pdFecSis), "dd/mm/yyyy hh:mm:ss") & Chr(10)
    lsImpre = lsImpre & psNomAge & Space(18) & "OPERACIONES ACUMULADAS DIARIAS EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
    lsImpre = lsImpre & Space(46) & "Pag. " & lnContPag & Chr(10)
    lsImpre = lsImpre & Space(80) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
    
    lnContLin = 4
    lnContPag = 1
    
    sql = " SELECT C.cPersCod, cPersNombre, cPersIDNro, Monto FROM " _
        & " (SELECT cPersCod, SUM(MontoS/TipoCambio + MontoD) AS Monto FROM " _
        & " (SELECT CV.cPersCod, MontoS = 0, nMovImporte MontoD, " _
        & " TipoCambio = (SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, ofunf.gsFormatoFecha) & "'), dFecCamb) = 0) " _
        & " FROM MOVCOMPRAVENTA CV INNER JOIN MOV M ON CV.nMovNro = M.nMovNro " _
        & " WHERE SUBSTRING(cMovNro,1,8) = '" _
        & lsFechaIni & "' AND M.nMovFlag = 0 "
        
   If psCodAge <> "" Then
        sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
   End If
   
   sql = sql & "UNION All " _
        & " SELECT cPersCod = (SELECT TOP 1 cPersCod FROM PRODUCTOPERSONA PP WHERE PP.cCtaCod = MC.cCtaCod ORDER BY cPersCod), " _
        & " MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
        & " MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, " _
        & " TipoCambio = (SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, ofunf.gsFormatoFecha) & "'), dFecCamb) = 0) " _
        & " FROM MOVCAP MC INNER JOIN MOV M ON MC.nMovNro = M.nMovNro AND SUBSTRING(cMovNro,1,8) = '" _
        & lsFechaIni & "' AND M.nMovFlag = 0 AND mc.copecod not like  '99%' and  " _
        & " Mc.cOpeCod in (" _
        & " SELECT GO.cOpeCod From GrupoOpe G JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
        & " WHERE G.nEfectivo = 1 and  cOpeCod not like '9010%' and cOpeCod not in (401401, 402401))  "
      '  & " And cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "
        
    If psCodAge <> "" Then
         sql = sql & " AND SUBSTRING(M.cMovNro, 18,2) = '" & psCodAge & "'"
    End If
        
   sql = sql & "UNION All " _
        & "SELECT cPersCod = (SELECT TOP 1 cPersCod FROM PRODUCTOPERSONA PP WHERE PP.cCtaCod = MC.cCtaCod " _
        & " And nPrdPersRelac = 20 ORDER BY cPersCod), " _
        & "MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
        & "MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, " _
        & "TipoCambio = (SELECT TOP 1 nValPond FROM TIPOCAMBIO WHERE datediff(d, dateadd(d," & Mid(psFechaIni, 1, 2) * -1 & ", '" _
        & Format(psFechaIni, ofunf.gsFormatoFecha) & "'), dFecCamb) = 0) " _
        & "FROM MOVCOL MC INNER JOIN MOV M ON MC.nMovNro = M.nMovNro AND SUBSTRING(cMovNro,1,8) = '" _
        & lsFechaIni & "' AND M.nMovFlag = 0 AND mc.copecod not like  '99%' and  " _
        & " Mc.cOpeCod in (" _
        & " SELECT GO.cOpeCod From GrupoOpe G JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
        & " WHERE G.nEfectivo = 1 and not cOpeCod like '9010%' and cOpeCod not in (401401, 402401)) " _
       ' & " And cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "
        
    If psCodAge <> "" Then
         sql = sql & " AND SUBSTRING(M.cMovNro, 18,2) = '" & psCodAge & "'"
    End If
        
    sql = sql & ") S " _
        & "GROUP BY cPersCod) C " _
        & "INNER JOIN PERSONA P On C.cPersCod = P.cPersCod INNER JOIN PERSID DI ON DI.cPersCod = C.cPersCod " _
        & "WHERE Monto >= " & lnMontoMenLD & " AND cPersIDTpo in (1,2) "
        
    Set rs = oCon.CargaRecordSet(sql)

    If Not (rs.EOF And rs.BOF) Then
        Do While Not rs.EOF
                
            If lnContLin > 52 Then
                lnContPag = lnContPag + 1
                lsImpre = lsImpre & Chr(12)
                lsImpre = lsImpre & psNomCmac & Space(125) & "Fecha : " & Format(oGen.FechaHora(pdFecSis), "dd/mm/yyyy hh:mm:ss") & Chr(10)
                lsImpre = lsImpre & psNomAge & Space(18) & "OPERACIONES ACUMULADAS DIARIAS EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
                lsImpre = lsImpre & Space(46) & "Pag. " & lnContPag & Chr(10)
                lsImpre = lsImpre & Space(80) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
                lnContLin = 4
            End If
            
            lsCliente = ofunc.PstaNombre(rs!cpersnombre)
            lsDocId = rs!cPersIdNro
            
            lsImpre = lsImpre & rs!cPersCod & Space(3) & ofuni.ImpreCarEsp(lsCliente) & Space(5) & lsDocId & Chr(10)
            
            lsImpre = lsImpre & String(180, "-") & Chr(10)
            lsImpre = lsImpre & "ITEM" & Space(3) & "AGENCIA" & Space(13) & "FECHA TRANSACCION" & Space(5) & "PRODUCTO"
            lsImpre = lsImpre & Space(8) & "OPERACION" & Space(15) & "CUENTA" & Space(14) & "MONTO SOLES" & Space(5)
            lsImpre = lsImpre & "EQUIV. DOLAR" & Space(5) & "MONTO DOLAR" & Space(5) & "TOTAL DOLAR" & Space(4) & "USUARIO" & Chr(10)
            lsImpre = lsImpre & String(180, "-") & Chr(10)
            
            lnContLin = lnContLin + 4
            
            sql = " SELECT nMovNro, cPersNombre, cPersIDNro, cAgeDescripcion, Agencia, cMovNro, TipoProd, cOpeDesc, " _
                & " cCtaCod, MontoS, MontoD, SUBSTRING(cMovNro, 22,4) Usuario FROM (" _
                & " SELECT M.nMovNro, cPersNombre, cPersIDNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
                & " TipoProd = '', cOpeDesc, cCtaCod = '', MontoS = 0, nMovImporte MontoD, SUBSTRING(cMovNro, 22,4) Usuario  " _
                & " FROM MOVCOMPRAVENTA CV INNER JOIN PERSONA P ON CV.cPersCod = P.cPersCod " _
                & " INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod INNER JOIN MOV M ON M.nMovNro = CV.nMovNro " _
                & " INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod " _
                & " INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
                & " WHERE cPersIDTpo in (1,2) AND CV.cPersCod = '" & rs!cPersCod & "' AND SUBSTRING(cMovNro,1,8) = '" _
                & lsFechaIni & "' "
                
            If psCodAge <> "" Then
                sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "' "
            End If
                
            sql = sql & "UNION All " _
                & "SELECT M.nMovNro, cPersNombre, cPersIDNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, cMovNro, " _
                & "TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 232 THEN 'AHORROS' WHEN 233 " _
                & "THEN 'PLAZOFIJO' WHEN 234 THEN 'CTS' END, cOpeDesc, MC.cCtaCod, " _
                & "MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
                & "MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, SUBSTRING(cMovNro, 22,4) Usuario " _
                & "FROM MOVCAP MC INNER JOIN PRODUCTOPERSONA PP ON PP.cCtaCod = MC.cCtaCod INNER JOIN " _
                & "PERSONA P ON PP.cPersCod = P.cPersCod " _
                & "INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
                & "INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
                & "WHERE cPersIDTpo in (1,2) AND PP.cPersCod = '" & rs!cPersCod _
                & "' AND SUBSTRING(cMovNro,1,8) = '" & lsFechaIni & "' AND mc.copecod not like  '99%' and " _
                & " Mc.cOpeCod in (" _
                & " SELECT GO.cOpeCod From GrupoOpe G JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
                & " WHERE G.nEfectivo = 1 and not cOpeCod like '9010%' and cOpeCod not in (401401, 402401)) " _
              '  & " And cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "
                
             If psCodAge <> "" Then
                sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
             End If
                                
            sql = sql & "UNION All " _
                & "SELECT M.nMovNro, cPersNombre, cPersIDNro, cAgeDescripcion, SUBSTRING(cMovNro, 18,2) Agencia, " _
                & " cMovNro, TipoProd = CASE SUBSTRING(MC.cCtaCod,6,3) WHEN 305 THEN 'PIGNORATICIO' ELSE 'CREDITOS' END, " _
                & " cOpeDesc, MC.cCtaCod, MontoS = CASE substring(MC.cCtaCod, 9,1) WHEN 1 THEN nMonto ELSE 0 END, " _
                & "MontoD = CASE substring(MC.cCtaCod, 9,1) WHEN 2 THEN nMonto ELSE 0 END, SUBSTRING(cMovNro, 22,4) Usuario " _
                & "FROM MOVCOL MC INNER JOIN PRODUCTOPERSONA PP ON PP.cCtaCod = MC.cCtaCod INNER JOIN " _
                & "PERSONA P ON PP.cPersCod = P.cPersCod " _
                & "INNER JOIN PersID DI ON P.cPersCod = DI.cPersCod INNER JOIN MOV M ON M.nMovNro = MC.nMovNro " _
                & "INNER JOIN OPETPO O ON M.cOpeCod = O.cOpeCod INNER JOIN AGENCIAS A ON A.cAgeCod = SUBSTRING(cMovNro, 18,2) " _
                & "WHERE cPersIDTpo in (1,2) AND PP.cPersCod = '" & rs!cPersCod _
                & "' AND SUBSTRING(cMovNro,1,8) = '" & lsFechaIni & "' AND nPrdPersRelac = 20 AND mc.copecod not like  '99%' and  " _
                & " Mc.cOpeCod in (" _
                & " SELECT GO.cOpeCod From GrupoOpe G JOIN GruposOpe GO ON G.cGrupoCod = GO.cGrupoCod " _
                & " WHERE G.nEfectivo = 1 and not cOpeCod like '9010%' and cOpeCod not in (401401, 402401)) " _
               ' & " And cOpeCod not in (Select cOpeCod from OpeDoc Where nDocTpo = 47)) "
                
             If psCodAge <> "" Then
                sql = sql & " AND SUBSTRING(cMovNro, 18,2) = '" & psCodAge & "'"
             End If
                                
           sql = sql & ") S ORDER BY cMovNro"
           
            Set rsDet = oCon.CargaRecordSet(sql)
            lnItem = 0
            lnTCItem = 0
            lnTCMontoS = 0
            lnTCMontoED = 0
            lnTCMontoD = 0
            
            
            If Not rsDet.EOF And Not rs.BOF Then
                Do While Not rsDet.EOF
                
                    If lnContLin >= 60 Then
                        lnContPag = lnContPag + 1
                        lsImpre = lsImpre & Chr(12)
                        
                        lsImpre = lsImpre & psNomCmac & Space(125) & "Impreso: " & Format(pdFecSis, "dd/mm/yyyy") & oCon.GetHoraServer() & Chr(10)
                        lsImpre = lsImpre & psNomAge & Space(18) & "OPERACIONES ACUMULADAS DIARIAS EN EFECTIVO MAYORES O EQUIVALENTES A : " & lnMontoMenLD & "  DOLARES"
                        lsImpre = lsImpre & Space(46) & "Pag. " & lnContPag & Chr(10)
                        lsImpre = lsImpre & Space(80) & "TIPO DE CAMBIO :   " & lnTipoCambio & Chr(10) & Chr(10)
                        
                        lsImpre = lsImpre & String(180, "-") & Chr(10)
                        lsImpre = lsImpre & "ITEM" & Space(3) & "AGENCIA" & Space(13) & "FECHA TRANSACCION" & Space(5) & "PRODUCTO"
                        lsImpre = lsImpre & Space(8) & "OPERACION" & Space(15) & "CUENTA" & Space(14) & "MONTO SOLES" & Space(5)
                        lsImpre = lsImpre & "EQUIV. DOLAR" & Space(5) & "MONTO DOLAR" & Space(5) & "TOTAL DOLAR" & Space(4) & "USUARIO" & Chr(10)
                        lsImpre = lsImpre & String(180, "-") & Chr(10)
                
                        lnContLin = 7
                    End If
                    
                    lnItem = lnItem + 1
                    lsAgencia = Mid(rsDet!cAgeDescripcion, 9)
                    lsFechaTrans = Mid(rsDet!cMovNro, 7, 2) & "/" & Mid(rsDet!cMovNro, 5, 2) & "/" & Mid(rsDet!cMovNro, 1, 4) & " " & Mid(rsDet!cMovNro, 9, 2) & ":" & Mid(rsDet!cMovNro, 11, 2) & ":" & Mid(rsDet!cMovNro, 13, 2)
                    lsProducto = rsDet!TipoProd
                    lsOperacion = rsDet!cOpeDesc
                    lsCtaCod = rsDet!cCtaCod
                    lnMontoED = Format(rsDet!MontoS / lnTipoCambio, "#0.00")
                    
                    lsImpre = lsImpre & ofuni.ImpreFormat(lnItem, 3, 0) & Space(3) & lsAgencia & Space(5) & lsFechaTrans
                    lsImpre = lsImpre & Space(5) & lsProducto & Space(5) & lsOperacion & Space(5) & lsCtaCod & Space(5)
                    lsImpre = lsImpre & ofuni.ImpreFormat(rsDet!MontoS, 11, 2, True) & Space(3) & ofuni.ImpreFormat(lnMontoED, 11, 2, True)
                    lsImpre = lsImpre & Space(3) & ofuni.ImpreFormat(rsDet!MontoD, 11, 2) & Space(3)
                    lsImpre = lsImpre & ofuni.ImpreFormat(lnMontoED + rsDet!MontoD, 11, 2) & Space(3) & rsDet!Usuario & Chr(10)
                    
                    lnContLin = lnContLin + 1
                    
                    lnTCItem = lnTCItem + 1
                    lnTCMontoS = lnTCMontoS + rsDet!MontoS
                    lnTCMontoED = lnTCMontoED + lnMontoED
                    lnTCMontoD = lnTCMontoD + rsDet!MontoD
                
                    rsDet.MoveNext
                Loop
            End If
            
            lsImpre = lsImpre & String(181, "-") & Chr(10)
            lsImpre = lsImpre & Space(5) & "TOTAL CLIENTE  :  " & ofuni.ImpreFormat(lnTCItem, 3, 0) & Space(80) & ofuni.ImpreFormat(lnTCMontoS, 13, 2, True) & Space(1)
            lsImpre = lsImpre & ofuni.ImpreFormat(lnTCMontoED, 13, 2, True) & Space(1) & ofuni.ImpreFormat(lnTCMontoD, 13, 2, True) & Space(1)
            lsImpre = lsImpre & ofuni.ImpreFormat(lnTCMontoED + lnTCMontoD, 13, 2, True) & Chr(10)
            lsImpre = lsImpre & String(181, "-") & Chr(10) & Chr(10)
            
            lnContLin = lnContLin + 3
            
            lnTItem = lnTItem + lnTCItem
            lnTMontoS = lnTMontoS + lnTCMontoS
            lnTMontoED = lnTMontoED + lnTCMontoED
            lnTMontoD = lnTMontoD + lnTCMontoD
            
            Set rsDet = Nothing
            rs.MoveNext
        Loop
    End If

    lsImpre = lsImpre & String(181, "-") & Chr(10)
    lsImpre = lsImpre & Space(5) & "TOTAL          :  " & ofuni.ImpreFormat(lnTItem, 3, 0) & Space(80) & ofuni.ImpreFormat(lnTMontoS, 13, 2, True) & Space(1)
    lsImpre = lsImpre & ofuni.ImpreFormat(lnTMontoED, 13, 2, True) & Space(1) & ofuni.ImpreFormat(lnTMontoD, 13, 2, True) & Space(1)
    lsImpre = lsImpre & ofuni.ImpreFormat(lnTMontoED + lnTMontoD, 13, 2, True) & Chr(10)
    lsImpre = lsImpre & String(181, "-") & Chr(10)
    
    Set rs = Nothing
    Set ofuni = Nothing
    Set ofunc = Nothing
    Set oFunV = Nothing
    Set oGen = Nothing
    ImpLavDineroAD = lsImpre
    
End Function

Public Function RepHavDevBoveda(psFecha As String, psCodAge As String) As ADODB.Recordset
 Dim sSql As String, RSTMP As ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Set RSTMP = New ADODB.Recordset
    oCon.AbreConexion
    
    sSql = " SELECT M.NMOVNRO,M.CMOVNRO,M.COPECOD,OPEDESC='DEVOLUCION',MH.CAGECOD,A.CAGEDESCRIPCION ,MH.NMOVIMPORTE,MH.CUSUORIG,MH.CUSUDEST, " _
           & " NOMBRE=(SELECT E.CPERSNOMBRE FROM PERSONA E JOIN RRHH R ON R.CPERSCOD=E.CPERSCOD WHERE R.CUSER= CASE WHEN M.COPECOD='901017' THEN MH.CUSUDEST  ELSE MH.CUSUORIG  END ),NMONEDA=CASE WHEN MH.NMONEDA=1 THEN 'SOLES' ELSE 'DOLARES' END " _
           & " FROM MOV M " _
           & " JOIN MOVREF MR ON MR.NMOVNRO=M.NMOVNRO " _
           & " JOIN MovHabDevCajero MH ON MH.NMOVNRO=MR.NMOVNROREF " _
           & " JOIN AGENCIAS A ON A.CAGECOD=MH.CAGECOD " _
           & "  WHERE M.CMOVNRO LIKE '" & psFecha & "%' " _
           & " AND M.COPECOD='901006' AND MH.CAGECOD='" & psCodAge & "' AND CUSUDEST='BOVE'" _
           & " AND M.NMOVFLAG=0  " _
           & " UNION " _
           & " SELECT M.NMOVNRO,M.CMOVNRO,M.COPECOD,OPEDESC='HABILITACION' ,MH.CAGECOD,A.CAGEDESCRIPCION ,MH.NMOVIMPORTE,MH.CUSUORIG,MH.CUSUDEST, " _
           & " NOMBRE=(SELECT E.CPERSNOMBRE FROM PERSONA E JOIN RRHH R ON R.CPERSCOD=E.CPERSCOD WHERE R.CUSER= CASE WHEN M.COPECOD='901017' THEN MH.CUSUDEST  ELSE MH.CUSUORIG  END ),NMONEDA=CASE WHEN MH.NMONEDA=1 THEN 'SOLES' ELSE 'DOLARES' END " _
           & " FROM MOV M " _
           & " JOIN MOVREF MR ON MR.NMOVNRO=M.NMOVNRO " _
           & " JOIN MovHabDevCajero MH ON MH.NMOVNRO=MR.NMOVNROREF " _
           & " JOIN AGENCIAS A ON A.CAGECOD=MH.CAGECOD " _
           & " WHERE M.CMOVNRO LIKE '" & psFecha & "%' " _
           & " AND M.COPECOD='901017' AND MH.CAGECOD='" & psCodAge & "' AND CUSUORIG='BOVE' " _
           & " AND M.NMOVFLAG=0  " _
           & " ORDER BY OPEDESC DESC , NMONEDA "

        
        If RSTMP.State = adStateOpen Then RSTMP.Close
        Set RSTMP = oCon.CargaRecordSet(sSql)
        
            Set RepHavDevBoveda = RSTMP
        
    oCon.CierraConexion

    Set RSTMP = Nothing
    Set oCon = Nothing
   
End Function


Public Function RepHavDevBovedaRango(ByVal psFechaIni As String, ByVal psFechaFin As String, ByVal psCodAge As String) As ADODB.Recordset
 Dim sSql As String, RSTMP As ADODB.Recordset, sqlaux
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Set RSTMP = New ADODB.Recordset
    oCon.AbreConexion
    
    If psFechaIni = psFechaFin Then
        sqlaux = " left(M.CMOVNRO,8)='" & psFechaIni & "'"
    Else
        sqlaux = " left(M.CMOVNRO,8)>='" & psFechaIni & "' and  left(M.CMOVNRO,8)<=  '" & psFechaFin & "' "
    
    End If
    
    
    sSql = " SELECT M.NMOVNRO,M.CMOVNRO,M.COPECOD,OPEDESC='DEVOLUCION',MH.CAGECOD,A.CAGEDESCRIPCION ,MH.NMOVIMPORTE,MH.CUSUORIG,MH.CUSUDEST, " _
           & " NOMBRE=(SELECT E.CPERSNOMBRE FROM PERSONA E JOIN RRHH R ON R.CPERSCOD=E.CPERSCOD WHERE R.CUSER= CASE WHEN M.COPECOD='901017' THEN MH.CUSUDEST  ELSE MH.CUSUORIG  END ),NMONEDA=CASE WHEN MH.NMONEDA=1 THEN 'SOLES' ELSE 'DOLARES' END" _
           & " FROM MOV M " _
           & " JOIN MOVREF MR ON MR.NMOVNRO=M.NMOVNRO " _
           & " JOIN MovHabDevCajero MH ON MH.NMOVNRO=MR.NMOVNROREF " _
           & " JOIN AGENCIAS A ON A.CAGECOD=MH.CAGECOD " _
           & "  WHERE " & sqlaux _
           & " AND M.COPECOD='901006' AND MH.CAGECOD='" & psCodAge & "' AND CUSUDEST='BOVE'" _
           & " AND M.NMOVFLAG=0  " _
           & " UNION " _
           & " SELECT M.NMOVNRO,M.CMOVNRO,M.COPECOD,OPEDESC='HABILITACION' ,MH.CAGECOD,A.CAGEDESCRIPCION ,MH.NMOVIMPORTE,MH.CUSUORIG,MH.CUSUDEST, " _
           & " NOMBRE=(SELECT E.CPERSNOMBRE FROM PERSONA E JOIN RRHH R ON R.CPERSCOD=E.CPERSCOD WHERE R.CUSER= CASE WHEN M.COPECOD='901017' THEN MH.CUSUDEST  ELSE MH.CUSUORIG  END ),NMONEDA=CASE WHEN MH.NMONEDA=1 THEN 'SOLES' ELSE 'DOLARES' END " _
           & " FROM MOV M " _
           & " JOIN MOVREF MR ON MR.NMOVNRO=M.NMOVNRO " _
           & " JOIN MovHabDevCajero MH ON MH.NMOVNRO=MR.NMOVNROREF " _
           & " JOIN AGENCIAS A ON A.CAGECOD=MH.CAGECOD " _
           & " WHERE " & sqlaux _
           & " AND M.COPECOD='901017' AND MH.CAGECOD='" & psCodAge & "' AND CUSUORIG='BOVE' " _
           & " AND M.NMOVFLAG=0  " _
           & " ORDER BY OPEDESC DESC , NMONEDA  "

        
        If RSTMP.State = adStateOpen Then RSTMP.Close
        Set RSTMP = oCon.CargaRecordSet(sSql)
        
            Set RepHavDevBovedaRango = RSTMP
        
    oCon.CierraConexion

    Set RSTMP = Nothing
    Set oCon = Nothing
   
End Function

Public Function REPBOVSALDOS(ByVal cAgeCod As String, ByVal psFechaIni As String, psFechaFin As String)
Dim sSql As String, RSTMP As ADODB.Recordset, sqlaux
Dim oCon As COMConecta.DCOMConecta
Set oCon = New COMConecta.DCOMConecta
Set RSTMP = New ADODB.Recordset
    oCon.AbreConexion

  If psFechaIni = psFechaFin Then
        sqlaux = " AND left(M.CMOVNRO,8)='" & psFechaIni & "'"
  Else
        sqlaux = " AND left(M.CMOVNRO,8)>='" & psFechaIni & "' and  left(M.CMOVNRO,8)<=  '" & psFechaFin & "'"
    
  End If

sSql = " SELECT s.DFECHA,S.CPERSNOMBRE,S.CUSER,S.SOLESMONTO,D.DOLARESMONTO "
sSql = sSql & " From (Select DFECHA=LEFT(M.CMOVNRO,8),T.CPERSNOMBRE,E.CUSER ,SOLESMONTO=ISNULL(SUM(E.nMonto),0) From  Mov  M "
sSql = sSql & " INNER JOIN MovUserEfectivo E ON M.nMovNro = E.nMovNro "
sSql = sSql & " JOIN (SELECT P.CPERSNOMBRE,R.CUSER FROM PERSONA P JOIN RRHH R  ON P.CPERSCOD=R.CPERSCOD ) T ON T.CUSER=E.CUSER "
sSql = sSql & " Where E.cEfectivoCod LIKE '1%' And SUBSTRING(M.cMovNro,18,2) = '" & cAgeCod & "' "
sSql = sSql & " AND M.nMovFlag NOT IN (2,1) " & sqlaux                                                                                                 'And M.cMovNro LIKE '" & sFecha & "%' "
sSql = sSql & " AND M.cOpeCod in ('901007', '901016') "
sSql = sSql & " GROUP BY LEFT(M.CMOVNRO,8),T.CPERSNOMBRE,E.CUSER) S "
sSql = sSql & "  Join "
sSql = sSql & " (Select DFECHA=LEFT(M.CMOVNRO,8),T.CPERSNOMBRE,E.CUSER ,DOLARESMONTO=ISNULL(SUM(E.nMonto),0) From  Mov  M "
sSql = sSql & " INNER JOIN MovUserEfectivo E ON M.nMovNro = E.nMovNro "
sSql = sSql & " JOIN (SELECT P.CPERSNOMBRE,R.CUSER FROM PERSONA P JOIN RRHH R  ON P.CPERSCOD=R.CPERSCOD ) T ON T.CUSER=E.CUSER "
sSql = sSql & " Where E.cEfectivoCod LIKE '2%' And SUBSTRING(M.cMovNro,18,2) = '" & cAgeCod & "' "
sSql = sSql & " AND M.nMovFlag NOT IN (2,1) " & sqlaux                                                                                                  'And M.cMovNro LIKE '" & sFecha & "%' "
sSql = sSql & " AND M.cOpeCod in ('901007', '901016') "
sSql = sSql & " GROUP BY LEFT(M.CMOVNRO,8),T.CPERSNOMBRE,E.CUSER ) D ON D.CUSER=S.CUSER and D.DFECHA=S.DFECHA "
sSql = sSql & " order by s.dfecha,s.cpersnombre "

If RSTMP.State = adStateOpen Then RSTMP.Close
Set RSTMP = oCon.CargaRecordSet(sSql)
        
Set REPBOVSALDOS = RSTMP

oCon.CierraConexion

Set RSTMP = Nothing
Set oCon = Nothing

End Function

Public Function SobranteFaltante(pdFecIni As String, pdFecFin As String, psAge As String) As String
    Dim i As Integer
    Dim rsSobFal As New ADODB.Recordset
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lsRTFExt As String
    Dim sqlAdd As String
    
    Dim lcTipoRep As String '*** PEAC 20120803
    
    If psAge = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And SubString(M.cMovNro,18,2) = '" & psAge & "'"
    End If
    
    oCon.AbreConexion
    
    If pdFecIni = pdFecFin Then
        '*** PEAC 20120803 -- no tiene el caso aumentar un dia
        'pdFecFin = Format$(DateAdd("d", 1, CDate(pdFecFin)), ofunf.gsFormatoFechaView)
    End If
    lsRTFExt = ""
    'Sobrantes de caja
    'MADM 20091120
        'VSQL = "Select dbo.GetFechaMov(M.cMovNro,103) dFecTran, MOV.nMovImporte nMonTran, IsNull(PE.cPersNombre,'') cNomUsu, Right(M.cMovNro,4) cCodUsu " _ '
    lcTipoRep = "1" 'SOBRANTE
    For i = 1 To 2
    
        '*** PEAC 20120803
         'VSQL = "Select dbo.GetFechaMov(M.cMovNro,103) + ' '+ substring(M.cMovNro,9,2) + ':'+ substring(M.cMovNro,11,2) + ':'+ substring(M.cMovNro,13,2) dFecTran, MOV.nMovImporte nMonTran, IsNull(PE.cPersNombre,'') cNomUsu, Right(M.cMovNro,4) cCodUsu " _
             & " From Mov M" _
             & " Inner Join MovOpeVarias MOV On M.nMovNro = MOV.nMovNro" _
             & " Left JOIN RRHH RH ON Right(M.cMovNro,4) = RH.cUser" _
             & " Left JOIN Persona PE ON RH.cPersCod = PE.cPersCod" _
             & " where (Left(M.cMovNro,8) between '" & Format$(pdFecIni, "yyyymmdd") & "' and '" & Format(DateAdd("d", 1, pdFecFin), "yyyymmdd") & "') and M.cOpeCod in ('" & gOpeHabCajRegSobrante & "')" _
             & " And MOV.nMoneda = " & i & " And M.nMovFlag = 0 " & sqlAdd & "   " _
             & " Order by M.cMovNro, cCodUsu"
             
        VSQL = "exec Stp_Sel_ListaSobranteFaltante '" & Format$(pdFecIni, "yyyymmdd") & "','" & Format$(pdFecFin, "yyyymmdd") & "','" & psAge & "'," & i & ",'" & lcTipoRep & "'"
             
        If rsSobFal.State = adStateOpen Then rsSobFal.Close
        Set rsSobFal = oCon.CargaRecordSet(VSQL)
        If (rsSobFal.EOF) Then
            lsRTFExt = lsRTFExt & ""
        Else
            If Len(Trim(lsRTFExt)) <> 0 Then
                lsRTFExt = lsRTFExt & oImp.gPrnSaltoPagina
            End If
            lsRTFExt = lsRTFExt & PrtSobFal(rsSobFal, i, True)
        End If
    Next i
    
    'Faltantes de Caja
    'VSQL = "Select dbo.GetFechaMov(M.cMovNro,103) dFecTran, MOV.nMovImporte nMonTran, IsNull(PE.cPersNombre,'') cNomUsu, Right(M.cMovNro,4) cCodUsu " _'
    lcTipoRep = "2" 'FALTANTE
    For i = 1 To 2
        
        '*** PEAC 20120803
        'VSQL = "Select dbo.GetFechaMov(M.cMovNro,103) + ' '+ substring(M.cMovNro,9,2) + ':'+ substring(M.cMovNro,11,2) + ':'+ substring(M.cMovNro,13,2) dFecTran, MOV.nMovImporte nMonTran, IsNull(PE.cPersNombre,'') cNomUsu, Right(M.cMovNro,4) cCodUsu " _
             & " From Mov M" _
             & " Inner Join MovOpeVarias MOV On M.nMovNro = MOV.nMovNro" _
             & " Left JOIN RRHH RH ON Right(M.cMovNro,4) = RH.cUser" _
             & " Left JOIN Persona PE ON RH.cPersCod = PE.cPersCod" _
             & " where (Left(M.cMovNro,8) between '" & Format$(pdFecIni, "yyyymmdd") & "' and '" & Format$(DateAdd("d", 1, pdFecFin), "yyyymmdd") & "') and M.cOpeCod in ('" & gOpeHabCajRegFaltante & "')" _
             & " And MOV.nMoneda = " & i & " And M.nMovFlag = 0  " & sqlAdd & "    " _
             & " Order by dFectran, cCodUsu"
             
        VSQL = "exec Stp_Sel_ListaSobranteFaltante '" & Format$(pdFecIni, "yyyymmdd") & "','" & Format$(pdFecFin, "yyyymmdd") & "','" & psAge & "'," & i & ",'" & lcTipoRep & "'"
             
        If rsSobFal.State = adStateOpen Then rsSobFal.Close
        Set rsSobFal = oCon.CargaRecordSet(VSQL)
        If (rsSobFal.EOF) Then
            lsRTFExt = lsRTFExt & ""
        Else
            If Len(Trim(lsRTFExt)) <> 0 Then
                lsRTFExt = lsRTFExt & oImp.gPrnSaltoPagina
            End If
            lsRTFExt = lsRTFExt & PrtSobFal(rsSobFal, i, False)
        End If
    Next i
    
    Set rsSobFal = Nothing
    SobranteFaltante = lsRTFExt
End Function


Private Function PrtSobFal(prSobFal As ADODB.Recordset, pnMoneda As Integer, Optional pnTipo As Boolean = True) As String
Dim lnAcum As Currency
Dim lnCarLin As Integer
Dim lsTitRp1 As String
Dim lsTitRp2 As String
Dim lsMoneda As String
Dim lsNumPag As String
Dim lsFchtra As String
Dim lnLinPag As Integer
Dim lnCntPag As Integer
Dim lsNomOpe As String
Dim lsUsu As String * 35
Dim lsRTFExt As String
Dim ofuni As New COMFunciones.FCOMImpresion
Dim ofunc As New COMFunciones.FCOMCadenas
Dim J As Integer 'madm 20091117
lsNumPag = ""
lnLinPag = 0
lnCarLin = 85
lsTitRp1 = IIf(pnTipo, "L I S T A D O   D E   S O B R A N T E S ", "L I S T A D O   D E   F A L T A N T E S")
lsTitRp2 = "" '"USO DE CONTABILIDAD"
lnCntPag = 1
lnAcum = 0
J = 0 'madm 20091117
lsMoneda = IIf(pnMoneda = 1, "SOLES", "DOLARES")
With prSobFal
    lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
    lsRTFExt = lsRTFExt & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1, lsTitRp2, lsMoneda, lsNumPag) & oImp.gPrnSaltoLinea
    lsRTFExt = lsRTFExt & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
    lsRTFExt = lsRTFExt & "ITEM  FECHA OPERACION         USU.  NOMBRE                                      MONTO      " & oImp.gPrnSaltoLinea
    lsRTFExt = lsRTFExt & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
    lnLinPag = 8
    Do While Not .EOF
        lnAcum = lnAcum + !nMonTran
        lsUsu = ofunc.PstaNombre(Trim(!cNomUsu), True)
        'madm 20091117
        J = J + 1
        'lsRTFExt = lsRTFExt & Format$(!dFecTran, "dd/mm/yyyy hh:mm:ss AMPM") & "    " & !cCodUsu & "  " & lsUsu & "  " & ofunc.JDNum(Trim(Str(IIf(IsNull(!nMonTran), 0, !nMonTran))), 12, True, 9, 2) & oImp.gPrnSaltoLinea
        lsRTFExt = lsRTFExt & ofuni.FillText(Str(J), 4, " ") & Format$(!dFecTran, "dd/mm/yyyy hh:mm:ss") & "    " & !cCodUsu & "  " & lsUsu & "  " & ofunc.JDNum(Trim(Str(IIf(IsNull(!nMonTran), 0, !nMonTran))), 12, True, 9, 2) & oImp.gPrnSaltoLinea
        lnLinPag = lnLinPag + 1
        If lnLinPag > 58 Then
            lsRTFExt = lsRTFExt & gPrnSaltoPagina
            lnCntPag = lnCntPag + 1
            lsNumPag = ofunc.FillNum(Trim(Str(lnCntPag)), 4, " ")
            lsRTFExt = lsRTFExt & CabeRepo("", "", lnCarLin, "SECCION AHORROS", lsTitRp1, lsTitRp2, lsMoneda, lsNumPag) & oImp.gPrnSaltoLinea
            lsRTFExt = lsRTFExt & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
            lsRTFExt = lsRTFExt & "ITEM  FECHA OPERACION         USU.  NOMBRE                                      MONTO      " & oImp.gPrnSaltoLinea
            lsRTFExt = lsRTFExt & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
            lnLinPag = 8
        End If
        .MoveNext
    Loop
    lsRTFExt = lsRTFExt & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
    lsRTFExt = lsRTFExt & String(40, " ") & "******** ACUMULADO " & ofuni.FillText(lsMoneda, 8, " ") & "  " & ofunc.JDNum(Trim(Str(lnAcum)), 12, True, 9, 2) & oImp.gPrnSaltoLinea
    lsRTFExt = lsRTFExt & String(lnCarLin, "=") & oImp.gPrnSaltoLinea
End With

PrtSobFal = lsRTFExt
End Function


Function RepoCheques(ByVal FechaI As Date, ByVal FechaF As Date, ByVal gsNomAge As String, ByVal gdFecSis As Date) As String
Dim sql As String
Dim rs As New ADODB.Recordset
Dim Age(50) As String
Dim ValAge(50) As String
Dim i As Long
Dim J As Byte
Dim lscadena As String
Dim vLineas As Integer
Dim Pag As Integer
Dim SubTotal As Currency
Dim Total As Currency
Dim Usuario As String
Dim UsuarioR As String
Dim lbCabecera As Boolean
Dim oCon As COMConecta.DCOMConecta
Set oCon = New COMConecta.DCOMConecta

oCon.AbreConexion

Dim lsCtaBco As String * 11
Dim lsNroCheque As String * 13
Dim lsPlaza As String * 11
Dim lsBco As String * 30

Dim sqlAdd As String

Dim ofunc As New COMFunciones.FCOMCadenas
Dim ofunfe As New COMFunciones.FCOMFechas

If gsCodAge <> "" Then
    
    sqlAdd = " And Substring(M.cMovNro,18,2) = '" & gsCodAge & "' "
    
    sql = "SELECT cAgeDescripcion cNomTab, cAgeCod cValor FROM Agencias Where cAgeCod = '" & gsCodAge & "'"
    Set rs = oCon.CargaRecordSet(sql)
    If rs.EOF And rs.BOF Then
    Else
       Do While Not rs.EOF
       Age(1) = rs!cNomTab
       ValAge(1) = rs!cValor
       rs.MoveNext
       Loop
    End If
    rs.Close

    sql = "SELECT cAgeDescripcion cNomTab, cAgeCod cValor FROM Agencias Where cAgeCod <> '" & gsCodAge & "'"
    Set rs = oCon.CargaRecordSet(sql)
    If rs.EOF And rs.BOF Then
    Else
    i = 2
       Do While Not rs.EOF
       Age(i) = rs!cNomTab
       ValAge(i) = rs!cValor
       rs.MoveNext
       i = i + 1
       Loop
    End If
    rs.Close
Else
    sql = "SELECT cAgeDescripcion cNomTab, cAgeCod cValor FROM Agencias"
    Set rs = oCon.CargaRecordSet(sql)
    If rs.EOF And rs.BOF Then
    Else
       i = 1
       Do While Not rs.EOF
       Age(i) = rs!cNomTab
       ValAge(i) = rs!cValor
       rs.MoveNext
       i = i + 1
       Loop
    End If
    rs.Close
End If
SubTotal = 0
Total = 0
vLineas = 8
Pag = 1
'*************  REPORTE ********************
Dim lsMoneda As String
For J = 1 To 2
    lbCabecera = False
    Total = 0
    sql = " SELECT  IsNull((Select cPersNombre From Persona PE where PE.cPersCod = DR.cPersCod),'') Bco, DRC.cCtaCod cCodCta, DRC.cNroDoc cNumChq, dbo.FechaMov(M.cMovNro) dRegChq," _
        & " DR.dValorizacion dValorChq, DR.nMonto nMontoChq, Right(M.cMovNro,4) cCodUsu," _
        & " M.cOpeCod cCodOpe, CO.cConsDescripcion cNomTab, DR.cIFCta cCtaBco, SubString(M.cMovNro,18,2) cCodAge, IsNull((Select cAgeDescripcion From Agencias AGE Where AGE.cAgeCod = SubString(M.cMovNro,18,2)),'') Agencia " _
        & " FROM DOcRecCapta DRC" _
        & " Inner Join DocRec DR On DRC.nTpoDoc = DR.nTpoDoc And DRC.cNroDoc = DR.cNroDoc" _
        & "                         And DRC.cPersCod = DR.cPersCod And DRC.cIFTpo = DR.cIFTpo" _
        & " Inner Join Mov M On M.nMovNro = DRC.nMovNro And M.cOpeCod in ('" & gChqOpeRegistro & "','" & gAhoApeChq & "','" & gAhoApeLoteChq & "','" & gAhoDepChq & "','" & gPFApeChq & "','" & gPFApeLoteChq & "','" & gCTSApeChq & "','" & gCTSApeLoteChq & "','" & gCTSDepChq & "')" _
        & "                         And Left(M.cMovNro,8) Between '" & Format(FechaI, "YYYYMMDD") & "' And '" & Format(DateAdd("d", 1, FechaF), "YYYYMMDD") & "'" _
        & "                         And Substring(DRC.cCtaCod,9,1)= '" & J & "'  and DR.nEstado not in (" & ChequeEstado.gChqEstAnulado & "," & ChequeEstado.gChqEstRechazado & "," & ChequeEstado.gsChqEstExtornado & ")" _
        & "                         And M.nMovflag = 0 And DRC.nTpoDoc = '" & TpoDoc.TpoDocCheque & "' " & sqlAdd & "" _
        & " Inner Join Constante CO On CO.nConsCod = " & gChequePlaza & " And CO.nConsvalor = DR.bPlaza"
        Set rs = oCon.CargaRecordSet(sql)
        If rs.EOF And rs.BOF Then
        Else
            If Not lbCabecera Then
                lsMoneda = IIf(J = 1, "SOLES", "DOLARES")
                lscadena = lscadena + UCase(gsNomAge) & " - " & lsMoneda & Space(78) + " " & ofunfe.ArmaFecha(gdFecSis) & " - " & Format(Now, "HH:MM:SS AMPM") & oImp.gPrnSaltoLinea + oImp.gPrnSaltoLinea
                lscadena = lscadena + Space(40) + "LISTADO DE CHEQUES RECIBIDOS" & oImp.gPrnSaltoLinea
                lscadena = lscadena + String(154, "=") + oImp.gPrnSaltoLinea
                lscadena = lscadena + "CUENTA              " + Space(2) & "NUMCHQ  " + Space(2) & "   BANCO                         "
                lscadena = lscadena + Space(2) + "        MONTO" + Space(2) + "FECHA REG "
                lscadena = lscadena + Space(2) & "FECHA VAL." + Space(2) + "USUA"
                lscadena = lscadena + Space(2) & "CUENTA      "
                lscadena = lscadena + Space(2) & "PLAZA       "
                lscadena = lscadena + Space(2) & "AGENCIA " & oImp.gPrnSaltoLinea
                lscadena = lscadena + String(154, "=")
                lbCabecera = True
            End If
            lscadena = lscadena + oImp.gPrnSaltoLinea + Trim(Age(i)) + oImp.gPrnSaltoLinea
            SubTotal = 0
            Do While Not rs.EOF
                If IsNull(rs!cCodUsu) Then
                    Usuario = "    "
                Else
                    Usuario = rs!cCodUsu
                End If
                UsuarioR = ""
                lsBco = rs!Bco
                lsNroCheque = ofunc.JDNum(rs!cNumChq, 8, False, 8, 0)
                lscadena = lscadena & rs!cCodCta & Space(2) & lsNroCheque & Space(1)
                lscadena = lscadena & lsBco & Space(2) & ofunc.JDNum(Str(rs!nMontoChq), 13, True, 11, 2) & Space(2)
                lscadena = lscadena & Format(rs!dRegChq, ofunf.gsFormatoFechaView) & Space(2) & Format(rs!dValorChq, ofunf.gsFormatoFechaView) + Space(2)
                lsPlaza = Trim(rs!cNomTab)
                lsCtaBco = Trim(rs!cCtaBco)
                lscadena = lscadena & Usuario & Space(2) & lsCtaBco & Space(2) & lsPlaza & Space(2) & rs!Agencia & oImp.gPrnSaltoLinea
                vLineas = vLineas + 1
                If vLineas > 55 Then
                    vLineas = 8
                    lscadena = lscadena & UCase(gsNomAge) & " - " & lsMoneda & Space(78) + " " + ofunfe.ArmaFecha(gdFecSis) & " - " & Format(Now, "HH:MM:SS AMPM") & oImp.gPrnSaltoLinea + oImp.gPrnSaltoLinea
                    lscadena = lscadena & Space(40) + "LISTADO DE CHEQUES RECIBIDOS" + oImp.gPrnSaltoLinea
                    lscadena = lscadena & String(154, "=") & oImp.gPrnSaltoLinea
                    lscadena = lscadena + "CUENTA              " + Space(2) & "NUMCHQ  " + Space(2) & "   BANCO                         "
                    lscadena = lscadena + Space(2) & "        MONTO" + Space(2) & "FECHA REG "
                    lscadena = lscadena + Space(2) & "FECHA VAL." + Space(2) + "USUA"
                    lscadena = lscadena + Space(2) & "CUENTA      "
                    lscadena = lscadena + Space(2) & "PLAZA       "
                    lscadena = lscadena + Space(2) & "AGENCIA " & oImp.gPrnSaltoLinea
                    lscadena = lscadena + String(154, "=")
                End If
                SubTotal = SubTotal + rs!nMontoChq
                rs.MoveNext
            Loop
            Total = Total + SubTotal
            lscadena = lscadena + Space(20) + "Sub Total : " + Space(34) + ofunc.JDNum(Str(SubTotal), 13, True, 11, 2) + oImp.gPrnSaltoLinea
        End If
        rs.Close
    If Total > 0 Then
        lscadena = lscadena + oImp.gPrnSaltoLinea + Space(30) + "Total     : " + Space(24) + ofunc.JDNum(Str(Total), 13, True, 11, 2) + oImp.gPrnSaltoLinea
        lscadena = lscadena + oImp.gPrnSaltoPagina
    End If
Next J
RepoCheques = lscadena
Set ofunc = Nothing
End Function

Public Function RepoChequesCompleto(ByVal psCodAge As String, ByVal psFecIni As String, ByVal psFecFin As String, ByVal lsEstadosCheques As String, ByVal lsOptionsCheques As String, ByVal nMoneda As Integer, gsNomAge As String, gdFecSis As String, Optional ByVal lsProd As String = "") As String

Dim sCadImp As String
Dim lsSQL As String
Dim cNroDoc As String * 15
Dim cPersona As String * 25

Dim oCon As COMConecta.DCOMConecta
Dim R As New ADODB.Recordset
Dim cEstadoTemp As String
Dim cAgenciaTemp As String
Dim nCantidad As Long
Dim ntotal As Double

Dim nCantidadA As Long
Dim nTotalA As Double, LNLIN As Long
Set oCon = New COMConecta.DCOMConecta
Dim ofuni As New COMFunciones.FCOMImpresion
Dim ofunf As New COMFunciones.FCOMFechas


Dim lscadena As String

lscadena = "Select "
lscadena = lscadena & " (Select cConsDescripcion FROM Constante C Where C.nConsValor=DR.nEstado And C.nConsCod=1007) as cEstadoCheque, "
lscadena = lscadena & " dbo.FechaHoraMov(M.cMovNro) FechaHora, Right(M.cMovNro,4) Usu, DR.cNroDoc, "
lscadena = lscadena & " (Select cPersNombre FROM Persona PE Where PE.cPersCod = DR.cPersCod) Persona, DR.bPlaza, "
'agregado para sacar tipode producto en el reporte WARO 05/06/2004
lscadena = lscadena & "  (Select cConsDescripcion FROM Constante C Where C.nConsValor=DR.nproducto And C.nConsCod=1001) as Prod,"
', DRE.nEstado, nMoneda "
lscadena = lscadena & " DR.cIFCta , DR.nMonto, DR.dValorizaRef, DR.dValorizacion, Substring(M.cMovNro,18,2) as cAgencia,cCtaCod=case when  dr.nproducto like '23[234]' then  isnull(DRC.Cctacod,'                  ')  else '                  ' end "
lscadena = lscadena & " From MovDoc MD  Inner Join Mov M On M.nMovNro = MD.nMovNro "
lscadena = lscadena & " Inner Join DocRec DR On MD.nDocTpo = DR.nTpoDoc "

lscadena = lscadena & " And DR.cNroDoc = MD.cDocNro Inner Join DocRecEst DRE On DR.nTpoDoc = DRE.nTpoDoc "
lscadena = lscadena & " And DR.cNroDoc = DRE.cNroDoc And DR.cPersCod = DRE.cPersCod "
lscadena = lscadena & " And DR.cIFTpo = DRE.cIFTpo And DRE.cMovNro = M.cMovNro "

'Agregado para que saque solo cheques de captaciones
lscadena = lscadena & " left Join DOcRecCapta DRC ON DRC.nTpoDoc = DR.nTpoDoc And DRC.cNroDoc = DR.cNroDoc And DRC.cPersCod = DR.cPersCod And DRC.cIFTpo = DR.cIFTpo "
'Fin Agregado / Actualizado por WARO ya estaba filtrado por  captaciones

'lsCadena = lsCadena & " Left Join ( select  md.cdocnro,mc.* From MovDoc MD join MovCol mc on mc.nmovnro=md.nmovnro where md.ndoctpo=47 and  MC.cOpeCod not like '107[123456789]%' and MC.cOpeCod not Like '99%'  )MCC on MCC.cdocnro=md.cdocnro "

lscadena = lscadena & " Where MD.nDocTpo = 47 And m.nMovFlag = 0 and m.copecod='900031' "

If Trim(lsOptionsCheques) = "1" Then '--Fecha de Recepcion
    lscadena = lscadena & " And Left(M.cMovNro,8) >='" & Format(psFecIni, "YYYYMMdd") & "' And Left(M.cMovNro,8) <='" & Format(psFecFin, "YYYYMMdd") & "' "
ElseIf Trim(lsOptionsCheques) = "2" Then '--Fecha de Valorizacion
    lscadena = lscadena & " and convert(varchar(8), DR.dValorizacion, 112) >='" & Format(psFecIni, gsFormatoMovFecha) & "' And convert(varchar(8), DR.dValorizacion, 112) <='" & Format(psFecFin, gsFormatoMovFecha) & "' "
End If
'--Producto
If lsProd = "CAPTACIONES" Then
    lscadena = lscadena & " and  DR.nproducto like '23[234]' "
ElseIf lsProd = "CREDITOS" Then
    lscadena = lscadena & " and  DR.nproducto NOT like '23[234]' "
    'lsCadena = lsCadena & " and  DR.nproducto like '1[02]%'  and  DR.nproducto like '2[02]%'   and  DR.nproducto like '3[02]%'  and  DR.nproducto like '4[02]%' "
End If

'--Estado
If lsEstadosCheques <> "" Then
    lscadena = lscadena & " and DR.nEstado in (" & lsEstadosCheques & ")"
End If
'--Moneda
lscadena = lscadena & " And nMoneda=" & nMoneda
'--Agencia
If Len(Trim(psCodAge)) > 0 Then
    lscadena = lscadena & " And Substring(M.cMovNro,18,2) = '" & psCodAge & "' "
End If

lscadena = lscadena & " Order By nMoneda, DR.nEstado, Substring(M.cMovNro,18,2), M.cMovNro, Usu, DR.cNroDoc, Persona "

oCon.AbreConexion
Set R = oCon.CargaRecordSet(lscadena)

If R.BOF Then
Else
    
    sCadImp = sCadImp & UCase(gsNomAge) & " - " & IIf(nMoneda = 1, "SOLES", "DOLARES") & Space(60) + " " + ofunf.ArmaFecha(CDate(gdFecSis)) & " - " & Format(Now, "HH:MM:SS AMPM") & Chr(10) & Chr(10)
    sCadImp = sCadImp & Space(40) & "LISTADO DE CHEQUES " & lsProd & Chr(10)
    sCadImp = sCadImp & String(124, "=") & Chr(10)
    sCadImp = sCadImp & Chr(10)
    
    sCadImp = sCadImp & "CHEQUES CON ESTADO: " & R!cestadocheque & Chr(10) & Chr(10)
    
    sCadImp = sCadImp & "AGENCIA: " & R!cAgencia & Chr(10)
    sCadImp = sCadImp & String(142, "-") & Chr(10)
    sCadImp = sCadImp & "    FECHA/HORA      USER      NUMERO           ENTIDAD                    MONTO    FECHA     FECHA     AG    Tipo                 Cuenta           " & Chr(10)
    sCadImp = sCadImp & " REGISTRO DOCUMENTO         DOCUMENTO      DE ORIGEN DEL DOC                      DE REFER  VALORIZAC    " & Chr(10)
    sCadImp = sCadImp & String(142, "-") & Chr(10)
    
    cEstadoTemp = R!cestadocheque
    cAgenciaTemp = R!cAgencia
    LNLIN = 12
    
    Do While Not R.EOF
        
        If Trim(cEstadoTemp) <> R!cestadocheque Or LNLIN >= 66 Then
            
            
            sCadImp = sCadImp & String(142, "-") & Chr(10)
            sCadImp = sCadImp & "TOTAL    " & Left("AGENCIA" & String(15, " "), 15) & ": " & Space(35) & ofuni.ImpreFormat(nCantidadA, 4, 0) & Space(2) & ofuni.ImpreFormat(nTotalA, 10, 2) & Chr(10) & Chr(10)
            
            sCadImp = sCadImp & String(142, "-") & Chr(10)
            sCadImp = sCadImp & "TOTAL    " & Left(UCase(cEstadoTemp) & String(15, " "), 15) & ": " & Space(35) & ofuni.ImpreFormat(nCantidad, 4, 0) & Space(2) & ofuni.ImpreFormat(ntotal, 10, 2) & Chr(10) & Chr(10)
            
            cEstadoTemp = R!cestadocheque
            ntotal = R!nMonto
            
            cAgenciaTemp = R!cAgencia
            nTotalA = R!nMonto
            
            nCantidad = 1
            nCantidadA = 1
            
            sCadImp = sCadImp & Chr(12)
            sCadImp = sCadImp & Chr(10)
            sCadImp = sCadImp & UCase(gsNomAge) & " - " & IIf(nMoneda = 1, "SOLES", "DOLARES") & Space(60) + " " + ofunf.ArmaFecha(CDate(gdFecSis)) & " - " & Format(Now, "HH:MM:SS AMPM") & Chr(10) & Chr(10)
            sCadImp = sCadImp & Space(40) & "LISTADO DE CHEQUES " & lsProd & Chr(10)
            sCadImp = sCadImp & String(124, "=") & Chr(10)
            sCadImp = sCadImp & Chr(10)
            
            sCadImp = sCadImp & "CHEQUES CON ESTADO: " & UCase(R!cestadocheque) & Chr(10) & Chr(10)
            sCadImp = sCadImp & "AGENCIA: " & R!cAgencia & Chr(10)
            sCadImp = sCadImp & String(142, "-") & Chr(10)
            sCadImp = sCadImp & "    FECHA/HORA      USER      NUMERO           ENTIDAD                    MONTO    FECHA     FECHA     AG    Tipo                 Cuenta           " & Chr(10)
            sCadImp = sCadImp & " REGISTRO DOCUMENTO         DOCUMENTO      DE ORIGEN DEL DOC                      DE REFER  VALORIZAC    " & Chr(10)
            sCadImp = sCadImp & String(142, "-") & Chr(10)
            sCadImp = sCadImp & Chr(10)
              LNLIN = 12
        Else
            
        
            ntotal = ntotal + R!nMonto
            nCantidad = nCantidad + 1
            
            If cAgenciaTemp <> R!cAgencia Then
                sCadImp = sCadImp & String(142, "-") & Chr(10)
                sCadImp = sCadImp & "TOTAL    " & Left("AGENCIA" & String(15, " "), 15) & ": " & Space(35) & ofuni.ImpreFormat(nCantidadA, 4, 0) & Space(2) & ofuni.ImpreFormat(nTotalA, 10, 2) & Chr(10) & Chr(10)
            
                cAgenciaTemp = R!cAgencia
                nTotalA = R!nMonto
                
                nCantidadA = 1
            
                sCadImp = sCadImp & Chr(12)
                sCadImp = sCadImp & Chr(10)
                sCadImp = sCadImp & UCase(gsNomAge) & " - " & IIf(nMoneda = 1, "SOLES", "DOLARES") & Space(60) + " " + ofunf.ArmaFecha(CDate(gdFecSis)) & " - " & Format(Now, "HH:MM:SS AMPM") & Chr(10) & Chr(10)
                sCadImp = sCadImp & Space(40) & "LISTADO DE CHEQUES " & lsProd & Chr(10)
                sCadImp = sCadImp & String(124, "=") & Chr(10)
                sCadImp = sCadImp & Chr(10)
                
                sCadImp = sCadImp & "CHEQUES CON ESTADO: " & UCase(R!cestadocheque) & Chr(10) & Chr(10)
                sCadImp = sCadImp & "AGENCIA: " & R!cAgencia & Chr(10)
                sCadImp = sCadImp & String(142, "-") & Chr(10)
                sCadImp = sCadImp & "    FECHA/HORA      USER      NUMERO           ENTIDAD                    MONTO    FECHA     FECHA     AG    Tipo                 Cuenta           " & Chr(10)
                sCadImp = sCadImp & " REGISTRO DOCUMENTO         DOCUMENTO      DE ORIGEN DEL DOC                      DE REFER  VALORIZAC    " & Chr(10)
                sCadImp = sCadImp & String(142, "-") & Chr(10)
                sCadImp = sCadImp & Chr(10)
                LNLIN = 12
                
                nTotalA = R!nMonto
                nCantidadA = 1
                
            Else
                nTotalA = nTotalA + R!nMonto
                nCantidadA = nCantidadA + 1
            End If
            
        End If
        
        cNroDoc = R!cNroDoc
        cPersona = R!Persona
    
        sCadImp = sCadImp & R!FechaHora & " " & R!Usu & " " & cNroDoc & " " & cPersona & " " & ofuni.ImpreFormat(R!nMonto, 10, 2) & " " & R!dValorizaRef & " " & R!DVALORIZACION & " " & R!cAgencia & " " & Left(Trim(R!prod), 18) & Space(20 - Len(Left(Trim(R!prod), 18))) & R!cCtaCod & Chr(10) ' era Chr(10) y agrego Producto
        LNLIN = LNLIN + 1
        R.MoveNext
    Loop
    
    sCadImp = sCadImp & String(142, "-") & Chr(10)
    sCadImp = sCadImp & "TOTAL    " & Left("AGENCIA" & String(15, " "), 15) & ": " & Space(35) & ofuni.ImpreFormat(nCantidadA, 4, 0) & Space(2) & ofuni.ImpreFormat(nTotalA, 10, 2) & Chr(10) & Chr(10)
    
    sCadImp = sCadImp & String(142, "-") & Chr(10)
    sCadImp = sCadImp & "TOTAL    " & Left(UCase(cEstadoTemp) & String(15, " "), 15) & ": " & Space(35) & ofuni.ImpreFormat(nCantidad, 4, 0) & Space(2) & ofuni.ImpreFormat(ntotal, 10, 2) & Chr(10)
    
End If
R.Close
Set R = Nothing
Set ofuni = Nothing
RepoChequesCompleto = sCadImp

End Function

Public Function GetOtrasOperaciones(pdIni As Date, pdFin As Date, pgsEmpresa As String, pgsNomAge As String, psAge As String, pgdFecSis As Date) As String
    Dim sql As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
    Dim ofuni As New COMFunciones.FCOMImpresion
        
    Dim lnCorr As Integer
    
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    
    Dim lscadena As String
    
    Dim lsMonedaAnt As String
    Dim lsCabeceraAnt As String
    
    Dim lnAcum As Currency
    
    Dim lsItem As String * 4
    Dim lsFecha As String * 20
    Dim lsUsu As String * 4
    Dim lsImporte As String * 15
    Dim lsDoc As String * 15
    Dim lsReferencia As String * 29
    Dim lsTipoOpe As String * 24
    
    Dim sqlAdd As String
    
    If psAge = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(M.cMovNro,18,2) = '" & psAge & "' "
    End If
    
    sql = " Select dbo.FechaHoraMov(M.cMovNro) FechaHora, Right(M.cMovNro,4) Usu, MOPV.nMoneda, MOPV.nMovImporte, MOPV.cNroDoc, Replace(Replace(MOPV.cReferencia,Char(10),' '),Char(13),' ')  Referencia," _
        & " (Select cOpeDesc from OpeTpo OP Where OP.cOpeCod = Left(M.cOpeCod,4) + '00') Cabecera, (Select cOpeDesc from OpeTpo OP Where OP.cOpeCod = M.cOpeCod) TipoOpe" _
        & " From MovOpeVarias MOPV" _
        & " Inner Join Mov M On MOPV.nMOvNro = M.nMovNro" _
        & " Where M.nMOvFlag = 0 And M.cOpeCod like '30%' " & sqlAdd & " " _
        & " And M.cOpeCod Not like '3003%' And Left(M.cMovNro,8) Between '" & Format(pdIni, "yyyymmdd") & "' And '" & Format(pdFin, "yyyymmdd") & "'" _
        & " Order By MOPV.nMoneda, Cabecera"

    lscadena = ""
    
    oCon.AbreConexion
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
        lnCorr = 0
        While Not rs.EOF
            If lsMonedaAnt <> rs!nMoneda Or lsCabeceraAnt <> rs!Cabecera Then
                If lscadena <> "" Then
                    RSet lsImporte = Format(lnAcum, "#,##0.00")
                    lscadena = lscadena & ofuni.Encabezado(" ;30;" & lsImporte & ";17; ;74;", lnItem, False)
                    lscadena = lscadena & Chr(12)
                    lnAcum = 0
                End If
                lscadena = lscadena & ofuni.CabeceraPagina(Trim(rs!Cabecera), lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, rs!nMoneda)
                lscadena = lscadena & ofuni.Encabezado("Item;4; ;6;Tipo.Ope;10; ;10;Importe;17; ;8;Documento;10; ;2;Referencia;15; ;5;Usu.;14; ;5;Fecha;10; ;5;", lnItem)
            End If
                        
            lnCorr = lnCorr + 1
            lnItem = lnItem + 1
            
            lsItem = Format(lnCorr, "0000")
            lsFecha = rs!FechaHora
            lsUsu = rs!Usu
            RSet lsImporte = Format(rs!nMovImporte, "#,##0.00")
            RSet lsDoc = rs!cNroDoc
            lsReferencia = rs!Referencia
            lsTipoOpe = rs!TipoOpe
            lnAcum = lnAcum + rs!nMovImporte
        
            lscadena = lscadena & lsItem & Space(2) & lsTipoOpe & Space(2) & lsImporte & Space(2) & lsDoc & Space(2) & lsReferencia & Space(2) & lsUsu & Space(2) & lsFecha & Chr(10)
            
            lsMonedaAnt = rs!nMoneda
            lsCabeceraAnt = rs!Cabecera
            
            If lnItem > 54 Then
                lscadena = lscadena & Chr(12)
                lscadena = lscadena & ofuni.CabeceraPagina(Trim(rs!Cabecera), lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, rs!nMoneda)
                lscadena = lscadena & ofuni.Encabezado("Item;4; ;6;Tipo.Ope;10; ;10;Importe;17; ;8;Documento;10; ;2;Referencia;15; ;5;Usu.;14; ;5;Fecha;10; ;5;", lnItem)
            End If
            
            rs.MoveNext
        Wend
    
        If lscadena <> "" Then
            RSet lsImporte = Format(lnAcum, "#,##0.00")
            lscadena = lscadena & ofuni.Encabezado(" ;30;" & lsImporte & ";17; ;74;", lnItem, False)
        End If
    End If
    
    GetOtrasOperaciones = lscadena
    Set ofuni = Nothing
    
End Function

Public Function GetChequesRecibidos(pdIni As Date, pdFin As Date, pgsEmpresa As String, pgsNomAge As String, psAge As String, pgdFecSis As Date) As String
    Dim sql As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
        
    Dim lnCorr As Integer
    
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    Dim lscadena As String
    
    Dim lsMonedaAnt As String
    Dim lsCabeceraAnt As String
    
    Dim lnAcum As Currency
    
    Dim lsItem As String * 4
    Dim lsFecha As String * 20
    Dim lsUsu As String * 4
    Dim lsImporte As String * 15
    Dim lsNroDoc As String * 20
    Dim lsCtaIf As String * 20
    Dim lsReferencia As String * 29
    Dim lsPersona As String * 24
    Dim ldVal As String * 20
    Dim lsTipoOpe As String
    Dim sqlAdd As String
    
    If psAge = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(M.cMovNro,18,2) = '" & psAge & "' "
    End If
    
    sql = " Select dbo.FechaHoraMov(M.cMovNro) FechaHora, Right(M.cMovNro,4) Usu, DR.cNroDoc, (Select cPersNombre FROM Persona PE Where PE.cPersCod = DR.cPersCod) Persona, DR.bPlaza, DR.cIFCta, DR.nMonto, DR.dValorizaRef, DR.dValorizacion, DRE.nEstado, nMoneda From MovDoc MD " _
        & " Inner Join Mov M On M.nMovNro = MD.nMovNro" _
        & " Inner Join DocRec DR On MD.nDocTpo = DR.nTpoDoc" _
        & "         And DR.cNroDoc = MD.cDocNro" _
        & " Inner Join DocRecEst DRE On DR.nTpoDoc = DRE.nTpoDoc" _
        & "         And DR.cNroDoc = DRE.cNroDoc And DR.cPersCod = DRE.cPersCod" _
        & "         And DR.cIFTpo = DRE.cIFTpo And DRE.cMovNro = M.cMovNro" _
        & " Where MD.nDocTpo = 47 And M.nMovFlag = 0 And Left(M.cMovNro,8) Between '" & Format(pdIni, "YYYYMMDD") & "' And '" & Format(pdFin, "YYYYMMDD") & "' " & sqlAdd & " Order By nMoneda"
    'Sql = " Select dbo.FechaHoraMov(M.cMovNro) FechaHora, Right(M.cMovNro,4) Usu, MOPV.nMoneda, MOPV.nMovImporte, MOPV.cNroDoc, Replace(Replace(MOPV.cReferencia,Char(10),' '),Char(13),' ')  Referencia," _
        & " (Select cOpeDesc from OpeTpo OP Where OP.cOpeCod = Left(M.cOpeCod,4) + '00') Cabecera, (Select cOpeDesc from OpeTpo OP Where OP.cOpeCod = M.cOpeCod) TipoOpe" _
        & " From MovOpeVarias MOPV" _
        & " Inner Join Mov M On MOPV.nMOvNro = M.nMovNro" _
        & " Where M.nMOvFlag = 0 And M.cOpeCod like '30%' " & sqlAdd & " " _
        & " And M.cOpeCod Not like '3003%' And Left(M.cMovNro,8) Between '" & Format(pdIni, "YYYYMMDD") & "' And '" & Format(pdFin, "YYYYMMDD") & "'" _
        & " Order By MOPV.nMoneda, Cabecera"

    lscadena = ""
    
    oCon.AbreConexion
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
        lnCorr = 0
        While Not rs.EOF
            If lsMonedaAnt <> rs!nMoneda Then
                If lscadena <> "" Then
                    RSet lsImporte = Format(lnAcum, "#,##0.00")
                    lscadena = lscadena & ofuni.Encabezado(" ;30;" & lsImporte & ";17; ;74;", lnItem, False)
                    lscadena = lscadena & Chr(12)
                    lnAcum = 0
                End If
                lscadena = lscadena & ofuni.CabeceraPagina("REPORTE DE CHEQUES RECIBIDOS", lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, rs!nMoneda)
                lscadena = lscadena & ofuni.Encabezado("Item;4; ;6;Tipo.Ope;10; ;10;Importe;17; ;8;Documento;10; ;2;Referencia;15; ;5;Usu.;14; ;5;Fecha;10; ;5;", lnItem)
            End If
                        
            lnCorr = lnCorr + 1
            lnItem = lnItem + 1
            
            lsItem = Format(lnCorr, "0000")
            lsFecha = rs!FechaHora
            lsUsu = rs!Usu
            RSet lsImporte = Format(rs!nMonto, "#,##0.00")
            RSet lsNroDoc = rs!cNroDoc
            lsReferencia = rs!Referencia
            lsTipoOpe = rs!TipoOpe
            lnAcum = lnAcum + rs!nMovImporte
        
            lscadena = lscadena & lsItem & Space(2) & lsNroDoc & Space(2) & lsImporte & Space(2) & lsCtaIf & Space(2) & lsPersona & Space(2) & lsReferencia & Space(2) & ldVal & Space(2) & lsFecha & Space(2) & lsUsu & Chr(10)
            
            lsMonedaAnt = rs!nMoneda
            
            rs.MoveNext
        Wend
    
        If lscadena <> "" Then
            RSet lsImporte = Format(lnAcum, "#,##0.00")
            lscadena = lscadena & ofuni.Encabezado(" ;30;" & lsImporte & ";17; ;74;", lnItem, False)
        End If
    End If
    
    GetChequesRecibidos = lscadena
    Set ofuni = Nothing
    
End Function

Public Function GetListaOPSolicitadas(pdIni As Date, pdFin As Date, pgsEmpresa As String, pgsNomAge As String, psAge As String, pgdFecSis As Date) As String
    Dim sql As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
        
    Dim lnCorr As Integer
    
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    
    Dim lscadena As String
    
    Dim lsMonedaAnt As String
    Dim lsCabeceraAnt As String
    
    Dim lnAcum As Currency
    
    Dim lsItem As String * 4
    Dim lsFecha As String * 20
    Dim lsUsu As String * 4
    Dim lsImporte As String * 12
    Dim lsCta As String * 18
    Dim lsReferencia As String * 53
    
    Dim sqlAdd As String
    
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    If psAge = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(M.cMovNro,18,2) = '" & psAge & "' "
    End If
    
    sql = " Select dbo.FechaHoraMov(M.cMovNro) FechaHora, M.nMovNro, Right(M.cMovNro,4) Usu, M.cMovDesc, MC.cCtaCod, MC.nMonto, Substring(MC.cCtaCod,9,1) nMoneda from mov  M" _
        & " Inner Join MovCap MC On M.nMovNro = MC.nMovNro" _
        & " Where M.cOpecod = '200602'" _
        & " And M.nMovFlag = 0 And Left(M.cMovNro,8) Between '" & Format(pdIni, "yyyymmdd") & "' And '" & Format(pdFin, "yyyymmdd") & "'" & sqlAdd & " Order by Substring(MC.cCtaCod,9,1), M.cMovNro"
        
    lscadena = ""
    
    oCon.AbreConexion
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
        lnCorr = 0
        While Not rs.EOF
            If lsMonedaAnt <> rs!nMoneda Then
                If lscadena <> "" Then
                    RSet lsImporte = Format(lnAcum, "#,##0.00")
                    lscadena = lscadena & ofuni.Encabezado(" ;21;" & lsImporte & ";17; ;81;", lnItem, False)
                    lscadena = lscadena & Chr(12)
                    lnAcum = 0
                End If
                lscadena = lscadena & ofuni.CabeceraPagina(Trim("LISTADO DE TALONARIOS DE OP SOLICITADOS"), lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, rs!nMoneda)
                lscadena = lscadena & ofuni.Encabezado("Item;4; ;6;Cuenta;10; ;5;Importe;12; ;8;Referencia;15; ;25;Usu.;14; ;5;Fecha;10; ;5;", lnItem)
            End If
                        
            lnCorr = lnCorr + 1
            lnItem = lnItem + 1
            
            lsItem = Format(lnCorr, "0000")
            lsFecha = rs!FechaHora
            lsUsu = rs!Usu
            RSet lsImporte = Format(rs!nMonto, "#,##0.00")
            lsReferencia = rs!cMovDesc
            lsCta = rs!cCtaCod
            lnAcum = lnAcum + rs!nMonto
        
            lscadena = lscadena & lsItem & Space(2) & lsCta & Space(2) & lsImporte & Space(2) & lsReferencia & Space(2) & lsUsu & Space(2) & lsFecha & Chr(10)
            
            lsMonedaAnt = rs!nMoneda
            
            If lnItem > 54 Then
                lscadena = lscadena & Chr(12)
                'TODOCOMPLETA
                lscadena = lscadena & ofuni.CabeceraPagina(Trim("LISTADO DE TALONARIOS DE OP SOLICITADOS"), lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, rs!nMoneda)
                lscadena = lscadena & ofuni.Encabezado("Item;4; ;6;Cuenta;10; ;5;Importe;12; ;8;Referencia;15; ;25;Usu.;14; ;5;Fecha;10; ;5;", lnItem)
            End If
            
            rs.MoveNext
        Wend
    
        If lscadena <> "" Then
            RSet lsImporte = Format(lnAcum, "#,##0.00")
            lscadena = lscadena & ofuni.Encabezado(" ;21;" & lsImporte & ";17; ;81;", lnItem, False)
        End If
    End If
    
    GetListaOPSolicitadas = lscadena
    Set ofuni = Nothing
    
End Function

Public Function GetListaLlamadasCMACS(pdIni As Date, pdFin As Date, pgsEmpresa As String, pgsNomAge As String, psAge As String, pgdFecSis As Date) As String
    Dim sql As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
        
    Dim lnCorr As Integer
    
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    
    Dim lscadena As String
    
    Dim cNomCaja As String * 43
    Dim cCodCtaTransaccion As String * 12
    Dim cDocumento As String * 10
    Dim cCliente As String * 30
    Dim nTempo As Integer
    
    Dim cTempoAge As String
    Dim cTempoUsu As String
    Dim cTempoMon As String
    Dim copecod As String
    Dim cOpeDesc As String
    
    Dim nTotalOpe1 As Double
    Dim nTotalOpe2 As Double
    Dim nTotalMon1 As Double
    Dim nTotalMon2 As Double
    Dim nTotalUsu1 As Double
    Dim nTotalUsu2 As Double
    Dim ntotalAge1 As Double
    Dim ntotalAge2 As Double
    
    Dim ofuni As New COMFunciones.FCOMImpresion
        
    Dim sqlAdd As String
    
    If psAge = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(M.cMovNro,18,2) = '" & psAge & "' "
    End If
        
    sql = "select substring(m1.cMovNro, 18,2) as cAgencia, A.cAgeDescripcion, right(m1.cMovNro, 4) as cUser, "
    sql = sql & " m1.cFecha, m1.cHora, m1.cCodCaja, m1.cNomCaja, m1.cMoneda, m1.nMonto, m1.cCodCtaTransaccion, "
    sql = sql & " m1.cDocumento, m1.cCliente, m1.cOpeCod, m1.cOpeDesc, "
    sql = sql & " isnull(m2.cMonedaComision, '') as cMonedaComision, isnull(m2.nImporteComision,0) as nImporteComision, "
    sql = sql & " m1.nMovNro as nMovCmac, m1.cMovNro as cMovCmac, "
    sql = sql & " isnull(m2.nMovNroRef, 0) as nMovOpeVarias, isnull(M2.cMovNro,'') as cMovOpeVarias, "
    sql = sql & " isnull(m3.nMovNroRef, 0) as nMovRegu, isnull(M3.cMovNro,'') as cMovRegu "
    sql = sql & " From "
    sql = sql & " ( "
    sql = sql & " select substring(m.cmovnro, 7, 2) + '/' + substring(m.cmovnro, 5, 2) + '/' + substring(m.cmovnro, 1, 4) as cFecha, "
    sql = sql & " substring(m.cMovNro, 9, 2) + ':' + substring(m.cMovNro, 11, 2) + ':' + substring(m.cMovNro, 13, 2)  as cHora, "
    sql = sql & " mc.cPersCod as cCodCaja, p.cpersnombre as cNomCaja, mc.nmoneda as cMoneda, mc.nMonto, "
    sql = sql & " isnull(mc.cCtaIF, '') as cCodCtaTransaccion, "
    sql = sql & " isnull(mc.cDocumento, '') as cDocumento, "
    sql = sql & " isnull(mc.cCliente, '') as cCliente, "
    sql = sql & " m.cOpeCod, cOpeDesc=case "
    sql = sql & " when m.copecod='260501' then 'LLAMADA DEPOSITO EFECTIVO CMAC' "
    sql = sql & " when m.copecod='260503' then 'LLAMADA RETIRO EFECTIVO CMAC' "
    sql = sql & " when m.copecod='260504' then 'LLAMADA RETIRO ORDEN DE PAGO' "
    sql = sql & " when m.copecod='107001' then 'LLAMADA PAGO DE CREDITO' "
    sql = sql & " when m.copecod='127100' then 'LLAMADA RENOVACION PRENDARIO' "
    sql = sql & " when m.copecod='127200' then 'LLAMADA CANCELACION PRENDARIO' "
    sql = sql & " end, m.nMovNro , m.cMovNro from mov m inner join movcmac mc on m.nmovnro=mc.nmovnro "
    sql = sql & " inner join persona p on mc.cperscod=p.cperscod "
    sql = sql & " where substring(m.cmovnro,1,8)='" & Format(pdIni, "yyyymmdd") & "' "
    sql = sql & " and m.copecod in(260501, 260503, 260504, 107001, 127100,127200) "
    sql = sql & sqlAdd
    sql = sql & " and m.nmovflag=0 ) m1 "
    sql = sql & " Inner Join (select cAgeCod, cAgeDescripcion from agencias) A "
    sql = sql & " On substring(m1.cMovNro, 18,2) = A.cAgeCod "
    sql = sql & " Left Join "
    sql = sql & " ( "
    sql = sql & " Select MR.nMovNro, M1.cMovNro, MR.nMovNroRef, MO.nMovImporte as nImporteComision, MO.nMoneda as cMonedaComision "
    sql = sql & " from MovRef MR Inner Join MovOpevarias MO "
    sql = sql & " on MR.nMovNroRef=MO.nMovNro Inner Join Mov M1 On M1.nMovNro=MR.nMovNroRef "
    sql = sql & " ) m2 "
    sql = sql & " on m1.nMovNro = m2.nMovNro "
    sql = sql & " Left Join "
    sql = sql & " ( "
    sql = sql & " Select MR.nMovNro, M1.cMovNro, MR.nMovNroRef, MC.nMonto as nImporteRegu, substring(MC.cCtaCod, 9,1) as cMonedaRegu "
    sql = sql & " from MovRef MR Inner Join MovCap MC "
    sql = sql & " on MR.nMovNroRef=MC.nMovNro Inner Join Mov M1 On M1.nMovNro=MR.nMovNroRef "
    sql = sql & " ) m3 "
    sql = sql & " on m1.nMovNro = m3.nMovNro "
    sql = sql & " Order By substring(m1.cMovNro, 18,2), " '--Agencia
    sql = sql & " right(m1.cMovNro, 4), " ' -- User
    sql = sql & " m1.cMoneda, " '--Moneda
    sql = sql & " m1.cOpeCod, "
    'sql = sql & " m1.cCodCaja, " '-- Caja Municipal
    sql = sql & " m1.cMovNro " '--Hora
    
        
    lscadena = ""
    
    oCon.AbreConexion
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
        
        cTempoAge = rs!cAgencia
        cTempoUsu = rs!cUser
        cTempoMon = rs!cMoneda
        copecod = rs!copecod
        cOpeDesc = rs!cOpeDesc
        
        lscadena = lscadena & ofuni.CabeceraPagina(Trim("LISTADO DE OPERACIONES - LLAMADAS CON CMACS"), lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, , False)
        lscadena = lscadena & String(162, "=") & Chr(10)
        
        lscadena = lscadena & "AGENCIA: " & rs!cAgencia & " - " & rs!cAgeDescripcion & Chr(10) & Chr(10)
        lscadena = lscadena & "USUARIO: " & rs!cUser & Chr(10) & Chr(10)
        lscadena = lscadena & "MONEDA: " & IIf(rs!cMoneda = "1", "Soles", "Dolares") & Chr(10) & Chr(10)
        lscadena = lscadena & "OPERACION: " & rs!copecod & " - " & rs!cOpeDesc & Chr(10)
        lscadena = lscadena & String(162, "-") & Chr(10)
        
        lscadena = lscadena & "ITEM HORA   " & Space(1) & "CAJA  MUNICIPAL  DE  REFERENCIA    " & Space(9) & "CUENTA      " & Space(1) & "DOCUMENTO " & Space(1) & "CLIENTE   " & Space(20) & "  M O N T O  " & Space(1) & Space(1) & "COMIS." & Space(1) & "CMAC    " & "   REGULAR" & Space(1) & "COMIS." & Chr(10)
        
        lscadena = lscadena & String(162, "-") & Chr(10)
        
        lnItem = lnItem + 5
        lnItem = lnItem + 10
        
        Do While Not rs.EOF
   
            If rs!cAgencia <> cTempoAge Then
                lscadena = lscadena & String(162, "-") & Chr(10)
                lscadena = lscadena & ofuni.ImpreFormat("TOTAL x OPERACION  ", 110) & ofuni.ImpreFormat(nTotalOpe1, 10, 2) & Space(2) & ofuni.ImpreFormat(nTotalOpe2, 2, 2) & Chr(10) & Chr(10)
                lscadena = lscadena & String(162, "-") & Chr(10)
                lscadena = lscadena & ofuni.ImpreFormat("TOTAL x MONEDA     ", 110) & ofuni.ImpreFormat(nTotalMon1, 10, 2) & Space(2) & ofuni.ImpreFormat(nTotalMon2, 2, 2) & Chr(10) & Chr(10)
                'lsCadena = lsCadena & String(136, "-") & Chr(10)
                'lsCadena = lsCadena & oFuni.ImpreFormat("TOTAL x USUARIO    ", 90) & oFuni.ImpreFormat(nTotalUsu1, 10, 2) & Space(3) & oFuni.ImpreFormat(nTotalUsu2, 2, 2) & Chr(10) & Chr(10)
                'lsCadena = lsCadena & String(136, "-") & Chr(10)
                'lsCadena = lsCadena & oFuni.ImpreFormat("TOTAL x AGENCIA    ", 90) & oFuni.ImpreFormat(nTotalAge1, 10, 2) & Space(3) & oFuni.ImpreFormat(nTotalAge2, 2, 2) & Chr(10) & Chr(10)
                nTotalOpe1 = rs!nMonto
                nTotalOpe2 = rs!nImporteComision
                nTotalMon1 = rs!nMonto
                nTotalMon2 = rs!nImporteComision
                nTotalUsu1 = rs!nMonto
                nTotalUsu2 = rs!nImporteComision
                ntotalAge1 = rs!nMonto
                ntotalAge2 = rs!nImporteComision
                nTempo = 1
                cTempoAge = rs!cAgencia
                cTempoUsu = rs!cUser
                cTempoMon = rs!cMoneda
                copecod = rs!copecod
                cOpeDesc = rs!cOpeDesc
                               
                lscadena = lscadena & Chr(12)
                lscadena = lscadena & ofuni.CabeceraPagina(Trim("LISTADO DE OPERACIONES - LLAMADAS CON CMACS"), lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, , False)
                lscadena = lscadena & String(162, "=") & Chr(10)
                lnItem = 6
                
                lscadena = lscadena & "AGENCIA: " & rs!cAgencia & " - " & rs!cAgeDescripcion & Chr(10) & Chr(10)
                lscadena = lscadena & "USUARIO: " & rs!cUser & Chr(10) & Chr(10)
                lscadena = lscadena & "MONEDA: " & IIf(rs!cMoneda = "1", "Soles", "Dolares") & Chr(10) & Chr(10)
                lscadena = lscadena & "OPERACION: " & rs!copecod & " - " & rs!cOpeDesc & Chr(10) & Chr(10)
                lscadena = lscadena & String(162, "-") & Chr(10)
                lscadena = lscadena & "ITEM HORA   " & Space(1) & "CAJA  MUNICIPAL  DE  REFERENCIA    " & Space(9) & "CUENTA      " & Space(1) & "DOCUMENTO " & Space(1) & "CLIENTE   " & Space(20) & "  M O N T O  " & Space(1) & Space(1) & "COMIS." & Space(1) & "CMAC    " & "   REGULAR" & Space(1) & "COMIS." & Chr(10)
                lscadena = lscadena & String(162, "-") & Chr(10)
                
                lnItem = lnItem + 17
                
            Else
                ntotalAge1 = ntotalAge1 + rs!nMonto
                ntotalAge2 = ntotalAge2 + rs!nImporteComision
                
                If rs!cUser <> cTempoUsu Then
                    lscadena = lscadena & String(162, "-") & Chr(10)
                    lscadena = lscadena & ofuni.ImpreFormat("TOTAL x OPERACION  ", 110) & ofuni.ImpreFormat(nTotalOpe1, 10, 2) & Space(2) & ofuni.ImpreFormat(nTotalOpe2, 2, 2) & Chr(10) & Chr(10)
                    lscadena = lscadena & String(162, "-") & Chr(10)
                    lscadena = lscadena & ofuni.ImpreFormat("TOTAL x MONEDA     ", 110) & ofuni.ImpreFormat(nTotalMon1, 10, 2) & Space(2) & ofuni.ImpreFormat(nTotalMon2, 2, 2) & Chr(10) & Chr(10)
                    'lsCadena = lsCadena & String(136, "-") & Chr(10)
                    'lsCadena = lsCadena & oFuni.ImpreFormat("TOTAL x USUARIO    ", 90) & oFuni.ImpreFormat(nTotalUsu1, 10, 2) & Space(3) & oFuni.ImpreFormat(nTotalUsu2, 2, 2) & Chr(10) & Chr(10)
                    
                    
                    nTotalOpe1 = rs!nMonto
                    nTotalOpe2 = rs!nImporteComision
                    nTotalMon1 = rs!nMonto
                    nTotalMon2 = rs!nImporteComision
                    nTotalUsu1 = rs!nMonto
                    nTotalUsu2 = rs!nImporteComision
                    nTempo = 1
                    
                    cTempoUsu = rs!cUser
                    cTempoMon = rs!cMoneda
                    copecod = rs!copecod
                    cOpeDesc = rs!cOpeDesc
                    
                    lscadena = lscadena & "USUARIO: " & rs!cUser & Chr(10) & Chr(10)
                    lscadena = lscadena & "MONEDA: " & IIf(rs!cMoneda = "1", "Soles", "Dolares") & Chr(10) & Chr(10)
                    lscadena = lscadena & "OPERACION: " & rs!copecod & " - " & rs!cOpeDesc & Chr(10) & Chr(10)
                    lscadena = lscadena & String(162, "-") & Chr(10)
                    lscadena = lscadena & "ITEM HORA   " & Space(1) & "CAJA  MUNICIPAL  DE  REFERENCIA    " & Space(9) & "CUENTA      " & Space(1) & "DOCUMENTO " & Space(1) & "CLIENTE   " & Space(20) & "  M O N T O  " & Space(1) & Space(1) & "COMIS." & Space(1) & "CMAC    " & "   REGULAR" & Space(1) & "COMIS." & Chr(10)
                    lscadena = lscadena & String(162, "-") & Chr(10)
                    
                    lnItem = lnItem + 15
                    
                Else
                    nTotalUsu1 = nTotalUsu1 + rs!nMonto
                    nTotalUsu2 = nTotalUsu2 + rs!nImporteComision
                
                    If rs!cMoneda <> cTempoMon Then
                        lscadena = lscadena & String(162, "-") & Chr(10)
                        lscadena = lscadena & ofuni.ImpreFormat("TOTAL x OPERACION  ", 110) & ofuni.ImpreFormat(nTotalOpe1, 10, 2) & Space(2) & ofuni.ImpreFormat(nTotalOpe2, 2, 2) & Chr(10) & Chr(10)
                        lscadena = lscadena & String(162, "-") & Chr(10)
                        lscadena = lscadena & ofuni.ImpreFormat("TOTAL x MONEDA     ", 110) & ofuni.ImpreFormat(nTotalMon1, 10, 2) & Space(2) & ofuni.ImpreFormat(nTotalMon2, 2, 2) & Chr(10) & Chr(10)
                        
                        nTotalOpe1 = rs!nMonto
                        nTotalOpe2 = rs!nImporteComision
                        nTotalMon1 = rs!nMonto
                        nTotalMon2 = rs!nImporteComision
                        nTempo = 1
                        cTempoMon = rs!cMoneda
                        copecod = rs!copecod
                        cOpeDesc = rs!cOpeDesc
                        
                        lscadena = lscadena & "MONEDA: " & IIf(rs!cMoneda = "1", "Soles", "Dolares") & Chr(10) & Chr(10)
                        lscadena = lscadena & "OPERACION: " & rs!copecod & " - " & rs!cOpeDesc & Chr(10) & Chr(10)
                        lscadena = lscadena & String(162, "-") & Chr(10)
                        lscadena = lscadena & "ITEM HORA   " & Space(1) & "CAJA  MUNICIPAL  DE  REFERENCIA    " & Space(9) & "CUENTA      " & Space(1) & "DOCUMENTO " & Space(1) & "CLIENTE   " & Space(20) & "  M O N T O  " & Space(1) & Space(1) & "COMIS." & Space(1) & "CMAC    " & "   REGULAR" & Space(1) & "COMIS." & Chr(10)
                        lscadena = lscadena & String(162, "-") & Chr(10)
                        
                        lnItem = lnItem + 13
                        
                    Else
                        nTotalMon1 = nTotalMon1 + rs!nMonto
                        nTotalMon2 = nTotalMon2 + rs!nImporteComision
                    
                        If rs!copecod <> copecod Then
                            lscadena = lscadena & String(162, "-") & Chr(10)
                            lscadena = lscadena & ofuni.ImpreFormat("TOTAL x OPERACION  ", 110) & ofuni.ImpreFormat(nTotalOpe1, 10, 2) & Space(2) & ofuni.ImpreFormat(nTotalOpe2, 2, 2) & Chr(10) & Chr(10)
                            
                            nTotalOpe1 = rs!nMonto
                            nTotalOpe2 = rs!nImporteComision
                            nTempo = 1
                            copecod = rs!copecod
                            cOpeDesc = rs!cOpeDesc
                            lscadena = lscadena & "OPERACION: " & rs!copecod & " - " & rs!cOpeDesc & Chr(10)
                            lscadena = lscadena & String(162, "-") & Chr(10)
                            lscadena = lscadena & "ITEM HORA   " & Space(1) & "CAJA  MUNICIPAL  DE  REFERENCIA    " & Space(9) & "CUENTA      " & Space(1) & "DOCUMENTO " & Space(1) & "CLIENTE   " & Space(20) & "  M O N T O  " & Space(1) & Space(1) & "COMIS." & Space(1) & "CMAC    " & "   REGULAR" & Space(1) & "COMIS." & Chr(10)
                            lscadena = lscadena & String(162, "-") & Chr(10)
                            
                            lnItem = lnItem + 7
                            
                        Else
                            nTempo = nTempo + 1
                            nTotalOpe1 = nTotalOpe1 + rs!nMonto
                            nTotalOpe2 = nTotalOpe2 + rs!nImporteComision
                        End If
                    End If
                End If
            End If
            
            lnItem = lnItem + 1
            
            cNomCaja = rs!cNomCaja
            cCodCtaTransaccion = rs!cCodCtaTransaccion
            cDocumento = rs!cDocumento
            cCliente = rs!cCliente
            
            lscadena = lscadena & ofuni.ImpreFormat(nTempo, 3, 0) & " " & rs!cHora & " " & cNomCaja & " "
            lscadena = lscadena & cCodCtaTransaccion & " " & cDocumento & " " & cCliente & " " & ofuni.ImpreFormat(rs!nMonto, 10, 2) & " " & IIf(rs!cmonedacomision = "1", "S", IIf(rs!cmonedacomision = "2", "D", " "))
            lscadena = lscadena & IIf(rs!nImporteComision = 0, "     ", ofuni.ImpreFormat(rs!nImporteComision, 2, 2))
            
            
            lscadena = lscadena & " " & ofuni.ImpreFormat(rs!nMovcmac, 7, 0)
            
            If Len(Trim(rs!cMovRegu)) = 0 Then
                lscadena = lscadena & "        "
            Else
                lscadena = lscadena & " " & ofuni.ImpreFormat(rs!nMovRegu, 7, 0)
            End If
            If Len(Trim(rs!cMovOpevarias)) = 0 Then
                lscadena = lscadena & "        "
            Else
                lscadena = lscadena & " " & ofuni.ImpreFormat(rs!nMovOpeVarias, 7, 0)
            End If
            
            lscadena = lscadena & Chr(10)
            
            
            If lnItem >= 54 Then
                lscadena = lscadena & Chr(12)
                lscadena = lscadena & ofuni.CabeceraPagina(Trim("LISTADO DE OPERACIONES - LLAMADAS CON CMACS"), lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis, , False)
                lscadena = lscadena & String(162, "=") & Chr(10)
                lnItem = 6
            End If
            
            rs.MoveNext
        Loop
                
        lscadena = lscadena & String(162, "-") & Chr(10)
        lscadena = lscadena & ofuni.ImpreFormat("TOTAL x OPERACION  ", 110) & ofuni.ImpreFormat(nTotalOpe1, 10, 2) & Space(3) & ofuni.ImpreFormat(nTotalOpe2, 2, 2) & Chr(10) & Chr(10)
        lscadena = lscadena & String(162, "-") & Chr(10)
        lscadena = lscadena & ofuni.ImpreFormat("TOTAL x MONEDA     ", 110) & ofuni.ImpreFormat(nTotalMon1, 10, 2) & Space(3) & ofuni.ImpreFormat(nTotalMon2, 2, 2) & Chr(10) & Chr(10)
        'lsCadena = lsCadena & String(136, "-") & Chr(10)
        'lsCadena = lsCadena & oFuni.ImpreFormat("TOTAL x USUARIO    ", 90) & oFuni.ImpreFormat(nTotalUsu1, 10, 2) & Space(3) & oFuni.ImpreFormat(nTotalUsu2, 2, 2) & Chr(10) & Chr(10)
        'lsCadena = lsCadena & String(136, "-") & Chr(10)
        'lsCadena = lsCadena & oFuni.ImpreFormat("TOTAL x AGENCIA    ", 90) & oFuni.ImpreFormat(nTotalAge1, 10, 2) & Space(3) & oFuni.ImpreFormat(nTotalAge2, 2, 2) & Chr(10) & Chr(10)
        
    End If
    
    GetListaLlamadasCMACS = lscadena
    Set ofuni = Nothing
    
End Function

Public Function GetListaRecepcionCMACS(pdIni As Date, pdFin As Date, pgsEmpresa As String, gsNomAge As String, psAge As String, pgdFecSis As Date) As String
    Dim sql As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
        
    Dim lnCorr As Integer
    
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    
    Dim lscadena As String
    
    Dim cNomCaja As String * 43
    Dim cCodCtaTransaccion As String * 12
    Dim cDocumento As String * 10
    Dim cCliente As String * 10
    Dim nTempo As Integer
    
    Dim cTempoAge As String
    Dim cTempoUsu As String
    Dim cTempoMon As String
    Dim copecod As String
    Dim cOpeDesc As String
    
    Dim nTotalOpe1 As Double
    Dim nTotalMon1 As Double
    Dim nTotalUsu1 As Double
    Dim ntotalAge1 As Double
    
    Dim ofuni As New COMFunciones.FCOMImpresion
        
    Dim sqlAdd As String
    
    If psAge = "" Then
        sqlAdd = ""
    Else
        sqlAdd = " And Substring(M.cMovNro,18,2) = '" & psAge & "' "
    End If
        
    sql = "select substring(m1.cMovNro, 18,2) as cAgencia, A.cAgeDescripcion, right(m1.cMovNro, 4) as cUser, "
    sql = sql & " m1.cFecha, m1.cHora, m1.cCodCaja, m1.cNomCaja, m1.cMoneda, m1.nMonto, m1.cCodCtaTransaccion, "
    sql = sql & " m1.cDocumento, m1.cCliente, m1.cOpeCod, m1.cOpeDesc, M1.nMovNro "
    sql = sql & " From "
    sql = sql & " ( "
    
    sql = sql & " select substring(m.cmovnro, 7, 2) + '/' + substring(m.cmovnro, 5, 2) + '/' + substring(m.cmovnro, 1, 4) as cFecha, "
    sql = sql & " substring(m.cMovNro, 9, 2) + ':' + substring(m.cMovNro, 11, 2) + ':' + substring(m.cMovNro, 13, 2)  as cHora, "
    sql = sql & " mc.cPersCod as cCodCaja, p.cpersnombre as cNomCaja, mc.nmoneda as cMoneda, mc.nMonto, "
    sql = sql & " isnull(mc.cCtaIF, '') as cCodCtaTransaccion,  isnull(mc.cDocumento, '') as cDocumento, "
    sql = sql & " isnull(mc.cCliente, '') as cCliente,  m.cOpeCod, "
    sql = sql & " ot.cOpeDesc, "
    sql = sql & " m.nMovNro , m.cMovNro "
    sql = sql & " from mov m inner join movcmac mc on m.nmovnro=mc.nmovnro "
    sql = sql & " inner join persona p on mc.cperscod=p.cperscod "
    sql = sql & " inner join opetpo ot on m.copecod=ot.copecod "
    sql = sql & " where substring(m.cmovnro,1,8)='" & Format(pdIni, "YYYYMMDD") & "' "
    sql = sql & " and m.copecod in ('260101','260102','260103','260104','260105','260201','260301','260302','100205','100305','100405','100505','126101','126102','126111','126112','126201','126202','126211','126212','126301') "
    'sql = sql & " and m.copecod in('260101', '260102','260103','260104','260201','260301','260302', '126100', '126200', '106001', '136101') "
    
    'sql = sql & " and m.copecod in('100205','100305','100405','107001','126100','126101','126102','126200','126202','136301','260101','260102','260103','260104','260201','260301','260302','260501','260503','260504','100406','106001', '136101') "
    
    sql = sql & sqlAdd
    sql = sql & " and m.nmovflag=0 ) m1 "
    
    sql = sql & " Inner Join (select cAgeCod, cAgeDescripcion from agencias) A  On substring(m1.cMovNro, 18,2) = A.cAgeCod "
    
    sql = sql & " Order By substring(m1.cMovNro, 18,2), " '--Agencia
    sql = sql & " right(m1.cMovNro, 4), " ' -- User
    sql = sql & " m1.cMoneda, " '--Moneda
    sql = sql & " m1.cOpeCod, "
    'sql = sql & " m1.cCodCaja, " '-- Caja Municipal
    sql = sql & " m1.cMovNro " '--Hora
        
    lscadena = ""
    
    oCon.AbreConexion
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
        
        cTempoAge = rs!cAgencia
        cTempoUsu = rs!cUser
        cTempoMon = rs!cMoneda
        copecod = rs!copecod
        cOpeDesc = rs!cOpeDesc
        
        lscadena = lscadena & ofuni.CabeceraPagina(Trim("LISTADO DE OPERACIONES - RECEPCIONES CON CMACS"), lnPagina, lnItem, gsNomAge, pgsEmpresa, pgdFecSis, , False)
        lscadena = lscadena & String(136, "=") & Chr(10)
        
        lscadena = lscadena & "AGENCIA: " & rs!cAgencia & " - " & rs!cAgeDescripcion & Chr(10) & Chr(10)
        lscadena = lscadena & "USUARIO: " & rs!cUser & Chr(10) & Chr(10)
        lscadena = lscadena & "MONEDA: " & IIf(rs!cMoneda = "1", "Soles", "Dolares") & Chr(10) & Chr(10)
        lscadena = lscadena & "OPERACION: " & rs!copecod & " - " & rs!cOpeDesc & Chr(10)
        lscadena = lscadena & String(136, "-") & Chr(10)
        
        lscadena = lscadena & "ITEM HORA   " & Space(1) & "CAJA  MUNICIPAL  DE  REFERENCIA    " & Space(9) & "CUENTA      " & Space(1) & "DOCUMENTO " & Space(1) & "CLIENTE   " & "  M O N T O  " & Space(1) & Space(2) & "OPERAC" & Chr(10)
        
        lscadena = lscadena & String(136, "-") & Chr(10)
        
        lnItem = lnItem + 5
        lnItem = lnItem + 10
        
        Do While Not rs.EOF
   
            If rs!cAgencia <> cTempoAge Then
                lscadena = lscadena & String(136, "-") & Chr(10)
                lscadena = lscadena & ofuni.ImpreFormat("TOTAL x OPERACION  ", 90) & ofuni.ImpreFormat(nTotalOpe1, 10, 2) & Chr(10) & Chr(10)
                lscadena = lscadena & String(136, "-") & Chr(10)
                lscadena = lscadena & ofuni.ImpreFormat("TOTAL x MONEDA     ", 90) & ofuni.ImpreFormat(nTotalMon1, 10, 2) & Chr(10) & Chr(10)
                'lsCadena = lsCadena & String(136, "-") & Chr(10)
                'lsCadena = lsCadena & oFuni.ImpreFormat("TOTAL x USUARIO    ", 90) & oFuni.ImpreFormat(nTotalUsu1, 10, 2) & Space(3) & oFuni.ImpreFormat(nTotalUsu2, 2, 2) & Chr(10) & Chr(10)
                'lsCadena = lsCadena & String(136, "-") & Chr(10)
                'lsCadena = lsCadena & oFuni.ImpreFormat("TOTAL x AGENCIA    ", 90) & oFuni.ImpreFormat(nTotalAge1, 10, 2) & Space(3) & oFuni.ImpreFormat(nTotalAge2, 2, 2) & Chr(10) & Chr(10)
                nTotalOpe1 = rs!nMonto
                nTotalMon1 = rs!nMonto
                nTotalUsu1 = rs!nMonto
                ntotalAge1 = rs!nMonto
                nTempo = 1
                cTempoAge = rs!cAgencia
                cTempoUsu = rs!cUser
                cTempoMon = rs!cMoneda
                copecod = rs!copecod
                cOpeDesc = rs!cOpeDesc
                               
                lscadena = lscadena & Chr(12)
                lscadena = lscadena & ofuni.CabeceraPagina(Trim("LISTADO DE OPERACIONES - RECEPCIONES CON CMACS"), lnPagina, lnItem, gsNomAge, pgsEmpresa, pgdFecSis, , False)
                lscadena = lscadena & String(136, "=") & Chr(10)
                lnItem = 6
                
                lscadena = lscadena & "AGENCIA: " & rs!cAgencia & " - " & rs!cAgeDescripcion & Chr(10) & Chr(10)
                lscadena = lscadena & "USUARIO: " & rs!cUser & Chr(10) & Chr(10)
                lscadena = lscadena & "MONEDA: " & IIf(rs!cMoneda = "1", "Soles", "Dolares") & Chr(10) & Chr(10)
                lscadena = lscadena & "OPERACION: " & rs!copecod & " - " & rs!cOpeDesc & Chr(10) & Chr(10)
                lscadena = lscadena & String(136, "-") & Chr(10)
                lscadena = lscadena & "ITEM HORA   " & Space(1) & "CAJA  MUNICIPAL  DE  REFERENCIA    " & Space(9) & "CUENTA      " & Space(1) & "DOCUMENTO " & Space(1) & "CLIENTE   " & "  M O N T O  " & Space(1) & Space(2) & "OPERAC" & Chr(10)
                lscadena = lscadena & String(136, "-") & Chr(10)
                
                lnItem = lnItem + 17
                
            Else
                ntotalAge1 = ntotalAge1 + rs!nMonto
                                
                If rs!cUser <> cTempoUsu Then
                    lscadena = lscadena & String(136, "-") & Chr(10)
                    lscadena = lscadena & ofuni.ImpreFormat("TOTAL x OPERACION  ", 90) & ofuni.ImpreFormat(nTotalOpe1, 10, 2) & Chr(10) & Chr(10)
                    lscadena = lscadena & String(136, "-") & Chr(10)
                    lscadena = lscadena & ofuni.ImpreFormat("TOTAL x MONEDA     ", 90) & ofuni.ImpreFormat(nTotalMon1, 10, 2) & Chr(10) & Chr(10)
                    'lsCadena = lsCadena & String(136, "-") & Chr(10)
                    'lsCadena = lsCadena & oFuni.ImpreFormat("TOTAL x USUARIO    ", 90) & oFuni.ImpreFormat(nTotalUsu1, 10, 2) & Space(3) & oFuni.ImpreFormat(nTotalUsu2, 2, 2) & Chr(10) & Chr(10)
                    
                    
                    nTotalOpe1 = rs!nMonto
                    nTotalMon1 = rs!nMonto
                    nTotalUsu1 = rs!nMonto
                    nTempo = 1
                    
                    cTempoUsu = rs!cUser
                    cTempoMon = rs!cMoneda
                    copecod = rs!copecod
                    cOpeDesc = rs!cOpeDesc
                    
                    lscadena = lscadena & "USUARIO: " & rs!cUser & Chr(10) & Chr(10)
                    lscadena = lscadena & "MONEDA: " & IIf(rs!cMoneda = "1", "Soles", "Dolares") & Chr(10) & Chr(10)
                    lscadena = lscadena & "OPERACION: " & rs!copecod & " - " & rs!cOpeDesc & Chr(10) & Chr(10)
                    lscadena = lscadena & String(136, "-") & Chr(10)
                    lscadena = lscadena & "ITEM HORA   " & Space(1) & "CAJA  MUNICIPAL  DE  REFERENCIA    " & Space(9) & "CUENTA      " & Space(1) & "DOCUMENTO " & Space(1) & "CLIENTE   " & "  M O N T O  " & Space(1) & Space(2) & "OPERAC" & Chr(10)
                    lscadena = lscadena & String(136, "-") & Chr(10)
                    
                    lnItem = lnItem + 15
                    
                Else
                    nTotalUsu1 = nTotalUsu1 + rs!nMonto
                                    
                    If rs!cMoneda <> cTempoMon Then
                        lscadena = lscadena & String(136, "-") & Chr(10)
                        lscadena = lscadena & ofuni.ImpreFormat("TOTAL x OPERACION  ", 90) & ofuni.ImpreFormat(nTotalOpe1, 10, 2) & Space(2) & Chr(10) & Chr(10)
                        lscadena = lscadena & String(136, "-") & Chr(10)
                        lscadena = lscadena & ofuni.ImpreFormat("TOTAL x MONEDA     ", 90) & ofuni.ImpreFormat(nTotalMon1, 10, 2) & Space(2) & Chr(10) & Chr(10)
                        
                        nTotalOpe1 = rs!nMonto
                        nTotalMon1 = rs!nMonto
                        nTempo = 1
                        cTempoMon = rs!cMoneda
                        copecod = rs!copecod
                        cOpeDesc = rs!cOpeDesc
                        
                        lscadena = lscadena & "MONEDA: " & IIf(rs!cMoneda = "1", "Soles", "Dolares") & Chr(10) & Chr(10)
                        lscadena = lscadena & "OPERACION: " & rs!copecod & " - " & rs!cOpeDesc & Chr(10) & Chr(10)
                        lscadena = lscadena & String(136, "-") & Chr(10)
                        lscadena = lscadena & "ITEM HORA   " & Space(1) & "CAJA  MUNICIPAL  DE  REFERENCIA    " & Space(9) & "CUENTA      " & Space(1) & "DOCUMENTO " & Space(1) & "CLIENTE   " & "  M O N T O  " & Space(1) & Space(2) & "OPERAC" & Chr(10)
                        lscadena = lscadena & String(136, "-") & Chr(10)
                        
                        lnItem = lnItem + 13
                        
                    Else
                        nTotalMon1 = nTotalMon1 + rs!nMonto
                        
                        If rs!copecod <> copecod Then
                            lscadena = lscadena & String(136, "-") & Chr(10)
                            lscadena = lscadena & ofuni.ImpreFormat("TOTAL x OPERACION  ", 90) & ofuni.ImpreFormat(nTotalOpe1, 10, 2) & Chr(10) & Chr(10)
                            
                            nTotalOpe1 = rs!nMonto
                            nTempo = 1
                            copecod = rs!copecod
                            cOpeDesc = rs!cOpeDesc
                            lscadena = lscadena & "OPERACION: " & rs!copecod & " - " & rs!cOpeDesc & Chr(10)
                            lscadena = lscadena & String(136, "-") & Chr(10)
                            lscadena = lscadena & "ITEM HORA   " & Space(1) & "CAJA  MUNICIPAL  DE  REFERENCIA    " & Space(9) & "CUENTA      " & Space(1) & "DOCUMENTO " & Space(1) & "CLIENTE   " & "  M O N T O  " & Space(1) & Space(2) & "OPERAC" & Chr(10)
                            lscadena = lscadena & String(136, "-") & Chr(10)
                            
                            lnItem = lnItem + 7
                            
                        Else
                            nTempo = nTempo + 1
                            nTotalOpe1 = nTotalOpe1 + rs!nMonto
                        End If
                    End If
                End If
            End If
            
            lnItem = lnItem + 1
            
            cNomCaja = rs!cNomCaja
            cCodCtaTransaccion = rs!cCodCtaTransaccion
            cDocumento = rs!cDocumento
            cCliente = rs!cCliente
            
            lscadena = lscadena & ofuni.ImpreFormat(nTempo, 3, 0) & " " & rs!cHora & " " & cNomCaja & " "
            lscadena = lscadena & cCodCtaTransaccion & " " & cDocumento & " " & cCliente & " " & ofuni.ImpreFormat(rs!nMonto, 10, 2) & " "
            
            lscadena = lscadena & " " & ofuni.ImpreFormat(rs!nMovNro, 7, 0)
            
            lscadena = lscadena & Chr(10)
            
            If lnItem >= 54 Then
                lscadena = lscadena & Chr(12)
                lscadena = lscadena & ofuni.CabeceraPagina(Trim("LISTADO DE OPERACIONES - RECEPCIONES CON CMACS"), lnPagina, lnItem, gsNomAge, pgsEmpresa, pgdFecSis, , False)
                lscadena = lscadena & String(136, "=") & Chr(10)
                lnItem = 6
            End If
            
            rs.MoveNext
        Loop
                
        lscadena = lscadena & String(136, "-") & Chr(10)
        lscadena = lscadena & ofuni.ImpreFormat("TOTAL x OPERACION  ", 90) & ofuni.ImpreFormat(nTotalOpe1, 10, 2) & Chr(10) & Chr(10)
        lscadena = lscadena & String(136, "-") & Chr(10)
        lscadena = lscadena & ofuni.ImpreFormat("TOTAL x MONEDA     ", 90) & ofuni.ImpreFormat(nTotalMon1, 10, 2) & Chr(10) & Chr(10)
        
    End If
    
    GetListaRecepcionCMACS = lscadena
    Set ofuni = Nothing
    
End Function

Public Function ReporteNoCobroInactivasN(ByVal rs As ADODB.Recordset, Optional ByVal gdFecSis As Date) As String
 Dim ofunc As New COMFunciones.FCOMCadenas
 Dim ofuni As New COMFunciones.FCOMImpresion
 
 Dim lnCarLin As Integer, i As Integer
 Dim lsNumPag As String
 Dim lnLinPag As Integer, lnCntPag As Integer
 Dim lsCodAge As String
 Dim lsCuenta As String
 Dim ClsAge As COMDConstantes.DCOMAgencias
 Dim oCon As New COMConecta.DCOMConecta
 lsNumPag = ""
 lnCarLin = 95
 lnLinPag = 0
 lsCodAge = ""
 lsRTFSdo = "" '& Chr(10) & Chr(10) & Chr(10) & Chr(10)
 i = i + 1
 'By Capi 11012008
 If rs.RecordCount = 0 Then
    MsgBox "No existen datos que mostrar", vbInformation, "Aviso!!!"
    Exit Function
 End If
 '
 
 
 rs.MoveFirst
    oCon.AbreConexion
    While Not rs.EOF
    
         If lsCodAge = "" Or lnLinPag > 65 Then
            
            lsRTFSdo = lsRTFSdo & Chr(10) & Chr(10) & Chr(10) & Chr(10)
            lsCodAge = CCodage
            lsRTFSdo = lsRTFSdo & Space(10) & "CMAC MAYNAS" & Space(70) & "FECHA: " & gdFecSis & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(10) & Space(8) & Space(70) & "HORA:" & oCon.GetHoraServer() & Chr(10) & Chr(10)
            Set ClsAge = New COMDConstantes.DCOMAgencias
            lsRTFSdo = lsRTFSdo & Space(15) & " REPORTE DE CUENTAS EXONERADAS DE COBRO DE INACTIVAS " & IIf(CCodage <> "", ClsAge.NombreAgencia(CCodage), "") & Chr(10) & Chr(10)
            
            
            lsRTFSdo = lsRTFSdo & Space(10) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
            lsRTFSdo = lsRTFSdo & Space(10) & "   NRO.   "
            lsRTFSdo = lsRTFSdo & "   CUENTA           "
            lsRTFSdo = lsRTFSdo & "   TITULAR                           "
            lsRTFSdo = lsRTFSdo & "   SALDO CONT. "
            lsRTFSdo = lsRTFSdo & "   SALDO DISP. " & Chr(10)
            lsRTFSdo = lsRTFSdo & Space(10) & String(lnCarLin, "-") & oImp.gPrnSaltoLinea
                        
         End If
                
            lsRTFSdo = lsRTFSdo & Space(8) & ofunc.FillNum(Trim(Str(i)), 10, " ") & Space(1) & Trim(rs!cCtaCod) & Space(1) & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(rs!cpersnom), False), 37), 37, " ") & ofunc.JDNum(Trim(Str(rs!nSaldoCont)), 11, True, 9, 2) & Space(3) & ofunc.JDNum(Trim(Str(rs!nSaldoDisp)), 11, True, 9, 2) & Chr(10)
             
            If lnLinPag = 65 Then
                lsRTFSdo = lsRTFSdo & oImp.gPrnSaltoPagina
            End If
             
            lnLinPag = lnLinPag + 1
            i = i + 1
            
             rs.MoveNext
    Wend
    
    
    ReporteNoCobroInactivasN = lsRTFSdo
    Set ClsAge = Nothing
    Set rs = Nothing
    Set oCon = Nothing
    Set ofunc = Nothing
    Set ofuni = Nothing
    'oCon.CierraConexion
    
End Function

Public Function GetCuentaCapPromotores(ByVal psAge As String, ByVal psTit As String, ByVal pdFecI As Date, ByVal pdFecF As Date) As String
    Dim oCon As COMConecta.DCOMConecta
    Dim oRep As COMDCaptaGenerales.COMDCaptaReportes
    Dim ofuni As New COMFunciones.FCOMImpresion
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ClsAge As COMDConstantes.DCOMAgencias
    Dim rsPro As ADODB.Recordset
    Dim rs As ADODB.Recordset
    Dim rsAge As ADODB.Recordset
    Dim sSql As String
    Dim sResult As String
    Dim nCtasMN As Integer
    Dim nCtasME As Integer
    Dim nTotMonMN As Double
    Dim nTotMonME As Double
    Dim lnLinPag As Integer
    
    Set oCon = New COMConecta.DCOMConecta
    Set rsPro = New ADODB.Recordset
    Set rs = New ADODB.Recordset
    Set rsAge = New ADODB.Recordset
    Set oRep = New COMDCaptaGenerales.COMDCaptaReportes
    
    sResult = "C A J A   M U N I C I P A L   D E   M A Y N A S" & Space(50) & "Fecha:" & Trim(Format(gdFecSis, "dd.mm.yyyy")) & oImp.gPrnSaltoLinea
    sResult = sResult & Space(25) & "CUENTAS APERTURADAS POR PROMOTOR DEL " & Format(pdFecI, "dd.mm.yyyy") & " al " & Format(pdFecF, "dd.mm.yyyy") & oImp.gPrnSaltoLinea
    sResult = sResult & Space(10) & oImp.gPrnSaltoLinea
    Set ClsAge = New COMDConstantes.DCOMAgencias
    If psAge = "" Then
        Set rsAge = ClsAge.RecuperaAgencias
    Else
        Set rsAge = ClsAge.RecuperaAgencias(psAge)
    End If
    lnLinPag = 3
    While Not rsAge.EOF
        sSql = "Select Distinct PP.cPersCod, RH.cUser, P.cPersNombre " & _
           "From ProductoPersona PP Inner Join RRHH RH On PP.cPersCod = RH.cPersCod " & _
           "Inner Join Persona P On RH.cPersCod = p.cPersCod Inner Join Captaciones C On PP.cCtaCod = C.cCtaCod " & _
           "Where substring(PP.cCtaCod,4,2) = '" & rsAge.Fields("cAgeCod") & "' And C.dApertura Between '" & Format(pdFecI, "yyyymmdd") & "' And '" & Format(pdFecF, "yyyymmdd") & "' " & _
           "And PP.nPrdPersRelac = " & gCapRelPersPromotor & " Order By P.cPersNombre"
        oCon.AbreConexion
        Set rsPro = oCon.CargaRecordSet(sSql)
        If Not rsPro.EOF And Not rsPro.BOF Then
            sResult = sResult & Space(55) & UCase(rsAge.Fields("cAgeDescripcion")) & oImp.gPrnSaltoLinea
            lnLinPag = lnLinPag + 1
        End If
        While Not rsPro.EOF
        
            sResult = sResult & oImp.gPrnSaltoLinea & ">Promotor: " & rsPro.Fields("cUser") & " - " & rsPro.Fields("cPersNombre") & oImp.gPrnSaltoLinea
        
            '--------Consulta para ahorros MN---------'
            nCtasMN = 0
            nTotMonMN = 0
            sResult = sResult & ">>>Moneda: Nuevos Soles" & oImp.gPrnSaltoLinea
            sResult = sResult & String(150, "-") & oImp.gPrnSaltoLinea
            sResult = sResult & Space(10) & "Cuenta" & Space(15) & "Nombre CLiente" & Space(30) & "Apertura" & Space(8) & "Saldo" & Space(5) & "Tangible" & Space(5) & "Intangible" & Space(5) & "Fecha Apertura" & Space(2) & "Plazo" & oImp.gPrnSaltoLinea
            sResult = sResult & String(150, "-") & oImp.gPrnSaltoLinea
            Set rs = oRep.GetAperturaPromotorAho("232", rsPro.Fields("cPersCod"), Moneda.gMonedaNacional, pdFecI, pdFecF)
            sResult = sResult & DetallePromotorAho(rs, nCtasMN, nTotMonMN, lnLinPag)
            Set rs = oRep.GetAperturaPromotorAho("233", rsPro.Fields("cPersCod"), Moneda.gMonedaNacional, pdFecI, pdFecF)
            sResult = sResult & DetallePromotorAho(rs, nCtasMN, nTotMonMN, lnLinPag)
            Set rs = oRep.GetAperturaPromotorAho("234", rsPro.Fields("cPersCod"), Moneda.gMonedaNacional, pdFecI, pdFecF)
            sResult = sResult & DetallePromotorAho(rs, nCtasMN, nTotMonMN, lnLinPag)
            If nCtasMN > 0 Then
                sResult = sResult & String(150, "-") & oImp.gPrnSaltoLinea
                sResult = sResult & "TOTAL------------------>" & Space(10) & "Cuentas: " & nCtasMN & Space(20) & "Monto: " & ofuni.ImpreFormat(nTotMonMN, 10, 2, True) & oImp.gPrnSaltoLinea
                sResult = sResult & String(150, "-") & oImp.gPrnSaltoLinea
            End If
        
            '--------Consulta para ahorros ME---------'
            nCtasME = 0
            nTotMonME = 0
            sResult = sResult & ">>>Moneda: Extranjera" & oImp.gPrnSaltoLinea
            Set rs = oRep.GetAperturaPromotorAho("232", rsPro.Fields("cPersCod"), Moneda.gMonedaExtranjera, pdFecI, pdFecF)
            sResult = sResult & DetallePromotorAho(rs, nCtasME, nTotMonME, lnLinPag)
            Set rs = oRep.GetAperturaPromotorAho("233", rsPro.Fields("cPersCod"), Moneda.gMonedaExtranjera, pdFecI, pdFecF)
            sResult = sResult & DetallePromotorAho(rs, nCtasME, nTotMonME, lnLinPag)
            Set rs = oRep.GetAperturaPromotorAho("234", rsPro.Fields("cPersCod"), Moneda.gMonedaExtranjera, pdFecI, pdFecF)
            sResult = sResult & DetallePromotorAho(rs, nCtasME, nTotMonME, lnLinPag)
            If nCtasME > 0 Then
                sResult = sResult & String(150, "-") & oImp.gPrnSaltoLinea
                sResult = sResult & "TOTAL------------------>" & Space(10) & "Cuentas: " & nCtasME & Space(20) & "Monto: " & ofuni.ImpreFormat(nTotMonME, 10, 2, True) & oImp.gPrnSaltoLinea
                sResult = sResult & String(150, "-") & oImp.gPrnSaltoLinea
            End If
            sResult = sResult & oImp.gPrnSaltoLinea
            rsPro.MoveNext
            If lnLinPag >= 65 Then
                sResult = sResult & oImp.gPrnSaltoPagina
                lnLinPag = 1
            End If
        Wend
        rsAge.MoveNext
    Wend
    Set rs = Nothing
    Set rsPro = Nothing
    oCon.CierraConexion
    Set oCon = Nothing
    GetCuentaCapPromotores = sResult
    Exit Function
End Function

Private Function DetallePromotorAho(ByVal rs As ADODB.Recordset, ByRef nCtas As Integer, ByRef nMon As Double, ByRef nLin As Integer) As String
    Dim sResult As String
    Dim ofunc As New COMFunciones.FCOMCadenas
    Dim ofuni As New COMFunciones.FCOMImpresion
    If Not rs.EOF And Not rs.BOF Then
        While Not rs.EOF
            sResult = sResult & Space(5) & rs.Fields("Cuenta")
            sResult = sResult & Space(5) & ofuni.FillText(Left(ofunc.PstaNombre(ofuni.ImpreCarEsp(rs.Fields("Cliente")), False), 35), 35, " ")
            sResult = sResult & Space(8) & ofuni.ImpreFormat(rs.Fields("nApertura"), 9, 2, True)
            sResult = sResult & Space(1) & ofuni.ImpreFormat(rs.Fields("nSaldo"), 9, 2, True)
            'By Capi Agosto 2007 (Acta 014)
            If Mid(rs.Fields("Cuenta"), 6, 3) = "234" Then
                sResult = sResult & Space(1) & ofuni.ImpreFormat(rs.Fields("nTangible"), 9, 2, True)
                sResult = sResult & Space(1) & ofuni.ImpreFormat(rs.Fields("nIntangible"), 9, 2, True)
            Else
                sResult = sResult & Space(1) & ofuni.ImpreFormat(0, 9, 2, True)
                sResult = sResult & Space(1) & ofuni.ImpreFormat(0, 9, 2, True)
            End If
            sResult = sResult & Space(10) & Format(rs.Fields("dApertura"), "dd.mm.yyyy")
            sResult = sResult & Space(5) & rs.Fields("nPlazo")
            sResult = sResult & oImp.gPrnSaltoLinea
            nCtas = nCtas + 1
            nMon = nMon + Format(rs.Fields("nApertura"), "###,###.00")
            nLin = nLin + 1
            rs.MoveNext
        Wend
        sResult = sResult & oImp.gPrnSaltoLinea
        rs.Close
    End If
    DetallePromotorAho = sResult
    Exit Function
End Function

Public Sub IniciaImpresora(Optional ByVal nImpresora As COMFunciones.Impresoras = gEPSON)
    Set oImp = New COMFunciones.FCOMVarImpresion
    oImp.Inicia nImpresora
End Sub
Private Sub Class_Initialize()
    'By Capi 01102008 para controlar IBM
    'IniciaImpresora
    Dim oImp As COMDConstSistema.DCOMImpresoras
    Set oImp = New COMDConstSistema.DCOMImpresoras
    IniciaImpresora oImp.GetImpreSetup(oImp.GetMaquina)
End Sub

Private Sub Class_Terminate()
    Set oImp = Nothing
End Sub
Public Function ImprimeReportesSubProd(ByVal sFecIni As Date, ByVal sFecFin As Date, _
                                       ByVal gsNomCmac As String, ByVal psSubProd As String, _
                                       ByVal psFormaRet As String, ByVal pnCondAho As Integer, _
                                       ByVal psCondVigCan As String, Optional ByVal psCodAge As String) As String
'Se agrego el parametro de codigo de agencia gitu 18-05-2009
Dim oCon As COMConecta.DCOMConecta
Dim rs As ADODB.Recordset
Dim lscadena As String
Dim lsSQL As String
Dim lsWhereFec As String
Dim lsConSubPro As String
Dim lsFechaCan As String
Dim lsFecCan As String
Dim lsJoinCon  As String
Dim lnMonSubPro As Double
Dim lnMonDisSubPro As Double
Dim lsCondAge As String
Dim lsTipo As String
Dim N As Integer
Dim s As Integer
Dim ofuni As New COMFunciones.FCOMImpresion
Set oCon = New COMConecta.DCOMConecta
oCon.AbreConexion
Set rs = New ADODB.Recordset

If psCondVigCan = 1 Then
    lsWhereFec = "C.dApertura Between '" & Format(CDate(sFecIni), "yyyy-mm-dd") & "' And '" & Format(CDate(sFecFin), "yyyy-mm-dd") & "'" _
               & " And Not PR.nPrdEstado In (1400,1300) "
    s = 82
Else
    'lsConSubPro = "PR.dPrdEstado, IsNull(MC.nMonto,0) As nMonApert"
    lsWhereFec = "PR.dPrdEstado Between '" & Format(CDate(sFecIni), "yyyy-mm-dd") & "' And '" & Format(CDate(sFecFin), "yyyy-mm-dd") & "'" _
               & " And PR.nPrdEstado = 1400 "
    lsFechaCan = " PR.dPrdEstado,"
    s = 100
End If
'Se agrego las cuentas inactivas a pedido del usuario ROBA 13-01-2009 GITU
If pnCondAho = 0 Then
    lsConSubPro = "CN.cConsDescripcion As Tipo"
    lsCondicion = " And SubString(C.cCtaCod,6,3) = '232' And nTpoPrograma in(" & psSubProd & ")" _
                & " And nConscod = '2030'"
    
    lsJoinCon = " Join CaptacAhorros CA On C.cCtaCod = CA.cCtaCod " _
              & " Join Constante CN On C.nTpoPrograma = CN.nConsValor "
ElseIf pnCondAho = 1 Then
    lsConSubPro = "CN.cConsDescripcion As Tipo"
    
    lsCondicion = " And SubString(C.cCtaCod,6,3) = '233' And nFormaRetiro in(" & psFormaRet & ")" _
                & " And nConscod = '2003'"
                
    lsJoinCon = " Join CaptacPLazoFijo CP On C.cCtaCod = CP.cCtaCod" _
              & " Join Constante CN On CP.nFormaRetiro = CN.nConsValor "
Else
    lsConSubPro = "Case CN.nConscod When '2030' Then CN.cConsDescripcion Else CN2.cConsDescripcion End As Tipo"
    
    lsCondicion = " And (nTpoPrograma in (" & psSubProd & ") Or nFormaRetiro in (" & psFormaRet & "))" _
                & " And SubString(C.cCtaCod,6,3) In ('232','233')"
                
    lsJoinCon = "  Left Join CaptacAhorros CA On C.cCtaCod = CA.cCtaCod " _
              & "  Left Join CaptacPLazoFijo CP On C.cCtaCod = CP.cCtaCod" _
              & "  left Join Constante CN On C.nTpoPrograma = CN.nConsValor And CN.nConscod = '2030'" _
              & "  left Join Constante CN2 On CP.nFormaRetiro = CN2.nConsValor And CN2.nConscod = '2003'"
End If

'Se agrego la condicion pra generar el reporte por agencia Gitu 18-05-2009.
If psCodAge <> "" Then
    lsCondAge = "And SubString(C.cCtaCod,4,2) = '" & psCodAge & "'"
End If

lsSQL = " Select C.cCtaCod, P.cPersnombre,C.dApertura," & lsFechaCan & " IsNull(MC.nMonto,0) As nMonApert, C.nSaldoDisp, PR.nTasaInteres, " _
      & lsConSubPro & " From Captaciones C "
lsSQL = lsSQL & lsJoinCon & " Join Producto PR On C.cCtaCod = PR.cCtaCod " _
      & "    Left Join MovCapDet MC  On C.cCtaCod = MC.cCtaCod And MC.cOpecod Like '20010%'" _
     & "    Join Productopersona PP On C.cCtaCod = PP.cCtaCod And PP.nPrdPersRelac = 10" _
      & "           And PP.cPersCod = (Select Max(cPersCod) From Productopersona Where cCtaCod = C.cCtaCod And nPrdPersRelac = 10 )" _
      & "    Join Persona P On PP.cPerscod = P.cPerscod " _
      & " Where " & lsWhereFec & lsCondicion & lsCondAge & " order by Tipo, C.dApertura, C.cCtaCod"
      


'*********
         
Set rs = oCon.CargaRecordSet(lsSQL)
 
If Not (rs.EOF And rs.BOF) Then
    'Imprime la cabecera del reporte
    lscadena = ""
    lscadena = lscadena & gsNomCmac & Chr$(10) & Chr$(10)
    lscadena = lscadena & "REPORTE DE CUENTAS POR SUBPRODUCTO DEL : " & Format(sFecIni, "DD/MM/YYYY") & " AL :" & Format(sFecFin, "DD/MM/YYYY") & Chr$(10) & Chr$(10)
    lscadena = lscadena & String(200, "-") & Chr$(10)

    If psCondVigCan = 1 Then
        lscadena = lscadena & ofuni.ImpreFormat("Fecha de Apert.  ", 15) & ofuni.ImpreFormat(" Nº Cuenta  ", 20) & ofuni.ImpreFormat("Cliente ", 62) & ofuni.ImpreFormat("Monto Apert. ", 15) & ofuni.ImpreFormat("Saldo Disponible ", 18) & ofuni.ImpreFormat("Tasa de Interes ", 15) & ofuni.ImpreFormat("SubProd. o Forma ret. ", 25) & Chr$(10)
    Else
        lscadena = lscadena & ofuni.ImpreFormat("Fecha de Apert.  ", 15) & ofuni.ImpreFormat("Fecha de Cance. ", 15) & ofuni.ImpreFormat(" Nº Cuenta  ", 20) & ofuni.ImpreFormat("Cliente ", 62) & ofuni.ImpreFormat("Monto Apert. ", 15) & ofuni.ImpreFormat("Saldo Disponible ", 18) & ofuni.ImpreFormat("Tasa de Interes ", 15) & ofuni.ImpreFormat("SubProd. o Forma ret. ", 25) & Chr$(10)
    End If
    lscadena = lscadena & String(200, "-") & Chr$(10)
            
    N = 0
    lsTipo = rs!Tipo
    Do Until rs.EOF
        If rs!Tipo <> lsTipo Then
            lscadena = lscadena & Space(s) & "Num Cuentas : " & N & ofuni.ImpreFormat(lnMonSubPro, 15) & ofuni.ImpreFormat(lnMonDisSubPro, 15) & Chr$(10) & Chr$(10)
            N = 0
            lnMonSubPro = 0
            lnMonDisSubPro = 0
            lsTipo = rs!Tipo
        End If
        If psCondVigCan = 2 Then
            lsFecCan = ofuni.ImpreFormat(Left(rs!dPrdEstado, 10), 15)
        End If
        lscadena = lscadena & ofuni.ImpreFormat(Left(rs!dApertura, 10), 15) & lsFecCan & ofuni.ImpreFormat(rs!cCtaCod, 20) & ofuni.ImpreFormat(rs!cpersnombre, 60) & ofuni.ImpreFormat(rs!nMonApert, 13) & ofuni.ImpreFormat(rs!nSaldoDisp, 15) & ofuni.ImpreFormat(rs!ntasainteres, 20) & ofuni.ImpreFormat(rs!Tipo, 25) & Chr$(10)
        lnMonSubPro = lnMonSubPro + rs!nMonApert
        lnMonDisSubPro = lnMonDisSubPro + rs!nSaldoDisp
        N = N + 1
    
        rs.MoveNext
    Loop
    lscadena = lscadena & Space(s) & "Num Cuentas : " & N & ofuni.ImpreFormat(lnMonSubPro, 15) & ofuni.ImpreFormat(lnMonDisSubPro, 15) & Chr$(10) & Chr$(10)
    lscadena = lscadena & String(200, "-") & Chr$(12)

    ImprimeReportesSubProd = lscadena
End If
oCon.CierraConexion
Set oCon = Nothing
Set ofuni = Nothing
End Function

'*** PEAC 20080616
Public Function GeneraRepSeguiCtasAhoPandero(ByVal psAgeCod As String, ByVal pdFecIni As Date, ByVal pdFecFin As Date, ByVal pdFecSis As Date, ByVal pnTipo As Integer, Optional prod As String = "") As String

Dim sql As String
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    
    Dim lncontador As Long
    Dim lscadena As String
    Dim lsContador As String * 4
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
    Dim sqlAdd As String, sqlaux As String
    Dim lsAgenciasComentario As String
    Dim ofuni As New COMFunciones.FCOMImpresion
    
    If psAgeCod = "" Then
        lsAgenciasComentario = ""
        
        sql = "exec stp_sel_ReporteSeguiCtasPandero '" & Format(pdFecIni, "yyyymmdd") & "','" & Format(pdFecFin, "yyyymmdd") & "'"
    Else
        Dim ClsAge As COMDConstantes.DCOMAgencias
        Set ClsAge = New COMDConstantes.DCOMAgencias
        lsAgenciasComentario = "Agencia = " & psAgeCod & " " & ClsAge.NombreAgencia(psAgeCod)
        
        sql = "exec stp_sel_ReporteSeguiCtasPandero '" & Format(pdFecIni, "yyyymmdd") & "','" & Format(pdFecFin, "yyyymmdd") & "','" & psAgeCod & "'"
    End If
                                
    oCon.AbreConexion
    
    Set rs = oCon.CargaRecordSet(sql)
       
    lscadena = ""
    lscadena = lscadena & "CAJA MAYNAS" & Chr$(10)
    lscadena = lscadena & lsAgenciasComentario & Chr$(10)
    lscadena = lscadena & ofuni.CabeceraPagina("REPORTE DE SEGUIMIENTO DE CUENTAS DE AHORRO POCO A POCO AHORRO DEL :" & Format(pdFecIni, "DD/MM/YYYY") & " AL :" & Format(pdFecFin, "DD/MM/YYYY"), lnPagina, lnItem, "", "", pdFecSis, , False)
    lscadena = lscadena & ofuni.Encabezado("Item;4; ;2;Cuenta;6; ;2;Nombre;20; ;2;Num. Doc.;55; ;2;Doc.;7; ;2;Estado;11; ;2;TASA %;12; ;2;Fec.Apertura;8; ;2;Condicion;9; ;2;", lnItem)

    lncontador = 0
    
    While Not rs.EOF
        lncontador = lncontador + 1
        
        lscadena = lscadena & Format(lncontador, "0000") & "  " & rs!cCtaCod & "  " & ofuni.ImpreFormat(rs!cpersnombre, 50) & "  " & ofuni.ImpreFormat(rs!numdoc, 10) & "  " & ofuni.ImpreFormat(Trim(rs!NomDoc), 7) & "  " & ofuni.ImpreFormat(rs!Estado, 15) & "  " & Format(((1 + rs!ntasainteres / 36000) ^ 360 - 1) * 100, "#,#.00") & "  " & Format(rs!dApertura, "dd/mm/yyyy") & "  " & rs!condicion & "  " & Chr(10)

        lnItem = lnItem + 1

        If lnItem > 54 Then
            lnItem = 0
            lscadena = lscadena & Chr(12)
    
            lscadena = lscadena & "CAJA MAYNAS" & Chr$(10)
            lscadena = lscadena & lsAgenciasComentario & Chr$(10)
            lscadena = lscadena & ofuni.CabeceraPagina("REPORTE DE SEGUIMIENTO DE CUENTAS DE AHORRO POCO A POCO AHORRO DEL :" & Format(pdFecIni, "DD/MM/YYYY") & " AL :" & Format(pdFecFin, "DD/MM/YYYY"), lnPagina, lnItem, "", "", pdFecSis, , False)
            lscadena = lscadena & ofuni.Encabezado("Item;4; ;2;Cuenta;6; ;2;Nombre;20; ;2;Num. Doc.;55; ;2;Doc.;7; ;2;Estado;11; ;2;TASA %;12; ;2;Fec.Apertura;8; ;2;Condicion;9; ;2;", lnItem)
        End If

        rs.MoveNext
    Wend
    
    oCon.CierraConexion
    Set rs = Nothing
    Set oCon = Nothing
    Set ClsAge = Nothing
    
   GeneraRepSeguiCtasAhoPandero = lscadena

End Function

'By Capi 07082008
Public Function generarReportePFPersoneria() As ADODB.Recordset
    Dim lsql As String
    Dim oConecta As COMConecta.DCOMConecta
    Set oConecta = New COMConecta.DCOMConecta
    oConecta.AbreConexion
    lsql = " Exec stp_sel_ReportePFPersoneria "
    Set generarReportePFPersoneria = oConecta.CargaRecordSet(lsql)
    oConecta.CierraConexion
    Set oConecta = Nothing
 End Function
 
 'By Capi 07082008
Public Function ReportePagosWesternUnion(ByVal pdFecIni As Date, ByVal pdFecFinal As Date) As ADODB.Recordset
    Dim sSql As String
    Dim oConecta As COMConecta.DCOMConecta
    Set oConecta = New COMConecta.DCOMConecta
    oConecta.AbreConexion
    sSql = " Exec stp_sel_ReportePagosWesternUnion '" & Format(pdFecIni, "yyyymmdd") & "','" & Format(pdFecFinal, "yyyymmdd") & "'"
    Set ReportePagosWesternUnion = oConecta.CargaRecordSet(sSql)
    oConecta.CierraConexion
    Set oConecta = Nothing
 End Function

'*** PEAC 20100524
Public Function ListadoDeCargosAbonos(pdIni As Date, pdFin As Date, pgsEmpresa As String, pgsNomAge As String, psAge As String, pgdFecSis As Date) As String
    Dim sql As String
    Dim oCon As COMConecta.DCOMConecta
    Set oCon = New COMConecta.DCOMConecta
    Dim lnPagina As Long
    Dim lnItem As Long
    Dim ofuni As New COMFunciones.FCOMImpresion
        
    Dim lnCorr As Integer
    
    Dim rs As ADODB.Recordset
    Set rs = New ADODB.Recordset
    
    Dim lscadena As String
    
    Dim lsMonedaAnt As String
    Dim lsCabeceraAnt As String
    
    Dim lnAcum As Currency
    
    Dim lsItem As String * 4
    Dim lsCargo As String * 15
    Dim lsAbono As String * 15
    Dim lcCabecera As String
    Dim sqlAdd As String
    Dim lcFecha As String
    Dim lsAgencia As String

    Dim lsTotCargo As Currency, lsTotAbono As Currency
    Dim lsTotalCargo As String, lsTotalAbono As String

    lcCabecera = "LISTADO DE CARGOS Y ABONOS"
    lscadena = ""
    
    If psAge = "" Then
        sqlAdd = ""
    Else
        sqlAdd = psAge
    End If
    
    sql = " exec stp_sel_ListadoCargosAbonos '" & Format(pdIni, "yyyymmdd") & "','" & Format(pdFin, "yyyymmdd") & "','" & sqlAdd & "' "
    
    oCon.AbreConexion
    Set rs = oCon.CargaRecordSet(sql)
    
    If Not (rs.EOF And rs.BOF) Then
        lnCorr = 0
        lscadena = lscadena & ofuni.CabeceraPagina(lcCabecera, lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis)
        lscadena = lscadena & ofuni.Encabezado("Item;4; ;2;Age.;4; ;1;Moneda;6; ;0;Fecha;7; ;2;Cuenta;8; ;14;Detalle;9; ;35;Cargo;7; ;10;Abono;7; ;3;Usu.;4; ;5;", lnItem)
        While Not rs.EOF
            
            If lnCorr = 158 Then
                dd = 55
            End If
            
            
            If (lsAgencia = rs!Agencia And lsMonedaAnt <> rs!Moneda) Or (lsAgencia <> rs!Agencia And lsMonedaAnt <> rs!Moneda) Or (lsAgencia <> rs!Agencia And lsMonedaAnt = rs!Moneda) Then
                If lsMonedaAnt <> "" Then
                If lscadena <> "" Then
                    lsTotalCargo = lsTotCargo 'Format(lsTotCargo, "#,##0.00")
                    lsTotalAbono = lsTotAbono 'Format(lsTotAbono, "#,##0.00")
                    lscadena = lscadena & String(129, "-") & Chr(10)
                    lscadena = lscadena & Space(40) & "Totales --->" & Space(32) & ofuni.ImpreFormat(Val(lsTotalCargo), 14, 2, True) & Space(0) & ofuni.ImpreFormat(Val(lsTotalAbono), 14, 2, True) & Chr(10)
                    lscadena = lscadena & String(129, "-") & Chr(10)
                    lscadena = lscadena & Chr(10) '(12)
                    lsTotCargo = 0
                    lsTotAbono = 0
                End If
                End If
            End If

            lnCorr = lnCorr + 1
            lnItem = lnItem + 1
            
            lsItem = Format(lnCorr, "0000")

            RSet lsCargo = Format(rs!Cargo, "#,##0.00")
            RSet lsAbono = Format(rs!Abono, "#,##0.00")
            
            lcFecha = Mid(rs!fecha, 7, 2) + "/" + Mid(rs!fecha, 5, 2) + "/" + Mid(rs!fecha, 1, 4)
            lscadena = lscadena & lsItem & Space(2) & rs!Agencia & Space(5) & rs!Moneda & Space(2) & lcFecha & Space(2) & rs!cuenta & Space(2) & ofuni.ImpreFormat(rs!detalle, 33) & Space(2) & lsCargo & Space(2) & lsAbono & Space(2) & rs!Usuario & Chr(10)
            
            lsTotCargo = lsTotCargo + rs!Cargo
            lsTotAbono = lsTotAbono + rs!Abono
            lsMonedaAnt = rs!Moneda
            lsAgencia = rs!Agencia
            
            If lnItem > 54 Then
                lscadena = lscadena & Chr(12)
                lscadena = lscadena & ofuni.CabeceraPagina(lcCabecera, lnPagina, lnItem, pgsNomAge, pgsEmpresa, pgdFecSis)
                lscadena = lscadena & ofuni.Encabezado("Item;4; ;2;Age.;4; ;1;Moneda;6; ;0;Fecha;7; ;2;Cuenta;8; ;14;Detalle;9; ;35;Cargo;7; ;10;Abono;7; ;3;Usu.;4; ;5;", lnItem)
            End If
            
            rs.MoveNext
            
            If rs.EOF Then
                If lscadena <> "" Then
                    lsTotalCargo = lsTotCargo 'Format(lsTotCargo, "#,##0.00")
                    lsTotalAbono = lsTotAbono 'Format(lsTotAbono, "#,##0.00")
                    lscadena = lscadena & String(129, "-") & Chr(10)
                    lscadena = lscadena & Space(40) & "Totales --->" & Space(32) & ofuni.ImpreFormat(Val(lsTotalCargo), 14, 2, True) & Space(0) & ofuni.ImpreFormat(Val(lsTotalAbono), 14, 2, True) & Chr(10)
                    lscadena = lscadena & String(129, "-") & Chr(10)
                    lscadena = lscadena & Chr(10) '(12)
                    lsTotCargo = 0
                    lsTotAbono = 0
                End If
            End If
            
            
        Wend
    End If
    
    ListadoDeCargosAbonos = lscadena
    Set ofuni = Nothing
End Function

''***Agregado por ELRO el 2012095, según OYP-RFC087-2012
Public Function devolverIndConCli() As ADODB.Recordset

    Dim oCOMDCaptaReportes As New COMDCaptaGenerales.COMDCaptaReportes

    On Error GoTo ErrorMsg
    Set devolverIndConCli = oCOMDCaptaReportes.obtenerIndConCli
    Set oCOMDCaptaReportes = Nothing
    Exit Function

ErrorMsg:
    Set ooCOMDCaptaReportes = Nothing
    Err.Raise Err.Number, "Error", Err.Description
End Function

Public Function modificarIndConCli(ByVal pnId_IndConCli As Long, _
                                   ByVal pnSBS As Currency, _
                                   ByVal pnInterno As Currency) As Long

    Dim oCOMDCaptaReportes As New COMDCaptaGenerales.COMDCaptaReportes

    On Error GoTo ErrorMsg
    modificarIndConCli = oCOMDCaptaReportes.actualizarIndConCli(pnId_IndConCli, pnSBS, pnInterno)
    Set oCOMDCaptaReportes = Nothing
    Exit Function

ErrorMsg:
    Set ooCOMDCaptaReportes = Nothing
    Err.Raise Err.Number, "Error", Err.Description
End Function

Public Function devolverIndComDep() As ADODB.Recordset

    Dim oCOMDCaptaReportes As New COMDCaptaGenerales.COMDCaptaReportes

    On Error GoTo ErrorMsg
    Set devolverIndComDep = oCOMDCaptaReportes.obtenerIndComDep
    Set oCOMDCaptaReportes = Nothing
    Exit Function

ErrorMsg:
    Set ooCOMDCaptaReportes = Nothing
    Err.Raise Err.Number, "Error", Err.Description
End Function

Public Function modificarIndComDep(ByVal pnId_IndComDep As Long, ByVal pnIndice As Currency) As Long

    Dim oCOMDCaptaReportes As New COMDCaptaGenerales.COMDCaptaReportes

    On Error GoTo ErrorMsg
    modificarIndComDep = oCOMDCaptaReportes.actualizarIndComDep(pnId_IndComDep, pnIndice)
    Set oCOMDCaptaReportes = Nothing
    Exit Function

ErrorMsg:
    Set ooCOMDCaptaReportes = Nothing
    Err.Raise Err.Number, "Error", Err.Description
End Function

Public Function devolverAperturaVoBo(ByVal psAgeCod As String) As ADODB.Recordset

    Dim oCOMDCaptaReportes As New COMDCaptaGenerales.COMDCaptaReportes

    On Error GoTo ErrorMsg
    Set devolverAperturaVoBo = oCOMDCaptaReportes.obtenerAperturaVoBo(psAgeCod)
    Set oCOMDCaptaReportes = Nothing
    Exit Function

ErrorMsg:
    Set ooCOMDCaptaReportes = Nothing
    Err.Raise Err.Number, "Error", Err.Description
End Function

Public Function modificarVoBo(ByVal pnId_VoBoConCli As Long, ByVal pnEstado As Integer, ByVal psMov As String) As Long

    Dim oCOMDCaptaReportes As New COMDCaptaGenerales.COMDCaptaReportes

    On Error GoTo ErrorMsg
    modificarVoBo = oCOMDCaptaReportes.actualizarVisBueCapIndConCli(pnId_VoBoConCli, pnEstado, psMov)
    Set oCOMDCaptaReportes = Nothing
    Exit Function

ErrorMsg:
    Set ooCOMDCaptaReportes = Nothing
    Err.Raise Err.Number, "Error", Err.Description
End Function

''***Fin Agregado por ELRO el 2012095*******************



